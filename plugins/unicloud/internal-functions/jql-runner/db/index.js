"use strict";function t(t){return t&&"string"==typeof t?JSON.parse(t):t}t(process.env.UNICLOUD_DEBUG),t(process.env.UNI_CLOUD_PROVIDER),process.env.RUN_BY_HBUILDERX;let e={};function r(t,r={}){var n,o;return n=e,o=t,Object.prototype.hasOwnProperty.call(n,o)||(e[t]=r),e[t]}const n=Symbol("CLIENT_DB_INTERNAL");function o(t,e){return t.then="DoNotReturnProxyWithAFunctionNamedThen",t._internalType=n,t.__ob__=void 0,t.__v_raw=void 0,new Proxy(t,{get:(t,r,n)=>r in t||"string"!=typeof r?t[r]:e.get(t,r,n)})}function a(t){return{on:(e,r)=>{t[e]=t[e]||[],t[e].indexOf(r)>-1||t[e].push(r)},off:(e,r)=>{t[e]=t[e]||[];const n=t[e].indexOf(r);-1!==n&&t[e].splice(n,1)}}}const s=["db.Geo","db.command","command.aggregate"];function c(t,e){return s.indexOf(`${t}.${e}`)>-1}function i(t){switch(e=t,Object.prototype.toString.call(e).slice(8,-1).toLowerCase()){case"array":return t.map((t=>i(t)));case"object":return t._internalType===n||Object.keys(t).forEach((e=>{t[e]=i(t[e])})),t;case"regexp":return{$regexp:{source:t.source,flags:t.flags}};case"date":return{$date:t.toISOString()};default:return t}var e}class u{constructor(t,e,r){this.content=t,this.prevStage=e||null,this.udb=null,this._database=r}toJSON(){let t=this;const e=[t.content];for(;t.prevStage;)t=t.prevStage,e.push(t.content);return{$db:e.reverse().map((t=>({$method:t.$method,$param:i(t.$param)})))}}getAction(){const t=this.toJSON().$db.find((t=>"action"===t.$method));return t&&t.$param&&t.$param[0]}getCommand(){return{$db:this.toJSON().$db.filter((t=>"action"!==t.$method))}}get useAggregate(){let t=this,e=!1;for(;t.prevStage;){t=t.prevStage;const r=t.content.$method;if("aggregate"===r||"pipeline"===r){e=!0;break}}return e}get count(){if(!this.useAggregate)return function(){return this._send("count",Array.from(arguments))};const t=this;return function(){return d({$method:"count",$param:i(Array.from(arguments))},t,this._database)}}get(){return this._send("get",Array.from(arguments))}add(){return this._send("add",Array.from(arguments))}remove(){return this._send("remove",Array.from(arguments))}update(){return this._send("update",Array.from(arguments))}end(){return this._send("end",Array.from(arguments))}set(){throw new Error("clientDB禁止使用set方法")}_send(t,e){const r=this.getAction(),n=this.getCommand();return n.$db.push({$method:t,$param:i(e)}),this._database._callCloudFunction({action:r,command:n})}}function d(t,e,r){return o(new u(t,e,r),{get(t,e){let n="db";return t&&t.content&&(n=t.content.$method),c(n,e)?d({$method:e},t,r):function(){return d({$method:e,$param:i(Array.from(arguments))},t,r)}}})}function m({path:t,method:e}){return class{constructor(){this.param=Array.from(arguments)}toJSON(){return{$newDb:[...t.map((t=>({$method:t}))),{$method:e,$param:this.param}]}}}}var h=function(t,e={}){return o(new t(e),{get:(t,e)=>c("db",e)?d({$method:e},null,t):function(){return d({$method:e,$param:i(Array.from(arguments))},null,t)}})}(class extends class{constructor({uniClient:t={}}={}){this._uniClient=t,this._authCallBacks={},this._dbCallBacks={},t.isDefault&&(this._dbCallBacks=r("_globalUniCloudDatabaseCallback")),this.auth=a(this._authCallBacks),Object.assign(this,a(this._dbCallBacks)),this.env=o({},{get:(t,e)=>({$env:e})}),this.Geo=o({},{get:(t,e)=>m({path:["Geo"],method:e})}),this.serverDate=m({path:[],method:"serverDate"}),this.RegExp=m({path:[],method:"RegExp"})}getCloudEnv(t){if("string"!=typeof t||!t.trim())throw new Error("getCloudEnv参数错误");return{$env:t.replace("$cloudEnv_","")}}_callback(t,e){const r=this._dbCallBacks;r[t]&&r[t].forEach((t=>{t(...e)}))}_callbackAuth(t,e){const r=this._authCallBacks;r[t]&&r[t].forEach((t=>{t(...e)}))}multiSend(){const t=Array.from(arguments),e=t.map((t=>{const e=t.getAction(),r=t.getCommand();if("getTemp"!==r.$db[r.$db.length-1].$method)throw new Error("multiSend只支持子命令内使用getTemp");return{action:e,command:r}}));return this._callCloudFunction({multiCommand:e,queryList:t})}}{_callCloudFunction({action:t,command:e,multiCommand:r}={}){if(t||r&&r.some((t=>!!t.getAction())))throw new Error("本地直接执行jql文件时不允许使用action");return{action:t,command:e,multiCommand:r}}});module.exports=h;
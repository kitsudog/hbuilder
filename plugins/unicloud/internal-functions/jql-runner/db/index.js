"use strict";function t(t){return t&&"string"==typeof t?JSON.parse(t):t}"true"===process.env.UNI_SECURE_NETWORK_ENABLE||process.env.UNI_SECURE_NETWORK_ENABLE,t(process.env.UNI_SECURE_NETWORK_CONFIG),t(process.env.UNICLOUD_DEBUG),t(process.env.UNI_CLOUD_PROVIDER),process.env.RUN_BY_HBUILDERX;let e={};function r(t,r={}){var n,o;return n=e,o=t,Object.prototype.hasOwnProperty.call(n,o)||(e[t]=r),e[t]}r("_globalUniCloudInterceptor"),r("_globalUniCloudListener");const n=Symbol("CLIENT_DB_INTERNAL");function o(t,e){return t.then="DoNotReturnProxyWithAFunctionNamedThen",t._internalType=n,t.inspect=null,t.__ob__=void 0,t.__v_raw=void 0,new Proxy(t,{get(t,r,n){if("_uniClient"===r)return null;if("symbol"==typeof r)return t[r];if(r in t||"string"!=typeof r){const e=t[r];return"function"==typeof e?e.bind(t):e}return e.get(t,r,n)}})}function a(t){return{on:(e,r)=>{t[e]=t[e]||[],t[e].indexOf(r)>-1||t[e].push(r)},off:(e,r)=>{t[e]=t[e]||[];const n=t[e].indexOf(r);-1!==n&&t[e].splice(n,1)}}}const s=["db.Geo","db.command","command.aggregate"];function i(t,e){return s.indexOf(`${t}.${e}`)>-1}function c(t){switch(e=t,Object.prototype.toString.call(e).slice(8,-1).toLowerCase()){case"array":return t.map((t=>c(t)));case"object":return t._internalType===n||Object.keys(t).forEach((e=>{t[e]=c(t[e])})),t;case"regexp":return{$regexp:{source:t.source,flags:t.flags}};case"date":return{$date:t.toISOString()};default:return t}var e}function u(t){return t&&t.content&&t.content.$method}class m{constructor(t,e,r){this.content=t,this.prevStage=e||null,this.udb=null,this._database=r}toJSON(){let t=this;const e=[t.content];for(;t.prevStage;)t=t.prevStage,e.push(t.content);return{$db:e.reverse().map((t=>({$method:t.$method,$param:c(t.$param)})))}}toString(){return JSON.stringify(this.toJSON())}getAction(){const t=this.toJSON().$db.find((t=>"action"===t.$method));return t&&t.$param&&t.$param[0]}getCommand(){return{$db:this.toJSON().$db.filter((t=>"action"!==t.$method))}}get isAggregate(){let t=this;for(;t;){const e=u(t),r=u(t.prevStage);if("aggregate"===e&&"collection"===r||"pipeline"===e)return!0;t=t.prevStage}return!1}get isCommand(){let t=this;for(;t;){if("command"===u(t))return!0;t=t.prevStage}return!1}get isAggregateCommand(){let t=this;for(;t;){const e=u(t),r=u(t.prevStage);if("aggregate"===e&&"command"===r)return!0;t=t.prevStage}return!1}getNextStageFn(t){const e=this;return function(){return d({$method:t,$param:c(Array.from(arguments))},e,e._database)}}get count(){return this.isAggregate?this.getNextStageFn("count"):function(){return this._send("count",Array.from(arguments))}}get remove(){return this.isCommand?this.getNextStageFn("remove"):function(){return this._send("remove",Array.from(arguments))}}get(){return this._send("get",Array.from(arguments))}get add(){return this.isCommand?this.getNextStageFn("add"):function(){return this._send("add",Array.from(arguments))}}update(){return this._send("update",Array.from(arguments))}end(){return this._send("end",Array.from(arguments))}get set(){return this.isCommand?this.getNextStageFn("set"):function(){throw new Error("JQL禁止使用set方法")}}_send(t,e){const r=this.getAction(),n=this.getCommand();return n.$db.push({$method:t,$param:c(e)}),this._database._callCloudFunction({action:r,command:n})}}function d(t,e,r){return o(new m(t,e,r),{get(t,e){let n="db";return t&&t.content&&(n=t.content.$method),i(n,e)?d({$method:e},t,r):function(){return d({$method:e,$param:c(Array.from(arguments))},t,r)}}})}function l({path:t,method:e}){return class{constructor(){this.param=Array.from(arguments)}toJSON(){return{$newDb:[...t.map((t=>({$method:t}))),{$method:e,$param:this.param}]}}toString(){return JSON.stringify(this.toJSON())}}}var h=function(t,e={}){return o(new t(e),{get:(t,e)=>i("db",e)?d({$method:e},null,t):function(){return d({$method:e,$param:c(Array.from(arguments))},null,t)}})}(class extends class{constructor({uniClient:t={},isJQL:e=!1}={}){this._uniClient=t,this._authCallBacks={},this._dbCallBacks={},t._isDefault&&(this._dbCallBacks=r("_globalUniCloudDatabaseCallback")),e||(this.auth=a(this._authCallBacks)),this._isJQL=e,Object.assign(this,a(this._dbCallBacks)),this.env=o({},{get:(t,e)=>({$env:e})}),this.Geo=o({},{get:(t,e)=>l({path:["Geo"],method:e})}),this.serverDate=l({path:[],method:"serverDate"}),this.RegExp=l({path:[],method:"RegExp"})}getCloudEnv(t){if("string"!=typeof t||!t.trim())throw new Error("getCloudEnv参数错误");return{$env:t.replace("$cloudEnv_","")}}_callback(t,e){const r=this._dbCallBacks;r[t]&&r[t].forEach((t=>{t(...e)}))}_callbackAuth(t,e){const r=this._authCallBacks;r[t]&&r[t].forEach((t=>{t(...e)}))}multiSend(){const t=Array.from(arguments),e=t.map((t=>{const e=t.getAction(),r=t.getCommand();if("getTemp"!==r.$db[r.$db.length-1].$method)throw new Error("multiSend只支持子命令内使用getTemp");return{action:e,command:r}}));return this._callCloudFunction({multiCommand:e,queryList:t})}}{_callCloudFunction({action:t,command:e,multiCommand:r}={}){if(t||r&&r.some((t=>!!t.action)))throw new Error("本地直接执行jql文件时不允许使用action");return{action:t,command:e,multiCommand:r}}});module.exports=h;
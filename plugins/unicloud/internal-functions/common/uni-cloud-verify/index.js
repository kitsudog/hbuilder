"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("crypto");function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}require("path"),require("fs");var r=t(e);class s extends Error{constructor(e){super(e.message),this.errMsg=e.message||"",this.code=this.errCode=e.code,this.errSubject=e.subject,this.forceReturn=e.forceReturn||!1,this.cause=e.cause,Object.defineProperties(this,{message:{get(){return this.errMsg},set(e){this.errMsg=e}}})}toJSON(e=0){if(!(e>=10))return e++,{errCode:this.errCode,errMsg:this.errMsg,errSubject:this.errSubject,cause:this.cause&&this.cause.toJSON?this.cause.toJSON(e):this.cause}}}const n=Object.prototype.toString;function i(e){return n.call(e).slice(8,-1).toLowerCase()}function a(){return JSON.parse(process.env.UNICLOUD_SERVICE_SECRET||"{}")}function o(e){const{provider:t,spaceId:r,useOldSpaceId:s}=e||{};return"aliyun"!==t||!0!==s||r.startsWith("mp-")?r:"mp-"+r}function c(e,t){const s=Object.keys(e).sort().filter((function(t){return void 0!==e[t]})).map((t=>`${t}=${""+e[t]}`));s.push(`apiSecret=${t}`);const n=r.default.createHash("md5");return n.update(s.join("&")),n.digest("hex").toLowerCase()}async function u(e,t){let r;try{r=await uniCloud.httpclient.request(e,{method:"POST",data:t,contentType:"json",dataType:"text",followRedirect:!0,timeout:6e4})}catch(e){if("ResponseTimeoutError"===e.name)return{code:999,message:"service timeout"};throw e.message=e.message.replace(/https?:\/\/(.*).dcloud.net.cn/,(function(e,t){return`service[${t}]`})),e}if(r.status>=400)return{code:r.status,message:r.data||"service error"};const s=JSON.parse(r.data);return s.ret?{code:s.ret,message:s.desc}:(delete s.ret,delete s.desc,s)}async function d(e,t){let r=null;const s=e.length,n=Math.floor(Math.random()*s);let i=0;for(;!r;){const a=e[(n+i)%s];r=await u(a,t),r.code<600&&r.code>=400&&i<e.length-1&&(r=null),i++}return r}function l(e){switch(e){case"tcb":case"tencent":return"tcb";default:return e}}const p=50001,h=50002,f=Object.create(null);function y(e){switch(e.type){case"array":return"array";case"root":return"root";default:return"base"}}function g(e){return null==e||"string"==typeof e&&""===e.trim()}["string","boolean","number","null"].forEach((e=>{f[e]=function(t){return i(t)===e}}));class m{constructor(){this.baseValidator=f,this.customValidator=Object.create(null)}mixin(e,t){this.customValidator[e]=t}_isMatchBaseType(e,t){const r=this._getRealBaseValidator(t.type);if("function"!=typeof r)throw new Error(`Invalid schema type: ${t.type}`);return r(e)}_isMatchArrayType(e,t){return"array"===i(e)&&!(t.children&&t.children.length&&e.some((e=>!this._isMatchUnionType(e,t))))}_isMatchUnionType(e,t){if(!t.children||0===t.children.length)return!0;const r=t.children;for(let t=0;t<r.length;t++){const s=r[t];let n=!1;switch(y(s)){case"base":n=this._isMatchBaseType(e,s);break;case"array":n=this._isMatchArrayType(e,s)}if(n)return!0}return!1}_getRealBaseValidator(e){return this.customValidator[e]||this.baseValidator[e]}get validator(){const e=this;return new Proxy({},{get:(t,r)=>{if("string"!=typeof r)return;const s=this._getRealBaseValidator(r);if(s)return s;const n=function(e){const t=function(e){let t=0;const r=[];let s="";for(;t<e.length;){const n=e[t];switch(n){case"|":case"<":case">":s&&r.push(s),r.push(n),s="";break;default:s+=n}t++,t===e.length&&s&&r.push(s)}return r}(e);let r=0,s=t[r];const n={type:"root",children:[],parent:null};let i=n;for(;s;){switch(s){case"array":{const e={type:"array",children:[],parent:i};i.children.push(e),i=e;break}case"<":if("array"!==i.type)throw new Error('Invalid validator token "<"');break;case">":if("array"!==i.type)throw new Error('Invalid validator token ">"');i=i.parent;break;case"|":if("array"!==i.type&&"root"!==i.type)throw new Error('Invalid validator token "|"');break;default:i.children.push({type:s})}r++,s=t[r]}return n}(r);return function(t,r){return!!e._isMatchUnionType(t,n)}}})}validate(e={},t={}){for(const r in t){let s=t[r];"string"===i(s)&&(s={required:!0,type:s});const{required:n,type:a}=s;if(g(e[r])){if(n)return{code:p,message:`Parameter ${r} is required`};continue}const o=this.validator[a];if(!o)throw new Error(`Invalid schema type: ${a}`);if(!1===o(e[r],r))return{code:h,message:`Parameter ${r} is invalid`}}}}const I="uni-getPhoneNumber";function v(e,t,r){throw new s({subject:I,code:e,message:t,cause:r})}const _=new m;async function b(e){const t=_.validate(e,{appid:{required:!1,type:"string"},apiKey:{required:!1,type:"string"},apiSecret:{required:!1,type:"string"},access_token:"string",openid:"string"});t&&v(t.code,t.message);const r=uniCloud.getCloudInfos()[0],n=o(r),i=l(r.provider),{appid:u=global.__ctx__.APPID,apiKey:p,apiSecret:h,access_token:f,openid:y}=e||{},g={token:f,openid:y,appid:u,spaceId:n,provider:i};let m;if(p||h)g.apiKey=p,m=h;else{const{secretKeyId:e,secretKey:t}=a()||{};g.keyId=e,m=t}const I=c(g,m),b=["ucoaulbk.dcloud.net.cn"].map((e=>`https://${e}/http/unilogin/api/getPhoneNumber`)),w=await d(b,{...g,sign:I});if(!w.code)return{code:0,errCode:0,errMsg:"",success:!0,phoneNumber:w.data.mobile};w.code>=400&&w.code<1e3&&v(6e4,"service error",new s(w)),v(w.code,w.message)}async function w(e){const t={univerify:b},{provider:r}=e;if("univerify"!==r)throw new s({code:1001,message:`getPhoneNumber不支持provider:${r}`});return await t[r](e)}function q(e,t,r){throw new s({subject:"uni-facialRecognitionVerify",code:e,message:t,cause:r})}class C{constructor(e){this._validator=new m,this._validate(e,{requestId:"string",appId:{required:!1,type:"string"}});const{requestId:t}=e,{secretKeyId:r,secretKey:s}=a()||{};this._requestId=t;const n=uniCloud.getClientInfos().find((e=>e.requestId===this._requestId))||{},i=uniCloud.getCloudInfos().find((e=>e.requestId===this._requestId))||{};n&&i||q(50002,"请确保参数内的requestId是正确的requestId"),this._secretKey=s,this._secretKeyId=r,this._spaceId=o(i),this._provider=i.provider,this._serviceSpaceProvider=l(this._provider);const{clientIP:c="127.0.0.1"}=n,u=e.appId||n.appId;u||q(50002,`未能从clientInfo内获取${u?"clientIP":"appId"}，请参考：\n1. 运行云函数时配置运行测试参数 https://uniapp.dcloud.net.cn/uniCloud/rundebug.html#runparam \n2. 运行云对象时传配置运行测试参数 https://uniapp.dcloud.net.cn/uniCloud/rundebug.html#run-obj-param`),"client"===n.source||u||q(50002,"当前请求来源无法获取客户端appId，请自行传递appId参数。请参考：https://uniapp.dcloud.net.cn/uniCloud/frv/dev.html#get-frv-manager"),this._appId=u,this._clientIP=c}_validate(e,t){const r=this._validator.validate(e,t);r&&q(r.code,r.message)}async _request(e,t){const r={...t,timestamp:""+Date.now(),provider:this._serviceSpaceProvider,spaceId:this._spaceId,keyId:this._secretKeyId,appid:this._appId,clientIp:this._clientIP},n=c(r,this._secretKey),i=["ucoafrvbk.dcloud.net.cn"].map((t=>`https://${t}/${e}`)),a=await d(i,{...r,sign:n});if(!a.code)return{errCode:0,errMsg:"",...a};a.code>=400&&a.code<1e3&&q(6e4,"service error",new s(a)),q(a.code,a.message)}async getCertifyId(e){let t;this._validate(e,{realName:"string",idCard:"string",metaInfo:"string",needPicture:{required:!1,type:"boolean"},model:{required:!1,type:"string"}}),t=e.needPicture?"1":"0";const{realName:r,idCard:s,metaInfo:n,model:i}=e;return this._request("ucoafrv/getCertifyId",{realName:r,idCard:s,metaInfo:n,needPicture:t,model:i})}async getAuthResult(e){this._validate(e,{certifyId:"string"});const{certifyId:t}=e;return this._request("ucoafrv/getAuthResult",{certifyId:t})}}function P(){const e=Object.getPrototypeOf(uniCloud);e.getPhoneNumber=w,e.getFacialRecognitionVerifyManager=function(e){const t=e.requestId,r=e.appId;return new C({requestId:t,appId:r})}}P(),exports.init=P;
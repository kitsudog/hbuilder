"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var t=e(require("crypto"));let a={};try{a=JSON.parse(process.env.UNICLOUD_PUSH_CONFIG)}catch(e){throw Error("未找到“关联当前服务空间”的uniPush服务；前往配置：https://dev.dcloud.net.cn/pages/app/push2/info")}const s=uniCloud.database(),i=s.command,r=s.collection("uni-push-message"),n=s.collection("opendb-tempdata");let o={},d=!1,u=d?console.log:()=>{},c=!1;const p=[];function l(e){return e.errCode=e.code?"uni-cloud-push-error-"+e.code:0,e.errMsg=e.msg,delete e.code,delete e.msg,e}class h{getPushChannel(){let{payload:e,title:t,content:a,open_url:s,badge:i,sound:r,channel:n={},force_notification:d,path:c}=this.message;if(!t)return{};e=JSON.stringify(e);let p="intent://io.dcloud.unipush/?#Intent;scheme=unipush;launchFlags=0x4000000;S.UP-OL-SU=true;";p+=`component=${o.packageName}/io.dcloud.PandoraEntry;S.title=${t};S.content=${JSON.stringify(a)};S.payload=${e};`,p+="S.unipush_version=2.0;",d&&c&&(p+=`S.unipush_data=${JSON.stringify({force_notification:d,path:c})};`),p+="end",u({intent:p});const l={ios:{type:"notify",payload:e,aps:{unipush_version:"2.0",alert:{title:t,body:a},"content-available":0,sound:""},auto_badge:"+1"},android:{ups:{notification:{title:t,body:a,click_type:"intent",intent:p},options:{HW:{},XM:{},VV:{},OP:{}}}}};c&&(l.ios.aps.unipush_data={force_notification:d,path:c}),s&&(l.android.ups.notification.url=s,l.android.ups.notification.click_type="url");const h=l.android.ups.options;if(1===this.message.content_available&&(delete l.ios.aps.alert,l.ios.aps["content-available"]=1),void 0===i&&(i="+1"),l.ios.auto_badge=i+"",h.HW["/message/android/notification/badge/class"]="io.dcloud.PandoraEntry","-"===i[0]||"+"===i[0]?h.HW["/message/android/notification/badge/add_num"]=i/1:h.HW["/message/android/notification/badge/set_num"]=i/1,r&&(l.ios.aps.sound=r+".caf"),n.HW&&(h.HW["/message/android/notification/channel_id"]=n.HW,h.HW["/message/android/notification/importance"]="NORMAL",r&&(h.HW["/message/android/notification/default_sound"]=!1,h.HW["/message/android/notification/sound"]="/raw/"+r)),n.XM&&(h.XM["/extra.channel_id"]=n.XM,r&&(h.XM["/extra.sound_uri"]=`android.resource://${o.packageName}/raw/${r}`)),n.OP&&(h.OP["/channel_id"]=n.OP),n.VV&&(h.VV["/classification"]=n.VV/1),n.VO&&(h.VV["/classification"]=n.VO/1),s){const e=l.android.ups.notification;e.click_type="url",e.url=s,delete e.intent}if("object"==typeof this.message.options){const e=this.message.options;e.IOS&&(l.ios.aps=this.deepObjectAssign(l.ios.aps,e.IOS),delete e.IOS),l.android.ups.options=this.deepObjectAssign(h,e)}return l}getPushMessage(){const{title:e,content:t,open_url:a,payload:s,force_notification:i,path:r}=this.message;if(a)return{notification:this.getPushChannel().android.ups.notification};const n={unipush_version:"2.0",payload:s,title:e,content:t};return n.force_notification=i,r&&(n.path=r),u({transmission:JSON.stringify(n)}),{transmission:JSON.stringify(n)}}async fastCustomTag(){return await this.request({method:"POST",module:"/push/fast_custom_tag",requestData:this.requestData})}async byTag(){return await this.request({method:"POST",module:"/push/tag",requestData:this.requestData})}async toListCid(e){if(e)u("有taskid直接复用：",e);else{const t=await this.request({method:"POST",module:"/push/list/message",requestData:this.requestData});if(u({getTaskidRes:t}),0!==t.errCode)return u("创建批量推送失败"),t;e=t.data.taskid,u("创建taskid：",e)}return await this.request({method:"POST",module:"/push/list/cid",requestData:{audience:this.requestData.audience,taskid:e,is_async:!1,need_alias_detail:!0}})}async toListAlias(e){const t=await this.request({method:"POST",module:"/push/list/message",requestData:this.requestData});if(0===t.errCode){const e=t.data.taskid;return await this.request({method:"POST",module:"/push/list/alias",requestData:{audience:this.requestData.audience,taskid:e,is_async:!1,need_alias_detail:!0}})}return t}async toSingleCid(e){const t=await this.request({method:"POST",module:"/push/single/cid",requestData:this.requestData});return"success"===t.msg&&(t.state=t.data[Object.keys(t.data)[0]][e]),t}async toSingleAlias(e){return await this.request({method:"POST",module:"/push/single/alias",requestData:this.requestData})}async toAll(){return await this.request({method:"POST",module:"/push/all",requestData:this.requestData})}}class g extends h{constructor(e){if(super(e),d=e.debug,this.disable_push_to_all=e.disable_push_to_all,c=e.getRequestBody,u=d?console.log:()=>{},d&&(u(`【info】正在运行的uni-cloud-push扩展库版本号为：${require("./package.json").version}。 关联的应用appId：${Object.keys(a)}`),u("config_info: "+JSON.stringify(a))),!e||!e.appId)throw new Error("appId 不能为空");this.appId=e.appId,this.setConfig(this.appId)}async sendMessage(e){this.message=e;let{user_id:a,user_tag:n,device_id:o,device_tag:d,push_clientid:c,getui_alias:p,getui_custom_tag:l,getui_big_data_tag:h,platform:g="ALL",request_id:m,group_name:y,settings:_,check_token:f=!0,before_id:q={"uni-id-users":!1,"uni-id-device":!1,"opendb-device":!1},taskid:b=!1,save_msg:T}=e;const k={appId:["String"],user_id:["String","Array"],user_tag:["String","Array"],device_id:["String","Array"],push_clientid:["String","Array"],getui_custom_tag:["String"],getui_big_data_tag:["Array"],getui_alias:["String","Array"],platform:["String","Array"],check_token:["Boolean"],mustReport:["Boolean"],must_report:["Boolean"],title:["String"],content:["String"],payload:["String","Object","Number"],force_notification:["Boolean"],badge:["Number","String"],channel:["Object"],request_id:["String"],group_name:["String"],sound:["String"],content_available:["Number"],open_url:["String"],settings:["Object"],options:["Object"],path:["String"],save_msg:["Boolean"]};for(const t in e){if(!(t in k))return{errCode:"uni-push-param-invalid",errMsg:"推送失败，意外的参数："+t};if(e[t]&&!k[t].includes(Object.prototype.toString.call(e[t]).replace(/[[\]]/g,"").split(" ")[1]))return{errCode:"uni-push-param-invalid",errMsg:"推送失败，参数："+t+"的数据类型必须为："+k[t].join("或")}}const w=["user_id","user_tag","device_id","device_tag","push_clientid","getui_alias","getui_custom_tag","getui_big_data_tag"];this.requestData={request_id:m,group_name:y||"",audience:{},settings:_||{},push_message:super.getPushMessage(),push_channel:super.getPushChannel()},this.requestData.request_id||(this.requestData.request_id=t.default.createHash("md5").update(Date.now()+Math.ceil(1e7*Math.random())+this.appId+""+a||n||o||d||c||p||l||h).digest("hex")),u("this.requestData.request_id",this.requestData.request_id);let S=!1,C=!1;for(let t=0;t<w.length;t++)if(e[w[t]]){S=w[t],C=e[w[t]];break}if(S&&!C)return{errCode:"uni-push-user-invalid",errMsg:S+"的值不能为空"};let D=!1,O=!1,v=!1;if(n){const e={dcloud_appid:this.appId};q["uni-id-users"]&&(e._id=i.gt(q["uni-id-users"])),"string"==typeof n&&(n=[n]),e.tags=i.in(n);const t=await s.collection("uni-id-users").where(e).limit(500).orderBy("_id","asc").get();if(u(e),u(`找到匹配的users数：${t.data.length}个，${JSON.stringify(t.data)}`),!t.data.length)return{errCode:"uni-push-user-invalid",errMsg:"推送失败，没有符合条件的消息接收者"};a=t.data.map((e=>e._id)),500===a.length&&(v=[...a].pop())}if(a){const e={appid:this.appId};q["uni-id-device"]&&(e._id=i.gt(q["uni-id-device"])),e.user_id="string"==typeof a?a:i.in(a),f&&(e.token_expired=i.gt(Date.now()));const t=await s.collection("uni-id-device").where(e).limit(500).orderBy("_id","asc").get();if(u(`找到匹配的users数：${t.data.length}个，${t.data}`),!t.data.length)return{errCode:"uni-push-user-invalid",errMsg:"推送失败，没有符合条件的消息接收者"};o=t.data.map((e=>e.device_id)),c=t.data.map((e=>e.push_clientid)),500===c.length&&(D=[...c].pop())}if("ALL"===g&&(g=!1),g||o){u(o,99898);let e={appid:this.appId};if(q["opendb-device"]&&(e._id=i.gt(q["opendb-device"])),o&&(e.device_id="string"==typeof o?o:i.in(o)),g){u({platform:g});const t=g.filter((e=>e.includes("app-"))).map((e=>e.slice(4)));u(e),e=i.and([e,i.or({uni_platform:"app",os_name:i.in(t)},{uni_platform:i.in(g)})])}u(e);const t=await s.collection("opendb-device").where(e).limit(500).orderBy("_id","asc").get();if(u(`找到匹配的opendb-device数：${t.data.length}个，${t.data}`),!t.data.length)return{errCode:"uni-push-user-invalid",errMsg:"推送失败，没有符合条件的消息接收者"};c=t.data.map((e=>e.push_clientid)),500===c.length&&(O=[...t.data.map((e=>e.push_clientid))].pop())}if(c){if(!0===T&&(a||n)){u("写入通知内容进数据库");const{title:e,content:t,payload:s,sound:i,open_url:o,path:d}=this.message,c={title:e,content:t,payload:s,sound:i,open_url:o,path:d};let p;c.is_read=!1,c.create_time=Date.now(),a&&(p="string"==typeof a?Object.assign(c,{user_id:a}):a.map((e=>({user_id:e,...c})))),n&&(p="string"==typeof n?Object.assign(c,{user_tag:n}):n.map((e=>({user_tag:e,...c}))));const{id:l}=await r.add(p);if("transmission"in this.requestData.push_message){const e=JSON.parse(this.requestData.push_message.transmission);e._id=l,this.requestData.push_message.transmission=JSON.stringify(e)}}else u("不写入-----");if("string"==typeof c&&(c=[c]),this.requestData.audience={cid:c},e.mustReport||e.must_report||c.length>1){const e=await super.toListCid(b);if("push_clientid"!==S){let t=!1;O&&(t={"opendb-device":O}),v&&(t={"uni-id-users":v}),D&&(t={"uni-id-users":a&&a[0],"uni-id-device":D}),O&&D&&v&&(t={"uni-id-users":a&&a[0],"uni-id-device":o&&o[0],"opendb-device":O}),t&&(e.before_id=t)}return e}return await super.toSingleCid()}return l?(this.requestData.audience={fast_custom_tag:l},await super.fastCustomTag()):h?(this.requestData.audience={tag:h},await super.byTag()):p?("string"==typeof p&&(p=[p]),this.requestData.audience={alias:p},p.length>1?await super.toListAlias():await super.toSingleAlias()):(u("群推"),!0!==this.disable_push_to_all?await super.toAll():void console.error("扩展库已禁用群推功能 参数 disable_push_to_all == true"))}async getAdminUrl(){u("pushConfig",o);const e={appid:o.appId,t:Date.now()+""},a=[];for(const t in e)a.push(t);u({keys:a}),a.sort();let s="";for(let t=0;t<a.length;t++)s+=a[t]+"="+e[a[t]]+"&";s+=o.mastersecret,u(s),u(JSON.stringify(e)),e.sign=t.default.createHash("MD5").update(s).digest("hex"),u(JSON.stringify(e));const i=await uniCloud.httpclient.request("https://test-dev.dcloud.net.cn/unipush/api/get-token",{method:"POST",data:e,contentType:"json",dataType:"json"});return"SUCCESS"===i.data.message?{errCode:0,data:`https://unipush.dcloud.net.cn/push/?mode=uni-admin&authToken=${i.data.data.token}&appId=${o.appId}`}:{errCode:i.data.code,errMsg:i.data.message}}setConfig(e){const t=a.app?a.app[e]:a[e];if(u(6666666,t),!t)throw d&&u({config:t,appId:e,configObj:a}),Error("应用appId："+e+"的uniPush服务，未关联当前服务空间；前往配置：https://dev.dcloud.net.cn/pages/app/push2/info");o=t}async stopTaskByTaskid(e){return await this.request({method:"DELETE",module:`/task/${e}`})}async getTaskScheduleByTaskid(e){return await this.request({method:"GET",module:`/task/schedule/${e}`})}async deleteTaskScheduleByTaskid(e){return await this.request({method:"DELETE",module:`/task/schedule/${e}`})}async getTaskDetail({taskid:e,cid:t}){return await this.request({method:"GET",module:`/task/detail/${t}/${e}`})}async cidBindAlias(e){return await this.request({module:"/user/alias",method:"POST",requestData:{data_list:e}})}async getAliasByCid(e){return await this.request({module:`/user/alias/cid/${e}`,method:"GET",requestData:{cid:e}})}async getCidByAlias(e){return await this.request({module:`/user/cid/alias/${e}`,method:"GET",requestData:{alias:e}})}async unboundAlias(e){return await this.request({method:"DELETE",module:"/user/alias",requestData:{data_list:e}})}async unboundAllAlias(e){return await this.request({method:"DELETE",module:`/user/alias/${e}`,requestData:{alias:e}})}async cidBindCustomTags({cid:e,custom_tag:t}){return"string"!=typeof e?{errMsg:"cid type error , must be a string",errCode:2001}:Array.isArray(t)?await this.request({module:"/user/custom_tag/cid/"+e,requestData:{custom_tag:t}}):{errMsg:"custom_tag type error , must be a Array",errCode:2001}}async cidsBindCustomTag({cids:e,custom_tag:t}){return"string"!=typeof t?{errMsg:"custom_tag type error , must be a string",errCode:2001}:Array.isArray(e)?await this.request({method:"PUT",module:"/user/custom_tag/batch/"+t,requestData:{cid:e}}):{errMsg:"cids type error , must be a Array",errCode:2001}}async cidsUnboundCustomTag({cids:e,custom_tag:t}){return"string"!=typeof t?{errMsg:"custom_tag type error , must be a string",errCode:2001}:Array.isArray(e)?await this.request({method:"DELETE",module:"/user/custom_tag/batch/"+t,requestData:{cid:e}}):{errMsg:"cids type error , must be a Array",errCode:2001}}async searchCustomTagByCid(e){if("string"!=typeof e)return{errMsg:"cid type error , must be a string",errCode:2001};const t=await this.request({method:"GET",module:`/user/custom_tag/cid/${e}`});if(0===t.errCode)for(const e in t.data)t.data[e]=t.data[e][0].split(" ");return t}async addCidToBlacklist(e){return"string"!=typeof e?{errMsg:"cid type error , must be a string",errCode:2001}:await this.request({method:"POST",module:`/user/black/cid/${e}`})}async removeCidInBlacklist(e){return"string"!=typeof e?{errMsg:"cid type error , must be a string",errCode:2001}:await this.request({method:"DELETE",module:`/user/black/cid/${e}`})}async getClientStatusByCid(e){return await this.request({method:"GET",module:"/user/status/"+e})}async getDeviceStatusByCid(e){return await this.request({method:"GET",module:`/user/deviceStatus/${e}`})}async getClientDetailByCid(e){return await this.request({method:"GET",module:`/user/detail/${e}`})}async setBadgeByCid({cid:e,badge:t}){return await this.request({method:"POST",module:`/user/badge/cid/${e}`,requestData:{badge:t}})}async getClientCount(e){return await this.request({method:"POST",module:"/user/count",requestData:e})}async getReport({taskid:e,actionIdList:t}){return"object"==typeof e&&(e=e.join(",")),await this.request({method:"GET",module:`/report/push/task/${e}`})}async getReportByGroupName(e){return await this.request({method:"GET",module:`/report/push/task_group/${e}`})}async getReportDetailByTaskid(e){return await this.request({method:"GET",module:`/report/push/task/${e}/detail`})}async getReportByDate(e){return await this.request({method:"GET",module:`/report/push/date/${e}`})}async getTodayReport(){return await this.request({method:"GET",module:"/report/push/count"})}async getClientReportByDate(e){return await this.request({method:"GET",module:`/report/user/date/${e}`})}async getTodayOnlineClientReport(){return await this.request({method:"GET",module:"/report/online_user",requestData:{}})}async request({method:e="POST",module:t,requestData:a}){let s=await this.getToken();const i=s.data;return u({token:i,res:s}),0!==s.errCode?s:(u("业务请求体：",{module:t,method:e,requestData:a}),u("url","https://restapi.getui.com/v2/"+o.appId+t,{method:e,headers:{"content-type":"application/json;charset=UTF-8",token:i,"cache-control":"no-cache"},contentType:"json",dataType:"json",data:a}),s=await uniCloud.httpclient.request("https://restapi.getui.com/v2/"+o.appId+t,{method:e,headers:{"content-type":"application/json;charset=UTF-8",token:i,"cache-control":"no-cache"},contentType:"json",dataType:"json",data:a}),c&&(p.push(a),s.data.requestBody=p),l(s.data))}async getToken(){const e=Date.now();if(this.token&&this.token.expired>e)return{errCode:0,errMsg:"成功获取缓存中有效的token",data:this.token.value};let a=await n.where({_id:"uni-push-token-"+o.appId,expired:i.gt(e)}).get();if(a.data[0])return this.token=a.data[0],{errCode:0,errMsg:"成功获取数据库中有效的token",data:this.token.value};const s=t.default.createHash("sha256").update(o.appkey+e+o.mastersecret).digest("hex");return a=await uniCloud.httpclient.request("https://restapi.getui.com/v2/"+o.appId+"/auth",{method:"POST",contentType:"json",dataType:"json",data:{sign:s,timestamp:e,appkey:o.appkey}}),"success"===a.data.msg?(this.token={value:a.data.data.token,expired:e+72e5},await n.doc("uni-push-token-"+o.appId).set(this.token),{errCode:0,errMsg:"获取token成功",data:this.token.value}):l(a.data)}deepObjectAssign(...e){const t=Object.assign({},...e);for(const a of e)for(const[e,s]of Object.entries(a))"object"==typeof s&&(t[e]=this.deepObjectAssign(t[e],s));return t}}function m(){Object.getPrototypeOf(uniCloud).getPushManager=function({appId:e,getRequestBody:t=!1}){return new g({appId:e,debug:!1,getRequestBody:t})}}m(),exports.init=m;
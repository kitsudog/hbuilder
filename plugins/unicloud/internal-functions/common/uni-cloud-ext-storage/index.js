"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("crypto");function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}require("path"),require("fs");var r=t(e);function a(e){if(e.__esModule)return e;var t=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(e).forEach((function(r){var a=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,a.get?a:{enumerable:!0,get:function(){return e[r]}})})),t}class n extends Error{constructor(e){super(e.message),this.errMsg=e.message||"",this.code=this.errCode=e.code,this.errSubject=e.subject,this.forceReturn=e.forceReturn||!1,this.cause=e.cause,Object.defineProperties(this,{message:{get(){return this.errMsg},set(e){this.errMsg=e}}})}toJSON(e=0){if(!(e>=10))return e++,{errCode:this.errCode,errMsg:this.errMsg,errSubject:this.errSubject,cause:this.cause&&this.cause.toJSON?this.cause.toJSON(e):this.cause}}}const i=Object.prototype.toString,o=Object.prototype.hasOwnProperty;function s(e,t){return o.call(e,t)}function c(e){return i.call(e).slice(8,-1).toLowerCase()}function u(e,t){return new Error(e.replace("%err%",t))}async function d(e,t){let r;try{r=await uniCloud.httpclient.request(e,{method:"POST",data:t,contentType:"json",dataType:"text",followRedirect:!0,timeout:6e4})}catch(e){if("ResponseTimeoutError"===e.name)return{code:999,message:"service timeout"};throw e.message=e.message.replace(/https?:\/\/(.*).dcloud.net.cn/,(function(e,t){return`service[${t}]`})),e}if(r.status>=400)return{code:r.status,message:r.data||"service error"};const a=JSON.parse(r.data);return a.ret?{code:a.ret,message:a.desc}:(delete a.ret,delete a.desc,a)}const l={PARAM_REQUIRED:50001,INVALID_PARAM:50002},f=Object.create(null);function h(e){switch(e.type){case"array":return"array";case"root":return"root";default:return"base"}}function p(e){return null==e||"string"==typeof e&&""===e.trim()}["string","boolean","number","null"].forEach((e=>{f[e]=function(t){return c(t)===e}}));var g=Object.freeze({__proto__:null,UniCloudError:n,hasOwn:s,isPlainObject:function(e){return"[object Object]"===i.call(e)},getType:c,checkRequiredParam:function e(t){const{param:r,rule:a,errTpl:n="%err%",paramPath:i=""}=t||{};Object.keys(a).forEach((t=>{if(!s(r,t))throw u(n,`缺少参数${i}${t}`);if(!r[t]&&!1!==r[t]&&0!==r[t])throw u(n,`参数${i}${t}值不可为空`);if("object"===c(a[t]))e({param:r[t],rule:a[t],errTpl:n,paramPath:`${t}.`});else{const e=c(r[t]);if(-1===a[t].indexOf(e))throw u(n,`参数${i}${t}类型不正确，期望传入类型${a[t].join("、")}，实际传入${e}`)}}))},getServiceSecret:function(){return JSON.parse(process.env.UNICLOUD_SERVICE_SECRET||"{}")},getRealSpaceId:function(e){const{provider:t,spaceId:r,useOldSpaceId:a}=e||{};return"aliyun"!==t||!0!==a||r.startsWith("mp-")?r:"mp-"+r},dcloudSign:function(e,t){const a=Object.keys(e).sort().filter((function(t){return void 0!==e[t]})).map((t=>`${t}=${""+e[t]}`));a.push(`apiSecret=${t}`);const n=r.default.createHash("md5");return n.update(a.join("&")),n.digest("hex").toLowerCase()},requestDCloud:d,requestDCloudWithFallback:async function(e,t){let r=null;const a=e.length,n=Math.floor(Math.random()*a);let i=0;for(;!r;){const o=e[(n+i)%a];r=await d(o,t),r.code<600&&r.code>=400&&i<e.length-1&&(r=null),i++}return r},getServiceSpaceProvider:function(e){switch(e){case"tcb":case"tencent":return"tcb";default:return e}},getUserSpaceProvider:function(e){switch(e){case"tcb":case"tencent":return"tencent";default:return e}},Validator:class{constructor(){this.baseValidator=f,this.customValidator=Object.create(null)}mixin(e,t){this.customValidator[e]=t}_isMatchBaseType(e,t){const r=this._getRealBaseValidator(t.type);if("function"!=typeof r)throw new Error(`Invalid schema type: ${t.type}`);return r(e)}_isMatchArrayType(e,t){return"array"===c(e)&&!(t.children&&t.children.length&&e.some((e=>!this._isMatchUnionType(e,t))))}_isMatchUnionType(e,t){if(!t.children||0===t.children.length)return!0;const r=t.children;for(let t=0;t<r.length;t++){const a=r[t];let n=!1;switch(h(a)){case"base":n=this._isMatchBaseType(e,a);break;case"array":n=this._isMatchArrayType(e,a)}if(n)return!0}return!1}_getRealBaseValidator(e){return this.customValidator[e]||this.baseValidator[e]}get validator(){const e=this;return new Proxy({},{get:(t,r)=>{if("string"!=typeof r)return;const a=this._getRealBaseValidator(r);if(a)return a;const n=function(e){const t=function(e){let t=0;const r=[];let a="";for(;t<e.length;){const n=e[t];switch(n){case"|":case"<":case">":a&&r.push(a),r.push(n),a="";break;default:a+=n}t++,t===e.length&&a&&r.push(a)}return r}(e);let r=0,a=t[r];const n={type:"root",children:[],parent:null};let i=n;for(;a;){switch(a){case"array":{const e={type:"array",children:[],parent:i};i.children.push(e),i=e;break}case"<":if("array"!==i.type)throw new Error('Invalid validator token "<"');break;case">":if("array"!==i.type)throw new Error('Invalid validator token ">"');i=i.parent;break;case"|":if("array"!==i.type&&"root"!==i.type)throw new Error('Invalid validator token "|"');break;default:i.children.push({type:a})}r++,a=t[r]}return n}(r);return function(t,r){return!!e._isMatchUnionType(t,n)}}})}validate(e={},t={}){for(const r in t){let a=t[r];"string"===c(a)&&(a={required:!0,type:a});const{required:n,type:i}=a;if(p(e[r])){if(n)return{code:l.PARAM_REQUIRED,message:`Parameter ${r} is required`};continue}const o=this.validator[i];if(!o)throw new Error(`Invalid schema type: ${i}`);if(!1===o(e[r],r))return{code:l.INVALID_PARAM,message:`Parameter ${r} is invalid`}}}},VALIDATE_ERROR:l}),m=a(g);const y=/^multipart\/.+?(?:;\s*boundary=(?:(?:"(.+)")|(?:([^\s]+))))$/i,b=/Content-Disposition:\sform-data;\sname="(.+?)"(?:;\sfilename="(.+?)")?/i,w=/Content-Type:\s(.+?)$/i,$="\r\n";var O={formDataUtil:{FormData:class{constructor(){this._shouldUseCache=!1,this._cachedBuffer=null,this._lineBreak="\r\n",this._boundary="------FormDataBaseBoundary"+Math.random().toString(36).substring(2),this.dataList=[]}_addData(e){if(this._shouldUseCache=!1,0===this.dataList.length)return void this.dataList.push(e);const t=this.dataList[this.dataList.length-1];switch(`${Buffer.isBuffer(t)?"buffer":"other"}_${Buffer.isBuffer(e)?"buffer":"other"}`){case"buffer_buffer":this.dataList.push(this._lineBreak),this.dataList.push(e);break;case"buffer_other":this.dataList.push(this._lineBreak+e);break;case"other_buffer":this.dataList[this.dataList.length-1]=t+"\r\n",this.dataList.push(e);break;case"other_other":this.dataList[this.dataList.length-1]=t+"\r\n"+e}}append(e,t,r){this._addData("--"+this._boundary);let a=`Content-Disposition: form-data; name="${encodeURIComponent(e)}"`;if(Buffer.isBuffer(t)){if(!r.filename||!r.contentType)throw new Error("filename and contentType required");a+=`; filename="${encodeURIComponent(r.filename)}"`,this._addData(a),this._addData(`Content-Type: ${r.contentType}`),this._addData(""),this._addData(t)}else this._addData(a),this._addData(""),this._addData(t)}getHeaders(e){const t={"Content-Type":"multipart/form-data; boundary="+this._boundary};return Object.assign(t,e)}getBuffer(){if(this._shouldUseCache)return this._cachedBuffer;this._shouldUseCache=!0;let e=Buffer.alloc(0);return this.dataList.forEach((t=>{e=Buffer.isBuffer(t)?Buffer.concat([e,t]):Buffer.concat([e,Buffer.from(""+t)])})),e=Buffer.concat([e,Buffer.from(`${this._lineBreak}--${this._boundary}--`)]),this._cachedBuffer=e,e}},formParser:e=>{const t=(e.headers["content-type"]||e.headers["Content-Type"]).match(y),r=t[1]||t[2],a=function(e,t){let r=0,a=0;const n=[];for(;-1!==(a=e.indexOf(t,r));)n.push(e.slice(r,a)),r=a+t.length,a=e.indexOf(t,r);return n}(Buffer.from(e.body,"base64"),Buffer.from(`--${r}`)).map((e=>function(e){let t=e.indexOf($)+2,r=t;const a=e.lastIndexOf($),n=[];for(;-1!==(r=e.indexOf($,t));)if(n.push(e.slice(t,r)),t=r+2,0===n[n.length-1].length){n.push(e.slice(t,a));break}return n}(e).filter((e=>e.length>0)))).filter((e=>2===e.length||3===e.length||4===e.length)).map((e=>{const t={},r=e[0].toString().match(b);switch(t.name=decodeURIComponent(r[1]),e.length){case 2:t.value=e[1].toString();break;case 3:t.filename=decodeURIComponent(r[2]),t.contentType=e[1].toString().match(w)[1],t.fileContent=e[2];break;case 4:t.filename=decodeURIComponent(r[2]),t.contentType=e[1].toString().match(w)[1],t.fileContent=e[3]}return t})),n={};return a.forEach((e=>{const t=e.name;delete e.name,n[t]=e.fileContent?e:e.value})),n}},...a(Object.freeze({__proto__:null,throwError:function(e,t,r){throw new n({subject:"uni-cloud-ext-storage",code:e,message:t,cause:r})}}))};const _=r.default;function k(e){return e.replace(/\//g,"_").replace(/\+/g,"-")}var B={hmacSha1:function(e,t){const r=_.createHmac("sha1",t);return r.update(e),r.digest("base64")},urlsafeBase64Encode:function(e){return k(Buffer.from(e).toString("base64"))},base64ToUrlSafe:k,urlSafeToBase64:function(e){return e.replace(/_/g,"/").replace(/-/g,"+")},getQiniuAccessToken:function(e,t,r){const a=function(e){let t=e.method+" "+e.path;return e.query&&(t+="?"+e.query),t+="\nHost: "+e.host,"object"==typeof e.header&&(e.header["content-type"]&&(t+="\nContent-Type: "+e.header["content-type"]),Object.keys(e.header).filter((e=>e.toLowerCase().startsWith("x-qiniu-"))).sort().forEach((r=>{t+="\n"+r+": "+e.header[r]}))),t+="\n\n",e.body&&"application/octet-stream"!==e["content-type"]&&(t+=e.body),t}(e),n=_.createHmac("sha1",t).update(a).digest();return`${r}:${Buffer.from(n).toString("base64").replace(/\+/g,"-").replace(/\//g,"_")}`},getQBoxAccessToken:function(e,t,r){const a=function(e){const{path:t,query:r="","content-type":a,body:n=""}=e;let i=t;return r&&(i+=`?${r}`),i+="\n",n&&"application/x-www-form-urlencoded"===a&&(i+=n),i}(JSON.parse(JSON.stringify(e))),n=_.createHmac("sha1",t).update(a).digest();return`${r}:${Buffer.from(n).toString("base64").replace(/\+/g,"-").replace(/\//g,"_")}`},parseURL:function(e){const t=e.match(/^(\w+):\/\/([^/?#]+)([^?#]+)?\??([^#]*)/),[,r,a,n,i]=t||[];return{protocol:r,host:a,path:n||"/",query:i||void 0}},calcSize:function(e=0,t,r,a=2,n="auto"){let i=0,o="";if((e=parseFloat(e))<r||t.length<=1)o=t[0],i=parseFloat(e.toFixed(a));else for(let s=1;s<t.length;s++){const c=t[s];if(e/=r,"auto"===n){if(e<r){o=c,i=parseFloat(e.toFixed(a));break}}else if(n===c){o=c,i=parseFloat(e.toFixed(a));break}}return{size:i,type:o,title:i+" "+o}}};const{Validator:S}=m,C=r.default,{formDataUtil:v,throwError:x}=O,E=B,T="qiniu://";function D(e){if(0===e.indexOf("qiniu://"))e=e.substring(8);else if(0===e.indexOf("http://")||0===e.indexOf("https://")){let t=e.indexOf("://")+3;t=e.indexOf("/",t);let r=-1===e.indexOf("?")?e.length:e.indexOf("?");r=-1!==e.indexOf("#")&&e.indexOf("#")<r?e.indexOf("#"):r,e=e.substring(t+1,r)}return e}function L(e){const t=[];return JSON.parse(JSON.stringify(e)).forEach((e=>{t.push(D(e))})),t}function F(e){return{"89504E47":"image/png",47494638:"image/gif",25504446:"application/pdf","504B0304":"application/zip","504B0506":"application/zip","504B0708":"application/zip",FFD8FFE0:"image/jpeg",FFD8FFE1:"image/jpeg",FFD8FFE2:"image/jpeg","255044462D312E":"application/pdf","504B34":"application/zip","526172211A0700":"application/x-rar-compressed","1F8B08":"application/gzip","377ABCAF271C":"application/7z",D0CF11E0A1B11AE1:"application/msword","25504446A25A":"application/epub+zip","7B5C727466":"application/pdf","425A68":"application/bzip2",38425053:"application/x-7z-compressed","504B030414000600":"application/x-java-archive","4D5A90":"application/x-dosexec",CAFEBABE:"application/java-vm","4D546864":"audio/midi"}[e.slice(0,4).toString("hex").toUpperCase()]||"application/octet-stream"}var U={qiniu:class{constructor(e){const t=(new S).validate(e,{bucketName:"string",ak:"string",sk:"string",domain:"string"});t&&x(t.code,t.message);const{bucketName:r,ak:a,sk:n,domain:i}=e,o=-1===i.indexOf("https://")&&-1===i.indexOf("http://")?`https://${i}`:i;this.config={bucketName:r,ak:a,sk:n,domain:o}}async request(e){let{url:t,method:r,header:a,data:n,authType:i="Qiniu",debug:o=!1}=e;try{Buffer.isBuffer(n)||"object"!=typeof n||(n=JSON.parse(JSON.stringify(n)))}catch(e){}const{host:s,path:c,query:u}=E.parseURL(t);let d;n&&"{}"!==JSON.stringify(n)&&(d="string"==typeof n?n:JSON.stringify(n));const l={method:r,path:c,query:u,host:s,header:a,body:d};let f;"Qiniu"===i?f=E.getQiniuAccessToken(l,this.config.sk,this.config.ak):"QBox"===i?f=E.getQBoxAccessToken(l,this.config.sk,this.config.ak):"Bearer"===i&&(f=this.config.accessToken||await this.getMainOauth2Token());const h={url:t,method:l.method,header:{...a},data:n};f&&(h.header||(h.header={}),h.header.Authorization=`${i} ${f}`),o&&console.log("requestBody: ",h);const p=await uniCloud.request(h);o&&console.log("requestRes: ",p);let g=0,m="ok";return 200!==p.statusCode&&(g=p.statusCode,m="异常",p.data&&(g=p.data.code?p.data.code:p.statusCode,m=p.data.error?p.data.error:"异常")),{code:g,msg:m,errCode:g,errMsg:m,data:p.data}}getUploadFileOptions(e){let{deadline:t,expiresIn:r=3600,forceSaveKey:a=!0,cloudPath:n,allowUpdate:i=!1,fsizeMin:o=0,fsizeLimit:s=1099511627776,returnBody:c=JSON.stringify({key:"$(key)",hash:"$(etag)",name:"$(fname)",size:"$(fsize)",width:"$(imageInfo.width)",height:"$(imageInfo.height)",format:"$(imageInfo.format)"}),region:u="z0"}=e;n||(n=function(){const e=C.randomBytes(16);return e[6]=15&e[6]|64,e[8]=63&e[8]|128,"cloudstorage/"+e.toString("hex",0,4)+"-"+e.toString("hex",4,6)+"-"+e.toString("hex",6,8)+"-"+e.toString("hex",8,10)+"-"+e.toString("hex",10,16)}());const d=i?0:1,l=t||Math.floor(Date.now()/1e3)+r,f={scope:`${this.config.bucketName}:${n}`,forceSaveKey:a,saveKey:n,deadline:l,insertOnly:d,fsizeMin:o,fsizeLimit:s,returnBody:c},h=E.urlsafeBase64Encode(JSON.stringify(f)),p=E.hmacSha1(h,this.config.sk),g=E.base64ToUrlSafe(p),m=`${this.config.ak}:${g}:${h}`,y={z0:"https://upload.qiniup.com"},b=y[u]||y.z0;return{expTime:l,cloudPath:n,fileID:`${T}${n}`,fileURL:`${this.config.domain}/${n}`,uploadFileOptions:{url:b,name:"file",formData:{token:m,key:n}}}}getTempFileURL(e){const{fileList:t,expiresIn:r=3600}=e,a=(new S).validate(e,{fileList:"array<string>"});a&&x(a.code,a.message);const n=Math.floor(Date.now()/1e3)+r,i=[];return L(t).forEach((e=>{let t=`${this.config.domain}/${e}?e=${n}`;const r=E.hmacSha1(t,this.config.sk),a=E.base64ToUrlSafe(r);t+=`&token=${this.config.ak}:${a}`,i.push({fileID:`${T}${e}`,cloudPath:e,tempFileURL:t})})),{fileList:i}}async uploadFile(e={}){let{fileContent:t,cloudPath:r,allowUpdate:a=!1}=e;const n=(new S).validate(e,{cloudPath:{required:!1,type:"string"}});n&&x(n.code,n.message),t||x(50001,"fileContent is required");const i=new v.FormData,o=this.getUploadFileOptions({cloudPath:r,allowUpdate:a}),s=o.uploadFileOptions.url,c=o.uploadFileOptions.formData.token;r||(r=o.cloudPath),i.append("file",t,{filename:r,contentType:F(t)}),i.append("token",c),i.append("key",r);const u=await this.request({url:s,method:"POST",header:i.getHeaders(),data:i.getBuffer()}),d={};return 0===u.code?(d.cloudPath=r,d.fileID=`${T}${r}`,d.fileURL=`${this.config.domain}/${r}`):(d.errCode=u.code,d.errMsg=u.msg),d}async downloadFile(e={}){const{fileID:t}=e,r=(new S).validate(e,{fileID:"string"});r&&x(r.code,r.message);const a=this.getTempFileURL({fileList:[t]}).fileList[0].tempFileURL,n=await uniCloud.request({url:a,method:"GET",responseType:"buffer",header:{"cache-control":"no-cache"}}),i={};return 200===n.statusCode&&(i.fileContent=n.data),i}async deleteFile(e={}){const{fileList:t=[]}=e,r=(new S).validate(e,{fileList:"array<string>"});r&&x(r.code,r.message);let a="https://rs.qiniuapi.com/batch";return L(t).forEach(((e,t)=>{const r=E.urlsafeBase64Encode(`${this.config.bucketName}:${e}`);a+=0===t?"?":"&",a+=`op=/delete/${r}`})),{fileList:(await this.request({url:a,method:"GET",header:{"content-type":"application/x-www-form-urlencoded"},authType:"Qiniu"})).data.map(((e,t)=>({code:200===e.code?0:e.code,msg:e.data&&e.data.error?e.data.error:"",index:t})))}}async updateFileStatus(e={}){const{fileID:t,isPrivate:r}=e,a=(new S).validate(e,{fileID:"string"});a&&x(a.code,a.message);const n=D(t),i=r?1:0,o=E.urlsafeBase64Encode(`${this.config.bucketName}:${n}`),s=await this.request({url:`https://rs.qiniuapi.com/chstatus/${o}/status/${i}`,method:"GET",header:{"content-type":"application/x-www-form-urlencoded"},authType:"Qiniu"});return await this.refreshCdnCache({fileList:[t]}),{errCode:s.code,errMsg:s.msg}}async refreshCdnCache(e={}){const{fileList:t,fileDirs:r}=e;let a,n;t&&t.length>0&&(a=t.map((e=>{const t=D(e);return`${this.config.domain}/${t}`}))),r&&r.length>0&&(n=r.map((e=>{const t=D(e);return`${this.config.domain}/${t}`})));const i=await this.request({url:"https://fusion.qiniuapi.com/v2/tune/refresh",method:"POST",header:{"content-type":"application/json"},authType:"QBox",data:{urls:a,dirs:n}});return{errCode:i.code,errMsg:i.msg}}getCloudPath(e){return D(e)}}};let j;function I(){try{return j||(j=JSON.parse(process.env.UNICLOUD_EXT_STORAGE_CONFIG),j)}catch(e){O.throwError(51001,"未找到“关联当前服务空间”的扩展储存服务")}}function R(){Object.getPrototypeOf(uniCloud).getExtStorageManager=function(e={provider:""}){const t=e.provider,r=U[t],a=I()[t];return r||O.throwError(51002,`uniCloud.getExtStorageManager不支持provider:"${t}"`),a||O.throwError(51003,`当前空间不支持provider:"${t}"`),new r({...e,...a})}}R(),exports.init=R;
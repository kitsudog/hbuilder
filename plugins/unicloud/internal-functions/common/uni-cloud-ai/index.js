"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("crypto");require("path"),require("fs");var t=require("events"),s=require("url"),r=require("https");function a(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=a(e),i=a(s),n=a(r);class c extends Error{constructor(e){super(e.message),this.errMsg=e.message||"",this.code=this.errCode=e.code,this.errSubject=e.subject,this.forceReturn=e.forceReturn||!1,this.cause=e.cause,Object.defineProperties(this,{message:{get(){return this.errMsg},set(e){this.errMsg=e}}})}toJSON(e=0){if(!(e>=10))return e++,{errCode:this.errCode,errMsg:this.errMsg,errSubject:this.errSubject,cause:this.cause&&this.cause.toJSON?this.cause.toJSON(e):this.cause}}}const p=Object.prototype.toString;function u(e){return p.call(e).slice(8,-1).toLowerCase()}function h(){return JSON.parse(process.env.UNICLOUD_SERVICE_SECRET||"{}")}async function d(e,t){let s;try{s=await uniCloud.httpclient.request(e,{method:"POST",data:t,contentType:"json",dataType:"text",followRedirect:!0,timeout:6e4})}catch(e){if("ResponseTimeoutError"===e.name)return{code:999,message:"service timeout"};throw e.message=e.message.replace(/https?:\/\/(.*).dcloud.net.cn/,(function(e,t){return`service[${t}]`})),e}if(s.status>=400)return{code:s.status,message:s.data||"service error"};const r=JSON.parse(s.data);return r.ret?{code:r.ret,message:r.desc}:(delete r.ret,delete r.desc,r)}const l=50001,m=50002,_=Object.create(null);function g(e){switch(e.type){case"array":return"array";case"root":return"root";default:return"base"}}function f(e){return null==e||"string"==typeof e&&""===e.trim()}["string","boolean","number","null"].forEach((e=>{_[e]=function(t){return u(t)===e}}));class y{constructor(){this.baseValidator=_,this.customValidator=Object.create(null)}mixin(e,t){this.customValidator[e]=t}_isMatchBaseType(e,t){const s=this._getRealBaseValidator(t.type);if("function"!=typeof s)throw new Error(`Invalid schema type: ${t.type}`);return s(e)}_isMatchArrayType(e,t){return"array"===u(e)&&!(t.children&&t.children.length&&e.some((e=>!this._isMatchUnionType(e,t))))}_isMatchUnionType(e,t){if(!t.children||0===t.children.length)return!0;const s=t.children;for(let t=0;t<s.length;t++){const r=s[t];let a=!1;switch(g(r)){case"base":a=this._isMatchBaseType(e,r);break;case"array":a=this._isMatchArrayType(e,r)}if(a)return!0}return!1}_getRealBaseValidator(e){return this.customValidator[e]||this.baseValidator[e]}get validator(){const e=this;return new Proxy({},{get:(t,s)=>{if("string"!=typeof s)return;const r=this._getRealBaseValidator(s);if(r)return r;const a=function(e){const t=function(e){let t=0;const s=[];let r="";for(;t<e.length;){const a=e[t];switch(a){case"|":case"<":case">":r&&s.push(r),s.push(a),r="";break;default:r+=a}t++,t===e.length&&r&&s.push(r)}return s}(e);let s=0,r=t[s];const a={type:"root",children:[],parent:null};let o=a;for(;r;){switch(r){case"array":{const e={type:"array",children:[],parent:o};o.children.push(e),o=e;break}case"<":if("array"!==o.type)throw new Error('Invalid validator token "<"');break;case">":if("array"!==o.type)throw new Error('Invalid validator token ">"');o=o.parent;break;case"|":if("array"!==o.type&&"root"!==o.type)throw new Error('Invalid validator token "|"');break;default:o.children.push({type:r})}s++,r=t[s]}return a}(s);return function(t,s){return!!e._isMatchUnionType(t,a)}}})}validate(e={},t={}){for(const s in t){let r=t[s];"string"===u(r)&&(r={required:!0,type:r});const{required:a,type:o}=r;if(f(e[s])){if(a)return{code:l,message:`Parameter ${s} is required`};continue}const i=this.validator[o];if(!i)throw new Error(`Invalid schema type: ${o}`);if(!1===i(e[s],s))return{code:m,message:`Parameter ${s} is invalid`}}}}const v=50001,E=50002,w=6e4,k=60001,S=60002,b=60003,q=60004,T="uni-cloud-ai";function I(e,t,s){throw C(e,t,s)}function C(e,t,s){return new c({subject:T,code:e,message:t,cause:s})}const M=18e4;class ${constructor(){this._validator=new y}_validate(e,t){const s=this._validator.validate(e,t);s&&I(s.code,s.message)}_parseMessages(e){e||I(v,'Parameter "messages" required'),"array"!==u(e)&&I(E,'Parameter "messages" is empty'),0===e.length&&I(E,'Parameter "messages" is empty')}_autoSSE(e){const{response:t,sseChannel:s,streamEventForSSE:r}=e||{},a=uniCloud.deserializeSSEChannel(s);return new Promise(((e,s)=>{t.on(r,(async e=>{await a.write(e)})),t.on("error",(async e=>{await a.end({errCode:e.errCode||e.code,errMsg:e.errMsg||e.message}),s(e)})),t.on("end",(async()=>{await a.end(),e({errCode:0,errMsg:""})}))}))}}class x extends t.EventEmitter{constructor(e){super();const{parseError:t}=e||{};this._parseError=t,this._errorOccurred=!1,this._tempLine=[]}_flushLine(e=!1){if(0===this._tempLine.length&&!e)return;const t=this._tempLine.join("");this._tempLine=[],this.emit("line",t)}_parseStreamError(e,t,s){try{this._parseError(e,t,s)}catch(e){this._emitError(e)}}_throwError(e,t){try{I(e,t)}catch(e){this._emitError(e)}}_emitError(e){this._errorOccurred||(this._errorOccurred=!0,this.emit("error",e))}_emitEvent(e,...t){this._errorOccurred||this.emit(e,...t)}}class O extends x{constructor(e){const{response:t,parseError:s}=e||{};super({parseError:s}),this._response=t,this._status=this._response.statusCode,this._initEvent()}_parserErrorResponse(e){try{const{base_resp:t}=JSON.parse(e);t&&t.status_code&&this._parseStreamError(t.status_code,t.status_msg)}catch(e){this._emitError(e)}}_parseData(e){const t=e.toString("utf8");if(!/^data:/.test(t))return void this._parserErrorResponse(t);const s=t.split(/\n+/).map((e=>e.replace(/^data:/,"").trim()));for(let t=0;t<s.length;t++){const r=s[t];if(0===r.length)continue;let a;try{a=JSON.parse(r)}catch(e){return void this._emitError(e)}const{base_resp:o,choices:i,usage:n}=a||{};if(n&&(this._usage={totalTokens:n.total_tokens}),o&&o.status_code)return void this._parseStreamError(o.status_code,o.status_msg);const c=i&&a.choices[0];if(!c)continue;const p=c&&c.delta;if(!p)continue;this._emitEvent("message",p),this._emitEvent("optimizedMessage",p);const u=p.split(/\n/);for(let e=0;e<u.length;e++){const t=u[e];e>0&&this._flushLine(!0),t.length>0&&this._tempLine.push(t)}}}_initEvent(){this._response.on("data",(e=>{if(this._status>=400){let t;try{t=JSON.parse(e.toString("utf8"))}catch(e){return void this._emitError(e)}const{base_resp:s}=t;return s&&s.status_code?void this._parseStreamError(s.status_code,s.status_msg):void this._throwError(w,`Request failed with status ${this._status}${t?", "+JSON.stringify(t):""}`)}this._parseData(e)}));let e=!1;this._response.on("close",(()=>{e=!0,this._status<400&&(this._flushLine(),this._emitEvent("end",{usage:this._usage}))})),this._response.on("error",(e=>{this._emitError(e)})),setTimeout((()=>{e||(!this._response.destroyed&&this._response.destroy(),this._throwError(w,"A network error was encountered while requesting the service: Network timeout"))}),M)}}class R extends x{constructor(e){const{response:t,parseError:s}=e||{};super({parseError:s}),this._response=t,this._status=this._response.statusCode,this._leftover=Buffer.alloc(0),this._eol=Buffer.from("\n","utf8"),this._messageCount=0,this._optimizedMessage="",this._initEvent()}_parseDataLine(e){const t=e.replace(/^data:/,"").trim();if("[DONE]"===t||0===t.length)return;if(0===t.length)return;let s;try{s=JSON.parse(t)}catch(e){return void this._emitError(e)}const r=s&&s.choices&&s.choices[0];if(!r)return;const a=r&&r.delta&&r.delta.content;if(!a)return;this._emitEvent("message",a),this._messageCount<5?this._emitEvent("optimizedMessage",a):(this._optimizedMessage+=a,this._optimizedMessage.length>20&&this._flushOptimizedMessage()),this._messageCount++;const o=a.split(/\n/);for(let e=0;e<o.length;e++){const t=o[e];e>0&&this._flushLine(!0),t.length>0&&this._tempLine.push(t)}}_flushOptimizedMessage(){if(0===this._optimizedMessage.length)return;const e=this._optimizedMessage;this._optimizedMessage="",this._emitEvent("optimizedMessage",e)}_parseData(e){const t=e.indexOf(this._eol);if(t>-1){const s=Buffer.concat([this._leftover,e.slice(0,t)]);this._parseDataLine(s.toString("utf8")),this._leftover=Buffer.alloc(0);const r=e.slice(t+this._eol.byteLength,e.byteLength);r.byteLength>0&&this._parseData(r)}else this._leftover=Buffer.concat([this._leftover,e])}_initEvent(){this._response.on("data",(e=>{if(this._status>=400){const t=JSON.parse(e.toString("utf8")),{error:s}=t;return s?void this._parseStreamError(this._status,s.message,s.code):void this._throwError(w,`Request failed with status ${this._status}${t?", "+JSON.stringify(t):""}`)}this._parseData(e)}));let e=!1;this._response.on("close",(()=>{e=!0,this._status<400&&(this._flushLine(),this._flushOptimizedMessage(),this._emitEvent("end"))})),this._response.on("error",(e=>{this._emitError(e)})),setTimeout((()=>{e||(!this._response.destroyed&&this._response.destroy(),this._throwError(w,"A network error was encountered while requesting the service: Network timeout"))}),M)}}class N extends ${constructor(e){super();const{apiKey:t,proxy:s}=e||{};this._validate({apiKey:t},{apiKey:"string"}),this._apiKey=t,this._proxy=s,this._proxy&&(this._proxy=0===this._proxy.indexOf("https://")?this._proxy:"https://"+this._proxy)}_getRequestUrl(e,t){return`${this._proxy||"https://api.openai.com"}/v1/${e}`}_getRequestHeaders(){return{Authorization:`Bearer ${this._apiKey}`}}async _request(e,t){let s;try{s=await uniCloud.httpclient.request(e,{headers:this._getRequestHeaders(),method:"POST",dataType:"json",contentType:"json",data:t,followRedirect:!0,timeout:M})}catch(e){I(w,"A network error was encountered while requesting the service: "+this._parseErrorMessage(e.message))}if(s.status>=400){const{error:e}=s.data||{};e&&this._parseError(s.status,e.message,e.code),I(w,`Request failed with status ${s.status}${s.data?", "+JSON.stringify(s.data):""}`)}const{error_code:r,error_message:a}=s.data||{};return r&&this._parseError(r,a),s.data}async _requestStream(e,t){const{hostname:s,protocol:r,path:a}=i.default.parse(e);return new Promise(((e,o)=>{const i=JSON.stringify(t),c=n.default.request({protocol:r,hostname:s,port:443,path:a,method:"POST",headers:{...this._getRequestHeaders(),"Content-Type":"application/json","Content-Length":Buffer.byteLength(i)}},(t=>{e(t)}));c.on("error",(e=>{o(C(w,"A network error was encountered while requesting the service: "+this._parseErrorMessage(e.message)))})),c.write(i),c.end()}))}_parseErrorMessage(e){return e.replace(/https:\/\/.*openai.com.*\s/,"* ").replace(/https:\/\/.*openai.com.*$/,"")}_parseError(e,t,s){switch(t=this._parseErrorMessage(t),e){case 400:"content_filter"===s&&I(q,t);break;case 401:I(S,"Incorrect API key provided");case 429:I(b,t)}I(k,`${t}, service provider error code: ${e}`)}_parseUsage(e){return{promptTokens:e.prompt_tokens,completionTokens:e.completion_tokens,totalTokens:e.total_tokens}}_parseChoices(e){return e.map((e=>{const{message:t,finish_reason:s}=e;return{message:{role:t.role,content:t.content},finishReason:s}}))}_parseChatResult(e){const{id:t,choices:s,usage:r}=e,a=this._parseChoices(s),o=a[0];return"content_filter"===o.finishReason&&I(q,"Output sensitive, content is seriously sensitive"),{id:t,reply:o.message.content,choices:a,usage:this._parseUsage(r)}}async chatCompletion(e){const{messages:t=[],maxTokens:s,tokensToGenerate:r,temperature:a,topP:o,model:i="gpt-3.5-turbo",stream:n=!1,streamEventForSSE:c="message",sseChannel:p}=e||{};this._validate({messages:t,tokensToGenerate:r,temperature:a,topP:o,model:i,stream:n},{messages:"array",maxTokens:{required:!1,type:"number"},tokensToGenerate:{required:!1,type:"number"},temperature:{required:!1,type:"number"},topP:{required:!1,type:"number"},model:{required:!1,type:"string"},stream:{required:!1,type:"boolean"}}),s&&console.warn('Parameter "maxTokens" has been deprecated, please use the tokensToGenerate parameter instead'),super._parseMessages(t);const u={model:i,messages:t,max_tokens:r||s,temperature:a,top_p:o,stream:n},h=this._getRequestUrl("chat/completions");if(!n){const e=await this._request(h,u);return this._parseChatResult(e)}const d=await this._requestStream(h,u),l=new R({response:d,parseError:this._parseError.bind(this)});return p?this._autoSSE({response:l,sseChannel:p,streamEventForSSE:c}):l}}class P extends x{constructor(e){const{response:t,parseError:s}=e||{};super({parseError:s}),this._response=t,this._status=this._response.statusCode,this._leftover=Buffer.alloc(0),this._eol=Buffer.from("\n","utf8"),this._initEvent()}_parserErrorResponse(e){try{const{error_code:t,error_msg:s}=JSON.parse(e);t&&this._parseStreamError(t,s)}catch(e){this._emitError(e)}}_parseDataLine(e){const t=e.toString("utf8").trim();if(!t)return;if(!/^data:/.test(t))return void this._parserErrorResponse(t);const s=t.split(/\n+/).map((e=>e.replace(/^data:/,"").trim()));for(let t=0;t<s.length;t++){const r=s[t];if(0===r.length)continue;let a;try{a=JSON.parse(r)}catch(e){return void this._emitError(e)}const{error_code:o,error_msg:i,result:n,usage:c}=a||{};if(c&&(this._usage={totalTokens:c.total_tokens,promptTokens:c.prompt_tokens,completionTokens:c.total_tokens-c.prompt_tokens}),o)return void this._parseStreamError(o,i);const p=n;if(!p)continue;this._emitEvent("message",p),this._emitEvent("optimizedMessage",p);const u=p.split(/\n/);for(let e=0;e<u.length;e++){const t=u[e];e>0&&this._flushLine(!0),t.length>0&&this._tempLine.push(t)}}}_parseData(e){const t=e.indexOf(this._eol);if(t>-1){const s=Buffer.concat([this._leftover,e.slice(0,t)]);this._parseDataLine(s.toString("utf8")),this._leftover=Buffer.alloc(0);const r=e.slice(t+this._eol.byteLength,e.byteLength);r.byteLength>0&&this._parseData(r)}else this._leftover=Buffer.concat([this._leftover,e])}_initEvent(){this._response.on("data",(e=>{if(this._status>=400){let t;try{t=JSON.parse(e.toString("utf8"))}catch(e){return void this._emitError(e)}const{error_code:s,error_msg:r}=t;return s?void this._parseStreamError(s,r):void this._throwError(w,`Request failed with status ${this._status}${t?", "+JSON.stringify(t):""}`)}this._parseData(e)}));let e=!1;this._response.on("close",(()=>{e=!0,this._status<400&&(this._flushLine(),this._emitEvent("end",{usage:this._usage}))})),this._response.on("error",(e=>{this._emitError(e)})),setTimeout((()=>{e||(!this._response.destroyed&&this._response.destroy(),this._throwError(w,"A network error was encountered while requesting the service: Network timeout"))}),M)}}class L extends ${constructor(e){super();const{accessToken:t}=e||{};this._validate({accessToken:t},{accessToken:"string"}),this.accessToken=t}_parseErrorMessage(e){return e.replace(/https:\/\/.*baidubce.com.*\s/,"* ").replace(/https:\/\/.*baidubce.com.*$/,"")}_parseError(e,t){switch(t=this._parseErrorMessage(t),e){case 4:case 17:case 18:case 19:case 282352:I(b,`${t}`);case 6:case 110:case 111:I(S,`${t}`);case 100:case 216100:case 216202:case 216203:case 282131:case 336001:case 336002:case 336004:case 282003:case 282004:case 282501:I(E,`${t}`)}I(k,`${t}, service provider error code: ${e}`)}async _request(e,t){const s=`access_token=${this.accessToken}`,r=e.indexOf("?")>-1?"&":"?",a=e+r+s;let o;try{o=await uniCloud.httpclient.request(a,{method:"POST",dataType:"json",contentType:"json",data:t,followRedirect:!0,timeout:M})}catch(e){I(w,"A network error was encountered while requesting the service: "+this._parseErrorMessage(e.message))}o.status>=400&&I(w,`Request failed with status ${o.status}${o.data?", "+JSON.stringify(o.data):""}`);const{error_code:i,error_msg:n}=o.data||{};return i&&this._parseError(i,n),o.data}async _requestStream(e,t){const s=`access_token=${this.accessToken}`,r=e.indexOf("?")>-1?"&":"?",a=e+r+s,{hostname:o,protocol:c,path:p}=i.default.parse(a);return new Promise(((e,s)=>{const r=JSON.stringify(t),a=n.default.request({protocol:c,hostname:o,port:443,path:p,method:"POST",headers:{"Content-Type":"application/json","Content-Length":Buffer.byteLength(r)}},(t=>{e(t)}));a.on("error",(e=>{s(C(w,"A network error was encountered while requesting the service: "+this._parseErrorMessage(e.message)))})),a.write(r),a.end()}))}_parseMessages(e=[]){return super._parseMessages(e),e.map((e=>("system"===e.role&&I(E,'Role "system" is not supported by Baidu'),{role:e.role,content:e.content})))}_parseUsage(e){return{promptTokens:e.prompt_tokens,completionTokens:e.completion_tokens,totalTokens:e.total_tokens}}_parseChatResult(e){const{id:t,result:s,usage:r}=e;return{id:t,reply:s,usage:this._parseUsage(r)}}async chatCompletion(e){const{model:t="ERNIE-Bot",messages:s=[],temperature:r,topP:a,stream:o=!1,sseChannel:i,streamEventForSSE:n="message"}=e||{};let c=r,p=a;r||a||(c=1,p=1);const u={messages:this._parseMessages(s),stream:o};"ERNIE-Bot"===t&&(u.temperature=c,u.top_p=p);const h={"ERNIE-Bot":"https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/completions","ERNIE-Bot-turbo":"https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/eb-instant"}[t];if(h||I(E,"Invalid parameter model"),!o){const e=await this._request(h,u);return this._parseChatResult(e)}const d=await this._requestStream(h,u),l=new P({response:d,parseError:this._parseError.bind(this)});return i?this._autoSSE({response:l,sseChannel:i,streamEventForSSE:n}):l}async _imageGenerationV1(e){const{prompt:t,resolution:s="1024*1024",style:r,imageNum:a=1}=e||{};this._validate({prompt:t,resolution:s,style:r,imageNum:a},{prompt:"string",resolution:"string",style:"string",imageNum:"number"});const o={text:t,resolution:s,style:r,num:a},i=await this._request("https://aip.baidubce.com/rpc/2.0/ernievilg/v1/txt2img",o);return{taskId:i&&i.data&&i.data.taskId}}async _getGeneratedImageV1(e){const{taskId:t}=e||{};this._validate({taskId:t},{taskId:"number|string"});const s={taskId:t},r=await this._request("https://aip.baidubce.com/rpc/2.0/ernievilg/v1/getImg",s),{status:a,imgUrls:o=[]}=r&&r.data||{};return{status:{0:"RUNNING",1:"SUCCESS"}[a],imgList:o.map((e=>({url:e.image})))}}async _imageGenerationV2(e){const{prompt:t,resolution:s="1024*1024",imageNum:r=1,imageBase64:a,imageUrl:o,pdfBase64:i,pdfPageNum:n,changeDegree:c}=e||{};this._validate({prompt:t,resolution:s,imageNum:r,imageBase64:a,imageUrl:o,pdfBase64:i,pdfPageNum:n,changeDegree:c},{prompt:"string",resolution:"string",imageNum:"number",imageBase64:{required:!1,type:"string"},imageUrl:{required:!1,type:"string"},pdfBase64:{required:!1,type:"string"},pdfPageNum:{required:!1,type:"number"},changeDegree:{required:!1,type:"number"}}),(a||o||i)&&void 0===c&&I(E,"Parameter changeDegree is required when reference file is passed");const[p,u]=s.split("*").map((e=>parseInt(e)));p&&u||I(E,"Invalid parameter resolution");const h={prompt:t,width:p,height:u,image_num:r,image:a,url:o,pdf_file:i,pdf_file_num:n,change_degree:c},d=await this._request("https://aip.baidubce.com/rpc/2.0/ernievilg/v1/txt2imgv2",h);return{taskId:d&&d.data&&d.data.task_id}}async _getGeneratedImageV2(e){const{taskId:t}=e||{};this._validate({taskId:t},{taskId:"number|string"});const s={task_id:t},r=await this._request("https://aip.baidubce.com/rpc/2.0/ernievilg/v1/getImgv2",s),{task_status:a,sub_task_result_list:o=[]}=r&&r.data||{};return{status:a,imgList:o.map((e=>{const t=e.final_image_list&&e.final_image_list[0]||{};return{url:t.img_url,securityCheckResult:t.img_approve_conclusion}}))}}async imageGeneration(e){const{version:t=1}=e||{};switch(t){case 1:return this._imageGenerationV1(e);case 2:return this._imageGenerationV2(e)}}async getGeneratedImage(e){const{version:t=1}=e||{};switch(t){case 1:return this._getGeneratedImageV1(e);case 2:return this._getGeneratedImageV2(e)}}}class B extends x{constructor(e){const{socketTask:t,parseError:s}=e;super({parseError:s}),this._socketTask=t,this._initEvent(),this._closed=!1,this._error=null,this._usage=null}_parseUsage(e){return{promptTokens:e.prompt_tokens,completionTokens:e.completion_tokens,totalTokens:e.total_tokens}}_parseSocketDataItem(e){const{header:t,payload:s}=JSON.parse(e);t.code&&this._parseError(t.code,t.message);const{choices:r,usage:a}=s,o=r.text.map((e=>({message:{role:e.role,content:e.content}})));return{reply:o[0].message.content,choices:o,usage:a&&a.text?this._parseUsage(a.text):void 0}}_initEvent(){const e=this._socketTask;e.onMessage((({data:t=""}={})=>{try{const e=this._parseSocketDataItem(t),s=e.reply;this._emitEvent("message",s),this._emitEvent("optimizedMessage",s);const r=s.split(/\n/);for(let e=0;e<r.length;e++){const t=r[e];e>0&&this._flushLine(!0),t.length>0&&this._tempLine.push(t)}e.usage&&(this._usage=e.usage)}catch(t){this._error=t,e.close()}})),e.onError((t=>{this._error=C(w,"A network error was encountered while requesting the service: "+t.errMsg),e.close()}));const t=setTimeout((()=>{this._closed||(this._error=C(w,"A network error was encountered while requesting the service: socket timeout"),e.close())}),M);e.onClose((()=>{this._closed=!0,clearTimeout(t),this._error?this._emitError(this._error):(this._flushLine(),this._emitEvent("end",{usage:this._usage}))}))}}class G extends ${constructor(e){super(),this._validate(e,{provider:"string",appId:{required:!1,type:"string"}});const{provider:t}=e||{},{secretKeyId:s,secretKey:r}=h()||{},a=uniCloud.getClientInfos();let o=e.appId;o||(a.length>1?I(v,"使用单实例多并发时需要传递appId参数。请参考：https://uniapp.dcloud.net.cn/uniCloud/uni-ai.html#get-llm-manager"):1===a.length&&(o=a[0].appId)),this._aiProvider=t;const i=uniCloud.getCloudInfos()[0]||{};this._secretKey=r,this._secretKeyId=s,this._spaceId=function(e){const{provider:t,spaceId:s,useOldSpaceId:r}=e||{};return"aliyun"!==t||!0!==r||s.startsWith("mp-")?s:"mp-"+s}(i),this._provider=i.provider,this._serviceSpaceProvider=function(e){switch(e){case"tcb":case"tencent":return"tcb";default:return e}}(this._provider),o||I(v,"未能从clientInfo内获取appId，请参考：\n1. 运行云函数时配置运行测试参数 https://uniapp.dcloud.net.cn/uniCloud/rundebug.html#runparam \n2. 运行云对象时传配置运行测试参数 https://uniapp.dcloud.net.cn/uniCloud/rundebug.html#run-obj-param"),o||I(v,"当前请求来源或调用方式无法获取客户端appId，请自行传递appId参数。请参考：https://uniapp.dcloud.net.cn/uniCloud/uni-ai.html#get-llm-manager"),this._appId=o}async _request(e,t){const s={...t,timestamp:Date.now(),spaceProvider:this._serviceSpaceProvider,spaceId:this._spaceId,keyId:this._secretKeyId,appid:this._appId,clientIp:this._clientIP},r=function(e,t){const s=Object.keys(e).sort().filter((function(t){return void 0!==e[t]})).map((t=>`${t}=${""+e[t]}`));s.push(`apiSecret=${t}`);const r=o.default.createHash("md5");return r.update(s.join("&")),r.digest("hex").toLowerCase()}(s,this._secretKey),a=["ucoaaibk.dcloud.net.cn"].map((t=>`https://${t}/${e}`)),i=await async function(e,t){let s=null;const r=e.length,a=Math.floor(Math.random()*r);let o=0;for(;!s;){const i=e[(a+o)%r];s=await d(i,t),s.code<600&&s.code>=400&&o<e.length-1&&(s=null),o++}return s}(a,{...s,sign:r});i.code<1e3&&i.code>=400&&I(w,`Request failed with status ${i.code}`);const n=i.errCode,c=i.errMsg;if(!n)return i.data||{};I(n,c)}async chatCompletion(e){const{messages:t=[],tokensToGenerate:s,temperature:r,topP:a,model:o,stream:i=!1,streamEventForSSE:n="message",sseChannel:c}=e||{};this._validate({messages:t,tokensToGenerate:s,temperature:r,topP:a,model:o,stream:i},{messages:"array",tokensToGenerate:{required:!1,type:"number"},temperature:{required:!1,type:"number"},topP:{required:!1,type:"number"},model:{required:!1,type:"string"},stream:{required:!1,type:"boolean"}}),i&&!c&&I(v,"使用DCloud提供的AI服务接口且使用了stream模式时需传递sseChannel参数");const p=await this._request("http/uniai/api/getMessage",{messages:JSON.stringify(t),model:o,provider:this._aiProvider,tokensToGenerate:s,temperature:r,topP:a,stream:i,streamEventForSSE:n,seqId:i?c.seqId:void 0,pushClientId:i?c.pushClientId:void 0});return i?{errCode:0}:p}}const j={minimax:class extends ${constructor(e){super();const{botName:t="Bot",userName:s="Me",groupId:r,apiKey:a}=e||{};r&&a||console.warn("因minimax提供给DCloud的免费测试key将被收回。从2023年6月9日起上午10点起，如果开发者调用uni-ai服务时，未填provider或没有配置自己的调用凭证时，将无法再调用llm。"),this._validate({groupId:r,apiKey:a},{groupId:"string",apiKey:"string"}),this.botName=t,this.userName=s,this.groupId=r,this.apiKey=a}async _request(e,t){let s;try{s=await uniCloud.httpclient.request(e,{headers:{Authorization:`Bearer ${this.apiKey}`},method:"POST",dataType:"json",contentType:"json",data:t,followRedirect:!0,timeout:M})}catch(e){I(w,"A network error was encountered while requesting the service: "+this._parseErrorMessage(e.message))}return s.status>=400&&I(w,`Request failed with status ${s.status}${s.data?", "+JSON.stringify(s.data):""}`),s.data}async _requestStream(e,t){const{hostname:s,protocol:r,path:a}=i.default.parse(e);return new Promise(((e,o)=>{const i=JSON.stringify(t),c=n.default.request({protocol:r,hostname:s,port:443,path:a,method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","Content-Length":Buffer.byteLength(i)}},(t=>{e(t)}));c.on("error",(e=>{o(C(w,"A network error was encountered while requesting the service: "+this._parseErrorMessage(e.message)))})),c.write(i),c.end()}))}_parseErrorMessage(e){return e.replace(/https:\/\/.*minimax.chat.*\s/,"* ").replace(/https:\/\/.*minimax.chat.*$/,"")}_parseError(e,t){switch(t=this._parseErrorMessage(t),e){case 1002:I(b,`${t}`);case 2013:I(E,`${t}`);case 1027:I(q,`${t}`);case 1004:I(S,`${t}`)}I(k,`${t}, service provider error code: ${e}`)}_parseRole(e){const t={system:"SYSTEM",user:"USER",assistant:"BOT"},s=t[e];return s||I(E,`message role error, expected one of [${Object.keys(t).join(",")}], got ${e}`),s}_parseMessages(e=[]){return super._parseMessages(e),e.map(((e,t)=>("system"===e.role&&t>0&&I(E,'Role "system" can only be the first item in the messages array'),{sender_type:this._parseRole(e.role),text:e.content})))}_parseUsage(e){return{promptTokens:e.prompt_tokens,completionTokens:e.completion_tokens,totalTokens:e.total_tokens}}_parseChoices(e){return e.map((e=>{const{text:t,finish_reason:s}=e;return{message:{role:"assistant",content:t},finishReason:s}}))}_parseChatResult(e){const{id:t,reply:s,choices:r,usage:a,base_resp:o}=e;return o&&o.status_code&&this._parseError(o.status_code,o.status_msg),{id:t,reply:s,choices:this._parseChoices(r),usage:this._parseUsage(a)}}async chatCompletion(e){const{messages:t=[],maxTokens:s,tokensToGenerate:r=512,temperature:a,topP:o,model:i="abab5-chat",stream:n=!1,streamEventForSSE:c="message",sseChannel:p}=e||{};s&&console.warn('Parameter "maxTokens" has been deprecated, please use the tokensToGenerate parameter instead');const u=this._parseMessages(t);let h;u[0]&&"SYSTEM"===u[0].sender_type&&(h=u.shift().text);let d=a,l=o;a||o||(d=1,l=1);const m={model:i,messages:u,prompt:void 0,role_meta:void 0,tokens_to_generate:r||s,temperature:d,top_p:l,stream:n};h&&(m.prompt=h,m.role_meta={user_name:this.userName,bot_name:this.botName});const _=`https://api.minimax.chat/v1/text/chatcompletion?GroupId=${this.groupId}`;if(!n){const e=await this._request(_,m);return this._parseChatResult(e)}const g=await this._requestStream(_,m),y=new O({response:g,parseError:this._parseError.bind(this)});return p?this._autoSSE({response:y,sseChannel:p,streamEventForSSE:c}):y}},openai:N,baidu:L,azure:class extends N{constructor(e){const{apiKey:t,endpoint:s}=e||{};super({apiKey:t}),this._validate({apiKey:t,endpoint:s},{apiKey:"string",endpoint:"string"}),this.endpoint=s}_getRequestUrl(e,t){return`${this.endpoint}openai/deployments/${t.deploymentId}/${e}?api-version=2023-03-15-preview`}_getRequestHeaders(){return{"api-key":this._apiKey}}async chatCompletion(e){const{messages:t=[],tokensToGenerate:s,temperature:r,topP:a,deploymentId:o,stream:i=!1,streamEventForSSE:n="message",sseChannel:c}=e||{};this._validate({messages:t,tokensToGenerate:s,temperature:r,topP:a,deploymentId:o,stream:i},{messages:"array",tokensToGenerate:{required:!1,type:"number"},temperature:{required:!1,type:"number"},topP:{required:!1,type:"number"},deploymentId:"string",stream:{required:!1,type:"boolean"}}),super._parseMessages(t);const p={messages:t,max_tokens:s,temperature:r,top_p:a,stream:i},u=this._getRequestUrl("chat/completions",{deploymentId:o});if(!i){const e=await this._request(u,p);return this._parseChatResult(e)}const h=await this._requestStream(u,p),d=new R({response:h,parseError:this._parseError.bind(this)});return c?this._autoSSE({response:d,sseChannel:c,streamEventForSSE:n}):d}},ifly:class extends ${constructor(e){super();const{appId:t,apiKey:s,apiSecret:r}=e||{};this._validate({appId:t,apiKey:s,apiSecret:r},{appId:"string",apiKey:"string",apiSecret:"string"}),this.appId=t,this.apiKey=s,this.apiSecret=r,this._host="spark-api.xf-yun.com"}_getAuthorization(e){const{host:t=this._host,urlPath:s,date:r}=e||{};let a="host: "+t+"\n";a+="date: "+r+"\n",a+="GET "+s+" HTTP/1.1";const i=o.default.createHmac("sha256",this.apiSecret).update(a).digest("base64");return Buffer.from(`api_key="${this.apiKey}", algorithm="hmac-sha256", headers="host date request-line", signature="${i}"`,"utf8").toString("base64")}async _requestStream(e,t){const s=(new Date).toGMTString(),r=this._getAuthorization({urlPath:e,date:s}),a=`wss://${this._host}${e}?authorization=${r}&date=${s.replace(/\s/g,"+").replace(/,/g,"%2C")}&host=${this._host}`,o=uniCloud.connectSocket({url:a});return o.onOpen((async()=>{await o.send({data:JSON.stringify(t)})})),o}_parseError(e,t){switch(e){case 10006:case 10007:case 10008:case 11201:case 11202:case 11203:I(b,`${t}`);case 10015:case 10016:case 11200:I(S,`${t}`);case 10003:case 10004:case 10005:case 10163:I(E,`${t}`);case 10013:case 10014:case 10019:I(q,`${t}`)}I(k,`${t}, service provider error code: ${e}`)}_parseMessages(e=[]){return super._parseMessages(e),e.map((e=>("system"===e.role&&I(E,'Role "system" is not supported by iFly'),{role:e.role,content:e.content})))}_streamToData(e){return new Promise(((t,s)=>{let r="";e.on("message",(e=>{r+=e})),e.on("error",(e=>{s(e)})),e.on("end",(({usage:e={}}={})=>{t({reply:r,choices:[{message:{role:"assistant",content:r}}],usage:e})}))}))}async chatCompletion(e){const{messages:t=[],tokensToGenerate:s=4096,temperature:r=1,stream:a=!1,streamEventForSSE:o="message",sseChannel:i}=e||{},n=r,c=this._parseMessages(t),p={header:{app_id:this.appId},parameter:{chat:{domain:"general",temperature:n,max_tokens:s}},payload:{message:{text:c}}},u=await this._requestStream("/v1.1/chat",p),h=new B({socketTask:u,parseError:this._parseError.bind(this)});return a?i?this._autoSSE({response:h,sseChannel:i,streamEventForSSE:o}):h:this._streamToData(h)}},dcloud:G},K={baidu:L};function D(e,t){const s={};for(let r=0;r<t.length;r++){const a=t[r];e[a]&&(s[a]=e[a].bind(e))}return s}function J(){Object.getPrototypeOf(uniCloud).ai={getLLMManager(e){const{provider:t="minimax"}=e||{};let s;return s=function(e){const{provider:t="minimax",apiKey:s}=e||{};return["azure","minimax"].includes(t)&&!s}(e)?G:j[t],s||I(E,`Invalid LLM provider: ${t}`),D(new s({...e,provider:t}),["chatCompletion"])},getMediaManager(e){const{provider:t="baidu"}=e||{};e.provider||console.warn("请指定provider（服务商）参数，默认调用baidu的行为后续可能会调整");const s=K[t];return s||I(E,`Invalid media manager provider: ${t}`),D(new s(e),["imageGeneration","getGeneratedImage"])}}}J(),exports.init=J;
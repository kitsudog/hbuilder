"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("path"),t=require("hbuilderx"),r=require("fs"),n=require("os"),s=require("child_process"),i=require("events"),o=require("http"),a=require("https"),c=require("net"),l=require("tls"),u=require("crypto"),d=require("stream"),h=require("url"),f=require("zlib");function p(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var _=p(e),m=p(t),g=p(r),v=p(n),y=p(i),w=p(o),b=p(a),S=p(c),E=p(l),k=p(u),C=p(d),x=p(h),O=p(f);"darwin"===process.platform&&(process.env.PATH=["./node_modules/.bin","/.nodebrew/current/bin","/usr/local/bin",process.env.PATH].join(":")),process.env.UNICLOUD_DEBUGGER_PATH=_.default.resolve(__dirname,"../");class I extends Error{constructor({code:e,message:t}){super(t),this.code=e}}var P={EOL:v.default.EOL||"\n",tryParseNumber:function(e,t){var r,n,s="",i=0,o=!0,a=0;function c(){return n=e.charAt(a),a++,n}for(c(),"-"===n&&(s="-",c());n>="0"&&n<="9";)o&&("0"==n?i++:o=!1),s+=n,c();if(o&&i--,"."===n)for(s+=".";c()&&n>="0"&&n<="9";)s+=n;if("e"===n||"E"===n)for(s+=n,c(),"-"!==n&&"+"!==n||(s+=n,c());n>="0"&&n<="9";)s+=n,c();for(;n&&n<=" ";)c();return t&&(","!==n&&"}"!==n&&"]"!==n&&"#"!==n&&("/"!==n||"/"!==e[a]&&"*"!==e[a])||(n=0)),r=+s,n||i||!isFinite(r)?void 0:r},createComment:function(e,t){return Object.defineProperty&&Object.defineProperty(e,"__COMMENTS__",{enumerable:!1,writable:!0}),e.__COMMENTS__=t||{}},removeComment:function(e){Object.defineProperty(e,"__COMMENTS__",{value:void 0})},getComment:function(e){return e.__COMMENTS__},forceComment:function(e){if(!e)return"";var t,r,n,s,i=e.split("\n");for(n=0;n<i.length;n++)for(s=(t=i[n]).length,r=0;r<s;r++){var o=t[r];if("#"===o)break;if("/"===o&&("/"===t[r+1]||"*"===t[r+1])){"*"===t[r+1]&&(n=i.length);break}if(o>" "){i[n]="# "+t;break}}return i.join("\n")}};function N(e,t){if(e)for(var r=0;r<e.length;r++){var n=e[r](t);if(void 0!==n)return n}}function T(){}function L(e){return"{"===e||"}"===e||"["===e||"]"===e||","===e}function R(){return{name:"math",parse:function(e){switch(e){case"+inf":case"inf":case"+Inf":case"Inf":return 1/0;case"-inf":case"-Inf":return-1/0;case"nan":case"NaN":return NaN}},stringify:function(e){if("number"==typeof e)return 1/e==-1/0?"-0":e===1/0?"Inf":e===-1/0?"-Inf":isNaN(e)?"NaN":void 0}}}function M(e){var t=e&&e.out;return{name:"hex",parse:function(e){if(/^0x[0-9A-Fa-f]+$/.test(e))return parseInt(e,16)},stringify:function(e){if(t&&Number.isInteger(e))return"0x"+e.toString(16)}}}function D(){return{name:"date",parse:function(e){if(/^\d{4}-\d{2}-\d{2}$/.test(e)||/^\d{4}-\d{2}-\d{2}T\d{2}\:\d{2}\:\d{2}(?:.\d+)(?:Z|[+-]\d{2}:\d{2})$/.test(e)){var t=Date.parse(e);if(!isNaN(t))return new Date(t)}},stringify:function(e){if("[object Date]"===Object.prototype.toString.call(e)){var t=e.toISOString();return-1!==t.indexOf("T00:00:00.000Z",t.length-14)?t.substr(0,10):t}}}}R.description="support for Inf/inf, -Inf/-inf, Nan/naN and -0",M.description="parse hexadecimal numbers prefixed with 0x",D.description="support ISO dates";var j={loadDsf:function(e,t){if("[object Array]"!==Object.prototype.toString.apply(e)){if(e)throw new Error("dsf option must contain an array!");return T}if(0===e.length)return T;var r=[];function n(e){return"[object Function]"==={}.toString.call(e)}return e.forEach((function(e){if(!e.name||!n(e.parse)||!n(e.stringify))throw new Error("extension does not match the DSF interface");r.push((function(){try{if("parse"==t)return e.parse.apply(null,arguments);if("stringify"==t){var r=e.stringify.apply(null,arguments);if(void 0!==r&&("string"!=typeof r||0===r.length||'"'===r[0]||[].some.call(r,(function(e){return L(e)}))))throw new Error("value may not be empty, start with a quote or contain a punctuator character except colon: "+r);return r}throw new Error("Invalid type")}catch(t){throw new Error("DSF-"+e.name+" failed; "+t.message)}}))})),N.bind(null,r)},std:{math:R,hex:M,date:D}},F=function(e,t){var r,n,s,i,o,a=P,c=j,l={'"':'"',"'":"'","\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"};function u(){n=0,s=" "}function d(e){return"{"===e||"}"===e||"["===e||"]"===e||","===e||":"===e}function h(e){var t,s=0,i=1;for(t=n-1;t>0&&"\n"!==r[t];t--,s++);for(;t>0;t--)"\n"===r[t]&&i++;throw new Error(e+" at line "+i+","+s+" >>>"+r.substr(n-s,20)+" ...")}function f(){return s=r.charAt(n),n++,s}function p(e){return r.charAt(n+e)}function _(e){for(var t="",r=s;f();){if(s===r)return f(),e&&"'"===r&&"'"===s&&0===t.length?(f(),m()):t;if("\\"===s)if(f(),"u"===s){for(var n=0,i=0;i<4;i++){f();var o,a=s.charCodeAt(0);s>="0"&&s<="9"?o=a-48:s>="a"&&s<="f"?o=a-97+10:s>="A"&&s<="F"?o=a-65+10:h("Bad \\u char "+s),n=16*n+o}t+=String.fromCharCode(n)}else{if("string"!=typeof l[s])break;t+=l[s]}else"\n"===s||"\r"===s?h("Bad string containing newline"):t+=s}h("Bad string")}function m(){for(var e="",t=0,r=0;;){var n=p(-r-5);if(!n||"\n"===n)break;r++}function i(){for(var e=r;s&&s<=" "&&"\n"!==s&&e-- >0;)f()}for(;s&&s<=" "&&"\n"!==s;)f();for("\n"===s&&(f(),i());;){if(s){if("'"===s){if(t++,f(),3===t)return"\n"===e.slice(-1)&&(e=e.slice(0,-1)),e;continue}for(;t>0;)e+="'",t--}else h("Bad multiline string");"\n"===s?(e+="\n",f(),i()):("\r"!==s&&(e+=s),f())}}function g(){if('"'===s||"'"===s)return _(!1);for(var e="",t=n,r=-1;;){if(":"===s)return e?r>=0&&r!==e.length&&(n=t+r,h("Found whitespace in your key name (use quotes to include)")):h("Found ':' but no key name (for an empty key name use quotes)"),e;s<=" "?s?r<0&&(r=e.length):h("Found EOF while looking for a key name (check your syntax)"):d(s)?h("Found '"+s+"' where a key name was expected (check your syntax or use quotes if the key name includes {}[],: or whitespace)"):e+=s,f()}}function v(){for(;s;){for(;s&&s<=" ";)f();if("#"===s||"/"===s&&"/"===p(0))for(;s&&"\n"!==s;)f();else{if("/"!==s||"*"!==p(0))break;for(f(),f();s&&("*"!==s||"/"!==p(0));)f();s&&(f(),f())}}}function y(e,t){var s;for(e--,s=n-2;s>e&&r[s]<=" "&&"\n"!==r[s];s--);"\n"===r[s]&&s--,"\r"===r[s]&&s--;var i=r.substr(e,s-e+1);for(s=0;s<i.length;s++)if(i[s]>" "){var o=i.indexOf("\n");if(o>=0){var a=[i.substr(0,o),i.substr(o+1)];return t&&0===a[0].trim().length&&a.shift(),a}return[i]}return[]}function w(e){function t(t){var r=function e(t,r){var n,s,i,o;switch(typeof t){case"string":t.indexOf(r)>=0&&(o=t);break;case"object":if("[object Array]"===Object.prototype.toString.apply(t))for(n=0,i=t.length;n<i;n++)o=e(t[n],r)||o;else for(s in t)Object.prototype.hasOwnProperty.call(t,s)&&(o=e(t[s],r)||o)}return o}(e,t);return r?"found '"+t+"' in a string value, your mistake could be with:\n  > "+r+"\n  (unquoted strings contain everything up to the next line!)":""}return t("}")||t("]")}function b(){var e,t,r,o=[];try{if(i&&(e=a.createComment(o,{a:[]})),f(),t=n,v(),e&&(r=y(t,!0).join("\n")),"]"===s)return f(),e&&(e.e=[r]),o;for(;s;){if(o.push(E()),t=n,v(),","===s&&(f(),t=n,v()),e){var c=y(t);e.a.push([r||"",c[0]||""]),r=c[1]}if("]"===s)return f(),e&&(e.a[e.a.length-1][1]+=r||""),o;v()}h("End of input while parsing an array (missing ']')")}catch(e){throw e.hint=e.hint||w(o),e}}function S(e){var t,r,o,c="",l={};try{if(i&&(t=a.createComment(l,{c:{},o:[]})),e?r=1:(f(),r=n),v(),t&&(o=y(r,!0).join("\n")),"}"===s&&!e)return t&&(t.e=[o]),f(),l;for(;s;){if(c=g(),v(),":"!==s&&h("Expected ':' instead of '"+s+"'"),f(),l[c]=E(),r=n,v(),","===s&&(f(),r=n,v()),t){var u=y(r);t.c[c]=[o||"",u[0]||""],o=u[1],t.o.push(c)}if("}"===s&&!e)return f(),t&&(t.c[c][1]+=o||""),l;v()}if(e)return l;h("End of input while parsing an object (missing '}')")}catch(e){throw e.hint=e.hint||w(l),e}}function E(){switch(v(),s){case"{":return S();case"[":return b();case"'":case'"':return _(!0);default:return function(){var e=s;for(d(s)&&h("Found a punctuator character '"+s+"' when expecting a quoteless string (check your syntax)");;){f();var t="\r"===s||"\n"===s||""===s;if(t||","===s||"}"===s||"]"===s||"#"===s||"/"===s&&("/"===p(0)||"*"===p(0))){var r=e[0];switch(r){case"f":if("false"===e.trim())return!1;break;case"n":if("null"===e.trim())return null;break;case"t":if("true"===e.trim())return!0;break;default:if("-"===r||r>="0"&&r<="9"){var n=a.tryParseNumber(e);if(void 0!==n)return n}}if(t){e=e.trim();var i=o(e);return void 0!==i?i:e}}e+=s}}()}}function k(e,t){var r=n;if(v(),s&&h("Syntax error, found trailing characters"),i){var o=t.join("\n"),c=y(r).join("\n");if(c||o)a.createComment(e,a.getComment(e)).r=[o,c]}return e}if("string"!=typeof e)throw new Error("source is not a string");var C=null,x=!0;return t&&"object"==typeof t&&(i=t.keepWsc,C=t.dsf,x=!1!==t.legacyRoot),o=c.loadDsf(C,"parse"),r=e,u(),x?function(){v();var e=i?y(1):null;switch(s){case"{":return k(S(),e);case"[":return k(b(),e)}try{return k(S(!0),e)}catch(t){u();try{return k(E(),e)}catch(e){throw t}}}():function(){v();var e=i?y(1):null;switch(s){case"{":return k(S(),e);case"[":return k(b(),e);default:return k(E(),e)}}()};var A=F;const U=require("hbuilderx");class B extends Error{constructor({message:e,code:t}={}){super(e),this.code=t}}const $=-32601,W=-32603;var q={JsonRpcClient:class{constructor({bridgeProcess:e}){this._id=0,this._bridgeProcess=e,this._promiseMap=new Map,this._bridgeProcess.on("message",({type:e,result:t,error:r,id:n})=>{"JSON_RPC_Message"===e&&this._processMessage({result:t,error:r,id:n})})}_processMessage({result:e,error:t,id:r}){if(!this._promiseMap.has(r))return;const{resolve:n,reject:s}=this._promiseMap.get(r);t?s(new B({code:t.code,message:t.message})):n(e)}_send({method:e,params:t}){const r=++this._id;this._bridgeProcess.send({type:"JSON_RPC_Message",id:r,method:e,params:t})}call(e,t){return new Promise((r,n)=>{this._send({method:e,params:t}),this._promiseMap.set(this._id,{resolve:r,reject:n})})}},JsonRpcServer:class{constructor({bridgeProcess:e}){this._bridgeProcess=e,this._methodMap=new Map,this._bridgeProcess.on("message",({type:e,id:t,method:r,params:n})=>{"JSON_RPC_Message"===e&&this._processMessage({id:t,method:r,params:n})})}expose(e,t){this._methodMap.set(e,t)}_send(e,t){this._bridgeProcess.send({type:"JSON_RPC_Message",id:e,result:t})}_sendError(e,t,r,n){this._bridgeProcess.send({type:"JSON_RPC_Message",id:e,error:{code:t,message:r&&r.message||r,data:n}})}_processMessage({id:e,method:t,params:r}){this._methodMap.has(t)||this._sendError(e,$,`method[${t}] not found`);const n=this._methodMap.get(t);try{const t=n(r);t instanceof Promise?t.then(t=>{this._send(e,t)}).catch(t=>{this._sendError(e,W,t)}):this._send(e,t)}catch(t){this._sendError(e,W,t)}}}};class G extends Error{constructor(e,t){super(e),this.code=t}}function V(e){return Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}function J(e,t="path"){let r;return r="path"===t?g.default.readFileSync(e).toString().replace("\r\n","\n").replace("\r","\n"):e,A(r)}function H(e){return[_.default.resolve(e,"src","manifest.json"),_.default.resolve(e,"src","pages.json")].every(e=>g.default.existsSync(e))}function Y(e){const t=_.default.resolve(e,H(e)?"src":"","uni_modules");try{if(!g.default.statSync(t).isDirectory())return[]}catch(e){return[]}return g.default.readdirSync(t).filter(e=>{try{return!!g.default.statSync(_.default.resolve(t,e)).isDirectory()}catch(e){return!1}})}function z(e){let t={};try{t=J(_.default.resolve(e,H(e)?"src":"","uni-modules.config.json"))}catch(e){}let r=t&&t.uni_modules;return r&&"object"===V(r)||(r={}),r}function K(e,t){const r=[_.default.resolve(e,"uniCloud-"+t)],n=Y(e);if(!n||0===n.length)return r;const s=z(e);for(let i=0;i<n.length;i++){const o=n[i],a=s[o];let c=a&&a.uniCloud;if(c&&"array"===V(c)||(c=[t]),c.indexOf(t)>-1){const t=_.default.resolve(e,H(e)?"src":"",`uni_modules/${o}/uniCloud`);g.default.existsSync(t)&&r.push(t)}}return r}function Q(e,t){const r=K(e,t),n=[];for(let e=0;e<r.length;e++){const t=_.default.resolve(r[e],"cloudfunctions");g.default.existsSync(t)&&n.push(t)}return n}function X(e,t){const r=[_.default.resolve(e,`uniCloud-${t}/database`)],n=Y(e);if(!n||0===n.length)return r;const s=z(e);for(let i=0;i<n.length;i++){const o=n[i];let a=s[o];if(a&&"array"===V(a)||(a=[t]),a.indexOf(t)>-1){const t=_.default.resolve(e,H(e)?"src":"",`uni_modules/${o}/uniCloud/database`);g.default.existsSync(t)&&r.push(t)}}return r}function Z(e){const t=["common","uni-clientDB-actions"];let r=[];try{r=g.default.readdirSync(e).filter(e=>-1===t.indexOf(e)).map(t=>_.default.resolve(e,t))}catch(e){}return r}function ee(e){const t=["common","uni-clientDB-actions"];let r=[];try{r=g.default.readdirSync(e).filter(e=>-1===t.indexOf(e))}catch(e){}return r}function te(e,t,r){const n=function(e,t,r){const n=Q(e,t),s=[];for(let e=0;e<n.length;e++){const t=n[e];let i;const o=_.default.resolve(t,"common/"+r);try{i=g.default.statSync(o)}catch(e){}i&&i.isDirectory()&&s.push(o)}return s}(e,t,r);if(0===n.length)throw new G(`未找到公共模块[${r}]`,"NOT_FOUND");if(n.length>1)throw console.error(`公共模块[${r}]存在名称冲突，请解决冲突后再试。产生冲突的路径如下：`),n.forEach(e=>{console.error(e)}),new G(`公共模块[${r}]名称冲突，请解决后再试', 'CONFLICT_NAME`);return n[0]}function re(e){return g.default.existsSync(_.default.resolve(e,"encrypt"))}function ne(e,t){const r=Q(e,t),n=[];for(let e=0;e<r.length;e++){const t=Z(r[e]);n.push(...t)}return n}var se={getType:V,parseJson:J,getRealWorkspace:function({workspaceFolder:e,uniCloudInfo:t,provider:r}){const n=t.find(e=>e.provider===r);return n&&function(e){return e&&e.uri&&e.uri.fsPath}(n.workspaceFolder)||e},getAppid:function(e){const t=H(e),r=_.default.resolve(e,t?"src":"","manifest.json");let n={};try{n=J(r)}catch(e){}return n.appid},getModuleList:Y,getCloudfunctionPathList:Q,getFunctionPathList:Z,getCommonModulePathList:function(e){let t=[];const r=_.default.resolve(e,"common");try{t=g.default.readdirSync(r).map(e=>_.default.resolve(r,e))}catch(e){}return t},getCommonModulePath:te,getFunctionEntry:function(e,t,r){const n=function(e,t,r){const n=Q(e,t),s=[];for(let e=0;e<n.length;e++){const t=n[e];ee(t).indexOf(r)>-1&&s.push(_.default.resolve(t,r))}return s}(e,t,r);if(0===n.length)throw new G(`未匹配到云函数[${r}]`,"NOT_FOUND");if(n.length>1)throw console.error(`云函数[${r}]存在名称冲突，请解决冲突后再试。产生冲突的路径如下：`),n.forEach(e=>{console.error(e)}),new G("云函数名称冲突，请解决后再试","CONFLICT_NAME");return n[0]},getUniIdPath:function(e,t){return te(e,t,"uni-id")},getActionPath:function(e,t,r){const n=function(e,t,r){const n=Q(e,t),s=[];for(let e=0;e<n.length;e++){const t=n[e];let i;const o=_.default.resolve(t,`uni-clientDB-actions/${r}.js`);try{i=g.default.statSync(o)}catch(e){}i&&i.isFile()&&s.push(o)}return s}(e,t,r);if(0===n.length)throw new G(`未找到uni-clientDB-actions[${r}]`,"NOT_FOUND");if(n.length>1)throw console.error(`uni-clientDB-actions[${r}]存在名称冲突，请解决冲突后再试。产生冲突的路径如下：`),n.forEach(e=>{console.error(e)}),new G(`uni-clientDB-actions[${r}]名称冲突，请解决后再试`,"CONFLICT_NAME");return n[0]},getSchemaPath:function(e,t,r){const n=function(e,t,r){const n=X(e,t),s=[];for(let e=0;e<n.length;e++){const t=n[e];let i;const o=_.default.resolve(t,r+".schema.json");try{i=g.default.statSync(o)}catch(e){}i&&i.isFile()&&s.push(o)}return s}(e,t,r);if(0===n.length)throw new G(`项目database目录下缺少${r}.schema.json。如云端的该表已配置schema，请下载到database目录中`,"NOT_FOUND");if(n.length>1)throw console.error(r+"表对应的schema存在名称冲突，请解决冲突后再试。产生冲突的路径如下："),n.forEach(e=>{console.error(e)}),new G(r+"表对应的schema名称冲突，请解决后再试","CONFLICT_NAME");return n[0]},getValidateFunctionPath:function(e,t,r){const n=function(e,t,r){const n=X(e,t),s=[];for(let e=0;e<n.length;e++){const t=n[e];let i;const o=_.default.resolve(t,`validateFunction/${r}.js`);try{i=g.default.statSync(o)}catch(e){}i&&i.isFile()&&s.push(o)}return s}(e,t,r);if(0===n.length)throw new G(`未找到扩展校验函数[${r}]`,"NOT_FOUND");if(n.length>1)throw console.error(`扩展校验函数[${r}]存在名称冲突，请解决冲突后再试。产生冲突的路径如下：`),n.forEach(e=>{console.error(e)}),new G(`扩展校验函数[${r}]名称冲突，请解决后再试`,"CONFLICT_NAME");return n[0]},getWorkspacePathFromFilePath:function(e){const t=e.match(/(.*?)\/(uniCloud-(?:aliyun|tcb)|src\/uni_modules|uni_modules)/);return t&&t[1]},isUniAppCli:H,isModuleEncrypted:re,isFileEncrypted:function(e){let t;try{t=g.default.statSync(e)}catch(e){return!1}const r=g.default.openSync(e),n=Buffer.alloc(Math.min(t.size,512));return g.default.readSync(r,n),g.default.closeSync(r),Array.from(n).some(e=>0===e)},getAllModuleFunctionPath:ne,getEncryptedFunctionList:function(e,t){return ne(e,t).filter(e=>re(e)).map(e=>({name:e.replace(/\\/g,"/").split("/").pop(),functionPath:e}))},getCollectionListFromAllDbInit:function(e,t){const r=K(e,t),n=[];for(let e=0;e<r.length;e++){const t=r[e],s=_.default.resolve(t,"database/db_init.json");if(g.default.existsSync(s))try{const e=J(s);n.push(...Object.keys(e))}catch(e){}}return n},...q};const ie="win32"===process.platform?"npm.cmd":"npm";let oe;function ae(e){void 0===oe&&(oe=g.default.existsSync(_.default.resolve(__dirname,"dcloud.debug"))),oe&&g.default.appendFileSync(_.default.resolve(__dirname,"log.txt"),(new Date).toLocaleString()+" "+e+"\n")}function ce(e){const t=e&&e.uri&&e.uri.fsPath,r=t.split(":");return 1===r.length?t:(r[0]=r[0].toUpperCase(),r.join(":"))}function le(e){return"/"!==(e=e.replace(/\\/g,"/"))[e.length-1]&&(e+="/"),new RegExp("^"+e,"i")}async function ue({path:e,body:t}={}){return function(e){if(e.error)throw new I({code:"NETWORK_ERROR",message:"请求DCloud服务失败："+JSON.stringify(e.error)});const t=JSON.parse(e.data),r=t.header&&t.header.result&&t.header.result.rspcode,n=t.header&&t.header.result&&t.header.result.rspdesc;if("1001"!==r)throw new I({code:"NETWORK_ERROR",message:`请求DCloud服务失败：错误码为：${r}，详细错误信息为：${n}`});return t.body}(await U.http.request({url:"https://ide.liuyingyong.cn"+e,method:"post",params:{param:JSON.stringify({header:{token:"${user.checked.token}"},body:t})}}))}let de={};const he=new Map;async function fe({provider:e,spaceId:t,appId:r,useCache:n=!1}={}){const s=`${t}_${n}`;let i;he.has(s)&&"pending"===he.get(s).status||(i=async function({provider:e,spaceId:t,appId:r,useCache:n=!1}={}){if(n&&de[t]&&de[t].expireTime-Date.now()>1e4){const{uniCloudSecret:e,expireTime:r}=de[t];return{uniCloudSecret:e,restTime:(r-Date.now())/1e3}}const s=await ue({path:"/serverless/space/debug-token",body:{provider:e,spaceId:t,appid:r}});let i;switch(e){case"aliyun":{const{Token:e}=s.Credentials;i={spaceId:t,serverSecret:e};break}case"tcb":{const{TmpSecretId:e,TmpSecretKey:r,Token:n}=s.Credentials;i={spaceId:t,secretId:e,secretKey:r,sessionToken:n};break}}const o=parseInt(s.RestTime);return de[t]={uniCloudSecret:i,expireTime:Date.now()+1e3*o},{uniCloudSecret:i,restTime:o}}({provider:e,spaceId:t,appId:r,useCache:n}),he.set(s,{promise:i,status:"pending"}));const o=he.get(s);let a;try{a=await o.promise,o.status="fulfilled"}catch(e){throw o.status="rejected",e}return a}function pe(){return["<node_internals>/**/*.js",process.env.UNICLOUD_DEBUGGER_PATH.replace(/\\/g,"/")+"/**/*.js"]}async function _e(){const e=await new Promise(e=>{const t=s.spawn(ie,["-v"]);t.on("exit",()=>{0===t.exitCode?e(ie):e(void 0)})});return e||_.default.resolve(__dirname,"../../npm",ie)}function me(e,{npmCmd:t=ie}={}){return new Promise((r,n)=>{const i=_.default.resolve(e,"package.json");if(!g.default.existsSync(i))return void r();let o;try{o=JSON.parse(g.default.readFileSync(i).toString())}catch(e){return void r()}const a=o&&o.dependencies&&Object.keys(o.dependencies).every(e=>0===o.dependencies[e].indexOf("file:")),c=s.spawn(t,["ls"],{cwd:e});c.on("exit",()=>{0===c.exitCode?r():r({type:a?"local":"npm"})})})}async function ge(e,{npmCmd:t=ie}={}){const r=[];for(let n=0;n<e.length;n++){const s=e[n],i=await me(s,{npmCmd:t});i&&r.push({dir:s,functionPath:s,...i})}return r}async function ve(e,{npmCmd:t=ie}){const r=[];for(let n=0;n<e.length;n++){const s=e[n],i=await me(s,{npmCmd:t});i&&r.push({dir:s,commonModulePath:s,...i})}return r}function ye(e,{npmCmd:t=ie}={}){const r=_.default.resolve(e,"package-lock.json");return g.default.existsSync(r)&&g.default.unlinkSync(r),new Promise((r,n)=>{const i=s.spawn(t,["install","--production"],{cwd:e});let o=Buffer.alloc(0);i.stderr.on("data",e=>{o=Buffer.concat([o,e])}),i.on("exit",()=>{0===i.exitCode?r():n(new Error(`npm进程退出码：${i.exitCode}\n详细错误信息如下：\n${o.toString()}`))})})}function we(e,t,r){return e(r={path:t,exports:{},require:function(e,t){return be(null==t&&r.path)}},r.exports),r.exports}function be(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}U.authorize.onUserLogout((function(){de={}}));var Se={BINARY_TYPES:["nodebuffer","arraybuffer","fragments"],GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),EMPTY_BUFFER:Buffer.alloc(0),NOOP:()=>{}},Ee="function"==typeof __webpack_require__?__non_webpack_require__:be,ke=process.config&&process.config.variables||{},Ce=!!process.env.PREBUILDS_ONLY,xe=process.versions.modules,Oe=!(!process.versions||!process.versions.electron)||!!process.env.ELECTRON_RUN_AS_NODE||"undefined"!=typeof window&&window.process&&"renderer"===window.process.type?"electron":"node",Ie=v.default.arch(),Pe=v.default.platform(),Ne=process.env.LIBC||(function(e){return"linux"===e&&g.default.existsSync("/etc/alpine-release")}(Pe)?"musl":"glibc"),Te=process.env.ARM_VERSION||("arm64"===Ie?"8":ke.arm_version)||"",Le=(process.versions.uv||"").split(".")[0],Re=Me;function Me(e){return Ee(Me.path(e))}function De(e){try{return g.default.readdirSync(e)}catch(e){return[]}}function je(e,t){var r=De(e).filter(t);return r[0]&&_.default.join(e,r[0])}function Fe(e){return/\.node$/.test(e)}function Ae(e){var t=e.split("-");if(2===t.length){var r=t[0],n=t[1].split("+");if(r&&n.length&&n.every(Boolean))return{name:e,platform:r,architectures:n}}}function Ue(e,t){return function(r){return null!=r&&(r.platform===e&&r.architectures.includes(t))}}function Be(e,t){return e.architectures.length-t.architectures.length}function $e(e){var t=e.split("."),r={file:e,specificity:0};if("node"===t.pop()){for(var n=0;n<t.length;n++){var s=t[n];if("node"===s||"electron"===s||"node-webkit"===s)r.runtime=s;else if("napi"===s)r.napi=!0;else if("abi"===s.slice(0,3))r.abi=s.slice(3);else if("uv"===s.slice(0,2))r.uv=s.slice(2);else if("armv"===s.slice(0,4))r.armv=s.slice(4);else{if("glibc"!==s&&"musl"!==s)continue;r.libc=s}r.specificity++}return r}}function We(e,t){return function(r){return null!=r&&(!(r.runtime!==e&&!function(e){return"node"===e.runtime&&e.napi}(r))&&(!(r.abi!==t&&!r.napi)&&((!r.uv||r.uv===Le)&&((!r.armv||r.armv===Te)&&(!r.libc||r.libc===Ne)))))}}function qe(e){return function(t,r){return t.runtime!==r.runtime?t.runtime===e?-1:1:t.abi!==r.abi?t.abi?-1:1:t.specificity!==r.specificity?t.specificity>r.specificity?-1:1:0}}Me.path=function(e){e=_.default.resolve(e||".");try{var t=Ee(_.default.join(e,"package.json")).name.toUpperCase().replace(/-/g,"_");process.env[t+"_PREBUILD"]&&(e=process.env[t+"_PREBUILD"])}catch(e){}if(!Ce){var r=je(_.default.join(e,"build/Release"),Fe);if(r)return r;var n=je(_.default.join(e,"build/Debug"),Fe);if(n)return n}var s=a(e);if(s)return s;var i=a(_.default.dirname(process.execPath));if(i)return i;var o=["platform="+Pe,"arch="+Ie,"runtime="+Oe,"abi="+xe,"uv="+Le,Te?"armv="+Te:"","libc="+Ne,"node="+process.versions.node,process.versions.electron?"electron="+process.versions.electron:"","function"==typeof __webpack_require__?"webpack=true":""].filter(Boolean).join(" ");throw new Error("No native build was found for "+o+"\n    loaded from: "+e+"\n");function a(e){var t=De(_.default.join(e,"prebuilds")).map(Ae).filter(Ue(Pe,Ie)).sort(Be)[0];if(t){var r=_.default.join(e,"prebuilds",t.name),n=De(r).map($e).filter(We(Oe,xe)).sort(qe(Oe))[0];return n?_.default.join(r,n.file):void 0}}},Me.parseTags=$e,Me.matchTags=We,Me.compareTags=qe,Me.parseTuple=Ae,Me.matchTuple=Ue,Me.compareTuples=Be;var Ge={mask:(e,t,r,n,s)=>{for(var i=0;i<s;i++)r[n+i]=e[i]^t[3&i]},unmask:(e,t)=>{const r=e.length;for(var n=0;n<r;n++)e[n]^=t[3&n]}},Ve=we((function(e){try{e.exports=Re(__dirname)}catch(t){e.exports=Ge}})),Je=we((function(e){const{EMPTY_BUFFER:t}=Se;function r(e,r){if(0===e.length)return t;if(1===e.length)return e[0];const n=Buffer.allocUnsafe(r);let s=0;for(let t=0;t<e.length;t++){const r=e[t];n.set(r,s),s+=r.length}return s<r?n.slice(0,s):n}function n(e,t,r,n,s){for(let i=0;i<s;i++)r[n+i]=e[i]^t[3&i]}function s(e,t){const r=e.length;for(let n=0;n<r;n++)e[n]^=t[3&n]}function i(e){return e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function o(e){if(o.readOnly=!0,Buffer.isBuffer(e))return e;let t;return e instanceof ArrayBuffer?t=Buffer.from(e):ArrayBuffer.isView(e)?t=Buffer.from(e.buffer,e.byteOffset,e.byteLength):(t=Buffer.from(e),o.readOnly=!1),t}try{const t=Ve,a=t.BufferUtil||t;e.exports={concat:r,mask(e,t,r,s,i){i<48?n(e,t,r,s,i):a.mask(e,t,r,s,i)},toArrayBuffer:i,toBuffer:o,unmask(e,t){e.length<32?s(e,t):a.unmask(e,t)}}}catch(t){e.exports={concat:r,mask:n,toArrayBuffer:i,toBuffer:o,unmask:s}}}));const He=Symbol("kDone"),Ye=Symbol("kRun");var ze=class{constructor(e){this[He]=()=>{this.pending--,this[Ye]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[Ye]()}[Ye](){if(this.pending!==this.concurrency&&this.jobs.length){const e=this.jobs.shift();this.pending++,e(this[He])}}};const{kStatusCode:Ke,NOOP:Qe}=Se,Xe=Buffer.from([0,0,255,255]),Ze=Symbol("permessage-deflate"),et=Symbol("total-length"),tt=Symbol("callback"),rt=Symbol("buffers"),nt=Symbol("error");let st;var it=class{constructor(e,t,r){if(this._maxPayload=0|r,this._options=e||{},this._threshold=void 0!==this._options.threshold?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!st){const e=void 0!==this._options.concurrencyLimit?this._options.concurrencyLimit:10;st=new ze(e)}}static get extensionName(){return"permessage-deflate"}offer(){const e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){const e=this._deflate[tt];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){const t=this._options,r=e.find(e=>!(!1===t.serverNoContextTakeover&&e.server_no_context_takeover||e.server_max_window_bits&&(!1===t.serverMaxWindowBits||"number"==typeof t.serverMaxWindowBits&&t.serverMaxWindowBits>e.server_max_window_bits)||"number"==typeof t.clientMaxWindowBits&&!e.client_max_window_bits));if(!r)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(r.server_no_context_takeover=!0),t.clientNoContextTakeover&&(r.client_no_context_takeover=!0),"number"==typeof t.serverMaxWindowBits&&(r.server_max_window_bits=t.serverMaxWindowBits),"number"==typeof t.clientMaxWindowBits?r.client_max_window_bits=t.clientMaxWindowBits:!0!==r.client_max_window_bits&&!1!==t.clientMaxWindowBits||delete r.client_max_window_bits,r}acceptAsClient(e){const t=e[0];if(!1===this._options.clientNoContextTakeover&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(t.client_max_window_bits){if(!1===this._options.clientMaxWindowBits||"number"==typeof this._options.clientMaxWindowBits&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"')}else"number"==typeof this._options.clientMaxWindowBits&&(t.client_max_window_bits=this._options.clientMaxWindowBits);return t}normalizeParams(e){return e.forEach(e=>{Object.keys(e).forEach(t=>{let r=e[t];if(r.length>1)throw new Error(`Parameter "${t}" must have only a single value`);if(r=r[0],"client_max_window_bits"===t){if(!0!==r){const e=+r;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${r}`);r=e}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${t}": ${r}`)}else if("server_max_window_bits"===t){const e=+r;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${r}`);r=e}else{if("client_no_context_takeover"!==t&&"server_no_context_takeover"!==t)throw new Error(`Unknown parameter "${t}"`);if(!0!==r)throw new TypeError(`Invalid value for parameter "${t}": ${r}`)}e[t]=r})}),e}decompress(e,t,r){st.add(n=>{this._decompress(e,t,(e,t)=>{n(),r(e,t)})})}compress(e,t,r){st.add(n=>{this._compress(e,t,(e,t)=>{n(),r(e,t)})})}_decompress(e,t,r){const n=this._isServer?"client":"server";if(!this._inflate){const e=n+"_max_window_bits",t="number"!=typeof this.params[e]?O.default.Z_DEFAULT_WINDOWBITS:this.params[e];this._inflate=O.default.createInflateRaw({...this._options.zlibInflateOptions,windowBits:t}),this._inflate[Ze]=this,this._inflate[et]=0,this._inflate[rt]=[],this._inflate.on("error",ct),this._inflate.on("data",at)}this._inflate[tt]=r,this._inflate.write(e),t&&this._inflate.write(Xe),this._inflate.flush(()=>{const e=this._inflate[nt];if(e)return this._inflate.close(),this._inflate=null,void r(e);const s=Je.concat(this._inflate[rt],this._inflate[et]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[et]=0,this._inflate[rt]=[],t&&this.params[n+"_no_context_takeover"]&&this._inflate.reset()),r(null,s)})}_compress(e,t,r){const n=this._isServer?"server":"client";if(!this._deflate){const e=n+"_max_window_bits",t="number"!=typeof this.params[e]?O.default.Z_DEFAULT_WINDOWBITS:this.params[e];this._deflate=O.default.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:t}),this._deflate[et]=0,this._deflate[rt]=[],this._deflate.on("error",Qe),this._deflate.on("data",ot)}this._deflate[tt]=r,this._deflate.write(e),this._deflate.flush(O.default.Z_SYNC_FLUSH,()=>{if(!this._deflate)return;let e=Je.concat(this._deflate[rt],this._deflate[et]);t&&(e=e.slice(0,e.length-4)),this._deflate[tt]=null,this._deflate[et]=0,this._deflate[rt]=[],t&&this.params[n+"_no_context_takeover"]&&this._deflate.reset(),r(null,e)})}};function ot(e){this[rt].push(e),this[et]+=e.length}function at(e){this[et]+=e.length,this[Ze]._maxPayload<1||this[et]<=this[Ze]._maxPayload?this[rt].push(e):(this[nt]=new RangeError("Max payload size exceeded"),this[nt].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[nt][Ke]=1009,this.removeListener("data",at),this.reset())}function ct(e){this[Ze]._inflate=null,e[Ke]=1007,this[tt](e)}var lt=function(e){const t=e.length;let r=0;for(;r<t;)if(0==(128&e[r]))r++;else if(192==(224&e[r])){if(r+1===t||128!=(192&e[r+1])||192==(254&e[r]))return!1;r+=2}else if(224==(240&e[r])){if(r+2>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||224===e[r]&&128==(224&e[r+1])||237===e[r]&&160==(224&e[r+1]))return!1;r+=3}else{if(240!=(248&e[r]))return!1;if(r+3>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||128!=(192&e[r+3])||240===e[r]&&128==(240&e[r+1])||244===e[r]&&e[r+1]>143||e[r]>244)return!1;r+=4}return!0},ut=we((function(e){try{e.exports=Re(__dirname)}catch(t){e.exports=lt}})),dt=we((function(e){function t(e){return e>=1e3&&e<=1014&&1004!==e&&1005!==e&&1006!==e||e>=3e3&&e<=4999}function r(e){const t=e.length;let r=0;for(;r<t;)if(0==(128&e[r]))r++;else if(192==(224&e[r])){if(r+1===t||128!=(192&e[r+1])||192==(254&e[r]))return!1;r+=2}else if(224==(240&e[r])){if(r+2>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||224===e[r]&&128==(224&e[r+1])||237===e[r]&&160==(224&e[r+1]))return!1;r+=3}else{if(240!=(248&e[r]))return!1;if(r+3>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||128!=(192&e[r+3])||240===e[r]&&128==(240&e[r+1])||244===e[r]&&e[r+1]>143||e[r]>244)return!1;r+=4}return!0}try{let n=ut;"object"==typeof n&&(n=n.Validation.isValidUTF8),e.exports={isValidStatusCode:t,isValidUTF8:e=>e.length<150?r(e):n(e)}}catch(n){e.exports={isValidStatusCode:t,isValidUTF8:r}}}));const{Writable:ht}=C.default,{BINARY_TYPES:ft,EMPTY_BUFFER:pt,kStatusCode:_t,kWebSocket:mt}=Se,{concat:gt,toArrayBuffer:vt,unmask:yt}=Je,{isValidStatusCode:wt,isValidUTF8:bt}=dt;var St=class extends ht{constructor(e,t,r,n){super(),this._binaryType=e||ft[0],this[mt]=void 0,this._extensions=t||{},this._isServer=!!r,this._maxPayload=0|n,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._state=0,this._loop=!1}_write(e,t,r){if(8===this._opcode&&0==this._state)return r();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(r)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){const t=this._buffers[0];return this._buffers[0]=t.slice(e),t.slice(0,e)}const t=Buffer.allocUnsafe(e);do{const r=this._buffers[0],n=t.length-e;e>=r.length?t.set(this._buffers.shift(),n):(t.set(new Uint8Array(r.buffer,r.byteOffset,e),n),this._buffers[0]=r.slice(e)),e-=r.length}while(e>0);return t}startLoop(e){let t;this._loop=!0;do{switch(this._state){case 0:t=this.getInfo();break;case 1:t=this.getPayloadLength16();break;case 2:t=this.getPayloadLength64();break;case 3:this.getMask();break;case 4:t=this.getData(e);break;default:return void(this._loop=!1)}}while(this._loop);e(t)}getInfo(){if(this._bufferedBytes<2)return void(this._loop=!1);const e=this.consume(2);if(0!=(48&e[0]))return this._loop=!1,Et(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3");const t=64==(64&e[0]);if(t&&!this._extensions[it.extensionName])return this._loop=!1,Et(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(this._fin=128==(128&e[0]),this._opcode=15&e[0],this._payloadLength=127&e[1],0===this._opcode){if(t)return this._loop=!1,Et(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(!this._fragmented)return this._loop=!1,Et(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE");this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented)return this._loop=!1,Et(RangeError,"invalid opcode "+this._opcode,!0,1002,"WS_ERR_INVALID_OPCODE");this._compressed=t}else{if(!(this._opcode>7&&this._opcode<11))return this._loop=!1,Et(RangeError,"invalid opcode "+this._opcode,!0,1002,"WS_ERR_INVALID_OPCODE");if(!this._fin)return this._loop=!1,Et(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN");if(t)return this._loop=!1,Et(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(this._payloadLength>125)return this._loop=!1,Et(RangeError,"invalid payload length "+this._payloadLength,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH")}if(this._fin||this._fragmented||(this._fragmented=this._opcode),this._masked=128==(128&e[1]),this._isServer){if(!this._masked)return this._loop=!1,Et(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK")}else if(this._masked)return this._loop=!1,Et(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK");if(126===this._payloadLength)this._state=1;else{if(127!==this._payloadLength)return this.haveLength();this._state=2}}getPayloadLength16(){if(!(this._bufferedBytes<2))return this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength();this._loop=!1}getPayloadLength64(){if(this._bufferedBytes<8)return void(this._loop=!1);const e=this.consume(8),t=e.readUInt32BE(0);return t>Math.pow(2,21)-1?(this._loop=!1,Et(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH")):(this._payloadLength=t*Math.pow(2,32)+e.readUInt32BE(4),this.haveLength())}haveLength(){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0))return this._loop=!1,Et(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");this._masked?this._state=3:this._state=4}getMask(){this._bufferedBytes<4?this._loop=!1:(this._mask=this.consume(4),this._state=4)}getData(e){let t=pt;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength)return void(this._loop=!1);t=this.consume(this._payloadLength),this._masked&&yt(t,this._mask)}return this._opcode>7?this.controlMessage(t):this._compressed?(this._state=5,void this.decompress(t,e)):(t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage())}decompress(e,t){this._extensions[it.extensionName].decompress(e,this._fin,(e,r)=>{if(e)return t(e);if(r.length){if(this._messageLength+=r.length,this._messageLength>this._maxPayload&&this._maxPayload>0)return t(Et(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"));this._fragments.push(r)}const n=this.dataMessage();if(n)return t(n);this.startLoop(t)})}dataMessage(){if(this._fin){const e=this._messageLength,t=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],2===this._opcode){let r;r="nodebuffer"===this._binaryType?gt(t,e):"arraybuffer"===this._binaryType?vt(gt(t,e)):t,this.emit("message",r)}else{const r=gt(t,e);if(!bt(r))return this._loop=!1,Et(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");this.emit("message",r.toString())}}this._state=0}controlMessage(e){if(8===this._opcode)if(this._loop=!1,0===e.length)this.emit("conclude",1005,""),this.end();else{if(1===e.length)return Et(RangeError,"invalid payload length 1",!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH");{const t=e.readUInt16BE(0);if(!wt(t))return Et(RangeError,"invalid status code "+t,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");const r=e.slice(2);if(!bt(r))return Et(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");this.emit("conclude",t,r.toString()),this.end()}}else 9===this._opcode?this.emit("ping",e):this.emit("pong",e);this._state=0}};function Et(e,t,r,n,s){const i=new e(r?"Invalid WebSocket frame: "+t:t);return Error.captureStackTrace(i,Et),i.code=s,i[_t]=n,i}const{randomFillSync:kt}=k.default,{EMPTY_BUFFER:Ct}=Se,{isValidStatusCode:xt}=dt,{mask:Ot,toBuffer:It}=Je,Pt=Buffer.alloc(4);class Nt{constructor(e,t){this._extensions=t||{},this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._deflating=!1,this._queue=[]}static frame(e,t){const r=t.mask&&t.readOnly;let n=t.mask?6:2,s=e.length;e.length>=65536?(n+=8,s=127):e.length>125&&(n+=2,s=126);const i=Buffer.allocUnsafe(r?e.length+n:n);return i[0]=t.fin?128|t.opcode:t.opcode,t.rsv1&&(i[0]|=64),i[1]=s,126===s?i.writeUInt16BE(e.length,2):127===s&&(i.writeUInt32BE(0,2),i.writeUInt32BE(e.length,6)),t.mask?(kt(Pt,0,4),i[1]|=128,i[n-4]=Pt[0],i[n-3]=Pt[1],i[n-2]=Pt[2],i[n-1]=Pt[3],r?(Ot(e,Pt,i,n,e.length),[i]):(Ot(e,Pt,e,0,e.length),[i,e])):[i,e]}close(e,t,r,n){let s;if(void 0===e)s=Ct;else{if("number"!=typeof e||!xt(e))throw new TypeError("First argument must be a valid error code number");if(void 0===t||""===t)s=Buffer.allocUnsafe(2),s.writeUInt16BE(e,0);else{const r=Buffer.byteLength(t);if(r>123)throw new RangeError("The message must not be greater than 123 bytes");s=Buffer.allocUnsafe(2+r),s.writeUInt16BE(e,0),s.write(t,2)}}this._deflating?this.enqueue([this.doClose,s,r,n]):this.doClose(s,r,n)}doClose(e,t,r){this.sendFrame(Nt.frame(e,{fin:!0,rsv1:!1,opcode:8,mask:t,readOnly:!1}),r)}ping(e,t,r){const n=It(e);if(n.length>125)throw new RangeError("The data size must not be greater than 125 bytes");this._deflating?this.enqueue([this.doPing,n,t,It.readOnly,r]):this.doPing(n,t,It.readOnly,r)}doPing(e,t,r,n){this.sendFrame(Nt.frame(e,{fin:!0,rsv1:!1,opcode:9,mask:t,readOnly:r}),n)}pong(e,t,r){const n=It(e);if(n.length>125)throw new RangeError("The data size must not be greater than 125 bytes");this._deflating?this.enqueue([this.doPong,n,t,It.readOnly,r]):this.doPong(n,t,It.readOnly,r)}doPong(e,t,r,n){this.sendFrame(Nt.frame(e,{fin:!0,rsv1:!1,opcode:10,mask:t,readOnly:r}),n)}send(e,t,r){const n=It(e),s=this._extensions[it.extensionName];let i=t.binary?2:1,o=t.compress;if(this._firstFragment?(this._firstFragment=!1,o&&s&&(o=n.length>=s._threshold),this._compress=o):(o=!1,i=0),t.fin&&(this._firstFragment=!0),s){const e={fin:t.fin,rsv1:o,opcode:i,mask:t.mask,readOnly:It.readOnly};this._deflating?this.enqueue([this.dispatch,n,this._compress,e,r]):this.dispatch(n,this._compress,e,r)}else this.sendFrame(Nt.frame(n,{fin:t.fin,rsv1:!1,opcode:i,mask:t.mask,readOnly:It.readOnly}),r)}dispatch(e,t,r,n){if(!t)return void this.sendFrame(Nt.frame(e,r),n);const s=this._extensions[it.extensionName];this._bufferedBytes+=e.length,this._deflating=!0,s.compress(e,r.fin,(t,s)=>{if(this._socket.destroyed){const e=new Error("The socket was closed while data was being compressed");"function"==typeof n&&n(e);for(let t=0;t<this._queue.length;t++){const r=this._queue[t][4];"function"==typeof r&&r(e)}}else this._bufferedBytes-=e.length,this._deflating=!1,r.readOnly=!1,this.sendFrame(Nt.frame(s,r),n),this.dequeue()})}dequeue(){for(;!this._deflating&&this._queue.length;){const e=this._queue.shift();this._bufferedBytes-=e[1].length,Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[1].length,this._queue.push(e)}sendFrame(e,t){2===e.length?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}}var Tt=Nt;class Lt{constructor(e,t){this.target=t,this.type=e}}class Rt extends Lt{constructor(e,t){super("message",t),this.data=e}}class Mt extends Lt{constructor(e,t,r){super("close",r),this.wasClean=r._closeFrameReceived&&r._closeFrameSent,this.reason=t,this.code=e}}class Dt extends Lt{constructor(e){super("open",e)}}class jt extends Lt{constructor(e,t){super("error",t),this.message=e.message,this.error=e}}var Ft={addEventListener(e,t,r){if("function"!=typeof t)return;function n(e){t.call(this,new Rt(e,this))}function s(e,r){t.call(this,new Mt(e,r,this))}function i(e){t.call(this,new jt(e,this))}function o(){t.call(this,new Dt(this))}const a=r&&r.once?"once":"on";"message"===e?(n._listener=t,this[a](e,n)):"close"===e?(s._listener=t,this[a](e,s)):"error"===e?(i._listener=t,this[a](e,i)):"open"===e?(o._listener=t,this[a](e,o)):this[a](e,t)},removeEventListener(e,t){const r=this.listeners(e);for(let n=0;n<r.length;n++)r[n]!==t&&r[n]._listener!==t||this.removeListener(e,r[n])}};const At=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function Ut(e,t,r){void 0===e[t]?e[t]=[r]:e[t].push(r)}var Bt={format:function(e){return Object.keys(e).map(t=>{let r=e[t];return Array.isArray(r)||(r=[r]),r.map(e=>[t].concat(Object.keys(e).map(t=>{let r=e[t];return Array.isArray(r)||(r=[r]),r.map(e=>!0===e?t:`${t}=${e}`).join("; ")})).join("; ")).join(", ")}).join(", ")},parse:function(e){const t=Object.create(null);if(void 0===e||""===e)return t;let r,n,s=Object.create(null),i=!1,o=!1,a=!1,c=-1,l=-1,u=0;for(;u<e.length;u++){const d=e.charCodeAt(u);if(void 0===r)if(-1===l&&1===At[d])-1===c&&(c=u);else if(32===d||9===d)-1===l&&-1!==c&&(l=u);else{if(59!==d&&44!==d)throw new SyntaxError("Unexpected character at index "+u);{if(-1===c)throw new SyntaxError("Unexpected character at index "+u);-1===l&&(l=u);const n=e.slice(c,l);44===d?(Ut(t,n,s),s=Object.create(null)):r=n,c=l=-1}}else if(void 0===n)if(-1===l&&1===At[d])-1===c&&(c=u);else if(32===d||9===d)-1===l&&-1!==c&&(l=u);else if(59===d||44===d){if(-1===c)throw new SyntaxError("Unexpected character at index "+u);-1===l&&(l=u),Ut(s,e.slice(c,l),!0),44===d&&(Ut(t,r,s),s=Object.create(null),r=void 0),c=l=-1}else{if(61!==d||-1===c||-1!==l)throw new SyntaxError("Unexpected character at index "+u);n=e.slice(c,u),c=l=-1}else if(o){if(1!==At[d])throw new SyntaxError("Unexpected character at index "+u);-1===c?c=u:i||(i=!0),o=!1}else if(a)if(1===At[d])-1===c&&(c=u);else if(34===d&&-1!==c)a=!1,l=u;else{if(92!==d)throw new SyntaxError("Unexpected character at index "+u);o=!0}else if(34===d&&61===e.charCodeAt(u-1))a=!0;else if(-1===l&&1===At[d])-1===c&&(c=u);else if(-1===c||32!==d&&9!==d){if(59!==d&&44!==d)throw new SyntaxError("Unexpected character at index "+u);{if(-1===c)throw new SyntaxError("Unexpected character at index "+u);-1===l&&(l=u);let o=e.slice(c,l);i&&(o=o.replace(/\\/g,""),i=!1),Ut(s,n,o),44===d&&(Ut(t,r,s),s=Object.create(null),r=void 0),n=void 0,c=l=-1}}else-1===l&&(l=u)}if(-1===c||a)throw new SyntaxError("Unexpected end of input");-1===l&&(l=u);const d=e.slice(c,l);return void 0===r?Ut(t,d,s):(void 0===n?Ut(s,d,!0):Ut(s,n,i?d.replace(/\\/g,""):d),Ut(t,r,s)),t}};const{randomBytes:$t,createHash:Wt}=k.default,{URL:qt}=x.default,{BINARY_TYPES:Gt,EMPTY_BUFFER:Vt,GUID:Jt,kStatusCode:Ht,kWebSocket:Yt,NOOP:zt}=Se,{addEventListener:Kt,removeEventListener:Qt}=Ft,{format:Xt,parse:Zt}=Bt,{toBuffer:er}=Je,tr=["CONNECTING","OPEN","CLOSING","CLOSED"],rr=[8,13];class nr extends y.default{constructor(e,t,r){super(),this._binaryType=Gt[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage="",this._closeTimer=null,this._extensions={},this._protocol="",this._readyState=nr.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,null!==e?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,Array.isArray(t)?t=t.join(", "):"object"==typeof t&&null!==t&&(r=t,t=void 0),function e(t,r,n,s){const i={protocolVersion:rr[1],maxPayload:104857600,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...s,createConnection:void 0,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:void 0,host:void 0,path:void 0,port:void 0};if(!rr.includes(i.protocolVersion))throw new RangeError(`Unsupported protocol version: ${i.protocolVersion} (supported versions: ${rr.join(", ")})`);let o;r instanceof qt?(o=r,t._url=r.href):(o=new qt(r),t._url=r);const a="ws+unix:"===o.protocol;if(!(o.host||a&&o.pathname)){const e=new Error("Invalid URL: "+t.url);if(0===t._redirects)throw e;return void ir(t,e)}const c="wss:"===o.protocol||"https:"===o.protocol,l=c?443:80,u=$t(16).toString("base64"),d=c?b.default.get:w.default.get;let h;i.createConnection=c?ar:or,i.defaultPort=i.defaultPort||l,i.port=o.port||l,i.host=o.hostname.startsWith("[")?o.hostname.slice(1,-1):o.hostname,i.headers={"Sec-WebSocket-Version":i.protocolVersion,"Sec-WebSocket-Key":u,Connection:"Upgrade",Upgrade:"websocket",...i.headers},i.path=o.pathname+o.search,i.timeout=i.handshakeTimeout,i.perMessageDeflate&&(h=new it(!0!==i.perMessageDeflate?i.perMessageDeflate:{},!1,i.maxPayload),i.headers["Sec-WebSocket-Extensions"]=Xt({[it.extensionName]:h.offer()}));n&&(i.headers["Sec-WebSocket-Protocol"]=n);i.origin&&(i.protocolVersion<13?i.headers["Sec-WebSocket-Origin"]=i.origin:i.headers.Origin=i.origin);(o.username||o.password)&&(i.auth=`${o.username}:${o.password}`);if(a){const e=i.path.split(":");i.socketPath=e[0],i.path=e[1]}let f=t._req=d(i);i.timeout&&f.on("timeout",()=>{cr(t,f,"Opening handshake has timed out")});f.on("error",e=>{null===f||f.aborted||(f=t._req=null,ir(t,e))}),f.on("response",o=>{const a=o.headers.location,c=o.statusCode;if(a&&i.followRedirects&&c>=300&&c<400){if(++t._redirects>i.maxRedirects)return void cr(t,f,"Maximum redirects exceeded");let o;f.abort();try{o=new qt(a,r)}catch(e){return void ir(t,e)}e(t,o,n,s)}else t.emit("unexpected-response",f,o)||cr(t,f,"Unexpected server response: "+o.statusCode)}),f.on("upgrade",(e,r,s)=>{if(t.emit("upgrade",e),t.readyState!==nr.CONNECTING)return;f=t._req=null;const o=Wt("sha1").update(u+Jt).digest("base64");if(e.headers["sec-websocket-accept"]!==o)return void cr(t,r,"Invalid Sec-WebSocket-Accept header");const a=e.headers["sec-websocket-protocol"],c=(n||"").split(/, */);let l;if(!n&&a?l="Server sent a subprotocol but none was requested":n&&!a?l="Server sent no subprotocol":a&&!c.includes(a)&&(l="Server sent an invalid subprotocol"),l)return void cr(t,r,l);a&&(t._protocol=a);const d=e.headers["sec-websocket-extensions"];if(void 0!==d){if(!h){return void cr(t,r,"Server sent a Sec-WebSocket-Extensions header but no extension was requested")}let e;try{e=Zt(d)}catch(e){return void cr(t,r,"Invalid Sec-WebSocket-Extensions header")}const n=Object.keys(e);if(n.length){if(1!==n.length||n[0]!==it.extensionName){return void cr(t,r,"Server indicated an extension that was not requested")}try{h.accept(e[it.extensionName])}catch(e){return void cr(t,r,"Invalid Sec-WebSocket-Extensions header")}t._extensions[it.extensionName]=h}}t.setSocket(r,s,i.maxPayload)})}(this,e,t,r)):this._isServer=!0}get binaryType(){return this._binaryType}set binaryType(e){Gt.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get onclose(){}set onclose(e){}get onerror(){}set onerror(e){}get onopen(){}set onopen(e){}get onmessage(){}set onmessage(e){}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,r){const n=new St(this.binaryType,this._extensions,this._isServer,r);this._sender=new Tt(e,this._extensions),this._receiver=n,this._socket=e,n[Yt]=this,e[Yt]=this,n.on("conclude",ur),n.on("drain",dr),n.on("error",hr),n.on("message",pr),n.on("ping",_r),n.on("pong",mr),e.setTimeout(0),e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",vr),e.on("data",yr),e.on("end",wr),e.on("error",br),this._readyState=nr.OPEN,this.emit("open")}emitClose(){if(!this._socket)return this._readyState=nr.CLOSED,void this.emit("close",this._closeCode,this._closeMessage);this._extensions[it.extensionName]&&this._extensions[it.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=nr.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==nr.CLOSED){if(this.readyState===nr.CONNECTING){const e="WebSocket was closed before the connection was established";return cr(this,this._req,e)}this.readyState!==nr.CLOSING?(this._readyState=nr.CLOSING,this._sender.close(e,t,!this._isServer,e=>{e||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())}),this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),3e4)):this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end()}}ping(e,t,r){if(this.readyState===nr.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(r=e,e=t=void 0):"function"==typeof t&&(r=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===nr.OPEN?(void 0===t&&(t=!this._isServer),this._sender.ping(e||Vt,t,r)):lr(this,e,r)}pong(e,t,r){if(this.readyState===nr.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(r=e,e=t=void 0):"function"==typeof t&&(r=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===nr.OPEN?(void 0===t&&(t=!this._isServer),this._sender.pong(e||Vt,t,r)):lr(this,e,r)}send(e,t,r){if(this.readyState===nr.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof t&&(r=t,t={}),"number"==typeof e&&(e=e.toString()),this.readyState!==nr.OPEN)return void lr(this,e,r);const n={binary:"string"!=typeof e,mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[it.extensionName]||(n.compress=!1),this._sender.send(e||Vt,n,r)}terminate(){if(this.readyState!==nr.CLOSED){if(this.readyState===nr.CONNECTING){const e="WebSocket was closed before the connection was established";return cr(this,this._req,e)}this._socket&&(this._readyState=nr.CLOSING,this._socket.destroy())}}}Object.defineProperty(nr,"CONNECTING",{enumerable:!0,value:tr.indexOf("CONNECTING")}),Object.defineProperty(nr.prototype,"CONNECTING",{enumerable:!0,value:tr.indexOf("CONNECTING")}),Object.defineProperty(nr,"OPEN",{enumerable:!0,value:tr.indexOf("OPEN")}),Object.defineProperty(nr.prototype,"OPEN",{enumerable:!0,value:tr.indexOf("OPEN")}),Object.defineProperty(nr,"CLOSING",{enumerable:!0,value:tr.indexOf("CLOSING")}),Object.defineProperty(nr.prototype,"CLOSING",{enumerable:!0,value:tr.indexOf("CLOSING")}),Object.defineProperty(nr,"CLOSED",{enumerable:!0,value:tr.indexOf("CLOSED")}),Object.defineProperty(nr.prototype,"CLOSED",{enumerable:!0,value:tr.indexOf("CLOSED")}),["binaryType","bufferedAmount","extensions","protocol","readyState","url"].forEach(e=>{Object.defineProperty(nr.prototype,e,{enumerable:!0})}),["open","error","close","message"].forEach(e=>{Object.defineProperty(nr.prototype,"on"+e,{enumerable:!0,get(){const t=this.listeners(e);for(let e=0;e<t.length;e++)if(t[e]._listener)return t[e]._listener},set(t){const r=this.listeners(e);for(let t=0;t<r.length;t++)r[t]._listener&&this.removeListener(e,r[t]);this.addEventListener(e,t)}})}),nr.prototype.addEventListener=Kt,nr.prototype.removeEventListener=Qt;var sr=nr;function ir(e,t){e._readyState=nr.CLOSING,e.emit("error",t),e.emitClose()}function or(e){return e.path=e.socketPath,S.default.connect(e)}function ar(e){return e.path=void 0,e.servername||""===e.servername||(e.servername=S.default.isIP(e.host)?"":e.host),E.default.connect(e)}function cr(e,t,r){e._readyState=nr.CLOSING;const n=new Error(r);Error.captureStackTrace(n,cr),t.setHeader?(t.abort(),t.socket&&!t.socket.destroyed&&t.socket.destroy(),t.once("abort",e.emitClose.bind(e)),e.emit("error",n)):(t.destroy(n),t.once("error",e.emit.bind(e,"error")),t.once("close",e.emitClose.bind(e)))}function lr(e,t,r){if(t){const r=er(t).length;e._socket?e._sender._bufferedBytes+=r:e._bufferedAmount+=r}if(r){r(new Error(`WebSocket is not open: readyState ${e.readyState} (${tr[e.readyState]})`))}}function ur(e,t){const r=this[Yt];r._closeFrameReceived=!0,r._closeMessage=t,r._closeCode=e,void 0!==r._socket[Yt]&&(r._socket.removeListener("data",yr),process.nextTick(gr,r._socket),1005===e?r.close():r.close(e,t))}function dr(){this[Yt]._socket.resume()}function hr(e){const t=this[Yt];void 0!==t._socket[Yt]&&(t._socket.removeListener("data",yr),process.nextTick(gr,t._socket),t.close(e[Ht])),t.emit("error",e)}function fr(){this[Yt].emitClose()}function pr(e){this[Yt].emit("message",e)}function _r(e){const t=this[Yt];t.pong(e,!t._isServer,zt),t.emit("ping",e)}function mr(e){this[Yt].emit("pong",e)}function gr(e){e.resume()}function vr(){const e=this[Yt];let t;this.removeListener("close",vr),this.removeListener("data",yr),this.removeListener("end",wr),e._readyState=nr.CLOSING,this._readableState.endEmitted||e._closeFrameReceived||e._receiver._writableState.errorEmitted||null===(t=e._socket.read())||e._receiver.write(t),e._receiver.end(),this[Yt]=void 0,clearTimeout(e._closeTimer),e._receiver._writableState.finished||e._receiver._writableState.errorEmitted?e.emitClose():(e._receiver.on("error",fr),e._receiver.on("finish",fr))}function yr(e){this[Yt]._receiver.write(e)||this.pause()}function wr(){const e=this[Yt];e._readyState=nr.CLOSING,e._receiver.end(),this.end()}function br(){const e=this[Yt];this.removeListener("error",br),this.on("error",zt),e&&(e._readyState=nr.CLOSING,this.destroy())}const{Duplex:Sr}=C.default;function Er(e){e.emit("close")}function kr(){!this.destroyed&&this._writableState.finished&&this.destroy()}function Cr(e){this.removeListener("error",Cr),this.destroy(),0===this.listenerCount("error")&&this.emit("error",e)}var xr=function(e,t){let r=!0,n=!0;function s(){r&&e._socket.resume()}e.readyState===e.CONNECTING?e.once("open",(function(){e._receiver.removeAllListeners("drain"),e._receiver.on("drain",s)})):(e._receiver.removeAllListeners("drain"),e._receiver.on("drain",s));const i=new Sr({...t,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return e.on("message",(function(t){i.push(t)||(r=!1,e._socket.pause())})),e.once("error",(function(e){i.destroyed||(n=!1,i.destroy(e))})),e.once("close",(function(){i.destroyed||i.push(null)})),i._destroy=function(t,r){if(e.readyState===e.CLOSED)return r(t),void process.nextTick(Er,i);let s=!1;e.once("error",(function(e){s=!0,r(e)})),e.once("close",(function(){s||r(t),process.nextTick(Er,i)})),n&&e.terminate()},i._final=function(t){e.readyState!==e.CONNECTING?null!==e._socket&&(e._socket._writableState.finished?(t(),i._readableState.endEmitted&&i.destroy()):(e._socket.once("finish",(function(){t()})),e.close())):e.once("open",(function(){i._final(t)}))},i._read=function(){e.readyState!==e.OPEN&&e.readyState!==e.CLOSING||r||(r=!0,e._receiver._writableState.needDrain||e._socket.resume())},i._write=function(t,r,n){e.readyState!==e.CONNECTING?e.send(t,n):e.once("open",(function(){i._write(t,r,n)}))},i.on("end",kr),i.on("error",Cr),i};const{createHash:Or}=k.default,{format:Ir,parse:Pr}=Bt,{GUID:Nr,kWebSocket:Tr}=Se,Lr=/^[+/0-9A-Za-z]{22}==$/;class Rr extends y.default{constructor(e,t){if(super(),null==(e={maxPayload:104857600,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,...e}).port&&!e.server&&!e.noServer||null!=e.port&&(e.server||e.noServer)||e.server&&e.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(null!=e.port?(this._server=w.default.createServer((e,t)=>{const r=w.default.STATUS_CODES[426];t.writeHead(426,{"Content-Length":r.length,"Content-Type":"text/plain"}),t.end(r)}),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server){const e=this.emit.bind(this,"connection");this._removeListeners=function(e,t){for(const r of Object.keys(t))e.on(r,t[r]);return function(){for(const r of Object.keys(t))e.removeListener(r,t[r])}}(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(t,r,n)=>{this.handleUpgrade(t,r,n,e)}})}!0===e.perMessageDeflate&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set),this.options=e,this._state=0}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(e&&this.once("close",e),2===this._state)return void process.nextTick(Dr,this);if(1===this._state)return;if(this._state=1,this.clients)for(const e of this.clients)e.terminate();const t=this._server;t&&(this._removeListeners(),this._removeListeners=this._server=null,null!=this.options.port)?t.close(Dr.bind(void 0,this)):process.nextTick(Dr,this)}shouldHandle(e){if(this.options.path){const t=e.url.indexOf("?");if((-1!==t?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,r,n){t.on("error",jr);const s=void 0!==e.headers["sec-websocket-key"]&&e.headers["sec-websocket-key"].trim(),i=+e.headers["sec-websocket-version"],o={};if("GET"!==e.method||"websocket"!==e.headers.upgrade.toLowerCase()||!s||!Lr.test(s)||8!==i&&13!==i||!this.shouldHandle(e))return Fr(t,400);if(this.options.perMessageDeflate){const r=new it(this.options.perMessageDeflate,!0,this.options.maxPayload);try{const t=Pr(e.headers["sec-websocket-extensions"]);t[it.extensionName]&&(r.accept(t[it.extensionName]),o[it.extensionName]=r)}catch(e){return Fr(t,400)}}if(this.options.verifyClient){const a={origin:e.headers[""+(8===i?"sec-websocket-origin":"origin")],secure:!(!e.socket.authorized&&!e.socket.encrypted),req:e};if(2===this.options.verifyClient.length)return void this.options.verifyClient(a,(i,a,c,l)=>{if(!i)return Fr(t,a||401,c,l);this.completeUpgrade(s,o,e,t,r,n)});if(!this.options.verifyClient(a))return Fr(t,401)}this.completeUpgrade(s,o,e,t,r,n)}completeUpgrade(e,t,r,n,s,i){if(!n.readable||!n.writable)return n.destroy();if(n[Tr])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>0)return Fr(n,503);const o=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Accept: "+Or("sha1").update(e+Nr).digest("base64")],a=new sr(null);let c=r.headers["sec-websocket-protocol"];if(c&&(c=c.split(",").map(Ar),c=this.options.handleProtocols?this.options.handleProtocols(c,r):c[0],c&&(o.push("Sec-WebSocket-Protocol: "+c),a._protocol=c)),t[it.extensionName]){const e=t[it.extensionName].params,r=Ir({[it.extensionName]:[e]});o.push("Sec-WebSocket-Extensions: "+r),a._extensions=t}this.emit("headers",o,r),n.write(o.concat("\r\n").join("\r\n")),n.removeListener("error",jr),a.setSocket(n,s,this.options.maxPayload),this.clients&&(this.clients.add(a),a.on("close",()=>this.clients.delete(a))),i(a,r)}}var Mr=Rr;function Dr(e){e._state=2,e.emit("close")}function jr(){this.destroy()}function Fr(e,t,r,n){e.writable&&(r=r||w.default.STATUS_CODES[t],n={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(r),...n},e.write(`HTTP/1.1 ${t} ${w.default.STATUS_CODES[t]}\r\n`+Object.keys(n).map(e=>`${e}: ${n[e]}`).join("\r\n")+"\r\n\r\n"+r)),e.removeListener("error",jr),e.destroy()}function Ar(e){return e.trim()}sr.createWebSocketStream=xr,sr.Server=Mr,sr.Receiver=St,sr.Sender=Tt;var Ur=sr,Br=we((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});class r extends Error{constructor(e){super(e.message),this._code=e.code||0,this._data=e.data||null}get code(){return this._code}get data(){return this._data}}t.MessageError=r;class n extends y.default.EventEmitter{constructor(e,t){if(super(),this._responsePromiseMap=new Map,this._nextMessageId=0,this._connected=!1,this._emitLog=!1,this._consoleLog=!1,this._requestQueue=[],this.setLogging(t),!e)throw new TypeError("socket cannot be undefined or null");this._socket=e,e.on("open",()=>{this._connected=!0,this._sendQueuedRequests()}),e.on("message",e=>this.processMessage(e))}processMessage(e){let t;this._logMessage(e,"receive");try{t=JSON.parse(e)}catch(e){return this.emit("error",e)}if(t)if(t.id)if(this._responsePromiseMap.has(t.id)){const n=this._responsePromiseMap.get(t.id);t.result?n.resolve(t.result):t.error?n.reject(new r(t.error)):this.emit("error",new Error("Response must have result or error: "+e))}else this.emit("error",new Error(`Response with id:${t.id} has no pending request`));else t.method?this.emit(t.method,t.params):this.emit("error",new Error("Invalid message: "+e));else this.emit("error",new Error("Message cannot be null, empty or undefined"))}setLogging({logEmit:e,logConsole:t}={}){this._emitLog=e,this._consoleLog=t}_send(e){this._requestQueue.push(JSON.stringify(e)),this._sendQueuedRequests()}_sendQueuedRequests(){if(this._connected){for(let e of this._requestQueue)this._logMessage(e,"send"),this._socket.send(e);this._requestQueue=[]}}_logMessage(e,t){this._consoleLog&&console.log("Client "+("send"===t?">":"<"),e),this._emitLog&&this.emit(t,e)}call(e,t){const r=++this._nextMessageId,n={id:r,method:e,params:t};return new Promise((e,t)=>{try{this._send(n),this._responsePromiseMap.set(r,{resolve:e,reject:t})}catch(e){return t(e)}})}notify(e,t){this._send({method:e,params:t})}api(e){if(!Proxy)throw new Error("api() requires ES6 Proxy. Please use an ES6 compatible engine");return new Proxy({},{get:(t,r)=>{if(t[r])return t[r];if("__proto__"===r||"prototype"===r)return Object.prototype;if(void 0===e)t[r]=this.api(r+".");else if("on"===r)t[r]=(t,r)=>this.on(`${e}${t}`,r);else if("emit"===r)t[r]=(t,r)=>this.notify(`${e}${t}`,r);else if("on"===r.substr(0,2)&&r.length>3){const n=r[2].toLowerCase()+r.substr(3);t[r]=t=>this.on(`${e}${n}`,t)}else if("emit"===r.substr(0,4)&&r.length>5){const n=r[4].toLowerCase()+r.substr(5);t[r]=t=>this.notify(`${e}${n}`,t)}else{const n=r;t[r]=t=>this.call(`${e}${n}`,t)}return t[r]}})}}t.Client=n;class s extends y.default.EventEmitter{constructor(e,t){if(super(),this._exposedMethodsMap=new Map,this._emitLog=!1,this._consoleLog=!1,this.setLogging(t),!e)throw new TypeError("server cannot be undefined or null");this._socketServer=e,e.on("connection",e=>{e.on("message",t=>this.processMessage(t,e))})}processMessage(e,t){let r;this._logMessage(e,"receive");try{r=JSON.parse(e)}catch(e){return this._sendError(t,r,-32700)}if(r&&r.method&&"string"==typeof r.method)if(r.id&&"number"==typeof r.id){const e=this._exposedMethodsMap.get(r.method);if(e)try{const n=e.call(null,r.params);n instanceof Promise?n.then(e=>{this._send(t,{id:r.id,result:e||{}})}).catch(e=>{this._sendError(t,r,-32603,e)}):this._send(t,{id:r.id,result:n||{}})}catch(e){this._sendError(t,r,-32603,e)}else this._sendError(t,r,-32601)}else this.emit(r.method,r.params);else this._sendError(t,r,-32600)}setLogging({logEmit:e,logConsole:t}={}){this._emitLog=e,this._consoleLog=t}_logMessage(e,t){this._consoleLog&&console.log("Server "+("send"===t?">":"<"),e),this._emitLog&&this.emit(t,e)}_send(e,t){const r=JSON.stringify(t);this._logMessage(r,"send"),e.send(r)}_sendError(e,t,r,n){try{this._send(e,{id:t&&t.id||-1,error:this._errorFromCode(r,n&&n.message||n,t&&t.method)})}catch(n){}}_errorFromCode(e,t,r){let n="";switch(e){case-32603:n=`InternalError: Internal Error when calling '${r}'`;break;case-32601:n=`MethodNotFound: '${r}' wasn't found`;break;case-32600:n="InvalidRequest: JSON sent is not a valid request object";break;case-32700:n="ParseError: invalid JSON received"}return{code:e,message:n,data:t}}expose(e,t){this._exposedMethodsMap.set(e,t)}notify(e,t){if(!this._socketServer.clients)throw new Error('SocketServer does not support broadcasting. No "clients: LikeSocket[]" property found');for(let r of this._socketServer.clients)this._send(r,{method:e,params:t})}api(e){if(!Proxy)throw new Error("api() requires ES6 Proxy. Please use an ES6 compatible engine");return new Proxy({},{get:(t,r)=>{if(t[r])return t[r];if("__proto__"===r||"prototype"===r)return Object.prototype;if(void 0===e)t[r]=this.api(r+".");else if("on"===r)t[r]=(t,r)=>this.on(`${e}${t}`,r);else if("emit"===r)t[r]=(t,r)=>this.notify(`${e}${t}`,r);else if("on"===r.substr(0,2)&&r.length>3){const n=r[2].toLowerCase()+r.substr(3);t[r]=t=>this.on(`${e}${n}`,t)}else if("emit"===r.substr(0,4)&&r.length>5){const n=r[4].toLowerCase()+r.substr(5);t[r]=t=>this.notify(`${e}${n}`,t)}else{if("expose"!==r)return;t[r]=t=>{if(!t||"object"!=typeof t)throw new Error("Expected an iterable object to expose functions");for(let r in t)"function"==typeof t[r]&&this.expose(`${e}${r}`,t[r].bind(t))}}return t[r]}})}}t.Server=s}));class $r extends i.EventEmitter{constructor(){super(),this._port=void 0,this._host=void 0,this._ws=void 0}async connect(e,t){this._port=e,this._host=t;const r=await this._discoverWebsocketPath();this._ws=new Ur(r);const n=new Br.Client(this._ws,{logConsole:!1}).api();var s;n.Runtime.enable(),await(s=100,new Promise((e,t)=>{setTimeout(()=>{e()},s)})),this._api=n,this._api.Runtime.on("consoleAPICalled",e=>{this.emit("consoleAPICalled",e)}),this._api.Runtime.on("exceptionThrown",e=>{this.emit("exceptionThrown",e)}),this._api.Runtime.on("executionContextDestroyed",e=>{this.emit("executionContextDestroyed",e)})}async disconnect(){this._ws.close(),this.status="disconnect"}api(){return this._api}async generateObjectStr(e,t=20){let r="{",n=!0;for(let s=0;s<e.length;s++){const i=e[s];if(!i.enumerable)continue;n=!1;const{type:o,subtype:a,description:c,objectId:l,value:u}=i.value,d=a||o;let h=void 0!==u?u:c;switch(d){case"object":case"array":h=await this.getObject(l,d,t-1),h||(h='"<层级过深，无法展示内容>"');break;case"date":h=`new Date("${h}")`}r+=`"${i.name}"`,r+=":",r+="string"===d?JSON.stringify(h):h,r+=","}return n||(r=r.slice(0,-1)),r+="}",r}async generateArrayStr(e,t=20){let r="[",n=!0;for(let s=0;s<e.length;s++){const i=e[s];if(!i.enumerable)continue;n=!1;const{type:o,subtype:a,description:c,objectId:l,value:u}=i.value,d=a||o;let h=void 0!==u?u:c;switch(d){case"object":case"array":h=await this.getObject(l,d,t-1),h||(h='"<层级过深，无法展示内容>"');break;case"date":h=`new Date("${h}")`}r+="string"===d?JSON.stringify(h):h,r+=","}return n||(r=r.slice(0,-1)),r+="]",r}async getObject(e,t,r=20){if(r<0)return!1;const n=await this.api().Runtime.getProperties({objectId:e,ownProperties:!0});switch(t){case"object":return this.generateObjectStr(n.result,r);case"array":return this.generateArrayStr(n.result,r)}}_discoverWebsocketPath(){return this._fetchJSON("/json").then(([{webSocketDebuggerUrl:e}])=>e)}_fetchJSON(e){return new Promise((t,r)=>{const n=w.default.get({host:this._host,port:this._port,path:e}),s=[];n.on("error",r),n.on("response",(function(e){e.on("error",r),e.on("data",e=>s.push(e)),e.on("end",(function(){const n=Buffer.concat(s).toString();if(200===e.statusCode)try{t(JSON.parse(n))}catch(e){r(new Error("Response didn't contain JSON: "+n))}else r(new Error(`Unexpected ${e.statusCode}: ${n}`))}))}))})}}const Wr=/^((?:[A-Za-z]:)?(?:[\\/][^/:?#]+)+)(?::(\d+))?(?::(\d+))?$/;function qr(e){const t=[],r=e.length;let n=0,s="",i=n;for(;n<=r;){const r=e.charAt(n);if(r&&-1===" \t()<>[]'\"、。｡､，．：；‘“〈《「『【〔（［｛｢｣｝］）〕】』」》〉”’｀～…".indexOf(r))s+=r;else{if(s){const e=s.match(Wr),r=n;if(e){const{1:n,2:s,3:o}=e;t.push({linkPosition:{start:i,end:r},onOpen:function(){U.workspace.openTextDocument(n).then(e=>{U.window.showTextDocument(e,{selection:{start:{line:Number(s),character:Number(o)-1}}})})}})}}s="",i=n+1}n++}return{text:e,hyperlinks:t}}const Gr=[/\[INSPECTOR_ASYNC_STACK_TRACES_NOT_AVAILABLE\]/];class Vr extends i.EventEmitter{constructor({title:e,id:t,workspaceFolder:r,provider:n,name:s,uniCloudInfo:i}){super(),this.workspaceFolder=r,this.title=e,this.id=t,this.provider=n,this.name=s,this.uniCloudInfo=i,this._outputView=null,this._show=!1,this.updateProvider(this.provider),this._init()}updateProvider(e){this.provider=e;const t=this.uniCloudInfo.find(t=>t.provider===e);this.spaceName=t&&t.name;const r="aliyun"===this.provider?"阿里云":"腾讯云";this.outputPrefix=1===this.uniCloudInfo.length?"[本地调试]":`[本地云函数调试:${r}:${this.spaceName}]`,this.outputPrefixLength=this.outputPrefix.length}appendMultiline({level:e="info",lastFrame:t,lines:r}){for(let n=0;n<r.length;n++){const s=r[n];let i=s.text;const o=s.hyperlinks||[];if(n===r.length-1&&t){const e=t.lineNumber+1,r=t.columnNumber,n=`${t.relativeUrl}:${e}:${r}`;o.push({linkPosition:{start:i.length+1,end:i.length+1+n.length},onOpen:async function(){U.workspace.openTextDocument(t.url).then(t=>{U.window.showTextDocument(t,{selection:{start:{line:e,character:r}}})})}}),i=i+" "+n}this.appendLine({level:e,line:i,hyperlinks:o})}}appendConsole({level:e="info",lastFrame:t,lines:r,multiline:n}){this.show();let s="",i=[];if(n)this.appendMultiline({level:e,lastFrame:t,lines:r});else{for(let e=0;e<r.length;e++){const t=r[e],n=s.length;s+=t.text+" ",t.hyperlinks&&(i=i.concat(t.hyperlinks.map(e=>(e.linkPosition.start+=n,e.linkPosition.end+=n,e))))}if(t){const e=s.length,r=t.lineNumber+1,n=t.columnNumber,o=`${t.relativeUrl}:${r}:${n}`;i.push({linkPosition:{start:e,end:e+o.length},onOpen:async function(){U.workspace.openTextDocument(t.url).then(e=>{U.window.showTextDocument(e,{selection:{start:{line:r,character:n}}})})}}),s+=o}this.appendLine({level:e,line:s,hyperlinks:i})}}appendPossibleHyperLink({line:e,hyperlinks:t=[]}={}){const{hyperlinks:r}=qr(e);return r.filter(({linkPosition:e}={})=>!t.some(({linkPosition:t}={})=>e.start<=t.end&&e.end>=t.start))}appendLine(e){Gr.some(t=>t.test(e.line))||(this._show||!1===e.forceshow||this.show(),e.line=this.outputPrefix+e.line,e.hyperlinks=e.hyperlinks||[],e.hyperlinks.forEach(e=>{e.linkPosition.start=e.linkPosition.start+this.outputPrefixLength,e.linkPosition.end=e.linkPosition.end+this.outputPrefixLength}),e.hyperlinks.push(...this.appendPossibleHyperLink({line:e.line,hyperlinks:e.hyperlinks})),this._outputView.appendLine(e))}show(){!this._show&&this._outputView&&(this._outputView.show(),this._show=!0)}_init(){this._outputView=U.window.createOutputView({id:this.id,title:this.title})}disconnect(){}}function Jr(e){let t="{";const r=e.properties.length>10,n=Math.min(e.properties.length,10);for(let r=0;r<n;r++){const n=e.properties[r],s=n.value;t+=`"${n.name}"`,t+=":",t+="string"===n.type?JSON.stringify(s):s,t+=","}return r?t+="...":n&&(t=t.slice(0,-1)),t+="}",t}function Hr(e){let t="[";const r=e.properties.length>10,n=Math.min(e.properties.length,10);for(let r=0;r<n;r++){const n=e.properties[r],s=n.value;t+="string"===n.type?JSON.stringify(s):s,t+=","}return r?t+="...":n&&(t=t.slice(0,-1)),t+="]",t}const Yr={plainParser:e=>({text:Jr(e.preview),objectId:e.objectId,objectType:"object"}),typedarrayParser:e=>({text:Hr(e.preview)}),arrayParser:e=>({text:Hr(e.preview),objectId:e.objectId,objectType:"array"}),nullParser:()=>({text:"null"}),errorParser:e=>({multiline:!0,text:e.description}),defaultParser:e=>({text:e.description})},zr={objectParser:e=>{if(!e.subtype)return Yr.plainParser(e);let t=e.subtype+"Parser";return Yr[t]||(t="defaultParser"),Yr[t](e)},undefinedParser:()=>({text:"undefined"}),stringParser:e=>({text:JSON.stringify(e.value)}),defaultParser:e=>({text:void 0!==e.value?e.value+"":e.description})};function Kr(e){return e=e.replace(/\\/g,"/").replace("win32"===process.platform?"file:///":"file://",""),e=decodeURIComponent(e)}class Qr extends i.EventEmitter{parseConsole(e){const{type:t,args:r,stackTrace:n,timestamp:s}=e,i=function(e){return e.map(e=>{let t=e.type?e.type+"Parser":"defaultParser";return zr[t]||(t="defaultParser"),zr[t](e)})}(r),o={error:"error",warn:"warning"}[t]||"info";let a;const c=le(this.workspaceFolder),l=le(_.default.resolve(__dirname,"../"));if(n&&n.callFrames){if(a=n.callFrames.find(e=>c.test(Kr(e.url))),!a){const e=n.callFrames[0];l.test(Kr(e.url))||(a=e)}a&&(a.url=Kr(a.url),a.relativeUrl=a.url.replace(c,""))}return{level:o,parsedArgs:i,multiline:i.some(e=>e.multiline),lastFrame:a,timestamp:s}}parseUncaughtException({exceptionDetails:e,timestamp:t}={}){return this.parseConsole({type:"error",args:e.exception,stackTrace:e.stackTrace,timestamp:t})}parseText(e){const t=this.inspector;let r=[];for(let n=0;n<e.length;n++){const s=e[n];if(s.objectId&&s.objectType){s.hyperlinks=[{linkPosition:{start:0,end:s.text.length},onOpen:async function(){if("disconnect"===t.status)U.workspace.openTextDocument({content:"调试已结束，无法再进行变量预览",language:"txt"});else{const e=await t.getObject(s.objectId,s.objectType);U.workspace.openTextDocument({content:e,language:"javascript"})}}}],r.push(s);continue}const i=s.text.replace(/\r\n/g,"\n").split("\n").map(e=>qr(e));r=r.concat(i)}return r}async parseTextAsync(e){const t=this.inspector;let r=[];for(let n=0;n<e.length;n++){const s=e[n];if(s.objectId&&s.objectType){const e=await t.getObject(s.objectId,s.objectType);s.hyperlinks=[{linkPosition:{start:0,end:s.text.length},onOpen:async function(){U.workspace.openTextDocument({content:e,language:"javascript"})}}],r.push(s);continue}const i=s.text.replace(/\r\n/g,"\n").split("\n").map(e=>qr(e));r=r.concat(i)}return r}}class Xr extends Qr{constructor({workspaceFolder:e,workspaceId:t,name:r,clientInfo:n,uniCloudInfo:s,runMode:i="run"}){super(),this.workspaceFolder=e,this.workspaceId=t,this.clientInfo={},this.name=r,this.runMode=i,this.addClient(n),this.uniCloudInfo=s;const o=this.getLaunchConfig(),a=o&&o.provider;if(this.uniCloudConfig=o,a){if(!this.uniCloudInfo.find(e=>e.provider===a))throw new I({code:"SYSTEM_ERROR",message:"launch.json内配置的provider在本项目中不可用"});this.provider=a}else switch(s.length){case 0:throw new I({code:"SYSTEM_ERROR",message:"项目未绑定uniCloud服务空间，uniCloud本地调试服务未启动，请绑定后重试"});case 1:this.provider=s[0].provider;break;case 2:throw new I({code:"SYSTEM_ERROR",message:"项目绑定了多个服务空间，请在项目目录下的.hbuilderx/launch.json内配置provider指定本地调试使用的服务空间"});default:throw new I({code:"SYSTEM_ERROR",message:"获取项目uniCloud配置出错"})}this.realWorkspace=se.getRealWorkspace({uniCloudInfo:this.uniCloudInfo,workspaceFolder:this.workspaceFolder,provider:this.provider}),this.status="ready",this.outputChannelTitle=`[${this.name}] - uniCloud控制台`,this.outputChannelId=this.workspaceId+"-unicloud"}async getSecret({provider:e}){const t=this.uniCloudInfo.find(t=>t.provider===e),{spaceId:r,appId:n}=t;return fe({provider:e,spaceId:r,appId:n,useCache:!0})}notify({level:e="info",info:t,forceshow:r}){this.outputChannel.appendLine({level:e,line:t,forceshow:r})}getLaunchConfig(){const e=_.default.resolve(this.workspaceFolder,".hbuilderx/launch.json");if(g.default.existsSync(e))try{const t=function(e){const t=g.default.readFileSync(e).toString().replace("\r\n","\n").replace("\r","\n");return A(t)}(e);return(t.configurations||[]).find(e=>"uniCloud"===e.type)}catch(e){throw new I({code:"SYSTEM_ERROR",message:"项目目录下.hbuilderx/launch.json格式不正确，请检查"})}}async checkCloudFunction({provider:e}={}){const t=se.getEncryptedFunctionList(this.realWorkspace,e).map(e=>e.name);if(!t.length)return;const r=this.uniCloudInfo.find(t=>t.provider===e),{appId:n,spaceId:s}=r,i=await async function({provider:e,appId:t,spaceId:r}={}){const{functions:n}=await ue({path:"/serverless/function/list",body:{provider:e,spaceId:r,appid:t,page:1,pageSize:200}});return n}({provider:e,appId:n,spaceId:s}),o=t.filter(e=>!i.includes(e));o.length&&(this.notify({level:"warning",info:"检测到以下加密云函数未上传到云端，可能会影响云函数调试、运行，请检查是否已执行了项目初始化（uniCloud目录右键选择“运行云服务空间初始化向导”）"}),this.notify({level:"warning",info:"未上传的加密云函数列表如下："+o.join("、")}))}async checkDatabase({provider:e}={}){const t=se.getCollectionListFromAllDbInit(this.workspaceFolder,e);if(!t.length)return;const r=this.uniCloudInfo.find(t=>t.provider===e),{appId:n,spaceId:s}=r,i=await async function({provider:e,appId:t,spaceId:r}={}){const{collections:n}=await ue({path:"/serverless/database/collections",body:{provider:e,spaceId:r,appid:t,page:1,pageSize:200}});return(n||[]).map(e=>e.name)}({provider:e,appId:n,spaceId:s}),o=t.filter(e=>!i.includes(e));o.length&&(this.notify({level:"warning",info:"检测到以下数据表未在云端创建，可能会影响云函数调试、运行，请检查是否已执行了项目初始化（uniCloud目录右键选择“运行云服务空间初始化向导”）"}),this.notify({level:"warning",info:"未创建的数据表列表如下："+o.join("、")}))}async checkDependency({provider:e}={}){const t=this.realWorkspace,r=await _e(),n=se.getCloudfunctionPathList(t,e);for(let e=0;e<n.length;e++){const t=n[e],s=se.getFunctionPathList(t),i=await ge(s,{npmCmd:r}),o=se.getCommonModulePathList(t),a=await ve(o,{npmCmd:r}),c=i.concat(a).filter(e=>"local"!==e.type);if(0===c.length)continue;this.notify({level:"warning",info:"检测到以下本地云函数/公共模块缺失依赖，可能影响本地云函数调试、运行，正在进行安装..."});const l=c.map(({dir:e,functionPath:t,commonModulePath:r})=>{const n=e.replace(/\\/g,"/").split("/").pop();return r?"common/"+n:n});this.notify({level:"info",info:"缺少依赖的本地云函数/公共模块："+l.join("、")});for(let e=0;e<c.length;e++){const t=c[e],n=t.dir,s=n.replace(/\\/g,"/").split("/").pop(),i=t.commonModulePath?"公共模块":"云函数";try{"local"!==t.type&&this.notify({level:"info",info:`${i}${s}开始安装依赖`}),await ye(n,{npmCmd:r}),"local"!==t.type&&this.notify({level:"info",info:`${i}${s}依赖安装完成`})}catch(e){const r=_.default.resolve(n,"node_modules");g.default.existsSync(r)&&this.notify({level:"warning",info:`文件夹(${n})中存在node_modules，且其中依赖缺失，如果出现依赖安装失败的错误请手动删除此node_modules再试`});("local"!==t.type?`${i}${s}依赖安装失败\n${e.message}`:`${i}${s}引入公共模块失败\n${e.message}`).split("\n").forEach(e=>{this.notify({level:"error",info:e})})}}}}async pollSecret({provider:e,retry:t=0}){let r,n;try{const t=await this.getSecret({provider:e});r=t.uniCloudSecret,n=t.restTime}catch(e){return this.notify({level:"error",info:e.message||"获取本地运行参数失败，请检查网络是否正常"}),{}}return{uniCloudSecret:r,restTime:n}}async syncSecret({provider:e}){const{uniCloudSecret:t,restTime:r}=await this.pollSecret({provider:e}),n=Date.now()+1e3*Number(r);if(!t)throw new I({code:"REQUEST_ERROR",message:"获取本地运行参数失败"});return{uniCloudSecret:t,expired:n,provider:e}}initBridge(e){this._jsonRpcServer=new se.JsonRpcServer({bridgeProcess:e}),this._jsonRpcServer.expose("syncSecret",({provider:e}={})=>this.syncSecret({provider:e}))}async startServer(){const e=s.fork("../server/index.js",{execArgv:(this.runMode,["--inspect=0"]),cwd:__dirname,silent:!0,env:{WORKSPACE_FOLDER:this.workspaceFolder,UNICLOUD_INFO:JSON.stringify(this.uniCloudInfo),SPACE_PROVIDER:this.provider,UNICLOUD_DEBUGGER_PATH:process.env.UNICLOUD_DEBUGGER_PATH,UNICLOUD_PLUGIN_PID:process.pid}});this.initBridge(e);const{Transform:t}=require("stream"),r=new t({transform:function(e,t,r){r()}});e.stdout.pipe(r),this.serverProcess=e;const n=this;return new Promise((t,r)=>{e.on("message",(function s(i){if("object"==typeof i)switch(i.action){case"server/start":{const{address:r,servePort:o,debugPort:a}=i.data;n.address=r,n.servePort=o,n.debugPort=a,n.status="start",e.removeListener("message",s),t();break}case"server/error":{const{code:t,message:n,detail:o}=i.data;if(e.removeListener("message",s),"EADDRINUSE"===t)return void r(new I({code:"EADDRINUSE",message:`指定端口（${o.servePort}）冲突，请重新指定或者直接去除此项配置`}));r(new I({code:t,message:n}));break}}})),setTimeout(()=>{r(new I({code:"SERVER_START_TIMEOUT",message:"本地调试服务启动超时"}))},5e3)})}updateProvider(e){this.provider=e,this.outputChannel.updateProvider(e)}getPlatformLaunchType(e,t){return e&&e[t]&&e[t].launchtype||e&&e.default&&e.default.launchtype||"remote"}checkConfig(){let e;try{e=this.getLaunchConfig()}catch(e){}const t=e&&e.provider;if(t&&t!==this.provider){const e={tcb:"腾讯云",aliyun:"阿里云"},r=this.uniCloudInfo.find(e=>e.provider===t);if(!r)return void this.notify({level:"error",info:".hbuilderx/launch.json内配置的provider在本项目下不可用"});this.updateProvider(t),this.notify({level:"warning",info:`当前uniCloud本地调试服务使用的服务空间将切换为:[${e[t]}:${r.name}]`})}const r=this.uniCloudConfig,n=this.uniCloudInfo.find(e=>e.provider===this.provider);["h5","app-plus","mp-weixin","mp-baidu","mp-alipay","mp-toutiao","mp-qq","mp-360","mp-kuaishou","mp-lark","quickapp-native","quickapp-webview"].forEach(t=>{const s=this.getPlatformLaunchType(e,t),i=this.getPlatformLaunchType(r,t);if(s!==i){const e=Object.keys(this.clientInfo).filter(e=>this.clientInfo[e].type===t);e.length&&e.forEach(e=>{this.clientInfo[e]&&this.clientInfo[e].outputView.appendLine({level:"warning",line:"local"===s?"已连接本地云函数环境。注意事项详见：https://uniapp.dcloud.net.cn/uniCloud/quickstart?id=calllocalfunction":"已连接云端云函数环境，服务空间id为"+n.spaceId})})}}),this.uniCloudConfig=e}watchLaunchJson(){const e=_.default.resolve(this.workspaceFolder,".hbuilderx/launch.json");return g.default.watch(e,{},()=>{this.checkProviderTimeout&&clearTimeout(this.checkProviderTimeout),this.checkProviderTimeout=setTimeout(()=>{this.checkConfig(),this.checkProviderTimeout=null},300)})}async start(){this.outputChannel=new Vr({title:this.outputChannelTitle,id:this.outputChannelId,workspaceFolder:this.workspaceFolder,provider:this.provider,name:this.name,uniCloudInfo:this.uniCloudInfo});for(let e=0;e<this.uniCloudInfo.length;e++){const t=this.uniCloudInfo[e].provider;this.checkDependency({provider:t}),this.checkCloudFunction({provider:t}),this.checkDatabase({provider:t})}await this.startServer(),this.launchJsonWatcher=this.watchLaunchJson();const e=new $r;this.inspector=e,await e.connect(this.debugPort,"localhost"),e.on("consoleAPICalled",e=>{const t=this.parseConsole(e);t.lines=this.parseText(t.parsedArgs),this.outputChannel.appendConsole(t)}),e.on("exceptionThrown",e=>{const t=this.parseUncaughtException(e);t.lines=this.parseText(t.parsedArgs),this.outputChannel.appendConsole(t)}),this.notify({level:"warning",info:"uniCloud本地调试服务已启动，如需客户端调用本地云函数，请在对应的客户端的运行控制台切换为连接本地云函数",forceshow:!0}),this.notify({level:"error",info:"如需调试本地云函数代码，请点击控制台右上角的调试按钮开启断点调试服务（双击行号添加断点）\n",forceshow:!0})}stop(){this.launchJsonWatcher.close(),this.inspector.disconnect(),this.serverProcess.removeAllListeners(),this.serverProcess.kill(),this.outputChannel.disconnect(),this.status="stop"}addClient(e){this.clientInfo[e.clientConsole._id]=e}deleteClient(e){delete this.clientInfo[e.clientConsole._id],0===Object.keys(this.clientInfo).length&&(this.notify({level:"warning",info:"所有客户端均已停止，uniCloud调试结束",forceshow:!1}),this.stop())}toEnv({platform:e}){const{address:t,servePort:r,debugPort:n}=this;return{address:t,servePort:r,debugPort:n,initialLaunchType:this.getPlatformLaunchType(this.uniCloudConfig,e)}}}let Zr;class en extends Vr{updateProvider(e){this.provider=e;const t=this.uniCloudInfo.find(t=>t.provider===e);this.spaceName=t&&t.name;const r="aliyun"===this.provider?"阿里云":"腾讯云";this.outputPrefix=1===this.uniCloudInfo.length?"[本地运行]":`[本地运行:${r}:${this.spaceName}]`,this.outputPrefixLength=this.outputPrefix.length}_init(){this._outputView=U.window.createOutputView({id:this.id,title:this.title})}disconnect(){}}class tn extends Qr{constructor({workspaceFolder:e,workspaceId:t,name:r,uniCloudInfo:n,provider:s,port:i,isHxDebugMode:o}){super(),this.workspaceFolder=e,this.workspaceId=t,this.name=r,this.uniCloudInfo=n,this.provider=s,this.debugPort=i,this.isHxDebugMode=o,this.outputChannelTitle=`[${this.name}] - uniCloud控制台`,this.outputChannelId=this.workspaceId+"-unicloud"}async start(){this.outputChannel=new en({title:this.outputChannelTitle,id:this.outputChannelId,workspaceFolder:this.workspaceFolder,provider:this.provider,name:this.name,uniCloudInfo:this.uniCloudInfo});const e=new $r;this.inspector=e,await e.connect(this.debugPort,"localhost"),e.on("consoleAPICalled",async e=>{const t=this.parseConsole(e);t.lines=await this.parseTextAsync(t.parsedArgs),this.outputChannel.appendConsole(t)}),e.on("exceptionThrown",async e=>{const t=this.parseUncaughtException(e);t.lines=await this.parseTextAsync(t.parsedArgs),this.outputChannel.appendConsole(t)}),e.on("executionContextDestroyed",()=>{setTimeout(()=>{this.stop(),this.emit("stop")},300)}),this.isHxDebugMode||e.api().Runtime.runIfWaitingForDebugger()}async stop(){this.inspector.disconnect(),this.outputChannel.disconnect(),this.status="stop"}}const rn=new class{constructor(){this.runnerList=[]}async startRunner({workspaceFolder:e,workspaceId:t,name:r,uniCloudInfo:n,provider:s,port:i,isHxDebugMode:o}){const a=new tn({workspaceFolder:e,workspaceId:t,name:r,uniCloudInfo:n,provider:s,port:i,isHxDebugMode:o});await a.start(),this.runnerList.push(a),a.on("stop",()=>{const e=this.runnerList.indexOf(a);e>-1&&this.runnerList.splice(e,1)})}};const nn=new Map;async function sn({provider:e,spaceId:t,appId:r,jqlPath:n,jqlContent:i,workspaceFolder:o,uuid:a,useCloudSchema:c=!1}={}){let l;try{l=await fe({provider:e,spaceId:t,appId:r,useCache:!0})}catch(e){return{code:e.code||"NETWORK_ERROR",message:e.message}}const{uniCloudSecret:u}=l,d=s.fork(`../${e}/index.js`,["jql-runner",_.default.resolve(__dirname,"../internal-functions"),JSON.stringify({jqlPath:n,jqlContent:i})],{silent:!0,cwd:__dirname,env:{UNICLOUD_DEBUGGER_PATH:process.env.UNICLOUD_DEBUGGER_PATH,UNICLOUD_INFO:JSON.stringify([]),SPACE_PROVIDER:e,WORKSPACE_FOLDER:o,UNICLOUD_SECRET:JSON.stringify(u),CALL_BY:"jql-runner",USE_CLOUD_SCHEMA:c?"true":"false"}}),h=new se.JsonRpcServer({bridgeProcess:d});return h.expose("getSchema",({name:n}={})=>async function({provider:e,appId:t,spaceId:r,name:n}={}){const{list:s}=await ue({path:"/serverless/clientdb/schema-list",body:{provider:e,spaceId:r,appid:t,name:n}}),i={};for(let e=0;e<s.length;e++){const t=s[e];i[t.name]=t.content}return i}({provider:e,spaceId:t,appId:r,name:n})),h.expose("getValidateFunction",({name:n}={})=>async function({provider:e,appId:t,spaceId:r,name:n}={}){const{list:s}=await ue({path:"/serverless/clientdb/validator-list",body:{provider:e,spaceId:r,appid:t,name:n}}),i={};for(let e=0;e<s.length;e++){const t=s[e];i[t.name]=t.content}return i}({provider:e,spaceId:t,appId:r,name:n})),nn.set(a,d),new Promise((e,t)=>{d.on("message",t=>{if("ExecuteResult"===t.type){nn.delete(a);const r={...t.result,message:on(t.result),fullRes:{result:t.result}};e(r)}})})}function on(e){if(e.message)return e.message;const{data:t,total:r,count:n,updated:s,deleted:i,inserted:o,ids:a,id:c,timeCost:l}=e;let u="";return void 0!==t?(u+=`查询到${t.length}条数据`,void 0!==n&&(u+=`，满足条件的数据总数为${n}条`),500!==t.length&&1e3!==t.length||(u+='，查询数量限制请参考：<a href="https://uniapp.dcloud.net.cn/uniCloud/cf-database?id=limit" target="_blank">https://uniapp.dcloud.net.cn/uniCloud/cf-database?id=limit</a>')):void 0!==o?u+=`批量插入成功，插入条数：${o}，插入数据的id列表为：${a.join(",")}`:void 0!==i?u+="删除完成，删除条数："+i:void 0!==s?u+="更新完成，更新条数："+s:void 0!==r?u+="计数完成，总条数："+r:void 0!==c&&(u+="插入成功，id为"+c),u+=`，本次请求耗时（包含网络传输时间）：${l}ms`,u}const an=new class{constructor(){if(Zr)return Zr;this.serverMap=new Map,Zr=this}parseSession(e){const t=ce(e.workspaceFolder),r=e.workspaceFolder.id,n=e.type,s=e.console,i={};i.type={Develop:"app-plus",Develop_WX:"mp-weixin",Previou_Develop_Uniapp:"h5",Develop_Baidu:"mp-baidu",Develop_Alipay:"mp-alipay",Develop_Bytedance:"mp-toutiao",Develop_QQ:"mp-qq",Develop_360:"mp-360"}[n]||n,i.clientConsole=s,i.outputView=U.window.createOutputView({id:s._id,title:s._title});return{workspaceFolder:t,workspaceId:r,name:e.workspaceFolder.name,clientInfo:i,uniCloudInfo:e.configuration&&e.configuration.spaces?e.configuration.spaces.map(e=>(e.clientSecret?e.provider="aliyun":e.provider="tcb",e.spaceId=e.id,e)):[],runMode:e.runMode||"run"}}async startServer(e){const{workspaceFolder:t,workspaceId:r,name:n,clientInfo:s,uniCloudInfo:i,runMode:o}=this.parseSession(e);if(ae("收到启动服务请求，参数："+JSON.stringify({workspaceFolder:t,workspaceId:r,name:n,uniCloudInfo:i,runMode:o})),!i||0===i.length)return;if(this.serverMap.has(t)){const e=this.serverMap.get(t);return ae("服务已启动，重用现有服务。服务信息："+JSON.stringify(e.toEnv({platform:s.type}))),e.addClient(s),e.toEnv({platform:s.type})}for(let e=0;e<i.length;e++){const r=i[e],n=r.provider,s=se.getRealWorkspace({workspaceFolder:t,uniCloudInfo:i,provider:n}),o=se.getAppid(s);if(!o)throw new I({code:"APPID_MISSING",message:s===t?"manifest.json内未配置AppId，请重新获取后再试":`项目(${s})下manifest.json内未配置AppId，请重新获取后再试`});r.appId=o}const a={workspaceFolder:t,workspaceId:r,name:n,clientInfo:s,uniCloudInfo:i,runMode:o};ae("准备启动服务，参数："+JSON.stringify(a));const c=new Xr(a);await c.start(),this.serverMap.set(t,c),ae("服务已启动，服务信息："+JSON.stringify(c.toEnv({platform:s.type})));return{...c.toEnv({platform:s.type}),skipFiles:pe()}}killAllServer(){this.serverMap.forEach(e=>{"stop"!==e.status&&e.stop()}),this.serverMap.clear()}killServer(e){if(!this.serverMap.has(e))return;this.serverMap.get(e).stop(),this.serverMap.delete(e)}async stopServer(e){const{workspaceFolder:t,clientInfo:r}=this.parseSession(e);if(!this.serverMap.has(t))return{code:"NO_SUCH_SERVER",message:"no such server"};const n=this.serverMap.get(t);return n.deleteClient(r),"stop"===n.status&&this.serverMap.delete(t),{code:0,serverStatus:n.status}}};exports.activate=function(e){const t=m.default.commands.registerCommand("extension.stopDebugServer",async()=>(an.killAllServer(),{}));return e.subscriptions.push(t),{async startDebugging(e){try{return await an.startServer(e)}catch(e){ae("服务启动时捕获到错误："+(e&&e.stack)),m.default.window.showErrorMessage("uniCloud本地调试服务启动失败，错误信息为："+e.message+"<br/>请按照上述错误信息调整后重新运行uni-app项目")}},stopDebugging:async e=>await an.stopServer(e),async runJQL(e){let t;ae("开始JQL查询："+JSON.stringify(e));try{t=await sn(e)}catch(e){t={code:e.code||"INTERNAL_ERROR",message:e.message,detail:e.stack}}return t},stopJQL:async e=>(ae("停止JQL查询："+JSON.stringify(e)),async function({uuid:e}){if(!nn.has(e))return;nn.get(e).kill("SIGKILL"),nn.delete(e)}(e)),async customRequest({method:e,params:t}={}){switch(e){case"spaceChanged":{const e=ce(t&&t.workspaceFolder);if(!an.serverMap.has(e))return{code:0};return an.serverMap.get(e).notify({level:"warning",info:"服务空间已改变，对本项目的本地调试服务自动关闭。请停止本项目所有正在运行的客户端后重新运行"}),an.killServer(e),{code:0}}case"localDebugLog":return ae("开始本地运行："+JSON.stringify(t)),await async function({funurl:e,port:t,projectid:r,provider:n,root:s,spacename:i,debugMode:o=!1}){e=e.replace(/\\/g,"/");const a=r,c=se.getWorkspacePathFromFilePath(e),l=[{provider:n,name:i}],u=c.split("/").pop();await rn.startRunner({workspaceFolder:c,workspaceId:a,name:u,uniCloudInfo:l,provider:n,port:t,isHxDebugMode:o})}(t),{code:0,skipFiles:pe()}}}}},exports.deactivate=function(){an.killAllServer()};

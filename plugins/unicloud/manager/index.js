"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("path"),t=require("hbuilderx"),n=require("async_hooks"),i=require("events"),o=require("fs"),r=require("child_process"),s=require("os"),a=require("vm"),c=require("zlib"),l=require("crypto"),u=require("vscode"),d=require("constants"),p=require("stream"),f=require("util"),h=require("assert"),m=require("url"),g=require("https"),y=require("querystring"),v=require("cos-nodejs-sdk-v5"),w=require("http"),x=require("net"),b=require("tls");function S(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function k(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var i=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,i.get?i:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var E=S(e),_=k(e),C=S(t),I=S(n),j=S(i),O=S(o),P=k(o),L=k(r),N=S(r),F=S(s),T=S(a),D=S(c),$=S(l),R=S(u),A=k(u),B=S(d),M=S(p),U=S(f),q=S(h),W=S(m),J=k(m),H=S(g),V=S(y),z=S(v),G=S(w),K=S(x),Z=S(b);function Y(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((i=i.apply(e,t||[])).next())}))}function X(e,t,n,i){var o,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(r<3?o(s):r>3?o(t,n,s):o(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s}function Q(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((i=i.apply(e,t||[])).next())}))}"darwin"===process.platform&&(process.env.PATH=["./node_modules/.bin","/.nodebrew/current/bin","/usr/local/bin",process.env.PATH].join(":")),process.env.UNICLOUD_DEBUGGER_PATH=E.default.resolve(__dirname,"../");class ee extends Error{constructor(e){const{message:t,code:n}=e||{};super(t),this.code=n}}function te(e){return Q(this,void 0,void 0,(function*(){return function(e){!function(e){if(e.error)throw new ee({message:`请求服务失败：${JSON.stringify(e.error)}${e.data?"\n"+e.data:e.data}`,code:"REQUEST_ERROR"});if(e.httpStatusCode>=400)throw new ee({message:`网络请求错误，状态码：${e.httpStatusCode}${e.data?"\n"+e.data:e.data}`,code:e.httpStatusCode})}(e);const t=JSON.parse(e.data),n=t.header&&t.header.result,i=n&&n.rspcode,o=n&&n.rspdesc;if("1001"!==i)throw new ee({code:"REQUEST_ERROR",message:`请求DCloud服务失败：错误码为：${i}，详细错误信息为：${o}`});return t.body}(yield function(e){return Q(this,void 0,void 0,(function*(){return C.default.http.request(Object.assign(Object.assign({},e),{dataType:void 0}))}))}({url:`https://ide.liuyingyong.cn${e.path}`,method:e.method,dataType:e.dataType,params:{param:JSON.stringify({header:{token:"${user.checked.token}"},body:e.body})}}))}))}const ne=Symbol("CONTEXT_STORAGE");function ie(){const e=(global[ne]||(global[ne]=new n.AsyncLocalStorage),global[ne]).getStore();if(!e)throw new Error("context is not exist");return e}function oe(){var e;return null===(e=ie())||void 0===e?void 0:e.outputView}const re=new i.EventEmitter;function se(e){return function(t,n){Object.defineProperty(t,n,{get:function(){return new e(this)}})}}function ae(){return function(e,t){Object.defineProperty(e,t,{get:function(){return ie()}})}}class ce{constructor(e){this.workspaceFolder=e.workspaceFolder,this.triggerType=e.triggerType,this.cliConsoleConfig=e.cliConsoleConfig,this.isCli="cliCommand"===this.triggerType,this.console=this.createLog()}createLog(){return this.isCli?C.default.cliconsole:this.workspaceFolder?C.default.window.createOutputView({id:`${this.workspaceFolder.id}-unicloud`,title:`[${this.workspaceFolder.name}] - unicloud控制台`}):C.default.window.createOutputChannel("unicloud")}appendLine(e){return Q(this,void 0,void 0,(function*(){const{line:t,status:n="info"}=e;this.isCli?yield this.console.log({clientId:this.cliConsoleConfig.clientId,msg:t,status:n,hideTime:!0}):yield this.console.appendLine(e)}))}show(){var e,t;null===(t=null===(e=this.console)||void 0===e?void 0:e.show)||void 0===t||t.call(e)}}X([ae()],class{isDebug(){return O.default.existsSync(E.default.resolve(__dirname,"dcloud.debug"))}resolve(e){return Q(this,void 0,void 0,(function*(){const{_params:t,_triggerType:n}=this.context,{workspaceFolder:i,fsPath:o,cliconsole:r}=t,s=Boolean("cliCommand"===n||(null==r?void 0:r.clientId));if(this.context.isDebug=this.isDebug(),this.context.isCli=s,this.context.workspaceFolder=i,this.context.fsPath=o,this.context.outputView=new ce({workspaceFolder:i,triggerType:n,cliConsoleConfig:r}),yield e(),this.context._return)return this.context._return}))}}.prototype,"context",void 0),X([ae()],class{resolve(e){return Q(this,void 0,void 0,(function*(){const{_params:t,_triggerType:n}=this.context,{workspaceFolder:i}=t;if("command"===n&&!i.appid)throw new Error("请先绑定AppId");yield e()}))}}.prototype,"context",void 0),X([ae()],class{uncaughtException(e){return Q(this,void 0,void 0,(function*(){e.message&&(yield this.context.outputView.appendLine({level:"error",status:"error",line:this.getErrorMessage(e)}))}))}resolve(e){return Q(this,void 0,void 0,(function*(){const{_triggerType:t,_commandOptions:n}=this.context;re.on("uncaughtException",this.uncaughtException.bind(this));try{yield e(),"cliCommand"===t&&(yield this.context.outputView.appendLine({level:"error",status:"error",line:`0:${n.commandName}:OK`}))}catch(e){e.message&&(yield this.context.outputView.appendLine({level:"error",status:"error",line:this.getErrorMessage(e)}))}re.off("uncaughtException",this.uncaughtException.bind(this))}))}getErrorMessage(e){const{isDebug:t,_triggerType:n,_commandOptions:i}=this.context,o=t?e.stack:e.message;return"cliCommand"!==n?o:`-1:${i.commandName}:${o}`}}.prototype,"context",void 0);class le{constructor(){this.providerNameList={tcb:"腾讯云",aliyun:"阿里云",alipay:"支付宝云"}}transformProvider(e){return this.providerNameList[e]}getBindSpace(){var e;return Q(this,void 0,void 0,(function*(){const{fsPath:t,workspaceFolder:n,properties:i={},specifySpace:o}=this.context._params,r=null===(e=null==t?void 0:t.match(/uniCloud-(tcb|aliyun|alipay)/))||void 0===e?void 0:e[1];let s=i.provider||r;const a=Object.keys(this.providerNameList).reduce(((e,t)=>(e[this.providerNameList[t]]=t,e)),{});if(o)return Object.assign({},o,{providerName:this.providerNameList[o.provider]});const{allSpaces:c}=yield function({workspaceFolder:e}){var t;return Q(this,void 0,void 0,(function*(){const{email:n}=yield C.default.authorize.requestUserInfo(),i=((yield C.default.workspace.getConfiguration("",e)).get("uniCloud")||{})[n]||{},o=O.default.readdirSync(e.uri.fsPath).filter((e=>/^uniCloud-(tcb|aliyun|alipay)$/.test(e))).map((e=>{var t;return null===(t=e.match(/^uniCloud-(tcb|aliyun|alipay)$/))||void 0===t?void 0:t[1]})).filter(Boolean),r=[];for(const e of o){const t=i[e];if(!t||!t.selected)continue;const n=t.spaces.find((e=>e.spaceid===t.selected));r.push({provider:e,spaceId:t.selected,spaceName:null==n?void 0:n.name,relatedProjectId:t.related&&t.related.projectid,clientSecret:null==n?void 0:n.clientSecret,accessKey:null==n?void 0:n.accessKey,secretKey:null==n?void 0:n.secretKey,spaceAppId:null==n?void 0:n.spaceAppId,apiEndpoint:null==n?void 0:n.apiEndpoint})}return Object.assign(Object.assign({},null!==(t=null==r?void 0:r[0])&&void 0!==t?t:{}),{allSpaces:r})}))}({workspaceFolder:n});if(c.length<=0)throw new Error("请先关联云服务空间");if(1===c.length&&(s=c[0].provider),!s){const e=yield C.default.window.showMessageBox({type:"warning",title:"",text:`项目 ${E.default.parse(n.uri.fsPath).base} 同时绑定了多个云服务商，请为当前操作指定使用哪个`,buttons:[...c.map((e=>this.providerNameList[e.provider])),"取消"]});if("取消"===e)throw new Error("取消");s=a[e]}const l=c.find((e=>e.provider===s));return Object.assign({},l,{providerName:this.providerNameList[s]})}))}getSpaceInfo(e){return Q(this,void 0,void 0,(function*(){return(yield this.remoteService.getAllSpaceList()).find((t=>t.id===e||t.name===e))}))}}X([ae()],le.prototype,"context",void 0),X([se(class{getAllSpaceList(){return Q(this,void 0,void 0,(function*(){const{spaces:e}=yield te({method:"post",path:"/serverless/space/list-all",dataType:"json",body:{}});return e}))}getAlipayUploadFileUrl(e){return Q(this,void 0,void 0,(function*(){return te({method:"post",path:"/serverless/host/get-upload-file-link",dataType:"json",body:e})}))}getAliyunUploadCredential(e){return Q(this,void 0,void 0,(function*(){const t=yield te({method:"post",path:"/serverless/host/aliyun-batch-upload-credential",dataType:"json",body:e});return{policy:t.Policy,securityToken:t.SecurityToken,endpoint:t.Endpoint,accessKeyId:t.AccessKeyId,signature:t.Signature,expiredTime:t.ExpiredTime,filePathPrefix:t.FilePathPrefix,remainedTime:t.RemainedTime}}))}getTcbUploadCredential(e){return Q(this,void 0,void 0,(function*(){const t=yield te({method:"post",path:"/serverless/host/tcb-sts-token",dataType:"json",body:e});return{bucket:t.bucket,region:t.region,expiredTime:t.expiredTime,sessionToken:t.credentials.sessionToken,tmpSecretId:t.credentials.tmpSecretId,tmpSecretKey:t.credentials.tmpSecretKey,startTime:t.startTime}}))}getWebHostInfo(e){return Q(this,void 0,void 0,(function*(){return te({method:"post",path:"/serverless/host/domains",dataType:"json",body:e})}))}getWebHostFileList(e){return Q(this,void 0,void 0,(function*(){const t=yield te({method:"post",path:"/serverless/host/file-list",dataType:"json",body:e});return t.files&&(t.files=t.files.map((e=>(e.createdAt=e.created_at,e.updatedAt=e.updated_at,e)))),t.lastPage=t.last_page,t.currentPage=t.current_page,t}))}deleteWebHostFile(e){return Q(this,void 0,void 0,(function*(){return te({method:"post",path:"/serverless/host/delete-file",dataType:"json",body:e})}))}})],le.prototype,"remoteService",void 0);const ue=C.default.window.createOutputView({id:"uniCloud-Debug-output",title:"uniCloud插件调试控制台"});class de{getUniCloudLogPrefix(){return Q(this,void 0,void 0,(function*(){if(this.context.isCli)return"";const{providerName:e,spaceName:t}=yield this.spaceService.getBindSpace();return`[${e}:${t}]`}))}writeDebug(...e){if(!this.context.isDebug)return;const t=e.map((e=>JSON.stringify(e))).join(" - ");return this.context.isCli?oe().appendLine({level:"info",line:`[debug] ${t}`}):(ue.show(),ue.appendLine({level:"info",line:t}))}writeUniCloudLog({level:e,message:t}){return Q(this,void 0,void 0,(function*(){const n=yield this.getRawUniCloudLog(t),i=oe();i.show(),yield i.appendLine({level:e,line:n})}))}getRawUniCloudLog(e){return Q(this,void 0,void 0,(function*(){return`${yield this.getUniCloudLogPrefix()}${e}`}))}getCliFormatLog(e,t=2){return Q(this,void 0,void 0,(function*(){const n=this.getColumnWidths(e);return e.reduce(((e,i)=>{const o=i.map(((e,i)=>e.padEnd(n[i]+t," "))).join("");return e.push(o.trimEnd()),e}),[])}))}getColumnWidths(e){const t=e.reduce(((e,t)=>Math.max(e,t.length)),0),n=[];for(let i=0;i<t;i++){const t=e.reduce(((e,t)=>(e.push(t[i]||""),e)),[]).reduce(((e,t)=>Math.max(e,t.length)),0);n.push(t)}return n}}X([ae()],de.prototype,"context",void 0),X([se(le)],de.prototype,"spaceService",void 0);const pe=["tcb","aliyun","alipay"];var fe={EOL:F.default.EOL||"\n",tryParseNumber:function(e,t){var n,i,o="",r=0,s=!0,a=0;function c(){return i=e.charAt(a),a++,i}for(c(),"-"===i&&(o="-",c());i>="0"&&i<="9";)s&&("0"==i?r++:s=!1),o+=i,c();if(s&&r--,"."===i)for(o+=".";c()&&i>="0"&&i<="9";)o+=i;if("e"===i||"E"===i)for(o+=i,c(),"-"!==i&&"+"!==i||(o+=i,c());i>="0"&&i<="9";)o+=i,c();for(;i&&i<=" ";)c();return t&&(","!==i&&"}"!==i&&"]"!==i&&"#"!==i&&("/"!==i||"/"!==e[a]&&"*"!==e[a])||(i=0)),n=+o,i||r||!isFinite(n)?void 0:n},createComment:function(e,t){return Object.defineProperty&&Object.defineProperty(e,"__COMMENTS__",{enumerable:!1,writable:!0}),e.__COMMENTS__=t||{}},removeComment:function(e){Object.defineProperty(e,"__COMMENTS__",{value:void 0})},getComment:function(e){return e.__COMMENTS__},forceComment:function(e){if(!e)return"";var t,n,i,o,r=e.split("\n");for(i=0;i<r.length;i++)for(o=(t=r[i]).length,n=0;n<o;n++){var s=t[n];if("#"===s)break;if("/"===s&&("/"===t[n+1]||"*"===t[n+1])){"*"===t[n+1]&&(i=r.length);break}if(s>" "){r[i]="# "+t;break}}return r.join("\n")}};function he(e,t){if(e)for(var n=0;n<e.length;n++){var i=e[n](t);if(void 0!==i)return i}}function me(){}function ge(e){return"{"===e||"}"===e||"["===e||"]"===e||","===e}function ye(){return{name:"math",parse:function(e){switch(e){case"+inf":case"inf":case"+Inf":case"Inf":return 1/0;case"-inf":case"-Inf":return-1/0;case"nan":case"NaN":return NaN}},stringify:function(e){if("number"==typeof e)return 1/e==-1/0?"-0":e===1/0?"Inf":e===-1/0?"-Inf":isNaN(e)?"NaN":void 0}}}function ve(e){var t=e&&e.out;return{name:"hex",parse:function(e){if(/^0x[0-9A-Fa-f]+$/.test(e))return parseInt(e,16)},stringify:function(e){if(t&&Number.isInteger(e))return"0x"+e.toString(16)}}}function we(){return{name:"date",parse:function(e){if(/^\d{4}-\d{2}-\d{2}$/.test(e)||/^\d{4}-\d{2}-\d{2}T\d{2}\:\d{2}\:\d{2}(?:.\d+)(?:Z|[+-]\d{2}:\d{2})$/.test(e)){var t=Date.parse(e);if(!isNaN(t))return new Date(t)}},stringify:function(e){if("[object Date]"===Object.prototype.toString.call(e)){var t=e.toISOString();return-1!==t.indexOf("T00:00:00.000Z",t.length-14)?t.substr(0,10):t}}}}ye.description="support for Inf/inf, -Inf/-inf, Nan/naN and -0",ve.description="parse hexadecimal numbers prefixed with 0x",we.description="support ISO dates";var xe={loadDsf:function(e,t){if("[object Array]"!==Object.prototype.toString.apply(e)){if(e)throw new Error("dsf option must contain an array!");return me}if(0===e.length)return me;var n=[];function i(e){return"[object Function]"==={}.toString.call(e)}return e.forEach((function(e){if(!e.name||!i(e.parse)||!i(e.stringify))throw new Error("extension does not match the DSF interface");n.push((function(){try{if("parse"==t)return e.parse.apply(null,arguments);if("stringify"==t){var n=e.stringify.apply(null,arguments);if(void 0!==n&&("string"!=typeof n||0===n.length||'"'===n[0]||[].some.call(n,(function(e){return ge(e)}))))throw new Error("value may not be empty, start with a quote or contain a punctuator character except colon: "+n);return n}throw new Error("Invalid type")}catch(t){throw new Error("DSF-"+e.name+" failed; "+t.message)}}))})),he.bind(null,n)},std:{math:ye,hex:ve,date:we}},be=function(e,t){var n,i,o,r,s,a=fe,c=xe,l={'"':'"',"'":"'","\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"};function u(){i=0,o=" "}function d(e){return"{"===e||"}"===e||"["===e||"]"===e||","===e||":"===e}function p(e){var t,o=0,r=1;for(t=i-1;t>0&&"\n"!==n[t];t--,o++);for(;t>0;t--)"\n"===n[t]&&r++;throw new Error(e+" at line "+r+","+o+" >>>"+n.substr(i-o,20)+" ...")}function f(){return o=n.charAt(i),i++,o}function h(e){return n.charAt(i+e)}function m(e){for(var t="",n=o;f();){if(o===n)return f(),e&&"'"===n&&"'"===o&&0===t.length?(f(),g()):t;if("\\"===o)if(f(),"u"===o){for(var i=0,r=0;r<4;r++){f();var s,a=o.charCodeAt(0);o>="0"&&o<="9"?s=a-48:o>="a"&&o<="f"?s=a-97+10:o>="A"&&o<="F"?s=a-65+10:p("Bad \\u char "+o),i=16*i+s}t+=String.fromCharCode(i)}else{if("string"!=typeof l[o])break;t+=l[o]}else"\n"===o||"\r"===o?p("Bad string containing newline"):t+=o}p("Bad string")}function g(){for(var e="",t=0,n=0;;){var i=h(-n-5);if(!i||"\n"===i)break;n++}function r(){for(var e=n;o&&o<=" "&&"\n"!==o&&e-- >0;)f()}for(;o&&o<=" "&&"\n"!==o;)f();for("\n"===o&&(f(),r());;){if(o){if("'"===o){if(t++,f(),3===t)return"\n"===e.slice(-1)&&(e=e.slice(0,-1)),e;continue}for(;t>0;)e+="'",t--}else p("Bad multiline string");"\n"===o?(e+="\n",f(),r()):("\r"!==o&&(e+=o),f())}}function y(){if('"'===o||"'"===o)return m(!1);for(var e="",t=i,n=-1;;){if(":"===o)return e?n>=0&&n!==e.length&&(i=t+n,p("Found whitespace in your key name (use quotes to include)")):p("Found ':' but no key name (for an empty key name use quotes)"),e;o<=" "?o?n<0&&(n=e.length):p("Found EOF while looking for a key name (check your syntax)"):d(o)?p("Found '"+o+"' where a key name was expected (check your syntax or use quotes if the key name includes {}[],: or whitespace)"):e+=o,f()}}function v(){for(;o;){for(;o&&o<=" ";)f();if("#"===o||"/"===o&&"/"===h(0))for(;o&&"\n"!==o;)f();else{if("/"!==o||"*"!==h(0))break;for(f(),f();o&&("*"!==o||"/"!==h(0));)f();o&&(f(),f())}}}function w(e,t){var o;for(e--,o=i-2;o>e&&n[o]<=" "&&"\n"!==n[o];o--);"\n"===n[o]&&o--,"\r"===n[o]&&o--;var r=n.substr(e,o-e+1);for(o=0;o<r.length;o++)if(r[o]>" "){var s=r.indexOf("\n");if(s>=0){var a=[r.substr(0,s),r.substr(s+1)];return t&&0===a[0].trim().length&&a.shift(),a}return[r]}return[]}function x(e){function t(e,n){var i,o,r,s;switch(typeof e){case"string":e.indexOf(n)>=0&&(s=e);break;case"object":if("[object Array]"===Object.prototype.toString.apply(e))for(i=0,r=e.length;i<r;i++)s=t(e[i],n)||s;else for(o in e)Object.prototype.hasOwnProperty.call(e,o)&&(s=t(e[o],n)||s)}return s}function n(n){var i=t(e,n);return i?"found '"+n+"' in a string value, your mistake could be with:\n  > "+i+"\n  (unquoted strings contain everything up to the next line!)":""}return n("}")||n("]")}function b(){var e,t,n,s=[];try{if(r&&(e=a.createComment(s,{a:[]})),f(),t=i,v(),e&&(n=w(t,!0).join("\n")),"]"===o)return f(),e&&(e.e=[n]),s;for(;o;){if(s.push(E()),t=i,v(),","===o&&(f(),t=i,v()),e){var c=w(t);e.a.push([n||"",c[0]||""]),n=c[1]}if("]"===o)return f(),e&&(e.a[e.a.length-1][1]+=n||""),s;v()}p("End of input while parsing an array (missing ']')")}catch(e){throw e.hint=e.hint||x(s),e}}function S(e){var t,n,s,c="",l={};try{if(r&&(t=a.createComment(l,{c:{},o:[]})),e?n=1:(f(),n=i),v(),t&&(s=w(n,!0).join("\n")),"}"===o&&!e)return t&&(t.e=[s]),f(),l;for(;o;){if(c=y(),v(),":"!==o&&p("Expected ':' instead of '"+o+"'"),f(),l[c]=E(),n=i,v(),","===o&&(f(),n=i,v()),t){var u=w(n);t.c[c]=[s||"",u[0]||""],s=u[1],t.o.push(c)}if("}"===o&&!e)return f(),t&&(t.c[c][1]+=s||""),l;v()}if(e)return l;p("End of input while parsing an object (missing '}')")}catch(e){throw e.hint=e.hint||x(l),e}}function E(){switch(v(),o){case"{":return S();case"[":return b();case"'":case'"':return m(!0);default:return function(){var e=o;for(d(o)&&p("Found a punctuator character '"+o+"' when expecting a quoteless string (check your syntax)");;){f();var t="\r"===o||"\n"===o||""===o;if(t||","===o||"}"===o||"]"===o||"#"===o||"/"===o&&("/"===h(0)||"*"===h(0))){var n=e[0];switch(n){case"f":if("false"===e.trim())return!1;break;case"n":if("null"===e.trim())return null;break;case"t":if("true"===e.trim())return!0;break;default:if("-"===n||n>="0"&&n<="9"){var i=a.tryParseNumber(e);if(void 0!==i)return i}}if(t){e=e.trim();var r=s(e);return void 0!==r?r:e}}e+=o}}()}}function C(e,t){var n=i;if(v(),o&&p("Syntax error, found trailing characters"),r){var s=t.join("\n"),c=w(n).join("\n");(c||s)&&(a.createComment(e,a.getComment(e)).r=[s,c])}return e}if("string"!=typeof e)throw new Error("source is not a string");var k=null,_=!0;return t&&"object"==typeof t&&(r=t.keepWsc,k=t.dsf,_=!1!==t.legacyRoot),s=c.loadDsf(k,"parse"),n=e,u(),_?function(){v();var e=r?w(1):null;switch(o){case"{":return C(S(),e);case"[":return C(b(),e)}try{return C(S(!0),e)}catch(t){u();try{return C(E(),e)}catch(e){throw t}}}():function(){v();var e=r?w(1):null;switch(o){case"{":return C(S(),e);case"[":return C(b(),e);default:return C(E(),e)}}()},Se=be;function ke(e){return Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}function Ee(e){try{return O.default.statSync(e).isDirectory()}catch(e){return!1}}function _e(e){return[E.default.resolve(e,"src","manifest.json"),E.default.resolve(e,"src","pages.json")].every((e=>O.default.existsSync(e)))}function Ce(e,t){O.default.existsSync(t)&&e.push(t)}function Ie(e,t,n){const i=[],o=E.default.resolve(e,`uniCloud-${t}`);Ce(i,E.default.resolve(o,n));const r=function(e){const t=E.default.resolve(e,_e(e)?"src":"","uni_modules");return Ee(t)?O.default.readdirSync(t).filter((e=>!!Ee(E.default.resolve(t,e)))):[]}(e);if(!r||0===r.length)return i;const s=function(e){let t={};try{t=function(e){return function(e){return Se(e.replace("\r\n","\n").replace("\r","\n"))}(function(e){let t=O.default.readFileSync(e);return 239===t[0]&&187===t[1]&&191===t[2]&&(t=t.slice(3)),t.toString("utf-8")}(e))}(E.default.resolve(e,_e(e)?"src":"","uni-modules.config.json"))}catch(e){}let n=t&&t.uni_modules;return n&&"object"===ke(n)||(n={}),n}(e);for(let o=0;o<r.length;o++){const a=r[o];let c=s[a];c&&"array"===ke(c)||(c=[t]),c.indexOf(t)>-1&&Ce(i,E.default.resolve(e,_e(e)?"src":"",`uni_modules/${a}/uniCloud`,n))}return i}function je(e){const t=(e=e.replace(/\\/g,"/")).match(/uni_modules\/(.*?)\//);return t&&t[1]||""}function Oe(e){const t=je(e),n=function(e){let t=[];const n=E.default.resolve(e,"common");try{t=O.default.readdirSync(n).map((e=>E.default.resolve(n,e))).filter((e=>Ee(e)))}catch(e){}return t}(e),i=[];for(let e=0;e<n.length;e++){const o=n[e],r=o.replace(/\\/g,"/").split("/").pop();i.push({name:r,path:o,uniModuleId:t})}return i}function Pe(e,t){const n=function(e,t){return Ie(e,t,"cloudfunctions")}(e,t),i=[];for(let e=0;e<n.length;e++){const t=Oe(n[e]);i.push(...t)}return i}process.env.UNICLOUD_DEBUGGER_PATH||E.default.resolve(__dirname,"../");const Le={"application/andrew-inset":["ez"],"application/appinstaller":["appinstaller"],"application/applixware":["aw"],"application/appx":["appx"],"application/appxbundle":["appxbundle"],"application/atom+xml":["atom"],"application/atomcat+xml":["atomcat"],"application/atomdeleted+xml":["atomdeleted"],"application/atomsvc+xml":["atomsvc"],"application/atsc-dwd+xml":["dwd"],"application/atsc-held+xml":["held"],"application/atsc-rsat+xml":["rsat"],"application/automationml-aml+xml":["aml"],"application/automationml-amlx+zip":["amlx"],"application/bdoc":["bdoc"],"application/calendar+xml":["xcs"],"application/ccxml+xml":["ccxml"],"application/cdfx+xml":["cdfx"],"application/cdmi-capability":["cdmia"],"application/cdmi-container":["cdmic"],"application/cdmi-domain":["cdmid"],"application/cdmi-object":["cdmio"],"application/cdmi-queue":["cdmiq"],"application/cpl+xml":["cpl"],"application/cu-seeme":["cu"],"application/cwl":["cwl"],"application/dash+xml":["mpd"],"application/dash-patch+xml":["mpp"],"application/davmount+xml":["davmount"],"application/docbook+xml":["dbk"],"application/dssc+der":["dssc"],"application/dssc+xml":["xdssc"],"application/ecmascript":["ecma"],"application/emma+xml":["emma"],"application/emotionml+xml":["emotionml"],"application/epub+zip":["epub"],"application/exi":["exi"],"application/express":["exp"],"application/fdf":["fdf"],"application/fdt+xml":["fdt"],"application/font-tdpfr":["pfr"],"application/geo+json":["geojson"],"application/gml+xml":["gml"],"application/gpx+xml":["gpx"],"application/gxf":["gxf"],"application/gzip":["gz"],"application/hjson":["hjson"],"application/hyperstudio":["stk"],"application/inkml+xml":["ink","inkml"],"application/ipfix":["ipfix"],"application/its+xml":["its"],"application/java-archive":["jar","war","ear"],"application/java-serialized-object":["ser"],"application/java-vm":["class"],"application/javascript":["js"],"application/json":["json","map"],"application/json5":["json5"],"application/jsonml+json":["jsonml"],"application/ld+json":["jsonld"],"application/lgr+xml":["lgr"],"application/lost+xml":["lostxml"],"application/mac-binhex40":["hqx"],"application/mac-compactpro":["cpt"],"application/mads+xml":["mads"],"application/manifest+json":["webmanifest"],"application/marc":["mrc"],"application/marcxml+xml":["mrcx"],"application/mathematica":["ma","nb","mb"],"application/mathml+xml":["mathml"],"application/mbox":["mbox"],"application/media-policy-dataset+xml":["mpf"],"application/mediaservercontrol+xml":["mscml"],"application/metalink+xml":["metalink"],"application/metalink4+xml":["meta4"],"application/mets+xml":["mets"],"application/mmt-aei+xml":["maei"],"application/mmt-usd+xml":["musd"],"application/mods+xml":["mods"],"application/mp21":["m21","mp21"],"application/mp4":["mp4","mpg4","mp4s","m4p"],"application/msix":["msix"],"application/msixbundle":["msixbundle"],"application/msword":["doc","dot"],"application/mxf":["mxf"],"application/n-quads":["nq"],"application/n-triples":["nt"],"application/node":["cjs"],"application/octet-stream":["bin","dms","lrf","mar","so","dist","distz","pkg","bpk","dump","elc","deploy","exe","dll","deb","dmg","iso","img","msi","msp","msm","buffer"],"application/oda":["oda"],"application/oebps-package+xml":["opf"],"application/ogg":["ogx"],"application/omdoc+xml":["omdoc"],"application/onenote":["onetoc","onetoc2","onetmp","onepkg"],"application/oxps":["oxps"],"application/p2p-overlay+xml":["relo"],"application/patch-ops-error+xml":["xer"],"application/pdf":["pdf"],"application/pgp-encrypted":["pgp"],"application/pgp-keys":["asc"],"application/pgp-signature":["sig","asc"],"application/pics-rules":["prf"],"application/pkcs10":["p10"],"application/pkcs7-mime":["p7m","p7c"],"application/pkcs7-signature":["p7s"],"application/pkcs8":["p8"],"application/pkix-attr-cert":["ac"],"application/pkix-cert":["cer"],"application/pkix-crl":["crl"],"application/pkix-pkipath":["pkipath"],"application/pkixcmp":["pki"],"application/pls+xml":["pls"],"application/postscript":["ai","eps","ps"],"application/provenance+xml":["provx"],"application/pskc+xml":["pskcxml"],"application/raml+yaml":["raml"],"application/rdf+xml":["rdf","owl"],"application/reginfo+xml":["rif"],"application/relax-ng-compact-syntax":["rnc"],"application/resource-lists+xml":["rl"],"application/resource-lists-diff+xml":["rld"],"application/rls-services+xml":["rs"],"application/route-apd+xml":["rapd"],"application/route-s-tsid+xml":["sls"],"application/route-usd+xml":["rusd"],"application/rpki-ghostbusters":["gbr"],"application/rpki-manifest":["mft"],"application/rpki-roa":["roa"],"application/rsd+xml":["rsd"],"application/rss+xml":["rss"],"application/rtf":["rtf"],"application/sbml+xml":["sbml"],"application/scvp-cv-request":["scq"],"application/scvp-cv-response":["scs"],"application/scvp-vp-request":["spq"],"application/scvp-vp-response":["spp"],"application/sdp":["sdp"],"application/senml+xml":["senmlx"],"application/sensml+xml":["sensmlx"],"application/set-payment-initiation":["setpay"],"application/set-registration-initiation":["setreg"],"application/shf+xml":["shf"],"application/sieve":["siv","sieve"],"application/smil+xml":["smi","smil"],"application/sparql-query":["rq"],"application/sparql-results+xml":["srx"],"application/sql":["sql"],"application/srgs":["gram"],"application/srgs+xml":["grxml"],"application/sru+xml":["sru"],"application/ssdl+xml":["ssdl"],"application/ssml+xml":["ssml"],"application/swid+xml":["swidtag"],"application/tei+xml":["tei","teicorpus"],"application/thraud+xml":["tfi"],"application/timestamped-data":["tsd"],"application/toml":["toml"],"application/trig":["trig"],"application/ttml+xml":["ttml"],"application/ubjson":["ubj"],"application/urc-ressheet+xml":["rsheet"],"application/urc-targetdesc+xml":["td"],"application/voicexml+xml":["vxml"],"application/wasm":["wasm"],"application/watcherinfo+xml":["wif"],"application/widget":["wgt"],"application/winhlp":["hlp"],"application/wsdl+xml":["wsdl"],"application/wspolicy+xml":["wspolicy"],"application/xaml+xml":["xaml"],"application/xcap-att+xml":["xav"],"application/xcap-caps+xml":["xca"],"application/xcap-diff+xml":["xdf"],"application/xcap-el+xml":["xel"],"application/xcap-ns+xml":["xns"],"application/xenc+xml":["xenc"],"application/xfdf":["xfdf"],"application/xhtml+xml":["xhtml","xht"],"application/xliff+xml":["xlf"],"application/xml":["xml","xsl","xsd","rng"],"application/xml-dtd":["dtd"],"application/xop+xml":["xop"],"application/xproc+xml":["xpl"],"application/xslt+xml":["xsl","xslt"],"application/xspf+xml":["xspf"],"application/xv+xml":["mxml","xhvml","xvml","xvm"],"application/yang":["yang"],"application/yin+xml":["yin"],"application/zip":["zip"],"audio/3gpp":["3gpp"],"audio/aac":["adts","aac"],"audio/adpcm":["adp"],"audio/amr":["amr"],"audio/basic":["au","snd"],"audio/midi":["mid","midi","kar","rmi"],"audio/mobile-xmf":["mxmf"],"audio/mp3":["mp3"],"audio/mp4":["m4a","mp4a"],"audio/mpeg":["mpga","mp2","mp2a","mp3","m2a","m3a"],"audio/ogg":["oga","ogg","spx","opus"],"audio/s3m":["s3m"],"audio/silk":["sil"],"audio/wav":["wav"],"audio/wave":["wav"],"audio/webm":["weba"],"audio/xm":["xm"],"font/collection":["ttc"],"font/otf":["otf"],"font/ttf":["ttf"],"font/woff":["woff"],"font/woff2":["woff2"],"image/aces":["exr"],"image/apng":["apng"],"image/avci":["avci"],"image/avcs":["avcs"],"image/avif":["avif"],"image/bmp":["bmp","dib"],"image/cgm":["cgm"],"image/dicom-rle":["drle"],"image/dpx":["dpx"],"image/emf":["emf"],"image/fits":["fits"],"image/g3fax":["g3"],"image/gif":["gif"],"image/heic":["heic"],"image/heic-sequence":["heics"],"image/heif":["heif"],"image/heif-sequence":["heifs"],"image/hej2k":["hej2"],"image/hsj2":["hsj2"],"image/ief":["ief"],"image/jls":["jls"],"image/jp2":["jp2","jpg2"],"image/jpeg":["jpeg","jpg","jpe"],"image/jph":["jph"],"image/jphc":["jhc"],"image/jpm":["jpm","jpgm"],"image/jpx":["jpx","jpf"],"image/jxr":["jxr"],"image/jxra":["jxra"],"image/jxrs":["jxrs"],"image/jxs":["jxs"],"image/jxsc":["jxsc"],"image/jxsi":["jxsi"],"image/jxss":["jxss"],"image/ktx":["ktx"],"image/ktx2":["ktx2"],"image/png":["png"],"image/sgi":["sgi"],"image/svg+xml":["svg","svgz"],"image/t38":["t38"],"image/tiff":["tif","tiff"],"image/tiff-fx":["tfx"],"image/webp":["webp"],"image/wmf":["wmf"],"message/disposition-notification":["disposition-notification"],"message/global":["u8msg"],"message/global-delivery-status":["u8dsn"],"message/global-disposition-notification":["u8mdn"],"message/global-headers":["u8hdr"],"message/rfc822":["eml","mime"],"model/3mf":["3mf"],"model/gltf+json":["gltf"],"model/gltf-binary":["glb"],"model/iges":["igs","iges"],"model/jt":["jt"],"model/mesh":["msh","mesh","silo"],"model/mtl":["mtl"],"model/obj":["obj"],"model/prc":["prc"],"model/step+xml":["stpx"],"model/step+zip":["stpz"],"model/step-xml+zip":["stpxz"],"model/stl":["stl"],"model/u3d":["u3d"],"model/vrml":["wrl","vrml"],"model/x3d+binary":["x3db","x3dbz"],"model/x3d+fastinfoset":["x3db"],"model/x3d+vrml":["x3dv","x3dvz"],"model/x3d+xml":["x3d","x3dz"],"model/x3d-vrml":["x3dv"],"text/cache-manifest":["appcache","manifest"],"text/calendar":["ics","ifb"],"text/coffeescript":["coffee","litcoffee"],"text/css":["css"],"text/csv":["csv"],"text/html":["html","htm","shtml"],"text/jade":["jade"],"text/javascript":["js","mjs"],"text/jsx":["jsx"],"text/less":["less"],"text/markdown":["md","markdown"],"text/mathml":["mml"],"text/mdx":["mdx"],"text/n3":["n3"],"text/plain":["txt","text","conf","def","list","log","in","ini"],"text/richtext":["rtx"],"text/rtf":["rtf"],"text/sgml":["sgml","sgm"],"text/shex":["shex"],"text/slim":["slim","slm"],"text/spdx":["spdx"],"text/stylus":["stylus","styl"],"text/tab-separated-values":["tsv"],"text/troff":["t","tr","roff","man","me","ms"],"text/turtle":["ttl"],"text/uri-list":["uri","uris","urls"],"text/vcard":["vcard"],"text/vtt":["vtt"],"text/wgsl":["wgsl"],"text/xml":["xml"],"text/yaml":["yaml","yml"],"video/3gpp":["3gp","3gpp"],"video/3gpp2":["3g2"],"video/h261":["h261"],"video/h263":["h263"],"video/h264":["h264"],"video/iso.segment":["m4s"],"video/jpeg":["jpgv"],"video/jpm":["jpm","jpgm"],"video/mj2":["mj2","mjp2"],"video/mp2t":["ts"],"video/mp4":["mp4","mp4v","mpg4"],"video/mpeg":["mpeg","mpg","mpe","m1v","m2v"],"video/ogg":["ogv"],"video/quicktime":["qt","mov"],"video/webm":["webm"]},Ne=new Map;for(let[e,t]of Object.entries(Le)){e=e.toLowerCase(),t=t.map((e=>e.toLowerCase()));for(const n of t)Ne.set(n,e)}function Fe(e){return JSON.parse(O.default.readFileSync(e).toString("utf8"))}function Te(e,t){const{srcPath:n,srcName:i,srcType:o}=e,r=E.default.resolve(n,"package.json");let s;if(O.default.existsSync(r))try{s=Fe(r)}catch(e){const t=`${n}内package.json内容有误，请检查后再试`;throw C.default.window.showErrorMessage(t),new Error(t)}else s={name:i,dependencies:{},extensions:{}};const{commonModuleList:a=[],extensionList:c=[]}=t||{},l=s.dependencies||{},u={};for(const e in l)l[e].startsWith("file:")&&delete l[e];if(a.length)for(let e=0;e<a.length;e++){const{name:t,path:i}=a[e];l[t]=`file:${E.default.relative(n,i).replace(/\\/g,"/")}`}if(c.length)for(let e=0;e<c.length;e++)u[c[e]]={};s.dependencies=l,s.extensions=u,"module"===o&&delete s.extensions,O.default.writeFileSync(r,JSON.stringify(s,null,2))}const De=[{name:"uni-cloud-jql",description:'为云函数提供JQL语法支持，<a href="https://uniapp.dcloud.net.cn/uniCloud/jql-cloud.html">详情</a>'},{name:"uni-cloud-redis",description:'连接Redis，<a href="https://uniapp.dcloud.net.cn/uniCloud/redis.html">详情</a>'},{name:"uni-cloud-sms",description:'发送短信，<a href="https://uniapp.dcloud.net.cn/uniCloud/send-sms.html">详情</a>'},{name:"uni-cloud-verify",description:'包含<a href="https://uniapp.dcloud.net.cn/uniCloud/univerify.html">手机号一键登录</a>和<a href="https://uniapp.dcloud.net.cn/uniCloud/frv/intro.html">实人认证</a>。'},{name:"uni-cloud-push",description:'统一推送服务，<a href="https://uniapp.dcloud.io/uniCloud/unipush.html">详情</a>'},{name:"uni-cloud-ai",description:'AI能力扩展，<a href="https://uniapp.dcloud.io/uniCloud/uni-ai.html">详情</a>'},{name:"uni-cloud-ext-storage",description:'扩展存储，<a href="https://uniapp.dcloud.io/uniCloud/uni-cloud-ext-storage.html">详情</a>'}];function $e(e,t){const n=e.map((e=>({type:"checkbox",columns:[{label:e.name},{label:e.description}]}))),i=[];for(let n=0;n<e.length;n++){const{name:o}=e[n];t.includes(o)&&i.push(n)}return{multiSelection:!0,type:"list",name:"extensionList",title:"选择要添加的uniCloud扩展库",maxHeight:240,columnStretches:[1,2],items:n,value:i}}function Re(e){return Y(this,void 0,void 0,(function*(){const{srcType:t,srcName:n,srcPath:i,workspacePath:o,provider:r,extensionList:s=[],commonModuleList:a=[],writePackageJson:c=!1}=e||{};let l=function(e,t){const n=t?[t]:pe,i=[];for(let t=0;t<n.length;t++){const o=n[t];i.push(...Pe(e,o))}return i.filter(((e,t)=>i.find((t=>t.uniModuleId===e.uniModuleId&&t.name===e.name))===e))}(o,r);"module"===t&&(l=l.filter((e=>e.name!==n)));const u=[];let d,p=De;"function"===t?u.push($e(p,s)):"database"===t&&(p=De.filter((e=>"uni-cloud-jql"!==e.name)),u.push($e(p,s))),u.push(function(e,t){const n=e.map((e=>({type:"checkbox",columns:[{label:e.uniModuleId?`${e.name} [${e.uniModuleId}]`:e.name}]}))),i=[];for(let n=0;n<e.length;n++){const{name:o,uniModuleId:r}=e[n];t.find((e=>e.name===o&&e.uniModuleId===r))&&i.push(n)}return{multiSelection:!0,type:"list",name:"commonModuleList",title:"选择项目下的公共模块",columnStretches:[1],items:n,value:i}}(l,a));try{let e,n;switch(t){case"function":e="管理本云函数的扩展库/公共模块依赖";break;case"database":e="管理Schema扩展Js的扩展库/公共模块依赖",n='配置的依赖可以在Schema扩展Js、validateFunction、action内使用，<a href="https://uniapp.dcloud.net.cn/uniCloud/jql.html#deps-of-jql">详情</a>';break;case"module":e="管理本公共模块依赖的公共模块"}d=yield C.default.window.showFormDialog({title:e,subtitle:n,width:560,height:640,submitButtonText:"确定(&N)",cancelButtonText:"取消(&C)",formItems:u})}catch(e){return{commonModuleList:a,extensionList:s}}const f=[],h=[];for(let e=0;e<d.commonModuleList.length;e++)h.push(l[d.commonModuleList[e]]);if("function"===t||"database"===t)for(let e=0;e<d.extensionList.length;e++)f.push(p[d.extensionList[e]].name);const m={commonModuleList:h,extensionList:f};if(!c)return m;try{Te({srcPath:i,srcName:n,srcType:t},m)}catch(e){}return m}))}const Ae=new RegExp(`uniCloud(${pe.map((e=>"-"+e)).join("|")})/database`),Be=pe.reduce(((e,t)=>(e[t]=new RegExp(`/uniCloud-${t}/`),e)),{});function Me(e){function t(e){return Y(this,void 0,void 0,(function*(){const t=e.fsPath.replace(/\\/g,"/"),n=t.replace(/\\/g,"/").split("/").pop();let i;i=Ae.test(t)?"database":function(e){return/uniCloud(-aliyun|-tcb|-alipay|)\/cloudfunctions\/common\//.test(e)?"module":/uniCloud(-aliyun|-tcb|-alipay|)\/cloudfunctions\/uni-clientDB-actions\//.test(e)?"action":/uniCloud(-aliyun|-tcb|-alipay|)\/cloudfunctions\//.test(e)?"function":""}(t);const o=e.workspaceFolder.uri.fsPath.replace(/\\/g,"/"),r=function(e){for(const t in Be)if(Be[t].test(e))return t}(t);Re(Object.assign(Object.assign({srcName:n,srcPath:t,srcType:i,provider:r,workspacePath:o},function(e){const t=E.default.resolve(e,"package.json");if(!O.default.existsSync(t))return{extensionList:[],commonModuleList:[]};let n;try{n=Fe(t)}catch(e){return{extensionList:[],commonModuleList:[]}}const{dependencies:i={},extensions:o={}}=n||{},r=[];for(const t in i){const n=i[t];if(!n.startsWith("file:"))continue;const o=t,s=E.default.resolve(e,n.replace("file:","")),a=je(s);r.push({name:o,path:s,uniModuleId:a})}return{extensionList:Object.keys(o),commonModuleList:r}}(t)),{writePackageJson:!0}))}))}const n=C.default.commands.registerCommand("unicloud-dependency-manager.edit-function",t),i=C.default.commands.registerCommand("unicloud-dependency-manager.edit-common",t),o=C.default.commands.registerCommand("unicloud-dependency-manager.edit-jql",t);return e.subscriptions.push(n),e.subscriptions.push(i),e.subscriptions.push(o),{editDependency:Re,saveDependency:Te}}var Ue="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function qe(e){if(e.__esModule)return e;var t=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(e).forEach((function(n){var i=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,i.get?i:{enumerable:!0,get:function(){return e[n]}})})),t}function We(e,t,n,i){var o,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(r<3?o(s):r>3?o(t,n,s):o(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s}function Je(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((i=i.apply(e,t||[])).next())}))}class He extends Error{constructor(e){const{message:t,code:n}=e||{};super(t),this.code=n}}function Ve(e){return{send:t=>{e.postMessage(t)},on:(t,n)=>{"message"===t&&e.onDidReceiveMessage((e=>{n(e)}))}}}const ze="JSON_RPC_MESSAGE_CALL",Ge="JSON_RPC_MESSAGE_RESPONSE";class Ke{constructor(e){const{bridge:t,timeout:n=3e4}=e||{};this._timeout=n,this._bridge=t,this._methodMap=new Map,this._promiseMap=new Map,this._callMessageId=0,this._messageCallback=e=>{!function(e){return e.type===ze}(e)?function(e){return e.type===Ge&&!!e.result}(e)?this._processResponseSuccessMessage(e):function(e){return e.type===Ge&&!!e.error}(e)&&this._processResponseFailMessage(e):this._processCallMessage(e)},this._bridge.on("message",this._messageCallback)}_processCallMessage(e){const{id:t,method:n,params:i}=e||{};this._methodMap.has(n)||this._fail(t,-32601,`method[${n}] not found`);const o=this._methodMap.get(n);try{const e=o(i);e&&"function"==typeof e.then?e.then((e=>{this._success(t,e||{})})).catch((e=>{this._fail(t,-32603,e.message)})):this._success(t,e||{})}catch(e){this._fail(t,-32603,e.message)}}_processResponseSuccessMessage(e){const{id:t,result:n}=e||{};if(!this._promiseMap.has(t))return;const{resolve:i}=this._promiseMap.get(t);this._promiseMap.delete(t),i(n)}_processResponseFailMessage(e){const{id:t,error:n}=e||{};if(!this._promiseMap.has(t))return;const{reject:i}=this._promiseMap.get(t);this._promiseMap.delete(t),i(new He({code:n.code,message:n.message}))}_send(e){this._bridge.send(e)}_success(e,t){this._send({id:e,type:Ge,result:t})}_fail(e,t,n){this._send({type:Ge,id:e,error:{code:t,message:n}})}call(e,t){return new Promise(((n,i)=>{const o=++this._callMessageId;this._send({type:ze,id:o,method:e,params:t||{}}),this._promiseMap.set(o,{resolve:n,reject:i}),setTimeout((()=>{this._promiseMap.delete(o),i(new He({code:-32e3,message:"Invoke method timeout"}))}),this._timeout)}))}expose(e,t){this._methodMap.set(e,t)}close(){this._bridge.off&&this._bridge.off("message",this._messageCallback)}}const Ze="https://ide.liuyingyong.cn";function Ye(e){return Je(this,void 0,void 0,(function*(){return C.default.http.request(Object.assign(Object.assign({},e),{dataType:void 0}))}))}function Xe(e){if(e.error)throw new He({message:`请求服务失败：${JSON.stringify(e.error)}${e.data?"\n"+e.data:e.data}`,code:"REQUEST_ERROR"});if(e.httpStatusCode>=400)throw new He({message:`网络请求错误，状态码：${e.httpStatusCode}${e.data?"\n"+e.data:e.data}`,code:e.httpStatusCode})}function Qe(e,t){if(Xe(e),"json"===t.dataType)try{return JSON.parse(e.data)}catch(t){throw new He({message:e.data,code:"REQUEST_ERROR"})}return e.data}const et=Qe;function tt(e){Xe(e);const t=JSON.parse(e.data),n=t.header&&t.header.result,i=n&&n.rspcode,o=n&&n.rspdesc;if("1001"!==i)throw new He({code:"REQUEST_ERROR",message:`请求DCloud服务失败：错误码为：${i}，详细错误信息为：${o}`});return t.body}function nt(e){return Je(this,void 0,void 0,(function*(){return tt(yield Ye({url:`${Ze}${e.path}`,method:e.method,dataType:e.dataType,params:{param:JSON.stringify({header:{token:"${user.checked.token}"},body:e.body})}}))}))}const it=Symbol("CONTEXT_STORAGE");function ot(){return global[it]||(global[it]=new n.AsyncLocalStorage),global[it]}function rt(){const e=ot().getStore();if(!e)throw new Error("context is not exist");return e}function st(){var e;return null===(e=rt())||void 0===e?void 0:e.outputView}class at extends Map{saveCommand(e,t,n){if(this.has(e))throw new Error(`Command ${e} already exists`);this.set(e,{type:"command",target:t,options:n})}saveCliCommand(e,t,n){if(this.has(e))throw new Error(`CliCommand ${e} already exists`);this.set(e,{type:"cliCommand",target:t,options:n})}saveAppService(e,t,n){if(this.has(e))throw new Error(`AppService ${e} already exists`);this.set(e,{type:"appService",target:t,options:n})}saveCustomEditor(e,t,n){if(this.has(e))throw new Error(`CustomEditor ${e} already exists`);this.set(e,{type:"customEditor",target:t,options:n})}saveLauncher(e,t,n){if(this.has(e))throw new Error(`Launcher ${e} already exists`);this.set(e,{type:"launcher",target:t,options:n})}}const ct=new at,lt=new i.EventEmitter;function ut(e){return function(t,n){Object.defineProperty(t,n,{get:function(){return new e(this)}})}}function dt(){return function(e,t){Object.defineProperty(e,t,{get:function(){return rt()}})}}class pt{constructor(e){this.workspaceFolder=e.workspaceFolder,this.triggerType=e.triggerType,this.cliConsoleConfig=e.cliConsoleConfig,this.isCli="cliCommand"===this.triggerType,this.console=this.createLog()}createLog(){return this.isCli?C.default.cliconsole:this.workspaceFolder?C.default.window.createOutputView({id:`${this.workspaceFolder.id}-unicloud`,title:`[${this.workspaceFolder.name}] - unicloud控制台`}):C.default.window.createOutputChannel("unicloud")}appendLine(e){return Je(this,void 0,void 0,(function*(){const{line:t,status:n="info"}=e;this.isCli?yield this.console.log({clientId:this.cliConsoleConfig.clientId,msg:t,status:n,hideTime:!0}):yield this.console.appendLine(e)}))}show(){var e,t;null===(t=null===(e=this.console)||void 0===e?void 0:e.show)||void 0===t||t.call(e)}}class ft{isDebug(){return O.default.existsSync(E.default.resolve(__dirname,"dcloud.debug"))}resolve(e){return Je(this,void 0,void 0,(function*(){const{_params:t,_triggerType:n}=this.context,{workspaceFolder:i,fsPath:o,cliconsole:r}=t,s=Boolean("cliCommand"===n||(null==r?void 0:r.clientId));if(this.context.isDebug=this.isDebug(),this.context.isCli=s,this.context.workspaceFolder=i,this.context.fsPath=o,this.context.outputView=new pt({workspaceFolder:i,triggerType:n,cliConsoleConfig:r}),yield e(),this.context._return)return this.context._return}))}}We([dt()],ft.prototype,"context",void 0);class ht{resolve(e){return Je(this,void 0,void 0,(function*(){const{_params:t,_triggerType:n}=this.context,{workspaceFolder:i}=t;if("command"===n&&!i.appid)throw new Error("请先绑定AppId");yield e()}))}}We([dt()],ht.prototype,"context",void 0);class mt{uncaughtException(e){return Je(this,void 0,void 0,(function*(){e.message&&(yield this.context.outputView.appendLine({level:"error",status:"error",line:this.getErrorMessage(e)}))}))}resolve(e){return Je(this,void 0,void 0,(function*(){const{_triggerType:t,_commandOptions:n}=this.context;lt.on("uncaughtException",this.uncaughtException.bind(this));try{yield e(),"cliCommand"===t&&(yield this.context.outputView.appendLine({level:"error",status:"error",line:`0:${n.commandName}:OK`}))}catch(e){e.message&&(yield this.context.outputView.appendLine({level:"error",status:"error",line:this.getErrorMessage(e)}))}lt.off("uncaughtException",this.uncaughtException.bind(this))}))}getErrorMessage(e){const{isDebug:t,_triggerType:n,_commandOptions:i}=this.context,o=t?e.stack:e.message;return"cliCommand"!==n?o:`-1:${i.commandName}:${o}`}}We([dt()],mt.prototype,"context",void 0);const gt={command:{commandAlias:"invoke",command:"registerCommand",group:"commands"},cliCommand:{commandAlias:"invoke",command:"registerCliCommand",group:"commands"},appService:{commandAlias:"invoke",command:"registerAppService",group:"app"},customEditor:{commandAlias:"invoke",command:"registerCustomEditorProvider",group:"window",useInstance:!0},launcher:{commandAlias:"invoke",command:"registerWorkspaceFolderLauncher",group:"workspace",useInstance:!0}};function yt(e,t,n,i){const{value:o,key:r}=i,{options:s={}}=o,a=s.middleware||[],c={_params:t.document?t.document:t,_triggerType:o.type,_commandOptions:Object.assign({},s,{commandName:r})};return ot().run(c,(()=>{var t;return function(e){if(!Array.isArray(e))throw new Error("middleware stack must be an array!");for(const t of e)if("function"!=typeof t)throw new TypeError("middleware must be composed of functions!");return function t(){const n=e.shift();if(!n)return Promise.resolve();try{const e=new n;return Promise.resolve(e.resolve(t))}catch(e){return Promise.reject(e)}}()}(null===(t=n.middleware)||void 0===t?void 0:t.concat(a).concat(e)).catch((e=>lt.emit("uncaughtException",e)))}))}function vt({workspaceFolder:e}){var t;return Je(this,void 0,void 0,(function*(){const{email:n}=yield C.default.authorize.requestUserInfo(),i=((yield C.default.workspace.getConfiguration("",e)).get("uniCloud")||{})[n]||{},o=O.default.readdirSync(e.uri.fsPath).filter((e=>/^uniCloud-(tcb|aliyun|alipay)$/.test(e))).map((e=>{var t;return null===(t=e.match(/^uniCloud-(tcb|aliyun|alipay)$/))||void 0===t?void 0:t[1]})).filter(Boolean),r=[];for(const e of o){const t=i[e];if(!t||!t.selected)continue;const n=t.spaces.find((e=>e.spaceid===t.selected));r.push({provider:e,spaceId:t.selected,spaceName:null==n?void 0:n.name,relatedProjectId:t.related&&t.related.projectid,clientSecret:null==n?void 0:n.clientSecret,accessKey:null==n?void 0:n.accessKey,secretKey:null==n?void 0:n.secretKey,spaceAppId:null==n?void 0:n.spaceAppId,apiEndpoint:null==n?void 0:n.apiEndpoint})}return Object.assign(Object.assign({},null!==(t=null==r?void 0:r[0])&&void 0!==t?t:{}),{allSpaces:r})}))}function wt(){return C.default.workspace.getConfiguration().get("node.path")||E.default.resolve(C.default.env.appRoot,"plugins","node","win32"===process.platform?"node.exe":"node")}function xt(){const e={tcb:{nodejs8:"8.9.4",nodejs12:"12.16.1"},aliyun:{nodejs8:"8.17.0",nodejs12:"12.22.1"},alipay:{nodejs16:"16.20.2",nodejs18:"18.18.2"}};return e.tcb.default=e.tcb.nodejs8,e.aliyun.default=e.aliyun.nodejs8,e.alipay.default=e.alipay.nodejs18,e}class bt{constructor(){this.providerNameList={tcb:"腾讯云",aliyun:"阿里云",alipay:"支付宝云"}}transformProvider(e){return this.providerNameList[e]}getBindSpace(){var e;return Je(this,void 0,void 0,(function*(){const{fsPath:t,workspaceFolder:n,properties:i={},specifySpace:o}=this.context._params,r=null===(e=null==t?void 0:t.match(/uniCloud-(tcb|aliyun|alipay)/))||void 0===e?void 0:e[1];let s=i.provider||r;const a=Object.keys(this.providerNameList).reduce(((e,t)=>(e[this.providerNameList[t]]=t,e)),{});if(o)return Object.assign({},o,{providerName:this.providerNameList[o.provider]});const{allSpaces:c}=yield vt({workspaceFolder:n});if(c.length<=0)throw new Error("请先关联云服务空间");if(1===c.length&&(s=c[0].provider),!s){const e=yield C.default.window.showMessageBox({type:"warning",title:"",text:`项目 ${E.default.parse(n.uri.fsPath).base} 同时绑定了多个云服务商，请为当前操作指定使用哪个`,buttons:[...c.map((e=>this.providerNameList[e.provider])),"取消"]});if("取消"===e)throw new Error("取消");s=a[e]}const l=c.find((e=>e.provider===s));return Object.assign({},l,{providerName:this.providerNameList[s]})}))}getSpaceInfo(e){return Je(this,void 0,void 0,(function*(){return(yield this.remoteService.getAllSpaceList()).find((t=>t.id===e||t.name===e))}))}}We([dt()],bt.prototype,"context",void 0),We([ut(class{getAllSpaceList(){return Je(this,void 0,void 0,(function*(){const{spaces:e}=yield nt({method:"post",path:"/serverless/space/list-all",dataType:"json",body:{}});return e}))}getAlipayUploadFileUrl(e){return Je(this,void 0,void 0,(function*(){return nt({method:"post",path:"/serverless/host/get-upload-file-link",dataType:"json",body:e})}))}getAliyunUploadCredential(e){return Je(this,void 0,void 0,(function*(){const t=yield nt({method:"post",path:"/serverless/host/aliyun-batch-upload-credential",dataType:"json",body:e});return{policy:t.Policy,securityToken:t.SecurityToken,endpoint:t.Endpoint,accessKeyId:t.AccessKeyId,signature:t.Signature,expiredTime:t.ExpiredTime,filePathPrefix:t.FilePathPrefix,remainedTime:t.RemainedTime}}))}getTcbUploadCredential(e){return Je(this,void 0,void 0,(function*(){const t=yield nt({method:"post",path:"/serverless/host/tcb-sts-token",dataType:"json",body:e});return{bucket:t.bucket,region:t.region,expiredTime:t.expiredTime,sessionToken:t.credentials.sessionToken,tmpSecretId:t.credentials.tmpSecretId,tmpSecretKey:t.credentials.tmpSecretKey,startTime:t.startTime}}))}getWebHostInfo(e){return Je(this,void 0,void 0,(function*(){return nt({method:"post",path:"/serverless/host/domains",dataType:"json",body:e})}))}getWebHostFileList(e){return Je(this,void 0,void 0,(function*(){const t=yield nt({method:"post",path:"/serverless/host/file-list",dataType:"json",body:e});return t.files&&(t.files=t.files.map((e=>(e.createdAt=e.created_at,e.updatedAt=e.updated_at,e)))),t.lastPage=t.last_page,t.currentPage=t.current_page,t}))}deleteWebHostFile(e){return Je(this,void 0,void 0,(function*(){return nt({method:"post",path:"/serverless/host/delete-file",dataType:"json",body:e})}))}})],bt.prototype,"remoteService",void 0);const St=C.default.window.createOutputView({id:"uniCloud-Debug-output",title:"uniCloud插件调试控制台"});class kt{getUniCloudLogPrefix(){return Je(this,void 0,void 0,(function*(){if(this.context.isCli)return"";const{providerName:e,spaceName:t}=yield this.spaceService.getBindSpace();return`[${e}:${t}]`}))}writeDebug(...e){if(!this.context.isDebug)return;const t=e.map((e=>JSON.stringify(e))).join(" - ");return this.context.isCli?st().appendLine({level:"info",line:`[debug] ${t}`}):(St.show(),St.appendLine({level:"info",line:t}))}writeUniCloudLog({level:e,message:t}){return Je(this,void 0,void 0,(function*(){const n=yield this.getRawUniCloudLog(t),i=st();i.show(),yield i.appendLine({level:e,line:n})}))}getRawUniCloudLog(e){return Je(this,void 0,void 0,(function*(){return`${yield this.getUniCloudLogPrefix()}${e}`}))}getCliFormatLog(e,t=2){return Je(this,void 0,void 0,(function*(){const n=this.getColumnWidths(e);return e.reduce(((e,i)=>{const o=i.map(((e,i)=>e.padEnd(n[i]+t," "))).join("");return e.push(o.trimEnd()),e}),[])}))}getColumnWidths(e){const t=e.reduce(((e,t)=>Math.max(e,t.length)),0),n=[];for(let i=0;i<t;i++){const t=e.reduce(((e,t)=>(e.push(t[i]||""),e)),[]).reduce(((e,t)=>Math.max(e,t.length)),0);n.push(t)}return n}}We([dt()],kt.prototype,"context",void 0),We([ut(bt)],kt.prototype,"spaceService",void 0);const Et={compileUniApp:function(e){return Je(this,void 0,void 0,(function*(){const t=yield C.default.request("MainHostPublish.compile",Object.assign(Object.assign({},e),{issuessr:e.useSSR}));return t.useSSR=t.issuessr,t}))}};var _t=Object.freeze({__proto__:null,BASE_IDE_URL:Ze,CliCommand:function(e,t){return function(n){return ct.saveCliCommand(e,n,t),n}},Command:function(e,t){return function(n){return ct.saveCommand(e,n,t),n}},Context:dt,CustomEditor:function(e){return function(t){return ct.saveCustomEditor(e,t),t}},Inject:ut,Launcher:function(e){return function(t){return ct.saveLauncher(e,t),t}},LogService:kt,SpaceService:bt,Webview:class extends class{constructor(){this._callbacks={}}_ensureEventCallback(e){return this._callbacks[e]||(this._callbacks[e]=[]),this._callbacks[e]}_findLastCallbackIndex(e,t){const n=this._ensureEventCallback(e);for(let e=n.length-1;e>=0;e--)if(n[e].fn===t)return e;return-1}on(e,t){return this._ensureEventCallback(e).push({fn:t,isOnce:!1}),this}addListener(e,t){return this.on(e,t)}once(e,t){return this._ensureEventCallback(e).push({fn:t,isOnce:!0}),this}prependListener(e,t){return this._ensureEventCallback(e).unshift({fn:t,isOnce:!1}),this}prependOnceListener(e,t){return this._ensureEventCallback(e).unshift({fn:t,isOnce:!0}),this}off(e,t){const n=this._ensureEventCallback(e),i=this._findLastCallbackIndex(e,t);return i>-1&&n.splice(i,1),this}removeListener(e,t){return this.off(e,t)}removeAllListeners(e){const t=this._ensureEventCallback(e);return t.splice(0,t.length),this}emit(e,...t){const n=this._ensureEventCallback(e);if(!n.length)return!1;for(let e=0;e<n.length;e++)(0,n[e].fn)(...t);for(let e=n.length-1;e>=0;e--)n[e].isOnce&&n.splice(e,1);return!0}}{constructor(e){super();const{webviewDialog:t,context:n={}}=e||{};this.webviewDialog=t,this.webview=t.webView,this.context=n,this.rpc=new Ke({bridge:Ve(this.webview)}),this.webviewDialog.onDialogClosed((()=>{this.emit("close")}))}loadHtml(e){this.webview.html=e}show(){return Je(this,void 0,void 0,(function*(){return this.webviewDialog.show()}))}close(){this.webviewDialog.close()}setButtonStatus(e,t){this.webviewDialog.setButtonStatus(e,t)}},downloadFile:function(e){return Je(this,void 0,void 0,(function*(){const t=e.dataType||"json";return Qe(yield Ye(Object.assign(Object.assign({},e),{connectionTimeout:e.connectionTimeout||1e5,readTimeout:e.readTimeout||6e5})),{dataType:t})}))},findNodePath:wt,getCloudFunctionNodeVersion:function(e,t){var n,i,o;const r=E.default.resolve(e,"package.json");if(!O.default.existsSync(r))return;let s;try{s=JSON.parse(O.default.readFileSync(r,"utf-8"))}catch(e){return}const a=xt(),c=s["cloudfunction-config"],l=null==c?void 0:c.runtime,u=null===(n=a[t])||void 0===n?void 0:n.default;return l&&null!==(o=null===(i=a[t])||void 0===i?void 0:i[c.runtime.toLowerCase()])&&void 0!==o?o:u},getCloudFunctionNodeVersionList:xt,getContext:rt,getHBuilderXNodeVersion:function(){const e=wt();try{return L.execSync(`${e} -v`).toString().trim().replace("v","")}catch(e){console.error(e)}},getWorkspaceBindServiceSpace:vt,hxExtends:Et,request:function(e){return Je(this,void 0,void 0,(function*(){const t=e.dataType||"json",n=yield Ye(e);return et(n,{dataType:t})}))},requestDCloud:nt,setup:function(e,t){var n,i,o;const r={};return null===(n=t.middleware)||void 0===n||n.unshift(ht),null===(i=t.middleware)||void 0===i||i.unshift(mt),null===(o=t.middleware)||void 0===o||o.unshift(ft),ct.forEach(((n,i)=>{const o=gt[n.type];if(n.type&&o){const{target:s,options:a={}}=n;if(o.useInstance?C.default[o.group][o.command](i,new Proxy(new s,{get:(e,o)=>(...r)=>yt(class{resolve(){return Je(this,void 0,void 0,(function*(){"function"==typeof e.init&&(yield e.init());const t=yield Promise.resolve(e[o](...r));return void 0!==t&&(rt()._return=t),t}))}},{},t,{value:n,key:i})})):C.default[o.group][o.command](i,(r=>{const a=new s(e);return yt(class{resolve(){return Je(this,void 0,void 0,(function*(){return"function"==typeof a.init&&(yield a.init()),Promise.resolve(a[o.commandAlias||o.command](r))}))}},r,t,{value:n,key:i})})),a.export){const o="string"==typeof a.export?a.export:i;r[o]=r=>{const a=new s(e);return"function"!=typeof a.export&&console.error(`export [${o}] fail, [export] function not found`),yt(class{resolve(){return Je(this,void 0,void 0,(function*(){return"function"==typeof a.init&&(yield a.init()),Promise.resolve(a.export(r))}))}},r,t,{value:n,key:i})}}}})),r},uploadFile:function(e){return Je(this,void 0,void 0,(function*(){const t=e.dataType||"json",n=yield Ye({method:e.method||"post",url:e.url,dataType:t,params:e.params});return et(n,{dataType:t})}))},uploadFileDCloud:function(e){return Je(this,void 0,void 0,(function*(){return tt(yield Ye({url:`${Ze}${e.path}`,method:e.method,connectionTimeout:e.connectionTimeout||1e5,readTimeout:e.readTimeout||6e5,dataType:e.dataType,params:{param:JSON.stringify({header:{token:"${user.checked.token}"},body:e.body}),attachment:e.attachment}}))}))},hx:C.default}),Ct=qe(_t);const It=C.default,jt=E.default,Ot=O.default,{getWorkspaceBindServiceSpace:Pt}=Ct,Lt={ALIYUN:0,TCB:1,BOTH:2,ALIPAY:3,toString(e){return e===this.BOTH?"both":e===this.ALIYUN?"aliyun":e===this.TCB?"tcb":"alipay"}};function Nt(e){return"aliyun"===e?"阿里云":"tcb"===e?"腾讯云":"支付宝云"}function Ft(e){try{let t=/(?<=(\/|\\)uniCloud(-aliyun|-tcb|-alipay)?(\/|\\)cloudfunctions(\/|\\))[^\/\\]*/g,n=e.match(t);if(n&&n.length>0)return n[0]}catch(e){}}function Tt(e){let t=Ft(e);if(t){let n=new RegExp(`.*cloudfunctions(/|\\\\)(?=${t})`),i=e.match(n);if(i&&i.length>0){let e=i[0];return jt.join(e,t)}}}function Dt(e){try{let t=/(?<=(\/|\\)uni_modules(\/|\\))[^\/\\]*/g,n=e.match(t);if(n&&n.length>0)return n[0]}catch(e){}}async function $t(e){const{fsPath:t,workspaceFolder:n,properties:i={}}=e,o=t.match(/uniCloud-(tcb|aliyun|alipay)/)?.[1];let r=i.provider||o;const{allSpaces:s}=await Pt({workspaceFolder:n});if(s.length<=0)throw new Error("请先关联云服务空间");1===s.length&&(r=s[0].provider);const a={tcb:"腾讯云",aliyun:"阿里云",alipay:"支付宝云"},c=Object.keys(a).reduce(((e,t)=>(e[a[t]]=t,e)),{});if(!r){const e=await It.window.showMessageBox({type:"warning",title:"",text:`项目 ${jt.parse(n.uri.fsPath).base} 同时绑定了多个云服务商，请为当前操作指定使用哪个`,buttons:[...s.map((e=>a[e.provider])),"取消"]});if("取消"===e)throw new Error("取消");r=c[e]}const l=s.find((e=>e.provider===r));return Object.assign({},l,{providerName:a[r]})}var Rt={getInvalidInputName:function(){return["test","测试","abc","asd","sdf","common","uni-clientDB-actions"]},validateName:function(e){return/^[_a-zA-Z][a-zA-Z0-9_-]{0,29}$/.test(e)},sessionInit:async function(e,t=!1,n){const{beforeRestart:i=null,beforeStop:o=null}=n,r="debug"===e.mode,s=`${e.workspaceFolder.id}-unicloud`,a=`[${e.workspaceFolder.name}] - unicloud控制台`;return r?e.init({autoDelete:!0,consoleOptions:{id:s,title:a,toolbarItems:[{type:"button",when:`viewId == '${s}' && (session.state == 'STARTING' || session.state == 'STARTED')`,icon:{normal:"hxtheme://restart.png",hover:"hxtheme://restart.png"},label:"restart",tooltips:"重新运行",onClick:async function(){console.log(e.state),i&&await i(),"STARTING"!==e.state&&"STARTED"!==e.state||e.stop().then((()=>{"STOPPING"!==e.state&&"STOPPED"!==e.state||e.start()})),console.log(e.state)}},{type:"button",when:`viewId == '${s}' && (session.state == 'STARTING' || session.state == 'STARTED')`,icon:{normal:"hxtheme://stop.png",hover:"hxtheme://stop.png"},label:"stop",tooltips:"停止运行",onClick:async function(){console.log(e.state),o&&await o(),"STOPPING"!==e.state&&"STOPPED"!==e.state&&await e.stop(),console.log(e.state)}}]}},t):e.init({autoDelete:!0,consoleOptions:{id:`${e.workspaceFolder.id}-unicloud`,title:`[${e.workspaceFolder.name}] - unicloud控制台`,toolbarItems:[]}},t)},getSpaceInfo:async function(e,t,n="云函数"){let i={code:0,msg:"",provider:"",spaceName:"",spaceId:""};const o="请先绑定服务空间",r=`当前${n}仅支持腾讯云(tcb)云开发环境,请先为腾讯云(tcb)云开发环境绑定服务空间`,s=`当前${n}仅支持阿里云(aliyun)云开发环境,请先为阿里云(aliyun)云开发环境绑定服务空间`,a=`当前${n}仅支持腾讯云(tcb)云开发环境,默认使用腾讯云(tcb)云开发环境`,c=`当前${n}仅支持阿里云(aliyun)云开发环境,默认使用阿里云(aliyun)云开发环境`,l=`当前${n}仅支持支付宝云(alipay)云开发环境,默认使用支付宝云(alipay)云开发环境`,u=`当前${n}仅支持支付宝云(alipay)云开发环境,请先为支付宝云(alipay)云开发环境绑定服务空间`;let d=!1,p=jt.dirname(t);p=jt.dirname(p);let f=jt.basename(p).split("-")[1];"aliyun"!==f&&"tcb"!==f&&"alipay"!==f&&(d=!0);let h=null;try{h=await Pt({workspaceFolder:e})}catch(e){return i.code=-1,i.msg=o,i}if(!h||h.allSpaces.length<=0)return i.code=-1,i.msg=o,i;if(!d){let e=h.allSpaces.find((e=>e.provider===f));return e&&e.spaceName&&e.spaceId?(i.provider=f,i.spaceName=e.spaceName,i.spaceId=e.spaceId):(i.code=-1,i.msg=o),i}let m=function(e){if(null===e.match(/uni_modules/g))return Lt.BOTH;let t=jt.dirname(e);t=jt.dirname(t),t=jt.dirname(t);let n=jt.join(t,"package.json");if(!Ot.existsSync(n))return Lt.BOTH;let i=Ot.readFileSync(n,{encoding:"utf-8"}).toString();try{let e=JSON.parse(i),t=e.uni_modules.platforms.cloud;if(e&&t){let e="y"===t.tcb,n="y"===t.aliyun,i="y"===t.alipay;return!e||n||i?e||!n||i?e||n||!i?Lt.BOTH:Lt.ALIPAY:Lt.ALIYUN:Lt.TCB}}catch(e){return Lt.BOTH}return Lt.BOTH}(t);if(m===Lt.BOTH){let e=[],t=h.allSpaces.find((e=>e.provider===Lt.toString(Lt.ALIYUN))),n=!!(t&&t.spaceName&&t.spaceId);if(e.push({isBind:n,provider:Lt.toString(Lt.ALIYUN),spaceName:n?t.spaceName:"未绑定服务空间",spaceId:n?t.spaceId:""}),t=h.allSpaces.find((e=>e.provider===Lt.toString(Lt.TCB))),n=!!(t&&t.spaceName&&t.spaceId),e.push({isBind:n,provider:Lt.toString(Lt.TCB),spaceName:n?t.spaceName:"未绑定服务空间",spaceId:n?t.spaceId:""}),t=h.allSpaces.find((e=>e.provider===Lt.toString(Lt.ALIPAY))),n=!!(t&&t.spaceName&&t.spaceId),e.push({isBind:n,provider:Lt.toString(Lt.ALIPAY),spaceName:n?t.spaceName:"未绑定服务空间",spaceId:n?t.spaceId:""}),1===h.allSpaces.length){const e=h.allSpaces[0];return i.provider=e.provider,i.spaceName=e.spaceName,i.spaceId=e.spaceId,i}function r(e){let t=[];return e.spaces.forEach((e=>{t.push({columns:[{label:e.provider},{label:e.spaceName}]})})),{title:"选择服务商",footer:"",formItems:[{type:"list",name:"spaceList",title:"",columnStretches:[1,1],items:t,value:0}]}}const s="取消(&C)",a="确定(&O)",c=await It.window.showFormDialog({...r({spaces:e}),width:330,height:350,customButtons:[{text:s},{text:a,role:"accept"}],onOpened:async function(){},onChanged:async function(){},validate:async function(e){return-1!==e.spaceList||(this.showError("请选择服务商"),!1)}});return 0===c.buttonIndex?(i.code=-2,i):(t=e[c.result.spaceList],t.isBind?(i.provider=t.provider,i.spaceName=t.spaceName,i.spaceId=t.spaceId,i):(i.code=-1,i.msg=o,i))}{f=Lt.toString(m);let e=h.allSpaces.find((e=>e.provider===f));return e&&e.spaceName&&e.spaceId?(i.msg=m===Lt.TCB?a:m===Lt.ALIYUN?c:l,i.provider=f,i.spaceName=e.spaceName,i.spaceId=e.spaceId,i):(i.code=-1,i.msg=(g=m)===Lt.TCB?r:g===Lt.ALIYUN?s:u,i)}var g},providerToCN:Nt,resolveFunctionOrObjectName:Ft,resolveCloudFunctionOrObjectPath:Tt,isCloudObject:function(e){let t=Tt(e);return!!t&&Ot.existsSync(jt.join(t,"index.obj.js"))},isUniModule:function(e){try{if(/(?<=(\/|\\)uni_modules(\/|\\))\.*/g.test(e)&&Ot.existsSync(e))return!0}catch(e){}return!1},resolveUniModuleName:Dt,resolveUniModuleRootPath:function(e){let t=Dt(e);if(t){let n=new RegExp(`.*uni_modules(/|\\\\)(?=${t})`),i=e.match(n);if(i&&i.length>0){let e=i[0];return jt.join(e,t)}}},copyDir:function e(t,n,i){Ot.existsSync(n)||Ot.mkdirSync(n,{recursive:!0}),Ot.readdirSync(t).forEach((function(o){let r=jt.join(t,o),s=jt.join(n,o);Ot.statSync(r).isFile()?Ot.copyFileSync(r,s):Ot.statSync(r).isDirectory()&&(i.includes(o)||e(r,s,i))}))},getUniModuleId:function(e){const t=(e=e.replace(/\\/g,"/")).match(/uni_modules\/(.*?)\//);return t&&t[1]||""},getCommonContext:async function(e){const{workspaceFolder:t}=e,n={};n.outputView=It.window.createOutputView({id:`${t.id}-unicloud`,title:`[${t.name}] - unicloud控制台`});try{n.currentSpace=await $t(e)}catch(e){throw n.outputView.show(),n.outputView.appendLine({level:"error",line:e.message}),e}return n},getBindSpace:$t,findNpmCli:function(){return jt.resolve(process.env.UNICLOUD_DEBUGGER_PATH,"../npm/node_modules/npm/bin/npm-cli.js")},genUniCloudProjectAliasName:function(e,t){return`${Nt(e)}:${t}`},isCliProject:function(e){return!["package.json","src/pages.json","src/manifest.json","src/App.vue"].find((t=>!Ot.existsSync(jt.resolve(e,t))))}},At={exports:{}},Bt={},Mt=Bt.require=function(){if("object"==typeof process&&process.versions&&process.versions.electron)try{const e=Mt("original-fs");if(Object.keys(e).length>0)return e}catch(e){}return O.default},Ut={LOCHDR:30,LOCSIG:67324752,LOCVER:4,LOCFLG:6,LOCHOW:8,LOCTIM:10,LOCCRC:14,LOCSIZ:18,LOCLEN:22,LOCNAM:26,LOCEXT:28,EXTSIG:134695760,EXTHDR:16,EXTCRC:4,EXTSIZ:8,EXTLEN:12,CENHDR:46,CENSIG:33639248,CENVEM:4,CENVER:6,CENFLG:8,CENHOW:10,CENTIM:12,CENCRC:16,CENSIZ:20,CENLEN:24,CENNAM:28,CENEXT:30,CENCOM:32,CENDSK:34,CENATT:36,CENATX:38,CENOFF:42,ENDHDR:22,ENDSIG:101010256,ENDSUB:8,ENDTOT:10,ENDSIZ:12,ENDOFF:16,ENDCOM:20,END64HDR:20,END64SIG:117853008,END64START:4,END64OFF:8,END64NUMDISKS:16,ZIP64SIG:101075792,ZIP64HDR:56,ZIP64LEAD:12,ZIP64SIZE:4,ZIP64VEM:12,ZIP64VER:14,ZIP64DSK:16,ZIP64DSKDIR:20,ZIP64SUB:24,ZIP64TOT:32,ZIP64SIZB:40,ZIP64OFF:48,ZIP64EXTRA:56,STORED:0,SHRUNK:1,REDUCED1:2,REDUCED2:3,REDUCED3:4,REDUCED4:5,IMPLODED:6,DEFLATED:8,ENHANCED_DEFLATED:9,PKWARE:10,BZIP2:12,LZMA:14,IBM_TERSE:18,IBM_LZ77:19,AES_ENCRYPT:99,FLG_ENC:1,FLG_COMP1:2,FLG_COMP2:4,FLG_DESC:8,FLG_ENH:16,FLG_PATCH:32,FLG_STR:64,FLG_EFS:2048,FLG_MSK:4096,FILE:2,BUFFER:1,NONE:0,EF_ID:0,EF_SIZE:2,ID_ZIP64:1,ID_AVINFO:7,ID_PFS:8,ID_OS2:9,ID_NTFS:10,ID_OPENVMS:12,ID_UNIX:13,ID_FORK:14,ID_PATCH:15,ID_X509_PKCS7:20,ID_X509_CERTID_F:21,ID_X509_CERTID_C:22,ID_STRONGENC:23,ID_RECORD_MGT:24,ID_X509_PKCS7_RL:25,ID_IBM1:101,ID_IBM2:102,ID_POSZIP:18064,EF_ZIP64_OR_32:4294967295,EF_ZIP64_OR_16:65535,EF_ZIP64_SUNCOMP:0,EF_ZIP64_SCOMP:8,EF_ZIP64_RHO:16,EF_ZIP64_DSN:24};const qt=Bt.require(),Wt=E.default,Jt=Ut,Ht="object"==typeof process&&"win32"===process.platform,Vt=e=>e&&"object"==typeof e,zt=new Uint32Array(256).map(((e,t)=>{for(let e=0;e<8;e++)0!=(1&t)?t=3988292384^t>>>1:t>>>=1;return t>>>0}));function Gt(e){this.sep=Wt.sep,this.fs=qt,Vt(e)&&Vt(e.fs)&&"function"==typeof e.fs.statSync&&(this.fs=e.fs)}var Kt=Gt;Gt.prototype.makeDir=function(e){const t=this;!function(e){let n=e.split(t.sep)[0];e.split(t.sep).forEach((function(e){if(e&&":"!==e.substr(-1,1)){var i;n+=t.sep+e;try{i=t.fs.statSync(n)}catch(e){t.fs.mkdirSync(n)}if(i&&i.isFile())throw Errors.FILE_IN_THE_WAY.replace("%s",n)}}))}(e)},Gt.prototype.writeFileTo=function(e,t,n,i){const o=this;if(o.fs.existsSync(e)){if(!n)return!1;if(o.fs.statSync(e).isDirectory())return!1}var r,s=Wt.dirname(e);o.fs.existsSync(s)||o.makeDir(s);try{r=o.fs.openSync(e,"w",438)}catch(t){o.fs.chmodSync(e,438),r=o.fs.openSync(e,"w",438)}if(r)try{o.fs.writeSync(r,t,0,t.length,0)}finally{o.fs.closeSync(r)}return o.fs.chmodSync(e,i||438),!0},Gt.prototype.writeFileToAsync=function(e,t,n,i,o){"function"==typeof i&&(o=i,i=void 0);const r=this;r.fs.exists(e,(function(s){if(s&&!n)return o(!1);r.fs.stat(e,(function(n,a){if(s&&a.isDirectory())return o(!1);var c=Wt.dirname(e);r.fs.exists(c,(function(n){n||r.makeDir(c),r.fs.open(e,"w",438,(function(n,s){n?r.fs.chmod(e,438,(function(){r.fs.open(e,"w",438,(function(n,s){r.fs.write(s,t,0,t.length,0,(function(){r.fs.close(s,(function(){r.fs.chmod(e,i||438,(function(){o(!0)}))}))}))}))})):s?r.fs.write(s,t,0,t.length,0,(function(){r.fs.close(s,(function(){r.fs.chmod(e,i||438,(function(){o(!0)}))}))})):r.fs.chmod(e,i||438,(function(){o(!0)}))}))}))}))}))},Gt.prototype.findFiles=function(e){const t=this;return function e(n,i,o){"boolean"==typeof i&&(o=i,i=void 0);let r=[];return t.fs.readdirSync(n).forEach((function(s){var a=Wt.join(n,s);t.fs.statSync(a).isDirectory()&&o&&(r=r.concat(e(a,i,o))),i&&!i.test(a)||r.push(Wt.normalize(a)+(t.fs.statSync(a).isDirectory()?t.sep:""))})),r}(e,void 0,!0)},Gt.prototype.getAttributes=function(){},Gt.prototype.setAttributes=function(){},Gt.crc32update=function(e,t){return zt[255&(e^t)]^e>>>8},Gt.crc32=function(e){"string"==typeof e&&(e=Buffer.from(e,"utf8")),zt.length||genCRCTable();let t=e.length,n=-1;for(let i=0;i<t;)n=Gt.crc32update(n,e[i++]);return~n>>>0},Gt.methodToString=function(e){switch(e){case Jt.STORED:return"STORED ("+e+")";case Jt.DEFLATED:return"DEFLATED ("+e+")";default:return"UNSUPPORTED ("+e+")"}},Gt.canonical=function(e){if(!e)return"";var t=Wt.posix.normalize("/"+e.split("\\").join("/"));return Wt.join(".",t)},Gt.sanitize=function(e,t){e=Wt.resolve(Wt.normalize(e));for(var n=t.split("/"),i=0,o=n.length;i<o;i++){var r=Wt.normalize(Wt.join(e,n.slice(i,o).join(Wt.sep)));if(0===r.indexOf(e))return r}return Wt.normalize(Wt.join(e,Wt.basename(t)))},Gt.toBuffer=function(e){return Buffer.isBuffer(e)?e:e instanceof Uint8Array?Buffer.from(e):"string"==typeof e?Buffer.from(e,"utf8"):Buffer.alloc(0)},Gt.readBigUInt64LE=function(e,t){var n=Buffer.from(e.slice(t,t+8));return n.swap64(),parseInt(`0x${n.toString("hex")}`)},Gt.isWin=Ht,Gt.crcTable=zt;const Zt=Bt.require(),Yt=E.default;Zt.existsSync=Zt.existsSync||Yt.existsSync,At.exports=Kt,At.exports.Constants=Ut,At.exports.Errors={INVALID_LOC:"Invalid LOC header (bad signature)",INVALID_CEN:"Invalid CEN header (bad signature)",INVALID_END:"Invalid END header (bad signature)",NO_DATA:"Nothing to decompress",BAD_CRC:"CRC32 checksum failed",FILE_IN_THE_WAY:"There is a file in the way: %s",UNKNOWN_METHOD:"Invalid/unsupported compression method",AVAIL_DATA:"inflate::Available inflate data did not terminate",INVALID_DISTANCE:"inflate::Invalid literal/length or distance code in fixed or dynamic block",TO_MANY_CODES:"inflate::Dynamic block code description: too many length or distance codes",INVALID_REPEAT_LEN:"inflate::Dynamic block code description: repeat more than specified lengths",INVALID_REPEAT_FIRST:"inflate::Dynamic block code description: repeat lengths with no first length",INCOMPLETE_CODES:"inflate::Dynamic block code description: code lengths codes incomplete",INVALID_DYN_DISTANCE:"inflate::Dynamic block code description: invalid distance code lengths",INVALID_CODES_LEN:"inflate::Dynamic block code description: invalid literal/length code lengths",INVALID_STORE_BLOCK:"inflate::Stored block length did not match one's complement",INVALID_BLOCK_TYPE:"inflate::Invalid block type (type == 3)",CANT_EXTRACT_FILE:"Could not extract the file",CANT_OVERRIDE:"Target file already exists",NO_ZIP:"No zip file was loaded",NO_ENTRY:"Entry doesn't exist",DIRECTORY_CONTENT_ERROR:"A directory cannot have content",FILE_NOT_FOUND:"File not found: %s",NOT_IMPLEMENTED:"Not implemented",INVALID_FILENAME:"Invalid filename",INVALID_FORMAT:"Invalid or unsupported zip format. No END header found"},At.exports.FileAttr=function(e){var t=e||"",n={directory:!1,readonly:!1,hidden:!1,executable:!1,mtime:0,atime:0},i=null;return t&&Zt.existsSync(t)?(i=Zt.statSync(t),n.directory=i.isDirectory(),n.mtime=i.mtime,n.atime=i.atime,n.executable=0!=(73&i.mode),n.readonly=0==(128&i.mode),n.hidden="."===Yt.basename(t)[0]):console.warn("Invalid path: "+t),{get directory(){return n.directory},get readOnly(){return n.readonly},get hidden(){return n.hidden},get mtime(){return n.mtime},get atime(){return n.atime},get executable(){return n.executable},decodeAttributes:function(){},encodeAttributes:function(){},toJSON:function(){return{path:t,isDirectory:n.directory,isReadOnly:n.readonly,isHidden:n.hidden,isExecutable:n.executable,mTime:n.mtime,aTime:n.atime}},toString:function(){return JSON.stringify(this.toJSON(),null,"\t")}}};var Xt={},Qt=At.exports,en=Qt.Constants,tn=At.exports,nn=tn.Constants;Xt.EntryHeader=function(){var e=20,t=10,n=0,i=0,o=0,r=0,s=0,a=0,c=0,l=0,u=0,d=0,p=0,f=0,h=0;e|=Qt.isWin?2560:768,n|=en.FLG_EFS;var m={};function g(e){e=new Date(e),o=(e.getFullYear()-1980&127)<<25|e.getMonth()+1<<21|e.getDate()<<16|e.getHours()<<11|e.getMinutes()<<5|e.getSeconds()>>1}return g(+new Date),{get made(){return e},set made(t){e=t},get version(){return t},set version(e){t=e},get flags(){return n},set flags(e){n=e},get method(){return i},set method(e){switch(e){case en.STORED:this.version=10;case en.DEFLATED:default:this.version=20}i=e},get time(){return new Date(1980+(o>>25&127),(o>>21&15)-1,o>>16&31,o>>11&31,o>>5&63,(31&o)<<1)},set time(e){g(e)},get crc(){return r},set crc(e){r=Math.max(0,e)>>>0},get compressedSize(){return s},set compressedSize(e){s=Math.max(0,e)>>>0},get size(){return a},set size(e){a=Math.max(0,e)>>>0},get fileNameLength(){return c},set fileNameLength(e){c=e},get extraLength(){return l},set extraLength(e){l=e},get commentLength(){return u},set commentLength(e){u=e},get diskNumStart(){return d},set diskNumStart(e){d=Math.max(0,e)>>>0},get inAttr(){return p},set inAttr(e){p=Math.max(0,e)>>>0},get attr(){return f},set attr(e){f=Math.max(0,e)>>>0},get fileAttr(){return f?(f>>>0|0)>>16&4095:0},get offset(){return h},set offset(e){h=Math.max(0,e)>>>0},get encripted(){return 1==(1&n)},get entryHeaderSize(){return en.CENHDR+c+l+u},get realDataOffset(){return h+en.LOCHDR+m.fnameLen+m.extraLen},get dataHeader(){return m},loadDataHeaderFromBinary:function(e){var t=e.slice(h,h+en.LOCHDR);if(t.readUInt32LE(0)!==en.LOCSIG)throw new Error(Qt.Errors.INVALID_LOC);m={version:t.readUInt16LE(en.LOCVER),flags:t.readUInt16LE(en.LOCFLG),method:t.readUInt16LE(en.LOCHOW),time:t.readUInt32LE(en.LOCTIM),crc:t.readUInt32LE(en.LOCCRC),compressedSize:t.readUInt32LE(en.LOCSIZ),size:t.readUInt32LE(en.LOCLEN),fnameLen:t.readUInt16LE(en.LOCNAM),extraLen:t.readUInt16LE(en.LOCEXT)}},loadFromBinary:function(m){if(m.length!==en.CENHDR||m.readUInt32LE(0)!==en.CENSIG)throw new Error(Qt.Errors.INVALID_CEN);e=m.readUInt16LE(en.CENVEM),t=m.readUInt16LE(en.CENVER),n=m.readUInt16LE(en.CENFLG),i=m.readUInt16LE(en.CENHOW),o=m.readUInt32LE(en.CENTIM),r=m.readUInt32LE(en.CENCRC),s=m.readUInt32LE(en.CENSIZ),a=m.readUInt32LE(en.CENLEN),c=m.readUInt16LE(en.CENNAM),l=m.readUInt16LE(en.CENEXT),u=m.readUInt16LE(en.CENCOM),d=m.readUInt16LE(en.CENDSK),p=m.readUInt16LE(en.CENATT),f=m.readUInt32LE(en.CENATX),h=m.readUInt32LE(en.CENOFF)},dataHeaderToBinary:function(){var e=Buffer.alloc(en.LOCHDR);return e.writeUInt32LE(en.LOCSIG,0),e.writeUInt16LE(t,en.LOCVER),e.writeUInt16LE(n,en.LOCFLG),e.writeUInt16LE(i,en.LOCHOW),e.writeUInt32LE(o,en.LOCTIM),e.writeUInt32LE(r,en.LOCCRC),e.writeUInt32LE(s,en.LOCSIZ),e.writeUInt32LE(a,en.LOCLEN),e.writeUInt16LE(c,en.LOCNAM),e.writeUInt16LE(l,en.LOCEXT),e},entryHeaderToBinary:function(){var m=Buffer.alloc(en.CENHDR+c+l+u);return m.writeUInt32LE(en.CENSIG,0),m.writeUInt16LE(e,en.CENVEM),m.writeUInt16LE(t,en.CENVER),m.writeUInt16LE(n,en.CENFLG),m.writeUInt16LE(i,en.CENHOW),m.writeUInt32LE(o,en.CENTIM),m.writeUInt32LE(r,en.CENCRC),m.writeUInt32LE(s,en.CENSIZ),m.writeUInt32LE(a,en.CENLEN),m.writeUInt16LE(c,en.CENNAM),m.writeUInt16LE(l,en.CENEXT),m.writeUInt16LE(u,en.CENCOM),m.writeUInt16LE(d,en.CENDSK),m.writeUInt16LE(p,en.CENATT),m.writeUInt32LE(f,en.CENATX),m.writeUInt32LE(h,en.CENOFF),m.fill(0,en.CENHDR),m},toJSON:function(){const o=function(e){return e+" bytes"};return{made:e,version:t,flags:n,method:Qt.methodToString(i),time:this.time,crc:"0x"+r.toString(16).toUpperCase(),compressedSize:o(s),size:o(a),fileNameLength:o(c),extraLength:o(l),commentLength:o(u),diskNumStart:d,inAttr:p,attr:f,offset:h,entryHeaderSize:o(en.CENHDR+c+l+u)}},toString:function(){return JSON.stringify(this.toJSON(),null,"\t")}}},Xt.MainHeader=function(){var e=0,t=0,n=0,i=0,o=0;return{get diskEntries(){return e},set diskEntries(n){e=t=n},get totalEntries(){return t},set totalEntries(n){t=e=n},get size(){return n},set size(e){n=e},get offset(){return i},set offset(e){i=e},get commentLength(){return o},set commentLength(e){o=e},get mainHeaderSize(){return nn.ENDHDR+o},loadFromBinary:function(r){if((r.length!==nn.ENDHDR||r.readUInt32LE(0)!==nn.ENDSIG)&&(r.length<nn.ZIP64HDR||r.readUInt32LE(0)!==nn.ZIP64SIG))throw new Error(tn.Errors.INVALID_END);r.readUInt32LE(0)===nn.ENDSIG?(e=r.readUInt16LE(nn.ENDSUB),t=r.readUInt16LE(nn.ENDTOT),n=r.readUInt32LE(nn.ENDSIZ),i=r.readUInt32LE(nn.ENDOFF),o=r.readUInt16LE(nn.ENDCOM)):(e=tn.readBigUInt64LE(r,nn.ZIP64SUB),t=tn.readBigUInt64LE(r,nn.ZIP64TOT),n=tn.readBigUInt64LE(r,nn.ZIP64SIZ),i=tn.readBigUInt64LE(r,nn.ZIP64OFF),o=0)},toBinary:function(){var r=Buffer.alloc(nn.ENDHDR+o);return r.writeUInt32LE(nn.ENDSIG,0),r.writeUInt32LE(0,4),r.writeUInt16LE(e,nn.ENDSUB),r.writeUInt16LE(t,nn.ENDTOT),r.writeUInt32LE(n,nn.ENDSIZ),r.writeUInt32LE(i,nn.ENDOFF),r.writeUInt16LE(o,nn.ENDCOM),r.fill(" ",nn.ENDHDR),r},toJSON:function(){return{diskEntries:e,totalEntries:t,size:n+" bytes",offset:function(e,t){let n=e.toString(16).toUpperCase();for(;n.length<4;)n="0"+n;return"0x"+n}(i),commentLength:o}},toString:function(){return JSON.stringify(this.toJSON(),null,"\t")}}};var on={};const{randomFillSync:rn}=$.default,sn=new Uint32Array(256).map(((e,t)=>{for(let e=0;e<8;e++)0!=(1&t)?t=t>>>1^3988292384:t>>>=1;return t>>>0})),an=(e,t)=>Math.imul(e,t)>>>0,cn=(e,t)=>sn[255&(e^t)]^e>>>8,ln=()=>"function"==typeof rn?rn(Buffer.alloc(12)):ln.node();ln.node=()=>{const e=Buffer.alloc(12),t=e.length;for(let n=0;n<t;n++)e[n]=256*Math.random()&255;return e};const un={genSalt:ln};function dn(e){const t=Buffer.isBuffer(e)?e:Buffer.from(e);this.keys=new Uint32Array([305419896,591751049,878082192]);for(let e=0;e<t.length;e++)this.updateKeys(t[e])}dn.prototype.updateKeys=function(e){const t=this.keys;return t[0]=cn(t[0],e),t[1]+=255&t[0],t[1]=an(t[1],134775813)+1,t[2]=cn(t[2],t[1]>>>24),e},dn.prototype.next=function(){const e=(2|this.keys[2])>>>0;return an(e,1^e)>>8&255};var pn={decrypt:function(e,t,n){if(!e||!Buffer.isBuffer(e)||e.length<12)return Buffer.alloc(0);const i=function(e){const t=new dn(e);return function(e){const n=Buffer.alloc(e.length);let i=0;for(let o of e)n[i++]=t.updateKeys(o^t.next());return n}}(n);if(i(e.slice(0,12))[11]!==t.crc>>>24)throw"ADM-ZIP: Wrong Password";return i(e.slice(12))},encrypt:function(e,t,n,i=!1){null==e&&(e=Buffer.alloc(0)),Buffer.isBuffer(e)||(e=Buffer.from(e.toString()));const o=function(e){const t=new dn(e);return function(e,n,i=0){n||(n=Buffer.alloc(e.length));for(let o of e){const e=t.next();n[i++]=o^e,t.updateKeys(o)}return n}}(n),r=un.genSalt();r[11]=t.crc>>>24&255,i&&(r[10]=t.crc>>>16&255);const s=Buffer.alloc(e.length+12);return o(r,s),o(e,s,12)},_salter:function(e){Buffer.isBuffer(e)&&e.length>=12?un.genSalt=function(){return e.slice(0,12)}:un.genSalt="node"===e?ln.node:ln}};on.Deflater=function(e){var t=D.default,n={chunkSize:1024*(parseInt(e.length/1024)+1)};return{deflate:function(){return t.deflateRawSync(e,n)},deflateAsync:function(i){var o=t.createDeflateRaw(n),r=[],s=0;o.on("data",(function(e){r.push(e),s+=e.length})),o.on("end",(function(){var e=Buffer.alloc(s),t=0;e.fill(0);for(var n=0;n<r.length;n++){var o=r[n];o.copy(e,t),t+=o.length}i&&i(e)})),o.end(e)}}},on.Inflater=function(e){var t=D.default;return{inflate:function(){return t.inflateRawSync(e)},inflateAsync:function(n){var i=t.createInflateRaw(),o=[],r=0;i.on("data",(function(e){o.push(e),r+=e.length})),i.on("end",(function(){var e=Buffer.alloc(r),t=0;e.fill(0);for(var i=0;i<o.length;i++){var s=o[i];s.copy(e,t),t+=s.length}n&&n(e)})),i.end(e)}}},on.ZipCrypto=pn;var fn=At.exports,hn=Xt,mn=fn.Constants,gn=on,yn=function(e){var t=new hn.EntryHeader,n=Buffer.alloc(0),i=Buffer.alloc(0),o=!1,r=null,s=Buffer.alloc(0);function a(){return e&&Buffer.isBuffer(e)?(t.loadDataHeaderFromBinary(e),e.slice(t.realDataOffset,t.realDataOffset+t.compressedSize)):Buffer.alloc(0)}function c(e){return 8==(8&t.flags)||fn.crc32(e)===t.dataHeader.crc}function l(e,i,r){if(void 0===i&&"string"==typeof e&&(r=e,e=void 0),o)return e&&i&&i(Buffer.alloc(0),fn.Errors.DIRECTORY_CONTENT_ERROR),Buffer.alloc(0);var s=a();if(0===s.length)return e&&i&&i(s),s;if(t.encripted){if("string"!=typeof r&&!Buffer.isBuffer(r))throw new Error("ADM-ZIP: Incompatible password parameter");s=gn.ZipCrypto.decrypt(s,t,r)}var l=Buffer.alloc(t.size);switch(t.method){case fn.Constants.STORED:if(s.copy(l),c(l))return e&&i&&i(l),l;throw e&&i&&i(l,fn.Errors.BAD_CRC),new Error(fn.Errors.BAD_CRC);case fn.Constants.DEFLATED:var u=new gn.Inflater(s);if(!e){if(u.inflate(l).copy(l,0),!c(l))throw new Error(fn.Errors.BAD_CRC+" "+n.toString());return l}u.inflateAsync((function(e){e.copy(e,0),i&&(c(e)?i(e):i(e,fn.Errors.BAD_CRC))}));break;default:throw e&&i&&i(Buffer.alloc(0),fn.Errors.UNKNOWN_METHOD),new Error(fn.Errors.UNKNOWN_METHOD)}}function u(n,i){if((!r||!r.length)&&Buffer.isBuffer(e))return n&&i&&i(a()),a();if(r.length&&!o){var s;switch(t.method){case fn.Constants.STORED:return t.compressedSize=t.size,s=Buffer.alloc(r.length),r.copy(s),n&&i&&i(s),s;default:case fn.Constants.DEFLATED:var c=new gn.Deflater(r);if(!n){var l=c.deflate();return t.compressedSize=l.length,l}c.deflateAsync((function(e){s=Buffer.alloc(e.length),t.compressedSize=e.length,e.copy(s),i&&i(s)})),c=null}}else{if(!n||!i)return Buffer.alloc(0);i(Buffer.alloc(0))}}function d(e,t){return(e.readUInt32LE(t+4)<<4)+e.readUInt32LE(t)}function p(e){var n,i,o,r;e.length>=mn.EF_ZIP64_SCOMP&&(n=d(e,mn.EF_ZIP64_SUNCOMP),t.size===mn.EF_ZIP64_OR_32&&(t.size=n)),e.length>=mn.EF_ZIP64_RHO&&(i=d(e,mn.EF_ZIP64_SCOMP),t.compressedSize===mn.EF_ZIP64_OR_32&&(t.compressedSize=i)),e.length>=mn.EF_ZIP64_DSN&&(o=d(e,mn.EF_ZIP64_RHO),t.offset===mn.EF_ZIP64_OR_32&&(t.offset=o)),e.length>=mn.EF_ZIP64_DSN+4&&(r=e.readUInt32LE(mn.EF_ZIP64_DSN),t.diskNumStart===mn.EF_ZIP64_OR_16&&(t.diskNumStart=r))}return{get entryName(){return n.toString()},get rawEntryName(){return n},set entryName(e){var i=(n=fn.toBuffer(e))[n.length-1];o=47===i||92===i,t.fileNameLength=n.length},get extra(){return s},set extra(e){s=e,t.extraLength=e.length,function(e){for(var t,n,i,o=0;o<e.length;)t=e.readUInt16LE(o),o+=2,n=e.readUInt16LE(o),o+=2,i=e.slice(o,o+n),o+=n,mn.ID_ZIP64===t&&p(i)}(e)},get comment(){return i.toString()},set comment(e){i=fn.toBuffer(e),t.commentLength=i.length},get name(){var e=n.toString();return o?e.substr(e.length-1).split("/").pop():e.split("/").pop()},get isDirectory(){return o},getCompressedData:function(){return u(!1,null)},getCompressedDataAsync:function(e){u(!0,e)},setData:function(e){r=fn.toBuffer(e),!o&&r.length?(t.size=r.length,t.method=fn.Constants.DEFLATED,t.crc=fn.crc32(e),t.changed=!0):t.method=fn.Constants.STORED},getData:function(e){return t.changed?r:l(!1,null,e)},getDataAsync:function(e,n){t.changed?e(r):l(!0,e,n)},set attr(e){t.attr=e},get attr(){return t.attr},set header(e){t.loadFromBinary(e)},get header(){return t},packHeader:function(){var e=t.entryHeaderToBinary(),o=fn.Constants.CENHDR;return n.copy(e,o),o+=n.length,t.extraLength&&(s.copy(e,o),o+=t.extraLength),t.commentLength&&i.copy(e,o),e},toJSON:function(){const n=function(e){return"<"+(e&&e.length+" bytes buffer"||"null")+">"};return{entryName:this.entryName,name:this.name,comment:this.comment,isDirectory:this.isDirectory,header:t.toJSON(),compressedData:n(e),data:n(r)}},toString:function(){return JSON.stringify(this.toJSON(),null,"\t")}}};const vn=yn,wn=Xt,xn=At.exports,bn=At.exports,Sn=E.default,kn=yn,En=function(e,t){var n=[],i={},o=Buffer.alloc(0),r=new wn.MainHeader,s=!1;const a=Object.assign(Object.create(null),t),{noSort:c}=a;function l(){s=!0,i={},n=new Array(r.diskEntries);for(var t=r.offset,o=0;o<n.length;o++){var a=t,c=new vn(e);c.header=e.slice(a,a+=xn.Constants.CENHDR),c.entryName=e.slice(a,a+=c.header.fileNameLength),c.header.extraLength&&(c.extra=e.slice(a,a+=c.header.extraLength)),c.header.commentLength&&(c.comment=e.slice(a,a+c.header.commentLength)),t+=c.header.entryHeaderSize,n[o]=c,i[c.entryName]=c}}function u(){n.length>1&&!c&&n.sort(((e,t)=>e.entryName.toLowerCase().localeCompare(t.entryName.toLowerCase())))}return e?function(t){for(var n=e.length-xn.Constants.ENDHDR,i=Math.max(0,n-65535),s=i,a=e.length,c=-1,u=0;n>=s;n--)if(80===e[n])if(e.readUInt32LE(n)!==xn.Constants.ENDSIG)if(e.readUInt32LE(n)!==xn.Constants.END64SIG){if(e.readUInt32LE(n)===xn.Constants.ZIP64SIG){c=n,a=n+xn.readBigUInt64LE(e,n+xn.Constants.ZIP64SIZE)+xn.Constants.ZIP64LEAD;break}}else s=i;else c=n,u=n,a=n+xn.Constants.ENDHDR,s=n-xn.Constants.END64HDR;if(!~c)throw new Error(xn.Errors.INVALID_FORMAT);r.loadFromBinary(e.slice(c,a)),r.commentLength&&(o=e.slice(u+xn.Constants.ENDHDR)),t&&l()}(a.readEntries):s=!0,{get entries(){return s||l(),n},get comment(){return o.toString()},set comment(e){o=xn.toBuffer(e),r.commentLength=o.length},getEntryCount:function(){return s?n.length:r.diskEntries},forEach:function(t){s?n.forEach(t):function(t){const n=r.diskEntries;let i=r.offset;for(let o=0;o<n;o++){let n=i;const o=new vn(e);o.header=e.slice(n,n+=xn.Constants.CENHDR),o.entryName=e.slice(n,n+=o.header.fileNameLength),i+=o.header.entryHeaderSize,t(o)}}(t)},getEntry:function(e){return s||l(),i[e]||null},setEntry:function(e){s||l(),n.push(e),i[e.entryName]=e,r.totalEntries=n.length},deleteEntry:function(e){s||l();var t=i[e];if(t&&t.isDirectory){var o=this;this.getEntryChildren(t).forEach((function(t){t.entryName!==e&&o.deleteEntry(t.entryName)}))}n.splice(n.indexOf(t),1),delete i[e],r.totalEntries=n.length},getEntryChildren:function(e){if(s||l(),e&&e.isDirectory){const t=[],i=e.entryName,o=i.length;return n.forEach((function(e){e.entryName.substr(0,o)===i&&t.push(e)})),t}return[]},compressToBuffer:function(){s||l(),u();const e=[],t=[];let i=0,a=0;r.size=0,r.offset=0;for(const o of n){const n=o.getCompressedData();o.header.offset=a;const s=o.header.dataHeaderToBinary(),c=o.rawEntryName.length,l=Buffer.alloc(c+o.extra.length);o.rawEntryName.copy(l,0),l.copy(o.extra,c);const u=s.length+l.length+n.length;a+=u,e.push(s),e.push(l),e.push(n);const d=o.packHeader();t.push(d),r.size+=d.length,i+=u+d.length}i+=r.mainHeaderSize,r.offset=a,a=0;const c=Buffer.alloc(i);for(const t of e)t.copy(c,a),a+=t.length;for(const e of t)e.copy(c,a),a+=e.length;const d=r.toBinary();return o&&o.copy(d,xn.Constants.ENDHDR),d.copy(c,a),c},toAsyncBuffer:function(e,t,i,a){try{s||l(),u();const t=[],c=[];let d=0,p=0;r.size=0,r.offset=0;const f=function(n){if(n.length){const e=n.pop(),o=e.entryName+e.extra.toString();i&&i(o),e.getCompressedDataAsync((function(i){a&&a(o),e.header.offset=p;const s=e.header.dataHeaderToBinary(),l=Buffer.alloc(o.length,o),u=s.length+l.length+i.length;p+=u,t.push(s),t.push(l),t.push(i);const h=e.packHeader();c.push(h),r.size+=h.length,d+=u+h.length,f(n)}))}else{d+=r.mainHeaderSize,r.offset=p,p=0;const n=Buffer.alloc(d);t.forEach((function(e){e.copy(n,p),p+=e.length})),c.forEach((function(e){e.copy(n,p),p+=e.length}));const i=r.toBinary();o&&o.copy(i,xn.Constants.ENDHDR),i.copy(n,p),e(n)}};f(n)}catch(e){t(e)}}}},_n=(e,t)=>"boolean"==typeof e?e:t,Cn=(e,t)=>"string"==typeof e?e:t,In={noSort:!1,readEntries:!1,method:bn.Constants.NONE,fs:null};var jn=function(e,t){let n=null;const i=Object.assign(Object.create(null),In);e&&"object"==typeof e&&(e instanceof Uint8Array||(Object.assign(i,e),e=i.input?i.input:void 0,i.input&&delete i.input),Buffer.isBuffer(e)&&(n=e,i.method=bn.Constants.BUFFER,e=void 0)),Object.assign(i,t);const o=new bn(i);if(e&&"string"==typeof e){if(!o.fs.existsSync(e))throw new Error(bn.Errors.INVALID_FILENAME);i.method=bn.Constants.FILE,i.filename=e,n=o.fs.readFileSync(e)}const r=new En(n,i),{canonical:s,sanitize:a}=bn;function c(e){var t;return e&&r&&("string"==typeof e&&(t=r.getEntry(e)),"object"==typeof e&&void 0!==e.entryName&&void 0!==e.header&&(t=r.getEntry(e.entryName)),t)?t:null}function l(e){const{join:t,normalize:n,sep:i}=Sn.posix;return t(".",n(i+e.split("\\").join(i)+i))}return{readFile:function(e,t){var n=c(e);return n&&n.getData(t)||null},readFileAsync:function(e,t){var n=c(e);n?n.getDataAsync(t):t(null,"getEntry failed for:"+e)},readAsText:function(e,t){var n=c(e);if(n){var i=n.getData();if(i&&i.length)return i.toString(t||"utf8")}return""},readAsTextAsync:function(e,t,n){var i=c(e);i?i.getDataAsync((function(e,i){i?t(e,i):e&&e.length?t(e.toString(n||"utf8")):t("")})):t("")},deleteFile:function(e){var t=c(e);t&&r.deleteEntry(t.entryName)},addZipComment:function(e){r.comment=e},getZipComment:function(){return r.comment||""},addZipEntryComment:function(e,t){var n=c(e);n&&(n.comment=t)},getZipEntryComment:function(e){var t=c(e);return t&&t.comment||""},updateFile:function(e,t){var n=c(e);n&&n.setData(t)},addLocalFile:function(e,t,n,i){if(!o.fs.existsSync(e))throw new Error(bn.Errors.FILE_NOT_FOUND.replace("%s",e));{t=t?l(t):"";var r=e.split("\\").join("/").split("/").pop();t+=n||r;const s=o.fs.statSync(e);this.addFile(t,o.fs.readFileSync(e),i,s)}},addLocalFolder:function(e,t,n){var i;if(n instanceof RegExp?(i=n,n=function(e){return i.test(e)}):"function"!=typeof n&&(n=function(){return!0}),t=t?l(t):"",e=Sn.normalize(e),!o.fs.existsSync(e))throw new Error(bn.Errors.FILE_NOT_FOUND.replace("%s",e));{const i=o.findFiles(e),r=this;i.length&&i.forEach((function(i){var s=Sn.relative(e,i).split("\\").join("/");if(n(s)){var a=o.fs.statSync(i);a.isFile()?r.addFile(t+s,o.fs.readFileSync(i),"",a):r.addFile(t+s+"/",Buffer.alloc(0),"",a)}}))}},addLocalFolderAsync:function(e,t,n,i){var r;i instanceof RegExp?(r=i,i=function(e){return r.test(e)}):"function"!=typeof i&&(i=function(){return!0}),n=n?l(n):"",e=Sn.normalize(e);var s=this;o.fs.open(e,"r",(function(r){if(r&&"ENOENT"===r.code)t(void 0,bn.Errors.FILE_NOT_FOUND.replace("%s",e));else if(r)t(void 0,r);else{var a=o.findFiles(e),c=-1,l=function(){if((c+=1)<a.length){var r=a[c],u=Sn.relative(e,r).split("\\").join("/");u=u.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\x20-\x7E]/g,""),i(u)?o.fs.stat(r,(function(e,i){e&&t(void 0,e),i.isFile()?o.fs.readFile(r,(function(e,o){e?t(void 0,e):(s.addFile(n+u,o,"",i),l())})):(s.addFile(n+u+"/",Buffer.alloc(0),"",i),l())})):l()}else t(!0,void 0)};l()}}))},addLocalFolderPromise:function(e,t){return new Promise(((n,i)=>{const{filter:o,zipPath:r}=Object.assign({},t);this.addLocalFolderAsync(e,((e,t)=>{t&&i(t),e&&n(this)}),r,o)}))},addFile:function(e,t,n,i){let s=c(e);const a=null!=s;a||(s=new kn,s.entryName=e),s.comment=n||"";const l="object"==typeof i&&i instanceof o.fs.Stats;l&&(s.header.time=i.mtime);var u=s.isDirectory?16:0;if(!bn.isWin){let e=s.isDirectory?16384:32768;e|=l?4095&i.mode:"number"==typeof i?4095&i:s.isDirectory?493:420,u=(u|e<<16)>>>0}s.attr=u,s.setData(t),a||r.setEntry(s)},getEntries:function(){return r?r.entries:[]},getEntry:function(e){return c(e)},getEntryCount:function(){return r.getEntryCount()},forEach:function(e){return r.forEach(e)},extractEntryTo:function(e,t,n,i,l,u){i=_n(i,!1),l=_n(l,!1),n=_n(n,!0),u=Cn(u,Cn(l,void 0));var d=c(e);if(!d)throw new Error(bn.Errors.NO_ENTRY);var p=s(d.entryName),f=a(t,u&&!d.isDirectory?u:n?p:Sn.basename(p));if(d.isDirectory)return r.getEntryChildren(d).forEach((function(e){if(e.isDirectory)return;var r=e.getData();if(!r)throw new Error(bn.Errors.CANT_EXTRACT_FILE);var c=s(e.entryName),u=a(t,n?c:Sn.basename(c));const d=l?e.header.fileAttr:void 0;o.writeFileTo(u,r,i,d)})),!0;var h=d.getData();if(!h)throw new Error(bn.Errors.CANT_EXTRACT_FILE);if(o.fs.existsSync(f)&&!i)throw new Error(bn.Errors.CANT_OVERRIDE);const m=l?e.header.fileAttr:void 0;return o.writeFileTo(f,h,i,m),!0},test:function(e){if(!r)return!1;for(var t in r.entries)try{if(t.isDirectory)continue;if(!r.entries[t].getData(e))return!1}catch(e){return!1}return!0},extractAllTo:function(e,t,n,i){if(t=_n(t,!1),i=Cn(n,i),n=_n(n,!1),!r)throw new Error(bn.Errors.NO_ZIP);r.entries.forEach((function(r){var c=a(e,s(r.entryName.toString()));if(r.isDirectory)return void o.makeDir(c);var l=r.getData(i);if(!l)throw new Error(bn.Errors.CANT_EXTRACT_FILE);const u=n?r.header.fileAttr:void 0;o.writeFileTo(c,l,t,u);try{o.fs.utimesSync(c,r.header.time,r.header.time)}catch(e){throw new Error(bn.Errors.CANT_EXTRACT_FILE)}}))},extractAllToAsync:function(e,t,n,i){if(i||(i=function(){}),t=_n(t,!1),"function"!=typeof n||i||(i=n),n=_n(n,!1),!r)return void i(new Error(bn.Errors.NO_ZIP));e=Sn.resolve(e);const c=t=>a(e,Sn.normalize(s(t.entryName.toString()))),l=(e,t)=>new Error(e+': "'+t+'"'),u=[],d=new Set;r.entries.forEach((e=>{e.isDirectory?u.push(e):d.add(e)}));for(const t of u){const r=c(t),s=n?t.header.fileAttr:void 0;try{o.makeDir(r),s&&o.fs.chmodSync(r,s),o.fs.utimesSync(r,t.header.time,t.header.time)}catch(e){i(l("Unable to create folder",r))}}const p=()=>{0===d.size&&i()};for(const r of d.values()){const c=Sn.normalize(s(r.entryName.toString())),u=a(e,c);r.getDataAsync((function(e,s){if(s)i(new Error(s));else if(e){const s=n?r.header.fileAttr:void 0;o.writeFileToAsync(u,e,t,s,(function(e){e?o.fs.utimes(u,r.header.time,r.header.time,(function(e){e?i(l("Unable to set times",u)):(d.delete(r),p())})):i(l("Unable to write file",u))}))}else i(new Error(bn.Errors.CANT_EXTRACT_FILE))}))}p()},writeZip:function(e,t){if(1===arguments.length&&"function"==typeof e&&(t=e,e=""),!e&&i.filename&&(e=i.filename),e){var n=r.compressToBuffer();if(n){var s=o.writeFileTo(e,n,!0);"function"==typeof t&&t(s?null:new Error("failed"),"")}}},writeZipPromise:function(e,t){const{overwrite:n,perm:r}=Object.assign({overwrite:!0},t);return new Promise(((t,s)=>{!e&&i.filename&&(e=i.filename),e||s("ADM-ZIP: ZIP File Name Missing"),this.toBufferPromise().then((i=>{o.writeFileToAsync(e,i,n,r,(e=>e?t(e):s("ADM-ZIP: Wasn't able to write zip file")))}),s)}))},toBufferPromise:function(){return new Promise(((e,t)=>{r.toAsyncBuffer(e,t)}))},toBuffer:function(e,t,n,i){return this.valueOf=2,"function"==typeof e?(r.toAsyncBuffer(e,t,n,i),null):r.compressToBuffer()}}};const On=C.default,Pn=Rt,Ln=O.default,Nn=E.default,Fn=jn,Tn=Nn.join(On.env.appData,"/templates/file/cloudfunction"),Dn=Nn.join(On.env.appRoot,"/plugins/templates/cloudfunction");function $n(e){if(!e||!Array.isArray(e)||0===e.length)return[];const t=[];return e.forEach((e=>{e.isLocal?t.push({columns:[{label:e.name},{label:e.description},{label:""}]}):t.push({columns:[{label:e.name},{label:e.description},{label:`<a href='${e.detail}'>详情</a>`}]})})),t}function Rn(e){e||(e={});const{isImport:t,nameInput:n,pathInput:i,checkedRadioButtonName:o,templateListItems:r,templateListSelectedRow:s,publicModulesCount:a,publicModulesButtonEnabled:c}=e;return{title:"新建云函数",customButtons:[{text:"取消(&C)"},{text:(t?"导入uni_module":"创建")+"(&N)",role:"accept"}],footer:'<a href="https://ext.dcloud.net.cn/?cat1=7&cat2=71">在插件市场获取更多模板</a>',focusName:"nameInput",formItems:[{type:"input",name:"nameInput",placeholder:`请输入${o?"cloudFunctionRadioButton"===o?"云函数":"云对象":"云函数"}名称，长度在1-30之间，只能包含字母、数字、下划线、中划线，不能以数字、中划线开头`,value:n||"",disabled:t},{type:"fileSelectInput",name:"pathInput",mode:"folder",placeholder:"请选择创建位置",value:i||"",disabled:t},{type:"widgetGroup",name:"createType",widgets:[{type:"radioGroup",name:"radioGroup",radios:[{name:"cloudFunctionRadioButton",text:"云函数",checked:!0},{name:"cloudObjectRadioButton",text:"云对象",checked:!1}],checkedRadio:o||"cloudFunctionRadioButton"},{type:"label",name:"cloudObjectLabel",text:'<a href="https://uniapp.dcloud.net.cn/uniCloud/cloud-obj">详情</a>'}]},{type:"list",name:"templateList",title:"选择模板",columnStretches:[1,2,1],items:r||[],value:s&&s>-1?s:0},{type:"widgetGroup",name:"publicModul",isHidden:!1,widgets:[{type:"button",name:"addPublicModulButton",text:`添加公共模块或扩展库依赖 (已添加${a||0}个)`,disabled:t}]}].map((e=>{if(e&&!e.isHidden)return e}))}}var An={createCloudFunction:async function(e){const{fsPath:t,workspaceFolder:n}=e,i="选择的位置下已存在同名的云函数",o=`不能使用以下名称:${Pn.getInvalidInputName().join("、")}`;let r="";const s=t.split("/"),a=s[s.length-2];r=-1!==a.indexOf("aliyun")?"aliyun":-1!==a.indexOf("tcb")?"tcb":"alipay";const c={func:[{name:"默认模板",description:"",type:"function",isLocal:!0,templatePath:Nn.join(Dn,"index.zip"),isUniModule:!1}],obj:[{name:"默认模板",description:"",type:"object",isLocal:!0,templatePath:Nn.join(Dn,"index.obj.zip"),isUniModule:!1}]},l=c.func,u=c.obj;let d=[],p=["uni-cloud-jql"],f=0;const h={isImport:!1,nameInput:"",pathInput:t,checkedRadioButtonName:"cloudFunctionRadioButton",templateListItems:$n(l),templateListSelectedRow:0,publicModulesCount:d.length+p.length,publicModulesButtonEnabled:!0};On.window.showFormDialog({width:700,height:550,onOpened:function(e){this.showLoading({maskAt:"templateList",text:""}),On.http.request({url:"https://ide.liuyingyong.cn/serverless/template/function-common-list",method:"post",connectionTimeout:1e4,readTimeout:1e4,serviceOptions:{serviceRequest:!0,body:{type:"function"}}}).then((e=>{if(1001===e.service.code){const t=function(e){const t=[],n=[];return e.forEach((e=>{let i=e.description;if(i.length>37){let t=i.slice(0,37);e.description=t+"..."}1===e.type?(e.type="function",t.push({isLocal:!1,isUniModule:0!==e.uniModules,...e})):2===e.type&&(e.type="object",n.push({isLocal:!1,isUniModule:0!==e.uniModules,...e}))})),{func:t,obj:n}}(JSON.parse(e.data).body);l.push(...t.func),u.push(...t.obj),h.templateListItems=$n("cloudFunctionRadioButton"===h.checkedRadioButtonName?l:u),this.hideLoading(),this.updateForm(Rn(h))}else this.hideLoading()}),(e=>{this.hideLoading()}))},onChanged:async function(e,t,i){if("nameInput"!=e)if("pathInput"!=e){if("createType"===e){const e=t.changedWidget;if("radioGroup"===e.name&&"cloudFunctionRadioButton"===e.checkedRadio&&"cloudFunctionRadioButton"!==h.checkedRadioButtonName){h.templateListSelectedRow=f,h.checkedRadioButtonName="cloudFunctionRadioButton",h.templateListItems=$n(l);const e=l[f];h.isImport=e.isUniModule,h.publicModulesButtonEnabled=e.isLocal,h.nameInput=e.isLocal?i.nameInput:e.name,f=i.templateList}else{if("radioGroup"!==e.name||"cloudObjectRadioButton"!==e.checkedRadio||"cloudObjectRadioButton"===h.checkedRadioButtonName)return;{h.templateListSelectedRow=f,h.checkedRadioButtonName="cloudObjectRadioButton",h.templateListItems=$n(u);const e=u[f];h.isImport=e.isUniModule,h.publicModulesButtonEnabled=e.isLocal,h.nameInput=e.isLocal?i.nameInput:e.name,f=i.templateList}}this.updateForm(Rn(h))}else if("templateList"===e){let e={};e="cloudFunctionRadioButton"===h.checkedRadioButtonName?l[t]:u[t],h.templateListSelectedRow=t,h.isImport=e.isUniModule,h.publicModulesButtonEnabled=e.isLocal,h.nameInput=e.isLocal?i.nameInput:e.name,this.updateForm(Rn(h))}else if("publicModul"===e){const e=On.extensions.getExtension("unicloud");if(e){const t=await e.editDependency({srcType:"function",srcName:h.nameInput,srcPath:h.pathInput,workspacePath:n.uri.fsPath,provider:r,commonModuleList:d,extensionList:p});d=t.commonModuleList,p=t.extensionList,h.publicModulesCount=d.length+p.length,this.updateForm(Rn(h))}}}else h.pathInput=t;else h.nameInput=t},validate:function(e){const{nameInput:t,pathInput:r,createType:s,templateList:a,publicModul:c}=e;if(""===t)return this.showError("云函数名称不能为空"),!1;if(!Pn.validateName(t))return this.showError("云函数名称不合法"),!1;if(Pn.getInvalidInputName().includes(t))return this.showError("云函数名称不合法,"+o),!1;if(""===r)return this.showError("云函数创建地址不能为空"),!1;let l=Ln.existsSync(Nn.join(r,t));return l?(this.showError(i),!1):(l=Ln.existsSync(Nn.join(n.uri.fsPath,"uni_modules",t)),!l||(this.showError(i),!1))},...Rn(h)}).then((async function(e){if(0===e.buttonIndex)return;const{nameInput:t,pathInput:i,createType:o,templateList:s,publicModul:a}=e.result,c=`云端已存在同名${t}，从云端拉取同名${t}还是继续本地创建？`,f="本地创建(&L)",h="从云端拉取(&P)",m=function(){let e={};e="cloudObjectRadioButton"===o.allWidget[0].checkedRadio?u[s]:l[s],function(e,t){const{name:n,description:i,url:o,detail:r,type:s,isLocal:a,templatePath:c,isUniModule:l}=e,{targetDir:u,functionName:d,publicModules:p,dependency:f,rootDir:h}=t,m=void 0===s||""===s||"function"===s?"index.js":"index.obj.js";if(a){if(new Fn(c).extractAllTo(Nn.join(u,d),!0),On.workspace.openTextDocument(Nn.join(u,d,m)),0!==p.length||0!==f.length){const e=On.extensions.getExtension("unicloud");e&&e.saveDependency({srcType:"function",srcName:d,srcPath:Nn.join(u,d)},{commonModuleList:p,extensionList:f})}}else if(l){const e=On.extensions.getExtension("uni_modules");e&&e.installDeps({fsPath:h,deps:[n]}).then((e=>{On.workspace.openTextDocument(Nn.join(h,"uni_modules",d))}))}else On.http.request({url:o,downloadFile:Nn.join(Tn,d+".zip")}).then((function(e){if(1001===e.service.code){const t=e.downloadFile;new Fn(t).extractAllTo(Nn.join(u,d),!0),On.workspace.openTextDocument(Nn.join(u,d,m)),Ln.unlink(t,(()=>{}))}}),(function(e){On.window.showErrorMessage("模板下载失败")}))}(e,{targetDir:i,functionName:t,publicModules:d,dependency:p,rootDir:n.uri.fsPath})},g=await On.unicloud.getSpaceInfo(n);let y;try{y=await On.http.request({url:"https://ide.liuyingyong.cn/serverless/function/list",method:"post",connectionTimeout:1e3,readTimeout:5e3,serviceOptions:{serviceRequest:!0,body:{provider:r,spaceId:g,appid:n.appid,uniModuleId:"",page:1,pageSize:1e3}}})}catch(e){return void m()}const v=y.service;let w=!1;if(1001===v.code){const e=v.body.functions;for(let n=0;n<e.length;n++)if(e[n].name===t){w=!0;break}}if(w){const e=await On.window.showMessageBox({type:"question",title:"",text:c,buttons:[h,f,"取消(&C)"]});if(e==h)!function(e){const{provider:t,spaceId:n,appid:i,functionName:o,targetDir:r}=e,s=`正在下载云函数${o}...`,a=`云函数${o}下载完成`,c=`云函数${o}下载失败`,l=On.window.createOutputChannel("HBuilder");l.appendLine(s),i?On.http.request({url:"https://ide.liuyingyong.cn/serverless/function/download",method:"post",serviceOptions:{serviceRequest:!0,body:{provider:t,spaceId:n,appid:i,functionName:o}}}).then((function(e){1001===e.service.code&&e.service.body.url?On.http.request({url:e.service.body.url,downloadFile:Nn.join(Tn,o+".zip")}).then((function(e){if(1001===e.service.code){const t=e.downloadFile;new Fn(t).extractAllTo(Nn.join(r,o),!0),On.workspace.openTextDocument(Nn.join(r,o+"/index.js")).then((e=>{e||On.workspace.openTextDocument(Nn.join(r,o+"/index.obj.js"))})),l.appendLine(a),Ln.unlink(t,(()=>{}))}else l.appendLine(c)}),(()=>{l.appendLine(c)})):l.appendLine(c)}),(e=>{l.appendLine(c)})):l.appendLine(c+",请先获取AppId")}({provider:r,spaceId:g,appid:n.appid,functionName:t,targetDir:i});else{if(e!==f)return;m()}}else m()}))}};const Bn=C.default,Mn=Rt,Un=E.default,qn=O.default,Wn=jn,Jn=Un.join(Bn.env.appData,"/templates/file/commonmodule"),Hn=Un.join(Bn.env.appRoot,"/plugins/templates/commonmodule");function Vn(e,t){const{name:n,description:i,isLocal:o,templatePath:r,url:s,detail:a,isUniModule:c}=e,{targetDir:l,moduleName:u,rootDir:d}=t;if(o){const e=`{\n\t"name": "${u}",\n\t"version": "1.0.0",\n\t"description": "",\n\t"main": "index.js",\n\t"scripts": {\n\t\t"test": "echo \\"Error: no test specified\\" && exit 1"\n\t},\n\t"keywords": [],\n\t"author": "",\n\t"license": "ISC"\n}`;qn.mkdirSync(Un.join(l,u),{recursive:!0}),qn.copyFileSync(r,Un.join(l,u,"index.js")),qn.writeFileSync(Un.join(l,u,"package.json"),e,"utf-8"),Bn.workspace.openTextDocument(Un.join(l,u,"index.js"))}else if(c){const e=Bn.extensions.getExtension("uni_modules");e&&e.installDeps({fsPath:d,deps:[n]}).then((e=>{Bn.workspace.openTextDocument(Un.join(d,"uni_modules",u))}))}else Bn.http.request({url:s,downloadFile:Un.join(Jn,u+".zip")}).then((function(e){if(1001===e.service.code){const t=e.downloadFile;new Wn(t).extractAllTo(Un.join(l,u),!0),Bn.workspace.openTextDocument(Un.join(l,u,"index.js")),qn.unlink(t,(()=>{}))}}),(function(e){Bn.window.showErrorMessage("模板下载失败")}))}function zn(e){e||(e={});const{isImport:t,nameInput:n,pathInput:i,templates:o,templateListSelectedRow:r}=e,s=(t?"导入uniModule":"创建")+"(&N)";let a=function(e){if(!e||!Array.isArray(e)||0===e.length)return[];const t=[];return e.forEach((e=>{e.isLocal?t.push({columns:[{label:e.name},{label:e.description},{label:""}]}):t.push({columns:[{label:e.name},{label:e.description},{label:`<a href='${e.detail}'>详情</a>`}]})})),t}(o);return{title:"新建公共模块",footer:'<a href="https://ext.dcloud.net.cn/?cat1=7&cat2=71">在插件市场获取更多模板</a>',customButtons:[{text:"取消(&C)"},{text:s,role:"accept"}],focusName:"nameInput",formItems:[{type:"input",name:"nameInput",placeholder:"请输入公共模块名称，长度在1-30之间，只能包含字母、数字、下划线、中划线，不能以数字、中划线开头",value:n||"",disabled:t},{type:"fileSelectInput",name:"pathInput",mode:"file",placeholder:"请选择公共模块创建位置",value:i||"",disabled:t},{type:"list",name:"templateList",title:"选择模板",columnStretches:[1,2,1],items:a&&0!==a.length?a:[],value:r&&r>-1?r:0}]}}var Gn={createCommon:async function(e){const{fsPath:t,workspaceFolder:n}=e,i=`不能使用以下名称:${Mn.getInvalidInputName().join("、")}`,o="本地创建(&L)",r="从云端拉取(&P)";let s=[{name:"默认模板",description:"",isLocal:!0,templatePath:Un.join(Hn,"index.js"),isUniModule:!1}];const a={isImport:s[0].isUniModule,nameInput:"",pathInput:t,templates:s,templateListSelectedRow:0};let c="";const l=t.split("/"),u=l[l.length-3];c=-1!==u.indexOf("aliyun")?"aliyun":-1!==u.indexOf("tcb")?"tcb":"alipay",Bn.window.showFormDialog({width:680,height:500,onOpened:function(e){this.showLoading({maskAt:"templateList",text:""}),Bn.http.request({url:"https://ide.liuyingyong.cn/serverless/template/function-common-list",method:"post",connectionTimeout:1e4,readTimeout:1e4,serviceOptions:{serviceRequest:!0,body:{type:"common"}}}).then((e=>{if(1001===e.service.code){const t=function(e){if(!e||!Array.isArray(e)||0===e.length)return[];const t=[];return e.forEach((e=>{3===e.type&&t.push({name:e.name,description:e.description,isLocal:!1,templatePath:"",url:e.url,detail:e.detail,isUniModule:0!==e.uniModules})})),t}(JSON.parse(e.data).body);s.push(...t),a.templates=s,this.updateForm(zn(a))}this.hideLoading()}),(e=>{this.hideLoading()}))},onChanged:async function(e,t,n){if("nameInput"!==e)if("pathInput"!==e){if("templateList"===e){const e=s[t];return a.isImport=e.isUniModule,a.nameInput=e.isLocal?n.nameInput:e.name,a.templateListSelectedRow=t,void this.updateForm(zn(a))}}else a.pathInput=t;else a.nameInput=t},validate:async function(e){const{nameInput:t,pathInput:n}=e;return""===t?(this.showError("公共模块名称不能为空"),!1):Mn.validateName(t)?Mn.getInvalidInputName().includes(t)?(this.showError("公共模块名称不合法,"+i),!1):""===n?(this.showError("公共模块创建地址不能为空"),!1):qn.existsSync(Un.join(n,t))?(this.showError("选择的位置下已存在同名的公共模块"),!1):!!qn.existsSync(n)||("是"==await Bn.window.showMessageBox({type:"question",title:"",text:`当前目录 ${n} 不存在，是否创建？`,buttons:["是","否"],defaultButton:0})?(qn.mkdirSync(n,{recursive:!0}),!0):(this.showError("无效的位置"),!1)):(this.showError("公共模块名称不合法"),!1)},...zn(a)}).then((async function(e){if(0===e.buttonIndex)return;const{nameInput:t,pathInput:i,templateList:a}=e.result,l=await Bn.unicloud.getSpaceInfo(n);let u;try{u=await Bn.http.request({url:"https://ide.liuyingyong.cn/serverless/commonModule/list",method:"post",connectionTimeout:1e3,readTimeout:5e3,serviceOptions:{serviceRequest:!0,body:{provider:c,spaceId:l,appid:n.appid,uniModuleId:""}}})}catch(e){return void Vn(s[a],{targetDir:i,moduleName:t,rootDir:n.uri.fsPath})}const d=u.service;let p=!1;if(1001===d.code){const e=d.body.modules;for(let n=0;n<e.length;n++)if(e[n].name===t){p=!0;break}}if(p){const e=await Bn.window.showMessageBox({type:"question",title:"",text:"云端已存在同名公共模块，从云端拉取同名公共模块还是继续本地创建？",buttons:[r,o,"取消(&C)"]});if(e==r)!function(e){const{provider:t,spaceId:n,appid:i,moduleName:o,targetDir:r}=e,s=`正在下载公共模块${o}...`,a=`公共模块${o}下载完成`,c=`公共模块${o}下载失败`,l="请检查网络状态",u=Bn.window.createOutputChannel("HBuilder");u.appendLine(s),i?Bn.http.request({url:"https://ide.liuyingyong.cn/serverless/commonModule/download",method:"post",connectionTimeout:2e3,readTimeout:2e3,serviceOptions:{serviceRequest:!0,body:{provider:t,spaceId:n,appid:i,moduleName:o}}}).then((function(e){1001===e.service.code&&e.service.body.url?Bn.http.request({url:e.service.body.url,downloadFile:Un.join(Jn,o+".zip")}).then((function(e){if(1001===e.service.code){const t=e.downloadFile;new Wn(t).extractAllTo(Un.join(r,o),!0),Bn.workspace.openTextDocument(Un.join(r,o+"/index.js")),u.appendLine(a),qn.unlink(t,(()=>{}))}else u.appendLine(c)}),(e=>{u.appendLine(c+","+l)})):u.appendLine(c)}),(e=>{u.appendLine(c+","+l)})):u.appendLine(c+",请先获取AppId")}({provider:c,spaceId:l,appid:n.appid,moduleName:t,targetDir:i});else{if(e!==o)return;Vn(s[a],{targetDir:i,moduleName:t,rootDir:n.uri.fsPath})}}else Vn(s[a],{targetDir:i,moduleName:t,rootDir:n.uri.fsPath})}))}},Kn={urlAlphabet:"useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"};let Xn,Qn,Zn=$.default,{urlAlphabet:Yn}=Kn,ei=e=>{!Xn||Xn.length<e?(Xn=Buffer.allocUnsafe(128*e),Zn.randomFillSync(Xn),Qn=0):Qn+e>Xn.length&&(Zn.randomFillSync(Xn),Qn=0),Qn+=e},ti=e=>(ei(e-=0),Xn.subarray(Qn-e,Qn)),ni=(e,t,n)=>{let i=(2<<31-Math.clz32(e.length-1|1))-1,o=Math.ceil(1.6*i*t/e.length);return(r=t)=>{let s="";for(;;){let t=n(o),a=o;for(;a--;)if(s+=e[t[a]&i]||"",s.length===r)return s}}};var ii={nanoid:(e=21)=>{ei(e-=0);let t="";for(let n=Qn-e;n<Qn;n++)t+=Yn[63&Xn[n]];return t},customAlphabet:(e,t=21)=>ni(e,t,ti),customRandom:ni,urlAlphabet:Yn,random:ti},oi={sessions:new Map};const ri=C.default,si=E.default,ai=O.default,ci=Rt;var li={configureRunTestParam:function(e){let t=ci.resolveFunctionOrObjectName(e.selectedPath),n=ci.resolveCloudFunctionOrObjectPath(e.selectedPath);if(t&&n){let i="",o="";ci.isCloudObject(e.selectedPath)?(i=si.join(n,`${t}.param.js`),o="// 本文件中的内容将在云对象【运行】时解析为运行参数\n// 配置教程参考：https://uniapp.dcloud.net.cn/uniCloud/rundebug.html#run-obj-param"):(i=si.join(n,`${t}.param.json`),o="// 本文件中的json内容将在云函数【运行】时作为参数传给云函数。\n// 配置教程参考：https://uniapp.dcloud.net.cn/uniCloud/rundebug.html#runparam\n{\n}"),ai.existsSync(i)||ai.writeFileSync(i,o,"utf-8"),ri.workspace.openTextDocument(i)}}};const ui=C.default,di=R.default,pi=O.default,fi=E.default,hi=ii,mi=oi,gi=Rt;var yi={runOrDebugLocalCloudObject:async function(e){let t="";gi.sessionInit(e,!1,{beforeStop:async()=>{await e.console.appendLine({line:t+"已停止运行...",level:"error"})}});let n=hi.nanoid();return console.log("uuid",n),{start:async function(){const i=e.workspaceFolder;console.log("workspaceFolder",i),e.activeTextEditor;const o=e.selectedPath,r="debug"===e.mode;if(!i.appid||""===i.appid)return await e.console.appendLine({line:"appid为空，请先在manifest.json内重新获取",level:"error"}),void await e.stop();if(r){let t=!1;if(mi.sessions.forEach((n=>{n.workspaceFolder.id!==e.workspaceFolder.id||"STOPPED"===n.state||(t=!0)})),t)return await ui.window.showMessageBox({type:"warning",title:"",text:"当前项目已有正在运行的uniCloud调试服务，无法启动新的调试服务",buttons:["确定"]}),void await e.stop();mi.sessions.set(e.id,e)}let s=null,a=null,c=null,l=null;try{if(!pi.existsSync(o))return void await e.stop();a=o.match(/(?<=.*\/uniCloud(-aliyun|-tcb|-alipay)*\/cloudfunctions\/)[^\/]*/)[0],s=fi.join(o.match(new RegExp(`.*cloudfunctions/(?=${a})`))[0],a),c=fi.join(s,"index.obj.js"),l=fi.join(s,a+".param.js")}catch(t){return console.log(t.toString()),await e.console.appendLine({line:"解析云对象路径失败，请检查后重试",level:"error"}),void await e.stop()}let u="aliyun",d=null,p=null,f=await gi.getSpaceInfo(i,s,"云对象");if(0===f.code)u=f.provider,d=f.spaceName,p=f.spaceId,""!==f.msg&&await e.console.appendLine({line:f.msg,level:"warning"});else{if(-1===f.code)return e.console.appendLine({line:f.msg,level:"warning"}),void await e.stop();if(-2===f.code)return void await e.stop()}if(!pi.existsSync(l)){li.configureRunTestParam(e);let t="未找到运行测试参数配置文件，已自动创建空文件，请自行配置运行参数";return e.console.appendLine({line:t,level:"warning"}),void await e.stop()}const h=ui.extensions.getExtension("unicloud");if(h){const o=`[本地运行:${"aliyun"===u?"阿里云":"tcb"===u?"腾讯云":"支付宝云"}:${d}]`;t=o;const l=o+`本地运行云对象【${a}】...`,f=o+"运行日志：",m=(r?"调试":"运行")+"失败...";e.console.appendLine({line:l,hyperlinks:[{linkPosition:{start:l.indexOf(a),end:l.indexOf(a)+a.length},onOpen:async function(){ui.workspace.openTextDocument(c)}}]}),e.console.appendLine({line:f});const g=await h.runCloudObject({objectPath:s,projectId:i.id,spaceName:d,provider:u,debugMode:r,spaceId:p,appId:i.appid,workspaceFolder:i.uri.fsPath,uuid:n,cloudObjectName:a,callback:async()=>{"debug"===e.mode&&await e.stop()}});if(0===g.code){if(r)return void di.debug.startDebugging(i,{type:"legacy-node2",request:"attach",name:`${a}云对象[${i.name}]`,port:g.debugPort,...g},{id:e.id})}else e.console.appendLine({line:m,level:"error"}),e.console.appendLine({line:g.message,level:"error"})}await e.stop()},stop:async function(){const t="debug"===e.mode,i=ui.extensions.getExtension("unicloud");i&&i.stopCloudFunction({uuid:n}),t&&mi.sessions.has(e.id)&&mi.sessions.delete(e.id)}}}};const vi=C.default,wi=R.default,xi=ii,bi=O.default,Si=E.default,ki=Rt,Ei=oi;let _i="";var Ci={runOrDebugLocalCloudFunction:function(e){ki.sessionInit(e,!0,{beforeStop:async()=>{await e.console.appendLine({line:_i+"已停止运行...",level:"error"})}});let t=xi.nanoid();return{start:async function(){await async function(e,t){const n=e.workspaceFolder;console.log(n);const i="debug"===e.mode,o=e.selectedPath;if(!n.appid||""===n.appid)return await e.console.appendLine({line:"appid为空，请先在manifest.json内重新获取",level:"error"}),void await e.stop();if(i){let t=!1;if(Ei.sessions.forEach((n=>{n.workspaceFolder.id!==e.workspaceFolder.id||"STOPPED"===n.state||(t=!0)})),t)return await vi.window.showMessageBox({type:"warning",title:"",text:"当前项目已有正在运行的uniCloud调试服务，无法启动新的调试服务",buttons:["确定"]}),void await e.stop();Ei.sessions.set(e.id,e)}let r=null,s=null,a=null;try{if(!bi.existsSync(o))return void await e.stop();s=o.match(/(?<=.*\/uniCloud(-aliyun|-tcb|-alipay)*\/cloudfunctions\/)[^\/]*/)[0],r=Si.join(o.match(new RegExp(`.*cloudfunctions/(?=${s})`))[0],s),a=Si.join(r,"index.js")}catch(t){return console.log(t.toString()),await e.console.appendLine({line:"解析云函数路径失败，请检查后重试",level:"error"}),void await e.stop()}let c="aliyun",l=null,u=null,d=await ki.getSpaceInfo(n,r,"云函数");if(0===d.code)c=d.provider,l=d.spaceName,u=d.spaceId,""!==d.msg&&await e.console.appendLine({line:d.msg,level:"warning"});else{if(-1===d.code)return e.console.appendLine({line:d.msg,level:"warning"}),void await e.stop();if(-2===d.code)return void await e.stop()}const p=vi.extensions.getExtension("unicloud");if(p){const o=`[本地运行:${"aliyun"===c?"阿里云":"tcb"===c?"腾讯云":"支付宝云"}:${l}]`;_i=o;const d=o+`本地运行云函数【${s}】...`,f=o+"运行日志：",h=(i?"调试":"运行")+"失败...";e.console.appendLine({line:d,hyperlinks:[{linkPosition:{start:d.indexOf(s),end:d.indexOf(s)+s.length},onOpen:async function(){vi.workspace.openTextDocument(a)}}]}),e.console.appendLine({line:f});const m=await p.runCloudFunction({functionPath:r,projectId:n.id,spaceName:l,provider:c,debugMode:i,spaceId:u,appId:n.appid,workspaceFolder:n.uri.fsPath,uuid:t.uuid,callback:async()=>{await e.stop()}});if(0===m.code){if(i)return void wi.debug.startDebugging(e.workspaceFolder,{type:"legacy-node2",request:"attach",name:`${s}云函数[${n.name}]`,port:m.debugPort,...m},{id:e.id})}else e.console.appendLine({line:h,level:"error"}),e.console.appendLine({line:m.message,level:"error"})}await e.stop()}(e,{uuid:t})},stop:async function(){await function(e,t){const n="debug"===e.mode,i=vi.extensions.getExtension("unicloud");i&&i.stopCloudFunction({uuid:t.uuid}),n&&Ei.sessions.has(e.id)&&Ei.sessions.delete(e.id)}(e,{uuid:t})}}}};const Ii=C.default;var ji={getCloudFunctionExecLog:async function(e){let t=e.provider,n=e.spaceId,i=e.requestId,o=e.functionName,r=Date.now()/1e3,s=!1,a={};for(;!(Date.now()/1e3-r>=120);)try{let e=await Ii.http.request({url:"https://ide.liuyingyong.cn/serverless/function/log",method:"post",connectionTimeout:1e3,readTimeout:5e3,serviceOptions:{serviceRequest:!0,body:{provider:t,spaceId:n,requestId:i,functionName:o}}});if(1001===e.service.code){if(a=e.service.body,"OK"===a.status){s=!0;break}if("FAILED"===a.status)break}await new Promise((e=>{setTimeout(e,300)}))}catch(e){}return{success:s,body:a}}};const{getCloudFunctionExecLog:Oi}=ji;var Pi={getCloudFunctionExecLog:Oi},Li={},Ni={fromCallback:function(e){return Object.defineProperty((function(...t){if("function"!=typeof t[t.length-1])return new Promise(((n,i)=>{e.call(this,...t,((e,t)=>null!=e?i(e):n(t)))}));e.apply(this,t)}),"name",{value:e.name})},fromPromise:function(e){return Object.defineProperty((function(...t){const n=t[t.length-1];if("function"!=typeof n)return e.apply(this,t);e.apply(this,t.slice(0,-1)).then((e=>n(null,e)),n)}),"name",{value:e.name})}},Fi=B.default,Ti=process.cwd,Di=null,$i=process.env.GRACEFUL_FS_PLATFORM||process.platform;process.cwd=function(){return Di||(Di=Ti.call(process)),Di};try{process.cwd()}catch(e){}if("function"==typeof process.chdir){var Ri=process.chdir;process.chdir=function(e){Di=null,Ri.call(process,e)},Object.setPrototypeOf&&Object.setPrototypeOf(process.chdir,Ri)}var Wi,Ji,Ai=function(e){var t,n;function i(t){return t?function(n,i,o){return t.call(e,n,i,(function(e){l(e)&&(e=null),o&&o.apply(this,arguments)}))}:t}function o(t){return t?function(n,i){try{return t.call(e,n,i)}catch(e){if(!l(e))throw e}}:t}function r(t){return t?function(n,i,o,r){return t.call(e,n,i,o,(function(e){l(e)&&(e=null),r&&r.apply(this,arguments)}))}:t}function s(t){return t?function(n,i,o){try{return t.call(e,n,i,o)}catch(e){if(!l(e))throw e}}:t}function a(t){return t?function(n,i,o){function r(e,t){t&&(t.uid<0&&(t.uid+=4294967296),t.gid<0&&(t.gid+=4294967296)),o&&o.apply(this,arguments)}return"function"==typeof i&&(o=i,i=null),i?t.call(e,n,i,r):t.call(e,n,r)}:t}function c(t){return t?function(n,i){var o=i?t.call(e,n,i):t.call(e,n);return o&&(o.uid<0&&(o.uid+=4294967296),o.gid<0&&(o.gid+=4294967296)),o}:t}function l(e){return!e||"ENOSYS"===e.code||!(process.getuid&&0===process.getuid()||"EINVAL"!==e.code&&"EPERM"!==e.code)}Fi.hasOwnProperty("O_SYMLINK")&&process.version.match(/^v0\.6\.[0-2]|^v0\.5\./)&&function(e){e.lchmod=function(t,n,i){e.open(t,Fi.O_WRONLY|Fi.O_SYMLINK,n,(function(t,o){t?i&&i(t):e.fchmod(o,n,(function(t){e.close(o,(function(e){i&&i(t||e)}))}))}))},e.lchmodSync=function(t,n){var i,o=e.openSync(t,Fi.O_WRONLY|Fi.O_SYMLINK,n),r=!0;try{i=e.fchmodSync(o,n),r=!1}finally{if(r)try{e.closeSync(o)}catch(e){}else e.closeSync(o)}return i}}(e),e.lutimes||function(e){Fi.hasOwnProperty("O_SYMLINK")?(e.lutimes=function(t,n,i,o){e.open(t,Fi.O_SYMLINK,(function(t,r){t?o&&o(t):e.futimes(r,n,i,(function(t){e.close(r,(function(e){o&&o(t||e)}))}))}))},e.lutimesSync=function(t,n,i){var o,r=e.openSync(t,Fi.O_SYMLINK),s=!0;try{o=e.futimesSync(r,n,i),s=!1}finally{if(s)try{e.closeSync(r)}catch(e){}else e.closeSync(r)}return o}):(e.lutimes=function(e,t,n,i){i&&process.nextTick(i)},e.lutimesSync=function(){})}(e),e.chown=r(e.chown),e.fchown=r(e.fchown),e.lchown=r(e.lchown),e.chmod=i(e.chmod),e.fchmod=i(e.fchmod),e.lchmod=i(e.lchmod),e.chownSync=s(e.chownSync),e.fchownSync=s(e.fchownSync),e.lchownSync=s(e.lchownSync),e.chmodSync=o(e.chmodSync),e.fchmodSync=o(e.fchmodSync),e.lchmodSync=o(e.lchmodSync),e.stat=a(e.stat),e.fstat=a(e.fstat),e.lstat=a(e.lstat),e.statSync=c(e.statSync),e.fstatSync=c(e.fstatSync),e.lstatSync=c(e.lstatSync),e.lchmod||(e.lchmod=function(e,t,n){n&&process.nextTick(n)},e.lchmodSync=function(){}),e.lchown||(e.lchown=function(e,t,n,i){i&&process.nextTick(i)},e.lchownSync=function(){}),"win32"===$i&&(e.rename=(t=e.rename,function(n,i,o){var r=Date.now(),s=0;t(n,i,(function a(c){if(c&&("EACCES"===c.code||"EPERM"===c.code)&&Date.now()-r<6e4)return setTimeout((function(){e.stat(i,(function(e,r){e&&"ENOENT"===e.code?t(n,i,a):o(c)}))}),s),void(s<100&&(s+=10));o&&o(c)}))})),e.read=function(t){function n(n,i,o,r,s,a){var c;if(a&&"function"==typeof a){var l=0;c=function(u,d,p){if(u&&"EAGAIN"===u.code&&l<10)return l++,t.call(e,n,i,o,r,s,c);a.apply(this,arguments)}}return t.call(e,n,i,o,r,s,c)}return Object.setPrototypeOf&&Object.setPrototypeOf(n,t),n}(e.read),e.readSync=(n=e.readSync,function(t,i,o,r,s){for(var a=0;;)try{return n.call(e,t,i,o,r,s)}catch(e){if("EAGAIN"===e.code&&a<10){a++;continue}throw e}})},Bi=M.default.Stream,Mi=function(e){return{ReadStream:function t(n,i){if(!(this instanceof t))return new t(n,i);Bi.call(this);var o=this;this.path=n,this.fd=null,this.readable=!0,this.paused=!1,this.flags="r",this.mode=438,this.bufferSize=65536,i=i||{};for(var r=Object.keys(i),s=0,a=r.length;s<a;s++){var c=r[s];this[c]=i[c]}if(this.encoding&&this.setEncoding(this.encoding),void 0!==this.start){if("number"!=typeof this.start)throw TypeError("start must be a Number");if(void 0===this.end)this.end=1/0;else if("number"!=typeof this.end)throw TypeError("end must be a Number");if(this.start>this.end)throw new Error("start must be <= end");this.pos=this.start}null===this.fd?e.open(this.path,this.flags,this.mode,(function(e,t){if(e)return o.emit("error",e),void(o.readable=!1);o.fd=t,o.emit("open",t),o._read()})):process.nextTick((function(){o._read()}))},WriteStream:function t(n,i){if(!(this instanceof t))return new t(n,i);Bi.call(this),this.path=n,this.fd=null,this.writable=!0,this.flags="w",this.encoding="binary",this.mode=438,this.bytesWritten=0,i=i||{};for(var o=Object.keys(i),r=0,s=o.length;r<s;r++){var a=o[r];this[a]=i[a]}if(void 0!==this.start){if("number"!=typeof this.start)throw TypeError("start must be a Number");if(this.start<0)throw new Error("start must be >= zero");this.pos=this.start}this.busy=!1,this._queue=[],null===this.fd&&(this._open=e.open,this._queue.push([this._open,this.path,this.flags,this.mode,void 0]),this.flush())}}},Ui=function(e){if(null===e||"object"!=typeof e)return e;if(e instanceof Object)var t={__proto__:qi(e)};else t=Object.create(null);return Object.getOwnPropertyNames(e).forEach((function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))})),t},qi=Object.getPrototypeOf||function(e){return e.__proto__},Hi=O.default,Vi=Ai,zi=Mi,Gi=Ui,Ki=U.default;function Zi(e,t){Object.defineProperty(e,Wi,{get:function(){return t}})}"function"==typeof Symbol&&"function"==typeof Symbol.for?(Wi=Symbol.for("graceful-fs.queue"),Ji=Symbol.for("graceful-fs.previous")):(Wi="___graceful-fs.queue",Ji="___graceful-fs.previous");var Yi=function(){};if(Ki.debuglog?Yi=Ki.debuglog("gfs4"):/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")&&(Yi=function(){var e=Ki.format.apply(Ki,arguments);e="GFS4: "+e.split(/\n/).join("\nGFS4: "),console.error(e)}),!Hi[Wi]){var Xi=Ue[Wi]||[];Zi(Hi,Xi),Hi.close=function(e){function t(t,n){return e.call(Hi,t,(function(e){e||io(),"function"==typeof n&&n.apply(this,arguments)}))}return Object.defineProperty(t,Ji,{value:e}),t}(Hi.close),Hi.closeSync=function(e){function t(t){e.apply(Hi,arguments),io()}return Object.defineProperty(t,Ji,{value:e}),t}(Hi.closeSync),/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")&&process.on("exit",(function(){Yi(Hi[Wi]),q.default.equal(Hi[Wi].length,0)}))}Ue[Wi]||Zi(Ue,Hi[Wi]);var Qi,eo=to(Gi(Hi));function to(e){Vi(e),e.gracefulify=to,e.createReadStream=function(t,n){return new e.ReadStream(t,n)},e.createWriteStream=function(t,n){return new e.WriteStream(t,n)};var t=e.readFile;e.readFile=function(e,n,i){return"function"==typeof n&&(i=n,n=null),function e(n,i,o,r){return t(n,i,(function(t){!t||"EMFILE"!==t.code&&"ENFILE"!==t.code?"function"==typeof o&&o.apply(this,arguments):no([e,[n,i,o],t,r||Date.now(),Date.now()])}))}(e,n,i)};var n=e.writeFile;e.writeFile=function(e,t,i,o){return"function"==typeof i&&(o=i,i=null),function e(t,i,o,r,s){return n(t,i,o,(function(n){!n||"EMFILE"!==n.code&&"ENFILE"!==n.code?"function"==typeof r&&r.apply(this,arguments):no([e,[t,i,o,r],n,s||Date.now(),Date.now()])}))}(e,t,i,o)};var i=e.appendFile;i&&(e.appendFile=function(e,t,n,o){return"function"==typeof n&&(o=n,n=null),function e(t,n,o,r,s){return i(t,n,o,(function(i){!i||"EMFILE"!==i.code&&"ENFILE"!==i.code?"function"==typeof r&&r.apply(this,arguments):no([e,[t,n,o,r],i,s||Date.now(),Date.now()])}))}(e,t,n,o)});var o=e.copyFile;o&&(e.copyFile=function(e,t,n,i){return"function"==typeof n&&(i=n,n=0),function e(t,n,i,r,s){return o(t,n,i,(function(o){!o||"EMFILE"!==o.code&&"ENFILE"!==o.code?"function"==typeof r&&r.apply(this,arguments):no([e,[t,n,i,r],o,s||Date.now(),Date.now()])}))}(e,t,n,i)});var r=e.readdir;if(e.readdir=function(e,t,n){return"function"==typeof t&&(n=t,t=null),function e(t,n,i,o){return r(t,n,(function(r,s){!r||"EMFILE"!==r.code&&"ENFILE"!==r.code?(s&&s.sort&&s.sort(),"function"==typeof i&&i.call(this,r,s)):no([e,[t,n,i],r,o||Date.now(),Date.now()])}))}(e,t,n)},"v0.8"===process.version.substr(0,4)){var s=zi(e);d=s.ReadStream,p=s.WriteStream}var a=e.ReadStream;a&&(d.prototype=Object.create(a.prototype),d.prototype.open=function(){var e=this;h(e.path,e.flags,e.mode,(function(t,n){t?(e.autoClose&&e.destroy(),e.emit("error",t)):(e.fd=n,e.emit("open",n),e.read())}))});var c=e.WriteStream;c&&(p.prototype=Object.create(c.prototype),p.prototype.open=function(){var e=this;h(e.path,e.flags,e.mode,(function(t,n){t?(e.destroy(),e.emit("error",t)):(e.fd=n,e.emit("open",n))}))}),Object.defineProperty(e,"ReadStream",{get:function(){return d},set:function(e){d=e},enumerable:!0,configurable:!0}),Object.defineProperty(e,"WriteStream",{get:function(){return p},set:function(e){p=e},enumerable:!0,configurable:!0});var l=d;Object.defineProperty(e,"FileReadStream",{get:function(){return l},set:function(e){l=e},enumerable:!0,configurable:!0});var u=p;function d(e,t){return this instanceof d?(a.apply(this,arguments),this):d.apply(Object.create(d.prototype),arguments)}function p(e,t){return this instanceof p?(c.apply(this,arguments),this):p.apply(Object.create(p.prototype),arguments)}Object.defineProperty(e,"FileWriteStream",{get:function(){return u},set:function(e){u=e},enumerable:!0,configurable:!0});var f=e.open;function h(e,t,n,i){return"function"==typeof n&&(i=n,n=null),function e(t,n,i,o,r){return f(t,n,i,(function(s,a){!s||"EMFILE"!==s.code&&"ENFILE"!==s.code?"function"==typeof o&&o.apply(this,arguments):no([e,[t,n,i,o],s,r||Date.now(),Date.now()])}))}(e,t,n,i)}return e.open=h,e}function no(e){Yi("ENQUEUE",e[0].name,e[1]),Hi[Wi].push(e),oo()}function io(){for(var e=Date.now(),t=0;t<Hi[Wi].length;++t)Hi[Wi][t].length>2&&(Hi[Wi][t][3]=e,Hi[Wi][t][4]=e);oo()}function oo(){if(clearTimeout(Qi),Qi=void 0,0!==Hi[Wi].length){var e=Hi[Wi].shift(),t=e[0],n=e[1],i=e[2],o=e[3],r=e[4];if(void 0===o)Yi("RETRY",t.name,n),t.apply(null,n);else if(Date.now()-o>=6e4){Yi("TIMEOUT",t.name,n);var s=n.pop();"function"==typeof s&&s.call(null,i)}else{var a=Date.now()-r,c=Math.max(r-o,1);a>=Math.min(1.2*c,100)?(Yi("RETRY",t.name,n),t.apply(null,n.concat([o]))):Hi[Wi].push(e)}void 0===Qi&&(Qi=setTimeout(oo,0))}}process.env.TEST_GRACEFUL_FS_GLOBAL_PATCH&&!Hi.__patched&&(eo=to(Hi),Hi.__patched=!0),function(e){const t=Ni.fromCallback,n=eo,i=["access","appendFile","chmod","chown","close","copyFile","fchmod","fchown","fdatasync","fstat","fsync","ftruncate","futimes","lchmod","lchown","link","lstat","mkdir","mkdtemp","open","opendir","readdir","readFile","readlink","realpath","rename","rm","rmdir","stat","symlink","truncate","unlink","utimes","writeFile"].filter((e=>"function"==typeof n[e]));Object.assign(e,n),i.forEach((i=>{e[i]=t(n[i])})),e.exists=function(e,t){return"function"==typeof t?n.exists(e,t):new Promise((t=>n.exists(e,t)))},e.read=function(e,t,i,o,r,s){return"function"==typeof s?n.read(e,t,i,o,r,s):new Promise(((s,a)=>{n.read(e,t,i,o,r,((e,t,n)=>{if(e)return a(e);s({bytesRead:t,buffer:n})}))}))},e.write=function(e,t,...i){return"function"==typeof i[i.length-1]?n.write(e,t,...i):new Promise(((o,r)=>{n.write(e,t,...i,((e,t,n)=>{if(e)return r(e);o({bytesWritten:t,buffer:n})}))}))},"function"==typeof n.writev&&(e.writev=function(e,t,...i){return"function"==typeof i[i.length-1]?n.writev(e,t,...i):new Promise(((o,r)=>{n.writev(e,t,...i,((e,t,n)=>{if(e)return r(e);o({bytesWritten:t,buffers:n})}))}))}),"function"==typeof n.realpath.native?e.realpath.native=t(n.realpath.native):process.emitWarning("fs.realpath.native is not a function. Is fs being monkey-patched?","Warning","fs-extra-WARN0003")}(Li);var ro={},so={};const ao=E.default;so.checkPath=function(e){if("win32"===process.platform&&/[<>:"|?*]/.test(e.replace(ao.parse(e).root,""))){const t=new Error(`Path contains invalid characters: ${e}`);throw t.code="EINVAL",t}};const co=Li,{checkPath:lo}=so,uo=e=>"number"==typeof e?e:{mode:511,...e}.mode;ro.makeDir=async(e,t)=>(lo(e),co.mkdir(e,{mode:uo(t),recursive:!0})),ro.makeDirSync=(e,t)=>(lo(e),co.mkdirSync(e,{mode:uo(t),recursive:!0}));const po=Ni.fromPromise,{makeDir:fo,makeDirSync:ho}=ro,mo=po(fo);var go={mkdirs:mo,mkdirsSync:ho,mkdirp:mo,mkdirpSync:ho,ensureDir:mo,ensureDirSync:ho};const yo=Ni.fromPromise,vo=Li;var wo={pathExists:yo((function(e){return vo.access(e).then((()=>!0)).catch((()=>!1))})),pathExistsSync:vo.existsSync};const xo=eo;var bo=function(e,t,n,i){xo.open(e,"r+",((e,o)=>{if(e)return i(e);xo.futimes(o,t,n,(e=>{xo.close(o,(t=>{i&&i(e||t)}))}))}))},So=function(e,t,n){const i=xo.openSync(e,"r+");return xo.futimesSync(i,t,n),xo.closeSync(i)};const ko=Li,Eo=E.default,_o=U.default;function Co(e,t,n){const i=n.dereference?e=>ko.stat(e,{bigint:!0}):e=>ko.lstat(e,{bigint:!0});return Promise.all([i(e),i(t).catch((e=>{if("ENOENT"===e.code)return null;throw e}))]).then((([e,t])=>({srcStat:e,destStat:t})))}function Io(e,t){return t.ino&&t.dev&&t.ino===e.ino&&t.dev===e.dev}function jo(e,t){const n=Eo.resolve(e).split(Eo.sep).filter((e=>e)),i=Eo.resolve(t).split(Eo.sep).filter((e=>e));return n.reduce(((e,t,n)=>e&&i[n]===t),!0)}function Oo(e,t,n){return`Cannot ${n} '${e}' to a subdirectory of itself, '${t}'.`}var Po={checkPaths:function(e,t,n,i,o){_o.callbackify(Co)(e,t,i,((i,r)=>{if(i)return o(i);const{srcStat:s,destStat:a}=r;if(a){if(Io(s,a)){const i=Eo.basename(e),r=Eo.basename(t);return"move"===n&&i!==r&&i.toLowerCase()===r.toLowerCase()?o(null,{srcStat:s,destStat:a,isChangingCase:!0}):o(new Error("Source and destination must not be the same."))}if(s.isDirectory()&&!a.isDirectory())return o(new Error(`Cannot overwrite non-directory '${t}' with directory '${e}'.`));if(!s.isDirectory()&&a.isDirectory())return o(new Error(`Cannot overwrite directory '${t}' with non-directory '${e}'.`))}return s.isDirectory()&&jo(e,t)?o(new Error(Oo(e,t,n))):o(null,{srcStat:s,destStat:a})}))},checkPathsSync:function(e,t,n,i){const{srcStat:o,destStat:r}=function(e,t,n){let i;const o=n.dereference?e=>ko.statSync(e,{bigint:!0}):e=>ko.lstatSync(e,{bigint:!0}),r=o(e);try{i=o(t)}catch(e){if("ENOENT"===e.code)return{srcStat:r,destStat:null};throw e}return{srcStat:r,destStat:i}}(e,t,i);if(r){if(Io(o,r)){const i=Eo.basename(e),s=Eo.basename(t);if("move"===n&&i!==s&&i.toLowerCase()===s.toLowerCase())return{srcStat:o,destStat:r,isChangingCase:!0};throw new Error("Source and destination must not be the same.")}if(o.isDirectory()&&!r.isDirectory())throw new Error(`Cannot overwrite non-directory '${t}' with directory '${e}'.`);if(!o.isDirectory()&&r.isDirectory())throw new Error(`Cannot overwrite directory '${t}' with non-directory '${e}'.`)}if(o.isDirectory()&&jo(e,t))throw new Error(Oo(e,t,n));return{srcStat:o,destStat:r}},checkParentPaths:function e(t,n,i,o,r){const s=Eo.resolve(Eo.dirname(t)),a=Eo.resolve(Eo.dirname(i));if(a===s||a===Eo.parse(a).root)return r();ko.stat(a,{bigint:!0},((s,c)=>s?"ENOENT"===s.code?r():r(s):Io(n,c)?r(new Error(Oo(t,i,o))):e(t,n,a,o,r)))},checkParentPathsSync:function e(t,n,i,o){const r=Eo.resolve(Eo.dirname(t)),s=Eo.resolve(Eo.dirname(i));if(s===r||s===Eo.parse(s).root)return;let a;try{a=ko.statSync(s,{bigint:!0})}catch(e){if("ENOENT"===e.code)return;throw e}if(Io(n,a))throw new Error(Oo(t,i,o));return e(t,n,s,o)},isSrcSubdir:jo,areIdentical:Io};const Lo=eo,No=E.default,Fo=go.mkdirs,To=wo.pathExists,Do=bo,$o=Po;function Ro(e,t,n,i,o){const r=No.dirname(n);To(r,((s,a)=>s?o(s):a?Bo(e,t,n,i,o):void Fo(r,(r=>r?o(r):Bo(e,t,n,i,o)))))}function Ao(e,t,n,i,o,r){Promise.resolve(o.filter(n,i)).then((s=>s?e(t,n,i,o,r):r()),(e=>r(e)))}function Bo(e,t,n,i,o){(i.dereference?Lo.stat:Lo.lstat)(t,((r,s)=>r?o(r):s.isDirectory()?function(e,t,n,i,o,r){return t?Wo(n,i,o,r):function(e,t,n,i,o){Lo.mkdir(n,(r=>{if(r)return o(r);Wo(t,n,i,(t=>t?o(t):qo(n,e,o)))}))}(e.mode,n,i,o,r)}(s,e,t,n,i,o):s.isFile()||s.isCharacterDevice()||s.isBlockDevice()?function(e,t,n,i,o,r){return t?function(e,t,n,i,o){if(!i.overwrite)return i.errorOnExist?o(new Error(`'${n}' already exists`)):o();Lo.unlink(n,(r=>r?o(r):Mo(e,t,n,i,o)))}(e,n,i,o,r):Mo(e,n,i,o,r)}(s,e,t,n,i,o):s.isSymbolicLink()?function(e,t,n,i,o){Lo.readlink(t,((t,r)=>t?o(t):(i.dereference&&(r=No.resolve(process.cwd(),r)),e?void Lo.readlink(n,((t,s)=>t?"EINVAL"===t.code||"UNKNOWN"===t.code?Lo.symlink(r,n,o):o(t):(i.dereference&&(s=No.resolve(process.cwd(),s)),$o.isSrcSubdir(r,s)?o(new Error(`Cannot copy '${r}' to a subdirectory of itself, '${s}'.`)):e.isDirectory()&&$o.isSrcSubdir(s,r)?o(new Error(`Cannot overwrite '${s}' with '${r}'.`)):function(e,t,n){Lo.unlink(t,(i=>i?n(i):Lo.symlink(e,t,n)))}(r,n,o)))):Lo.symlink(r,n,o))))}(e,t,n,i,o):s.isSocket()?o(new Error(`Cannot copy a socket file: ${t}`)):s.isFIFO()?o(new Error(`Cannot copy a FIFO pipe: ${t}`)):o(new Error(`Unknown file: ${t}`))))}function Mo(e,t,n,i,o){Lo.copyFile(t,n,(r=>r?o(r):i.preserveTimestamps?function(e,t,n,i){return function(e){return 0==(128&e)}(e)?function(e,t,n){return qo(e,128|t,n)}(n,e,(o=>o?i(o):Uo(e,t,n,i))):Uo(e,t,n,i)}(e.mode,t,n,o):qo(n,e.mode,o)))}function Uo(e,t,n,i){!function(e,t,n){Lo.stat(e,((e,i)=>e?n(e):Do(t,i.atime,i.mtime,n)))}(t,n,(t=>t?i(t):qo(n,e,i)))}function qo(e,t,n){return Lo.chmod(e,t,n)}function Wo(e,t,n,i){Lo.readdir(e,((o,r)=>o?i(o):Jo(r,e,t,n,i)))}function Jo(e,t,n,i,o){const r=e.pop();return r?function(e,t,n,i,o,r){const s=No.join(n,t),a=No.join(i,t);$o.checkPaths(s,a,"copy",o,((t,c)=>{if(t)return r(t);const{destStat:l}=c;!function(e,t,n,i,o){i.filter?Ao(Bo,e,t,n,i,o):Bo(e,t,n,i,o)}(l,s,a,o,(t=>t?r(t):Jo(e,n,i,o,r)))}))}(e,r,t,n,i,o):o()}var Ho=function(e,t,n,i){"function"!=typeof n||i?"function"==typeof n&&(n={filter:n}):(i=n,n={}),i=i||function(){},(n=n||{}).clobber=!("clobber"in n)||!!n.clobber,n.overwrite="overwrite"in n?!!n.overwrite:n.clobber,n.preserveTimestamps&&"ia32"===process.arch&&process.emitWarning("Using the preserveTimestamps option in 32-bit node is not recommended;\n\n\tsee https://github.com/jprichardson/node-fs-extra/issues/269","Warning","fs-extra-WARN0001"),$o.checkPaths(e,t,"copy",n,((o,r)=>{if(o)return i(o);const{srcStat:s,destStat:a}=r;$o.checkParentPaths(e,s,t,"copy",(o=>o?i(o):n.filter?Ao(Ro,a,e,t,n,i):Ro(a,e,t,n,i)))}))};const Vo=eo,zo=E.default,Go=go.mkdirsSync,Ko=So,Zo=Po;function Yo(e,t,n,i){const o=(i.dereference?Vo.statSync:Vo.lstatSync)(t);if(o.isDirectory())return function(e,t,n,i,o){return t?er(n,i,o):function(e,t,n,i){return Vo.mkdirSync(n),er(t,n,i),Qo(n,e)}(e.mode,n,i,o)}(o,e,t,n,i);if(o.isFile()||o.isCharacterDevice()||o.isBlockDevice())return function(e,t,n,i,o){return t?function(e,t,n,i){if(i.overwrite)return Vo.unlinkSync(n),Xo(e,t,n,i);if(i.errorOnExist)throw new Error(`'${n}' already exists`)}(e,n,i,o):Xo(e,n,i,o)}(o,e,t,n,i);if(o.isSymbolicLink())return function(e,t,n,i){let o=Vo.readlinkSync(t);if(i.dereference&&(o=zo.resolve(process.cwd(),o)),e){let t;try{t=Vo.readlinkSync(n)}catch(e){if("EINVAL"===e.code||"UNKNOWN"===e.code)return Vo.symlinkSync(o,n);throw e}if(i.dereference&&(t=zo.resolve(process.cwd(),t)),Zo.isSrcSubdir(o,t))throw new Error(`Cannot copy '${o}' to a subdirectory of itself, '${t}'.`);if(Vo.statSync(n).isDirectory()&&Zo.isSrcSubdir(t,o))throw new Error(`Cannot overwrite '${t}' with '${o}'.`);return function(e,t){return Vo.unlinkSync(t),Vo.symlinkSync(e,t)}(o,n)}return Vo.symlinkSync(o,n)}(e,t,n,i);if(o.isSocket())throw new Error(`Cannot copy a socket file: ${t}`);if(o.isFIFO())throw new Error(`Cannot copy a FIFO pipe: ${t}`);throw new Error(`Unknown file: ${t}`)}function Xo(e,t,n,i){return Vo.copyFileSync(t,n),i.preserveTimestamps&&function(e,t,n){(function(e){return 0==(128&e)})(e)&&function(e,t){Qo(e,128|t)}(n,e),function(e,t){const n=Vo.statSync(e);Ko(t,n.atime,n.mtime)}(t,n)}(e.mode,t,n),Qo(n,e.mode)}function Qo(e,t){return Vo.chmodSync(e,t)}function er(e,t,n){Vo.readdirSync(e).forEach((i=>function(e,t,n,i){const o=zo.join(t,e),r=zo.join(n,e),{destStat:s}=Zo.checkPathsSync(o,r,"copy",i);return function(e,t,n,i){if(!i.filter||i.filter(t,n))return Yo(e,t,n,i)}(s,o,r,i)}(i,e,t,n)))}var tr=function(e,t,n){"function"==typeof n&&(n={filter:n}),(n=n||{}).clobber=!("clobber"in n)||!!n.clobber,n.overwrite="overwrite"in n?!!n.overwrite:n.clobber,n.preserveTimestamps&&"ia32"===process.arch&&process.emitWarning("Using the preserveTimestamps option in 32-bit node is not recommended;\n\n\tsee https://github.com/jprichardson/node-fs-extra/issues/269","Warning","fs-extra-WARN0002");const{srcStat:i,destStat:o}=Zo.checkPathsSync(e,t,"copy",n);return Zo.checkParentPathsSync(e,i,t,"copy"),function(e,t,n,i){if(i.filter&&!i.filter(t,n))return;const o=zo.dirname(n);return Vo.existsSync(o)||Go(o),Yo(e,t,n,i)}(o,e,t,n)},nr={copy:(0,Ni.fromCallback)(Ho),copySync:tr};const ir=eo,or=E.default,rr=q.default,sr="win32"===process.platform;function ar(e){["unlink","chmod","stat","lstat","rmdir","readdir"].forEach((t=>{e[t]=e[t]||ir[t],e[t+="Sync"]=e[t]||ir[t]})),e.maxBusyTries=e.maxBusyTries||3}function cr(e,t,n){let i=0;"function"==typeof t&&(n=t,t={}),rr(e,"rimraf: missing path"),rr.strictEqual(typeof e,"string","rimraf: path should be a string"),rr.strictEqual(typeof n,"function","rimraf: callback function required"),rr(t,"rimraf: invalid options argument provided"),rr.strictEqual(typeof t,"object","rimraf: options should be object"),ar(t),lr(e,t,(function o(r){if(r){if(("EBUSY"===r.code||"ENOTEMPTY"===r.code||"EPERM"===r.code)&&i<t.maxBusyTries)return i++,setTimeout((()=>lr(e,t,o)),100*i);"ENOENT"===r.code&&(r=null)}n(r)}))}function lr(e,t,n){rr(e),rr(t),rr("function"==typeof n),t.lstat(e,((i,o)=>i&&"ENOENT"===i.code?n(null):i&&"EPERM"===i.code&&sr?ur(e,t,i,n):o&&o.isDirectory()?pr(e,t,i,n):void t.unlink(e,(i=>{if(i){if("ENOENT"===i.code)return n(null);if("EPERM"===i.code)return sr?ur(e,t,i,n):pr(e,t,i,n);if("EISDIR"===i.code)return pr(e,t,i,n)}return n(i)}))))}function ur(e,t,n,i){rr(e),rr(t),rr("function"==typeof i),t.chmod(e,438,(o=>{o?i("ENOENT"===o.code?null:n):t.stat(e,((o,r)=>{o?i("ENOENT"===o.code?null:n):r.isDirectory()?pr(e,t,n,i):t.unlink(e,i)}))}))}function dr(e,t,n){let i;rr(e),rr(t);try{t.chmodSync(e,438)}catch(e){if("ENOENT"===e.code)return;throw n}try{i=t.statSync(e)}catch(e){if("ENOENT"===e.code)return;throw n}i.isDirectory()?hr(e,t,n):t.unlinkSync(e)}function pr(e,t,n,i){rr(e),rr(t),rr("function"==typeof i),t.rmdir(e,(o=>{!o||"ENOTEMPTY"!==o.code&&"EEXIST"!==o.code&&"EPERM"!==o.code?o&&"ENOTDIR"===o.code?i(n):i(o):function(e,t,n){rr(e),rr(t),rr("function"==typeof n),t.readdir(e,((i,o)=>{if(i)return n(i);let r,s=o.length;if(0===s)return t.rmdir(e,n);o.forEach((i=>{cr(or.join(e,i),t,(i=>{if(!r)return i?n(r=i):void(0==--s&&t.rmdir(e,n))}))}))}))}(e,t,i)}))}function fr(e,t){let n;ar(t=t||{}),rr(e,"rimraf: missing path"),rr.strictEqual(typeof e,"string","rimraf: path should be a string"),rr(t,"rimraf: missing options"),rr.strictEqual(typeof t,"object","rimraf: options should be object");try{n=t.lstatSync(e)}catch(n){if("ENOENT"===n.code)return;"EPERM"===n.code&&sr&&dr(e,t,n)}try{n&&n.isDirectory()?hr(e,t,null):t.unlinkSync(e)}catch(n){if("ENOENT"===n.code)return;if("EPERM"===n.code)return sr?dr(e,t,n):hr(e,t,n);if("EISDIR"!==n.code)throw n;hr(e,t,n)}}function hr(e,t,n){rr(e),rr(t);try{t.rmdirSync(e)}catch(i){if("ENOTDIR"===i.code)throw n;if("ENOTEMPTY"===i.code||"EEXIST"===i.code||"EPERM"===i.code)!function(e,t){if(rr(e),rr(t),t.readdirSync(e).forEach((n=>fr(or.join(e,n),t))),!sr)return t.rmdirSync(e,t);{const n=Date.now();do{try{return t.rmdirSync(e,t)}catch{}}while(Date.now()-n<500)}}(e,t);else if("ENOENT"!==i.code)throw i}}var mr=cr;cr.sync=fr;const gr=eo,yr=Ni.fromCallback,vr=mr;var wr={remove:yr((function(e,t){if(gr.rm)return gr.rm(e,{recursive:!0,force:!0},t);vr(e,t)})),removeSync:function(e){if(gr.rmSync)return gr.rmSync(e,{recursive:!0,force:!0});vr.sync(e)}};const xr=Ni.fromPromise,br=Li,Sr=E.default,kr=go,Er=wr,_r=xr((async function(e){let t;try{t=await br.readdir(e)}catch{return kr.mkdirs(e)}return Promise.all(t.map((t=>Er.remove(Sr.join(e,t)))))}));function Cr(e){let t;try{t=br.readdirSync(e)}catch{return kr.mkdirsSync(e)}t.forEach((t=>{t=Sr.join(e,t),Er.removeSync(t)}))}var Ir={emptyDirSync:Cr,emptydirSync:Cr,emptyDir:_r,emptydir:_r};const jr=Ni.fromCallback,Or=E.default,Pr=eo,Lr=go;var Nr={createFile:jr((function(e,t){function n(){Pr.writeFile(e,"",(e=>{if(e)return t(e);t()}))}Pr.stat(e,((i,o)=>{if(!i&&o.isFile())return t();const r=Or.dirname(e);Pr.stat(r,((e,i)=>{if(e)return"ENOENT"===e.code?Lr.mkdirs(r,(e=>{if(e)return t(e);n()})):t(e);i.isDirectory()?n():Pr.readdir(r,(e=>{if(e)return t(e)}))}))}))})),createFileSync:function(e){let t;try{t=Pr.statSync(e)}catch{}if(t&&t.isFile())return;const n=Or.dirname(e);try{Pr.statSync(n).isDirectory()||Pr.readdirSync(n)}catch(e){if(!e||"ENOENT"!==e.code)throw e;Lr.mkdirsSync(n)}Pr.writeFileSync(e,"")}};const Fr=Ni.fromCallback,Tr=E.default,Dr=eo,$r=go,Rr=wo.pathExists,{areIdentical:Ar}=Po;var Br={createLink:Fr((function(e,t,n){function i(e,t){Dr.link(e,t,(e=>{if(e)return n(e);n(null)}))}Dr.lstat(t,((o,r)=>{Dr.lstat(e,((o,s)=>{if(o)return o.message=o.message.replace("lstat","ensureLink"),n(o);if(r&&Ar(s,r))return n(null);const a=Tr.dirname(t);Rr(a,((o,r)=>o?n(o):r?i(e,t):void $r.mkdirs(a,(o=>{if(o)return n(o);i(e,t)}))))}))}))})),createLinkSync:function(e,t){let n;try{n=Dr.lstatSync(t)}catch{}try{const t=Dr.lstatSync(e);if(n&&Ar(t,n))return}catch(e){throw e.message=e.message.replace("lstat","ensureLink"),e}const i=Tr.dirname(t);return Dr.existsSync(i)||$r.mkdirsSync(i),Dr.linkSync(e,t)}};const Mr=E.default,Ur=eo,qr=wo.pathExists;var Wr={symlinkPaths:function(e,t,n){if(Mr.isAbsolute(e))return Ur.lstat(e,(t=>t?(t.message=t.message.replace("lstat","ensureSymlink"),n(t)):n(null,{toCwd:e,toDst:e})));{const i=Mr.dirname(t),o=Mr.join(i,e);return qr(o,((t,r)=>t?n(t):r?n(null,{toCwd:o,toDst:e}):Ur.lstat(e,(t=>t?(t.message=t.message.replace("lstat","ensureSymlink"),n(t)):n(null,{toCwd:e,toDst:Mr.relative(i,e)})))))}},symlinkPathsSync:function(e,t){let n;if(Mr.isAbsolute(e)){if(n=Ur.existsSync(e),!n)throw new Error("absolute srcpath does not exist");return{toCwd:e,toDst:e}}{const i=Mr.dirname(t),o=Mr.join(i,e);if(n=Ur.existsSync(o),n)return{toCwd:o,toDst:e};if(n=Ur.existsSync(e),!n)throw new Error("relative srcpath does not exist");return{toCwd:e,toDst:Mr.relative(i,e)}}}};const Jr=eo;var Hr={symlinkType:function(e,t,n){if(n="function"==typeof t?t:n,t="function"!=typeof t&&t)return n(null,t);Jr.lstat(e,((e,i)=>{if(e)return n(null,"file");t=i&&i.isDirectory()?"dir":"file",n(null,t)}))},symlinkTypeSync:function(e,t){let n;if(t)return t;try{n=Jr.lstatSync(e)}catch{return"file"}return n&&n.isDirectory()?"dir":"file"}};const Vr=Ni.fromCallback,zr=E.default,Gr=Li,Kr=go.mkdirs,Zr=go.mkdirsSync,Yr=Wr.symlinkPaths,Xr=Wr.symlinkPathsSync,Qr=Hr.symlinkType,es=Hr.symlinkTypeSync,ts=wo.pathExists,{areIdentical:ns}=Po;function is(e,t,n,i){Yr(e,t,((o,r)=>{if(o)return i(o);e=r.toDst,Qr(r.toCwd,n,((n,o)=>{if(n)return i(n);const r=zr.dirname(t);ts(r,((n,s)=>n?i(n):s?Gr.symlink(e,t,o,i):void Kr(r,(n=>{if(n)return i(n);Gr.symlink(e,t,o,i)}))))}))}))}var os={createSymlink:Vr((function(e,t,n,i){i="function"==typeof n?n:i,n="function"!=typeof n&&n,Gr.lstat(t,((o,r)=>{!o&&r.isSymbolicLink()?Promise.all([Gr.stat(e),Gr.stat(t)]).then((([o,r])=>{if(ns(o,r))return i(null);is(e,t,n,i)})):is(e,t,n,i)}))})),createSymlinkSync:function(e,t,n){let i;try{i=Gr.lstatSync(t)}catch{}if(i&&i.isSymbolicLink()){const n=Gr.statSync(e),i=Gr.statSync(t);if(ns(n,i))return}const o=Xr(e,t);e=o.toDst,n=es(o.toCwd,n);const r=zr.dirname(t);return Gr.existsSync(r)||Zr(r),Gr.symlinkSync(e,t,n)}};const{createFile:rs,createFileSync:ss}=Nr,{createLink:as,createLinkSync:cs}=Br,{createSymlink:ls,createSymlinkSync:us}=os;var ds={createFile:rs,createFileSync:ss,ensureFile:rs,ensureFileSync:ss,createLink:as,createLinkSync:cs,ensureLink:as,ensureLinkSync:cs,createSymlink:ls,createSymlinkSync:us,ensureSymlink:ls,ensureSymlinkSync:us},ps={stringify:function(e,{EOL:t="\n",finalEOL:n=!0,replacer:i=null,spaces:o}={}){const r=n?t:"";return JSON.stringify(e,i,o).replace(/\n/g,t)+r},stripBom:function(e){return Buffer.isBuffer(e)&&(e=e.toString("utf8")),e.replace(/^\uFEFF/,"")}};let fs;try{fs=require("graceful-fs")}catch(Sm){fs=O.default}const hs=Ni,{stringify:ms,stripBom:gs}=ps,ys=hs.fromPromise((async function(e,t={}){"string"==typeof t&&(t={encoding:t});const n=t.fs||fs,i=!("throws"in t)||t.throws;let o,r=await hs.fromCallback(n.readFile)(e,t);r=gs(r);try{o=JSON.parse(r,t?t.reviver:null)}catch(t){if(i)throw t.message=`${e}: ${t.message}`,t;return null}return o})),vs=hs.fromPromise((async function(e,t,n={}){const i=n.fs||fs,o=ms(t,n);await hs.fromCallback(i.writeFile)(e,o,n)})),ws={readFile:ys,readFileSync:function(e,t={}){"string"==typeof t&&(t={encoding:t});const n=t.fs||fs,i=!("throws"in t)||t.throws;try{let i=n.readFileSync(e,t);return i=gs(i),JSON.parse(i,t.reviver)}catch(t){if(i)throw t.message=`${e}: ${t.message}`,t;return null}},writeFile:vs,writeFileSync:function(e,t,n={}){const i=n.fs||fs,o=ms(t,n);return i.writeFileSync(e,o,n)}};var xs={readJson:ws.readFile,readJsonSync:ws.readFileSync,writeJson:ws.writeFile,writeJsonSync:ws.writeFileSync};const bs=Ni.fromCallback,Ss=eo,ks=E.default,Es=go,_s=wo.pathExists;var Cs={outputFile:bs((function(e,t,n,i){"function"==typeof n&&(i=n,n="utf8");const o=ks.dirname(e);_s(o,((r,s)=>r?i(r):s?Ss.writeFile(e,t,n,i):void Es.mkdirs(o,(o=>{if(o)return i(o);Ss.writeFile(e,t,n,i)}))))})),outputFileSync:function(e,...t){const n=ks.dirname(e);if(Ss.existsSync(n))return Ss.writeFileSync(e,...t);Es.mkdirsSync(n),Ss.writeFileSync(e,...t)}};const{stringify:Is}=ps,{outputFile:js}=Cs;var Os=async function(e,t,n={}){const i=Is(t,n);await js(e,i,n)};const{stringify:Ps}=ps,{outputFileSync:Ls}=Cs;var Ns=function(e,t,n){const i=Ps(t,n);Ls(e,i,n)};const Fs=Ni.fromPromise,Ts=xs;Ts.outputJson=Fs(Os),Ts.outputJsonSync=Ns,Ts.outputJSON=Ts.outputJson,Ts.outputJSONSync=Ts.outputJsonSync,Ts.writeJSON=Ts.writeJson,Ts.writeJSONSync=Ts.writeJsonSync,Ts.readJSON=Ts.readJson,Ts.readJSONSync=Ts.readJsonSync;var Ds=Ts;const $s=eo,Rs=E.default,As=nr.copy,Bs=wr.remove,Ms=go.mkdirp,Us=wo.pathExists,qs=Po;function Ws(e,t,n,i,o){return i?Js(e,t,n,o):n?Bs(t,(i=>i?o(i):Js(e,t,n,o))):void Us(t,((i,r)=>i?o(i):r?o(new Error("dest already exists.")):Js(e,t,n,o)))}function Js(e,t,n,i){$s.rename(e,t,(o=>o?"EXDEV"!==o.code?i(o):function(e,t,n,i){As(e,t,{overwrite:n,errorOnExist:!0},(t=>t?i(t):Bs(e,i)))}(e,t,n,i):i()))}var Hs=function(e,t,n,i){"function"==typeof n&&(i=n,n={});const o=(n=n||{}).overwrite||n.clobber||!1;qs.checkPaths(e,t,"move",n,((n,r)=>{if(n)return i(n);const{srcStat:s,isChangingCase:a=!1}=r;qs.checkParentPaths(e,s,t,"move",(n=>n?i(n):function(e){const t=Rs.dirname(e);return Rs.parse(t).root===t}(t)?Ws(e,t,o,a,i):void Ms(Rs.dirname(t),(n=>n?i(n):Ws(e,t,o,a,i)))))}))};const Vs=eo,zs=E.default,Gs=nr.copySync,Ks=wr.removeSync,Zs=go.mkdirpSync,Ys=Po;function Xs(e,t,n){try{Vs.renameSync(e,t)}catch(i){if("EXDEV"!==i.code)throw i;return function(e,t,n){return Gs(e,t,{overwrite:n,errorOnExist:!0}),Ks(e)}(e,t,n)}}var Qs=function(e,t,n){const i=(n=n||{}).overwrite||n.clobber||!1,{srcStat:o,isChangingCase:r=!1}=Ys.checkPathsSync(e,t,"move",n);return Ys.checkParentPathsSync(e,o,t,"move"),function(e){const t=zs.dirname(e);return zs.parse(t).root===t}(t)||Zs(zs.dirname(t)),function(e,t,n,i){if(i)return Xs(e,t,n);if(n)return Ks(t),Xs(e,t,n);if(Vs.existsSync(t))throw new Error("dest already exists.");return Xs(e,t,n)}(e,t,i,r)},ea={move:(0,Ni.fromCallback)(Hs),moveSync:Qs},ta={...Li,...nr,...Ir,...ds,...Ds,...go,...ea,...Cs,...wo,...wr};const na=O.default,ia=E.default,oa=C.default,ra=jn,{getWorkspaceBindServiceSpace:sa}=Ct;function aa(e){return!!(e&&na.existsSync(e)&&na.statSync(e).isFile())}var ca={walkSync:function(e,t){na.readdirSync(e).forEach((function(n){const i=ia.join(e,n),o=na.statSync(i);o.isFile()&&t(i,o)}))},makeDir:function(e){if(na.existsSync(e))return!1;let t;e.split("/").forEach((e=>{t=t?ia.join(t,e):e||"/",na.existsSync(t)||na.mkdirSync(t)}))},isTemplateFile:function(e){if(e){const t=ia.basename(e);return!("config.json"===t||t.startsWith("config.")||t.startsWith(".")||t.startsWith("readme.txt"))}},getDBSchemaVersion:function(e){let t;if(aa(e)){try{const n=na.readFileSync(e,"utf8"),i=JSON.parse(n);i&&(t=i.version)}catch(e){console.log("e::",e)}return t}},fileExists:aa,isSchemaExtFile:function(e){if(!e)return!1;const t=ia.basename(e);return/.schema.ext.js$/.test(t)},validateName:function(e){return/^[a-zA-Z][a-zA-Z0-9-_.]*$/.test(e)},initWizard:function(e,t){const n=ia.parse(e).base.split(".")[0],i=ia.parse(e).dir,o=ia.join(i,n+".schema.ext.js");return!na.existsSync(o)||(t.fsPath=o,t)},errorArray:function(e){const t=e.error,n={ConnectionRefusedError:"连接被拒绝",RemoteHostClosedError:"服务端连接已经被关闭",HostNotFoundError:"主机未找到",TimeoutError:"超时",OperationCanceledError:"网络连接超时请重试",SslHandshakeFailedError:"Ssl握手失败",TemporaryNetworkFailureError:"暂时性网络失败",NetworkSessionFailedError:"网络会话错误",BackgroundRequestNotAllowedError:"后台请求不被允许",TooManyRedirectsError:"重定向过多",InsecureRedirectError:"不安全的重定向",UnknownNetworkError:"未知网络错误",ProxyConnectionRefusedError:"代理连接被拒绝",ProxyConnectionClosedError:"代理连接被关闭",ProxyNotFoundError:"代理未找到",ProxyTimeoutError:"代理操作超时",ProxyAuthenticationRequiredError:"代理认证请求错误",UnknownProxyError:"未知代理错误",ContentAccessDenied:"内容禁止访问",ContentOperationNotPermittedError:"内容操作不被允许",ContentNotFoundError:"内容未找到",AuthenticationRequiredError:"认证请求错误",ContentReSendError:"内容重发",ContentConflictError:"内容冲突",ContentGoneError:"内容不见了",UnknownContentError:"未知内容错误",ProtocolUnknownError:"未知协议",ProtocolInvalidOperationError:"无效的协议操作",ProtocolFailure:"协议错误",InternalServerError:"内部服务错误",OperationNotImplementedError:"操作未实现",ServiceUnavailableError:"服务不可用",UnknownServerError:"未知服务",UserNotLogin:"用户未登录"};return n[t]?n[t]:"未知错误"},checkServiceSpace:async function(e,t,n,i){const{workspaceFolder:o,properties:r={}}=e;let{provider:s,spaceName:a,allSpaces:c}=await sa({workspaceFolder:o});const l=r.provider||s;if(a=(c.find((e=>e.provider===l))||{}).spaceName,"不存在云服务空间"===i){if("aliyun"===l)return"[阿里云:未绑定]请先关联云服务空间";if("tcb"===l)return"[腾讯云:未绑定]请先关联云服务空间";if("alipay"===l)return"[支付宝云:未绑定]请先关联云服务空间";if(!l)return"请先关联云服务空间"}if(0===c.length){if(-1!==e.fsPath.indexOf("uniCloud-aliyun"))return"[阿里云:未绑定]请先关联云服务空间";if(-1!==e.fsPath.indexOf("uniCloud-tcb"))return"[腾讯云:未绑定]请先关联云服务空间";if(-1!==e.fsPath.indexOf("uniCloud-alipay"))return"[支付宝云:未绑定]请先关联云服务空间";if(-1!==e.fsPath.indexOf("uni_modules")){const t=ia.parse(ia.join(e.fsPath,"../../../")).base;if(na.existsSync(ia.join(o.uri.fsPath,"uniCloud-aliyun"))&&na.existsSync(ia.join(o.uri.fsPath,"uniCloud-tcb"))&&na.existsSync(ia.join(o.uri.fsPath,"uniCloud-alipay"))||!na.existsSync(ia.join(o.uri.fsPath,"uniCloud-aliyun"))&&!na.existsSync(ia.join(o.uri.fsPath,"uniCloud-tcb"))&&!na.existsSync(ia.join(o.uri.fsPath,"uniCloud-alipay"))){const n=await oa.window.showMessageBox({type:"warning",title:"",text:`项目 ${ia.parse(e.fsPath).base} 同时绑定了多个云服务商，请为当前操作指定使用哪个`,buttons:["腾讯云","阿里云","支付宝云","取消"]});return"取消"!==n&&`[${n}:${t}]请先关联云服务空间`}if(na.existsSync(ia.join(o.uri.fsPath,"uniCloud-aliyun")))return`[阿里云:${t}]请先关联云服务空间`;if(na.existsSync(ia.join(o.uri.fsPath,"uniCloud-tcb")))return`[腾讯云:${t}]请先关联云服务空间`;if(na.existsSync(ia.join(o.uri.fsPath,"uniCloud-alipay")))return`[支付宝云:${t}]请先关联云服务空间`}}let u="aliyun"===l?"阿里云":"tcb"===l?"腾讯云":"支付宝云";if("阿里云"===i||"腾讯云"===i||"支付宝云"===i){u=i;const e="阿里云"===i?"aliyun":"腾讯云"===i?"tcb":"alipay",t=c.find((t=>t.provider===e));a=t?t.spaceName:"未绑定"}const d=ia.parse(e.dbFolder?e.dbFolder.fsPath:e.fsPath).base;let p="success"===n?`[${u}:${a}]${t} (${d}) 成功`:`[${u}:${a}]${t} (${d})...`;return"error"===n&&(p=`[${u}:${a}]${t}`),p},zipSchema:async function(e){const t=ia.dirname(e),n=ia.basename(e).replace(/.schema.json$/,""),i=ia.join(t,"locale",n),o=new ra;o.addLocalFile(e),na.existsSync(i)&&o.addLocalFolder(i,`locale/${n}`,/.json$/);const r=ia.join(__dirname,"schema.zip");return await o.writeZipPromise(r),r},getUniModuleId:function(e){const t=(e=e.replace(/\\/g,"/")).match(/uni_modules\/(.*?)\//);return t&&t[1]||""},getCommonContext:async function(e){const{workspaceFolder:t}=e,n={};return n.outputView=oa.window.createOutputView({id:`${t.id}-unicloud`,title:`[${t.name}] - unicloud控制台`}),n.currentSpace=await async function(e){const{fsPath:t,workspaceFolder:n,properties:i={}}=e,o=t.match(/uniCloud-(tcb|aliyun|alipay)/)?.[1];let r=i.provider||o;const s={tcb:"腾讯云",aliyun:"阿里云",alipay:"支付宝云"},a=Object.keys(s).reduce(((e,t)=>(e[s[t]]=t,e)),{}),{allSpaces:c}=await sa({workspaceFolder:n});if(c.length<=0)throw new Error("请先关联云服务空间");if(1===c.length&&(r=c[0].provider),!r){const e=await oa.window.showMessageBox({type:"warning",title:"",text:`项目 ${ia.parse(n.uri.fsPath).base} 同时绑定了多个云服务商，请为当前操作指定使用哪个`,buttons:[...c.map((e=>s[e.provider])),"取消"]});if("取消"===e)throw new Error("取消");r=a[e]}const l=c.find((e=>e.provider===r));return Object.assign({},l,{providerName:s[r]})}(e),n}};const la=C.default;var ua=async function(e){const t=await la.http.request({url:e,method:"get"});if(!t&&200!==t.httpStatusCode&&!t.data)return[];try{return JSON.parse(t.data)}catch(e){return[]}};const da=C.default,pa=ta,fa=E.default,ha=ca,ma=ua,ga=da.env.appData+"/templates/file/database",ya=da.env.appRoot+"/plugins/templates/file/database";function va(e={},{dirPath:t,templateList:n}){return e.dirPathInput||(e.dirPathInput=t),e.templateList||(e.templateList=0),n&&(n=n.map((e=>({columns:[{label:e.name},{label:e.title},{label:e.detail?`<a href='${e.detail}'>详情</a>`:""}]})))),{title:"新建数据集合Schema文件",hideSubTitle:!0,focusName:"templateList",footer:'<a href="https://uniapp.dcloud.io/uniCloud/schema">DB Schema教程</a> | <a href="https://uniapp.dcloud.io/uniCloud/opendb">什么是opendb表</a>',formItems:[{type:"input",name:"fileNameInput",placeholder:"请输入文件名",value:e.fileNameInput?e.fileNameInput:"",selection:e.fileNameInput?{offset:0,length:e.fileNameInput.length}:""},{type:"label",name:"tipLabel",text:e.tipLabel},{type:"fileSelectInput",name:"dirPathInput",mode:"folder",placeholder:"请选择文件路径",value:e.dirPathInput},{type:"list",name:"templateList",title:"选择模板",searchable:!0,searchColumns:[0,1],columnStretches:[1,1,1],items:n,value:e.templateList}]}}var wa=function(e){const t=[],n=e.fsPath;return da.window.showFormDialog({cornerWidget:{type:"label",text:"<a href='custom'>[自定义模板]</a>",onEvent:()=>{pa.ensureDirSync(ga);const e=ga.startsWith("/")?"file://":"file:///";da.env.openExternal(e+ga)}},...va({},{dirPath:n}),onOpened:function(){this.showLoading({maskAt:"templateList",text:""}),ha.walkSync(ya.toString(),(function(e,n){let i=fa.basename(e);ha.isTemplateFile(e)&&(i=i.substring(0,i.indexOf(".")),t.push({name:i,path:e,title:"默认模板",local:!0,existsFiles:{schema:!0}}))})),ha.walkSync(ga,(function(e,n){let i=fa.basename(e);ha.isTemplateFile(e)&&(i=i.substring(0,i.indexOf(".")),t.push({name:i,path:e,title:"自定义模板",local:!0,existsFiles:{schema:!0}}))})),da.http.request({url:"https://ide.liuyingyong.cn/serverless/opendb/search",method:"post",serviceOptions:{serviceRequest:!0}}).then((async e=>{if(e&&e.service&&1001===e.service.code){const n=e.service.body.collections;for(let e=0;e<n.length;++e)t.push({name:n[e].name,path:"",title:n[e].title,local:!1,detail:n[e].detail,existsFiles:{schema:n[e].hasSchema,index:n[e].hasIndex,initData:n[e].hasData,schemaExt:n[e].hasSchemaExt}})}else console.error(e);this.updateForm(va({},{fileNameInput:t.length>0?t[0].name:"",templateList:t}))})).finally((()=>{this.hideLoading()}))},onChanged:function(e,n,i){if("templateList"!==e)return;const o=t[n];if(o.existsFiles){const e={schema:"定义文件(schema.json)",index:"索引文件(index.json)",initData:"初始化数据文件(init_data.json)",schemaExt:"定义扩展js文件(schema.ext.js)"},t=Object.keys(o.existsFiles).filter((e=>o.existsFiles[e])).map((t=>e[t]));t.length&&(i.tipLabel=`  将会创建${t.join("、")}`)}i.fileNameInput=o.name,this.updateForm(va(i,{templateList:t}))},validate:async function(e){if(this.showError(""),!e.fileNameInput)return this.showError("请输入文件名"),!1;if(!/^[a-zA-Z][a-zA-Z0-9-_.]*$/.test(e.fileNameInput))return this.showError("表名仅能以字母开头，只允许使用大小写字母、数字、连字符（-）及下划线（_）"),!1;if(!e.dirPathInput)return this.showError("请选择文件路径"),!1;if(e.templateList<0)return this.showError("请选择模板"),!1;if(pa.existsSync(e.dirPathInput+"/"+e.fileNameInput+".schema.json"))return this.showError("选择的位置已存在同名的数据集合Schema"),!1;const n=t[e.templateList];if(n.local)return!0;const i=await da.http.request({url:"https://ide.liuyingyong.cn/serverless/opendb/meta-data",method:"post",serviceOptions:{serviceRequest:!0,body:{name:n.name}}});return!(!i||!i.service||1001!==i.service.code)||(this.showError(i.error),!1)}}).then((async e=>{const{dirPathInput:n,fileNameInput:i}=e,o=t[e.templateList];if(!o)return;pa.ensureDirSync(n);const r=n+"/"+i+".schema.json",s=n+"/"+i+".schema.ext.js",a=n+"/"+i+".init_data.json",c=n+"/"+i+".index.json";if(o.local){const e=pa.readFileSync(o.path,"utf-8");return e&&(pa.writeFileSync(r,e,{encoding:"utf-8"}),da.workspace.openTextDocument(r)),!1}const l=await da.http.request({url:"https://ide.liuyingyong.cn/serverless/opendb/meta-data",method:"post",serviceOptions:{serviceRequest:!0,body:{name:o.name}}});if(l&&l.service&&l.service.code&&1001===l.service.code&&l.data){const e=JSON.parse(l.data);if(e&&e.body&&e.body.schemaExt&&(pa.existsSync(s)||pa.writeFileSync(s,e.body.schemaExt,{encoding:"utf-8"})),e&&e.body&&(e.body.index||e.body.collection&&e.body.collection.index)){const t=JSON.stringify(e.body.index||e.body.collection.index,null,"\t");pa.existsSync(c)||pa.writeFileSync(c,t,{encoding:"utf-8"})}if(e&&e.body&&(e.body.data||e.body.collection&&e.body.collection.data)){const t=!o.local&&i!==o.name;let n=JSON.stringify(e.body.data||e.body.collection.data,null,"\t");if("url"===e.body.dataType&&t){const t=await ma(e.body.data);n=JSON.stringify(t,null,"\t")}pa.existsSync(a)||pa.writeFileSync(a,t?n:JSON.stringify([]),{encoding:"utf-8"})}if(e&&e.body&&(e.body.schema||e.body.collection&&e.body.collection.schema)){const t=JSON.stringify(e.body.schema||e.body.collection.schema,null,"\t");t&&(pa.writeFileSync(r,t,{encoding:"utf-8"}),da.workspace.openTextDocument(r))}}else console.error(l)}))};const xa=C.default,ba=F.default,Sa=O.default,ka=E.default,Ea=jn,{getWorkspaceBindServiceSpace:_a}=Ct,Ca=ca;async function Ia(e){if(!e)return;const t=e.schema,n=[],i=e.serverPath,o=e.updateSchemas;if(!i)return;if(!Sa.existsSync(i))return;if(!Sa.statSync(i).isDirectory())return;if(o&&Array.isArray(o))for(const e in o){const i=o[e];if(!i)continue;const r=i.local,s=i.server,a=Ca.getDBSchemaVersion(r),c=Ca.getDBSchemaVersion(s);let l=!1;Ca.fileExists(r)&&(l=!0);let u=null;if(l){const e=".schema.json",t=ka.basename(r);t&&t.endsWith(e)&&(u=t.substring(0,t.length-e.length))}let d=!1;t&&(d=!0),c&&(a?c>a&&(d=!0):d=!0);const p={name:u,schema:t,version:a,endVersion:c};!t&&p.hasOwnProperty("schema")&&delete p.schema,d&&u&&n.push(p)}if(!n)return;if(n&&n.length<1)return;const r=e.workspaceFolder,s=await _a({workspaceFolder:r});let a,c,l;r&&(c=r.appid),s&&(a=s.provider,l=s.spaceId);const u={appid:c,provider:a,spaceId:l,collections:n};!a&&u.hasOwnProperty("provider")&&delete u.provider,!l&&u.hasOwnProperty("spaceId")&&delete u.spaceId;const d=await xa.http.request({url:"https://ide.liuyingyong.cn/serverless/clientdb/schema-update",method:"post",serviceOptions:{serviceRequest:!0,body:u}});if(d&&d.service&&1001===d.service.code){const e=d.service.body;if(e){let t=ba.tmpdir();const n=Date.now();t=ka.join(t,n.toString()+".zip");const o=e.file;if(o)return await xa.http.request({url:o,downloadFile:t}),new Ea(t).extractAllTo(i,!0),Sa.existsSync(t)||Sa.rmSync(t,{recursive:!0}),0}}}var ja={updateDbSchemaResource:async function(e){const t=e.fsPath;if(!t)return;const n=ka.basename(t),i=t.substring(0,t.length-n.length),o=ka.join(ba.tmpdir(),".dbschame"),r=Date.now(),s=ka.join(o,r.toString());Sa.existsSync(s)||Sa.mkdirSync(s,{recursive:!0});const a=e.workspaceFolder,c=[{local:t,server:s}];if(0===await Ia({workspaceFolder:a,schema:!0,serverPath:s,updateSchemas:c})&&0===await xa.workspace.copyFileWithPrompt({src:ka.join(s,"/"),dest:i,defaction:"compare",showcomparebutton:!0,filter:function(e){return 0},errorHandler:function(e){return 0}})){const e=xa.window.createOutputChannel("HBuilder"),t=[];Sa.readdirSync(s).forEach((e=>{e&&e.endsWith(".jql")&&t.push(e)}));let i="更新完成，更新到云端还需执行如下步骤:",o="选择该文件右键菜单点击【上传DB Schema】";if(t&&t.length>0&&(o="1. "+o),i=n+i,e.appendLine(i),e.appendLine(o),t&&t.length>0){let n="2. 依次打开并执行";n+=t.join("、"),e.appendLine(n)}}},updateDBSchema:Ia},Oa={EOL:F.default.EOL||"\n",tryParseNumber:function(e,t){var n,i,o="",r=0,s=!0,a=0;function c(){return i=e.charAt(a),a++,i}for(c(),"-"===i&&(o="-",c());i>="0"&&i<="9";)s&&("0"==i?r++:s=!1),o+=i,c();if(s&&r--,"."===i)for(o+=".";c()&&i>="0"&&i<="9";)o+=i;if("e"===i||"E"===i)for(o+=i,c(),"-"!==i&&"+"!==i||(o+=i,c());i>="0"&&i<="9";)o+=i,c();for(;i&&i<=" ";)c();return t&&(","!==i&&"}"!==i&&"]"!==i&&"#"!==i&&("/"!==i||"/"!==e[a]&&"*"!==e[a])||(i=0)),n=+o,i||r||!isFinite(n)?void 0:n},createComment:function(e,t){return Object.defineProperty&&Object.defineProperty(e,"__COMMENTS__",{enumerable:!1,writable:!0}),e.__COMMENTS__=t||{}},removeComment:function(e){Object.defineProperty(e,"__COMMENTS__",{value:void 0})},getComment:function(e){return e.__COMMENTS__},forceComment:function(e){if(!e)return"";var t,n,i,o,r=e.split("\n");for(i=0;i<r.length;i++)for(o=(t=r[i]).length,n=0;n<o;n++){var s=t[n];if("#"===s)break;if("/"===s&&("/"===t[n+1]||"*"===t[n+1])){"*"===t[n+1]&&(i=r.length);break}if(s>" "){r[i]="# "+t;break}}return r.join("\n")}};function Pa(e,t){if(e)for(var n=0;n<e.length;n++){var i=e[n](t);if(void 0!==i)return i}}function La(){}function Na(e){return"{"===e||"}"===e||"["===e||"]"===e||","===e}function Fa(){return{name:"math",parse:function(e){switch(e){case"+inf":case"inf":case"+Inf":case"Inf":return 1/0;case"-inf":case"-Inf":return-1/0;case"nan":case"NaN":return NaN}},stringify:function(e){if("number"==typeof e)return 1/e==-1/0?"-0":e===1/0?"Inf":e===-1/0?"-Inf":isNaN(e)?"NaN":void 0}}}function Ta(e){var t=e&&e.out;return{name:"hex",parse:function(e){if(/^0x[0-9A-Fa-f]+$/.test(e))return parseInt(e,16)},stringify:function(e){if(t&&Number.isInteger(e))return"0x"+e.toString(16)}}}function Da(){return{name:"date",parse:function(e){if(/^\d{4}-\d{2}-\d{2}$/.test(e)||/^\d{4}-\d{2}-\d{2}T\d{2}\:\d{2}\:\d{2}(?:.\d+)(?:Z|[+-]\d{2}:\d{2})$/.test(e)){var t=Date.parse(e);if(!isNaN(t))return new Date(t)}},stringify:function(e){if("[object Date]"===Object.prototype.toString.call(e)){var t=e.toISOString();return-1!==t.indexOf("T00:00:00.000Z",t.length-14)?t.substr(0,10):t}}}}Fa.description="support for Inf/inf, -Inf/-inf, Nan/naN and -0",Ta.description="parse hexadecimal numbers prefixed with 0x",Da.description="support ISO dates";var $a={loadDsf:function(e,t){if("[object Array]"!==Object.prototype.toString.apply(e)){if(e)throw new Error("dsf option must contain an array!");return La}if(0===e.length)return La;var n=[];function i(e){return"[object Function]"==={}.toString.call(e)}return e.forEach((function(e){if(!e.name||!i(e.parse)||!i(e.stringify))throw new Error("extension does not match the DSF interface");n.push((function(){try{if("parse"==t)return e.parse.apply(null,arguments);if("stringify"==t){var n=e.stringify.apply(null,arguments);if(void 0!==n&&("string"!=typeof n||0===n.length||'"'===n[0]||[].some.call(n,(function(e){return Na(e)}))))throw new Error("value may not be empty, start with a quote or contain a punctuator character except colon: "+n);return n}throw new Error("Invalid type")}catch(t){throw new Error("DSF-"+e.name+" failed; "+t.message)}}))})),Pa.bind(null,n)},std:{math:Fa,hex:Ta,date:Da}},Ra=Oa;function Aa(e,t,n){var i;return e&&(i={b:e}),t&&((i=i||{}).a=t),n&&((i=i||{}).x=n),i}function Ba(e,t){if(null!==e&&"object"==typeof e){var n,i,o,r,s=Ra.getComment(e);if(s&&Ra.removeComment(e),"[object Array]"===Object.prototype.toString.apply(e)){for(r={a:{}},n=0,i=e.length;n<i;n++)Ma(r.a,n,s.a[n],Ba(e[n]))&&(o=!0);!o&&s.e&&(r.e=Aa(s.e[0],s.e[1]),o=!0)}else{r={s:{}};var a,c=Object.keys(e);for(s&&s.o?(a=[],s.o.concat(c).forEach((function(t){Object.prototype.hasOwnProperty.call(e,t)&&a.indexOf(t)<0&&a.push(t)}))):a=c,r.o=a,n=0,i=a.length;n<i;n++){var l=a[n];Ma(r.s,l,s.c[l],Ba(e[l]))&&(o=!0)}!o&&s.e&&(r.e=Aa(s.e[0],s.e[1]),o=!0)}return t&&s&&s.r&&(r.r=Aa(s.r[0],s.r[1])),o?r:void 0}}function Ma(e,t,n,i){var o=Aa(n?n[0]:void 0,n?n[1]:void 0,i);return o&&(e[t]=o),o}function Ua(e,t){var n=Aa(t.b,t.a);return n.path=e,n}function qa(e,t,n){if(e){var i,o;if(e.a)for(i=0,o=e.a.length;i<o;i++){var r=n.slice().concat([i]),s=e.a[i];s&&(t.push(Ua(r,s)),qa(s.x,t,r))}else e.o&&e.o.forEach((function(i){var o=n.slice().concat([i]),r=e.s[i];r&&(t.push(Ua(o,r)),qa(r.x,t,o))}));e.e&&t.push(Ua(n,e.e))}}function Wa(e,t,n,i){if(e)if(null!==t&&"object"==typeof t){var o,r=Ra.createComment(t);if(0===i.length&&e.r&&(r.r=[e.r.b,e.r.a]),"[object Array]"===Object.prototype.toString.apply(t)){r.a=[];var s=e.a||{};for(var a in s)if(s.hasOwnProperty(a)){o=parseInt(a);var c=e.a[a];if(c){var l=i.slice().concat([o]);o<t.length?(r.a[o]=[c.b,c.a],Wa(c.x,t[o],n,l)):(n.push(Ua(l,c)),qa(c.x,n,l))}}0===o&&e.e&&(r.e=[e.e.b,e.e.a])}else r.c={},r.o=[],(e.o||[]).forEach((function(o){var s=i.slice().concat([o]),a=e.s[o];Object.prototype.hasOwnProperty.call(t,o)?(r.o.push(o),a&&(r.c[o]=[a.b,a.a],Wa(a.x,t[o],n,s))):a&&(n.push(Ua(s,a)),qa(a.x,n,s))})),e.e&&(r.e=[e.e.b,e.e.a])}else qa(e,n,i)}function Ja(e,t,n){var i=Ra.createComment(e,Ra.getComment(e));return i.r||(i.r=["",""]),(t||""===t)&&(i.r[n]=Ra.forceComment(t)),i.r[n]||""}var Ha={extract:function(e){return Ba(e,!0)},merge:function(e,t){var n=[];if(Wa(e,t,n,[]),n.length>0){var i=Ja(t,null,1);i+="\n# Orphaned comments:\n",n.forEach((function(e){i+=("# "+e.path.join("/")+": "+function(){var e="";return[].forEach.call(arguments,(function(t){t&&""!==t.trim()&&(e&&(e+="; "),e+=t.trim())})),e}(e.b,e.a,e.e)).replace("\n","\\n ")+"\n"})),Ja(t,i,1)}},header:function(e,t){return Ja(e,t,0)},footer:function(e,t){return Ja(e,t,1)}},Va=Oa,za=function(e,t){var n,i,o,r,s,a=Oa,c=$a,l={'"':'"',"'":"'","\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"};function u(){i=0,o=" "}function d(e){return"{"===e||"}"===e||"["===e||"]"===e||","===e||":"===e}function p(e){var t,o=0,r=1;for(t=i-1;t>0&&"\n"!==n[t];t--,o++);for(;t>0;t--)"\n"===n[t]&&r++;throw new Error(e+" at line "+r+","+o+" >>>"+n.substr(i-o,20)+" ...")}function f(){return o=n.charAt(i),i++,o}function h(e){return n.charAt(i+e)}function m(e){for(var t="",n=o;f();){if(o===n)return f(),e&&"'"===n&&"'"===o&&0===t.length?(f(),g()):t;if("\\"===o)if(f(),"u"===o){for(var i=0,r=0;r<4;r++){f();var s,a=o.charCodeAt(0);o>="0"&&o<="9"?s=a-48:o>="a"&&o<="f"?s=a-97+10:o>="A"&&o<="F"?s=a-65+10:p("Bad \\u char "+o),i=16*i+s}t+=String.fromCharCode(i)}else{if("string"!=typeof l[o])break;t+=l[o]}else"\n"===o||"\r"===o?p("Bad string containing newline"):t+=o}p("Bad string")}function g(){for(var e="",t=0,n=0;;){var i=h(-n-5);if(!i||"\n"===i)break;n++}function r(){for(var e=n;o&&o<=" "&&"\n"!==o&&e-- >0;)f()}for(;o&&o<=" "&&"\n"!==o;)f();for("\n"===o&&(f(),r());;){if(o){if("'"===o){if(t++,f(),3===t)return"\n"===e.slice(-1)&&(e=e.slice(0,-1)),e;continue}for(;t>0;)e+="'",t--}else p("Bad multiline string");"\n"===o?(e+="\n",f(),r()):("\r"!==o&&(e+=o),f())}}function y(){if('"'===o||"'"===o)return m(!1);for(var e="",t=i,n=-1;;){if(":"===o)return e?n>=0&&n!==e.length&&(i=t+n,p("Found whitespace in your key name (use quotes to include)")):p("Found ':' but no key name (for an empty key name use quotes)"),e;o<=" "?o?n<0&&(n=e.length):p("Found EOF while looking for a key name (check your syntax)"):d(o)?p("Found '"+o+"' where a key name was expected (check your syntax or use quotes if the key name includes {}[],: or whitespace)"):e+=o,f()}}function v(){for(;o;){for(;o&&o<=" ";)f();if("#"===o||"/"===o&&"/"===h(0))for(;o&&"\n"!==o;)f();else{if("/"!==o||"*"!==h(0))break;for(f(),f();o&&("*"!==o||"/"!==h(0));)f();o&&(f(),f())}}}function w(e,t){var o;for(e--,o=i-2;o>e&&n[o]<=" "&&"\n"!==n[o];o--);"\n"===n[o]&&o--,"\r"===n[o]&&o--;var r=n.substr(e,o-e+1);for(o=0;o<r.length;o++)if(r[o]>" "){var s=r.indexOf("\n");if(s>=0){var a=[r.substr(0,s),r.substr(s+1)];return t&&0===a[0].trim().length&&a.shift(),a}return[r]}return[]}function x(e){function t(e,n){var i,o,r,s;switch(typeof e){case"string":e.indexOf(n)>=0&&(s=e);break;case"object":if("[object Array]"===Object.prototype.toString.apply(e))for(i=0,r=e.length;i<r;i++)s=t(e[i],n)||s;else for(o in e)Object.prototype.hasOwnProperty.call(e,o)&&(s=t(e[o],n)||s)}return s}function n(n){var i=t(e,n);return i?"found '"+n+"' in a string value, your mistake could be with:\n  > "+i+"\n  (unquoted strings contain everything up to the next line!)":""}return n("}")||n("]")}function b(){var e,t,n,s=[];try{if(r&&(e=a.createComment(s,{a:[]})),f(),t=i,v(),e&&(n=w(t,!0).join("\n")),"]"===o)return f(),e&&(e.e=[n]),s;for(;o;){if(s.push(E()),t=i,v(),","===o&&(f(),t=i,v()),e){var c=w(t);e.a.push([n||"",c[0]||""]),n=c[1]}if("]"===o)return f(),e&&(e.a[e.a.length-1][1]+=n||""),s;v()}p("End of input while parsing an array (missing ']')")}catch(e){throw e.hint=e.hint||x(s),e}}function S(e){var t,n,s,c="",l={};try{if(r&&(t=a.createComment(l,{c:{},o:[]})),e?n=1:(f(),n=i),v(),t&&(s=w(n,!0).join("\n")),"}"===o&&!e)return t&&(t.e=[s]),f(),l;for(;o;){if(c=y(),v(),":"!==o&&p("Expected ':' instead of '"+o+"'"),f(),l[c]=E(),n=i,v(),","===o&&(f(),n=i,v()),t){var u=w(n);t.c[c]=[s||"",u[0]||""],s=u[1],t.o.push(c)}if("}"===o&&!e)return f(),t&&(t.c[c][1]+=s||""),l;v()}if(e)return l;p("End of input while parsing an object (missing '}')")}catch(e){throw e.hint=e.hint||x(l),e}}function E(){switch(v(),o){case"{":return S();case"[":return b();case"'":case'"':return m(!0);default:return function(){var e=o;for(d(o)&&p("Found a punctuator character '"+o+"' when expecting a quoteless string (check your syntax)");;){f();var t="\r"===o||"\n"===o||""===o;if(t||","===o||"}"===o||"]"===o||"#"===o||"/"===o&&("/"===h(0)||"*"===h(0))){var n=e[0];switch(n){case"f":if("false"===e.trim())return!1;break;case"n":if("null"===e.trim())return null;break;case"t":if("true"===e.trim())return!0;break;default:if("-"===n||n>="0"&&n<="9"){var i=a.tryParseNumber(e);if(void 0!==i)return i}}if(t){e=e.trim();var r=s(e);return void 0!==r?r:e}}e+=o}}()}}function C(e,t){var n=i;if(v(),o&&p("Syntax error, found trailing characters"),r){var s=t.join("\n"),c=w(n).join("\n");(c||s)&&(a.createComment(e,a.getComment(e)).r=[s,c])}return e}if("string"!=typeof e)throw new Error("source is not a string");var k=null,_=!0;return t&&"object"==typeof t&&(r=t.keepWsc,k=t.dsf,_=!1!==t.legacyRoot),s=c.loadDsf(k,"parse"),n=e,u(),_?function(){v();var e=r?w(1):null;switch(o){case"{":return C(S(),e);case"[":return C(b(),e)}try{return C(S(!0),e)}catch(t){u();try{return C(E(),e)}catch(e){throw t}}}():function(){v();var e=r?w(1):null;switch(o){case"{":return C(S(),e);case"[":return C(b(),e);default:return C(E(),e)}}()},Ga=function(e,t){var n,i=Oa,o=$a,r={obj:["{","}"],arr:["[","]"],key:["",""],qkey:['"','"'],col:[":",""],com:[",",""],str:["",""],qstr:['"','"'],mstr:["'''","'''"],num:["",""],lit:["",""],dsf:["",""],esc:["\\",""],uni:["\\u",""],rem:["",""]},s=i.EOL,a="  ",c=!1,l=!1,u=!1,d=!1,p=0,f=1,h="",m=null,g=!1,y=r;if(t&&"object"==typeof t){t.quotes="always"===t.quotes?"strings":t.quotes,"\n"!==t.eol&&"\r\n"!==t.eol||(s=t.eol),c=t.keepWsc,p=t.condense||0,l=t.bracesSameLine,u="all"===t.quotes||"keys"===t.quotes,d="all"===t.quotes||"strings"===t.quotes||!0===t.separator,f=d||"off"==t.multiline?0:"no-tabs"==t.multiline?2:1,h=!0===t.separator?y.com[0]:"",m=t.dsf,g=t.sortProps,"number"==typeof t.space?a=new Array(t.space+1).join(" "):"string"==typeof t.space&&(a=t.space),!0===t.colors&&(y={obj:["[37m{[0m","[37m}[0m"],arr:["[37m[[0m","[37m][0m"],key:["[33m","[0m"],qkey:['[33m"','"[0m'],col:["[37m:[0m",""],com:["[37m,[0m",""],str:["[37;1m","[0m"],qstr:['[37;1m"','"[0m'],mstr:["[37;1m'''","'''[0m"],num:["[36;1m","[0m"],lit:["[36m","[0m"],dsf:["[37m","[0m"],esc:["[31m\\","[0m"],uni:["[31m\\u","[0m"],rem:["[35m","[0m"]});var v,w=Object.keys(r);for(v=w.length-1;v>=0;v--){var x=w[v];y[x].push(r[x][0].length,r[x][1].length)}}var b="-­؀-؄܏឴឵‌-‏\u2028- ⁠-⁯\ufeff￰-￿",S=new RegExp('[\\\\\\"\0-'+b+"]","g"),E=new RegExp("^\\s|^\"|^'|^#|^\\/\\*|^\\/\\/|^\\{|^\\}|^\\[|^\\]|^:|^,|\\s$|[\0-"+b+"]","g"),C=new RegExp("'''|^[\\s]+$|[\0-"+(2===f?"\t":"\b")+"\v\f-"+b+"]","g"),k=new RegExp("^(true|false|null)\\s*((,|\\]|\\}|#|//|/\\*).*)?$"),_={"\b":"b","\t":"t","\n":"n","\f":"f","\r":"r",'"':'"',"\\":"\\"},I=/[,\{\[\}\]\s:#"']|\/\/|\/\*/,j="",O=0;function L(e,t){return O+=e[0].length+e[1].length-e[2]-e[3],e[0]+t+e[1]}function P(e){return e.replace(S,(function(e){var t=_[e];return"string"==typeof t?L(y.esc,t):L(y.uni,("0000"+e.charCodeAt(0).toString(16)).slice(-4))}))}function N(e,t,n,o){return e?(E.lastIndex=0,k.lastIndex=0,d||n||E.test(e)||void 0!==i.tryParseNumber(e,!0)||k.test(e)?(S.lastIndex=0,C.lastIndex=0,S.test(e)?C.test(e)||o||!f?L(y.qstr,P(e)):function(e,t){var n,i=e.replace(/\r/g,"").split("\n");if(t+=a,1===i.length)return L(y.mstr,i[0]);var o=s+t+y.mstr[0];for(n=0;n<i.length;n++)o+=s,i[n]&&(o+=t+i[n]);return o+s+t+y.mstr[1]}(e,t):L(y.qstr,e)):L(y.str,e)):L(y.qstr,"")}function F(e){return e?u||I.test(e)?(S.lastIndex=0,L(y.qkey,S.test(e)?P(e):e)):L(y.key,e):'""'}n=o.loadDsf(m,"stringify");var T="",D=c?D=(i.getComment(e)||{}).r:null;return D&&D[0]&&(T=D[0]+"\n"),T+=function e(t,o,r,u){function m(e){return e&&"\n"===e["\r"===e[0]?1:0]}function v(e){return e&&!m(e)}function w(e,t,n){if(!e)return"";var o,r=(e=i.forceComment(e)).length;for(o=0;o<r&&e[o]<=" ";o++);return n&&o>0&&(e=e.substr(o)),o<r?t+L(y.rem,e):e}var x=n(t);if(void 0!==x)return L(y.dsf,x);switch(typeof t){case"string":return N(t,j,o,u);case"number":return isFinite(t)?L(y.num,String(t)):L(y.lit,"null");case"boolean":return L(y.lit,String(t));case"object":if(!t)return L(y.lit,"null");var b;c&&(b=i.getComment(t));var S,E,C,k,_,I,P,T,D,$,R="[object Array]"===Object.prototype.toString.apply(t),A=j,B=s+A,M=s+(j+=a),U=r||l?"":B,q=[],W=p?[]:null,J=d,V=f,H=h?"":y.com[0],z=0;if(R){for(E=0,C=t.length;E<C;E++){if(S=E<C-1,b?(T=v((P=b.a[E]||[])[1]),q.push(w(P[0],"\n")+M),W&&(P[0]||P[1]||T)&&(W=null)):q.push(M),O=0,_=t[E],q.push(e(_,!!b&&T,!0)+(S?h:"")),W){switch(typeof _){case"string":O=0,d=!0,f=0,W.push(e(_,!1,!0)+(S?y.com[0]:"")),d=J,f=V;break;case"object":if(_){W=null;break}default:W.push(q[q.length-1]+(S?H:""))}S&&(O+=y.com[0].length-y.com[2]),z+=O}b&&P[1]&&q.push(w(P[1],T?" ":"\n",T))}0===C?b&&b.e&&q.push(w(b.e[0],"\n")+B):q.push(B),0===q.length?D=L(y.arr,""):(D=U+L(y.arr,q.join("")),W&&($=W.join(" ")).length-z<=p&&(D=L(y.arr,$)))}else{var G=b?b.o.slice():[],K=[];for(k in t)Object.prototype.hasOwnProperty.call(t,k)&&G.indexOf(k)<0&&K.push(k);g&&K.sort();var Z=G.concat(K);for(E=0,C=Z.length;E<C;E++)if(S=E<C-1,k=Z[E],b?(T=v((P=b.c[k]||[])[1]),q.push(w(P[0],"\n")+M),W&&(P[0]||P[1]||T)&&(W=null)):q.push(M),O=0,I=e(_=t[k],b&&T),q.push(F(k)+y.col[0]+(m(I)?"":" ")+I+(S?h:"")),b&&P[1]&&q.push(w(P[1],T?" ":"\n",T)),W){switch(typeof _){case"string":O=0,d=!0,f=0,I=e(_,!1),d=J,f=V,W.push(F(k)+y.col[0]+" "+I+(S?y.com[0]:""));break;case"object":if(_){W=null;break}default:W.push(q[q.length-1]+(S?H:""))}O+=y.col[0].length-y.col[2],S&&(O+=y.com[0].length-y.com[2]),z+=O}0===C?b&&b.e&&q.push(w(b.e[0],"\n")+B):q.push(B),0===q.length?D=L(y.obj,""):(D=U+L(y.obj,q.join("")),W&&($=W.join(" ")).length-z<=p&&(D=L(y.obj,$)))}return j=A,D}}(e,null,!0,!0),D&&(T+=D[1]||""),T},Ka={parse:za,stringify:Ga,endOfLine:function(){return Va.EOL},setEndOfLine:function(e){"\n"!==e&&"\r\n"!==e||(Va.EOL=e)},version:"3.2.1",rt:{parse:function(e,t){return(t=t||{}).keepWsc=!0,za(e,t)},stringify:function(e,t){return(t=t||{}).keepWsc=!0,Ga(e,t)}},comments:Ha,dsf:$a.std};class Za extends Error{constructor(e){const{message:t,code:n}=e||{};super(t),this.code=n}}const Ya=-32603,Xa="JSON_RPC_MESSAGE_CALL",Qa="JSON_RPC_MESSAGE_RESPONSE";class ec{constructor(e){const{bridge:t,timeout:n=3e4}=e||{};this._timeout=n,this._bridge=t,this._methodMap=new Map,this._promiseMap=new Map,this._callMessageId=0,this._messageCallback=e=>{!function(e){return e.type===Xa}(e)?function(e){return e.type===Qa&&!!e.result}(e)?this._processResponseSuccessMessage(e):function(e){return e.type===Qa&&!!e.error}(e)&&this._processResponseFailMessage(e):this._processCallMessage(e)},this._bridge.on("message",this._messageCallback)}_processCallMessage(e){const{id:t,method:n,params:i}=e||{};this._methodMap.has(n)||this._fail(t,-32601,`method[${n}] not found`);const o=this._methodMap.get(n);try{const e=o(i);e&&"function"==typeof e.then?e.then((e=>{this._success(t,e||{})})).catch((e=>{this._fail(t,Ya,e.message)})):this._success(t,e||{})}catch(e){this._fail(t,Ya,e.message)}}_processResponseSuccessMessage(e){const{id:t,result:n}=e||{};if(!this._promiseMap.has(t))return;const{resolve:i}=this._promiseMap.get(t);this._promiseMap.delete(t),i(n)}_processResponseFailMessage(e){const{id:t,error:n}=e||{};if(!this._promiseMap.has(t))return;const{reject:i}=this._promiseMap.get(t);this._promiseMap.delete(t),i(new Za({code:n.code,message:n.message}))}_send(e){this._bridge.send(e)}_success(e,t){this._send({id:e,type:Qa,result:t})}_fail(e,t,n){this._send({type:Qa,id:e,error:{code:t,message:n}})}call(e,t){return new Promise(((n,i)=>{const o=++this._callMessageId;this._send({type:Xa,id:o,method:e,params:t||{}}),this._promiseMap.set(o,{resolve:n,reject:i}),setTimeout((()=>{this._promiseMap.delete(o),i(new Za({code:-32e3,message:"Invoke method timeout"}))}),this._timeout)}))}expose(e,t){this._methodMap.set(e,t)}close(){this._bridge.off&&this._bridge.off("message",this._messageCallback)}}class tc extends ec{constructor({bridgeProcess:e}){super({bridge:e})}}class nc extends ec{constructor({bridgeProcess:e}){super({bridge:e})}}const ic=process.env.UNICLOUD_DEBUGGER_PATH||E.default.resolve(__dirname,"../");class oc extends Error{constructor(e,t){super(e),this.code=t}}function rc(e){return Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}function sc(e){try{return O.default.statSync(e).isDirectory()}catch(e){return!1}}function ac(e){return Ka.parse(e.replace("\r\n","\n").replace("\r","\n"))}function cc(e){let t=O.default.readFileSync(e);return 239===t[0]&&187===t[1]&&191===t[2]&&(t=t.slice(3)),t.toString("utf-8")}function lc(e){return ac(cc(e))}function uc(e){const t=new T.default.Script(e),n=T.default.createContext({Date:Date,RegExp:RegExp});return t.runInContext(n)}function dc(e){return[E.default.resolve(e,"src","manifest.json"),E.default.resolve(e,"src","pages.json")].every((e=>O.default.existsSync(e)))}function pc(e){return O.default.existsSync(E.default.resolve(e,"encrypt"))}class fc{constructor({parent:e,type:t,start:n,end:i,startIndex:o,endIndex:r}={}){this.parent=e,this.type=t,this.start=n,this.end=i,this.startIndex=o,this.endIndex=r}}const hc=[{start:"(",end:")",type:"bracket"},{start:"{",end:"}",type:"bracket"},{start:"'",end:"'",type:"string"},{start:'"',end:'"',type:"string"},{start:"`",end:"`",type:"string"},{start:"//",end:"\n",type:"comment"},{start:"/*",end:"*/",type:"comment"}],mc={root:["comment","bracket","string"],bracket:["comment","bracket","string"],comment:[],string:[]};function gc({content:e,index:t,lastRealm:n,currentRealm:i}={}){const o=n&&n.endIndex||0;for(let n=0;n<hc.length;n++){const{start:r,end:s,type:a}=hc[n];if(s===e.substring(t+1-s.length,t+1)&&i.end===s)return{start:r,end:s,type:a,matchType:"end"};if(t+1-o>=r.length&&r===e.substring(t+1-r.length,t+1))return{start:r,end:s,type:a,matchType:"start"}}}function yc(e,t={}){let n=new fc({parent:null,type:"root",start:"root",end:"root",startIndex:0}),i=n;function o(e){n.endIndex=e+1,t.onRealmClosed&&t.onRealmClosed(n),i=n,n=n.parent}function r(e,{type:t,start:i,end:o}={}){n=new fc({parent:n,type:t,start:i,end:o,startIndex:e})}for(let t=0;t<e.length;t++){const s=gc({content:e,index:t,lastRealm:i,currentRealm:n});if(!s)continue;const{start:a,end:c,type:l,matchType:u}=s;"start"===u?mc[n.type].includes(l)&&r(t+1-a.length,s):"end"===u&&n.end===c&&o(t)}for(;n;)o(e.length-1)}function vc(e){const t=e.replace(/\\/g,"/").match(/(.*?)\/(uniCloud-(?:aliyun|tcb|alipay)|src\/uni_modules|uni_modules)/);return t&&t[1]}function wc(e){const t=dc(e),n=E.default.resolve(e,t?"src":"","manifest.json");let i={};try{i=lc(n)}catch(e){}return i.appid}function xc(e){const t=E.default.resolve(e,dc(e)?"src":"","uni_modules");return sc(t)?O.default.readdirSync(t).filter((e=>!!sc(E.default.resolve(t,e)))):[]}function bc(e,t){O.default.existsSync(t)&&e.push(t)}function Sc(e,t,n){const i=[],o=E.default.resolve(e,`uniCloud-${t}`);bc(i,E.default.resolve(o,n));const r=xc(e);if(!r||0===r.length)return i;const s=function(e){let t={};try{t=lc(E.default.resolve(e,dc(e)?"src":"","uni-modules.config.json"))}catch(e){}let n=t&&t.uni_modules;return n&&"object"===rc(n)||(n={}),n}(e);for(let o=0;o<r.length;o++){const a=r[o];let c=s[a];c&&"array"===rc(c)||(c=[t]),c.indexOf(t)>-1&&bc(i,E.default.resolve(e,dc(e)?"src":"",`uni_modules/${a}/uniCloud`,n))}return i}function kc(e,t){return Sc(e,t,"cloudfunctions")}function Ec(e){const t=["common","uni-clientDB-actions"];let n=[];try{n=O.default.readdirSync(e).filter((e=>-1===t.indexOf(e))).map((t=>E.default.resolve(e,t)))}catch(e){}return n}function _c(e){let t=[];const n=E.default.resolve(e,"common");try{t=O.default.readdirSync(n).map((e=>E.default.resolve(n,e))).filter((e=>sc(e)))}catch(e){}return t}function Cc(e,t,n){const i=function(e,t,n){return Sc(e,t,`cloudfunctions/${n}`)}(e,t,n);if(0===i.length)throw new oc(`未匹配到云函数[${n}]`,"NOT_FOUND");if(i.length>1)throw console.error(`云函数[${n}]存在名称冲突，请解决冲突后再试。产生冲突的路径如下：`),i.forEach((e=>{console.error(e)})),new oc("云函数名称冲突，请解决后再试","CONFLICT_NAME");return i[0]}function Ic(e){const t=O.default.existsSync(E.default.resolve(e,"index.js")),n=O.default.existsSync(E.default.resolve(e,"index.obj.js"));if(t){if(n)throw new Error("云函数目录下index.js和index.obj.js不可同时存在");return"function"}if(n)return"object";throw new Error("未找到云函数入口")}function jc(e,t,n){const i=function(e,t,n){return Sc(e,t,`cloudfunctions/common/${n}`)}(e,t,n);if(0===i.length)throw new oc(`未找到公共模块[${n}]`,"NOT_FOUND");if(i.length>1)throw console.error(`公共模块[${n}]存在名称冲突，请解决冲突后再试。产生冲突的路径如下：`),i.forEach((e=>{console.error(e)})),new oc(`公共模块[${n}]名称冲突，请解决后再试', 'CONFLICT_NAME`);return i[0]}function Oc(e,t){const n=kc(e,t),i=[];for(let e=0;e<n.length;e++){const t=Ec(n[e]);i.push(...t)}return i}function Pc(e,t){return Oc(e,t).filter((e=>pc(e))).map((e=>({name:e.replace(/\\/g,"/").split("/").pop(),functionPath:e})))}function Lc(e,t){const n=Sc(e,t,"database/db_init.json"),i=[];for(let t=0;t<n.length;t++){const o=n[t];try{const e=lc(o);i.push(...Object.keys(e))}catch(e){}}return i}function Nc(e){const t=(e=e.replace(/\\/g,"/")).match(/uni_modules\/(.*?)\//);return t&&t[1]||""}function Fc(e){const t=Nc(e),n=_c(e),i=[];for(let e=0;e<n.length;e++){const o=n[e],r=o.replace(/\\/g,"/").split("/").pop();i.push({name:r,path:o,uniModuleId:t})}return i}function Tc(e){return e.replace(/\\/g,"/").split("/").pop()}function Dc(e){const t=Tc(e),n=E.default.resolve(e,`${t}.param.json`);return O.default.existsSync(n)?lc(n):{}}function $c(e){switch(Ic(e)){case"function":return Dc(e);case"object":return function(e){const t=`${Tc(e)}.param.js`,n=E.default.resolve(e,t);return O.default.existsSync(n)?function(e){const t=(e=function(e){const t=[];yc(e,{onRealmClosed:function(e){"comment"===e.type&&t.push(e)}});const n=e.split("");for(let e=t.length-1;e>=0;e--){const i=t[e];n.splice(i.startIndex,i.endIndex-i.startIndex)}return n.join("")}(e=e.replace(/\r\n/g,"\n"))).match(/(?:const\s+clientInfo[\s\n]*=[\s\n]*({[\s\S]+?});?)?[\s\n]*([a-zA-Z0-9_]+)[\s\n]*(\([\s\S]*\))/);if(!t)return{};let n;try{n=JSON.parse(JSON.stringify(t[1]?uc("a = "+t[1]):{}))}catch(e){throw console.error("解析clientInfo出错，clientInfo："+t[1]),e}const i=t[2]?t[2]:"";let o;if(t[3])try{o=JSON.parse(JSON.stringify(uc(function(e){let t;return yc(e,{onRealmClosed:function(e){"("===e.start&&0===e.startIndex&&(t=e)}}),t?"["+e.substring(t.startIndex+1,t.endIndex-1)+"]":"[]"}(t[3]))))}catch(e){throw console.error("解析云对象参数出错，params："+t[3]),e}else o=[];return{method:i,params:o,clientInfo:n}}(O.default.readFileSync(n).toString("utf8")):Dc(e)}(e);default:throw new Error("system error")}}const Rc={"application/andrew-inset":["ez"],"application/appinstaller":["appinstaller"],"application/applixware":["aw"],"application/appx":["appx"],"application/appxbundle":["appxbundle"],"application/atom+xml":["atom"],"application/atomcat+xml":["atomcat"],"application/atomdeleted+xml":["atomdeleted"],"application/atomsvc+xml":["atomsvc"],"application/atsc-dwd+xml":["dwd"],"application/atsc-held+xml":["held"],"application/atsc-rsat+xml":["rsat"],"application/automationml-aml+xml":["aml"],"application/automationml-amlx+zip":["amlx"],"application/bdoc":["bdoc"],"application/calendar+xml":["xcs"],"application/ccxml+xml":["ccxml"],"application/cdfx+xml":["cdfx"],"application/cdmi-capability":["cdmia"],"application/cdmi-container":["cdmic"],"application/cdmi-domain":["cdmid"],"application/cdmi-object":["cdmio"],"application/cdmi-queue":["cdmiq"],"application/cpl+xml":["cpl"],"application/cu-seeme":["cu"],"application/cwl":["cwl"],"application/dash+xml":["mpd"],"application/dash-patch+xml":["mpp"],"application/davmount+xml":["davmount"],"application/docbook+xml":["dbk"],"application/dssc+der":["dssc"],"application/dssc+xml":["xdssc"],"application/ecmascript":["ecma"],"application/emma+xml":["emma"],"application/emotionml+xml":["emotionml"],"application/epub+zip":["epub"],"application/exi":["exi"],"application/express":["exp"],"application/fdf":["fdf"],"application/fdt+xml":["fdt"],"application/font-tdpfr":["pfr"],"application/geo+json":["geojson"],"application/gml+xml":["gml"],"application/gpx+xml":["gpx"],"application/gxf":["gxf"],"application/gzip":["gz"],"application/hjson":["hjson"],"application/hyperstudio":["stk"],"application/inkml+xml":["ink","inkml"],"application/ipfix":["ipfix"],"application/its+xml":["its"],"application/java-archive":["jar","war","ear"],"application/java-serialized-object":["ser"],"application/java-vm":["class"],"application/javascript":["js"],"application/json":["json","map"],"application/json5":["json5"],"application/jsonml+json":["jsonml"],"application/ld+json":["jsonld"],"application/lgr+xml":["lgr"],"application/lost+xml":["lostxml"],"application/mac-binhex40":["hqx"],"application/mac-compactpro":["cpt"],"application/mads+xml":["mads"],"application/manifest+json":["webmanifest"],"application/marc":["mrc"],"application/marcxml+xml":["mrcx"],"application/mathematica":["ma","nb","mb"],"application/mathml+xml":["mathml"],"application/mbox":["mbox"],"application/media-policy-dataset+xml":["mpf"],"application/mediaservercontrol+xml":["mscml"],"application/metalink+xml":["metalink"],"application/metalink4+xml":["meta4"],"application/mets+xml":["mets"],"application/mmt-aei+xml":["maei"],"application/mmt-usd+xml":["musd"],"application/mods+xml":["mods"],"application/mp21":["m21","mp21"],"application/mp4":["mp4","mpg4","mp4s","m4p"],"application/msix":["msix"],"application/msixbundle":["msixbundle"],"application/msword":["doc","dot"],"application/mxf":["mxf"],"application/n-quads":["nq"],"application/n-triples":["nt"],"application/node":["cjs"],"application/octet-stream":["bin","dms","lrf","mar","so","dist","distz","pkg","bpk","dump","elc","deploy","exe","dll","deb","dmg","iso","img","msi","msp","msm","buffer"],"application/oda":["oda"],"application/oebps-package+xml":["opf"],"application/ogg":["ogx"],"application/omdoc+xml":["omdoc"],"application/onenote":["onetoc","onetoc2","onetmp","onepkg"],"application/oxps":["oxps"],"application/p2p-overlay+xml":["relo"],"application/patch-ops-error+xml":["xer"],"application/pdf":["pdf"],"application/pgp-encrypted":["pgp"],"application/pgp-keys":["asc"],"application/pgp-signature":["sig","asc"],"application/pics-rules":["prf"],"application/pkcs10":["p10"],"application/pkcs7-mime":["p7m","p7c"],"application/pkcs7-signature":["p7s"],"application/pkcs8":["p8"],"application/pkix-attr-cert":["ac"],"application/pkix-cert":["cer"],"application/pkix-crl":["crl"],"application/pkix-pkipath":["pkipath"],"application/pkixcmp":["pki"],"application/pls+xml":["pls"],"application/postscript":["ai","eps","ps"],"application/provenance+xml":["provx"],"application/pskc+xml":["pskcxml"],"application/raml+yaml":["raml"],"application/rdf+xml":["rdf","owl"],"application/reginfo+xml":["rif"],"application/relax-ng-compact-syntax":["rnc"],"application/resource-lists+xml":["rl"],"application/resource-lists-diff+xml":["rld"],"application/rls-services+xml":["rs"],"application/route-apd+xml":["rapd"],"application/route-s-tsid+xml":["sls"],"application/route-usd+xml":["rusd"],"application/rpki-ghostbusters":["gbr"],"application/rpki-manifest":["mft"],"application/rpki-roa":["roa"],"application/rsd+xml":["rsd"],"application/rss+xml":["rss"],"application/rtf":["rtf"],"application/sbml+xml":["sbml"],"application/scvp-cv-request":["scq"],"application/scvp-cv-response":["scs"],"application/scvp-vp-request":["spq"],"application/scvp-vp-response":["spp"],"application/sdp":["sdp"],"application/senml+xml":["senmlx"],"application/sensml+xml":["sensmlx"],"application/set-payment-initiation":["setpay"],"application/set-registration-initiation":["setreg"],"application/shf+xml":["shf"],"application/sieve":["siv","sieve"],"application/smil+xml":["smi","smil"],"application/sparql-query":["rq"],"application/sparql-results+xml":["srx"],"application/sql":["sql"],"application/srgs":["gram"],"application/srgs+xml":["grxml"],"application/sru+xml":["sru"],"application/ssdl+xml":["ssdl"],"application/ssml+xml":["ssml"],"application/swid+xml":["swidtag"],"application/tei+xml":["tei","teicorpus"],"application/thraud+xml":["tfi"],"application/timestamped-data":["tsd"],"application/toml":["toml"],"application/trig":["trig"],"application/ttml+xml":["ttml"],"application/ubjson":["ubj"],"application/urc-ressheet+xml":["rsheet"],"application/urc-targetdesc+xml":["td"],"application/voicexml+xml":["vxml"],"application/wasm":["wasm"],"application/watcherinfo+xml":["wif"],"application/widget":["wgt"],"application/winhlp":["hlp"],"application/wsdl+xml":["wsdl"],"application/wspolicy+xml":["wspolicy"],"application/xaml+xml":["xaml"],"application/xcap-att+xml":["xav"],"application/xcap-caps+xml":["xca"],"application/xcap-diff+xml":["xdf"],"application/xcap-el+xml":["xel"],"application/xcap-ns+xml":["xns"],"application/xenc+xml":["xenc"],"application/xfdf":["xfdf"],"application/xhtml+xml":["xhtml","xht"],"application/xliff+xml":["xlf"],"application/xml":["xml","xsl","xsd","rng"],"application/xml-dtd":["dtd"],"application/xop+xml":["xop"],"application/xproc+xml":["xpl"],"application/xslt+xml":["xsl","xslt"],"application/xspf+xml":["xspf"],"application/xv+xml":["mxml","xhvml","xvml","xvm"],"application/yang":["yang"],"application/yin+xml":["yin"],"application/zip":["zip"],"audio/3gpp":["3gpp"],"audio/aac":["adts","aac"],"audio/adpcm":["adp"],"audio/amr":["amr"],"audio/basic":["au","snd"],"audio/midi":["mid","midi","kar","rmi"],"audio/mobile-xmf":["mxmf"],"audio/mp3":["mp3"],"audio/mp4":["m4a","mp4a"],"audio/mpeg":["mpga","mp2","mp2a","mp3","m2a","m3a"],"audio/ogg":["oga","ogg","spx","opus"],"audio/s3m":["s3m"],"audio/silk":["sil"],"audio/wav":["wav"],"audio/wave":["wav"],"audio/webm":["weba"],"audio/xm":["xm"],"font/collection":["ttc"],"font/otf":["otf"],"font/ttf":["ttf"],"font/woff":["woff"],"font/woff2":["woff2"],"image/aces":["exr"],"image/apng":["apng"],"image/avci":["avci"],"image/avcs":["avcs"],"image/avif":["avif"],"image/bmp":["bmp","dib"],"image/cgm":["cgm"],"image/dicom-rle":["drle"],"image/dpx":["dpx"],"image/emf":["emf"],"image/fits":["fits"],"image/g3fax":["g3"],"image/gif":["gif"],"image/heic":["heic"],"image/heic-sequence":["heics"],"image/heif":["heif"],"image/heif-sequence":["heifs"],"image/hej2k":["hej2"],"image/hsj2":["hsj2"],"image/ief":["ief"],"image/jls":["jls"],"image/jp2":["jp2","jpg2"],"image/jpeg":["jpeg","jpg","jpe"],"image/jph":["jph"],"image/jphc":["jhc"],"image/jpm":["jpm","jpgm"],"image/jpx":["jpx","jpf"],"image/jxr":["jxr"],"image/jxra":["jxra"],"image/jxrs":["jxrs"],"image/jxs":["jxs"],"image/jxsc":["jxsc"],"image/jxsi":["jxsi"],"image/jxss":["jxss"],"image/ktx":["ktx"],"image/ktx2":["ktx2"],"image/png":["png"],"image/sgi":["sgi"],"image/svg+xml":["svg","svgz"],"image/t38":["t38"],"image/tiff":["tif","tiff"],"image/tiff-fx":["tfx"],"image/webp":["webp"],"image/wmf":["wmf"],"message/disposition-notification":["disposition-notification"],"message/global":["u8msg"],"message/global-delivery-status":["u8dsn"],"message/global-disposition-notification":["u8mdn"],"message/global-headers":["u8hdr"],"message/rfc822":["eml","mime"],"model/3mf":["3mf"],"model/gltf+json":["gltf"],"model/gltf-binary":["glb"],"model/iges":["igs","iges"],"model/jt":["jt"],"model/mesh":["msh","mesh","silo"],"model/mtl":["mtl"],"model/obj":["obj"],"model/prc":["prc"],"model/step+xml":["stpx"],"model/step+zip":["stpz"],"model/step-xml+zip":["stpxz"],"model/stl":["stl"],"model/u3d":["u3d"],"model/vrml":["wrl","vrml"],"model/x3d+binary":["x3db","x3dbz"],"model/x3d+fastinfoset":["x3db"],"model/x3d+vrml":["x3dv","x3dvz"],"model/x3d+xml":["x3d","x3dz"],"model/x3d-vrml":["x3dv"],"text/cache-manifest":["appcache","manifest"],"text/calendar":["ics","ifb"],"text/coffeescript":["coffee","litcoffee"],"text/css":["css"],"text/csv":["csv"],"text/html":["html","htm","shtml"],"text/jade":["jade"],"text/javascript":["js","mjs"],"text/jsx":["jsx"],"text/less":["less"],"text/markdown":["md","markdown"],"text/mathml":["mml"],"text/mdx":["mdx"],"text/n3":["n3"],"text/plain":["txt","text","conf","def","list","log","in","ini"],"text/richtext":["rtx"],"text/rtf":["rtf"],"text/sgml":["sgml","sgm"],"text/shex":["shex"],"text/slim":["slim","slm"],"text/spdx":["spdx"],"text/stylus":["stylus","styl"],"text/tab-separated-values":["tsv"],"text/troff":["t","tr","roff","man","me","ms"],"text/turtle":["ttl"],"text/uri-list":["uri","uris","urls"],"text/vcard":["vcard"],"text/vtt":["vtt"],"text/wgsl":["wgsl"],"text/xml":["xml"],"text/yaml":["yaml","yml"],"video/3gpp":["3gp","3gpp"],"video/3gpp2":["3g2"],"video/h261":["h261"],"video/h263":["h263"],"video/h264":["h264"],"video/iso.segment":["m4s"],"video/jpeg":["jpgv"],"video/jpm":["jpm","jpgm"],"video/mj2":["mj2","mjp2"],"video/mp2t":["ts"],"video/mp4":["mp4","mp4v","mpg4"],"video/mpeg":["mpeg","mpg","mpe","m1v","m2v"],"video/ogg":["ogv"],"video/quicktime":["qt","mov"],"video/webm":["webm"]},Ac=new Map;for(let[e,t]of Object.entries(Rc)){e=e.toLowerCase(),t=t.map((e=>e.toLowerCase()));for(const n of t)Ac.set(n,e)}var Bc=Object.freeze({__proto__:null,ErrorWithCode:oc,FormData:class{constructor(){this._shouldUseCache=!1,this._cachedBuffer=null,this._lineBreak="\r\n",this._boundary="------FormDataBaseBoundary"+Math.random().toString(36).substring(2),this.dataList=[]}_addData(e){if(this._shouldUseCache=!1,0===this.dataList.length)return void this.dataList.push(e);const t=this.dataList[this.dataList.length-1];switch(`${Buffer.isBuffer(t)?"buffer":"other"}_${Buffer.isBuffer(e)?"buffer":"other"}`){case"buffer_buffer":this.dataList.push(this._lineBreak),this.dataList.push(e);break;case"buffer_other":this.dataList.push(this._lineBreak+e);break;case"other_buffer":this.dataList[this.dataList.length-1]=t+"\r\n",this.dataList.push(e);break;case"other_other":this.dataList[this.dataList.length-1]=t+"\r\n"+e}}append(e,t,n){this._addData("--"+this._boundary);let i=`Content-Disposition: form-data; name="${encodeURIComponent(e)}"`;if(Buffer.isBuffer(t)){if(!n.filename||!n.contentType)throw new Error("filename and contentType required");i+=`; filename="${encodeURIComponent(n.filename)}"`,this._addData(i),this._addData(`Content-Type: ${n.contentType}`),this._addData(""),this._addData(t)}else this._addData(i),this._addData(""),this._addData(t)}getHeaders(e){const t={"Content-Type":"multipart/form-data; boundary="+this._boundary};return Object.assign(t,e)}getBuffer(){if(this._shouldUseCache)return this._cachedBuffer;this._shouldUseCache=!0;let e=Buffer.alloc(0);return this.dataList.forEach((t=>{e=Buffer.isBuffer(t)?Buffer.concat([e,t]):Buffer.concat([e,Buffer.from(""+t)])})),e=Buffer.concat([e,Buffer.from(`${this._lineBreak}--${this._boundary}--`)]),this._cachedBuffer=e,e}},JsonRpcClient:tc,JsonRpcServer:nc,getActionPath:function(e,t,n){const i=function(e,t,n){return Sc(e,t,`cloudfunctions/uni-clientDB-actions/${n}.js`)}(e,t,n);if(0===i.length)throw new oc(`未找到uni-clientDB-actions[${n}]`,"NOT_FOUND");if(i.length>1)throw console.error(`uni-clientDB-actions[${n}]存在名称冲突，请解决冲突后再试。产生冲突的路径如下：`),i.forEach((e=>{console.error(e)})),new oc(`uni-clientDB-actions[${n}]名称冲突，请解决后再试`,"CONFLICT_NAME");return i[0]},getAllFile:function e(t,n){if(!O.default.existsSync(t))return;const i=[],o=O.default.readdirSync(t);for(const r of o){if(n&&n.test(r))continue;const o=E.default.join(t,r),s=O.default.statSync(o);s.isFile()&&i.push(o),s.isDirectory()&&i.push(...e(o,n))}return i},getAllModuleCommonModuleList:function(e,t){const n=kc(e,t),i=[];for(let e=0;e<n.length;e++){const t=Fc(n[e]);i.push(...t)}return i},getAllModuleFunctionPath:Oc,getAppid:wc,getCloudPathType:function(e){return/uniCloud(-aliyun|-tcb|-alipay|)\/cloudfunctions\/common\//.test(e)?"module":/uniCloud(-aliyun|-tcb|-alipay|)\/cloudfunctions\/uni-clientDB-actions\//.test(e)?"action":/uniCloud(-aliyun|-tcb|-alipay|)\/cloudfunctions\//.test(e)?"function":""},getCloudfunctionPathList:kc,getCloudfunctionsPathFromFilePath:function(e){const t=e.replace(/\\/g,"/").match(/(?:.*)\/uniCloud(?:-aliyun|tcb|alipay){0,1}\/cloudfunctions/);return t&&t[0]},getCollectionListFromAllDbInit:Lc,getCommonModuleList:Fc,getCommonModulePath:jc,getCommonModulePathList:_c,getEncryptedFunctionList:Pc,getFunctionNameFromFunctionPath:Tc,getFunctionParam:$c,getFunctionPath:Cc,getFunctionPathList:Ec,getFunctionType:Ic,getGlobalJsonRpcClient:function(){return global.__jsonRpcClient||(global.__jsonRpcClient=new tc({bridgeProcess:process})),global.__jsonRpcClient},getMimeType:function(e){if("string"!=typeof e)return null;const t=e.replace(/^.*[/\\]/,"").toLowerCase(),n=t.replace(/^.*\./,"").toLowerCase(),i=t.length<e.length;return n.length<t.length-1||!i?Ac.get(n)??"application/octet-stream":null},getModuleList:xc,getPossiblePath:Sc,getProjectManifestContent:function(e){const t=dc(e),n=E.default.resolve(e,t?"src":"","manifest.json");let i={};try{i=lc(n)}catch(e){}return i},getRealFunctionPath:function(e,t,n){const i=E.default.resolve(ic,"internal-functions");return O.default.readdirSync(i).filter((e=>sc(E.default.resolve(i,e))&&"common"!==e)).indexOf(n)>-1?E.default.resolve(i,n):Cc(e,t,n)},getRealWorkspace:function({uniCloudInfo:e,provider:t}){return e.find((e=>e.provider===t)).workspaceFolder},getSchemaPath:function(e,t,n){const i=function(e,t,n){return Sc(e,t,`database/${n}.schema.json`)}(e,t,n);if(0===i.length)throw new oc(`项目database目录下缺少${n}.schema.json。如云端的该表已配置schema，请下载到database目录中`,"NOT_FOUND");if(i.length>1)throw console.error(`${n}表对应的schema存在名称冲突，请解决冲突后再试。产生冲突的路径如下：`),i.forEach((e=>{console.error(e)})),new oc(`${n}表对应的schema名称冲突，请解决后再试`,"CONFLICT_NAME");return i[0]},getType:rc,getUniCloudClient:function(e){const t=require(E.default.resolve(__dirname,"./ulib"));return e?t.init(e):t.init(function(){const e=JSON.parse(process.env.UNICLOUD_SPACE_LIST).find((e=>e.provider===process.env.UNICLOUD_SPACE_PROVIDER)),t=JSON.parse(JSON.stringify(e));return"tcb"===t.provider?t.provider="tencent":"aliyun"===t.provider&&(t.endpoint=t.endpoint||(t.spaceId.startsWith("mp-")?"https://api.next.bspapp.com":"https://api.bspapp.com")),t}())},getUniIdPath:function(e,t){return jc(e,t,"uni-id")},getUniModuleId:Nc,getValidateFunctionPath:function(e,t,n){const i=function(e,t,n){return Sc(e,t,`database/validateFunction/${n}.js`)}(e,t,n);if(0===i.length)throw new oc(`未找到扩展校验函数[${n}]`,"NOT_FOUND");if(i.length>1)throw console.error(`扩展校验函数[${n}]存在名称冲突，请解决冲突后再试。产生冲突的路径如下：`),i.forEach((e=>{console.error(e)})),new oc(`扩展校验函数[${n}]名称冲突，请解决后再试`,"CONFLICT_NAME");return i[0]},getWorkspacePathFromFilePath:vc,isDirectory:sc,isFileEncrypted:function(e){let t;try{t=O.default.statSync(e)}catch(e){return!1}const n=O.default.openSync(e),i=Buffer.alloc(Math.min(t.size,512));return O.default.readSync(n,i),O.default.closeSync(n),Array.from(i).some((e=>0===e))},isModuleEncrypted:pc,isPlainObject:function(e){if("object"!=typeof e||null===e||"[object Object]"!==Object.prototype.toString.call(e))return!1;const t=Object.getPrototypeOf(e);return null===t||null===Object.getPrototypeOf(t)},isUniAppCli:dc,parseJson:ac,parseJsonByPath:lc,readText:cc,safeEval:uc,traverseJs:yc,uniCloudDebuggerPath:ic}),Mc=qe(Bc);const Uc=O.default,qc=E.default,{isUniAppCli:Wc}=Mc;function Jc(e){const t=e.match(/(?:\/|\\)uni_modules(?:\/|\\)(.*?)(?:\/|\\)/);return t?t[1]:""}function Hc(e,t){const n=[];for(const i of e){if(!Uc.existsSync(i))continue;const e=Uc.readdirSync(i),o=Jc(i);for(const r of e){const e=qc.join(i,r);Uc.statSync(e).isFile()&&t.test(e)&&n.push({uniModule:o,collectionName:r.replace(t,""),filePath:e})}}return n}var Vc=function(e,t=""){const n=function(e,t=""){Wc(t)&&(t=qc.join(t,"src"));const n=qc.join(t,"uni_modules"),i=[e];if(Uc.existsSync(n)&&Uc.statSync(n).isDirectory()){const e=Uc.readdirSync(n);for(const o of e){const e=qc.join(t,"uni_modules",o,"uniCloud","database");Uc.statSync(n).isDirectory()&&i.push(e)}}return i}(e,t),i=function(e=[]){const t=[];for(const n of e){const e=qc.join(n,"validateFunction"),i=Jc(n);Uc.existsSync(e)&&Uc.statSync(n).isDirectory()&&t.push({uniModule:i,dirPath:e})}return t}(n),o=Hc(n,/\.schema\.json$/),r=Hc(n,/\.index\.json$/),s=Hc(n,/\.init_data\.json$/),a=Hc(n,/\.schema\.ext\.js$/),c=[];for(const{collectionName:e,filePath:t,uniModule:n}of o){const i=c.find((t=>t.collectionName===e));i?i.schemaFilePath=t:c.push({uniModule:n,collectionName:e,schemaFilePath:t})}for(const{collectionName:e,filePath:t,uniModule:n}of r){const i=c.find((t=>t.collectionName===e));i?i.indexFilePath=t:c.push({uniModule:n,collectionName:e,indexFilePath:t})}for(const{collectionName:e,filePath:t,uniModule:n}of s){const i=c.find((t=>t.collectionName===e));i?i.dataFilePath=t:c.push({uniModule:n,collectionName:e,dataFilePath:t})}for(const{collectionName:e,filePath:t,uniModule:n}of a){const i=c.find((t=>t.collectionName===e));i?i.schemaExtJSFilePath=t:c.push({uniModule:n,collectionName:e,schemaExtJSFilePath:t})}return{validateFunctions:i,collections:c.sort(((e,t)=>e.collectionName.localeCompare(t.collectionName)))}};const zc=C.default,Gc=O.default,Kc=E.default,Zc=Ka,Yc=jn,{getWorkspaceBindServiceSpace:Xc}=Ct,Qc=ca;let el=[];async function tl(e,t){const n=new Yc,i=await async function(e){const t={name:"",uniModuleId:""},n=e.fsPath.match(/(?<=(\/|\\)uni_modules(\/|\\))[^/\\]*/g);if(n&&n.length>0){const i=new RegExp(`.*uni_modules(/|\\\\)(?=${n[0]})`),o=e.fsPath.match(i),r=Kc.join(o[0],n[0]+"/package.json");if(Gc.existsSync(r)){const e=Zc.parse(Gc.readFileSync(r).toString());e.id&&"[object String]"===Object.prototype.toString.call(e.id)&&(t.uniModuleId=e.id)}else t.uniModuleId=n[0]}const i=Kc.basename(e.fsPath).split(".schema.ext.js")[0];return t.name=i||"",t}(e);return el.push(i),n.addLocalFile(e.fsPath),n.writeZipPromise(t)}var nl=async function(e,t){const{workspaceFolder:n}=e;let{provider:i,allSpaces:o}=await Xc({workspaceFolder:n});const r=await(async(e,t)=>{const{properties:n}=e;if(e.spec){const{fsPath:t}=e.spec,n=Qc.initWizard(t,e);if("boolean"==typeof n)return"取消";e=n}if(console.error("properties.provider ----------------- "+JSON.stringify(n)),n&&n.provider&&0===t.length)return"不存在云服务空间";const i=/(?<=(\/|\\)uni_modules(\/|\\))[^/\\]*/g,o=e.dbFolder?e.dbFolder.fsPath.match(i):e.fsPath.match(i);if(!o){const t=e.dbFolder?e.dbFolder.fsPath:e.fsPath;return t.indexOf("uniCloud-aliyun")>=0?"阿里云":t.indexOf("uniCloud-tcb")>=0?"腾讯云":"支付宝云"}if(t.length>1){const t=new RegExp(`.*uni_modules(/|\\\\)(?=${o[0]})`),n=e.dbFolder?e.dbFolder.fsPath.match(t):e.fsPath.match(t),i=Kc.join(n[0],o[0]+"/package.json");if(!Gc.existsSync(i)){const t=await zc.window.showMessageBox({type:"warning",title:"",text:`项目 ${e.fsPath?Kc.parse(e.fsPath).base:e.uniModuleId} 同时绑定了多个云服务商，请为当前操作指定使用哪个`,buttons:["腾讯云","阿里云","支付宝云","取消"]});return"取消"!==t&&t}{const t=Zc.parse(Gc.readFileSync(i).toString());if("n"!==t.uni_modules.platforms.cloud.aliyun||"n"!==t.uni_modules.platforms.cloud.tcb||"n"!==t.uni_modules.platforms.cloud.alipay){const t=await zc.window.showMessageBox({type:"warning",title:"",text:`项目 ${e.fsPath?Kc.parse(e.fsPath).base:e.uniModuleId} 同时绑定了多个云服务商，请为当前操作指定使用哪个`,buttons:["腾讯云","阿里云","支付宝云","取消"]});return"取消"!==t&&t}}}return n&&n.provider&&1===t.length?"aliyun"===n.provider?"阿里云":"tcb"===n.provider?"腾讯云":"支付宝云":"单个云服务空间"})(e,o);if(!r||"取消"===r)return!1;let s=await Qc.checkServiceSpace(e,"开始运行上传DB Schema扩展JS","",r);if(!s)return!1;await t(s);const a=Kc.join(__dirname,"/schema-ext.zip"),c=await tl(e,a);"阿里云"===r?i="aliyun":"腾讯云"===r?i="tcb":"支付宝云"===r&&(i="alipay");let l="";if(o.length&&o.forEach((e=>{e.provider===i&&(l=e.spaceId)})),!l||0===l.length){const n=await Qc.checkServiceSpace(e,"请先关联云服务空间","error",r);return await t(n,"error"),!1}if(c)try{const o=await zc.http.request({url:"https://ide.liuyingyong.cn/serverless/clientdb/upload-schema-ext",method:"post",connectionTimeout:1e4,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:i,spaceId:l,appid:n.appid,run:1,config:el}},params:{attachment:zc.Uri.file(a)}});if(1001!==o.service.code||!Gc.existsSync(a)){const e="aliyun"===i?"阿里云":"tcb"===i?"腾讯云":"支付宝云",{spaceName:r}=await Xc({workspaceFolder:n});return await t(`[${e}:${r}]${o.service.description}`,"error"),el=[],!1}s=await Qc.checkServiceSpace(e,"上传DB Schema扩展JS","success"),await t(s,"success"),Gc.unlinkSync(a),el=[]}catch(e){console.log(e),el=[];const n=Qc.errorArray(e);return await t(n,"error"),!1}},il={};const{AsyncLocalStorage:ol}=I.default,rl=Symbol("CONTEXT_STORAGE");function sl(){return Ue[rl]||(Ue[rl]=new ol),Ue[rl]}function al(){const e=sl().getStore();if(!e)throw new Error("context is not exist");return e}il.createContext=sl,il.getContext=al,il.getOutputViewWithContext=function(){return al()?.outputView};const cl=C.default,ll=O.default,ul=E.default,dl=ca,pl=Vc,fl=nl,{createContext:hl,getOutputViewWithContext:ml,getContext:gl}=il,{getCommonContext:yl}=ca;let vl={button:"",checked:!1},wl={button:"",checked:!1};async function xl(e,t,n={},i=!1){const o=gl(),r=ml();r.show();const{provider:s,spaceId:a}=o.currentSpace,c=dl.getUniModuleId(e),l=ul.basename(e),u=l.replace(".schema.json",""),d={fsPath:e,workspaceFolder:t,properties:n};await r.appendLine({level:"info",line:await dl.checkServiceSpace(d,`${c?`(${c})`:""}开始运行上传数据集合Schema(${l})`,"error")});const p=await async function(e,t,n,i){const o=await cl.http.request({url:"https://ide.liuyingyong.cn/serverless/database/collections",method:"post",connectionTimeout:1e4,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:t,spaceId:n,appid:i}}}),r=o.service&&o.service.code,s=o.service&&o.service.body.collections&&o.service.body.collections.map((e=>e.name));return 1001===r&&s.includes(e)}(u,s,a,t.appid);if(!p){if(!wl.checked){wl=await cl.window.showMessageBox2({type:"question",title:"",text:`集合/表 ${u} 不存在，是否自动在本服务空间的数据库中创建该表并重试上传操作?`,buttons:["是(&Y)","取消"],checkBoxText:i?"全部创建":null}),null===wl&&(wl={button:"取消",checked:!1});const{button:e}=wl;if("取消"===e)return r.appendLine({level:"error",line:await dl.checkServiceSpace(d,`${c?`(${c})`:""}上传数据集合Schema(${l}) 结束`,"error")})}const e=await cl.http.request({url:"https://ide.liuyingyong.cn/serverless/database/create-collection",method:"post",connectionTimeout:1e4,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:s,spaceId:a,appid:t.appid,name:u,initSchema:0}}});e.service&&1001===e.service.code?await r.appendLine({level:"success",line:await dl.checkServiceSpace(d,`${c?`(${c})`:""}创建数据表(${u})成功`,"error")}):await r.appendLine({level:"error",line:await dl.checkServiceSpace(d,e.service.description,"error")})}const f=await async function(e,t,n,i){const o=await cl.http.request({url:"https://ide.liuyingyong.cn/serverless/clientdb/schema-exists",method:"post",connectionTimeout:1e4,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:t,spaceId:n,appid:i,name:[e]}}}),r=o.service&&o.service.code,s=o.service&&o.service.body.list&&o.service.body.list[0];return 1001===r&&s.exists}(u,s,a,t.appid);f&&!vl.checked&&(vl=await cl.window.showMessageBox2({type:"question",title:"",text:`云端当前位置下已存在数据集合Schema(${u})，是否替换?`,buttons:["替换(&R)","跳过(&K)","停止(&S)"],checkBoxText:i?"全部应用":null}),null===vl&&(vl={button:"停止(&S)",checked:!1}));const{button:h}=vl;if("停止(&S)"===h)throw vl.button="",vl.checked=!1,new Error("停止上传");if("跳过(&K)"===h&&f)return r.appendLine({level:"info",line:await dl.checkServiceSpace(d,`${c?`(${c})`:""}跳过上传数据集合Schema(${l})`,"error")});try{const n=await dl.zipSchema(e),i=await cl.http.request({url:"https://ide.liuyingyong.cn/serverless/clientdb/upload-schema-with-locale",method:"post",connectionTimeout:1e4,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:s,spaceId:a,appid:t.appid,name:u,uniModuleId:c}},params:{attachment:cl.Uri.file(n)}});i.service&&1001===i.service.code?(await r.appendLine({level:"success",line:await dl.checkServiceSpace(d,`${c?`(${c})`:""}上传数据集合Schema(${l})成功`,"error")}),ll.unlinkSync(n)):await r.appendLine({level:"error",line:await dl.checkServiceSpace(d,i.service.description,"error")})}catch(e){console.error(e),await r.appendLine({level:"error",line:await dl.checkServiceSpace(d,`${c?`(${c})`:""}上传数据集合Schema(${l})失败`,"error")})}}var bl={async uploadAllSchemaResource(e){const t=await yl(e);hl().run(t,(()=>{!async function(e){const{fsPath:t,workspaceFolder:n,uploadSchemaJS:i=!0}=e,o=gl(),r=dl.getUniModuleId(t),{collections:s}=pl(t,r?"":n.uri.fsPath),a=s.filter((e=>e.schemaFilePath)),c=ml();e.properties=Object.assign({},e.properties,{provider:e.properties?.provider||o.currentSpace.provider}),c.show(),await c.appendLine({level:"info",line:await dl.checkServiceSpace(e,"开始运行上传所有数据集合Schema和数据库扩展校验函数","error")});for(const o of a){try{await xl(o.schemaFilePath,n,e.properties,!0)}catch(t){if("停止上传"===t.message)return vl.button="",vl.checked=!1,wl.button="",wl.checked=!1,c.appendLine({level:"info",line:await dl.checkServiceSpace(e,"上传结束","error")});await c.appendLine({level:"error",line:await dl.checkServiceSpace(e,t.message,"error")})}!i||vl.button&&"替换(&R)"!==vl.button||!o.schemaExtJSFilePath||await fl({fsPath:o.schemaExtJSFilePath,workspaceFolder:n,properties:e.properties},(async(e,t)=>{await c.appendLine({level:t||"",line:e})}))}await c.appendLine({level:"info",line:await dl.checkServiceSpace(e,"上传完成","error")}),vl.button="",vl.checked=!1,wl.button="",wl.checked=!1}(e)}))},async uploadSchemaResource(e){const t=await yl(e);hl().run(t,(()=>{!async function(e){const t=gl();e.properties=Object.assign({},e.properties,{provider:e.properties?.provider||t.currentSpace.provider}),xl(e.fsPath,e.workspaceFolder,e.properties)}(e)}))}};const Sl=C.default,kl=O.default,El=E.default,_l=ca,Cl=ua;function Il(e={nameInputValue:"default"}){const{nameInputValue:t="default",pathInputValue:n,formItems:i,tips:o}=e,r=Sl.env.appData+"/templates/file/database",s=i?i.map((e=>({columns:[{label:e.name},{label:e.title}]}))):[];return{title:"新建DB Schema扩展JS",footer:'<a href="https://uniapp.dcloud.net.cn/uniCloud/jql-schema-ext.html">什么是DB Schema扩展JS</a>',customButtons:[{text:"取消(&C)"},{text:"确定(&N)",role:"accept"}],cornerWidget:{type:"label",text:'<a href="#">[自定义模板]</a>',onEvent:()=>{_l.makeDir(r);const e=r.startsWith("/")?"file://":"file:///";Sl.env.openExternal(e+r)}},formItems:[{type:"input",name:"nameInput",placeholder:"请输入文件名称",value:t,selection:{offset:0,length:t?t.length:7}},{type:"label",name:"tipLabel",text:o},{type:"fileSelectInput",name:"pathInput",value:n},{type:"list",name:"schemaExtList",title:"选择模板",searchable:!0,columnStretches:[1,1],items:s,value:0}]}}var jl=function(e){const{fsPath:t}=e,n=[],i=Sl.env.appRoot+"/plugins/templates/file/jql-trigger/default.schema.ext.js",o=Sl.env.appData+"/templates/file/database",r=Sl.env.appRoot+"/plugins/templates/file/database";kl.existsSync(i)&&n.push({name:"default",path:i,title:"默认模板",local:!0,existsFiles:{schemaExt:!0}}),Sl.window.showFormDialog({...Il({nameInputValue:"default",pathInputValue:t}),onOpened:function(e){this.showLoading({maskAt:"templateList",text:""}),_l.walkSync(r.toString(),(function(e,t){let i=El.basename(e);_l.isSchemaExtFile(e)&&(i=i.substring(0,i.indexOf(".")),n.push({name:i,path:e,title:"默认模板",local:!0,existsFiles:{schemaExt:!0}}))})),_l.walkSync(o,(function(e,t){let i=El.basename(e);_l.isSchemaExtFile(e)&&(i=i.substring(0,i.indexOf(".")),n.push({name:i,path:e,title:"自定义模板",local:!0,existsFiles:{schemaExt:!0}}))})),Sl.http.request({url:"https://ide.liuyingyong.cn/serverless/opendb/search",method:"post",serviceOptions:{serviceRequest:!0}}).then((async e=>{if(e&&e.service&&1001===e.service.code){const t=e.service.body.collections?e.service.body.collections.filter((e=>e.schemaExt)):[];for(const e of t)n.push({name:e.name,path:"",title:e.title,local:!1,detail:e.detail,existsFiles:{schema:e.hasSchema,index:e.hasIndex,initData:e.hasData,schemaExt:e.hasSchemaExt}})}else console.error(e)})).catch((e=>{console.error(e)})).finally((()=>{this.updateForm(Il({pathInputValue:t,formItems:n})),this.hideLoading()}))},onChanged:function(e,i){if("schemaExtList"!==e)return;const o=n[i];let r;if(o.existsFiles){const e={schema:"定义文件(schema.json)",index:"索引文件(index.json)",initData:"初始化数据文件(init_data.json)",schemaExt:"定义扩展js文件(schema.ext.js)"},t=Object.keys(o.existsFiles).filter((e=>o.existsFiles[e])).map((t=>e[t]));t.length&&(r=`  将会创建${t.join("、")}`)}this.updateForm(Il({nameInputValue:o.name,pathInputValue:t,formItems:n,tips:r}))},validate:function(e){const{nameInput:t,pathInput:n}=e,i=El.join(n,t+".schema.ext.js");return kl.existsSync(i)?(this.showError("选择的位置已存在同名的DB Schema扩展JS"),!1):!!_l.validateName(t)||(this.showError("表名仅能以字母开头，只允许使用大小写字母、数字、连字符（-）及下划线（_）"),!1)}}).then((async e=>{if(0===e.buttonIndex)return;const{pathInput:t,nameInput:i,schemaExtList:o=0}=e.result||{},r=n[o];if(!r)return;const s=El.join(t,i+".schema.ext.js");if(r.local)return kl.writeFileSync(s,kl.readFileSync(r.path)),Sl.workspace.openTextDocument(s),!1;const a=await Sl.http.request({url:"https://ide.liuyingyong.cn/serverless/opendb/meta-data",method:"post",serviceOptions:{serviceRequest:!0,body:{name:r.name}}});if(a&&a.service&&a.service.code&&1001===a.service.code&&a.data){const e=JSON.parse(a.data);if(e&&e.body&&(e.body.schema||e.body.collection&&e.body.collection.schema)){const n=El.join(t,`${i}.schema.json`);if(!kl.existsSync(n)){const t=JSON.stringify(e.body.schema||e.body.collection.schema,null,"\t");t&&kl.writeFileSync(n,t,{encoding:"utf-8"})}}if(e&&e.body&&(e.body.index||e.body.collection&&e.body.collection.index)){const n=El.join(t,`${i}.index.json`);if(!kl.existsSync(n)){const t=JSON.stringify(e.body.index||e.body.collection.index,null,"\t");kl.writeFileSync(n,t,{encoding:"utf-8"})}}if(e&&e.body&&(e.body.data||e.body.collection&&e.body.collection.data)){const n=El.join(t,`${i}.init_data.json`);if(!kl.existsSync(n)){const t=i!==r.name;let o=JSON.stringify(e.body.data||e.body.collection.data,null,"\t");if("url"===e.body.dataType&&t){const t=await Cl(e.body.data);o=JSON.stringify(t,null,"\t")}kl.writeFileSync(n,t?o:JSON.stringify([]),{encoding:"utf-8"})}}e&&e.body&&e.body.schemaExt&&(kl.writeFileSync(s,e.body.schemaExt,{encoding:"utf-8"}),Sl.workspace.openTextDocument(s))}}))};const Ol=C.default,Pl=O.default,Ll=E.default,Nl=Ka,{getWorkspaceBindServiceSpace:Fl}=Ct,Tl=ca;async function Dl(e,t,n){let i="";i=Pl.lstatSync(e.fsPath).isFile()?e.fsPath:Ll.join(e.fsPath,t[n].name+".schema.ext.js"),Pl.writeFileSync(i,t[n].content,"utf-8")}var $l=async function(e){const{workspaceFolder:t}=e,n=await Tl.checkServiceSpace(e,"开始运行下载DB Schema扩展JS"),i=await function(e,t){const n=Ol.window.createOutputView({id:`${e.id}-unicloud`,title:`[${e.name}] - unicloud控制台`});if(-1===t.indexOf("请先关联云服务空间"))return n.show(),n.appendLine({level:"",line:t}),n;n.show(),n.appendLine({level:"error",line:t})}(t,n),o=await async function(e){const t={name:"",uniModuleId:""},n=e.fsPath.match(/(?<=(\/|\\)uni_modules(\/|\\))[^/\\]*/g);if(n&&n.length>0){const i=new RegExp(`.*uni_modules(/|\\\\)(?=${n[0]})`),o=e.fsPath.match(i),r=Ll.join(o[0],n[0]+"/package.json");if(Pl.existsSync(r)){const e=Nl.parse(Pl.readFileSync(r).toString());e.id&&"[object String]"===Object.prototype.toString.call(e.id)&&(t.uniModuleId=e.id)}else t.uniModuleId=n[0]}const i=Ll.basename(e.fsPath).split(".schema.ext.js")[0];return t.name=i||"",t}(e);let{provider:r,spaceId:s,allSpaces:a}=await Fl({workspaceFolder:t});const c=await async function(e,t){const{properties:n}=e;if(e.spec){const{fsPath:t}=e.spec,n=Tl.initWizard(t,e);if("boolean"==typeof n)return"取消";e=n}if(n&&n.provider&&0===t.length)return"不存在云服务空间";const i=/(?<=(\/|\\)uni_modules(\/|\\))[^/\\]*/g,o=e.dbFolder?e.dbFolder.fsPath.match(i):e.fsPath.match(i);if(!o){const t=e.dbFolder?e.dbFolder.fsPath:e.fsPath;return t.indexOf("uniCloud-aliyun")>=0?"阿里云":t.indexOf("uniCloud-tcb")>=0?"腾讯云":"支付宝云"}if(t.length>1){const t=new RegExp(`.*uni_modules(/|\\\\)(?=${o[0]})`),n=e.dbFolder?e.dbFolder.fsPath.match(t):e.fsPath.match(t),i=Ll.join(n[0],o[0]+"/package.json");if(!Pl.existsSync(i)){const t=await Ol.window.showMessageBox({type:"warning",title:"",text:`项目 ${e.fsPath?Ll.parse(e.fsPath).base:e.uniModuleId} 同时绑定了多个云服务商，请为当前操作指定使用哪个`,buttons:["腾讯云","阿里云","支付宝云","取消"]});return"取消"!==t&&t}{const t=Nl.parse(Pl.readFileSync(i).toString());if("n"!==t.uni_modules.platforms.cloud.aliyun||"n"!==t.uni_modules.platforms.cloud.tcb||"n"!==t.uni_modules.platforms.cloud.alipay){const t=await Ol.window.showMessageBox({type:"warning",title:"",text:`项目 ${e.fsPath?Ll.parse(e.fsPath).base:e.uniModuleId} 同时绑定了多个云服务商，请为当前操作指定使用哪个`,buttons:["腾讯云","阿里云","支付宝云","取消"]});return"取消"!==t&&t}}}return n&&n.provider&&1===t.length?"aliyun"===n.provider?"阿里云":"tcb"===n.provider?"腾讯云":"支付宝云":"单个云服务空间"}(e,a);r="取消"===c?r:"阿里云"===c?"aliyun":"腾讯云"===c?"tcb":"alipay";try{const{service:n}=await Ol.http.request({url:"https://ide.liuyingyong.cn/serverless/clientdb/download-schema-ext",method:"post",connectionTimeout:1e3,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:r,spaceId:s,appid:t.appid,run:1,name:o.name?[o.name]:[],uniModuleId:o.uniModuleId?o.uniModuleId:e.uniModuleId?e.uniModuleId:""}}});if(1001===n.code)await async function(e,t,n){if(e&&e.length)for(let i=0;i<e.length;i++){await Dl(t,e,i);const o=await Tl.checkServiceSpace(t,"下载DB Schema扩展JS","success");n.appendLine({level:"success",line:o})}}(n.body.list,e,i);else{const e="aliyun"===r?"阿里云":"tcb"===r?"腾讯云":"支付宝云",{spaceName:o}=await Fl({workspaceFolder:t});i.appendLine({level:"error",line:`[${e}:${o}]${n.description}`})}}catch(e){const t=Tl.errorArray(e);i.appendLine({level:"error",line:t})}},Rl={exports:{}};Rl.exports=function e(t,n,i){function o(s,a){if(!n[s]){if(!t[s]){const e="function"==typeof require&&require;if(!a&&e)return e(s,!0);if(r)return r(s,!0);const t=new Error("Cannot find module '"+s+"'");throw t.code="MODULE_NOT_FOUND",t}const c=n[s]={exports:{}};t[s][0].call(c.exports,(function(e){return o(t[s][1][e]||e)}),c,c.exports,e,t,n,i)}return n[s].exports}for(var r="function"==typeof require&&require,s=0;s<i.length;s++)o(i[s]);return o}({1:[function(e,t,n){function i(e,t,n){let i;return e&&(i={b:e}),t&&((i=i||{}).a=t),n&&((i=i||{}).x=n),i}function o(e,t){if(null!==e&&"object"==typeof e){const n=u.getComment(e);let s,a,c,l;if(n&&u.removeComment(e),"[object Array]"===Object.prototype.toString.apply(e)){for(l={a:{}},s=0,a=e.length;s<a;s++)r(l.a,s,n.a[s],o(e[s]))&&(c=!0);!c&&n.e&&(l.e=i(n.e[0],n.e[1]),c=!0)}else{let t;l={s:{}};const u=Object.keys(e);for(n&&n.o?(t=[],n.o.concat(u).forEach((function(n){Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&t.push(n)}))):t=u,l.o=t,s=0,a=t.length;s<a;s++){const i=t[s];r(l.s,i,n.c[i],o(e[i]))&&(c=!0)}!c&&n.e&&(l.e=i(n.e[0],n.e[1]),c=!0)}return t&&n&&n.r&&(l.r=i(n.r[0],n.r[1])),c?l:void 0}}function r(e,t,n,o){const r=i(n?n[0]:void 0,n?n[1]:void 0,o);return r&&(e[t]=r),r}function s(e,t){const n=i(t.b,t.a);return n.path=e,n}function a(e,t,n){if(e){let i,o;if(e.a)for(i=0,o=e.a.length;i<o;i++){const o=n.slice().concat([i]),r=e.a[i];r&&(t.push(s(o,r)),a(r.x,t,o))}else e.o&&e.o.forEach((function(i){const o=n.slice().concat([i]),r=e.s[i];r&&(t.push(s(o,r)),a(r.x,t,o))}));e.e&&t.push(s(n,e.e))}}function c(e,t,n,i){if(e){if(null===t||"object"!=typeof t)return void a(e,n,i);let o;const r=u.createComment(t);if(0===i.length&&e.r&&(r.r=[e.r.b,e.r.a]),"[object Array]"===Object.prototype.toString.apply(t)){r.a=[];const l=e.a||{};for(const u in l)if(l.hasOwnProperty(u)){o=parseInt(u);const l=e.a[u];if(l){const e=i.slice().concat([o]);o<t.length?(r.a[o]=[l.b,l.a],c(l.x,t[o],n,e)):(n.push(s(e,l)),a(l.x,n,e))}}0===o&&e.e&&(r.e=[e.e.b,e.e.a])}else r.c={},r.o=[],(e.o||[]).forEach((function(o){const l=i.slice().concat([o]),u=e.s[o];Object.prototype.hasOwnProperty.call(t,o)?(r.o.push(o),u&&(r.c[o]=[u.b,u.a],c(u.x,t[o],n,l))):u&&(n.push(s(l,u)),a(u.x,n,l))})),e.e&&(r.e=[e.e.b,e.e.a])}}function l(e,t,n){const i=u.createComment(e,u.getComment(e));return i.r||(i.r=["",""]),(t||""===t)&&(i.r[n]=u.forceComment(t)),i.r[n]||""}var u=e("./hjson-common");t.exports={extract:function(e){return o(e,!0)},merge:function(e,t){const n=[];if(c(e,t,n,[]),n.length>0){let e=l(t,null,1);e+="\n# Orphaned comments:\n",n.forEach((function(t){e+=("# "+t.path.join("/")+": "+function(){let e="";return[].forEach.call(arguments,(function(t){t&&""!==t.trim()&&(e&&(e+="; "),e+=t.trim())})),e}(t.b,t.a,t.e)).replace("\n","\\n ")+"\n"})),l(t,e,1)}},header:function(e,t){return l(e,t,0)},footer:function(e,t){return l(e,t,1)}}},{"./hjson-common":2}],2:[function(e,t,n){const i=e("os");t.exports={EOL:i.EOL||"\n",tryParseNumber:function(e,t){function n(){return o=e.charAt(c),c++,o}let i,o,r="",s=0,a=!0;var c=0;for(n(),"-"===o&&(r="-",n());o>="0"&&o<="9";)a&&("0"==o?s++:a=!1),r+=o,n();if(a&&s--,"."===o)for(r+=".";n()&&o>="0"&&o<="9";)r+=o;if("e"===o||"E"===o)for(r+=o,n(),"-"!==o&&"+"!==o||(r+=o,n());o>="0"&&o<="9";)r+=o,n();for(;o&&o<=" ";)n();return t&&(","!==o&&"}"!==o&&"]"!==o&&"#"!==o&&("/"!==o||"/"!==e[c]&&"*"!==e[c])||(o=0)),i=+r,o||s||!isFinite(i)?void 0:i},createComment:function(e,t){return Object.defineProperty&&Object.defineProperty(e,"__COMMENTS__",{enumerable:!1,writable:!0}),e.__COMMENTS__=t||{}},removeComment:function(e){Object.defineProperty(e,"__COMMENTS__",{value:void 0})},getComment:function(e){return e.__COMMENTS__},forceComment:function(e){if(!e)return"";let t,n,i,o;const r=e.split("\n");for(i=0;i<r.length;i++)for(t=r[i],o=t.length,n=0;n<o;n++){const e=t[n];if("#"===e)break;if("/"===e&&("/"===t[n+1]||"*"===t[n+1])){"*"===t[n+1]&&(i=r.length);break}if(e>" "){r[i]="# "+t;break}}return r.join("\n")}}},{os:8}],3:[function(e,t,n){function i(e,t){if(e)for(let n=0;n<e.length;n++){const i=e[n](t);if(void 0!==i)return i}}function o(){}function r(e){return"{"===e||"}"===e||"["===e||"]"===e||","===e}function s(){return{name:"math",parse:function(e){switch(e){case"+inf":case"inf":case"+Inf":case"Inf":return 1/0;case"-inf":case"-Inf":return-1/0;case"nan":case"NaN":return NaN}},stringify:function(e){if("number"==typeof e)return 1/e==-1/0?"-0":e===1/0?"Inf":e===-1/0?"-Inf":isNaN(e)?"NaN":void 0}}}function a(e){const t=e&&e.out;return{name:"hex",parse:function(e){if(/^0x[0-9A-Fa-f]+$/.test(e))return parseInt(e,16)},stringify:function(e){if(t&&Number.isInteger(e))return"0x"+e.toString(16)}}}function c(){return{name:"date",parse:function(e){if(/^\d{4}-\d{2}-\d{2}$/.test(e)||/^\d{4}-\d{2}-\d{2}T\d{2}\:\d{2}\:\d{2}(?:.\d+)(?:Z|[+-]\d{2}:\d{2})$/.test(e)){const t=Date.parse(e);if(!isNaN(t))return new Date(t)}},stringify:function(e){if("[object Date]"===Object.prototype.toString.call(e)){const t=e.toISOString();return-1!==t.indexOf("T00:00:00.000Z",t.length-14)?t.substr(0,10):t}}}}s.description="support for Inf/inf, -Inf/-inf, Nan/naN and -0",a.description="parse hexadecimal numbers prefixed with 0x",c.description="support ISO dates",t.exports={loadDsf:function(e,t){function n(e){return"[object Function]"==={}.toString.call(e)}if("[object Array]"!==Object.prototype.toString.apply(e)){if(e)throw new Error("dsf option must contain an array!");return o}if(0===e.length)return o;const s=[];return e.forEach((function(e){if(!e.name||!n(e.parse)||!n(e.stringify))throw new Error("extension does not match the DSF interface");s.push((function(){try{if("parse"==t)return e.parse.apply(null,arguments);if("stringify"==t){const t=e.stringify.apply(null,arguments);if(void 0!==t&&("string"!=typeof t||0===t.length||'"'===t[0]||[].some.call(t,(function(e){return r(e)}))))throw new Error("value may not be empty, start with a quote or contain a punctuator character except colon: "+t);return t}throw new Error("Invalid type")}catch(t){throw new Error("DSF-"+e.name+" failed; "+t.message)}}))})),i.bind(null,s)},std:{math:s,hex:a,date:c}}},{}],4:[function(e,t,n){t.exports=function(t,n){function i(){w=0,x=" "}function o(e){return"{"===e||"}"===e||"["===e||"]"===e||","===e||":"===e}function r(e){let t,n=0,i=1;for(t=w-1;t>0&&"\n"!==v[t];t--,n++);for(;t>0;t--)"\n"===v[t]&&i++;throw new Error(e+" at line "+i+","+n+" >>>"+v.substr(w-n,20)+" ...")}function s(){return x=v.charAt(w),w++,x}function a(e){return v.charAt(w+e)}function c(e){for(let o="",a=x;s();){if(x===a)return s(),e&&"'"===a&&"'"===x&&0===o.length?(s(),l()):o;if("\\"===x)if(s(),"u"===x){for(var t=0,n=0;n<4;n++){var i;s();const e=x.charCodeAt(0);x>="0"&&x<="9"?i=e-48:x>="a"&&x<="f"?i=e-97+10:x>="A"&&x<="F"?i=e-65+10:r("Bad \\u char "+x),t=16*t+i}o+=String.fromCharCode(t)}else{if("string"!=typeof k[x])break;o+=k[x]}else"\n"===x||"\r"===x?r("Bad string containing newline"):o+=x}r("Bad string")}function l(){function e(){for(let e=i;x&&x<=" "&&"\n"!==x&&e-- >0;)s()}for(var t="",n=0,i=0;;){const e=a(-i-5);if(!e||"\n"===e)break;i++}for(;x&&x<=" "&&"\n"!==x;)s();for("\n"===x&&(s(),e());;){if(x){if("'"===x){if(n++,s(),3===n)return"\n"===t.slice(-1)&&(t=t.slice(0,-1)),t;continue}for(;n>0;)t+="'",n--}else r("Bad multiline string");"\n"===x?(t+="\n",s(),e()):("\r"!==x&&(t+=x),s())}}function u(){if('"'===x||"'"===x)return c(!1);for(let e="",t=w,n=-1;;){if(":"===x)return e?n>=0&&n!==e.length&&(w=t+n,r("Found whitespace in your key name (use quotes to include)")):r("Found ':' but no key name (for an empty key name use quotes)"),e;x<=" "?x?n<0&&(n=e.length):r("Found EOF while looking for a key name (check your syntax)"):o(x)?r("Found '"+x+"' where a key name was expected (check your syntax or use quotes if the key name includes {}[],: or whitespace)"):e+=x,s()}}function d(){for(;x;){for(;x&&x<=" ";)s();if("#"===x||"/"===x&&"/"===a(0))for(;x&&"\n"!==x;)s();else{if("/"!==x||"*"!==a(0))break;for(s(),s();x&&("*"!==x||"/"!==a(0));)s();x&&(s(),s())}}}function p(e,t){let n;for(e--,n=w-2;n>e&&v[n]<=" "&&"\n"!==v[n];n--);"\n"===v[n]&&n--,"\r"===v[n]&&n--;const i=v.substr(e,n-e+1);for(n=0;n<i.length;n++)if(i[n]>" "){const e=i.indexOf("\n");if(e>=0){const n=[i.substr(0,e),i.substr(e+1)];return t&&0===n[0].trim().length&&n.shift(),n}return[i]}return[]}function f(e){function t(e,n){let i,o,r,s;switch(typeof e){case"string":e.indexOf(n)>=0&&(s=e);break;case"object":if("[object Array]"===Object.prototype.toString.apply(e))for(i=0,r=e.length;i<r;i++)s=t(e[i],n)||s;else for(o in e)Object.prototype.hasOwnProperty.call(e,o)&&(s=t(e[o],n)||s)}return s}function n(n){const i=t(e,n);return i?"found '"+n+"' in a string value, your mistake could be with:\n  > "+i+"\n  (unquoted strings contain everything up to the next line!)":""}return n("}")||n("]")}function h(){let e,t,n;const i=[];try{if(b&&(e=E.createComment(i,{a:[]})),s(),t=w,d(),e&&(n=p(t,!0).join("\n")),"]"===x)return s(),e&&(e.e=[n]),i;for(;x;){if(i.push(g()),t=w,d(),","===x&&(s(),t=w,d()),e){const i=p(t);e.a.push([n||"",i[0]||""]),n=i[1]}if("]"===x)return s(),e&&(e.a[e.a.length-1][1]+=n||""),i;d()}r("End of input while parsing an array (missing ']')")}catch(e){throw e.hint=e.hint||f(i),e}}function m(e){let t,n,i,o="";const a={};try{if(b&&(t=E.createComment(a,{c:{},o:[]})),e?n=1:(s(),n=w),d(),t&&(i=p(n,!0).join("\n")),"}"===x&&!e)return t&&(t.e=[i]),s(),a;for(;x;){if(o=u(),d(),":"!==x&&r("Expected ':' instead of '"+x+"'"),s(),a[o]=g(),n=w,d(),","===x&&(s(),n=w,d()),t){const e=p(n);t.c[o]=[i||"",e[0]||""],i=e[1],t.o.push(o)}if("}"===x&&!e)return s(),t&&(t.c[o][1]+=i||""),a;d()}if(e)return a;r("End of input while parsing an object (missing '}')")}catch(e){throw e.hint=e.hint||f(a),e}}function g(){switch(d(),x){case"{":return m();case"[":return h();case"'":case'"':return c(!0);default:return function(){let e=x;for(o(x)&&r("Found a punctuator character '"+x+"' when expecting a quoteless string (check your syntax)");;){s();const t="\r"===x||"\n"===x||""===x;if(t||","===x||"}"===x||"]"===x||"#"===x||"/"===x&&("/"===a(0)||"*"===a(0))){const n=e[0];switch(n){case"f":if("false"===e.trim())return!1;break;case"n":if("null"===e.trim())return null;break;case"t":if("true"===e.trim())return!0;break;default:if("-"===n||n>="0"&&n<="9"){const t=E.tryParseNumber(e);if(void 0!==t)return t}}if(t){e=e.trim();const t=S(e);return void 0!==t?t:e}}e+=x}}()}}function y(e,t){const n=w;if(d(),x&&r("Syntax error, found trailing characters"),b){const i=t.join("\n"),o=p(n).join("\n");(o||i)&&(E.createComment(e,E.getComment(e)).r=[i,o])}return e}let v,w,x,b,S;var E=e("./hjson-common");const C=e("./hjson-dsf");var k={'"':'"',"'":"'","\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"};if("string"!=typeof t)throw new Error("source is not a string");let _=null,I=!0;return n&&"object"==typeof n&&(b=n.keepWsc,_=n.dsf,I=!1!==n.legacyRoot),S=C.loadDsf(_,"parse"),v=t,i(),I?function(){d();const e=b?p(1):null;switch(x){case"{":return y(m(),e);case"[":return y(h(),e)}try{return y(m(!0),e)}catch(t){i();try{return y(g(),e)}catch(e){throw t}}}():function(){d();const e=b?p(1):null;switch(x){case"{":return y(m(),e);case"[":return y(h(),e);default:return y(g(),e)}}()}},{"./hjson-common":2,"./hjson-dsf":3}],5:[function(e,t,n){t.exports=function(t,n){function i(e,t){return P+=e[0].length+e[1].length-e[2]-e[3],e[0]+t+e[1]}function o(e){return e.replace(C,(function(e){const t=j[e];return"string"==typeof t?i(b.esc,t):i(b.uni,("0000"+e.charCodeAt(0).toString(16)).slice(-4))}))}function r(e,t,n,r){return e?(k.lastIndex=0,I.lastIndex=0,m||n||k.test(e)||void 0!==a.tryParseNumber(e,!0)||I.test(e)?(C.lastIndex=0,_.lastIndex=0,C.test(e)?_.test(e)||r||!y?i(b.qstr,o(e)):function(e,t){let n;const o=e.replace(/\r/g,"").split("\n");if(t+=d,1===o.length)return i(b.mstr,o[0]);let r=u+t+b.mstr[0];for(n=0;n<o.length;n++)r+=u,o[n]&&(r+=t+o[n]);return r+u+t+b.mstr[1]}(e,t):i(b.qstr,e)):i(b.str,e)):i(b.qstr,"")}function s(e){return e?h||O.test(e)?(C.lastIndex=0,i(b.qkey,C.test(e)?o(e):e)):i(b.key,e):'""'}var a=e("./hjson-common");const c=e("./hjson-dsf"),l={obj:["{","}"],arr:["[","]"],key:["",""],qkey:['"','"'],col:[":",""],com:[",",""],str:["",""],qstr:['"','"'],mstr:["'''","'''"],num:["",""],lit:["",""],dsf:["",""],esc:["\\",""],uni:["\\u",""],rem:["",""]};var u=a.EOL,d="  ",p=!1,f=!1,h=!1,m=!1,g=0,y=1,v="";let w=null;var x=!1,b=l;if(n&&"object"==typeof n){let e;n.quotes="always"===n.quotes?"strings":n.quotes,"\n"!==n.eol&&"\r\n"!==n.eol||(u=n.eol),p=n.keepWsc,g=n.condense||0,f=n.bracesSameLine,h="all"===n.quotes||"keys"===n.quotes,m="all"===n.quotes||"strings"===n.quotes||!0===n.separator,y=m||"off"==n.multiline?0:"no-tabs"==n.multiline?2:1,v=!0===n.separator?b.com[0]:"",w=n.dsf,x=n.sortProps,"number"==typeof n.space?d=new Array(n.space+1).join(" "):"string"==typeof n.space&&(d=n.space),!0===n.colors&&(b={obj:["[37m{[0m","[37m}[0m"],arr:["[37m[[0m","[37m][0m"],key:["[33m","[0m"],qkey:['[33m"','"[0m'],col:["[37m:[0m",""],com:["[37m,[0m",""],str:["[37;1m","[0m"],qstr:['[37;1m"','"[0m'],mstr:["[37;1m'''","'''[0m"],num:["[36;1m","[0m"],lit:["[36m","[0m"],dsf:["[37m","[0m"],esc:["[31m\\","[0m"],uni:["[31m\\u","[0m"],rem:["[35m","[0m"]});const t=Object.keys(l);for(e=t.length-1;e>=0;e--){const n=t[e];b[n].push(l[n][0].length,l[n][1].length)}}let S;const E="-­؀-؄܏឴឵‌-‏\u2028- ⁠-⁯\ufeff￰-￿";var C=new RegExp('[\\\\\\"\0-'+E+"]","g"),k=new RegExp("^\\s|^\"|^'|^#|^\\/\\*|^\\/\\/|^\\{|^\\}|^\\[|^\\]|^:|^,|\\s$|[\0-"+E+"]","g"),_=new RegExp("'''|^[\\s]+$|[\0-"+(2===y?"\t":"\b")+"\v\f-"+E+"]","g"),I=new RegExp("^(true|false|null)\\s*((,|\\]|\\}|#|//|/\\*).*)?$"),j={"\b":"b","\t":"t","\n":"n","\f":"f","\r":"r",'"':'"',"\\":"\\"},O=/[,\{\[\}\]\s:#"']|\/\/|\/\*/,L="",P=0;S=c.loadDsf(w,"stringify");let N="";var F=p?F=(a.getComment(t)||{}).r:null;return F&&F[0]&&(N=F[0]+"\n"),N+=function e(t,n,o,c){function l(e){return e&&"\n"===e["\r"===e[0]?1:0]}function h(e){return e&&!l(e)}function w(e,t,n){if(!e)return"";let o;const r=(e=a.forceComment(e)).length;for(o=0;o<r&&e[o]<=" ";o++);return n&&o>0&&(e=e.substr(o)),o<r?t+i(b.rem,e):e}const E=S(t);if(void 0!==E)return i(b.dsf,E);switch(typeof t){case"string":return r(t,L,n,c);case"number":return isFinite(t)?i(b.num,String(t)):i(b.lit,"null");case"boolean":return i(b.lit,String(t));case"object":if(!t)return i(b.lit,"null");var C;p&&(C=a.getComment(t));var k,_,I,j,O,N,F,T,D,$,R="[object Array]"===Object.prototype.toString.apply(t),A=L,B=u+A,M=u+(L+=d),U=o||f?"":B,q=[],W=g?[]:null,J=m,V=y,H=v?"":b.com[0],z=0;if(R){for(_=0,I=t.length;_<I;_++){if(k=_<I-1,C?(T=h((F=C.a[_]||[])[1]),q.push(w(F[0],"\n")+M),W&&(F[0]||F[1]||T)&&(W=null)):q.push(M),P=0,O=t[_],q.push(e(O,!!C&&T,!0)+(k?v:"")),W){switch(typeof O){case"string":P=0,m=!0,y=0,W.push(e(O,!1,!0)+(k?b.com[0]:"")),m=J,y=V;break;case"object":if(O){W=null;break}default:W.push(q[q.length-1]+(k?H:""))}k&&(P+=b.com[0].length-b.com[2]),z+=P}C&&F[1]&&q.push(w(F[1],T?" ":"\n",T))}0===I?C&&C.e&&q.push(w(C.e[0],"\n")+B):q.push(B),0===q.length?D=i(b.arr,""):(D=U+i(b.arr,q.join("")),W&&($=W.join(" ")).length-z<=g&&(D=i(b.arr,$)))}else{const n=C?C.o.slice():[],o=[];for(j in t)Object.prototype.hasOwnProperty.call(t,j)&&n.indexOf(j)<0&&o.push(j);x&&o.sort();const r=n.concat(o);for(_=0,I=r.length;_<I;_++)if(k=_<I-1,j=r[_],C?(T=h((F=C.c[j]||[])[1]),q.push(w(F[0],"\n")+M),W&&(F[0]||F[1]||T)&&(W=null)):q.push(M),P=0,N=e(O=t[j],C&&T),q.push(s(j)+b.col[0]+(l(N)?"":" ")+N+(k?v:"")),C&&F[1]&&q.push(w(F[1],T?" ":"\n",T)),W){switch(typeof O){case"string":P=0,m=!0,y=0,N=e(O,!1),m=J,y=V,W.push(s(j)+b.col[0]+" "+N+(k?b.com[0]:""));break;case"object":if(O){W=null;break}default:W.push(q[q.length-1]+(k?H:""))}P+=b.col[0].length-b.col[2],k&&(P+=b.com[0].length-b.com[2]),z+=P}0===I?C&&C.e&&q.push(w(C.e[0],"\n")+B):q.push(B),0===q.length?D=i(b.obj,""):(D=U+i(b.obj,q.join("")),W&&($=W.join(" ")).length-z<=g&&(D=i(b.obj,$)))}return L=A,D}}(t,null,!0,!0),F&&(N+=F[1]||""),N}},{"./hjson-common":2,"./hjson-dsf":3}],6:[function(e,t,n){t.exports="3.2.1"},{}],7:[function(e,t,n){const i=e("./hjson-common"),o=e("./hjson-version"),r=e("./hjson-parse"),s=e("./hjson-stringify"),a=e("./hjson-comments"),c=e("./hjson-dsf");t.exports={parse:r,stringify:s,endOfLine:function(){return i.EOL},setEndOfLine:function(e){"\n"!==e&&"\r\n"!==e||(i.EOL=e)},version:o,rt:{parse:function(e,t){return(t=t||{}).keepWsc=!0,r(e,t)},stringify:function(e,t){return(t=t||{}).keepWsc=!0,s(e,t)}},comments:a,dsf:c.std}},{"./hjson-comments":1,"./hjson-common":2,"./hjson-dsf":3,"./hjson-parse":4,"./hjson-stringify":5,"./hjson-version":6}],8:[function(e,t,n){},{}]},{},[7])(7);const Al=O.default,Bl=E.default,Ml=C.default,Ul=jn,{getWorkspaceBindServiceSpace:ql}=Ct,Wl=Rl.exports,Jl=ca,Hl=Vc,Vl=ua;async function zl(e){const{fsPath:t,workspaceFolder:n}=e;if(!n.appid)return Ml.window.showMessageBox({type:"warning",title:"",text:"缺少appid，请在manifest.json中设置appid",buttons:["确定"]});const{provider:i,spaceId:o,allSpaces:r}=await ql({workspaceFolder:n}),s=Ml.window.createOutputView({id:`${n.id}-unicloud`,title:`[${n.name}] - unicloud控制台`});if(r&&r.length<=0)return s.show(),s.appendLine({level:"error",line:await Jl.checkServiceSpace(e,"","error")});const{collections:a,validateFunctions:c}=Hl(t,n.uri.fsPath);if(a.length<=0)return s.show(),s.appendLine({level:"error",line:await Jl.checkServiceSpace(e,"没有要初始化的数据表","error")});const l=[],u=[],d=await Ml.http.request({url:"https://ide.liuyingyong.cn/serverless/database/collections",method:"post",connectionTimeout:1e4,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:i,spaceId:o,appid:n.appid}}});if(d.service&&1001===d.service.code&&d.service.body.collections){const e=d.service.body.collections.map((e=>e.name));for(const t of a)e.includes(t.collectionName)?l.push(t):u.push(t)}let p;l.length>0&&(p=await Ml.window.showFormDialog({width:420,height:500,cancelButtonText:"取消",submitButtonText:"覆盖选中的表",title:"初始化云数据库",subtitle:"当前云数据库已经存在以下同名的数据表，请选择要覆盖的表。\n覆盖表不会删除该表的已存在数据，需注意如果数据中没有_id，\n会插入新数据。",formItems:[{type:"vue:initDBDialog",name:"initDBDialog",value:{workspaceFolder:e.workspaceFolder,collections:l}}]})),console.log(p),s.show();const f=p?.initDBDialog?p.initDBDialog.collections.filter((e=>e.selected)):[],h=p?u.concat(f):u;if(h.length<=0)return s.appendLine({level:"warning",line:await Jl.checkServiceSpace(e,"没有任何表数据要上传","error")});if(u.length>0){await s.appendLine({line:await Jl.checkServiceSpace(e,"初始化云数据库...","error")});for(const t of u){await s.appendLine({line:await Jl.checkServiceSpace(e,`创建数据表(${t.collectionName})`,"error")});const r=await Ml.http.request({url:"https://ide.liuyingyong.cn/serverless/database/create-collection",method:"post",connectionTimeout:1e4,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:i,spaceId:o,appid:n.appid,name:t.collectionName,initSchema:0}}});r.service&&1001===r.service.code?await s.appendLine({level:"success",line:await Jl.checkServiceSpace(e,`创建数据表(${t.collectionName})成功`,"error")}):await s.appendLine({level:"error",line:await Jl.checkServiceSpace(e,r.service.description,"error")})}}for(const t of h)if(Al.existsSync(t.schemaFilePath)){await s.appendLine({line:await Jl.checkServiceSpace(e,`上传数据集合Schema(${t.collectionName}.schema.json)`,"error")});try{const r=await Jl.zipSchema(t.schemaFilePath),a=await Ml.http.request({url:"https://ide.liuyingyong.cn/serverless/clientdb/upload-schema-with-locale",method:"post",connectionTimeout:1e3,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:i,spaceId:o,appid:n.appid,name:t.collectionName,uniModuleId:Jl.getUniModuleId(t.schemaFilePath)}},params:{attachment:Ml.Uri.file(r)}});a.service&&1001===a.service.code?(await s.appendLine({level:"success",line:await Jl.checkServiceSpace(e,`上传数据集合Schema(${t.collectionName}.schema.json)成功`,"error")}),Al.unlinkSync(r)):await s.appendLine({level:"error",line:await Jl.checkServiceSpace(e,a.service.description,"error")})}catch(n){console.error(n),await s.appendLine({level:"error",line:await Jl.checkServiceSpace(e,`上传数据集合Schema(${t.collectionName}.schema.json)失败`,"error")})}}if(c.length>0){await s.appendLine({line:await Jl.checkServiceSpace(e,"上传所有数据库扩展校验函数","error")});let r=Promise.resolve({button:"",checked:!1});for(const a of c){const c=Al.readdirSync(a.dirPath),l=new Set,u=await Ml.http.request({url:"https://ide.liuyingyong.cn/serverless/clientdb/validator-exists",method:"post",connectionTimeout:1e3,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:i,spaceId:o,appid:n.appid,name:c.map((e=>e.replace(/\.js$/,"")))}}});if(u.service&&1001===u.service.code)for(const e of u.service.body.list)e.exists&&l.add(e.name);for(const u of c){const c=Bl.join(a.dirPath,u);if(!Al.statSync(c).isFile()||!u.endsWith(".js"))continue;const d=Bl.join(__dirname,"validator.js");Al.writeFileSync(d,Al.readFileSync(c),"utf-8");const p=l.has(u.replace(/\.js$/,""));p&&!r.checked&&(r=await Ml.window.showMessageBox2({type:"question",title:"",text:`云端当前位置下已存在数据库扩展函数(${u})，是否替换？`,buttons:["替换(&R)","跳过(&K)","停止(&S)"],checkBoxText:"全部应用"}));const{button:f}=r;if(f&&"替换(&R)"!==f){if("停止(&S)"===f){await s.appendLine({level:"error",line:await Jl.checkServiceSpace(e,`上传数据集合校验函数(${u})取消`,"error")});break}"跳过(&K)"===f&&p&&await s.appendLine({level:"warning",line:await Jl.checkServiceSpace(e,`上传数据集合校验函数(${u})跳过`,"error")})}else try{const t=await Ml.http.request({url:"https://ide.liuyingyong.cn/serverless/clientdb/edit-validator",method:"post",connectionTimeout:1e3,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:i,spaceId:o,appid:n.appid,name:u.replace(".js",""),uniModuleId:a.uniModule}},params:{attachment:Ml.Uri.file(d)}});t.service&&1001===t.service.code?await s.appendLine({level:"success",line:await Jl.checkServiceSpace(e,`上传数据集合校验函数(${u})成功`,"error")}):await s.appendLine({level:"error",line:await Jl.checkServiceSpace(e,t.service.description,"error")})}catch(t){await s.appendLine({level:"error",line:await Jl.checkServiceSpace(e,`上传数据集合校验函数(${u})失败`,"error")})}Al.unlinkSync(d)}}}for(const t of h){if(!t.indexFilePath)continue;if(!u.find((e=>e.collectionName===t.collectionName))){await s.appendLine({line:await Jl.checkServiceSpace(e,`索引(${t.collectionName}.index.json)已初始化`,"error")});continue}await s.appendLine({line:await Jl.checkServiceSpace(e,`上传初始索引(${t.collectionName}.index.json)`,"error")});const r=new Ul;r.addLocalFile(t.indexFilePath);const a=Bl.join(__dirname,"index.zip");await r.writeZipPromise(a);try{const r=await Ml.http.request({url:"https://ide.liuyingyong.cn/serverless/database/init-index",method:"post",connectionTimeout:1e3,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:i,spaceId:o,appid:n.appid,name:t.collectionName}},params:{attachment:Ml.Uri.file(a)}});r.service&&1001===r.service.code?await s.appendLine({level:"success",line:await Jl.checkServiceSpace(e,`上传初始索引(${t.collectionName}.index.json)成功`,"error")}):await s.appendLine({level:"error",line:await Jl.checkServiceSpace(e,r.service.description,"error")})}catch(n){console.error(n),await s.appendLine({level:"error",line:await Jl.checkServiceSpace(e,`上传初始索引(${t.collectionName}.index.json)失败`,"error")})}Al.unlinkSync(a)}for(const t of h){if(!t.dataFilePath)continue;const r=await Jl.checkServiceSpace(e,`上传初始数据(${t.collectionName}.init_data.json)`,"error");await s.appendLine({line:r});const a=new Ul,c=Al.readFileSync(t.dataFilePath,"utf8");let l=[];try{l=Wl.parse(c)}catch(e){}if(l&&Array.isArray(l)&&l.length<=0){const e=await Gl(t.collectionName);e&&e.data&&(l="url"===e.dataType?await Vl(e.data):e.data||e.collection.data||[])}a.addFile(`${t.collectionName}.init_data.json`,Buffer.from(JSON.stringify(l,null,2),"utf8"));const u=Bl.join(__dirname,"data.zip");await a.writeZipPromise(u);try{const r=await Ml.http.request({url:"https://ide.liuyingyong.cn/serverless/database/init-data",method:"post",connectionTimeout:1e3,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:i,spaceId:o,appid:n.appid,name:t.collectionName}},params:{attachment:Ml.Uri.file(u)}});r.service&&1001===r.service.code?(await s.appendLine({level:"success",line:await Jl.checkServiceSpace(e,`上传初始数据(${t.collectionName}.init_data.json)成功`,"error")}),Al.unlinkSync(u)):await s.appendLine({level:"error",line:await Jl.checkServiceSpace(e,r.service.description,"error")})}catch(n){console.error(n),await s.appendLine({level:"error",line:await Jl.checkServiceSpace(e,`上传初始数据(${t.collectionName}.init_data.json)失败`,"error")})}}for(const t of h){if(!t.schemaExtJSFilePath)continue;await s.appendLine({line:await Jl.checkServiceSpace(e,`上传Schema扩展(${t.collectionName}.schema.ext.js)`,"error")});const r=new Ul;r.addLocalFile(t.schemaExtJSFilePath);const a=Bl.join(__dirname,"schema-ext.zip");await r.writeZipPromise(a);try{const r=await Ml.http.request({url:"https://ide.liuyingyong.cn/serverless/clientdb/upload-schema-ext",method:"post",connectionTimeout:1e3,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:i,spaceId:o,appid:n.appid,config:[{name:t.collectionName,uniModuleId:t.uniModule}]}},params:{attachment:Ml.Uri.file(a)}});r.service&&1001===r.service.code?(await s.appendLine({level:"success",line:await Jl.checkServiceSpace(e,`上传Schema扩展(${t.collectionName}.schema.ext.js)成功`,"error")}),Al.unlinkSync(a)):await s.appendLine({level:"error",line:await Jl.checkServiceSpace(e,r.service.description,"error")})}catch(n){console.error(n),await s.appendLine({level:"error",line:await Jl.checkServiceSpace(e,`上传Schema扩展(${t.collectionName}.schema.ext.js)失败`,"error")})}}await s.appendLine({level:"success",line:await Jl.checkServiceSpace(e,"初始化云数据库完成","error")})}async function Gl(e){const t=await Ml.http.request({url:"https://ide.liuyingyong.cn/serverless/opendb/meta-data",method:"post",serviceOptions:{serviceRequest:!0,body:{name:e}}});if(t&&t.service&&t.service.code&&1001===t.service.code)return t.service.body}Ml.vue.defineComponent("initDBDialog",Bl.join(process.env.UNICLOUD_DEBUGGER_PATH,"manager/dialog-components/init-db-dialog.vue"));var Kl={initDB:zl,oldInitDBTransfer:async function(e){const{fsPath:t,workspaceFolder:n,showDeprecatedMessage:i=!0}=e,o=Ml.window.createOutputView({id:`${n.id}-unicloud`,title:`[${n.name}] - unicloud控制台`});if(i&&"取消"===(await Ml.window.showMessageBox2({type:"question",title:"db_init.json 已废弃",text:'初始化云数据库现已将schema、data、index拆分为独立文件进行初始化，并且初始化云数据库操作移至database目录<br />继续将会根据db_init.json文件拆分后初始化，详见<a href="https://uniapp.dcloud.net.cn/uniCloud/hellodb.html#db-init">文档说明</a>',buttons:["继续","取消"]})).button)return;const r=Al.readFileSync(t,"utf8"),s=Bl.dirname(t);let a;o.show(),await o.appendLine({level:"info",line:await Jl.checkServiceSpace(e,"正在解析db_init.json","error")});try{a=Wl.parse(r)}catch(t){return o.appendLine({level:"error",line:await Jl.checkServiceSpace(e,`解析db_init.json失败；失败原因：${t.message}`,"error")})}for(const t in a){let n=a[t];Array.isArray(n)&&(n={data:n}),0===Object.keys(n).length&&(n={data:[]});const{data:i,index:r,schema:c}=n;if(await o.appendLine({level:"info",line:await Jl.checkServiceSpace(e,`正在转换${t}集合`,"error")}),i){const e=Bl.resolve(s,`${t}.init_data.json`);Al.existsSync(e)||Al.writeFileSync(e,JSON.stringify(i,null,2))}if(r){const e=Bl.resolve(s,`${t}.index.json`);Al.existsSync(e)||Al.writeFileSync(e,JSON.stringify(r,null,2))}if(c){const e=Bl.resolve(s,`${t}.schema.json`);Al.existsSync(e)||Al.writeFileSync(e,JSON.stringify(c,null,2))}}await o.appendLine({level:"success",line:await Jl.checkServiceSpace(e,"db_init.json 转换完成","error")}),await zl({...e,fsPath:s})}};const Zl=O.default,Yl=F.default,Xl=E.default,Ql=C.default,eu=jn,{getWorkspaceBindServiceSpace:tu}=Ct,{updateDBSchema:nu}=ja,iu=ca,ou=Rl.exports,ru=ua;var su=async function(e){const{workspaceFolder:t}=e,n=Xl.basename(e.fsPath),i=n.replace(/.init_data.json$/,"");if(!t.appid)return Ql.window.showMessageBox({type:"warning",title:"",text:"缺少appid，请在manifest.json中设置appid",buttons:["确定"]});const o=Ql.window.createOutputView({id:`${t.id}-unicloud`,title:`[${t.name}] - unicloud控制台`});o.show(),o.appendLine({line:await iu.checkServiceSpace(e,`初始化数据(${n})`,"error")});const{provider:r,spaceId:s}=await tu({workspaceFolder:t}),a=await Ql.http.request({url:"https://ide.liuyingyong.cn/serverless/database/collections",method:"post",connectionTimeout:1e4,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:r,spaceId:s,appid:t.appid}}});if(a.service&&1001===a.service.code&&a.service.body.collections.length)if(a.service.body.collections.map((e=>e.name)).includes(i)){if("停止(&S)"===await Ql.window.showMessageBox({type:"warning",title:"是否继续执行初始化操作？",text:`数据表(${i})已创建，继续初始化可能导致数据冲突。`,buttons:["继续(&N)","停止(&S)"]}))return o.appendLine({line:await iu.checkServiceSpace(e,"初始化数据已停止","error")})}else{const n=Xl.join(Xl.dirname(e.fsPath),`${i}.schema.json`);if(!Zl.existsSync(n))return o.appendLine({level:"error",line:await iu.checkServiceSpace(e,`Schema(${i}.schema.json) 不存在`,"error")});const r=Xl.join(Yl.tmpdir(),".dbschame"),s=Date.now(),a=Xl.join(r,s.toString());Zl.existsSync(a)||Zl.mkdirSync(a,{recursive:!0});const c=[{local:n,server:a}];await nu({workspaceFolder:t,schema:!0,serverPath:a,updateSchemas:c})}const c=new eu,l=Zl.readFileSync(e.fsPath,"utf8");let u=[];try{u=ou.parse(l)}catch(e){}if(u&&Array.isArray(u)&&u.length<=0){const e=await async function(e){const t=await Ql.http.request({url:"https://ide.liuyingyong.cn/serverless/opendb/meta-data",method:"post",serviceOptions:{serviceRequest:!0,body:{name:e}}});if(t&&t.service&&t.service.code&&1001===t.service.code)return t.service.body}(i);e&&e.data&&(u="url"===e.dataType?await ru(e.data):e.data||e.collection.data||[])}const d=Xl.join(__dirname,"data.zip");c.addFile(`${i}.init_data.json`,Buffer.from(JSON.stringify(u,null,2),"utf8")),await c.writeZipPromise(d);const p=await Ql.http.request({url:"https://ide.liuyingyong.cn/serverless/database/init-data",method:"post",connectionTimeout:1e4,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:r,spaceId:s,appid:t.appid,name:i}},params:{attachment:Ql.Uri.file(d)}});p.service&&1001===p.service.code?o.appendLine({line:await iu.checkServiceSpace(e,`数据(${n})初始化完成`,"error"),level:"success"}):o.appendLine({line:await iu.checkServiceSpace(e,p.service.description,"error"),level:"error"}),Zl.unlinkSync(d)};const au=O.default,cu=F.default,lu=E.default,uu=C.default,du=jn,{getWorkspaceBindServiceSpace:pu}=Ct,{updateDBSchema:fu}=ja,hu=ca;var mu=async function(e){const{workspaceFolder:t}=e,n=lu.basename(e.fsPath),i=n.replace(/.index.json$/,"");if(!t.appid)return uu.window.showMessageBox({type:"warning",title:"",text:"缺少appid，请在manifest.json中设置appid",buttons:["确定"]});const o=uu.window.createOutputView({id:`${t.id}-unicloud`,title:`[${t.name}] - unicloud控制台`});o.show(),o.appendLine({line:await hu.checkServiceSpace(e,`初始化索引(${n})`,"error")});const{provider:r,spaceId:s}=await pu({workspaceFolder:t}),a=await uu.http.request({url:"https://ide.liuyingyong.cn/serverless/database/collections",method:"post",connectionTimeout:1e4,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:r,spaceId:s,appid:t.appid}}});if(a.service&&1001===a.service.code&&a.service.body.collections.length)if(a.service.body.collections.map((e=>e.name)).includes(i)){if("停止(&S)"===await uu.window.showMessageBox({type:"warning",title:"是否继续执行初始化操作？",text:`数据表(${i})已创建，继续初始化可能导致索引冲突。`,buttons:["继续(&N)","停止(&S)"]}))return o.appendLine({line:await hu.checkServiceSpace(e,"初始化索引已停止","error")})}else{const n=lu.join(lu.dirname(e.fsPath),`${i}.schema.json`);if(!au.existsSync(n))return o.appendLine({level:"error",line:await hu.checkServiceSpace(e,`Schema(${i}.schema.json) 不存在`,"error")});const r=lu.join(cu.tmpdir(),".dbschame"),s=Date.now(),a=lu.join(r,s.toString());au.existsSync(a)||au.mkdirSync(a,{recursive:!0});const c=[{local:n,server:a}];await fu({workspaceFolder:t,schema:!0,serverPath:a,updateSchemas:c})}const c=new du,l=lu.join(__dirname,"index.zip");c.addLocalFile(e.fsPath),await c.writeZipPromise(l);const u=await uu.http.request({url:"https://ide.liuyingyong.cn/serverless/database/init-index",method:"post",connectionTimeout:1e4,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:r,spaceId:s,appid:t.appid,name:i}},params:{attachment:uu.Uri.file(l)}});u.service&&1001===u.service.code?o.appendLine({line:await hu.checkServiceSpace(e,`索引(${n})初始化完成`,"error"),level:"success"}):o.appendLine({line:await hu.checkServiceSpace(e,u.service.description,"error"),level:"error"}),au.unlinkSync(l)};const gu=C.default,yu=ta,vu=E.default,wu=ca,{getCommonContext:xu}=ca,{createContext:bu,getContext:Su,getOutputViewWithContext:ku}=il,{isUniAppCli:Eu}=Mc;async function _u(e){const t=Su();return e.properties=Object.assign({},e.properties,{provider:e.properties?.provider||t.currentSpace.provider}),async function(e,t,n={}){const i=Su(),o=ku();o.show();const{provider:r,spaceId:s}=i.currentSpace,a=vu.basename(e),c=a.replace(".schema.json",""),l=vu.dirname(e),u={fsPath:e,workspaceFolder:t,properties:n};o.appendLine({level:"info",line:await wu.checkServiceSpace(u,`开始下载数据集合(${a}) ...`,"error")});const d=await gu.http.request({url:"https://ide.liuyingyong.cn/serverless/clientdb/schema-list",method:"post",serviceOptions:{serviceRequest:!0,body:{appid:t.appid,provider:r,spaceId:s,name:[c]}}});if(d&&d.service&&1001===d.service.code){if(d.service.body&&d.service.body.list.length>0){for(const e of d.service.body.list){const t=vu.join(l,e.name+".schema.json");if(yu.writeFileSync(t,e.content||"","utf-8"),e.locale)for(const t in e.locale){const n=vu.resolve(l,"locale",e.name,t+".json");yu.writeFileSync(n,e.locale[t]||"","utf-8")}}return o.appendLine({level:"success",line:await wu.checkServiceSpace(u,`下载数据集合Schema(${a})成功`,"error")})}return o.appendLine({level:"error",line:await wu.checkServiceSpace(u,`数据集合Schema(${c})云端不存在，请检查是否上传`,"error")})}return o.appendLine({level:"error",line:await wu.checkServiceSpace(u,d.service.description||`下载数据集合Schema(${c})失败`,"error")})}(e.fsPath,e.workspaceFolder,e.properties)}var Cu={async downloadSchemaResource(e){const t=await xu(e);bu().run(t,(()=>{_u(e)}))},async downloadAllSchemaResource(e){const t=await xu(e);bu().run(t,(()=>{!async function(e){const{fsPath:t,workspaceFolder:n}=e,i=Su(),o=ku(),r=wu.getUniModuleId(t),{provider:s,spaceId:a}=i.currentSpace;e.properties=Object.assign({},e.properties,{provider:e.properties?.provider||s}),o.show(),await o.appendLine({level:"info",line:await wu.checkServiceSpace(e,"开始运行下载所有数据集合Schema和数据库扩展校验函数","error")});let c={},l={},u={};const d=await gu.http.request({url:"https://ide.liuyingyong.cn/serverless/clientdb/schema-list",method:"post",serviceOptions:{serviceRequest:!0,body:{appid:n.appid,provider:s,spaceId:a,uniModuleId:r}}});if(!d||!d.service||1001!==d.service.code)return o.appendLine({level:"error",line:await wu.checkServiceSpace(e,d.service.description||"下载数据集合失败","error")});if(d.service.body&&d.service.body.list.length>0)for(const t of d.service.body.list){let i=vu.resolve(n.uri.fsPath,`uniCloud-${s}`,"database");t.uni_modules_id&&(i=Eu(n.uri.fsPath)?vu.resolve(n.uri.fsPath,"src","uni_modules",t.uni_modules_id,"uniCloud","database"):vu.resolve(n.uri.fsPath,"uni_modules",t.uni_modules_id,"uniCloud","database")),yu.ensureDirSync(i);const a=vu.join(i,t.name+".schema.json"),l=yu.existsSync(a);if(l&&!c.checked){if(c=await gu.window.showMessageBox2({type:"question",title:"",text:`当前位置下已存在数据集合Schema(${t.name}.schema.json)，是否替换?`,buttons:["替换(&R)","跳过(&K)","停止(&S)"],checkBoxText:"全部应用"}),null===c&&(c={button:"停止(&S)",checked:!1}),"停止(&S)"===c.button)throw new Error("停止上传");if("跳过(&K)"===c.button&&l)continue}if(yu.writeFileSync(a,t.content||"","utf-8"),t.locale)for(const e in t.locale){const n=vu.resolve(i,"locale",t.name,e+".json");yu.writeFileSync(n,t.locale[e]||"","utf-8")}await o.appendLine({level:"success",line:await wu.checkServiceSpace(e,`${r?`(${r})`:""}下载数据集合Schema(${t.name})成功`,"error")})}else await o.appendLine({level:"info",line:await wu.checkServiceSpace(e,"云端不存在数据集合","error")});await o.appendLine({level:"info",line:await wu.checkServiceSpace(e,"开始下载 DB Schema 扩展JS的配置","error")});const p=await gu.http.request({url:"https://ide.liuyingyong.cn/serverless/clientdb/download-schema-ext",method:"post",serviceOptions:{serviceRequest:!0,body:{appid:n.appid,provider:s,spaceId:a,name:[],uniModuleId:r}}});if(!p||!p.service||1001!==p.service.code)return o.appendLine({level:"error",line:await wu.checkServiceSpace(e,d.service.description||"下载DB Schema扩展JS失败","error")});if(p.service.body&&p.service.body.list.length>0)for(const t of p.service.body.list){let i=vu.resolve(n.uri.fsPath,`uniCloud-${s}`,"database");t.uniModuleId&&(i=Eu(n.uri.fsPath)?vu.resolve(n.uri.fsPath,"src","uni_modules",t.uniModuleId,"uniCloud","database"):vu.resolve(n.uri.fsPath,"uni_modules",t.uniModuleId,"uniCloud","database"));const a=vu.join(i,t.name+".schema.ext.js"),c=yu.existsSync(a);if(c&&!l.checked){if(l=await gu.window.showMessageBox2({type:"question",title:"",text:`当前位置下已存在 DB Schema 扩展JS(${t.name}.schema.ext.js)，是否替换?`,buttons:["替换(&R)","跳过(&K)","停止(&S)"],checkBoxText:"全部应用"}),null===l&&(l={button:"停止(&S)",checked:!1}),"停止(&S)"===l.button)throw new Error("停止上传");if("跳过(&K)"===l.button&&c)continue}yu.writeFileSync(a,t.content||"","utf-8"),await o.appendLine({level:"success",line:await wu.checkServiceSpace(e,`${r?`(${r})`:""}下载DB Schema扩展JS(${t.name})成功`,"error")})}else await o.appendLine({level:"info",line:await wu.checkServiceSpace(e,"云端不存在DB Schema扩展JS","error")});await o.appendLine({level:"info",line:await wu.checkServiceSpace(e,"开始运行下载所有数据集合Schema和数据库扩展校验函数","error")});const f=await gu.http.request({url:"https://ide.liuyingyong.cn/serverless/clientdb/validator-list",method:"post",serviceOptions:{serviceRequest:!0,body:{appid:n.appid,provider:s,spaceId:a,name:[],uniModuleId:r}}});if(!f||!f.service||1001!==f.service.code)return o.appendLine({level:"error",line:await wu.checkServiceSpace(e,d.service.description||"下载数据库扩展校验函数失败","error")});if(f.service.body&&f.service.body.list.length>0)for(const t of f.service.body.list){let i=vu.resolve(n.uri.fsPath,`uniCloud-${s}`,"database","validateFunction");t.uni_modules_id&&(i=Eu(n.uri.fsPath)?vu.resolve(n.uri.fsPath,"src","uni_modules",t.uni_modules_id,"uniCloud","database","validateFunction"):vu.resolve(n.uri.fsPath,"uni_modules",t.uni_modules_id,"uniCloud","database","validateFunction")),yu.ensureDirSync(i);const a=vu.join(i,t.name+".js"),c=yu.existsSync(a);if(c&&!u.checked){if(u=await gu.window.showMessageBox2({type:"question",title:"",text:`当前位置下已存在数据库扩展校验函数(${t.name}.js)，是否替换?`,buttons:["替换(&R)","跳过(&K)","停止(&S)"],checkBoxText:"全部应用"}),null===u&&(u={button:"停止(&S)",checked:!1}),"停止(&S)"===u.button)throw new Error("停止上传");if("跳过(&K)"===u.button&&c)continue}yu.writeFileSync(a,t.content||"","utf-8"),await o.appendLine({level:"success",line:await wu.checkServiceSpace(e,`${r?`(${r})`:""}下载数据库扩展校验函数(${t.name})成功`,"error")})}else await o.appendLine({level:"info",line:await wu.checkServiceSpace(e,"云端不存在数据库扩展校验函数","error")});o.appendLine({level:"success",line:await wu.checkServiceSpace(e,"下载完成","error")})}(e)}))}};const Iu=C.default,ju=Ka,Ou=E.default,Pu=ta,Lu=F.default,{getCommonContext:Nu,getUniModuleId:Fu}=ca,{createContext:Tu,getOutputViewWithContext:Du,getContext:$u}=il;async function Ru(e){const{fsPath:t,workspaceFolder:n,showCliTip:i=!0}=e,o=Ou.basename(t),r=$u(),s=Du(),{provider:a,spaceId:c,providerName:l,spaceName:u}=r.currentSpace,d=`[${l}:${u}]`,p=e=>`${d} ${e}`;i&&function(e){const t=$u(),n=Du(),{providerName:i,spaceName:o}=t.currentSpace,r=`[${i}:${o}]`,s=Ou.join(Lu.tmpdir(),e.name);Pu.ensureDirSync(s);const a=Ou.join(s,"history.json");let c={};if(Pu.existsSync(a))try{c=ju.parse(Pu.readFileSync(a).toString())}catch(e){}c.cliNoTip||(n.show(),n.appendLine({line:(e=>`${r} ${e}`)("HBuilderx已支持通过命令行cli部署uniCloud资源，详情参考：https://hx.dcloud.net.cn/cli/uniCloud [不再提示]"),hyperlinks:[{linkPosition:{start:r.length+38,end:r.length+75},onOpen:()=>{Iu.env.openExternal("https://hx.dcloud.net.cn/cli/uniCloud")}},{linkPosition:{start:r.length+77,end:r.length+81},onOpen:()=>{Iu.window.showInformationMessage("设置成功，控制台将不再提示该信息",["我知道了"]),c.cliNoTip=!0,Pu.writeFileSync(a,JSON.stringify(c))}}]}))}(n),s.show(),await s.appendLine({level:"info",line:p(`开始运行上传数据库扩展校验函数(${o})...`)});const f=Ou.resolve(Lu.tmpdir(),"validator.js");let h;Pu.copySync(t,f);try{h=await Iu.http.request({url:"https://ide.liuyingyong.cn/serverless/clientdb/edit-validator",method:"post",connectionTimeout:1e3,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:a,spaceId:c,appid:n.appid,name:o.replace(".js",""),uniModuleId:Fu(t)}},params:{attachment:Iu.Uri.file(f)}})}catch(e){throw await s.appendLine({level:"error",line:p(`上传数据库扩展校验函数(${o})失败`)}),Pu.removeSync(f),new Error(e)}h.service&&1001===h.service.code?await s.appendLine({level:"success",line:p(`上传数据库扩展校验函数(${o})成功`)}):await s.appendLine({level:"error",line:p(h.service.description)}),Pu.removeSync(f)}async function Au(e){const{fsPath:t,workspaceFolder:n}=e,i=Du(),o=$u(),{providerName:r,spaceName:s}=o.currentSpace,a=`[${r}:${s}]`,c=e=>`${a} ${e}`;let l=!0;const u=Pu.readdirSync(t),d=await async function(e,t){const n=$u(),{provider:i,spaceId:o}=n.currentSpace,r=new Set,s=await Iu.http.request({url:"https://ide.liuyingyong.cn/serverless/clientdb/validator-exists",method:"post",connectionTimeout:1e3,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:i,spaceId:o,appid:e.appid,name:t}}});if(s.service&&1001===s.service.code)for(const e of s.service.body.list)e.exists&&r.add(e.name);return r}(n,u.map((e=>e.replace(".js",""))));let p={button:"",checked:!1};for(const e of u){if(!/.js$/.test(e))continue;const o=d.has(e.replace(/\.js$/,""));if(o&&!p.checked&&(p=await Iu.window.showMessageBox2({type:"question",title:"",text:`云端当前位置下已存在数据库扩展函数(${e})，是否替换？`,buttons:["替换(&R)","跳过(&K)","停止(&S)"],checkBoxText:"全部应用"})),null===p||"停止(&S)"===p.button){await i.appendLine({level:"error",line:c("上传所有数据库扩展校验函数被取消")});break}"跳过(&K)"===p.button&&o||(await Ru({fsPath:Ou.join(t,e),workspaceFolder:n,showCliTip:l}),l=!1)}await i.appendLine({level:"success",line:c("上传数据库扩展校验函数完成")})}var Bu={async uploadValidateFunction(e){const t=await Nu(e);Tu().run(t,(()=>{Ru(e)}))},async uploadAllValidateFunction(e){const t=await Nu(e);Tu().run(t,(()=>{Au(e)}))}};const Mu=C.default,Uu=E.default,qu=ta,{getCommonContext:Wu,getUniModuleId:Ju}=ca,{createContext:Hu,getOutputViewWithContext:Vu,getContext:zu}=il;var Gu={async downloadValidateFunction(e){const t=await Wu(e);Hu().run(t,(()=>{!async function(e){const{fsPath:t,workspaceFolder:n}=e,i=Uu.basename(t),o=zu(),r=Vu(),{provider:s,spaceId:a,providerName:c,spaceName:l}=o.currentSpace,u=`[${c}:${l}]`,d=e=>`${u} ${e}`,p=await Mu.window.showMessageBox2({type:"question",title:"",text:`目标位置文件 ${t} 已经存在，是否替换?`,buttons:["替换(&R)","停止(&S)"]});if(null===p||"停止(&S)"===p.button)return;r.show(),await r.appendLine({level:"info",line:d(`开始运行下载数据库扩展校验函数(${i})...`)});const f=Ju(t);let h;try{h=await Mu.http.request({url:"https://ide.liuyingyong.cn/serverless/clientdb/validator-list",method:"post",serviceOptions:{serviceRequest:!0,body:{appid:n.appid,provider:s,spaceId:a,name:[i.replace(".js","")],uniModuleId:f}}})}catch(e){throw await r.appendLine({level:"error",line:d(`下载数据库扩展校验函数(${i})失败`)}),new Error(e)}if(!h||!h.service||1001!==h.service.code)return r.appendLine({level:"error",line:d(h.service.description||`下载数据库扩展校验函数${i}失败`)});if(!(h.service.body&&h.service.body.list.length>0))return r.appendLine({level:"info",line:d(`云端不存在数据库扩展校验函数(${i})`)});{const e=h.service.body.list[0];qu.writeFileSync(t,e.content||"","utf-8"),await r.appendLine({level:"info",line:d(`${f?`(${f})`:""}下载数据库扩展校验函数(${e.name}.js)成功`)})}}(e)}))},async downloadAllValidateFunction(e){const t=await Wu(e);Hu().run(t,(()=>{!async function(e){const{fsPath:t,workspaceFolder:n}=e,i=zu(),{provider:o,spaceId:r,spaceName:s,providerName:a}=i.currentSpace,c=Vu(),l=`[${a}:${s}]`,u=e=>`${l} ${e}`;c.appendLine({level:"info",line:u("开始运行下载所有数据库扩展校验函数")});const d=Ju(t),p=await Mu.http.request({url:"https://ide.liuyingyong.cn/serverless/clientdb/validator-list",method:"post",serviceOptions:{serviceRequest:!0,body:{appid:n.appid,provider:o,spaceId:r,name:[],uniModuleId:d}}});let f={button:"",checked:!1};if(!p||!p.service||1001!==p.service.code)return c.appendLine({level:"error",line:u(p.service.description||"下载数据库扩展校验函数失败")});if(!(p.service.body&&p.service.body.list.length>0))return c.appendLine({level:"info",line:u("云端不存在数据库扩展校验函数")});for(const e of p.service.body.list){const n=Uu.resolve(t,e.name+".js"),i=qu.existsSync(n);if(i&&!f.checked){if(f=await Mu.window.showMessageBox2({type:"question",title:"",text:`当前位置下已存在数据库扩展校验函数(${e.name}.js)，是否替换?`,buttons:["替换(&R)","跳过(&K)","停止(&S)"],checkBoxText:"全部应用"}),null===f&&(f={button:"停止(&S)",checked:!1}),"停止(&S)"===f.button)throw new Error("停止上传");if("跳过(&K)"===f.button&&i)continue}qu.writeFileSync(n,e.content||"","utf-8"),await c.appendLine({level:"success",line:u(`${d?`(${d})`:""}下载数据库扩展校验函数(${e.name}.js)成功`)})}c.appendLine({level:"success",line:u("下载数据库扩展校验函数完成")})}(e)}))}};const Ku=C.default,Zu=ca,Yu=E.default,Xu=ta,Qu=Ku.env.appData+"/templates/file/dbvalidation",ed=Ku.env.appRoot+"/plugins/templates/file/dbvalidation";function td(e={},{dirPath:t,templateList:n,templateListSelected:i=0}){let o;return e.fileNameInput||(e.fileNameInput="new_validation.js"),e.dirPathInput||(e.dirPathInput=t),e.templateList||(e.templateList=i),e.fileNameInput&&(o=e.fileNameInput.indexOf(".")),n&&(n=n.map((e=>({columns:[{label:e.name}]})))),{title:"新建数据库扩展校验函数文件",hideSubTitle:!0,focusName:"templateList",formItems:[{type:"input",name:"fileNameInput",placeholder:"请输入文件名",value:e.fileNameInput,selection:e.fileNameInput?{offset:0,length:o}:""},{type:"fileSelectInput",name:"dirPathInput",mode:"folder",placeholder:"请选择文件路径",value:e.dirPathInput},{type:"list",name:"templateList",title:"选择模板",columnStretches:[1],items:n,value:e.templateList}]}}var nd={newDBSchemaResource:wa,updateDBSchemaResource:ja,uploadDBSchemaResource:bl,createSchemaJS:jl,uploadSchemaJS:nl,downloadSchemaJS:$l,initDB:Kl,initDBData:su,initDBIndex:mu,downloadDBSchemaResource:Cu,uploadValidateFunction:Bu,downloadValidateFunction:Gu,newValidateFunction:{createValidateFunction:function(e){const{fsPath:t}=e,n=[];Ku.window.showFormDialog({cornerWidget:{type:"label",text:"<a href='custom'>[自定义模板]</a>",onEvent:()=>{Xu.ensureDirSync(Qu);const e=Qu.startsWith("/")?"file://":"file:///";Ku.env.openExternal(e+Qu)}},...td({},{dirPath:t}),onOpened:function(){Zu.walkSync(ed.toString(),(function(e,t){let i=Yu.basename(e);Zu.isTemplateFile(e)&&(i=i.substring(0,i.indexOf(".")),n.push({name:i,path:e,title:i}))})),Zu.walkSync(Qu,(function(e,t){let i=Yu.basename(e);Zu.isTemplateFile(e)&&(i=i.substring(0,i.indexOf(".")),n.push({name:i,path:e,title:i}))})),this.updateForm(td({},{templateList:n}))},validate:async function(e){return this.showError(""),e.fileNameInput?/^[a-zA-Z][a-zA-Z0-9-_.]*$/.test(e.fileNameInput)?e.dirPathInput?e.templateList<0?(this.showError("请选择模板"),!1):!Xu.existsSync(e.dirPathInput+"/"+e.fileNameInput)||(this.showError("选择的位置已存在同名的数据库扩展校验函数文件"),!1):(this.showError("请选择文件路径"),!1):(this.showError("文件名仅能以字母开头，只允许使用大小写字母、数字、连字符（-）及下划线（_）"),!1):(this.showError("请输入文件名"),!1)}}).then((e=>{const t=n[e.templateList];if(!t)return;let i=e.dirPathInput;Xu.ensureDirSync(i),i=i+"/"+e.fileNameInput;const o=Xu.readFileSync(t.path,"utf-8");o&&(Xu.writeFileSync(i,o,{encoding:"utf-8"}),Ku.workspace.openTextDocument(i))}))},createValidateFunctionDir:function(e){Xu.ensureDirSync(Yu.resolve(e.fsPath,"validateFunction"))}}};const id=C.default,od=R.default,rd=E.default,sd=O.default,ad=ta,cd=Ka,ld=jn,ud=ca,{getWorkspaceBindServiceSpace:dd}=Ct;let pd=!0;const fd=async function(e,t,n){const i=rd.parse(e.dbFolder?e.dbFolder.fsPath:e.fsPath).base;return"success"===n?`${t} (${i}) 成功`:`${t} (${i})...`},hd=async(e,t)=>{const{properties:n}=e;if(e.spec){const{fsPath:t}=e.spec,n=ud.initWizard(t,e);if("boolean"==typeof n)return"取消";e=n}if(console.error("properties.provider ----------------- "+JSON.stringify(n)),n&&n.provider&&0===t.length)return"不存在云服务空间";const i=/(?<=(\/|\\)uni_modules(\/|\\))[^/\\]*/g,o=e.dbFolder?e.dbFolder.fsPath.match(i):e.fsPath.match(i);if(!o){const t=e.dbFolder?e.dbFolder.fsPath:e.fsPath;return t.indexOf("uniCloud-aliyun")>=0?"阿里云":t.indexOf("uniCloud-tcb")>=0?"腾讯云":"支付宝云"}if(t.length>1){const t=new RegExp(`.*uni_modules(/|\\\\)(?=${o[0]})`),n=e.dbFolder?e.dbFolder.fsPath.match(t):e.fsPath.match(t),i=rd.join(n[0],o[0]+"/package.json");if(!sd.existsSync(i)){const t=await id.window.showMessageBox({type:"warning",title:"",text:`项目 ${e.fsPath?rd.parse(e.fsPath).base:e.uniModuleId} 同时绑定了多个云服务商，请为当前操作指定使用哪个`,buttons:["腾讯云","阿里云","支付宝云","取消"]});return"取消"!==t&&t}{const t=cd.parse(sd.readFileSync(i).toString());if("n"!==t.uni_modules.platforms.cloud.aliyun||"n"!==t.uni_modules.platforms.cloud.tcb||"n"!==t.uni_modules.platforms.cloud.alipay){const t=await id.window.showMessageBox({type:"warning",title:"",text:`项目 ${e.fsPath?rd.parse(e.fsPath).base:e.uniModuleId} 同时绑定了多个云服务商，请为当前操作指定使用哪个`,buttons:["腾讯云","阿里云","支付宝云","取消"]});return"取消"!==t&&t}}}return n&&n.provider&&1===t.length?"aliyun"===n.provider?"阿里云":"tcb"===n.provider?"腾讯云":"支付宝云":"单个云服务空间"};async function md(e,t,n,i,o,r,s,a){const c=rd.join(__dirname,"/schema-ext.zip"),l=new ld,u=[{name:rd.parse(e[t]).name.split(".schema.ext")[0],uniModuleId:-1!==e[t].indexOf("uni_modules")?rd.join(rd.parse(e[0]).dir,"../../").match(/(?<=(\/|\\)uni_modules(\/|\\))[^/\\]*/g)[0]:""}];l.addLocalFile(e[t]),await l.writeZipPromise(c);const d=JSON.parse(JSON.stringify(s));d.dbFolder.fsPath=d.dbFolder?e[t]:"";const p=await fd(d,"正在上传DB Schema扩展JS");await a.report({increment:1,message:p});try{const e=await id.http.request({url:"https://ide.liuyingyong.cn/serverless/clientdb/upload-schema-ext",method:"post",connectionTimeout:1e4,readTimeout:5e3,serviceOptions:{serviceRequest:!0,body:{provider:n,spaceId:i,appid:s.appId,run:1,config:u}},params:{attachment:id.Uri.file(c)}});console.log(e,"res"),1001===e.service.code&&sd.existsSync(c)||(pd=!1,await a.report({increment:1,level:"error",message:e.service.description})),sd.unlinkSync(c)}catch(e){const t=ud.errorArray(e);pd=!1,await a.report({increment:1,level:"error",message:t})}}const gd=async(e,t,n,i,o,r,s,a)=>{const c=rd.parse(e[t]).name.split(".schema.ext")[0],{service:l}=await id.http.request({url:"https://ide.liuyingyong.cn/serverless/clientdb/schema-ext-exists",method:"post",connectionTimeout:1e4,readTimeout:5e3,serviceOptions:{serviceRequest:!0,body:{provider:n,spaceId:i,appid:s.appId,run:1,name:[c]}}});return l};async function yd(e,t,n,i,o,r){let s,a=!1,c=!0;if(e&&e.length)for(let l=0;l<e.length;l++){if(!a&&c){const{spaceId:i}=await dd({workspaceFolder:t}),r=await gd(e,l,n,i,0,0,o);r.body&&r.body.list&&r.body.list.length&&(a=r.body.list[0].exists)}if(a&&(s=await id.window.showMessageBox2({type:"question",title:"",text:`云端已存在名为 ${rd.parse(e[l]).base} 的文件，是否使用正在上传的文件来替换它？`,buttons:["替换","跳过","停止"],checkBoxText:"全部应用"})),!a&&c){let{spaceId:i,allSpaces:s}=await dd({workspaceFolder:t});s.length>1&&s.forEach((e=>{e.provider===n&&(i=e.id)})),await md(e,l,n,i,0,0,o,r)}if(s){const{button:u,checked:d}=s;let{spaceId:p,allSpaces:f}=await dd({workspaceFolder:t});if(f.length>1&&f.forEach((e=>{e.provider===n&&(p=e.id)})),"停止"===u)break;if(d&&"替换"===u&&(await md(e,l,n,p,0,0,o,r),a=!1,c=!1),d&&"跳过"===u)break;if(!d&&"替换"===u)return await md(e,l,n,p,0,0,o,r),a=!0,e=e.slice(l+1,e.length),void await yd(e,t,n,i,o,r)}}}const vd=function(e,t){const n=[];return e.uni_modules&&e.uni_modules.platforms&&e.uni_modules.platforms.cloud&&("n"!==e.uni_modules.platforms.cloud.aliyun&&n.push("aliyun"),"n"!==e.uni_modules.platforms.cloud.tcb&&n.push("tcb"),"n"!==e.uni_modules.platforms.cloud.alipay&&n.push("alipay")),-1===n.indexOf(t)};async function wd(e,t,n,i){let o,r=!1;if(e&&e.length)for(let s=0;s<e.length;s++)if(!r&&sd.existsSync(rd.join(t.dbFolder.fsPath,e[s].name+n))&&(o=await id.window.showMessageBox2({type:"question",title:"",text:`本地已存在名为 ${e[s].name} 的文件，是否使用正在下载的文件来替换它？`,buttons:["替换","跳过","停止"],checkBoxText:"全部应用"})),sd.existsSync(rd.join(t.dbFolder.fsPath,e[s].name+n))){if(!o)break;{const{button:a,checked:c}=o;if("停止"===a)break;if(c&&"替换"===a&&(await xd(t,n,e,s,i),await bd(t,n,e,s),r=!0),c&&"跳过"===a)break;if(!c&&"替换"===a)return await xd(t,n,e,s,i),await bd(t,n,e,s),e=e.slice(s+1,e.length),void await wd(e,t,n,i)}}else await xd(t,n,e,s,i),await bd(t,n,e,s)}const xd=async(e,t,n,i,o)=>{const r=JSON.parse(JSON.stringify(e));n[i].uniModuleId&&(r.dbFolder.fsPath=rd.join(rd.join(e.dbFolder.fsPath,"../../"),"uni_modules/uniCloud/database/"+n[i].uniModuleId+"/"+n[i].name+t)),r.dbFolder.fsPath=r.dbFolder?rd.join(e.dbFolder.fsPath,n[i].name+t):"";const s=await fd(r,"正在下载DB Schema扩展JS");await o.report({increment:1,message:s})},bd=async(e,t,n,i)=>{let o="";const r=JSON.parse(JSON.stringify(e));if(sd.lstatSync(e.dbFolder.fsPath).isFile()?o=e.dbFolder.fsPath:(n[i].uniModuleId&&-1===e.dbFolder.fsPath.indexOf("uni_modules")?r.dbFolder.fsPath=rd.join(rd.join(e.dbFolder.fsPath,"../../"),"uni_modules/"+n[i].uniModuleId+"/uniCloud/database/"):r.dbFolder.fsPath=e.dbFolder.fsPath,o=rd.join(r.dbFolder.fsPath,n[i].name+t)),-1!==e.dbFolder.fsPath.indexOf("uniCloud-aliyun")||-1!==e.dbFolder.fsPath.indexOf("uniCloud-tcb")||-1!==e.dbFolder.fsPath.indexOf("uniCloud-alipay")){if(n[i].uniModuleId){const e=rd.join(rd.join(o,"../../../../"),n[i].uniModuleId);return sd.existsSync(rd.join(e,"/uniCloud/database/"))||ad.ensureDirSync(rd.join(e,"/uniCloud/database/")),void sd.writeFileSync(rd.join(e,`/uniCloud/database/${n[i].name}${t}`),n[i].content,"utf-8")}}else sd.existsSync(rd.join(o,"../"))||ad.ensureDirSync(rd.join(o,"../"));sd.writeFileSync(o,n[i].content,"utf-8")},Sd=async(e,t,n,i,o)=>{if(!e){const e="aliyun"===n?"阿里云":"tcb"===n?"腾讯云":"支付宝云";return await sd.readdirSync(i.fsPath,{withFileTypes:!0}).forEach((t=>{const n=`[${e}]${t.name}下载失败。失败原因：无法关联服务空间`;o.report({increment:1,level:"error",message:n})})),!1}if(!t){const e="aliyun"===n?"阿里云":"tcb"===n?"腾讯云":"支付宝云";return await sd.readdirSync(i.fsPath,{withFileTypes:!0}).forEach((t=>{const n=`[${e}]${t.name}下载失败。失败原因：请指定 appId`;o.report({increment:1,level:"error",message:n})})),!1}return!!n||(await sd.readdirSync(i.fsPath,{withFileTypes:!0}).forEach((e=>{const t=`${e.name}下载失败。失败原因：请指定阿里云或腾讯云服务空间`;o.report({increment:1,level:"error",message:t})})),!1)};var kd={upLoadAllFile:async function(e){pd=!0,console.error("----------------------------- 走到了 node 端 ---------------------------------------"),console.error("----------------------------- params ---------------------------------------"+JSON.stringify(e));let{parentId:t,workspaceFolder:n,dbFolder:i,provider:o,spaceId:r,appId:s}=e;const a=i.fsPath,c={cancellable:!0,location:{parentId:t}},l=[],{allSpaces:u}=await dd({workspaceFolder:n}),d=await hd(e,u);if(d&&"取消"!==d){if("阿里云"===d?o="aliyun":"腾讯云"===d?o="tcb":"支付宝云"===d&&(o="alipay"),-1!==a.indexOf("uni_modules")){const e=rd.join(rd.join(a,"../../"),"/package.json");if(sd.existsSync(e)){const t=cd.parse(sd.readFileSync(e).toString());if(vd(t,o))return}sd.readdirSync(a,{withFileTypes:!0}).forEach((e=>{-1!==e.name.indexOf(".schema.ext.js")&&l.push(rd.join(a,e.name))}))}else{const e=rd.join(rd.join(a,"../../"),"uni_modules");sd.readdirSync(rd.join(rd.join(a,"../../"),"uni_modules"),{withFileTypes:!0}).forEach((t=>{if(sd.existsSync(rd.join(e,`/${t.name}/uniCloud/database`))){if(sd.existsSync(rd.join(e,`/${t.name}/package.json`))){const n=cd.parse(sd.readFileSync(rd.join(e,`/${t.name}/package.json`)).toString());if(vd(n,o))return}sd.readdirSync(rd.join(e,`/${t.name}/uniCloud/database`)).forEach((n=>{-1!==n.indexOf(".schema.ext.js")&&l.push(rd.join(e,`/${t.name}/uniCloud/database/${n}`))}))}})),sd.readdirSync(a).forEach((e=>{-1!==e.indexOf(".schema.ext.js")&&l.push(rd.join(a,e))}))}await od.window.withProgress(c,(async t=>{await Sd(r,s,o,i,t)&&await yd(l,n,o,e.dbFolder.fsPath,e,t)}))}},downLoadAllFile:async function(e){let{parentId:t,workspaceFolder:n,dbFolder:i,provider:o,spaceId:r,appId:s}=e;const{allSpaces:a}=await dd({workspaceFolder:n}),c=await hd(i,a);if(!c||"取消"===c)return;"阿里云"===c?o="aliyun":"腾讯云"===c?o="tcb":"支付宝云"===c&&(o="alipay"),a.length>1&&a.forEach((e=>{e.provider===o&&(r=e.id)}));const l={cancellable:!0,location:{parentId:t}},u=await(async e=>{const t={uniModuleId:""},n=e.dbFolder.fsPath.match(/(?<=(\/|\\)uni_modules(\/|\\))[^/\\]*/g);if(n&&n.length>0){const i=new RegExp(`.*uni_modules(/|\\\\)(?=${n[0]})`),o=e.dbFolder.fsPath.match(i),r=rd.join(o[0],n[0]+"/package.json");if(sd.existsSync(r)){const e=cd.parse(sd.readFileSync(r).toString());e.id&&"[object String]"===Object.prototype.toString.call(e.id)&&(t.uniModuleId=e.id)}else t.uniModuleId=n}return t})(e);await od.window.withProgress(l,(async t=>{if(o){if(await Sd(r,s,o,i,t))try{const{service:n}=await id.http.request({url:"https://ide.liuyingyong.cn/serverless/clientdb/download-schema-ext",method:"post",connectionTimeout:1e4,readTimeout:5e3,serviceOptions:{serviceRequest:!0,body:{provider:o,spaceId:r,appid:s,run:1,name:[],uniModuleId:u.uniModuleId?u.uniModuleId:""}}});1001===n.code?await wd(n.body.list,e,".schema.ext.js",t):await t.report({increment:1,level:"error",message:n.description})}catch(e){const n=ud.errorArray(e);await t.report({increment:1,level:"error",message:n})}}else await t.report({increment:1,level:"error",message:"请为项目指定云服务空间"})}))},getUploadAllSuccessOrError:()=>pd};const Ed=C.default,_d=R.default,Cd=nd,{upLoadAllFile:Id,getUploadAllSuccessOrError:jd,downLoadAllFile:Od}=kd;var Pd={activate:function(e){const t=Ed.commands.registerCommand("uniCloud.newdbSchemaResource",Cd.newDBSchemaResource),n=Ed.commands.registerCommand("uniCloud.updatedbSchemaResource",Cd.updateDBSchemaResource.updateDbSchemaResource),i=Ed.commands.registerCommand("uniCloud.createSchemaJS",Cd.createSchemaJS),o=Ed.commands.registerCommand("uniCloud.uploadSchemaJS",(async e=>{const{workspaceFolder:t}=e,n=Ed.window.createOutputView({id:`${t.id}-unicloud`,title:`[${t.name}] - unicloud控制台`});n.show(),await Cd.uploadSchemaJS(e,(async(e,t)=>{await n.appendLine({level:t||"",line:e})}))})),r=Ed.commands.registerCommand("uniCloud.downloadSchemaJS",Cd.downloadSchemaJS),s=Ed.commands.registerCommand("uniCloud.initDB",Cd.initDB.initDB),a=Ed.commands.registerCommand("uniCloud.initDBData",Cd.initDBData),c=Ed.commands.registerCommand("uniCloud.initDBIndex",Cd.initDBIndex),l=Ed.commands.registerCommand("uniCloud.oldInitDBTransfer",Cd.initDB.oldInitDBTransfer),u=Ed.commands.registerCommand("uniCloud.uploadDBSchemaResource",Cd.uploadDBSchemaResource.uploadSchemaResource),d=Ed.commands.registerCommand("uniCloud.downloadDBSchemaResource",Cd.downloadDBSchemaResource.downloadSchemaResource),p=Ed.commands.registerCommand("uniCloud.uploadAllDBSchemaResource",Cd.uploadDBSchemaResource.uploadAllSchemaResource),f=Ed.commands.registerCommand("uniCloud.downloadAllDBSchemaResource",Cd.downloadDBSchemaResource.downloadAllSchemaResource),h=Ed.commands.registerCommand("uniCloud.uploadValidateFunction",Cd.uploadValidateFunction.uploadValidateFunction),m=Ed.commands.registerCommand("uniCloud.uploadAllValidateFunction",Cd.uploadValidateFunction.uploadAllValidateFunction),g=Ed.commands.registerCommand("uniCloud.downloadValidateFunction",Cd.downloadValidateFunction.downloadValidateFunction),y=Ed.commands.registerCommand("uniCloud.downloadAllValidateFunction",Cd.downloadValidateFunction.downloadAllValidateFunction),v=Ed.commands.registerCommand("uniCloud.newValidateFunction",Cd.newValidateFunction.createValidateFunction),w=Ed.commands.registerCommand("uniCloud.createValidateFunctionDir",Cd.newValidateFunction.createValidateFunctionDir);return e.subscriptions.push(t),e.subscriptions.push(n),e.subscriptions.push(i),e.subscriptions.push(o),e.subscriptions.push(r),e.subscriptions.push(s),e.subscriptions.push(a),e.subscriptions.push(c),e.subscriptions.push(u),e.subscriptions.push(d),e.subscriptions.push(p),e.subscriptions.push(f),e.subscriptions.push(h),e.subscriptions.push(m),e.subscriptions.push(g),e.subscriptions.push(y),e.subscriptions.push(v),e.subscriptions.push(w),e.subscriptions.push(l),{uploadFunction:async e=>{const{parentId:t}=e;if(!t||0===t.length)return console.error("获取不到任务ID （parentId）！"),!1;await _d.window.withProgress({cancellable:!0,location:{parentId:t}},(async t=>{await Cd.uploadSchemaJS(e,((e,n)=>{t.report({message:e,level:n})}))}))},downloadFunction:async e=>{await Cd.downloadSchemaJS(e)},upLoadAllFile:async e=>{await Id(e);const t=Ed.extensions.getExtension("unicloud");return t&&t.synchronouDependencies({caller:2,...e}),jd()},downLoadAllFile:async e=>{await Od(e);const t=Ed.extensions.getExtension("unicloud");t&&t.downLoadJson({caller:2,...e})},cliUpLoadFunction:async e=>{},cliDownLoadFunction:async e=>{},updatedbSchema:Cd.updateDBSchemaResource.updateDBSchema,initDB:Cd.initDB}},deactivate:function(){},initDB:Cd.initDB,uploadSchemaJS:Cd.uploadSchemaJS,uploadAllDBSchemaResource:Cd.uploadDBSchemaResource.uploadAllSchemaResource},Ld={exports:{}};const Nd=C.default,Fd=Rt,Td=E.default,Dd=O.default,$d=F.default,Rd=Ka,{getHBuilderXNodeVersion:Ad,getCloudFunctionNodeVersion:Bd}=Ct;var Md=async function(e){const{workspaceFolder:t,cloudPath:n,isRun:i=!1,showCliTip:o=!0}=e;if(!t.appid)return Nd.window.showMessageBox({type:"warning",title:"",text:"缺少appid，请在manifest.json中设置appid",buttons:["确定"]});const r=Fd.resolveCloudFunctionOrObjectPath(n),s=Fd.resolveFunctionOrObjectName(r),a=Fd.isCloudObject(r)?"云对象":"云函数",c=`${s}.param.${Fd.isCloudObject(r)?"js":"json"}`;let l=Td.join(r,c);l=Dd.existsSync(l)?l:null;let u=Td.join(r,"package.json");u=Dd.existsSync(u)?u:null;let d=Nd.window.createOutputView({id:`${t.id}-unicloud`,title:`[${t.name}] - unicloud控制台`});const{code:p,msg:f,provider:h,spaceName:m,spaceId:g}=await Fd.getSpaceInfo(t,r,a);if(0!==p)return d.show(),void d.appendLine({level:"error",line:f});const y=Fd.providerToCN(h),v=Td.join($d.tmpdir(),t.name);Dd.existsSync(v)||Dd.mkdirSync(v);let w=`[${y}:${m}]`;const x=Td.join(v,"history.json");let b={};if(Dd.existsSync(x))try{b=Rd.parse(Dd.readFileSync(x).toString())}catch(e){}!b.cliNoTip&&o&&d.appendLine({line:`${w}HBuilderx已支持通过命令行cli部署uniCloud资源，详情参考：https://hx.dcloud.net.cn/cli/uniCloud [不再提示]`,hyperlinks:[{linkPosition:{start:w.length+38,end:w.length+75},onOpen:()=>{Nd.env.openExternal("https://hx.dcloud.net.cn/cli/uniCloud")}},{linkPosition:{start:w.length+77,end:w.length+81},onOpen:()=>{Nd.window.showInformationMessage("设置成功，控制台将不再提示该信息",["我知道了"]),b.cliNoTip=!0,Dd.writeFileSync(x,JSON.stringify(b))}}]});const S=Ad(),E=Bd(n,h);if(S&&E&&S!==E){const e=`${w}本地node版本是${S}，云端node版本是${E}，请注意兼容问题。调整云端node版本参考`;d.appendLine({line:e,hyperlinks:[{linkPosition:{start:e.length-2,end:e.length},onOpen:()=>{Nd.env.openExternal("https://doc.dcloud.net.cn/uniCloud/cf-functions.html#node%E7%89%88%E6%9C%AC")}}],level:"warning"})}d.appendLine({line:`${w}正在上传${a}${s}${l&&i?"(已携带"+c+"参数)":""}...`}),i&&(w=`[云端运行:${y}:${m}]`);let C=Td.join(v,s);Fd.copyDir(r,C,["node_modules"]);let k=[];if(u)try{let e;const t=Rd.parse(Dd.readFileSync(u).toString());if(t.dependencies&&"[object Object]"===Object.prototype.toString.call(t.dependencies)){let n=t.dependencies;e={...n};for(let t in n)n[t].startsWith("file:")&&(k.push(t),delete e[t])}if(Object.keys(e).length>0&&"aliyun"===h){d.appendLine({line:`${w}正在安装${a}${s}依赖...`});const t=Td.join(C,"package.json");let n=Rd.parse(Dd.readFileSync(t).toString());n.dependencies=e,Dd.writeFileSync(t,JSON.stringify(n,null,"    "));let i=Nd.workspace.getConfiguration().get("npm.path");if(!i||!Dd.existsSync(i)){let e="npm";if("Windows_NT"===$d.type()&&(e="npm.cmd"),i=Td.join(Nd.env.appRoot,"plugins","npm",e),!i||!Dd.existsSync(i))return void d.appendLine({line:"npm install执行失败，未找到npm 路径，请检查后重试"})}console.log(i);let o=await new Promise((e=>{const t=require("child_process").exec(`"${i}" install`,{cwd:C},((n,i,o)=>{let r={success:!0,msg:""};0!==t.exitCode&&(r.success=!1,r.msg=o),n&&(console.error(`exec error: ${n}`),r.success=!1,r.msg=n.message),e(r)}))}));if(!o.success)return void d.appendLine({level:"error",line:o.msg||"npm install执行失败，如果云函数目录下存在package-lock.json, node_modules可能会导致 npm install失败, 请删除后重试。"});Dd.copyFileSync(u,t)}}catch(e){}const _=Td.join(v,`${s}.zip`);let I=await Nd.util.compressDir(_,C);if(0!=I.code||!I.res||1!=I.res)return;Dd.existsSync(C)&&Dd.rmSync(C,{recursive:!0,force:!0});let j="",O={common:k},L="";const P=Nd.extensions.getExtension("unicloud");if(P){let e=await P.getFunctionParam(r);j=JSON.stringify(e)}if(Fd.isUniModule(r)){const t=Td.join(Fd.resolveUniModuleRootPath(r),"package.json");if(Dd.existsSync(t))try{const e=Rd.parse(Dd.readFileSync(t).toString());e.id&&"[object String]"===Object.prototype.toString.call(e.id)&&(L=e.id)}catch(e){}}let N;try{N=await Nd.http.request({url:"https://ide.liuyingyong.cn/serverless/function/upload",method:"post",connectionTimeout:1e4,readTimeout:5e3,serviceOptions:{serviceRequest:!0,body:{provider:h,spaceId:g,appid:t.appid,functionName:s,run:i?1:0,run_params:j,dependencies:O,uniModuleId:L}},params:{attachment:Nd.Uri.file(_)}})}catch(e){return void d.appendLine({line:`${w}上传失败：${e.message||e.toString()}`,level:"error"})}if(1001!==N.service.code)return void d.appendLine({line:`${w}上传失败：${N.service.description}`,level:"error"});if(Dd.unlinkSync(_),!i)return d.appendLine({line:`${w}${a}${s}上传完成`,level:"success"});d.appendLine({line:`${w}${a}${s}上传完成，开始运行...`,level:"success"});let F=N.service.body,T=F.ticket,D=Date.now()/1e3,$=!1;for(;!(Date.now()/1e3-D>=120);)try{let e=await Nd.http.request({url:"https://ide.liuyingyong.cn/serverless/function/run-result",method:"post",serviceOptions:{serviceRequest:!0,body:{ticket:T}}});if(1001===e.service.code){if(F=e.service.body,"OK"===F.status){$=!0;break}if("FAILED"===F.status)break}await new Promise((e=>{setTimeout(e,300)}))}catch(e){}d.appendLine({line:`${w}运行状态：${$?"成功":"失败"}`,level:$?"success":"error"});const R=F.result;let A="\n"+F.log;const{billingDuration:B,invocationDuration:M,maxMemoryUsage:U,requestId:q}=F.runtimeMeta;d.appendLine({line:`${w}运行结果：${R}`}),d.appendLine({line:`${w}运行日志：${A}`}),d.appendLine({line:`${w}运行报告：计费时间:${B} 运行时间:${M} 运行内存:${U}`})},Ud={};const{AsyncLocalStorage:qd}=I.default,Wd=Symbol("CONTEXT_STORAGE");function Jd(){return Ue[Wd]||(Ue[Wd]=new qd),Ue[Wd]}function Hd(){const e=Jd().getStore();if(!e)throw new Error("context is not exist");return e}Ud.createContext=Jd,Ud.getContext=Hd,Ud.getOutputViewWithContext=function(){return Hd()?.outputView};var Vd={exports:{}};!function(e){const{createContext:t,getOutputViewWithContext:n,getContext:i}=Ud,{getCommonContext:o,getBindSpace:r,getUniModuleId:s,findNpmCli:a}=Rt,c=E.default,l=ta,u=F.default,{spawn:d}=N.default,p=jn,f=C.default,{isUniAppCli:h}=Mc,m=c.resolve(u.tmpdir(),"hx-unicloud-plugin");async function g(e){const{fsPath:t,workspaceFolder:o,fsPaths:r}=e;if(!o.appid)return f.window.showMessageBox({type:"warning",title:"",text:"缺少appid，请在manifest.json中设置appid",buttons:["确定"]});const a=i(),u=n(),{provider:d,providerName:h,spaceId:g,spaceName:v}=a.currentSpace,w=e=>`[${h}:${v}] ${e}`,x=e=>Object.keys(e||{}).reduce(((t,n)=>{const i=e[n];return i.startsWith("file:")||(t[n]=i),t}),{}),b=r||[t],S=b.map((e=>c.basename(e))).join(",");if(b.length<=0)return;u.show(),await u.appendLine({level:"info",line:w(`正在上传公共模块${S}...`)});const E=[];for(const t of b){const n=c.basename(t);if(l.readdirSync(t).length<=0){if(await u.appendLine({level:"error",line:w(`公共模块${n}内没有文件, 停止上传`)}),b.length)continue;return}const i=s(t),o=i?c.resolve(m,"uni_modules",i,n):c.resolve(m,n);l.ensureDirSync(o),l.copySync(t,o,{filter:e=>!(e.endsWith(".DS_Store")||e.endsWith("node_modules")||e.endsWith("package-lock.json"))});const r=c.resolve(o,"package.json");let a={};if(l.existsSync(r)){a=l.readJsonSync(r);const t=Object.assign({},a);if(t.dependencies&&(t.dependencies=x(t.dependencies)),t.devDependencies&&(t.devDependencies=x(t.devDependencies)),l.writeJsonSync(r,t),t.dependencies&&Object.keys(t.dependencies).length||t.devDependencies&&Object.keys(t.devDependencies).length){await u.appendLine({level:"info",line:w(`正在安装公共模块${n}依赖...`)});try{await y(o)}catch(e){return u.appendLine({level:"error",line:w(`安装公共模块${n}依赖失败。\n${e}`)})}}}l.writeJsonSync(r,a),E.push(o)}if(E.length<=0)return;const C=function(e=[]){if(e.length<=0)return;const t=c.resolve(m,`preUpload-${Date.now()}`),n=new p;l.ensureDirSync(t);for(const i of e){const e=c.basename(i);let o=new p;const r=c.resolve(t,`${e}.zip`);o.addLocalFolder(i),o.writeZip(r),n.addLocalFile(r)}const i=c.resolve(t,"commonModule.zip");return n.writeZip(i),i}(E),k=function(e=[]){let t={};const n=e=>Object.keys(e||{}).filter((t=>e[t].startsWith("file:")));for(const i of e){const e=c.basename(i),o=c.resolve(i,"package.json");if(!l.existsSync(o)){t[e]={};continue}const r=l.readJsonSync(o),a=[...n(r.dependencies),...n(r.devDependencies)],u={uniModuleId:s(i),version:r.version};t[e]={localDependencies:a,moduleInfo:u}}return t}(b),_=await f.http.request({url:"https://ide.liuyingyong.cn/serverless/commonModule/upload",method:"post",connectionTimeout:1e4,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:d,spaceId:g,appid:o.appid,modules:Object.keys(k).reduce(((e,t)=>(e[t]=k[t].localDependencies,e)),{}),config:Object.keys(k).reduce(((e,t)=>(e[t]=k[t].moduleInfo,e)),{})}},params:{attachment:f.Uri.file(C)}});try{const e=c.dirname(C);l.removeSync(e),E.forEach((e=>{l.removeSync(e)}))}catch(e){}if(!_.service||1001!==_.service.code)return u.appendLine({level:"error",line:w(_.service.description)});const{ticket:I}=_.service.body;return I?(await u.appendLine({level:"info",line:w(`公共模块${S}被云端云函数依赖，正在更新相关云端云函数...`)}),new Promise(((e,t)=>{const n=setInterval((async()=>{const i=await f.http.request({url:"https://ide.liuyingyong.cn/serverless/commonModule/update-result",method:"post",connectionTimeout:1e4,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{ticket:I}}});i.service&&1001===i.service.code?"OK"===i.service.body.status?(clearInterval(n),await u.appendLine({level:"success",line:w("更新云端云函数成功")}),await u.appendLine({level:"success",line:w(`公共模块${S}上传成功`)}),e()):"FAILED"===i.service.body.status&&(clearInterval(n),await u.appendLine({level:"error",line:w(`公共模块${S}上传失败`)}),t()):(clearInterval(n),await u.appendLine({level:"error",line:w(`公共模块${S}上传失败; 原因: ${i.service.description??i.service.code}`)}),t())}),5e3)}))):await u.appendLine({level:"success",line:w(`公共模块${S}上传成功`)})}function y(e){const t=a();return new Promise(((n,i)=>{const o=d(process.execPath,[t,"install","--no-package-lock","--omit=dev"],{stdio:["pipe","pipe","pipe"],cwd:e});let r=Buffer.alloc(0);o.stderr.on("data",(e=>{r=Buffer.concat([r,e])})),o.on("exit",(()=>{0===o.exitCode?n():i(new Error(`npm进程退出码：${o.exitCode}\n详细错误信息如下：\n${r.toString()}`))}))}))}async function v(e){const{workspaceFolder:t}=e,{provider:n}=await r(e),i=[c.resolve(t.uri.fsPath,`uniCloud-${n}`,"cloudfunctions","common")],o=c.resolve(t.uri.fsPath,h(t.uri.fsPath)?"src":"","uni_modules");let s=[];l.existsSync(o)&&(s=l.readdirSync(o).map((e=>c.resolve(o,e))));for(const e of s){const t=c.resolve(e,"uniCloud","cloudfunctions","common");l.existsSync(t)&&i.push(t)}const a=[];for(const e of i){if(!l.existsSync(e))continue;const t=l.readdirSync(e);for(const n of t){const t=c.resolve(e,n);l.statSync(t).isDirectory()&&a.push(t)}}return a}e.exports={async uploadCommonModule(e){const n=await o(e);t().run(n,(()=>{g(e)}))},rawUploadAllCommonModule:async function(e){const{workspaceFolder:t}=e,{provider:n,spaceId:i}=await r(e),o=await v(e),s=o.map((e=>c.basename(e))),a=await f.http.request({url:"https://ide.liuyingyong.cn/serverless/commonModule/list",method:"post",connectionTimeout:1e4,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:n,spaceId:i,appid:t.appid}}});if(a.service&&1001===a.service.code){const{modules:e}=a.service.body,t=[];for(const n of e)s.includes(n.name)&&t.push(n);if(t&&t.length>0){let e=t.map((e=>e.name));e.length>5&&(e=e.slice(0,5).concat(`...还有${e.length-5}个公共模块未显示`)),e=e.join("\n");let n=await f.window.showMessageBox2({type:"question",title:"云端已存在公共模块，是否替换?",text:e,buttons:["替换","跳过","终止上传"]});if(null===n&&(n={button:"替换"}),"跳过"===n.button)return;if("终止上传"===n.button)throw new Error("终止上传")}}await g({...e,fsPaths:o})},getCommonModuleDirs:v}}(Vd);const{getCommonContext:zd,getBindSpace:Gd,getUniModuleId:Kd}=Rt,{createContext:Zd,getOutputViewWithContext:Yd,getContext:Xd}=Ud,Qd=jn,ep=E.default,tp=F.default,np=C.default,ip=O.default,op=ep.resolve(tp.tmpdir(),"hx-unicloud-plugin");async function rp(e){const{fsPath:t,workspaceFolder:n}=e;if(!n.appid)return np.window.showMessageBox({type:"warning",title:"",text:"缺少appid，请在manifest.json中设置appid",buttons:["确定"]});const i=Xd(),o=Yd(),{provider:r,providerName:s,spaceId:a,spaceName:c}=i.currentSpace,l=e=>`[${s}:${c}] ${e}`,u=ep.basename(t),d=Kd(t),p=new Qd,f=ep.resolve(op,"clientDB-actions.zip");p.addLocalFile(t),p.writeZip(f);const h=await np.http.request({url:"https://ide.liuyingyong.cn/serverless/clientdb/upload-action-multi",method:"post",connectionTimeout:1e4,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:r,spaceId:a,appid:n.appid,uniModuleId:d}},params:{attachment:np.Uri.file(f)}});if(o.show(),!h.service||1001!==h.service.code)return o.appendLine({level:"error",line:l(h.service.description)});await o.appendLine({level:"success",line:l(`${d?`(${d})`:""}uni-clientDB-actions(${u})上传完成`)})}async function sp(e){const t=await async function(e){const{workspaceFolder:t}=e,{provider:n}=await Gd(e),i=[ep.resolve(t.uri.fsPath,`uniCloud-${n}`,"cloudfunctions","uni-clientDB-actions")],o=ep.resolve(t.uri.fsPath,"uni_modules"),r=ip.readdirSync(o).map((e=>ep.resolve(o,e)));for(const e of r){const t=ep.resolve(e,"uniCloud","cloudfunctions","uni-clientDB-actions");ip.existsSync(t)&&i.push(t)}const s=[];for(const e of i){if(!ip.existsSync(e))continue;const t=ip.readdirSync(e);for(const n of t){const t=ep.resolve(e,n);ip.statSync(t).isFile()&&n.endsWith(".js")&&s.push({filePath:t,fileName:n})}}return s}(e);for(const n of t)await rp({...e,fsPath:n.filePath})}var ap={async uploadUniClientDBAction(e){const t=await zd(e);Zd().run(t,(()=>{rp(e)}))},async uploadAllUniClientDBAction(e){const t=await zd(e);Zd().run(t,(()=>{sp(e)}))},rawUploadAllUniClientDBAction:sp};const{createContext:cp,getOutputViewWithContext:lp,getContext:up}=Ud,{getCommonContext:dp,getBindSpace:pp,getUniModuleId:fp}=Rt,hp=E.default,mp=ta,gp=F.default,yp=jn,vp=C.default,wp=hp.resolve(gp.tmpdir(),"hx-unicloud-plugin");async function xp(e){const{fsPath:t,workspaceFolder:n}=e;if(!n.appid)return vp.window.showMessageBox({type:"warning",title:"",text:"缺少appid，请在manifest.json中设置appid",buttons:["确定"]});const i=hp.basename(t),o=up(),r=lp(),{provider:s,providerName:a,spaceId:c,spaceName:l}=o.currentSpace,u=e=>`[${a}:${l}] ${e}`;await r.appendLine({level:"info",line:u(`正在下载公共模块${i}...`)});const d=fp(t),p=await vp.http.request({url:"https://ide.liuyingyong.cn/serverless/commonModule/download",method:"post",connectionTimeout:1e4,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:s,spaceId:c,appid:n.appid,moduleName:i,uniModuleId:d}}});if(!p.service||1001!==p.service.code)return r.appendLine({level:"error",line:u(p.service.description)});const{url:f}=p.service.body;if(!f)return r.appendLine({level:"error",line:u(`公共模块下载失败，请检查云端是否存在${i}公共模块`)});const h=await vp.http.request({url:f,downloadFile:hp.resolve(wp,i+".zip")});if(!h.service||1001!==h.service.code)return r.appendLine({level:"error",line:u(h.service.description)});const{downloadFile:m}=h;new yp(m).extractAllTo(t,!0),mp.unlinkSync(m),await r.appendLine({level:"success",line:u(`公共模块${i}下载完成`)})}var bp={async downloadCommonModule(e){const t=await dp(e);cp().run(t,(()=>{xp(e)}))},rawDownloadCommonModule:xp};const{getCommonContext:Sp,getBindSpace:kp,getUniModuleId:Ep}=Rt,{createContext:_p,getOutputViewWithContext:Cp,getContext:Ip}=Ud,jp=E.default,Op=C.default,Pp=ta;async function Lp(e){const{workspaceFolder:t}=e,n=Ip(),i=Cp(),{provider:o,providerName:r,spaceId:s,spaceName:a}=n.currentSpace,c=e=>`[${r}:${a}] ${e}`;await i.appendLine({level:"info",line:c("正在下载uni-clientDB-actions...")});const l=await Op.http.request({url:"https://ide.liuyingyong.cn/serverless/clientdb/action-list",method:"post",connectionTimeout:1e4,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:o,spaceId:s,appid:t.appid}}});if(!l.service||1001!==l.service.code)return i.appendLine({level:"error",line:c(l.service.description)});const{list:u}=l.service.body;for(const e of u){let n=jp.resolve(t.uri.fsPath,`uniCloud-${o}`,"cloudfunctions","uni-clientDB-actions");e.uni_modules_id&&(n=jp.resolve(t.uri.fsPath,"uni_modules",e.uni_modules_id,"uniCloud","cloudfunctions","uni-clientDB-actions")),Pp.ensureDirSync(n),Pp.writeFileSync(jp.join(n,e.name+".js"),e.content||"","utf-8")}await i.appendLine({level:"success",line:c("uni-clientDB-actions下载完成")})}var Np={async downloadAllUniClientDBAction(e){const t=await Sp(e);_p().run(t,(()=>{Lp(e)}))},rawDownloadAllUniClientDBAction:Lp};!function(e){const t=C.default,n=O.default,i=E.default,o=jn,r=Md,s=Rt,a=F.default,{getCommonContext:c,getBindSpace:l}=Rt,{createContext:u,getOutputViewWithContext:d}=Ud,{rawUploadAllCommonModule:p,getCommonModuleDirs:f}=Vd.exports,{rawUploadAllUniClientDBAction:h}=ap,{rawDownloadCommonModule:m}=bp,{rawDownloadAllUniClientDBAction:g}=Np,{isUniAppCli:y}=Mc;async function v(e){const{workspaceFolder:r,fsPath:c,isReplace:u}=e,d=i.basename(c);if(!r.appid)return t.window.showMessageBox({type:"warning",title:"",text:"缺少appid，请在manifest.json中设置appid",buttons:["确定"]});let p="替换";if(n.existsSync(c)&&n.readdirSync(c).length&&!u&&(p=await t.window.showMessageBox({type:"question",title:"云函数下载",text:`云函数${d}已经存在内容，你是要用即将下载得云函数替换它吗?`,buttons:["替换","取消"]})),"取消"===p)return;const{provider:f,spaceId:h,providerName:m,spaceName:g}=await l(e),y=e=>`[${m}:${g}] ${e}`;let v,w=t.window.createOutputView({id:`${r.id}-unicloud`,title:`[${r.name}] - unicloud控制台`});w.show(),w.appendLine({level:"info",line:y(`正在下载云函数${d}...`)});try{v=await t.http.request({url:"https://ide.liuyingyong.cn/serverless/function/download",method:"post",connectionTimeout:1e4,readTimeout:5e3,serviceOptions:{serviceRequest:!0,body:{provider:f,spaceId:h,appid:r.appid,functionName:d,uniModuleId:s.getUniModuleId(c)}}})}catch(e){return console.error(e),w.appendLine({level:"error",line:y(`下载云函数[${d}]失败：${e.message}`)})}if(v.service&&1001!==v.service.code)return w.appendLine({level:"error",line:y(`下载云函数[${d}]失败：${v.service.description}`)});const x=v.service.body.url,b=i.join(a.tmpdir(),r.name);if(!x)return w.appendLine({level:"error",line:y(`下载云函数[${d}]失败：下载地址无效`)});const S=await t.http.request({url:x,downloadFile:i.join(b,d+".zip")});if(S.service&&1001===S.service.code){const{downloadFile:t}=S;return new o(t).extractAllTo(e.fsPath,!0),n.unlink(t,(()=>{})),w.appendLine({level:"success",line:y(`下载云函数[${d}]完成`)})}w.appendLine({level:"error",line:y(`下载云函数[${d}]失败：${S.service.description}`)})}async function w(e){const{workspaceFolder:t}=e,{provider:o}=await l(e),r=[i.resolve(t.uri.fsPath,`uniCloud-${o}`,"cloudfunctions")],s=i.resolve(t.uri.fsPath,y(t.uri.fsPath)?"src":"","uni_modules"),a=n.readdirSync(s).map((e=>i.resolve(s,e)));for(const e of a){const t=i.resolve(e,"uniCloud","cloudfunctions");n.existsSync(t)&&r.push(t)}const c=[];for(const e of r){if(!n.existsSync(e))continue;const t=n.readdirSync(e);for(const o of t){if(["uni-clientDB-actions","common"].includes(o))continue;const t=i.resolve(e,o);n.statSync(t).isDirectory()&&c.push(t)}}return c}async function x(e){const{workspaceFolder:n}=e;if(!n.appid)return t.window.showMessageBox({type:"warning",title:"",text:"缺少appid，请在manifest.json中设置appid",buttons:["确定"]});const o=d();let s,a;o.show();try{const t=await l(e);s=t.providerName,a=t.spaceName}catch(e){return o.appendLine({level:"error",line:e.message})}await p(e),await async function(e){const{workspaceFolder:n}=e;if(!n.appid)return t.window.showMessageBox({type:"warning",title:"",text:"缺少appid，请在manifest.json中设置appid",buttons:["确定"]});const{provider:o,spaceId:s}=await l(e),a=await w(e),c=a.map((e=>i.basename(e))),u=await t.http.request({url:"https://ide.liuyingyong.cn/serverless/function/list",method:"post",connectionTimeout:1e4,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:o,spaceId:s,appid:n.appid}}}),d=[];if(u.service&&1001===u.service.code){const{functions:e}=u.service.body;for(const t of e)c.includes(t.name)&&d.push(t.name)}let p={button:"",checked:!1},f=!0;for(const e of a){const o=i.basename(e),s=d.includes(o);if(s&&!p.checked&&(p=await t.window.showMessageBox2({type:"question",title:`云端已存在云函数${o}，是否替换?`,text:"",buttons:["替换(&R)","跳过(&S)","停止(&T)"],checkBoxText:"全部应用"})),null===p&&(p={button:"替换(&R)",checked:!1}),"跳过(&S)"===p.button&&s)continue;if("停止(&T)"===p.button)throw new Error("终止上传");const a="win32"===process.platform?e.replace(/\\\\/g,"/"):e;await r({workspaceFolder:n,cloudPath:a,showCliTip:f}),f=!1}}(e),await h(e),o.appendLine({level:"success",line:`[${s}:${a}] 上传完成`})}e.exports={uploadFunction:async function(e){const{workspaceFolder:t,cloudPath:n}=e;await r({workspaceFolder:t,cloudPath:n})},uploadAndExecFunction:async function(e){const{workspaceFolder:t,cloudPath:n}=e;await r({workspaceFolder:t,cloudPath:n,isRun:!0})},downloadFunction:v,async uploadAllCloudFunction(e){const t=await c(e);return u().run(t,(()=>x(e)))},async downloadAllCloudFunction(e){const n=await c(e);u().run(n,(()=>{!async function(e){const{workspaceFolder:n}=e;if(!n.appid)return t.window.showMessageBox({type:"warning",title:"",text:"缺少appid，请在manifest.json中设置appid",buttons:["确定"]});const o=d();let r;try{r=await l(e)}catch(e){return o.appendLine({level:"error",line:e.message})}const{provider:s,providerName:a,spaceId:c,spaceName:u}=r,p=e=>`[${a}:${u}] ${e}`,h=(await w(e)).map((e=>i.basename(e))),x=await t.http.request({url:"https://ide.liuyingyong.cn/serverless/function/list",method:"post",connectionTimeout:1e4,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:s,spaceId:c,appid:n.appid}}});x.service&&1001===x.service.code||await o.appendLine({level:"error",line:p(x.service.description)});const{functions:b}=x.service.body;let S=[],E=[];for(const e of b)E.push(e),h.includes(e.name)&&S.push(e.name);if(S.length){let e=S.join("\n");S.length>5&&(e=S.slice(0,5).concat(`...还有${S.length-5}个公共模块未显示`).join("\n"));let n=await t.window.showMessageBox2({type:"question",title:"云函数目录下存在以下云函数，是否替换?",text:e,buttons:["取消导入","跳过已有","确认覆盖"]});if("取消导入"===n.button)return o.appendLine({level:"info",line:p("取消导入")});"跳过已有"===n.button&&(E=E.filter((e=>!S.includes(e.name))))}for(const t of E){const o=t.uni_modules_id?i.resolve(n.uri.fsPath,y(n.uri.fsPath)?"src":"","uni_modules",t.uni_modules_id,"uniCloud","cloudfunctions",t.name):i.resolve(n.uri.fsPath,`uniCloud-${s}`,"cloudfunctions",t.name);await v({...e,fsPath:o,isReplace:!0})}const C=(await f(e)).map((e=>i.basename(e))),k=await t.http.request({url:"https://ide.liuyingyong.cn/serverless/commonModule/list",method:"post",connectionTimeout:1e4,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:s,spaceId:c,appid:n.appid}}});k.service&&1001===k.service.code||await o.appendLine({level:"error",line:p(k.service.description)});const{modules:_}=k.service.body;let I=[],j=[];for(const e of _)j.push(e),C.includes(e.name)&&I.push(e.name);if(I.length){let e=I.join("\n");I.length>5&&(e=I.slice(0,5).concat(`...还有${I.length-5}个公共模块未显示`).join("\n"));let n=await t.window.showMessageBox2({type:"question",title:"公共模块目录下存在以下公共模块，是否替换?",text:e,buttons:["取消导入","跳过已有","确认覆盖"]});if("取消导入"===n.button)return o.appendLine({level:"info",line:p("取消导入")});"跳过已有"===n.button&&(j=j.filter((e=>!I.includes(e.name))))}for(const t of j){const o=t.uni_modules_id?i.resolve(n.uri.fsPath,y(n.uri.fsPath)?"src":"","uni_modules",t.uni_modules_id,"uniCloud","cloudfunctions","common",t.name):i.resolve(n.uri.fsPath,`uniCloud-${s}`,"cloudfunctions","common",t.name);await m({...e,fsPath:o})}await g(e),await o.appendLine({level:"success",line:p("下载完成")})}(e)}))}}}(Ld);var Fp={};const Tp=C.default,Dp=W.default,$p=C.default;var Rp=async function(){const e=$p.extensions.getExtension("unicloud_proxy");if(!e)throw await $p.window.showMessageBox({type:"warning",title:"",text:"缺少unicloud_proxy插件，请先安装unicloud_proxy",buttons:["我知道了"],defaultButton:0}),new Error("缺少unicloud_proxy插件，请先安装unicloud_proxy");return e.fileEventEmitter};const Ap=C.default,Bp=E.default,Mp=ta,Up=function(e){const t=Dp.format({protocol:"https",hostname:"dev.dcloud.net.cn",pathname:"/auth/dcloud/callback",search:new Dp.URLSearchParams({return_url:encodeURIComponent(e)}).toString()});return Dp.format({protocol:"https",hostname:"account.dcloud.net.cn",pathname:"/oauth2/login",search:`email=\${email}&deviceId=\${deviceId}&sign=\${askSign}&timestamp=\${timestamp}&source=hbuilder.win32&client_id=DCLOUD_DEV&sourceversion=${Tp.env.appVersion}&redirectURL=${encodeURIComponent(t)}`})},{getBindSpace:qp,getCommonContext:Wp,genUniCloudProjectAliasName:Jp}=Rt,{createContext:Hp}=Ud,Vp=Rp;Ap.vue.defineComponent("relatedSpaceDialog",Bp.join(process.env.UNICLOUD_DEBUGGER_PATH,"manager/dialog-components/related-service-space.vue")),Fp.bindSpace=async function({uniCloudDirPath:e,workspaceFolder:t,space:n}){const{email:i}=await Ap.authorize.requestUserInfo(),o=await Vp(),r=await Ap.workspace.getConfiguration("",t),s=r.get("uniCloud")||{},a=s[i]||{},c=a[n.provider]||{},l=await Ap.http.request({url:"https://ide.liuyingyong.cn/serverless/space/debug-token",method:"post",connectionTimeout:1e4,serviceOptions:{serviceRequest:!0,body:{provider:n.provider,spaceId:n.spaceId,appid:t.appid,isTmp:!1}}});if(l.service&&1001!==l.service.code)throw await Ap.window.showMessageBox({type:"warning",title:"",text:l.service.description,buttons:["确定"],defaultButton:0}),new Error(l.service.description);const{AK:u,SK:d,AppId:p,EndPoint:f,ClientSecret:h}=l.service.body.Credentials;let m;switch(n.provider){case"aliyun":m={apiEndpoint:f,clientSecret:h};break;case"alipay":m={accessKey:u,secretKey:d,apiEndpoint:f,spaceAppId:p};break;default:m={}}delete c.related,c.selected=n.spaceId,c.spaces||(c.spaces=[]),c.spaces&&!c.spaces.find((e=>e.spaceid===n.spaceId))&&c.spaces.push({spaceid:n.spaceId,name:n.spaceName,...m}),c.allSpaces||(c.allSpaces=[]),c.allSpaces&&!c.allSpaces.find((e=>e.id===n.spaceId))&&c.allSpaces.push({id:n.spaceId,owner:n.isActor}),a[n.provider]=c,s[i]=a,await r.update("uniCloud",s);const g=Jp(n.provider,n.spaceName);o.fire(e,{aliasName:g,tooltip:`uniCloud-${g}`})},Fp.setUniCloudRelatedProjectPaths=async function(){const e=await async function(){const{email:e}=await Ap.authorize.requestUserInfo(),t=await Ap.workspace.getWorkspaceFolders(),n=[];for(const i of t)if("UniApp_Vue"===i.nature){const t=((await Ap.workspace.getConfiguration("",i)).get("uniCloud")||{})[e]||{};for(const e in t){const o=t[e];o&&o.related&&o.related.projectid&&n.push(i.uri.fsPath)}}return n}();Ap.commands.executeCommand("setContext",["uniCloudRelatedProjectPaths",e.join(",")])},Fp.relatedServiceSpace=async function(e){const{fsPath:t,workspaceFolder:n}=e;if(!n.appid)return Ap.window.showMessageBox({type:"warning",title:"",text:"缺少appid，请在manifest.json中设置appid",buttons:["确定"]});if(!await Ap.http.checkLogin())return;const{email:i,isLogin:o}=await Ap.authorize.requestUserInfo();if(!o)return;const r=await Vp(),s=t.match(/uniCloud-(tcb|aliyun|alipay)/),a=await async function(e){const{email:t}=await Ap.authorize.requestUserInfo(),n=await Ap.workspace.getWorkspaceFolders(),i=[];for(var o of n)if("UniApp_Vue"===o.nature){const n=(((await Ap.workspace.getConfiguration("",o)).get("uniCloud")||{})[t]||{})[e]||{};let r={id:o.id,name:o.name};if(n.selected){const e=n.spaces.find((e=>e.spaceid===n.selected));e&&(r.space={id:e.spaceid,name:e.name})}i.push(r)}return i}(s[1]),c=await Ap.workspace.getConfiguration("",e.workspaceFolder),l=c.get("uniCloud")||{},u=l[i]||{},d=u[s[1]]||{};let p,f="",h="",m=await Ap.window.showFormDialog({title:"关联服务空间或项目",submitButtonText:"关联(&L)",cancelButtonText:"取消(&C)",width:550,height:400,formItems:[{type:"vue:relatedSpaceDialog",name:"relatedSpace",value:{workspaceFolder:e.workspaceFolder,provider:s[1],projects:a,providerConfig:d}}],onChanged:function(e,t){"relatedSpace"===e&&(t.isLoading?this.showLoading({maskAt:"relatedSpace"}):this.hideLoading())},validate:async function(t){const{relatedSpace:n}=t,{projects:i,spaces:o,currentRadio:r}=n,a="project"===r;if(a){const t=i.find((e=>e.selected));if(!t)return!0;if(t.name===e.workspaceFolder.name)return Ap.window.showMessageBox({type:"warning",title:"",text:"项目不能关联自身，请选择其他项目",buttons:["我知道了"],defaultButton:0});if(!t.space)return Ap.window.showMessageBox({type:"warning",title:"",text:"您当前要关联的项目没有相应的运行环境，检查是否已关联云服务空间，如没有云服务空间请先创建相应的云开发环境（不同的云服务空间之间无法相互关联）。",buttons:["我知道了"],defaultButton:0})}if(a){const e=i.find((e=>e.selected));e&&(f=e.space.id,h=s[1])}else{const t=o.find((e=>e.selected));if(t&&(f=t.spaceId,h=t.provider,t.provider!==s[1])){const n=Bp.resolve(e.workspaceFolder.uri.fsPath,`uniCloud-${t.provider}`);if(Mp.pathExistsSync(n))return Ap.window.showMessageBox({type:"warning",title:"",text:`${t.providerCNName}服务空间已存在，不允许关联`,buttons:["确定"]});const{hasRelatedProject:i,relatedProjects:o}=await async function(e,t){const{email:n}=await Ap.authorize.requestUserInfo(),i=await Ap.workspace.getWorkspaceFolders();let o=[];for(const r of i){const i=(((await Ap.workspace.getConfiguration("",r)).get("uniCloud")||{})[n]||{})[t]||{};i.related&&i.related.projectid===e.id&&o.push(r)}return{hasRelatedProject:o.length>0,relatedProjects:o}}(e.workspaceFolder,s[1]);if(i)return Ap.window.showMessageBox({type:"warning",title:"",text:`项目[${o.map((e=>e.name)).join(",")}]绑定了当前服务空间，不允许切换云厂商，请先解除绑定后尝试`,buttons:["确定"]});if("取消"===await Ap.window.showMessageBox({type:"warning",title:"",text:`即将关联的是${t.providerCNName}服务空间，需注意不同云厂商之前兼容性问题。`,buttons:["确认切换","取消"]}))return!1}}const c=await Ap.http.request({url:"https://ide.liuyingyong.cn/serverless/space/debug-token",method:"post",connectionTimeout:1e4,serviceOptions:{serviceRequest:!0,body:{provider:h,spaceId:f,appid:e.workspaceFolder.appid,isTmp:!1}}});if(c.service&&1001!==c.service.code)return Ap.window.showMessageBox({type:"warning",title:"",text:c.service.description||"关联服务空间失败",buttons:["确定"],defaultButton:0});if(p=c.service.body.Credentials,h!==s[1])try{Mp.renameSync(Bp.resolve(e.workspaceFolder.uri.fsPath,`uniCloud-${s[1]}`),Bp.resolve(e.workspaceFolder.uri.fsPath,`uniCloud-${h}`))}catch(e){return console.error(e),Ap.window.showMessageBox({type:"error",title:"",text:"EPERM"===e.code?"切换云服务商失败，可能uniCloud服务正在运行，请尝试关闭uniCloud或者重启HBuilderX后重试":e.message||"切换云服务商失败",buttons:["确定"]})}return!0}});const{relatedSpace:g}=m,{spaces:y,projects:v,currentRadio:w}=g,x="project"===w,{AK:b,SK:S,AppId:E,EndPoint:C,ClientSecret:k}=p;let _,I;switch(h){case"aliyun":_={apiEndpoint:C,clientSecret:k};break;case"alipay":_={accessKey:b,secretKey:S,apiEndpoint:C,spaceAppId:E};break;default:_={}}if(x){const e=v.find((e=>e.selected));d.related={projectid:e.id}}else delete d.related;d.selected=f,d.spaces=y.map((e=>{let t={spaceid:e.spaceId,name:e.spaceName};return e.spaceId===f&&(t=Object.assign(t,_)),t})),d.allSpaces=y.map((e=>({id:e.spaceId,owner:e.isActor}))),u[h]=d,l[i]=u,await c.update("uniCloud",l),I=x?`已关联项目${v.find((e=>e.selected)).name}`:`${y.find((e=>e.selected)).spaceName}`,I=Jp(h,I),r.fire(e.fsPath,{aliasName:I,tooltip:`uniCloud-${I}`,collapsable:x,preventDefaultContextMenu:x,customMenuContext:x?"explorer/unicloud.related.project":"",corners:x?[{position:"bottomleft",icon:"hxtheme://explorer/relate_project.png",size:[10,10],margin:[0,0,0,-2]}]:[]})},Fp.viewRelatedProjectServiceSpace=async function(e){const{fsPath:t,workspaceFolder:n}=e,{email:i,isLogin:o}=await Ap.authorize.requestUserInfo();if(!o)return;const r=await Ap.workspace.getConfiguration("",n),[,s]=t.match(/uniCloud-(tcb|aliyun|alipay)/)||[],a=((r.get("uniCloud")||{})[i]||{})[s]||{};if(!a.related)return Ap.window.showMessageBox({type:"warning",title:"",text:"uniCloud未关联项目，无法查看关联项目的云服务空间",buttons:["确定"]});const c=(await Ap.workspace.getWorkspaceFolders()).find((e=>e.id===a.related.projectid));if(!c)return Ap.window.showMessageBox({type:"warning",title:"",text:"关联项目不在工作区，无法查看",buttons:["确定"]});Ap.window.revealFile(Bp.resolve(c.uri.fsPath,`uniCloud-${s}`))},Fp.unBindRelatedProjectServiceSpace=async function(e){const{fsPath:t,workspaceFolder:n}=e,{email:i,isLogin:o}=await Ap.authorize.requestUserInfo();if(!o)return;const r=await Vp(),s=await Ap.workspace.getConfiguration("",n),[,a]=t.match(/uniCloud-(tcb|aliyun|alipay)/)||[],c=s.get("uniCloud")||{},l=c[i]||{},u=l[a]||{};if(!u.related)return;delete u.related;const d=u.spaces.find((e=>e.spaceid===u.selected));d||delete u.selected,l[a]=u,c[i]=l,await s.update("uniCloud",c);const p=Jp(a,d?d.name:"未关联服务空间");r.fire(t,{aliasName:p,tooltip:`uniCloud-${p}`,collapsable:!1,preventDefaultContextMenu:!1,customMenuContext:"",corners:[]})},Fp.moveServiceSpaceToRelatedProject=async function(e){const{fsPath:t,workspaceFolder:n}=e,{email:i,isLogin:o}=await Ap.authorize.requestUserInfo();if(!o)return;const r=await Ap.workspace.getWorkspaceFolders(),[,s]=t.match(/uniCloud-(tcb|aliyun|alipay)/)||[],a=(((await Ap.workspace.getConfiguration("",n)).get("uniCloud")||{})[i]||{})[s]||{},c=r.find((e=>e.id===a?.related?.projectid));if(!c)return Ap.window.showMessageBox({type:"warning",title:"",text:"关联项目未在工作区中打开，请将项目在工作区内打开后执行此操作",buttons:["确定"]});await Ap.workspace.copyFileWithPrompt({src:t,dest:c.uri.fsPath,defaction:"compare",showcomparebutton:!0,filter:()=>!1,errorHandler:()=>!1})},Fp.openUniCloudWebConsole=async e=>{const t=await Wp(e);Hp().run(t,(()=>{!async function(e){const{workspaceFolder:t}=e;if(!t.appid)return Ap.window.showMessageBox({type:"warning",title:"",text:"缺少appid，请在manifest.json中设置appid",buttons:["确定"]});try{let n;try{n=await qp(e)}catch(e){return Ap.window.showMessageBox({type:"warning",title:"打开控制台失败",text:e.message,buttons:["确定"]})}const{provider:i,spaceId:o}=n;Ap.env.openExternal(Up(`https://dev.dcloud.net.cn/unicloud/auth?action=openConsole&appid=${t.appid}&provider=${i}&spaceId=${o}`))}catch(e){await Ap.window.showMessageBox({type:"warning",title:"打开控制台失败",text:e.message,buttons:["确定"]})}}(e)}))};const zp=C.default,Gp=O.default,Kp=E.default,{initDB:Zp,uploadSchemaJS:Yp,uploadAllDBSchemaResource:Xp}=Pd,{uploadAllCloudFunction:Qp}=Ld.exports,{bindSpace:ef}=Fp,tf=Rp;var nf={showInitUniCloudWizard:async function(e){const{fsPath:t,workspaceFolder:n}=e,i=t.match(/uniCloud-(tcb|aliyun|alipay)/)?.[1];if(!i)return zp.window.showErrorMessage("请在uniCloud项目中执行初始化");zp.vue.defineComponent("initUniCloudSpaceWizard",Kp.join(process.env.UNICLOUD_DEBUGGER_PATH,"manager/dialog-components/init-unicloud-space-wizard.vue")),zp.window.showFormDialog({width:640,height:450,hideFooter:!0,hideSubTitle:!0,hideErrorLabel:!0,hideFooterSeparator:!0,title:"",formItems:[{type:"vue:initUniCloudSpaceWizard",name:"initUniCloudSpaceWizard",value:{provider:i,workspaceFolder:n},event:{startDeploy(e){!async function(e){const{fsPath:t,workspaceFolder:n,space:i,deployFunctions:o,initDatabase:r}=e;if(await ef({uniCloudDirPath:t,workspaceFolder:n,space:i}),o&&await Qp({fsPath:t,workspaceFolder:n}),r){const e=Kp.join(n.uri.fsPath,`uniCloud-${i.provider}`,"database"),t=Kp.join(e,"db_init.json");Gp.existsSync(t)?await Zp.oldInitDBTransfer({fsPath:t,workspaceFolder:n,showDeprecatedMessage:!1}):await Zp.initDB({fsPath:e,workspaceFolder:n})}}({...e,fsPath:t,workspaceFolder:n})}}}]})},initDeploy:async function(e){const{appid:t,space:n={},functions:i=!1,initDB:o=!1,initscheme:r=!1,workspaceFolder:s}=e,a=await tf(),c=zp.window.createOutputView({id:`${s.id}-unicloud`,title:`[${s.name}] - unicloud控制台`});c.show(),s.appid||(s.appid=t);const l=Kp.join(s.uri.fsPath,`uniCloud-${n.provider}`,"database"),u=Kp.join(l,"db_init.json"),d=Gp.existsSync(u);let p=!o&&r||!d;if(a.refreshUniCloudProjectAlias(),i&&await function(e){return new Promise((t=>zp.unicloud.deployUploadFunctionResources(e,(()=>t()))))}(e),o&&(Gp.existsSync(u)?await zp.unicloud.dbInit(e):await Zp.initDB({fsPath:l,workspaceFolder:s})),!o&&r&&await Xp({fsPath:l,workspaceFolder:s,uploadSchemaJS:!1}),p){const e=function(e,t){const n=Kp.join(t.uri.fsPath,"uni_modules"),i=[e];if(Gp.existsSync(n)&&Gp.statSync(n).isDirectory()){const e=Gp.readdirSync(n);for(const t of e){const e=Kp.join(n,t,"uniCloud","database");Gp.statSync(n).isDirectory()&&Gp.existsSync(e)&&i.push(e)}}return i}(l,s),t=function(e,t){const n=[];for(const i of e){if(!Gp.existsSync(i))continue;const e=Gp.readdirSync(i);for(const o of e){const e=Kp.join(i,o);Gp.statSync(e).isFile()&&t.test(e)&&n.push(e)}}return n}(e,/schema\.ext\.js$/);for(const e of t)await Yp({fsPath:e,workspaceFolder:s},(async(e,t)=>{await c.appendLine({level:t||"",line:e})}))}await c.appendLine({level:"info",line:"初始化完成"})}};const of=C.default,rf=O.default,sf=E.default,af=W.default,cf=H.default;of.vue.defineComponent("uploadPkgPage",sf.join(process.env.UNICLOUD_DEBUGGER_PATH,"manager/dialog-components/upload-pkg.vue"));const lf=new Map;function uf(e){return{title:"选择云服务空间",subtitle:"请选择一个服务空间，选择服务空间后安装包将上传到云存储，\n上传成功后，控制台将会显示安装包的下载地址",formItems:[{type:"vue:uploadPkgPage",name:"uploadPkg",value:{appid:e.appid}}]}}async function df(e,t,{workspaceFolder:n}){const i=sf.extname(e)||"apk";return new Promise(((o,r)=>{/^https?:\/\//.test(e)||(rf.cpSync(e,t),o(t)),cf.get(e,(e=>{301===e.statusCode&&o(df(e.headers.location,t,{workspaceFolder:n})),200!==e.statusCode&&r(new Error(`下载文件失败, statusCode: ${e.statusCode}`));const s=/filename="(.*)"/.exec(e.headers["content-disposition"]||""),a=s?s[1]:n.appid+"_"+Date.now()+"."+i,c=t||`${n.uri.fsPath}/unpackage/cache/${i}/${a}`,l=rf.createWriteStream(c);e.pipe(l),l.on("finish",(()=>o(c)))})).on("error",(e=>r(e)))}))}var pf=async function(e){const{workspaceFolder:t,console:n,pkgLocation:i,localCachePath:o}=e,r=await of.window.showFormDialog({width:430,height:500,cancelButtonText:"取消",submitButtonText:"确定",...uf(t)}),{uploadPkg:s}=r,a=s.spaces.find((e=>e.selected));if(!a)return;const c=of.window.createOutputView({id:n.id,title:n.title});c.show();const l=lf.get(i);let u,d,p;u=l?sf.basename(l):sf.basename(o),await c.appendLine({level:"info",line:`正在准备文件 ${u}...`,channel:"HBuilder"});try{d=await async function(e,t,{workspaceFolder:n}){const i=lf.get(e);if(i&&rf.existsSync(i))return i;const o=await df(e,t,{workspaceFolder:n});return lf.set(e,o),o}(i,o,{workspaceFolder:t})}catch(e){return console.error(e),void await c.appendLine({level:"error",line:e.message,channel:"HBuilder"})}if(!d)return console.error("pkg file not found"),void await c.appendLine({level:"error",line:`文件 ${u} 准备失败`,channel:"HBuilder"});try{p=await async function(e,t,n={}){const{workspaceFolder:i}=n,o=sf.basename(e),r=rf.statSync(e),s=await of.http.request({url:"https://ide.liuyingyong.cn/serverless/file/upload-info",method:"post",connectionTimeout:1e4,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:"aliyun",spaceId:t,appid:i.appid,name:o,size:r.size}}});if(s.service&&1001===s.service.code)return s.service.body;{const e=new Error(s.service.description||"获取上传信息失败");throw e.code=s.service.code,e}}(d,a.spaceId,{workspaceFolder:t})}catch(e){return console.error(e),void await c.appendLine({level:"error",line:e.code?`获取上传信息失败: code: ${e.code}, message: ${e.message}`:e.message,channel:"HBuilder"})}const{SignUrl:f,OssCallbackUrl:h,Id:m}=p;await c.appendLine({level:"info",line:`正在上传文件 ${u}...`,channel:"HBuilder"});try{await async function(e,t,n){return new Promise(((i,o)=>{const r=rf.createReadStream(t),s=af.parse(e),a=cf.request({hostname:s.hostname,path:s.path,method:"PUT",headers:{"Content-Type":"application/octet-stream","x-oss-callback":n}},(e=>{e.on("data",(()=>{})),e.on("end",(()=>{i()}))}));a.on("error",(e=>{o(e)})),r.pipe(a),r.on("end",(()=>{a.end()}))}))}(f,d,Buffer.from(JSON.stringify({callbackUrl:h,callbackBody:JSON.stringify({fileId:m,spaceId:a.spaceId}),callbackBodyType:"application/json"})).toString("base64"))}catch(e){return console.error(e),void await c.appendLine({level:"error",line:`上传文件 ${u} 失败`,channel:"HBuilder"})}const g=await async function(e,t,{workspaceFolder:n}){const i=await of.http.request({url:"https://ide.liuyingyong.cn/serverless/file/temp-url",method:"post",connectionTimeout:1e4,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:"aliyun",spaceId:t,folder:e,appid:n.appid}}});if(i.service&&1001===i.service.code&&i.service.body.url)return i.service.body.url}(m,a.spaceId,{workspaceFolder:t});g?await c.appendLine({level:"success",line:`已成功上传安装包,安装包下载地址: ${g}   推荐使用升级中心，详见：https://uniapp.dcloud.net.cn/uniCloud/upgrade-center`,channel:"HBuilder"}):await c.appendLine({level:"error",line:"获取文件下载地址失败",channel:"HBuilder"})};const ff=C.default,hf=ta,mf=E.default,gf=Rp;var yf={createUniCloudEnvironment:async function(e){const{workspaceFolder:t,provider:n}=e;if(1===hf.readdirSync(t.uri.fsPath).filter((e=>/uniCloud-(tcb|aliyun|alipay)/.test(e))).length){const e=ff.extensions.getExtension("uni_modules");e&&await e.installDeps({fsPath:t.uri.fsPath,deps:["uni-id-common"]})}},preprocessBeforeCreateUniCloudEnvironment:async function(e){const{workspaceFolder:t,provider:n,isCreateProject:i=!0}=e,o=await gf();if(!n)return{code:-1,message:"请选择云服务商后初始化uniCloud环境"};const r=mf.join(t.uri.fsPath,`uniCloud-${n}`);if(hf.existsSync(r))return{code:-1,message:"uniCloud环境已存在"};try{!function(e,t){const n=mf.join(e.uri.fsPath,`uniCloud-${t}`),i=mf.join(e.uri.fsPath,"cloudfunctions"),o=mf.join(e.uri.fsPath,`cloudfunctions-${t}`),r=mf.join(e.uri.fsPath,"uniCloud"),s=mf.join(e.uri.fsPath,"db_init.json");hf.existsSync(i)&&(hf.readdirSync(i).forEach((e=>{hf.moveSync(mf.join(i,e),mf.join(n,"cloudfunctions",e),{overwrite:!0})})),hf.removeSync(i)),hf.existsSync(o)&&(hf.readdirSync(o).forEach((e=>{hf.moveSync(mf.join(o,e),mf.join(n,"cloudfunctions",e),{overwrite:!0})})),hf.removeSync(o)),hf.existsSync(r)&&(hf.readdirSync(r).forEach((e=>{hf.moveSync(mf.join(r,e),mf.join(n,e),{overwrite:!0})})),hf.removeSync(r)),hf.existsSync(s)&&hf.moveSync(s,mf.join(n,"database","db_init.json"),{overwrite:!0})}(t,n),function(e,t,n=!0){const i=mf.join(e.uri.fsPath,`uniCloud-${t}`),o=mf.join(i,"cloudfunctions"),r=mf.join(i,"database");if(n){const n=hf.readdirSync(e.uri.fsPath).filter((e=>/^uniCloud-/.test(e)));if(n.length){const i=n[0];return void hf.renameSync(mf.resolve(e.uri.fsPath,i),mf.resolve(e.uri.fsPath,`uniCloud-${t}`))}}hf.existsSync(i)||hf.mkdirSync(i),hf.existsSync(o)||hf.mkdirSync(o),hf.existsSync(r)||hf.mkdirSync(r)}(t,n,i),function(e,t){const n=mf.resolve(ff.env.appRoot,"plugins","templates","file","jql","default.jql");n&&hf.copySync(n,mf.join(e.uri.fsPath,`uniCloud-${t}`,"database","JQL查询.jql"))}(t,n)}catch(e){return{code:-1,message:e.message}}return o.refreshUniCloudProjectAlias(),{code:0,message:""}}},vf={exports:{}};!function(e){const{getCommonContext:t,getBindSpace:n}=Rt,{createContext:i,getOutputViewWithContext:o}=Ud,r=E.default,s=C.default,a=ta,{isUniAppCli:c}=Mc;e.exports=async function(e){const l=await t(e);i().run(l,(()=>{!async function(e){const{workspaceFolder:t}=e;if(!t.appid)return s.window.showMessageBox({type:"warning",title:"",text:"缺少appid，请在manifest.json中设置appid",buttons:["确定"]});const i=o();let l;try{l=await n(e)}catch(e){return i.show(),i.appendLine({level:"info",line:e.message})}const{provider:u,providerName:d,spaceId:p,spaceName:f}=l,h=e=>`[${d}:${f}] ${e}`;i.show(),await i.appendLine({level:"info",line:h("正在同步公共模块列表...")});const m=await s.http.request({url:"https://ide.liuyingyong.cn/serverless/commonModule/list",method:"post",connectionTimeout:1e4,readTimeout:3e4,serviceOptions:{serviceRequest:!0,body:{provider:u,spaceId:p,appid:t.appid}}});if(m.service&&1001===m.service.code){const{modules:e}=m.service.body;for(const n of e){let e=r.join(t.uri.fsPath,`uniCloud-${u}`,"cloudfunctions","common",n.name);n.uni_modules_id&&(e=r.join(t.uri.fsPath,c(t.uri.fsPath)?"src":"","uni_modules",n.uni_modules_id,"uniCloud","cloudfunctions","common",n.name)),a.existsSync(e)||a.ensureDirSync(e)}}await i.appendLine({level:"success",line:h("公共模块列表同步完成")})}(e)}))}}(vf);var wf={},xf={exports:{}};!function(e){const t=/^[v^~<>=]*?(\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+))?(?:-([\da-z\-]+(?:\.[\da-z\-]+)*))?(?:\+[\da-z\-]+(?:\.[\da-z\-]+)*)?)?)?$/i,n=e=>{if("string"!=typeof e)throw new TypeError("Invalid argument expected string");const n=e.match(t);if(!n)throw new Error(`Invalid argument not valid semver ('${e}' received)`);return n.shift(),n},i=e=>"*"===e||"x"===e||"X"===e,o=e=>{const t=parseInt(e,10);return isNaN(t)?e:t},r=(e,t)=>{if(i(e)||i(t))return 0;const[n,r]=((e,t)=>typeof e!=typeof t?[String(e),String(t)]:[e,t])(o(e),o(t));return n>r?1:n<r?-1:0},s=(e,t)=>{for(let n=0;n<Math.max(e.length,t.length);n++){const i=r(e[n]||"0",t[n]||"0");if(0!==i)return i}return 0},a=(e,t)=>{const i=n(e),o=n(t),r=i.pop(),a=o.pop(),c=s(i,o);return 0!==c?c:r&&a?s(r.split("."),a.split(".")):r||a?r?-1:1:0},c=(e,t,n)=>{d(n);const i=a(e,t);return l[n].includes(i)},l={">":[1],">=":[0,1],"=":[0],"<=":[-1,0],"<":[-1],"!=":[-1,1]},u=Object.keys(l),d=e=>{if("string"!=typeof e)throw new TypeError("Invalid operator type, expected string but got "+typeof e);if(-1===u.indexOf(e))throw new Error(`Invalid operator, expected one of ${u.join("|")}`)},p=(e,t)=>{if((t=t.replace(/([><=]+)\s+/g,"$1")).includes("||"))return t.split("||").some((t=>p(e,t)));if(t.includes(" - ")){const[n,i]=t.split(" - ",2);return p(e,`>=${n} <=${i}`)}if(t.includes(" "))return t.trim().replace(/\s{2,}/g," ").split(" ").every((t=>p(e,t)));const i=t.match(/^([<>=~^]+)/),o=i?i[1]:"=";if("^"!==o&&"~"!==o)return c(e,t,o);const[r,a,l,,u]=n(e),[d,f,h,,m]=n(t),g=[r,a,l],y=[d,null!=f?f:"x",null!=h?h:"x"];if(m){if(!u)return!1;if(0!==s(g,y))return!1;if(-1===s(u.split("."),m.split(".")))return!1}const v=y.findIndex((e=>"0"!==e))+1,w="~"===o?2:v>1?v:1;return 0===s(g.slice(0,w),y.slice(0,w))&&-1!==s(g.slice(w),y.slice(w))};e.compare=c,e.compareVersions=a,e.satisfies=p,e.validate=e=>"string"==typeof e&&/^[v\d]/.test(e)&&t.test(e),e.validateStrict=e=>"string"==typeof e&&/^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(?:-((?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\.(?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\+([0-9a-zA-Z-]+(?:\.[0-9a-zA-Z-]+)*))?$/.test(e)}(xf.exports);const bf=F.default,Sf=O.default,kf=E.default,Ef=C.default,_f=Ka,Cf=jn,{isCliProject:If}=Rt,{compare:jf}=xf.exports,Of=Ef.window.createOutputChannel("uni_modules");async function Pf(e){Ef.vue.defineComponent("importUniCloudPlugin",kf.join(process.env.UNICLOUD_DEBUGGER_PATH,"manager/dialog-components/import-unicloud-plugin.vue"));const t=await async function(){const{email:e}=await Ef.authorize.requestUserInfo(),t=await Ef.workspace.getWorkspaceFolders(),n={tcb:"腾讯云",aliyun:"阿里云",alipay:"支付宝云"};let i=[];for(const o of t){const t=Sf.readdirSync(o.uri.fsPath),r=/^uniCloud-(tcb|aliyun|alipay)$/,s=t.filter((e=>r.test(e))),a=((await Ef.workspace.getConfiguration("",o)).get("uniCloud")||{})[e]||{};for(const e of s){const t=e.match(r)[1],i=a[t];if(i){const e=i.spaces.find((e=>e.spaceid===i.selected));e&&(o[t]={spaceId:e.spaceid,spaceName:e.name,provider:t,providerName:n[t]})}}i.push(o)}return i}(),n=await Ef.window.showFormDialog({width:520,height:450,hideSubTitle:!0,hideErrorLabel:!0,title:"选择一个uni-app项目导入插件",formItems:[{type:"vue:importUniCloudPlugin",name:"importUniCloudPlugin",value:{pluginInfo:e,workspaceFolders:t},event:{}}]}),{selectedProvider:i,workspaceFoldersWithProvider:o}=n.importUniCloudPlugin;return{provider:i,workspaceFolder:o.find((e=>e.selected))}}async function Lf(e,t){const n=require(kf.resolve(e,"package.json")),i=(n&&n.uni_modules&&n.uni_modules.scripts||{})[t];if(i)return function(e,t,n){return new Promise((i=>{setTimeout((()=>{Nf("npm").load((()=>{Ff(kf.basename(e),"开始执行"+t+"脚本"),Ff(kf.basename(e),"> "+n),function(e,t,n,i,o){"function"==typeof i&&(o=i,i=null);const r=Nf("config/lifecycle")(i);("npm-lifecycle",require(kf.resolve(Ef.env.appRoot,"plugins/npm/node_modules/npm/node_modules/","npm-lifecycle")))(e,t,n,r).then(o,o)}({_id:"uni_modules",scripts:{[t]:n}},t,e,{scriptsPrependNodePath:!0},(()=>{Ff(kf.basename(e),t+"脚本执行结束"),i(!0)}))}))}),50)}))}(e,t,i)}function Nf(e){return require(kf.resolve(Ef.env.appRoot,"plugins/npm/node_modules/npm/lib",e))}function Ff(e,t){"string"==typeof t?t=(e?`[${e}] `:"")+Bf(t):t.line=(e?`[${e}] `:"")+Bf(t.line),Of.appendLine(t)}function Tf(e){return Sf.readdirSync(e,{withFileTypes:!0}).filter((e=>e.isDirectory())).map((t=>kf.join(e,t.name)))}function Df(e,t,n,i=[]){n.useCache=!1!==n.useCache,n.deps=!1!==n.deps;const o=n.workspaceFolder?.name||"",r=e.id+"@"+e.version,s=r+".zip",a=kf.resolve(n.output,e.id);let c=kf.resolve(bf.tmpdir(),"uni_modules/cache",e.type||"");if(Sf.existsSync(a))return Promise.resolve();const l=[...i,r],u=kf.resolve(c,s);function d(){return function(e,t){return new Promise(((n,i)=>{if(Sf.existsSync(t))return n(!1);try{new Cf(e).extractAllToAsync(t,!0,!1,(t=>t?(Sf.unlinkSync(e),i(t)):n(!0)))}catch(t){return Sf.unlinkSync(e),i(t)}}))}(u,a).then((async e=>{Af(o,l,"已下载到临时目录"),function(e,t){if(!t||!Object.keys(t).length)return;const n=kf.resolve(e,"package.json");if(!Sf.existsSync(n))return;const i=Sf.readFileSync(n,"utf8");let o={};try{o=JSON.parse(i)}catch(e){}o.uni_modules||(o.uni_modules={}),o.uni_modules.extends=t,Sf.writeFileSync(n,o)}(a,n.extends);try{await function(e,t,n){if(!e)return Promise.resolve();const i=kf.resolve(t,"uniCloud/database"),o=kf.resolve(n,"uniCloud/database");if(!Sf.existsSync(i)&&!Sf.existsSync(o))return Promise.resolve();const r=$f(i),s=$f(o),a=[];s.forEach((e=>{a.push({local:kf.resolve(o,e),server:r.includes(e)?kf.resolve(i,e):""})})),r.forEach((e=>{s.includes(e)||a.push({local:"",server:kf.resolve(i,e)})}));const c=Ef.extensions.getExtension("unicloud");return c&&c.updatedbSchema?c.updatedbSchema({workspaceFolder:e,serverPath:i,updateSchemas:a}):Promise.resolve()}(n.workspaceFolder,a,n.input)}catch(e){console.error("downloadSchemas",e)}if(e&&n.deps)return async function(e,t,n){const i=function(e){try{let t={};try{t=JSON.parse(Sf.readFileSync(kf.resolve(e,"package.json")).toString())}catch(e){}if(t.uni_modules&&t.uni_modules.dependencies&&Array.isArray(t.uni_modules.dependencies))return Array.from(new Set(t.uni_modules.dependencies))}catch(e){}return[]}(e);if(i.length){const o=await Ef.http.request({url:"https://ext.liuyingyong.cn/modules/download-dependencies",method:"post",connectionTimeout:1e4,header:{token:"${user.checked.token}",ideVersion:Ef.env.appVersion},params:{dependencies:i.join(",")}}),r=JSON.parse(o.data);if(r.ret)throw new Error(r.desc);for(let i of r.data)i.downloadUrl&&await Df({id:i.id,version:i.latestVersion,type:i.type},i.downloadUrl,{workspaceFolder:n.workspaceFolder,useCache:n.useCache,input:kf.resolve(e,"..",i.id),output:n.output,deps:n.deps,extends:i.extends||{}},t)}}(a,l,n)}))}if(n.useCache&&Sf.existsSync(u))return d().catch((()=>{throw Af(o,l,{level:"error",line:"解压失败，请重试！"}),"解压失败，请重试！"}));const p=kf.resolve(bf.tmpdir(),"uni_modules/download"),f=kf.resolve(c||p,s);return Ef.http.request({url:t,downloadFile:f}).then((()=>f)).then((()=>d())).catch((e=>{throw Af(o,l,{level:"error",line:"string"==typeof e?e:`下载失败：${Bf(e.error||e.message)}`}),"下载失败"}))}function $f(e){const t=/opendb-(.*).schema.json$/;return Sf.existsSync(e)?Sf.readdirSync(e,{withFileTypes:!0}).filter((e=>e.isFile()&&t.test(e.name))).map((e=>e.name)):[]}function Rf(e){return Array.isArray(e)?e.map((e=>`[${e}]`)).join(""):e}function Af(e,t,n){"string"==typeof n?n=(e?`[${e}]`:"")+`${Rf(t)} `+Bf(n):n.line=(e?`[${e}]`:"")+`${Rf(t)} `+Bf(n.line),Of.appendLine(n)}function Bf(e){return{UserNotLogin:"当前功能需要登录HBuilderX",HostNotFoundError:"网络发生错误，请稍后重试！",OperationCanceledError:"网络发生错误，请稍后重试！",NoPermission:"检测到uni_modules插件代码被篡改，有可能存在安全隐患，解决此问题需要重新安装该插件或者HBuilderX。"}[e]||e}wf.importUniCloudPlugin=async function(e){const{ide_version:t}=e;if(t)try{if(1===jf(t,Ef.env.appVersion))return Ef.window.showMessageBox({type:"warning",title:"升级提示",text:`导入当前插件需要HBuilderX ${t} 以上版本，请先升级。<br>可通过菜单【帮助】-【检查更新】触发升级流程`,buttons:["知道了"]})}catch(e){}const{workspaceFolder:n,provider:i}=await Pf(e);let o=n.uri.fsPath,r=kf.basename(o),s="uni_modules";if(If(n.uri.fsPath)&&(o=kf.resolve(n.uri.fsPath,"src"),s="src/node_modules"),e.vue_version){const t=await function(e,t){const n=kf.resolve(e,"manifest.json");if(!Sf.existsSync(n))return Promise.resolve(!0);const i=_f.parse(Sf.readFileSync(n,"utf8"));if(!i)return Promise.resolve(!0);const o=i.vueVersion||"2";return o==t?Promise.resolve(!0):Ef.window.showMessageBox({type:"warn",title:`即将导入的插件的vue版本是${t}，而项目的vue版本是${o}。不匹配的版本可能导致项目运行异常，是否继续导入。`,text:"",buttons:["继续导入","取消"]}).then((e=>"继续导入"==e))}(o,e.vue_version);if(!t)return}const a=kf.resolve(bf.tmpdir(),"uni_modules/tmp",String(Date.now()),"uni_modules");await async function(e){if(!e.extends)return Promise.resolve(!1);const t=[{plugin_id:e.id,version:e.version}],n=await Ef.http.request({url:"https://ext.liuyingyong.cn/modules/create-sn",method:"post",connectionTimeout:1e4,header:{token:"${user.checked.token}",ideVersion:Ef.env.appVersion},params:{param:JSON.stringify(t)}}),i=JSON.parse(n.data);if(i.ret)throw new Error(i.desc);const o=i.data;o.length&&(e.extends=o[0].extends||{})}(e),await Df({id:e.id,version:e.version,type:e.type},e.download_url,{workspaceFolder:n,input:kf.resolve(n.uri.fsPath,s,e.id),output:a,extends:e.extends||{}}),await async function(e,t,n){if(!Ef.workspace.showSubPackgeWindow)return 3;const i="pages_init.json",o=function(e,t){const n=[];return Tf(e).forEach((e=>{const t=kf.join(e,"pages_init.json");if(Sf.existsSync(t))try{const e=JSON.parse(Sf.readFileSync(t,"utf-8"));Array.isArray(e.pages)&&e.pages.length&&n.push(...e.pages)}catch(e){}})),n}(e);if(!o.length)return 3;const r=kf.join(e,i);try{Sf.writeFileSync(r,JSON.stringify({pages:o}))}catch(e){return 3}n&&n.length&&Af((await Ef.workspace.getWorkspaceFolder(t))?.name||"",n,"有 pages_init.json 文件，请处理合并");const s=await Ef.workspace.showSubPackgeWindow({srcPath:e,destPath:t,specialFile:i,pluginName:"schema2code",showWindow:!0});return function(e,t){try{Sf.unlinkSync(kf.join(e,t))}catch(e){}Tf(e).forEach((e=>{const n=kf.join(e,t);if(Sf.existsSync(n))try{Sf.unlinkSync(n)}catch(e){}}))}(e,i),s}(a+"/",n.uri.fsPath,[e.id+"@"+e.version]);const c=a+"/",l=kf.resolve(n.uri.fsPath,"uni_modules"),u=function(e,t){const n=Sf.existsSync(e),i=Sf.existsSync(t);if(!n)return[];const o=Sf.readdirSync(e);if(!i)return o;const r=Sf.readdirSync(t);return o.filter((e=>!r.includes(e)))}(c,l),d=[e.id+"@"+e.version];(function(e,t){if(!Sf.existsSync(t))return!1;const n=Sf.readdirSync(e),i=Sf.readdirSync(t);return!!n.find((e=>i.includes(e)))})(c,l)&&Af(n.name,d,"有同名文件，请处理合并"),function(e,t,n){return Ef.workspace.copyFileWithPrompt({src:Ef.Uri.file(t),dest:Ef.Uri.file(n),defaction:"compare",showcomparebutton:!0}).then((e=>e)).catch((t=>{Af(e,[],{level:"error",line:t.toString()})}))}(n.name,c,l).then((async e=>{if(1===e)Af(n.name,d,{level:"warn",line:"导入被取消"});else if(0===e){for(let e=0;e<u.length;e++){const t=u[e],n=kf.resolve(l,t);await Lf(n,"init")}Af(n.name,d,{level:"success",line:"导入["+r+"/"+s+"]成功"})}}))};const Mf=C.default,{parse:Uf}=V.default,{importUniCloudPlugin:qf}=wf,Wf=C.default,Jf=An,Hf=Gn,Vf=yi,zf=Ci,Gf=li,Kf=Pi,Zf=nf,Yf=pf,Xf=yf,Qf=Ld.exports,{relatedServiceSpace:eh,viewRelatedProjectServiceSpace:th,unBindRelatedProjectServiceSpace:nh,moveServiceSpaceToRelatedProject:ih,openUniCloudWebConsole:oh}=Fp,rh=Vd.exports,sh=bp,ah=ap,ch=Np,lh=vf.exports,uh=function(e){Mf.window.registerUriHandler({handleUri:function(e){const{plugin:t}=Uf(e.query);if(console.log("plugin:",t,e),!t)return;const n=JSON.parse(t);qf(n)}},e)},{importUniCloudPlugin:dh}=wf;async function ph(){let e="安装(&O)",t=await Wf.extensions.existsPlugin("hbuilderx-node-debug");return 0===t.code&&(t.exists||Wf.window.showMessageBox({type:"warning",title:"",text:"当前操作依赖插件【JavaScript 运行调试】，请安装后再试",buttons:[e,"取消(&C)"]}).then((t=>{t==e&&Wf.extensions.installPlugin("hbuilderx-node-debug")})),t.exists)}var fh={activate:function(e){uh(e),Wf.app.registerService("unicloud.uploadAppBuildPkg",Yf);const t=Wf.commands.registerCommand("unicloud.createCloudFunctionObject",(e=>{Jf.createCloudFunction(e)})),n=Wf.commands.registerCommand("unicloud.createCommonModule",(e=>{Hf.createCommon(e)}));Wf.workspace.registerWorkspaceFolderLauncher("unicloud.launcher.runLocalCloudObject",(async function(e){return Vf.runOrDebugLocalCloudObject(e)})),Wf.workspace.registerWorkspaceFolderLauncher("unicloud.launcher.debugLocalCloudObject",(async function(e){if(await ph())return Vf.runOrDebugLocalCloudObject(e)})),Wf.workspace.registerWorkspaceFolderLauncher("unicloud.launcher.runLocalCloudFunction",(async function(e){return zf.runOrDebugLocalCloudFunction(e)})),Wf.workspace.registerWorkspaceFolderLauncher("unicloud.launcher.debugLocalCloudFunction",(async function(e){if(await ph())return zf.runOrDebugLocalCloudFunction(e)}));const i=Wf.commands.registerCommand("unicloud.launcher.uploadAndExec",(e=>{Qf.uploadAndExecFunction({workspaceFolder:e.workspaceFolder,cloudPath:e.fsPath})}));Wf.workspace.registerWorkspaceFolderLauncher("unicloud.launcher.uploadAndExecFunction",(async function(e){Qf.uploadAndExecFunction({workspaceFolder:e.workspaceFolder,cloudPath:e.selectedPath})})),Wf.workspace.registerWorkspaceFolderLauncher("unicloud.launcher.uploadAndExecObject",(async function(e){Qf.uploadAndExecFunction({workspaceFolder:e.workspaceFolder,cloudPath:e.selectedPath})})),Wf.workspace.registerWorkspaceFolderLauncher("unicloud.launcher.configureRunTestParam",(async function(e){Gf.configureRunTestParam(e)}));const o=Wf.commands.registerCommand("unicloud.cloudFunction.uploadFunction",(e=>{Qf.uploadFunction({workspaceFolder:e.workspaceFolder,cloudPath:e.fsPath})})),r=Wf.commands.registerCommand("unicloud.cloudFunction.downloadFunction",(e=>{Qf.downloadFunction(e)})),s=Wf.commands.registerCommand("unicloud.relatedServiceSpace",(e=>{eh(e)})),a=Wf.commands.registerCommand("unicloud.command.uploadCommonFunction",(e=>{rh.uploadCommonModule(e)})),c=Wf.commands.registerCommand("unicloud.command.downloadCommonModule",(e=>{sh.downloadCommonModule(e)})),l=Wf.commands.registerCommand("unicloud.command.uploadUniClientDBAction",(e=>{ah.uploadUniClientDBAction(e)})),u=Wf.commands.registerCommand("unicloud.command.uploadUniClientDBActions",(e=>{ah.uploadAllUniClientDBAction(e)})),d=Wf.commands.registerCommand("unicloud.command.downloadUniClientDBActions",(e=>{ch.downloadAllUniClientDBAction(e)})),p=Wf.commands.registerCommand("unicloud.command.uploadAllFunction",(e=>{Qf.uploadAllCloudFunction(e)})),f=Wf.commands.registerCommand("unicloud.command.downloadAllFunction",(e=>{Qf.downloadAllCloudFunction(e)})),h=Wf.commands.registerCommand("unicloud.command.syncCommonModuleList",(e=>{lh(e)})),m=Wf.commands.registerCommand("unicloud.command.viewRelatedProjectServiceSpace",th),g=Wf.commands.registerCommand("unicloud.command.unBindRelatedProjectServiceSpace",nh),y=Wf.commands.registerCommand("unicloud.command.moveServiceSpaceToRelatedProject",ih),v=Wf.commands.registerCommand("unicloud.command.openUniCloudWebConsole",oh),w=Wf.commands.registerCommand("unicloud.command.initUniCloudSpaceWizard",Zf.showInitUniCloudWizard);return e.subscriptions.push(t,n,i,o,r,s,a,c,l,u,d,p,f,h,m,g,y,v,w),{initDeploy:Zf.initDeploy,getCloudFunctionExecLog:Kf.getCloudFunctionExecLog,createUniCloudEnvironment:Xf.createUniCloudEnvironment,preprocessBeforeCreateUniCloudEnvironment:Xf.preprocessBeforeCreateUniCloudEnvironment,importUniCloudPlugin:dh}},deactivate:function(){}};const hh=C.default,mh=O.default,gh=E.default;let yh=new Map;var vh={getFilesByPath:function e(t,n=!0,i=""){if(!mh.existsSync(t))return[];let o=[];return mh.readdirSync(t).forEach((r=>{let s=gh.join(t,r),a=i.endsWith("/")?i+r:i+"/"+r;a=a.startsWith("/")?a.slice(1):a,mh.statSync(s).isDirectory()?(n&&o.push({key:a+"/",value:s,type:"dir",defaultAction:0}),o.push(...e(s,n,a))):o.push({key:a,value:s,type:"file",defaultAction:0})})),o},consoleOut:async function(e,t){if(e.none)return;""===e.id&&(e.id="workbench.view.console");let n=yh.get(e.id);n||(n=hh.window.createOutputView({id:e.id,title:""}),yh.set(e.id,n)),await n.appendLine("string"==typeof t?{line:t}:t),e.isCli&&await hh.cliconsole.log({clientId:e.id,msg:"string"==typeof t?t:t.line,status:"string"==typeof t?"info":t.level})},getOpenUnicloudDevelopmentCenterUrl:function(e,t,n){let i=`https://dev.dcloud.net.cn/auth/dcloud/callback?return_url=https%25253A%25252F%25252Fdev.dcloud.net.cn%25252Funicloud%25252Fauth%25253Faction%25253Dhosting%252526appid%25253D${e}%252526provider%25253D${t}%252526spaceId%25253D${n}`;return"https://account.dcloud.net.cn/oauth2/login?email=${email}&deviceId=${deviceId}&sign=${askSign}&timestamp=${timestamp}&source=hbuilder.win32&sourceversion="+hh.env.appVersion+"&redirectURL="+i+"&client_id=DCLOUD_DEV"},checkUniappCli:function(e){if("UniApp_Vue"!==e.nature)return!1;const t=function(e){return mh.existsSync(gh.join(n,e))},n=e.uri.fsPath;return!!(t("package.json")&&t("node_modules")&&t("src")&&t("src/manifest.json")&&t("src/pages.json")&&(t("src/App.vue")||t("src/App.nvue"))&&(t("src/main.js")||t("src/main.ts")))||void 0}};const wh=C.default,xh=vh;function bh(e,t){return wh.http.request({url:"https://ide.liuyingyong.cn/serverless/host/tcb-sts-token",method:"post",serviceOptions:{serviceRequest:!0,body:{provider:"tcb",spaceId:e,appid:t}}})}function Sh(e){const{startTime:t,tmpSecretId:n,tmpSecretKey:i,sessionToken:o,expiredTime:r}=e;return new(0,z.default)({getAuthorization:function(e,s){s({StartTime:t,TmpSecretId:n,TmpSecretKey:i,SecurityToken:o,ExpiredTime:r})}})}const kh=0,Eh=1,_h=2;function Ch(e,t,n,i,o,r=1){return new Promise(((s,a)=>{e.getBucket({Bucket:t,Region:n,Prefix:i||"",Delimiter:o||""},(function(e,t){if(e)a({code:-1,msg:e});else{let e={code:0};switch(r){case 0:let n=[];t.Contents.forEach((e=>{n.push(e.Key)})),e.keys=n;break;case 1:let i=[],o=[];t.Contents.forEach((e=>{e.Key.endsWith("/")?o.push(e):i.push(e)})),e.files=i,e.dirs=o;break;case 2:e.contents=t.Contents}s(e)}}))}))}let Ih=new Map;var jh={uploadFiles:async function(e,t,n,i){const o="没有要上传的文件",r=`[腾讯云:${e.spaceName}]`;if(0===n.length)return await xh.consoleOut(i,{channel:"前端网页托管",line:r+o,level:"warning"}),{code:-1,msg:o};const s="上传失败,失败原因：",a=async function(n,o){0!==n&&await xh.consoleOut(i,{channel:"前端网页托管",line:r+`总共需上传${n}个文件，已成功上传${o}个文件。`+(e.bindDomain?`访问地址：https://${e.bindDomain}`:""),level:"success"});const s="跨域配置、自定义域名、证书等更多设置请到",a=" web控制台 ";await xh.consoleOut(i,{channel:"前端网页托管",line:r+s+a+"操作。",level:"success",hyperlinks:[{linkPosition:{start:r.length+s.length,end:r.length+s.length+a.length},onOpen:async function(){let n=xh.getOpenUnicloudDevelopmentCenterUrl(t.appid?t.appid:"",e.provider,e.spaceId);wh.env.openExternal(n)}}]})};xh.consoleOut(i,{channel:"前端网页托管",line:r+(t.name?`项目【 ${t.name} 】`:"")+`开始上传到 ${e.spaceName} 服务空间...`});const c=await bh(e.spaceId,t.appid?t.appid:"");if(c&&c.service&&1001===c.service.code){let t=c.service.body;const l=Sh({expiredTime:t.expiredTime,...t.credentials});let u=[];try{let e=await Ch(l,t.bucket,t.region);-1!==e.code&&e.files.forEach((e=>{u.push(e.Key)}))}catch(e){console.log(e)}let d=!!i.isCli,p=[];for(let e=0;e<n.length;++e){let i=n[e];if("file"===i.type){if(!d&&u.includes(i.key))if(0===i.defaultAction){let e=await wh.window.showMessageBox2({type:"question",title:"",text:`云端已存在名为 '${i.key}' 的文件，是否使用正在上传的文件来替换它？`,buttons:["替换","停止","跳过"],checkBoxText:"应用全部"});if(e){if("停止"===e.button)return a(n.filter((e=>"file"===e.type)).length,0);if("跳过"===e.button){if(e.checked)break;continue}"替换"===e.button&&e.checked&&(d=!0)}}else if(2===i.defaultAction)continue;p.push({Bucket:t.bucket,Region:t.region,Key:i.key,FilePath:i.value,onTaskReady:function(e){Ih.set(e,i)}})}else"dir"===i.type&&p.push({Bucket:t.bucket,Region:t.region,Key:i.key,FilePath:i.value,onTaskReady:function(e){}})}return 0===p.filter((e=>!e.Key.endsWith("/"))).length&&(await xh.consoleOut(i,{channel:"前端网页托管",line:r+o,level:"warning"}),0===p.length)?(await a(0,0),{code:-1,msg:o}):new Promise(((t,n)=>{l.uploadFiles({files:p,SliceSize:10485760,onProgress:function(e){var t=parseInt(1e4*e.percent)/100,n=parseInt(e.speed/1024/1024*100)/100;console.log("进度："+t+"%; 速度："+n+"Mb/s;")},onFileFinish:function(e,t,n){console.log(n.Key+"上传"+(e?"失败:"+e.message:"完成")),n.Key.endsWith("/")||(e?xh.consoleOut(i,{channel:"前端网页托管",line:r+"/"+n.Key+" "+s+e.message,level:"error"}):(xh.consoleOut(i,{channel:"前端网页托管",line:r+n.FilePath+" 已成功上传到 /"+n.Key,level:"success"}),Ih.delete(n.TaskId)))}},(async function(i,o){const r=p.filter((e=>!e.Key.endsWith("/"))).length;await a(r,r-Ih.size),console.log(i||o),i?n(i):t({code:0,bindDomain:e.bindDomain})}))}))}return xh.consoleOut(i,{channel:"前端网页托管",line:r+s+c.service.description,level:"error"}),{code:-1,msg:c.service.description}},getFiles:async function(e,t,n,i){const o=await bh(e.spaceId,t.appid?t.appid:"");if(!o||!o.service||1001!==o.service.code)return[];{let t=o.service.body;const i=Sh({expiredTime:t.expiredTime,...t.credentials});try{const e=n.startsWith("/")?n.slice(1):n;let o=await Ch(i,t.bucket,t.region,e,"",2);if(0===o.code){let t=[],n=new Map;return o.contents.forEach((i=>{let o=i.Key.slice(e.length);if(""===o||"/"===o)return;o=o.startsWith("/")?o.slice(1):o;const r=o.split("/");let s={};if(r.length>1){let e=r[0];if(n.has(e))return;n.set(e,e),s.type=0,s.name=e}else 1===r.length&&(s.type=1,s.name=r[0],s.updateTime=i.LastModified,s.size=i.Size);t.push(s)})),n.clear(),t}}catch(e){return console.log(e),[]}}},deleteFiles:async function(e,t,n,i){let o=[],r=[];n.forEach((e=>{let t=e.key.startsWith("/")?e.key.slice(1):e.key;"file"===e.type?o.push({Key:t}):"dir"===e.type&&(t=t.endsWith("/")?t:t+"/",r.push({key:t}))}));const s=await bh(e.spaceId,t.appid?t.appid:"");if(s&&s.service&&1001===s.service.code){let t=s.service.body;const n=Sh({expiredTime:t.expiredTime,...t.credentials});for(let i=0;i<r.length;++i){const s=r[i],a=s.key.startsWith("/")?s.key.slice(1):s.key;try{const e=await Ch(n,t.bucket,t.region,a,"",0);0===e.code&&e.keys.forEach((e=>{o.push({Key:e})}))}catch(e){console.log(e)}}const a=`[腾讯云:${e.spaceName}]`;if(xh.consoleOut(i,{channel:"前端网页托管",line:a+"正在执行删除操作..."}),0===o.length){const e="没有要删除的文件";return xh.consoleOut(i,{channel:"前端网页托管",line:a+e}),{code:-1,msg:e}}return new Promise(((e,r)=>{n.deleteMultipleObject({Bucket:t.bucket,Region:t.region,Objects:o},(function(t,n){if(console.log(t||n),t)return xh.consoleOut(i,{channel:"前端网页托管",line:a+"删除失败，原因："+t.message,level:"error"}),void r(t);n.Deleted.forEach((e=>{let t="文件";e.Key.endsWith("/")&&(t="目录"),xh.consoleOut(i,{channel:"前端网页托管",line:a+t+" "+e.Key+" 删除成功",level:"success"})})),e({code:0})}))}))}return{code:-1,msg:s.service.description}}},Oh={exports:{}};Oh.exports=function e(t,n,i){function o(s,a){if(!n[s]){if(!t[s]){var c="function"==typeof require&&require;if(!a&&c)return c(s,!0);if(r)return r(s,!0);var l=new Error("Cannot find module '"+s+"'");throw l.code="MODULE_NOT_FOUND",l}var u=n[s]={exports:{}};t[s][0].call(u.exports,(function(e){return o(t[s][1][e]||e)}),u,u.exports,e,t,n,i)}return n[s].exports}for(var r="function"==typeof require&&require,s=0;s<i.length;s++)o(i[s]);return o}({1:[function(e,t,n){function i(e,t,n){var i;return e&&(i={b:e}),t&&((i=i||{}).a=t),n&&((i=i||{}).x=n),i}function o(e,t){if(null!==e&&"object"==typeof e){var n,s,a,c,l=u.getComment(e);if(l&&u.removeComment(e),"[object Array]"===Object.prototype.toString.apply(e)){for(c={a:{}},n=0,s=e.length;n<s;n++)r(c.a,n,l.a[n],o(e[n]))&&(a=!0);!a&&l.e&&(c.e=i(l.e[0],l.e[1]),a=!0)}else{c={s:{}};var d,p=Object.keys(e);for(l&&l.o?(d=[],l.o.concat(p).forEach((function(t){Object.prototype.hasOwnProperty.call(e,t)&&d.indexOf(t)<0&&d.push(t)}))):d=p,c.o=d,n=0,s=d.length;n<s;n++){var f=d[n];r(c.s,f,l.c[f],o(e[f]))&&(a=!0)}!a&&l.e&&(c.e=i(l.e[0],l.e[1]),a=!0)}return t&&l&&l.r&&(c.r=i(l.r[0],l.r[1])),a?c:void 0}}function r(e,t,n,o){var r=i(n?n[0]:void 0,n?n[1]:void 0,o);return r&&(e[t]=r),r}function s(e,t){var n=i(t.b,t.a);return n.path=e,n}function a(e,t,n){if(e){var i,o;if(e.a)for(i=0,o=e.a.length;i<o;i++){var r=n.slice().concat([i]),c=e.a[i];c&&(t.push(s(r,c)),a(c.x,t,r))}else e.o&&e.o.forEach((function(i){var o=n.slice().concat([i]),r=e.s[i];r&&(t.push(s(o,r)),a(r.x,t,o))}));e.e&&t.push(s(n,e.e))}}function c(e,t,n,i){if(e){if(null===t||"object"!=typeof t)return void a(e,n,i);var o,r=u.createComment(t);if(0===i.length&&e.r&&(r.r=[e.r.b,e.r.a]),"[object Array]"===Object.prototype.toString.apply(t)){r.a=[];var l=e.a||{};for(var d in l)if(l.hasOwnProperty(d)){o=parseInt(d);var p=e.a[d];if(p){var f=i.slice().concat([o]);o<t.length?(r.a[o]=[p.b,p.a],c(p.x,t[o],n,f)):(n.push(s(f,p)),a(p.x,n,f))}}0===o&&e.e&&(r.e=[e.e.b,e.e.a])}else r.c={},r.o=[],(e.o||[]).forEach((function(o){var l=i.slice().concat([o]),u=e.s[o];Object.prototype.hasOwnProperty.call(t,o)?(r.o.push(o),u&&(r.c[o]=[u.b,u.a],c(u.x,t[o],n,l))):u&&(n.push(s(l,u)),a(u.x,n,l))})),e.e&&(r.e=[e.e.b,e.e.a])}}function l(e,t,n){var i=u.createComment(e,u.getComment(e));return i.r||(i.r=["",""]),(t||""===t)&&(i.r[n]=u.forceComment(t)),i.r[n]||""}var u=e("./hjson-common");t.exports={extract:function(e){return o(e,!0)},merge:function(e,t){var n=[];if(c(e,t,n,[]),n.length>0){var i=l(t,null,1);i+="\n# Orphaned comments:\n",n.forEach((function(e){i+=("# "+e.path.join("/")+": "+function(){var e="";return[].forEach.call(arguments,(function(t){t&&""!==t.trim()&&(e&&(e+="; "),e+=t.trim())})),e}(e.b,e.a,e.e)).replace("\n","\\n ")+"\n"})),l(t,i,1)}},header:function(e,t){return l(e,t,0)},footer:function(e,t){return l(e,t,1)}}},{"./hjson-common":2}],2:[function(e,t,n){var i=e("os");t.exports={EOL:i.EOL||"\n",tryParseNumber:function(e,t){function n(){return o=e.charAt(c),c++,o}var i,o,r="",s=0,a=!0,c=0;for(n(),"-"===o&&(r="-",n());o>="0"&&o<="9";)a&&("0"==o?s++:a=!1),r+=o,n();if(a&&s--,"."===o)for(r+=".";n()&&o>="0"&&o<="9";)r+=o;if("e"===o||"E"===o)for(r+=o,n(),"-"!==o&&"+"!==o||(r+=o,n());o>="0"&&o<="9";)r+=o,n();for(;o&&o<=" ";)n();return t&&(","!==o&&"}"!==o&&"]"!==o&&"#"!==o&&("/"!==o||"/"!==e[c]&&"*"!==e[c])||(o=0)),i=+r,o||s||!isFinite(i)?void 0:i},createComment:function(e,t){return Object.defineProperty&&Object.defineProperty(e,"__COMMENTS__",{enumerable:!1,writable:!0}),e.__COMMENTS__=t||{}},removeComment:function(e){Object.defineProperty(e,"__COMMENTS__",{value:void 0})},getComment:function(e){return e.__COMMENTS__},forceComment:function(e){if(!e)return"";var t,n,i,o,r=e.split("\n");for(i=0;i<r.length;i++)for(o=(t=r[i]).length,n=0;n<o;n++){var s=t[n];if("#"===s)break;if("/"===s&&("/"===t[n+1]||"*"===t[n+1])){"*"===t[n+1]&&(i=r.length);break}if(s>" "){r[i]="# "+t;break}}return r.join("\n")}}},{os:8}],3:[function(e,t,n){function i(e,t){if(e)for(var n=0;n<e.length;n++){var i=e[n](t);if(void 0!==i)return i}}function o(){}function r(e){return"{"===e||"}"===e||"["===e||"]"===e||","===e}function s(){return{name:"math",parse:function(e){switch(e){case"+inf":case"inf":case"+Inf":case"Inf":return 1/0;case"-inf":case"-Inf":return-1/0;case"nan":case"NaN":return NaN}},stringify:function(e){if("number"==typeof e)return 1/e==-1/0?"-0":e===1/0?"Inf":e===-1/0?"-Inf":isNaN(e)?"NaN":void 0}}}function a(e){var t=e&&e.out;return{name:"hex",parse:function(e){if(/^0x[0-9A-Fa-f]+$/.test(e))return parseInt(e,16)},stringify:function(e){if(t&&Number.isInteger(e))return"0x"+e.toString(16)}}}function c(){return{name:"date",parse:function(e){if(/^\d{4}-\d{2}-\d{2}$/.test(e)||/^\d{4}-\d{2}-\d{2}T\d{2}\:\d{2}\:\d{2}(?:.\d+)(?:Z|[+-]\d{2}:\d{2})$/.test(e)){var t=Date.parse(e);if(!isNaN(t))return new Date(t)}},stringify:function(e){if("[object Date]"===Object.prototype.toString.call(e)){var t=e.toISOString();return-1!==t.indexOf("T00:00:00.000Z",t.length-14)?t.substr(0,10):t}}}}s.description="support for Inf/inf, -Inf/-inf, Nan/naN and -0",a.description="parse hexadecimal numbers prefixed with 0x",c.description="support ISO dates",t.exports={loadDsf:function(e,t){function n(e){return"[object Function]"==={}.toString.call(e)}if("[object Array]"!==Object.prototype.toString.apply(e)){if(e)throw new Error("dsf option must contain an array!");return o}if(0===e.length)return o;var s=[];return e.forEach((function(e){if(!e.name||!n(e.parse)||!n(e.stringify))throw new Error("extension does not match the DSF interface");s.push((function(){try{if("parse"==t)return e.parse.apply(null,arguments);if("stringify"==t){var n=e.stringify.apply(null,arguments);if(void 0!==n&&("string"!=typeof n||0===n.length||'"'===n[0]||[].some.call(n,(function(e){return r(e)}))))throw new Error("value may not be empty, start with a quote or contain a punctuator character except colon: "+n);return n}throw new Error("Invalid type")}catch(t){throw new Error("DSF-"+e.name+" failed; "+t.message)}}))})),i.bind(null,s)},std:{math:s,hex:a,date:c}}},{}],4:[function(e,t,n){t.exports=function(t,n){function i(){w=0,x=" "}function o(e){return"{"===e||"}"===e||"["===e||"]"===e||","===e||":"===e}function r(e){var t,n=0,i=1;for(t=w-1;t>0&&"\n"!==v[t];t--,n++);for(;t>0;t--)"\n"===v[t]&&i++;throw new Error(e+" at line "+i+","+n+" >>>"+v.substr(w-n,20)+" ...")}function s(){return x=v.charAt(w),w++,x}function a(e){return v.charAt(w+e)}function c(e){for(var t="",n=x;s();){if(x===n)return s(),e&&"'"===n&&"'"===x&&0===t.length?(s(),l()):t;if("\\"===x)if(s(),"u"===x){for(var i=0,o=0;o<4;o++){s();var a,c=x.charCodeAt(0);x>="0"&&x<="9"?a=c-48:x>="a"&&x<="f"?a=c-97+10:x>="A"&&x<="F"?a=c-65+10:r("Bad \\u char "+x),i=16*i+a}t+=String.fromCharCode(i)}else{if("string"!=typeof k[x])break;t+=k[x]}else"\n"===x||"\r"===x?r("Bad string containing newline"):t+=x}r("Bad string")}function l(){function e(){for(var e=i;x&&x<=" "&&"\n"!==x&&e-- >0;)s()}for(var t="",n=0,i=0;;){var o=a(-i-5);if(!o||"\n"===o)break;i++}for(;x&&x<=" "&&"\n"!==x;)s();for("\n"===x&&(s(),e());;){if(x){if("'"===x){if(n++,s(),3===n)return"\n"===t.slice(-1)&&(t=t.slice(0,-1)),t;continue}for(;n>0;)t+="'",n--}else r("Bad multiline string");"\n"===x?(t+="\n",s(),e()):("\r"!==x&&(t+=x),s())}}function u(){if('"'===x||"'"===x)return c(!1);for(var e="",t=w,n=-1;;){if(":"===x)return e?n>=0&&n!==e.length&&(w=t+n,r("Found whitespace in your key name (use quotes to include)")):r("Found ':' but no key name (for an empty key name use quotes)"),e;x<=" "?x?n<0&&(n=e.length):r("Found EOF while looking for a key name (check your syntax)"):o(x)?r("Found '"+x+"' where a key name was expected (check your syntax or use quotes if the key name includes {}[],: or whitespace)"):e+=x,s()}}function d(){for(;x;){for(;x&&x<=" ";)s();if("#"===x||"/"===x&&"/"===a(0))for(;x&&"\n"!==x;)s();else{if("/"!==x||"*"!==a(0))break;for(s(),s();x&&("*"!==x||"/"!==a(0));)s();x&&(s(),s())}}}function p(e,t){var n;for(e--,n=w-2;n>e&&v[n]<=" "&&"\n"!==v[n];n--);"\n"===v[n]&&n--,"\r"===v[n]&&n--;var i=v.substr(e,n-e+1);for(n=0;n<i.length;n++)if(i[n]>" "){var o=i.indexOf("\n");if(o>=0){var r=[i.substr(0,o),i.substr(o+1)];return t&&0===r[0].trim().length&&r.shift(),r}return[i]}return[]}function f(e){function t(e,n){var i,o,r,s;switch(typeof e){case"string":e.indexOf(n)>=0&&(s=e);break;case"object":if("[object Array]"===Object.prototype.toString.apply(e))for(i=0,r=e.length;i<r;i++)s=t(e[i],n)||s;else for(o in e)Object.prototype.hasOwnProperty.call(e,o)&&(s=t(e[o],n)||s)}return s}function n(n){var i=t(e,n);return i?"found '"+n+"' in a string value, your mistake could be with:\n  > "+i+"\n  (unquoted strings contain everything up to the next line!)":""}return n("}")||n("]")}function h(){var e,t,n,i=[];try{if(b&&(e=E.createComment(i,{a:[]})),s(),t=w,d(),e&&(n=p(t,!0).join("\n")),"]"===x)return s(),e&&(e.e=[n]),i;for(;x;){if(i.push(g()),t=w,d(),","===x&&(s(),t=w,d()),e){var o=p(t);e.a.push([n||"",o[0]||""]),n=o[1]}if("]"===x)return s(),e&&(e.a[e.a.length-1][1]+=n||""),i;d()}r("End of input while parsing an array (missing ']')")}catch(e){throw e.hint=e.hint||f(i),e}}function m(e){var t,n,i,o="",a={};try{if(b&&(t=E.createComment(a,{c:{},o:[]})),e?n=1:(s(),n=w),d(),t&&(i=p(n,!0).join("\n")),"}"===x&&!e)return t&&(t.e=[i]),s(),a;for(;x;){if(o=u(),d(),":"!==x&&r("Expected ':' instead of '"+x+"'"),s(),a[o]=g(),n=w,d(),","===x&&(s(),n=w,d()),t){var c=p(n);t.c[o]=[i||"",c[0]||""],i=c[1],t.o.push(o)}if("}"===x&&!e)return s(),t&&(t.c[o][1]+=i||""),a;d()}if(e)return a;r("End of input while parsing an object (missing '}')")}catch(e){throw e.hint=e.hint||f(a),e}}function g(){switch(d(),x){case"{":return m();case"[":return h();case"'":case'"':return c(!0);default:return function(){var e=x;for(o(x)&&r("Found a punctuator character '"+x+"' when expecting a quoteless string (check your syntax)");;){s();var t="\r"===x||"\n"===x||""===x;if(t||","===x||"}"===x||"]"===x||"#"===x||"/"===x&&("/"===a(0)||"*"===a(0))){var n=e[0];switch(n){case"f":if("false"===e.trim())return!1;break;case"n":if("null"===e.trim())return null;break;case"t":if("true"===e.trim())return!0;break;default:if("-"===n||n>="0"&&n<="9"){var i=E.tryParseNumber(e);if(void 0!==i)return i}}if(t){e=e.trim();var c=S(e);return void 0!==c?c:e}}e+=x}}()}}function y(e,t){var n=w;if(d(),x&&r("Syntax error, found trailing characters"),b){var i=t.join("\n"),o=p(n).join("\n");(o||i)&&(E.createComment(e,E.getComment(e)).r=[i,o])}return e}var v,w,x,b,S,E=e("./hjson-common"),C=e("./hjson-dsf"),k={'"':'"',"'":"'","\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"};if("string"!=typeof t)throw new Error("source is not a string");var _=null,I=!0;return n&&"object"==typeof n&&(b=n.keepWsc,_=n.dsf,I=!1!==n.legacyRoot),S=C.loadDsf(_,"parse"),v=t,i(),I?function(){d();var e=b?p(1):null;switch(x){case"{":return y(m(),e);case"[":return y(h(),e)}try{return y(m(!0),e)}catch(t){i();try{return y(g(),e)}catch(e){throw t}}}():function(){d();var e=b?p(1):null;switch(x){case"{":return y(m(),e);case"[":return y(h(),e);default:return y(g(),e)}}()}},{"./hjson-common":2,"./hjson-dsf":3}],5:[function(e,t,n){t.exports=function(t,n){function i(e,t){return T+=e[0].length+e[1].length-e[2]-e[3],e[0]+t+e[1]}function o(e){return e.replace(I,(function(e){var t=P[e];return"string"==typeof t?i(b.esc,t):i(b.uni,("0000"+e.charCodeAt(0).toString(16)).slice(-4))}))}function r(e,t,n,r){return e?(j.lastIndex=0,L.lastIndex=0,m||n||j.test(e)||void 0!==a.tryParseNumber(e,!0)||L.test(e)?(I.lastIndex=0,O.lastIndex=0,I.test(e)?O.test(e)||r||!y?i(b.qstr,o(e)):function(e,t){var n,o=e.replace(/\r/g,"").split("\n");if(t+=d,1===o.length)return i(b.mstr,o[0]);var r=u+t+b.mstr[0];for(n=0;n<o.length;n++)r+=u,o[n]&&(r+=t+o[n]);return r+u+t+b.mstr[1]}(e,t):i(b.qstr,e)):i(b.str,e)):i(b.qstr,"")}function s(e){return e?h||N.test(e)?(I.lastIndex=0,i(b.qkey,I.test(e)?o(e):e)):i(b.key,e):'""'}var a=e("./hjson-common"),c=e("./hjson-dsf"),l={obj:["{","}"],arr:["[","]"],key:["",""],qkey:['"','"'],col:[":",""],com:[",",""],str:["",""],qstr:['"','"'],mstr:["'''","'''"],num:["",""],lit:["",""],dsf:["",""],esc:["\\",""],uni:["\\u",""],rem:["",""]},u=a.EOL,d="  ",p=!1,f=!1,h=!1,m=!1,g=0,y=1,v="",w=null,x=!1,b=l;if(n&&"object"==typeof n){n.quotes="always"===n.quotes?"strings":n.quotes,"\n"!==n.eol&&"\r\n"!==n.eol||(u=n.eol),p=n.keepWsc,g=n.condense||0,f=n.bracesSameLine,h="all"===n.quotes||"keys"===n.quotes,m="all"===n.quotes||"strings"===n.quotes||!0===n.separator,y=m||"off"==n.multiline?0:"no-tabs"==n.multiline?2:1,v=!0===n.separator?b.com[0]:"",w=n.dsf,x=n.sortProps,"number"==typeof n.space?d=new Array(n.space+1).join(" "):"string"==typeof n.space&&(d=n.space),!0===n.colors&&(b={obj:["[37m{[0m","[37m}[0m"],arr:["[37m[[0m","[37m][0m"],key:["[33m","[0m"],qkey:['[33m"','"[0m'],col:["[37m:[0m",""],com:["[37m,[0m",""],str:["[37;1m","[0m"],qstr:['[37;1m"','"[0m'],mstr:["[37;1m'''","'''[0m"],num:["[36;1m","[0m"],lit:["[36m","[0m"],dsf:["[37m","[0m"],esc:["[31m\\","[0m"],uni:["[31m\\u","[0m"],rem:["[35m","[0m"]});var S,E=Object.keys(l);for(S=E.length-1;S>=0;S--){var C=E[S];b[C].push(l[C][0].length,l[C][1].length)}}var k,_="-­؀-؄܏឴឵‌-‏\u2028- ⁠-⁯\ufeff￰-￿",I=new RegExp('[\\\\\\"\0-'+_+"]","g"),j=new RegExp("^\\s|^\"|^'|^#|^\\/\\*|^\\/\\/|^\\{|^\\}|^\\[|^\\]|^:|^,|\\s$|[\0-"+_+"]","g"),O=new RegExp("'''|^[\\s]+$|[\0-"+(2===y?"\t":"\b")+"\v\f-"+_+"]","g"),L=new RegExp("^(true|false|null)\\s*((,|\\]|\\}|#|//|/\\*).*)?$"),P={"\b":"b","\t":"t","\n":"n","\f":"f","\r":"r",'"':'"',"\\":"\\"},N=/[,\{\[\}\]\s:#"']|\/\/|\/\*/,F="",T=0;k=c.loadDsf(w,"stringify");var D="",$=p?$=(a.getComment(t)||{}).r:null;return $&&$[0]&&(D=$[0]+"\n"),D+=function e(t,n,o,c){function l(e){return e&&"\n"===e["\r"===e[0]?1:0]}function h(e){return e&&!l(e)}function w(e,t,n){if(!e)return"";var o,r=(e=a.forceComment(e)).length;for(o=0;o<r&&e[o]<=" ";o++);return n&&o>0&&(e=e.substr(o)),o<r?t+i(b.rem,e):e}var S=k(t);if(void 0!==S)return i(b.dsf,S);switch(typeof t){case"string":return r(t,F,n,c);case"number":return isFinite(t)?i(b.num,String(t)):i(b.lit,"null");case"boolean":return i(b.lit,String(t));case"object":if(!t)return i(b.lit,"null");var E;p&&(E=a.getComment(t));var C,_,I,j,O,L,P,N,D,$,R="[object Array]"===Object.prototype.toString.apply(t),A=F,B=u+A,M=u+(F+=d),U=o||f?"":B,q=[],W=g?[]:null,J=m,V=y,H=v?"":b.com[0],z=0;if(R){for(_=0,I=t.length;_<I;_++){if(C=_<I-1,E?(N=h((P=E.a[_]||[])[1]),q.push(w(P[0],"\n")+M),W&&(P[0]||P[1]||N)&&(W=null)):q.push(M),T=0,O=t[_],q.push(e(O,!!E&&N,!0)+(C?v:"")),W){switch(typeof O){case"string":T=0,m=!0,y=0,W.push(e(O,!1,!0)+(C?b.com[0]:"")),m=J,y=V;break;case"object":if(O){W=null;break}default:W.push(q[q.length-1]+(C?H:""))}C&&(T+=b.com[0].length-b.com[2]),z+=T}E&&P[1]&&q.push(w(P[1],N?" ":"\n",N))}0===I?E&&E.e&&q.push(w(E.e[0],"\n")+B):q.push(B),0===q.length?D=i(b.arr,""):(D=U+i(b.arr,q.join("")),W&&($=W.join(" ")).length-z<=g&&(D=i(b.arr,$)))}else{var G=E?E.o.slice():[],K=[];for(j in t)Object.prototype.hasOwnProperty.call(t,j)&&G.indexOf(j)<0&&K.push(j);x&&K.sort();var Z=G.concat(K);for(_=0,I=Z.length;_<I;_++)if(C=_<I-1,j=Z[_],E?(N=h((P=E.c[j]||[])[1]),q.push(w(P[0],"\n")+M),W&&(P[0]||P[1]||N)&&(W=null)):q.push(M),T=0,L=e(O=t[j],E&&N),q.push(s(j)+b.col[0]+(l(L)?"":" ")+L+(C?v:"")),E&&P[1]&&q.push(w(P[1],N?" ":"\n",N)),W){switch(typeof O){case"string":T=0,m=!0,y=0,L=e(O,!1),m=J,y=V,W.push(s(j)+b.col[0]+" "+L+(C?b.com[0]:""));break;case"object":if(O){W=null;break}default:W.push(q[q.length-1]+(C?H:""))}T+=b.col[0].length-b.col[2],C&&(T+=b.com[0].length-b.com[2]),z+=T}0===I?E&&E.e&&q.push(w(E.e[0],"\n")+B):q.push(B),0===q.length?D=i(b.obj,""):(D=U+i(b.obj,q.join("")),W&&($=W.join(" ")).length-z<=g&&(D=i(b.obj,$)))}return F=A,D}}(t,null,!0,!0),$&&(D+=$[1]||""),D}},{"./hjson-common":2,"./hjson-dsf":3}],6:[function(e,t,n){t.exports="3.2.1"},{}],7:[function(e,t,n){var i=e("./hjson-common"),o=e("./hjson-version"),r=e("./hjson-parse"),s=e("./hjson-stringify"),a=e("./hjson-comments"),c=e("./hjson-dsf");t.exports={parse:r,stringify:s,endOfLine:function(){return i.EOL},setEndOfLine:function(e){"\n"!==e&&"\r\n"!==e||(i.EOL=e)},version:o,rt:{parse:function(e,t){return(t=t||{}).keepWsc=!0,r(e,t)},stringify:function(e,t){return(t=t||{}).keepWsc=!0,s(e,t)}},comments:a,dsf:c.std}},{"./hjson-comments":1,"./hjson-common":2,"./hjson-dsf":3,"./hjson-parse":4,"./hjson-stringify":5,"./hjson-version":6}],8:[function(e,t,n){},{}]},{},[7])(7);const Ph=C.default,Lh=vh,Nh=jh,Fh=O.default,Th=E.default,Dh=Oh.exports;async function $h(e){const{spaceInfo:t,workspaceFolder:n,filePaths:i,consoleOptions:o,args:r=null}=e;let s=[],a=Object.prototype.toString.call(i);if("[object String]"===a){let t="";try{if(n.nature&&"UniApp_Vue"===n.nature){let e=Th.join(n.uri.fsPath,Lh.checkUniappCli(n)?"src/manifest.json":"manifest.json");if(Fh.existsSync(e)){let n=Fh.readFileSync(e,"utf-8"),i=Dh.parse(n);i&&i.h5&&i.h5.router&&i.h5.router.base&&(t=i.h5.router.base)}}}catch(e){}s=Lh.getFilesByPath(i,!0,t)}else{if("[object Array]"!==a)throw new"不支持的参数类型";s=i}let c=null;const l=await Ph.http.request({url:"https://ide.liuyingyong.cn/serverless/host/domains",method:"post",serviceOptions:{serviceRequest:!0,body:{provider:t.provider,spaceId:t.spaceId,appid:n.appid}}});if(l&&l.service&&1001==l.service.code){let e=l.service.body.customDomains;0===e.length&&(e=l.service.body.defaultDomains),c=e[0].domain}t.bindDomain=c;const u=t.provider;if("aliyun"!==u){if("tcb"===u)return Nh.uploadFiles(t,n,s,o);throw new Error("不支持的服务商")}}function Rh(e){const{spaceInfo:t,workspaceFolder:n,prefix:i,consoleOptions:o}=e,r=t.provider;if("aliyun"!==r){if("tcb"===r)return Nh.getFiles(t,n,i,o);throw new Error("不支持的服务商")}}function Ah(e){const{spaceInfo:t,workspaceFolder:n,fileKeys:i,consoleOptions:o}=e,r=t.provider;if("aliyun"!==r){if("tcb"===r)return Nh.deleteFiles(t,n,i,o);throw new Error("不支持的服务商")}}var Bh={activate:function(e){return{staticFilesDeploy:$h,getDeployedFiles:Rh,deleteDeployedFiles:Ah}},deactivate:function(){}};const Mh=C.default,Uh=R.default,qh=E.default,Wh=O.default,Jh=F.default,{getWorkspaceBindServiceSpace:Hh}=Ct,Vh={ALIYUN:0,TCB:1,BOTH:2,ALIPAY:3,toString(e){return e===this.BOTH?"both":e===this.ALIYUN?"aliyun":e===this.TCB?"tcb":"alipay"}};function zh(e){return"aliyun"===e?"阿里云":"tcb"===e?"腾讯云":"支付宝云"}async function Gh(e,t,n="服务"){let i={code:0,msg:"",provider:"",spaceName:"",spaceId:""};const o="请先绑定服务空间",r=`当前${n}仅支持腾讯云(tcb)云开发环境,请先为腾讯云(tcb)云开发环境绑定服务空间`,s=`当前${n}仅支持阿里云(aliyun)云开发环境,请先为阿里云(aliyun)云开发环境绑定服务空间`,a=`当前${n}仅支持腾讯云(tcb)云开发环境,默认使用腾讯云(tcb)云开发环境`,c=`当前${n}仅支持阿里云(aliyun)云开发环境,默认使用阿里云(aliyun)云开发环境`,l=`当前${n}仅支持支付宝云(alipay)云开发环境,默认使用支付宝云(alipay)云开发环境`,u=`当前${n}仅支持支付宝云(alipay)云开发环境,请先为支付宝云(alipay)云开发环境绑定服务空间`;let d=!1,p=qh.dirname(t),f=qh.basename(p).split("-")[1];"aliyun"!==f&&"tcb"!==f&&"alipay"!==f&&(d=!0);let h=null;try{h=await Hh({workspaceFolder:e})}catch(e){return i.code=-1,i.msg=o,i}if(!h||h.allSpaces.length<=0)return i.code=-1,i.msg=o,i;if(!d){let e=h.allSpaces.find((e=>e.provider===f));return e&&e.spaceName&&e.spaceId?(i.provider=f,i.spaceName=e.spaceName,i.spaceId=e.spaceId):(i.code=-1,i.msg=o),i}let m=function(e){if(null===e.match(/uni_modules/g))return Vh.BOTH;let t=qh.dirname(e);t=qh.dirname(t);let n=qh.join(t,"package.json");if(!Wh.existsSync(n))return Vh.BOTH;let i=Wh.readFileSync(n,{encoding:"utf-8"}).toString();try{let e=JSON.parse(i),t=e.uni_modules.platforms.cloud;if(e&&t){let e="y"===t.tcb,n="y"===t.aliyun,i="y"===t.alipay;return!e||n||i?e||!n||i?e||n||!i?Vh.BOTH:Vh.ALIPAY:Vh.ALIYUN:Vh.TCB}}catch(e){return Vh.BOTH}return Vh.BOTH}(t);if(m===Vh.BOTH){let e=[],t=h.allSpaces.find((e=>e.provider===Vh.toString(Vh.ALIYUN))),n=!!(t&&t.spaceName&&t.spaceId);if(e.push({isBind:n,provider:Vh.toString(Vh.ALIYUN),spaceName:n?t.spaceName:"未绑定服务空间",spaceId:n?t.spaceId:""}),t=h.allSpaces.find((e=>e.provider===Vh.toString(Vh.TCB))),n=!!(t&&t.spaceName&&t.spaceId),e.push({isBind:n,provider:Vh.toString(Vh.TCB),spaceName:n?t.spaceName:"未绑定服务空间",spaceId:n?t.spaceId:""}),t=h.allSpaces.find((e=>e.provider===Vh.toString(Vh.ALIPAY))),n=!!(t&&t.spaceName&&t.spaceId),e.push({isBind:n,provider:Vh.toString(Vh.ALIPAY),spaceName:n?t.spaceName:"未绑定服务空间",spaceId:n?t.spaceId:""}),1===h.allSpaces.length){const e=h.allSpaces[0];return i.provider=e.provider,i.spaceName=e.spaceName,i.spaceId=e.spaceId,i}function r(e){let t=[];return e.spaces.forEach((e=>{t.push({columns:[{label:e.provider},{label:e.spaceName}]})})),{title:"选择服务商",footer:"",formItems:[{type:"list",name:"spaceList",title:"",columnStretches:[1,1],items:t,value:0}]}}const s="取消(&C)",a="确定(&O)",c=await Mh.window.showFormDialog({...r({spaces:e}),width:330,height:350,customButtons:[{text:s},{text:a,role:"accept"}],onOpened:async function(){},onChanged:async function(){},validate:async function(e){return-1!==e.spaceList||(this.showError("请选择服务商"),!1)}});return 0===c.buttonIndex?(i.code=-2,i):(t=e[c.result.spaceList],t.isBind?(i.provider=t.provider,i.spaceName=t.spaceName,i.spaceId=t.spaceId,i):(i.code=-1,i.msg=o,i))}{f=Vh.toString(m);let e=h.allSpaces.find((e=>e.provider===f));return e&&e.spaceName&&e.spaceId?(i.msg=m===Vh.TCB?a:m===Vh.ALIYUN?c:l,i.provider=f,i.spaceName=e.spaceName,i.spaceId=e.spaceId,i):(i.code=-1,i.msg=(g=m)===Vh.TCB?r:g===Vh.ALIYUN?s:u,i)}var g}async function Kh(e){3!==e.caller?(e.progress&&e.progress.report({message:e.message,level:e.level||""}),e.output&&e.output.appendLine({level:e.level||"",line:e.message})):Mh.cliconsole.log({clientId:e.clientId,msg:e.message,status:e.level||"info"})}function Zh(e){try{if(/(?<=(\/|\\)uni_modules(\/|\\))\.*/g.test(e))return!0}catch(e){}return!1}var Yh={uploadJson:async function(e){if(console.log("uploadJson params",e),Zh(e?.dbFolder?.path||e.fsPath))return;let t,n,i,o,r="";const s=e.caller||1;1===s?(t=e.workspaceFolder,n=e.fsPath,o=Mh.window.createOutputView({id:`${t.id}-unicloud`,title:`[${t.name}] - unicloud控制台`})):2===s?(t=e.workspaceFolder,n=qh.join(e.workspaceFolder.uri.fsPath,`/uniCloud-${e.provider}/database`),await Uh.window.withProgress({cancellable:!0,location:{parentId:e.parentId}},(async e=>{i=e})),o=Mh.window.createOutputView({id:`${t.id}-unicloud`,title:`[${t.name}] - unicloud控制台`})):(n=qh.join(e.fsPath,`/uniCloud-${e.provider}/database`),t={name:e.prj},r=e.clientId);const a=qh.join(n,"/package.json");if(!Wh.existsSync(a))return void(2!==s&&Kh({caller:s,message:"database/package.json文件不存在，请通过菜单【配置Schema扩展到Js的公共模块或扩展库】进行配置",level:"error",output:o,progress:i,clientId:r}));const c=qh.join(Jh.tmpdir(),t.name);Wh.existsSync(c)||Wh.mkdirSync(c);const l=qh.join(c,"databaseJql");Wh.existsSync(l)&&Wh.rmSync(l,{recursive:!0,force:!0}),Wh.mkdirSync(l),Wh.copyFileSync(a,qh.join(l,"package.json"));const u=qh.join(c,"databaseJql.zip");let d=await Mh.util.compressDir(u,l);if(0!==d.code||!d.res||!0!==d.res)return void Kh({caller:s,message:"database/package.json文件压缩失败，请重新通过菜单【配置Schema扩展到Js的公共模块或扩展库】进行配置",level:"error",output:o,progress:i,clientId:r});let p,f,h,m,g=0;if(1===s||2===s)try{const e=await Gh(t,n);g=e.code,p=e.msg,f=e.provider,h=e.spaceName,m=e.spaceId}catch(e){}if(1!==s&&(f=e.provider,m=e.spaceId),0!==g)return void Kh({caller:s,message:p,level:"error",output:o,progress:i,clientId:r});let y,v=`[${zh(f)}:${h||""}]`;Kh({caller:s,message:`${v}开始上传Schema扩展Js的配置`,output:o,progress:i,clientId:r});try{y=await Mh.http.request({url:"https://ide.liuyingyong.cn/serverless/commonModule/upload-jql",method:"post",connectionTimeout:1e3,readTimeout:5e3,serviceOptions:{serviceRequest:!0,body:{provider:f,spaceId:m,appid:t.appid||e.appId}},params:{attachment:Mh.Uri.file(u)}})}catch(e){return void Kh({caller:s,message:`${v}database/package.json文件上传失败：${JSON.stringify(e)}`,level:"error",output:o,progress:i,clientId:r})}if(1001!==y.service.code)return void Kh({caller:s,message:`${v}database/package.json文件上传失败：${y.service.description}`,level:"error",output:o,progress:i,clientId:r});Wh.unlinkSync(u);let w=y.service.body,x=w.ticket,b=Date.now()/1e3,S=!1,E="";for(;!(Date.now()/1e3-b>=1800);)try{let e=await Mh.http.request({url:"https://ide.liuyingyong.cn/serverless/commonModule/update-result",method:"post",serviceOptions:{serviceRequest:!0,body:{ticket:x}}});if(1001===e.service.code){if(w=e.service.body,"OK"===w.status){S=!0;break}if("FAILED"===w.status){E=w.error_log;break}}await new Promise((e=>{setTimeout(e,300)}))}catch(e){}Kh({caller:s,message:`${v}上传Schema扩展Js的配置${S?"成功":"失败，"}${E}`,level:S?"success":"error",output:o,progress:i,clientId:r})},downLoadJson:async function(e){let t,n,i;const o=qh.join(e.workspaceFolder.uri.fsPath,`/uniCloud-${e.provider}/database`),r=e?.dbFolder?.path;if(Zh(r))return;t=e.workspaceFolder,n=e.provider,i=e.spaceId;let s=Mh.window.createOutputView({id:`${t.id}-unicloud`,title:`[${t.name}] - unicloud控制台`});await Uh.window.withProgress({cancellable:!0,location:{parentId:e.parentId}},(async e=>{}));let a,{spaceName:c}=await Gh(t,o),l=`[${zh(n)}:${c}]`;Kh({message:`${l}开始下载Schema扩展Js的配置`,output:s});try{a=await Mh.http.request({url:"https://ide.liuyingyong.cn/serverless/commonModule/download-jql",method:"post",connectionTimeout:1e3,readTimeout:5e3,serviceOptions:{serviceRequest:!0,body:{provider:n,spaceId:i,appid:e.appId}}})}catch(e){Kh({message:`${l}Schema扩展Js的配置文件下载失败：${JSON.stringify(e)}`,level:"error",output:s})}let u=a.data;if("string"==typeof u&&(u=JSON.parse(u)),1001===a.service.code&&u){const e=u.body[0].name,t=u.body[0].content,n=qh.join(o,`/${e}`);Wh.open(n,"w+",(function(e,n){if(e)throw e;Wh.writeSync(n,t,0,"utf-8"),Wh.close(n,(function(e){if(e)throw e}))})),Kh({message:`${l}Schema扩展Js的配置文件下载成功`,level:"success",output:s})}}},Xh=C.default,Qh=Yh,em={activate:function(e){let t=Xh.commands.registerCommand("uniCloud.synchronouDependencies",(e=>{Qh.uploadJson({caller:1,...e})}));return Xh.commands.registerCliCommand("uniCloud.synchronouDependencies",(e=>{const{path:t}=e;Qh.uploadJson({caller:3,...e,fsPath:t})})),e.subscriptions.push(t),{synchronouDependencies:Qh.uploadJson,downLoadJson:Qh.downLoadJson}},deactivate:function(){}};function tm(e,t,n,i){var o,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(r<3?o(s):r>3?o(t,n,s):o(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s}function nm(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((i=i.apply(e,t||[])).next())}))}class im extends Error{constructor(e){const{message:t,code:n}=e||{};super(t),this.code=n}}function om(e){return nm(this,void 0,void 0,(function*(){return function(e){!function(e){if(e.error)throw new im({message:`请求服务失败：${JSON.stringify(e.error)}${e.data?"\n"+e.data:e.data}`,code:"REQUEST_ERROR"});if(e.httpStatusCode>=400)throw new im({message:`网络请求错误，状态码：${e.httpStatusCode}${e.data?"\n"+e.data:e.data}`,code:e.httpStatusCode})}(e);const t=JSON.parse(e.data),n=t.header&&t.header.result,i=n&&n.rspcode,o=n&&n.rspdesc;if("1001"!==i)throw new im({code:"REQUEST_ERROR",message:`请求DCloud服务失败：错误码为：${i}，详细错误信息为：${o}`});return t.body}(yield function(e){return nm(this,void 0,void 0,(function*(){return C.default.http.request(Object.assign(Object.assign({},e),{dataType:void 0}))}))}({url:`https://ide.liuyingyong.cn${e.path}`,method:e.method,dataType:e.dataType,params:{param:JSON.stringify({header:{token:"${user.checked.token}"},body:e.body})}}))}))}const rm=Symbol("CONTEXT_STORAGE");function sm(){return global[rm]||(global[rm]=new n.AsyncLocalStorage),global[rm]}function am(){const e=sm().getStore();if(!e)throw new Error("context is not exist");return e}function cm(){var e;return null===(e=am())||void 0===e?void 0:e.outputView}class lm extends Map{saveCommand(e,t,n){if(this.has(e))throw new Error(`Command ${e} already exists`);this.set(e,{type:"command",target:t,options:n})}saveCliCommand(e,t,n){if(this.has(e))throw new Error(`CliCommand ${e} already exists`);this.set(e,{type:"cliCommand",target:t,options:n})}saveAppService(e,t,n){if(this.has(e))throw new Error(`AppService ${e} already exists`);this.set(e,{type:"appService",target:t,options:n})}saveCustomEditor(e,t,n){if(this.has(e))throw new Error(`CustomEditor ${e} already exists`);this.set(e,{type:"customEditor",target:t,options:n})}saveLauncher(e,t,n){if(this.has(e))throw new Error(`Launcher ${e} already exists`);this.set(e,{type:"launcher",target:t,options:n})}}const um=new lm,dm=new i.EventEmitter;function pm(e){return function(t,n){Object.defineProperty(t,n,{get:function(){return new e(this)}})}}function fm(){return function(e,t){Object.defineProperty(e,t,{get:function(){return am()}})}}function hm(e,t){return function(n){return um.saveCliCommand(e,n,t),n}}class mm{constructor(e){this.workspaceFolder=e.workspaceFolder,this.triggerType=e.triggerType,this.cliConsoleConfig=e.cliConsoleConfig,this.isCli="cliCommand"===this.triggerType,this.console=this.createLog()}createLog(){return this.isCli?C.default.cliconsole:this.workspaceFolder?C.default.window.createOutputView({id:`${this.workspaceFolder.id}-unicloud`,title:`[${this.workspaceFolder.name}] - unicloud控制台`}):C.default.window.createOutputChannel("unicloud")}appendLine(e){return nm(this,void 0,void 0,(function*(){const{line:t,status:n="info"}=e;this.isCli?yield this.console.log({clientId:this.cliConsoleConfig.clientId,msg:t,status:n,hideTime:!0}):yield this.console.appendLine(e)}))}show(){var e,t;null===(t=null===(e=this.console)||void 0===e?void 0:e.show)||void 0===t||t.call(e)}}class gm{isDebug(){return O.default.existsSync(E.default.resolve(__dirname,"dcloud.debug"))}resolve(e){return nm(this,void 0,void 0,(function*(){const{_params:t,_triggerType:n}=this.context,{workspaceFolder:i,fsPath:o,cliconsole:r}=t,s=Boolean("cliCommand"===n||(null==r?void 0:r.clientId));if(this.context.isDebug=this.isDebug(),this.context.isCli=s,this.context.workspaceFolder=i,this.context.fsPath=o,this.context.outputView=new mm({workspaceFolder:i,triggerType:n,cliConsoleConfig:r}),yield e(),this.context._return)return this.context._return}))}}tm([fm()],gm.prototype,"context",void 0);class ym{resolve(e){return nm(this,void 0,void 0,(function*(){const{_params:t,_triggerType:n}=this.context,{workspaceFolder:i}=t;if("command"===n&&!i.appid)throw new Error("请先绑定AppId");yield e()}))}}tm([fm()],ym.prototype,"context",void 0);class vm{uncaughtException(e){return nm(this,void 0,void 0,(function*(){e.message&&(yield this.context.outputView.appendLine({level:"error",status:"error",line:this.getErrorMessage(e)}))}))}resolve(e){return nm(this,void 0,void 0,(function*(){const{_triggerType:t,_commandOptions:n}=this.context;dm.on("uncaughtException",this.uncaughtException.bind(this));try{yield e(),"cliCommand"===t&&(yield this.context.outputView.appendLine({level:"error",status:"error",line:`0:${n.commandName}:OK`}))}catch(e){e.message&&(yield this.context.outputView.appendLine({level:"error",status:"error",line:this.getErrorMessage(e)}))}dm.off("uncaughtException",this.uncaughtException.bind(this))}))}getErrorMessage(e){const{isDebug:t,_triggerType:n,_commandOptions:i}=this.context,o=t?e.stack:e.message;return"cliCommand"!==n?o:`-1:${i.commandName}:${o}`}}tm([fm()],vm.prototype,"context",void 0);const wm={command:{commandAlias:"invoke",command:"registerCommand",group:"commands"},cliCommand:{commandAlias:"invoke",command:"registerCliCommand",group:"commands"},appService:{commandAlias:"invoke",command:"registerAppService",group:"app"},customEditor:{commandAlias:"invoke",command:"registerCustomEditorProvider",group:"window",useInstance:!0},launcher:{commandAlias:"invoke",command:"registerWorkspaceFolderLauncher",group:"workspace",useInstance:!0}};function xm(e,t,n,i){const{value:o,key:r}=i,{options:s={}}=o,a=s.middleware||[],c={_params:t.document?t.document:t,_triggerType:o.type,_commandOptions:Object.assign({},s,{commandName:r})};return sm().run(c,(()=>{var t;return function(e){if(!Array.isArray(e))throw new Error("middleware stack must be an array!");for(const t of e)if("function"!=typeof t)throw new TypeError("middleware must be composed of functions!");return function t(){const n=e.shift();if(!n)return Promise.resolve();try{const e=new n;return Promise.resolve(e.resolve(t))}catch(e){return Promise.reject(e)}}()}(null===(t=n.middleware)||void 0===t?void 0:t.concat(a).concat(e)).catch((e=>dm.emit("uncaughtException",e)))}))}function bm({workspaceFolder:e}){var t;return nm(this,void 0,void 0,(function*(){const{email:n}=yield C.default.authorize.requestUserInfo(),i=((yield C.default.workspace.getConfiguration("",e)).get("uniCloud")||{})[n]||{},o=O.default.readdirSync(e.uri.fsPath).filter((e=>/^uniCloud-(tcb|aliyun|alipay)$/.test(e))).map((e=>{var t;return null===(t=e.match(/^uniCloud-(tcb|aliyun|alipay)$/))||void 0===t?void 0:t[1]})).filter(Boolean),r=[];for(const e of o){const t=i[e];if(!t||!t.selected)continue;const n=t.spaces.find((e=>e.spaceid===t.selected));r.push({provider:e,spaceId:t.selected,spaceName:null==n?void 0:n.name,relatedProjectId:t.related&&t.related.projectid,clientSecret:null==n?void 0:n.clientSecret,accessKey:null==n?void 0:n.accessKey,secretKey:null==n?void 0:n.secretKey,spaceAppId:null==n?void 0:n.spaceAppId,apiEndpoint:null==n?void 0:n.apiEndpoint})}return Object.assign(Object.assign({},null!==(t=null==r?void 0:r[0])&&void 0!==t?t:{}),{allSpaces:r})}))}class Sm{constructor(){this.providerNameList={tcb:"腾讯云",aliyun:"阿里云",alipay:"支付宝云"}}transformProvider(e){return this.providerNameList[e]}getBindSpace(){var e;return nm(this,void 0,void 0,(function*(){const{fsPath:t,workspaceFolder:n,properties:i={},specifySpace:o}=this.context._params,r=null===(e=null==t?void 0:t.match(/uniCloud-(tcb|aliyun|alipay)/))||void 0===e?void 0:e[1];let s=i.provider||r;const a=Object.keys(this.providerNameList).reduce(((e,t)=>(e[this.providerNameList[t]]=t,e)),{});if(o)return Object.assign({},o,{providerName:this.providerNameList[o.provider]});const{allSpaces:c}=yield bm({workspaceFolder:n});if(c.length<=0)throw new Error("请先关联云服务空间");if(1===c.length&&(s=c[0].provider),!s){const e=yield C.default.window.showMessageBox({type:"warning",title:"",text:`项目 ${E.default.parse(n.uri.fsPath).base} 同时绑定了多个云服务商，请为当前操作指定使用哪个`,buttons:[...c.map((e=>this.providerNameList[e.provider])),"取消"]});if("取消"===e)throw new Error("取消");s=a[e]}const l=c.find((e=>e.provider===s));return Object.assign({},l,{providerName:this.providerNameList[s]})}))}getSpaceInfo(e){return nm(this,void 0,void 0,(function*(){return(yield this.remoteService.getAllSpaceList()).find((t=>t.id===e||t.name===e))}))}}tm([fm()],Sm.prototype,"context",void 0),tm([pm(class{getAllSpaceList(){return nm(this,void 0,void 0,(function*(){const{spaces:e}=yield om({method:"post",path:"/serverless/space/list-all",dataType:"json",body:{}});return e}))}getAlipayUploadFileUrl(e){return nm(this,void 0,void 0,(function*(){return om({method:"post",path:"/serverless/host/get-upload-file-link",dataType:"json",body:e})}))}getAliyunUploadCredential(e){return nm(this,void 0,void 0,(function*(){const t=yield om({method:"post",path:"/serverless/host/aliyun-batch-upload-credential",dataType:"json",body:e});return{policy:t.Policy,securityToken:t.SecurityToken,endpoint:t.Endpoint,accessKeyId:t.AccessKeyId,signature:t.Signature,expiredTime:t.ExpiredTime,filePathPrefix:t.FilePathPrefix,remainedTime:t.RemainedTime}}))}getTcbUploadCredential(e){return nm(this,void 0,void 0,(function*(){const t=yield om({method:"post",path:"/serverless/host/tcb-sts-token",dataType:"json",body:e});return{bucket:t.bucket,region:t.region,expiredTime:t.expiredTime,sessionToken:t.credentials.sessionToken,tmpSecretId:t.credentials.tmpSecretId,tmpSecretKey:t.credentials.tmpSecretKey,startTime:t.startTime}}))}getWebHostInfo(e){return nm(this,void 0,void 0,(function*(){return om({method:"post",path:"/serverless/host/domains",dataType:"json",body:e})}))}getWebHostFileList(e){return nm(this,void 0,void 0,(function*(){const t=yield om({method:"post",path:"/serverless/host/file-list",dataType:"json",body:e});return t.files&&(t.files=t.files.map((e=>(e.createdAt=e.created_at,e.updatedAt=e.updated_at,e)))),t.lastPage=t.last_page,t.currentPage=t.current_page,t}))}deleteWebHostFile(e){return nm(this,void 0,void 0,(function*(){return om({method:"post",path:"/serverless/host/delete-file",dataType:"json",body:e})}))}})],Sm.prototype,"remoteService",void 0);const km=C.default.window.createOutputView({id:"uniCloud-Debug-output",title:"uniCloud插件调试控制台"});class Em{getUniCloudLogPrefix(){return nm(this,void 0,void 0,(function*(){if(this.context.isCli)return"";const{providerName:e,spaceName:t}=yield this.spaceService.getBindSpace();return`[${e}:${t}]`}))}writeDebug(...e){if(!this.context.isDebug)return;const t=e.map((e=>JSON.stringify(e))).join(" - ");return this.context.isCli?cm().appendLine({level:"info",line:`[debug] ${t}`}):(km.show(),km.appendLine({level:"info",line:t}))}writeUniCloudLog({level:e,message:t}){return nm(this,void 0,void 0,(function*(){const n=yield this.getRawUniCloudLog(t),i=cm();i.show(),yield i.appendLine({level:e,line:n})}))}getRawUniCloudLog(e){return nm(this,void 0,void 0,(function*(){return`${yield this.getUniCloudLogPrefix()}${e}`}))}getCliFormatLog(e,t=2){return nm(this,void 0,void 0,(function*(){const n=this.getColumnWidths(e);return e.reduce(((e,i)=>{const o=i.map(((e,i)=>e.padEnd(n[i]+t," "))).join("");return e.push(o.trimEnd()),e}),[])}))}getColumnWidths(e){const t=e.reduce(((e,t)=>Math.max(e,t.length)),0),n=[];for(let i=0;i<t;i++){const t=e.reduce(((e,t)=>(e.push(t[i]||""),e)),[]).reduce(((e,t)=>Math.max(e,t.length)),0);n.push(t)}return n}}function _m(e,t,n,i){var o,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(r<3?o(s):r>3?o(t,n,s):o(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s}function Cm(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((i=i.apply(e,t||[])).next())}))}tm([fm()],Em.prototype,"context",void 0),tm([pm(Sm)],Em.prototype,"spaceService",void 0);var Im={EOL:F.default.EOL||"\n",tryParseNumber:function(e,t){var n,i,o="",r=0,s=!0,a=0;function c(){return i=e.charAt(a),a++,i}for(c(),"-"===i&&(o="-",c());i>="0"&&i<="9";)s&&("0"==i?r++:s=!1),o+=i,c();if(s&&r--,"."===i)for(o+=".";c()&&i>="0"&&i<="9";)o+=i;if("e"===i||"E"===i)for(o+=i,c(),"-"!==i&&"+"!==i||(o+=i,c());i>="0"&&i<="9";)o+=i,c();for(;i&&i<=" ";)c();return t&&(","!==i&&"}"!==i&&"]"!==i&&"#"!==i&&("/"!==i||"/"!==e[a]&&"*"!==e[a])||(i=0)),n=+o,i||r||!isFinite(n)?void 0:n},createComment:function(e,t){return Object.defineProperty&&Object.defineProperty(e,"__COMMENTS__",{enumerable:!1,writable:!0}),e.__COMMENTS__=t||{}},removeComment:function(e){Object.defineProperty(e,"__COMMENTS__",{value:void 0})},getComment:function(e){return e.__COMMENTS__},forceComment:function(e){if(!e)return"";var t,n,i,o,r=e.split("\n");for(i=0;i<r.length;i++)for(o=(t=r[i]).length,n=0;n<o;n++){var s=t[n];if("#"===s)break;if("/"===s&&("/"===t[n+1]||"*"===t[n+1])){"*"===t[n+1]&&(i=r.length);break}if(s>" "){r[i]="# "+t;break}}return r.join("\n")}};function jm(e,t){if(e)for(var n=0;n<e.length;n++){var i=e[n](t);if(void 0!==i)return i}}function Om(){}function Pm(e){return"{"===e||"}"===e||"["===e||"]"===e||","===e}function Lm(){return{name:"math",parse:function(e){switch(e){case"+inf":case"inf":case"+Inf":case"Inf":return 1/0;case"-inf":case"-Inf":return-1/0;case"nan":case"NaN":return NaN}},stringify:function(e){if("number"==typeof e)return 1/e==-1/0?"-0":e===1/0?"Inf":e===-1/0?"-Inf":isNaN(e)?"NaN":void 0}}}function Nm(e){var t=e&&e.out;return{name:"hex",parse:function(e){if(/^0x[0-9A-Fa-f]+$/.test(e))return parseInt(e,16)},stringify:function(e){if(t&&Number.isInteger(e))return"0x"+e.toString(16)}}}function Fm(){return{name:"date",parse:function(e){if(/^\d{4}-\d{2}-\d{2}$/.test(e)||/^\d{4}-\d{2}-\d{2}T\d{2}\:\d{2}\:\d{2}(?:.\d+)(?:Z|[+-]\d{2}:\d{2})$/.test(e)){var t=Date.parse(e);if(!isNaN(t))return new Date(t)}},stringify:function(e){if("[object Date]"===Object.prototype.toString.call(e)){var t=e.toISOString();return-1!==t.indexOf("T00:00:00.000Z",t.length-14)?t.substr(0,10):t}}}}Lm.description="support for Inf/inf, -Inf/-inf, Nan/naN and -0",Nm.description="parse hexadecimal numbers prefixed with 0x",Fm.description="support ISO dates";var Tm={loadDsf:function(e,t){if("[object Array]"!==Object.prototype.toString.apply(e)){if(e)throw new Error("dsf option must contain an array!");return Om}if(0===e.length)return Om;var n=[];function i(e){return"[object Function]"==={}.toString.call(e)}return e.forEach((function(e){if(!e.name||!i(e.parse)||!i(e.stringify))throw new Error("extension does not match the DSF interface");n.push((function(){try{if("parse"==t)return e.parse.apply(null,arguments);if("stringify"==t){var n=e.stringify.apply(null,arguments);if(void 0!==n&&("string"!=typeof n||0===n.length||'"'===n[0]||[].some.call(n,(function(e){return Pm(e)}))))throw new Error("value may not be empty, start with a quote or contain a punctuator character except colon: "+n);return n}throw new Error("Invalid type")}catch(t){throw new Error("DSF-"+e.name+" failed; "+t.message)}}))})),jm.bind(null,n)},std:{math:Lm,hex:Nm,date:Fm}},Dm=function(e,t){var n,i,o,r,s,a=Im,c=Tm,l={'"':'"',"'":"'","\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"};function u(){i=0,o=" "}function d(e){return"{"===e||"}"===e||"["===e||"]"===e||","===e||":"===e}function p(e){var t,o=0,r=1;for(t=i-1;t>0&&"\n"!==n[t];t--,o++);for(;t>0;t--)"\n"===n[t]&&r++;throw new Error(e+" at line "+r+","+o+" >>>"+n.substr(i-o,20)+" ...")}function f(){return o=n.charAt(i),i++,o}function h(e){return n.charAt(i+e)}function m(e){for(var t="",n=o;f();){if(o===n)return f(),e&&"'"===n&&"'"===o&&0===t.length?(f(),g()):t;if("\\"===o)if(f(),"u"===o){for(var i=0,r=0;r<4;r++){f();var s,a=o.charCodeAt(0);o>="0"&&o<="9"?s=a-48:o>="a"&&o<="f"?s=a-97+10:o>="A"&&o<="F"?s=a-65+10:p("Bad \\u char "+o),i=16*i+s}t+=String.fromCharCode(i)}else{if("string"!=typeof l[o])break;t+=l[o]}else"\n"===o||"\r"===o?p("Bad string containing newline"):t+=o}p("Bad string")}function g(){for(var e="",t=0,n=0;;){var i=h(-n-5);if(!i||"\n"===i)break;n++}function r(){for(var e=n;o&&o<=" "&&"\n"!==o&&e-- >0;)f()}for(;o&&o<=" "&&"\n"!==o;)f();for("\n"===o&&(f(),r());;){if(o){if("'"===o){if(t++,f(),3===t)return"\n"===e.slice(-1)&&(e=e.slice(0,-1)),e;continue}for(;t>0;)e+="'",t--}else p("Bad multiline string");"\n"===o?(e+="\n",f(),r()):("\r"!==o&&(e+=o),f())}}function y(){if('"'===o||"'"===o)return m(!1);for(var e="",t=i,n=-1;;){if(":"===o)return e?n>=0&&n!==e.length&&(i=t+n,p("Found whitespace in your key name (use quotes to include)")):p("Found ':' but no key name (for an empty key name use quotes)"),e;o<=" "?o?n<0&&(n=e.length):p("Found EOF while looking for a key name (check your syntax)"):d(o)?p("Found '"+o+"' where a key name was expected (check your syntax or use quotes if the key name includes {}[],: or whitespace)"):e+=o,f()}}function v(){for(;o;){for(;o&&o<=" ";)f();if("#"===o||"/"===o&&"/"===h(0))for(;o&&"\n"!==o;)f();else{if("/"!==o||"*"!==h(0))break;for(f(),f();o&&("*"!==o||"/"!==h(0));)f();o&&(f(),f())}}}function w(e,t){var o;for(e--,o=i-2;o>e&&n[o]<=" "&&"\n"!==n[o];o--);"\n"===n[o]&&o--,"\r"===n[o]&&o--;var r=n.substr(e,o-e+1);for(o=0;o<r.length;o++)if(r[o]>" "){var s=r.indexOf("\n");if(s>=0){var a=[r.substr(0,s),r.substr(s+1)];return t&&0===a[0].trim().length&&a.shift(),a}return[r]}return[]}function x(e){function t(e,n){var i,o,r,s;switch(typeof e){case"string":e.indexOf(n)>=0&&(s=e);break;case"object":if("[object Array]"===Object.prototype.toString.apply(e))for(i=0,r=e.length;i<r;i++)s=t(e[i],n)||s;else for(o in e)Object.prototype.hasOwnProperty.call(e,o)&&(s=t(e[o],n)||s)}return s}function n(n){var i=t(e,n);return i?"found '"+n+"' in a string value, your mistake could be with:\n  > "+i+"\n  (unquoted strings contain everything up to the next line!)":""}return n("}")||n("]")}function b(){var e,t,n,s=[];try{if(r&&(e=a.createComment(s,{a:[]})),f(),t=i,v(),e&&(n=w(t,!0).join("\n")),"]"===o)return f(),e&&(e.e=[n]),s;for(;o;){if(s.push(E()),t=i,v(),","===o&&(f(),t=i,v()),e){var c=w(t);e.a.push([n||"",c[0]||""]),n=c[1]}if("]"===o)return f(),e&&(e.a[e.a.length-1][1]+=n||""),s;v()}p("End of input while parsing an array (missing ']')")}catch(e){throw e.hint=e.hint||x(s),e}}function S(e){var t,n,s,c="",l={};try{if(r&&(t=a.createComment(l,{c:{},o:[]})),e?n=1:(f(),n=i),v(),t&&(s=w(n,!0).join("\n")),"}"===o&&!e)return t&&(t.e=[s]),f(),l;for(;o;){if(c=y(),v(),":"!==o&&p("Expected ':' instead of '"+o+"'"),f(),l[c]=E(),n=i,v(),","===o&&(f(),n=i,v()),t){var u=w(n);t.c[c]=[s||"",u[0]||""],s=u[1],t.o.push(c)}if("}"===o&&!e)return f(),t&&(t.c[c][1]+=s||""),l;v()}if(e)return l;p("End of input while parsing an object (missing '}')")}catch(e){throw e.hint=e.hint||x(l),e}}function E(){switch(v(),o){case"{":return S();case"[":return b();case"'":case'"':return m(!0);default:return function(){var e=o;for(d(o)&&p("Found a punctuator character '"+o+"' when expecting a quoteless string (check your syntax)");;){f();var t="\r"===o||"\n"===o||""===o;if(t||","===o||"}"===o||"]"===o||"#"===o||"/"===o&&("/"===h(0)||"*"===h(0))){var n=e[0];switch(n){case"f":if("false"===e.trim())return!1;break;case"n":if("null"===e.trim())return null;break;case"t":if("true"===e.trim())return!0;break;default:if("-"===n||n>="0"&&n<="9"){var i=a.tryParseNumber(e);if(void 0!==i)return i}}if(t){e=e.trim();var r=s(e);return void 0!==r?r:e}}e+=o}}()}}function C(e,t){var n=i;if(v(),o&&p("Syntax error, found trailing characters"),r){var s=t.join("\n"),c=w(n).join("\n");(c||s)&&(a.createComment(e,a.getComment(e)).r=[s,c])}return e}if("string"!=typeof e)throw new Error("source is not a string");var k=null,_=!0;return t&&"object"==typeof t&&(r=t.keepWsc,k=t.dsf,_=!1!==t.legacyRoot),s=c.loadDsf(k,"parse"),n=e,u(),_?function(){v();var e=r?w(1):null;switch(o){case"{":return C(S(),e);case"[":return C(b(),e)}try{return C(S(!0),e)}catch(t){u();try{return C(E(),e)}catch(e){throw t}}}():function(){v();var e=r?w(1):null;switch(o){case"{":return C(S(),e);case"[":return C(b(),e);default:return C(E(),e)}}()},$m=Dm;function Rm(e){return[E.default.resolve(e,"src","manifest.json"),E.default.resolve(e,"src","pages.json")].every((e=>O.default.existsSync(e)))}function Am(e,t){if(!O.default.existsSync(e))return;const n=[],i=O.default.readdirSync(e);for(const o of i){if(t&&t.test(o))continue;const i=E.default.join(e,o),r=O.default.statSync(i);r.isFile()&&n.push(i),r.isDirectory()&&n.push(...Am(i,t))}return n}process.env.UNICLOUD_DEBUGGER_PATH||E.default.resolve(__dirname,"../");class Bm{constructor(){this._shouldUseCache=!1,this._cachedBuffer=null,this._lineBreak="\r\n",this._boundary="------FormDataBaseBoundary"+Math.random().toString(36).substring(2),this.dataList=[]}_addData(e){if(this._shouldUseCache=!1,0===this.dataList.length)return void this.dataList.push(e);const t=this.dataList[this.dataList.length-1];switch(`${Buffer.isBuffer(t)?"buffer":"other"}_${Buffer.isBuffer(e)?"buffer":"other"}`){case"buffer_buffer":this.dataList.push(this._lineBreak),this.dataList.push(e);break;case"buffer_other":this.dataList.push(this._lineBreak+e);break;case"other_buffer":this.dataList[this.dataList.length-1]=t+"\r\n",this.dataList.push(e);break;case"other_other":this.dataList[this.dataList.length-1]=t+"\r\n"+e}}append(e,t,n){this._addData("--"+this._boundary);let i=`Content-Disposition: form-data; name="${encodeURIComponent(e)}"`;if(Buffer.isBuffer(t)){if(!n.filename||!n.contentType)throw new Error("filename and contentType required");i+=`; filename="${encodeURIComponent(n.filename)}"`,this._addData(i),this._addData(`Content-Type: ${n.contentType}`),this._addData(""),this._addData(t)}else this._addData(i),this._addData(""),this._addData(t)}getHeaders(e){const t={"Content-Type":"multipart/form-data; boundary="+this._boundary};return Object.assign(t,e)}getBuffer(){if(this._shouldUseCache)return this._cachedBuffer;this._shouldUseCache=!0;let e=Buffer.alloc(0);return this.dataList.forEach((t=>{e=Buffer.isBuffer(t)?Buffer.concat([e,t]):Buffer.concat([e,Buffer.from(""+t)])})),e=Buffer.concat([e,Buffer.from(`${this._lineBreak}--${this._boundary}--`)]),this._cachedBuffer=e,e}}const Mm={"application/andrew-inset":["ez"],"application/appinstaller":["appinstaller"],"application/applixware":["aw"],"application/appx":["appx"],"application/appxbundle":["appxbundle"],"application/atom+xml":["atom"],"application/atomcat+xml":["atomcat"],"application/atomdeleted+xml":["atomdeleted"],"application/atomsvc+xml":["atomsvc"],"application/atsc-dwd+xml":["dwd"],"application/atsc-held+xml":["held"],"application/atsc-rsat+xml":["rsat"],"application/automationml-aml+xml":["aml"],"application/automationml-amlx+zip":["amlx"],"application/bdoc":["bdoc"],"application/calendar+xml":["xcs"],"application/ccxml+xml":["ccxml"],"application/cdfx+xml":["cdfx"],"application/cdmi-capability":["cdmia"],"application/cdmi-container":["cdmic"],"application/cdmi-domain":["cdmid"],"application/cdmi-object":["cdmio"],"application/cdmi-queue":["cdmiq"],"application/cpl+xml":["cpl"],"application/cu-seeme":["cu"],"application/cwl":["cwl"],"application/dash+xml":["mpd"],"application/dash-patch+xml":["mpp"],"application/davmount+xml":["davmount"],"application/docbook+xml":["dbk"],"application/dssc+der":["dssc"],"application/dssc+xml":["xdssc"],"application/ecmascript":["ecma"],"application/emma+xml":["emma"],"application/emotionml+xml":["emotionml"],"application/epub+zip":["epub"],"application/exi":["exi"],"application/express":["exp"],"application/fdf":["fdf"],"application/fdt+xml":["fdt"],"application/font-tdpfr":["pfr"],"application/geo+json":["geojson"],"application/gml+xml":["gml"],"application/gpx+xml":["gpx"],"application/gxf":["gxf"],"application/gzip":["gz"],"application/hjson":["hjson"],"application/hyperstudio":["stk"],"application/inkml+xml":["ink","inkml"],"application/ipfix":["ipfix"],"application/its+xml":["its"],"application/java-archive":["jar","war","ear"],"application/java-serialized-object":["ser"],"application/java-vm":["class"],"application/javascript":["js"],"application/json":["json","map"],"application/json5":["json5"],"application/jsonml+json":["jsonml"],"application/ld+json":["jsonld"],"application/lgr+xml":["lgr"],"application/lost+xml":["lostxml"],"application/mac-binhex40":["hqx"],"application/mac-compactpro":["cpt"],"application/mads+xml":["mads"],"application/manifest+json":["webmanifest"],"application/marc":["mrc"],"application/marcxml+xml":["mrcx"],"application/mathematica":["ma","nb","mb"],"application/mathml+xml":["mathml"],"application/mbox":["mbox"],"application/media-policy-dataset+xml":["mpf"],"application/mediaservercontrol+xml":["mscml"],"application/metalink+xml":["metalink"],"application/metalink4+xml":["meta4"],"application/mets+xml":["mets"],"application/mmt-aei+xml":["maei"],"application/mmt-usd+xml":["musd"],"application/mods+xml":["mods"],"application/mp21":["m21","mp21"],"application/mp4":["mp4","mpg4","mp4s","m4p"],"application/msix":["msix"],"application/msixbundle":["msixbundle"],"application/msword":["doc","dot"],"application/mxf":["mxf"],"application/n-quads":["nq"],"application/n-triples":["nt"],"application/node":["cjs"],"application/octet-stream":["bin","dms","lrf","mar","so","dist","distz","pkg","bpk","dump","elc","deploy","exe","dll","deb","dmg","iso","img","msi","msp","msm","buffer"],"application/oda":["oda"],"application/oebps-package+xml":["opf"],"application/ogg":["ogx"],"application/omdoc+xml":["omdoc"],"application/onenote":["onetoc","onetoc2","onetmp","onepkg"],"application/oxps":["oxps"],"application/p2p-overlay+xml":["relo"],"application/patch-ops-error+xml":["xer"],"application/pdf":["pdf"],"application/pgp-encrypted":["pgp"],"application/pgp-keys":["asc"],"application/pgp-signature":["sig","asc"],"application/pics-rules":["prf"],"application/pkcs10":["p10"],"application/pkcs7-mime":["p7m","p7c"],"application/pkcs7-signature":["p7s"],"application/pkcs8":["p8"],"application/pkix-attr-cert":["ac"],"application/pkix-cert":["cer"],"application/pkix-crl":["crl"],"application/pkix-pkipath":["pkipath"],"application/pkixcmp":["pki"],"application/pls+xml":["pls"],"application/postscript":["ai","eps","ps"],"application/provenance+xml":["provx"],"application/pskc+xml":["pskcxml"],"application/raml+yaml":["raml"],"application/rdf+xml":["rdf","owl"],"application/reginfo+xml":["rif"],"application/relax-ng-compact-syntax":["rnc"],"application/resource-lists+xml":["rl"],"application/resource-lists-diff+xml":["rld"],"application/rls-services+xml":["rs"],"application/route-apd+xml":["rapd"],"application/route-s-tsid+xml":["sls"],"application/route-usd+xml":["rusd"],"application/rpki-ghostbusters":["gbr"],"application/rpki-manifest":["mft"],"application/rpki-roa":["roa"],"application/rsd+xml":["rsd"],"application/rss+xml":["rss"],"application/rtf":["rtf"],"application/sbml+xml":["sbml"],"application/scvp-cv-request":["scq"],"application/scvp-cv-response":["scs"],"application/scvp-vp-request":["spq"],"application/scvp-vp-response":["spp"],"application/sdp":["sdp"],"application/senml+xml":["senmlx"],"application/sensml+xml":["sensmlx"],"application/set-payment-initiation":["setpay"],"application/set-registration-initiation":["setreg"],"application/shf+xml":["shf"],"application/sieve":["siv","sieve"],"application/smil+xml":["smi","smil"],"application/sparql-query":["rq"],"application/sparql-results+xml":["srx"],"application/sql":["sql"],"application/srgs":["gram"],"application/srgs+xml":["grxml"],"application/sru+xml":["sru"],"application/ssdl+xml":["ssdl"],"application/ssml+xml":["ssml"],"application/swid+xml":["swidtag"],"application/tei+xml":["tei","teicorpus"],"application/thraud+xml":["tfi"],"application/timestamped-data":["tsd"],"application/toml":["toml"],"application/trig":["trig"],"application/ttml+xml":["ttml"],"application/ubjson":["ubj"],"application/urc-ressheet+xml":["rsheet"],"application/urc-targetdesc+xml":["td"],"application/voicexml+xml":["vxml"],"application/wasm":["wasm"],"application/watcherinfo+xml":["wif"],"application/widget":["wgt"],"application/winhlp":["hlp"],"application/wsdl+xml":["wsdl"],"application/wspolicy+xml":["wspolicy"],"application/xaml+xml":["xaml"],"application/xcap-att+xml":["xav"],"application/xcap-caps+xml":["xca"],"application/xcap-diff+xml":["xdf"],"application/xcap-el+xml":["xel"],"application/xcap-ns+xml":["xns"],"application/xenc+xml":["xenc"],"application/xfdf":["xfdf"],"application/xhtml+xml":["xhtml","xht"],"application/xliff+xml":["xlf"],"application/xml":["xml","xsl","xsd","rng"],"application/xml-dtd":["dtd"],"application/xop+xml":["xop"],"application/xproc+xml":["xpl"],"application/xslt+xml":["xsl","xslt"],"application/xspf+xml":["xspf"],"application/xv+xml":["mxml","xhvml","xvml","xvm"],"application/yang":["yang"],"application/yin+xml":["yin"],"application/zip":["zip"],"audio/3gpp":["3gpp"],"audio/aac":["adts","aac"],"audio/adpcm":["adp"],"audio/amr":["amr"],"audio/basic":["au","snd"],"audio/midi":["mid","midi","kar","rmi"],"audio/mobile-xmf":["mxmf"],"audio/mp3":["mp3"],"audio/mp4":["m4a","mp4a"],"audio/mpeg":["mpga","mp2","mp2a","mp3","m2a","m3a"],"audio/ogg":["oga","ogg","spx","opus"],"audio/s3m":["s3m"],"audio/silk":["sil"],"audio/wav":["wav"],"audio/wave":["wav"],"audio/webm":["weba"],"audio/xm":["xm"],"font/collection":["ttc"],"font/otf":["otf"],"font/ttf":["ttf"],"font/woff":["woff"],"font/woff2":["woff2"],"image/aces":["exr"],"image/apng":["apng"],"image/avci":["avci"],"image/avcs":["avcs"],"image/avif":["avif"],"image/bmp":["bmp","dib"],"image/cgm":["cgm"],"image/dicom-rle":["drle"],"image/dpx":["dpx"],"image/emf":["emf"],"image/fits":["fits"],"image/g3fax":["g3"],"image/gif":["gif"],"image/heic":["heic"],"image/heic-sequence":["heics"],"image/heif":["heif"],"image/heif-sequence":["heifs"],"image/hej2k":["hej2"],"image/hsj2":["hsj2"],"image/ief":["ief"],"image/jls":["jls"],"image/jp2":["jp2","jpg2"],"image/jpeg":["jpeg","jpg","jpe"],"image/jph":["jph"],"image/jphc":["jhc"],"image/jpm":["jpm","jpgm"],"image/jpx":["jpx","jpf"],"image/jxr":["jxr"],"image/jxra":["jxra"],"image/jxrs":["jxrs"],"image/jxs":["jxs"],"image/jxsc":["jxsc"],"image/jxsi":["jxsi"],"image/jxss":["jxss"],"image/ktx":["ktx"],"image/ktx2":["ktx2"],"image/png":["png"],"image/sgi":["sgi"],"image/svg+xml":["svg","svgz"],"image/t38":["t38"],"image/tiff":["tif","tiff"],"image/tiff-fx":["tfx"],"image/webp":["webp"],"image/wmf":["wmf"],"message/disposition-notification":["disposition-notification"],"message/global":["u8msg"],"message/global-delivery-status":["u8dsn"],"message/global-disposition-notification":["u8mdn"],"message/global-headers":["u8hdr"],"message/rfc822":["eml","mime"],"model/3mf":["3mf"],"model/gltf+json":["gltf"],"model/gltf-binary":["glb"],"model/iges":["igs","iges"],"model/jt":["jt"],"model/mesh":["msh","mesh","silo"],"model/mtl":["mtl"],"model/obj":["obj"],"model/prc":["prc"],"model/step+xml":["stpx"],"model/step+zip":["stpz"],"model/step-xml+zip":["stpxz"],"model/stl":["stl"],"model/u3d":["u3d"],"model/vrml":["wrl","vrml"],"model/x3d+binary":["x3db","x3dbz"],"model/x3d+fastinfoset":["x3db"],"model/x3d+vrml":["x3dv","x3dvz"],"model/x3d+xml":["x3d","x3dz"],"model/x3d-vrml":["x3dv"],"text/cache-manifest":["appcache","manifest"],"text/calendar":["ics","ifb"],"text/coffeescript":["coffee","litcoffee"],"text/css":["css"],"text/csv":["csv"],"text/html":["html","htm","shtml"],"text/jade":["jade"],"text/javascript":["js","mjs"],"text/jsx":["jsx"],"text/less":["less"],"text/markdown":["md","markdown"],"text/mathml":["mml"],"text/mdx":["mdx"],"text/n3":["n3"],"text/plain":["txt","text","conf","def","list","log","in","ini"],"text/richtext":["rtx"],"text/rtf":["rtf"],"text/sgml":["sgml","sgm"],"text/shex":["shex"],"text/slim":["slim","slm"],"text/spdx":["spdx"],"text/stylus":["stylus","styl"],"text/tab-separated-values":["tsv"],"text/troff":["t","tr","roff","man","me","ms"],"text/turtle":["ttl"],"text/uri-list":["uri","uris","urls"],"text/vcard":["vcard"],"text/vtt":["vtt"],"text/wgsl":["wgsl"],"text/xml":["xml"],"text/yaml":["yaml","yml"],"video/3gpp":["3gp","3gpp"],"video/3gpp2":["3g2"],"video/h261":["h261"],"video/h263":["h263"],"video/h264":["h264"],"video/iso.segment":["m4s"],"video/jpeg":["jpgv"],"video/jpm":["jpm","jpgm"],"video/mj2":["mj2","mjp2"],"video/mp2t":["ts"],"video/mp4":["mp4","mp4v","mpg4"],"video/mpeg":["mpeg","mpg","mpe","m1v","m2v"],"video/ogg":["ogv"],"video/quicktime":["qt","mov"],"video/webm":["webm"]},Um=new Map;for(let[e,t]of Object.entries(Mm)){e=e.toLowerCase(),t=t.map((e=>e.toLowerCase()));for(const n of t)Um.set(n,e)}function qm(e){if("string"!=typeof e)return null;const t=e.replace(/^.*[/\\]/,"").toLowerCase(),n=t.replace(/^.*\./,"").toLowerCase(),i=t.length<e.length;return n.length<t.length-1||!i?Um.get(n)??"application/octet-stream":null}class Wm extends Error{constructor(e){const{message:t,code:n}=e||{};super(t),this.code=n}}function Jm(e){return Cm(this,void 0,void 0,(function*(){const t=yield function(e){return Cm(this,void 0,void 0,(function*(){return C.default.http.request(Object.assign(Object.assign({},e),{dataType:void 0}))}))}({url:`https://ide.liuyingyong.cn${e.path}`,method:e.method,dataType:e.dataType,params:{param:JSON.stringify({header:{token:"${user.checked.token}"},body:e.body})}});return function(e){!function(e){if(e.error)throw new Wm({message:`请求服务失败：${JSON.stringify(e.error)}${e.data?"\n"+e.data:e.data}`,code:"REQUEST_ERROR"});if(e.httpStatusCode>=400)throw new Wm({message:`网络请求错误，状态码：${e.httpStatusCode}${e.data?"\n"+e.data:e.data}`,code:e.httpStatusCode})}(e);const t=JSON.parse(e.data),n=t.header&&t.header.result,i=n&&n.rspcode,o=n&&n.rspdesc;if("1001"!==i)throw new Wm({code:"REQUEST_ERROR",message:`请求DCloud服务失败：错误码为：${i}，详细错误信息为：${o}`});return t.body}(t)}))}class Hm{getAllSpaceList(){return Cm(this,void 0,void 0,(function*(){const{spaces:e}=yield Jm({method:"post",path:"/serverless/space/list-all",dataType:"json",body:{}});return e}))}getAlipayUploadFileUrl(e){return Cm(this,void 0,void 0,(function*(){return Jm({method:"post",path:"/serverless/host/get-upload-file-link",dataType:"json",body:e})}))}getAliyunUploadCredential(e){return Cm(this,void 0,void 0,(function*(){const t=yield Jm({method:"post",path:"/serverless/host/aliyun-batch-upload-credential",dataType:"json",body:e});return{policy:t.Policy,securityToken:t.SecurityToken,endpoint:t.Endpoint,accessKeyId:t.AccessKeyId,signature:t.Signature,expiredTime:t.ExpiredTime,filePathPrefix:t.FilePathPrefix,remainedTime:t.RemainedTime}}))}getTcbUploadCredential(e){return Cm(this,void 0,void 0,(function*(){const t=yield Jm({method:"post",path:"/serverless/host/tcb-sts-token",dataType:"json",body:e});return{bucket:t.bucket,region:t.region,expiredTime:t.expiredTime,sessionToken:t.credentials.sessionToken,tmpSecretId:t.credentials.tmpSecretId,tmpSecretKey:t.credentials.tmpSecretKey,startTime:t.startTime}}))}getWebHostInfo(e){return Cm(this,void 0,void 0,(function*(){return Jm({method:"post",path:"/serverless/host/domains",dataType:"json",body:e})}))}getWebHostFileList(e){return Cm(this,void 0,void 0,(function*(){const t=yield Jm({method:"post",path:"/serverless/host/file-list",dataType:"json",body:e});return t.files&&(t.files=t.files.map((e=>(e.createdAt=e.created_at,e.updatedAt=e.updated_at,e)))),t.lastPage=t.last_page,t.currentPage=t.current_page,t}))}deleteWebHostFile(e){return Cm(this,void 0,void 0,(function*(){return Jm({method:"post",path:"/serverless/host/delete-file",dataType:"json",body:e})}))}}const Vm=require("cos-nodejs-sdk-v5");class zm{createUploadWebHostDialog(){const e=E.default.resolve(this.context.workspaceFolder.uri.fsPath,Rm(this.context.workspaceFolder.uri.fsPath)?"":"unpackage","dist","build","web"),t=O.default.existsSync(e);return bm({workspaceFolder:this.context.workspaceFolder}).then((({allSpaces:n})=>C.default.window.showFormDialog({title:"前端网页托管",footer:"<a href='https://hx.dcloud.net.cn/cli/uniCloud-hosting'><span style=\"color: #43C45B; font-size: 12px;\">前端网页托管cli教程</span></a>",submitButtonText:"上传(&U)",cancelButtonText:"取消(&C)",width:640,height:480,formItems:[{type:"vue:uploadWebHostDialog",name:"uploadWebHostDialog",value:{uploadDirPath:e,buildUniApp:!0,enableBuildApp:t,allBindSpaces:n}}],onChanged:function(e,t){"uploadWebHostDialog"===e&&(t.isLoading?this.showLoading({maskAt:"uploadWebHostDialog"}):this.hideLoading())},validate:function({uploadWebHostDialog:e}){return Cm(this,void 0,void 0,(function*(){const t=e.spaces.find((e=>e.selected));return!(!t||!t.openedHosting&&("去开通"===(yield C.default.window.showMessageBox({type:"warning",title:"",text:`服务空间${t.spaceName}未开通前端网页托管`,buttons:["去开通","取消"],defaultButton:0}))&&C.default.env.openExternal(`https://unicloud.dcloud.net.cn/pages/web-host/web-host?pageid=${t.spaceId}`),1))}))}})))}uploadWebHost(e,t,n=!1,i="/"){var o,r,s,a;return Cm(this,void 0,void 0,(function*(){const{workspaceFolder:c}=this.context,l=this.context.isCli?this.context.outputView:C.default.window.createOutputChannel("前端网页托管");if(n){const e=C.default.extensions.getExtension("uniapp-extension");if(!e)throw new Error("请安装uniapp-extension插件");const t=yield e.uniappExtensionCompile({workspaceFolder:c,type:"h5",console:l});if(t&&0!==t.code)throw new Error("编译失败");if(!t.buildServerPath&&!t.buildClientPath)throw new Error("编译失败");yield this.logService.writeDebug(t)}if(!O.default.existsSync(e))throw new Error(`上传的文件/目录不存在：${e}`);if(i=E.default.join(i).replace(new RegExp(`\\${E.default.sep}`,"g"),"/"),!this.context.isCli&&c){const e=function(e){const t=Rm(e),n=E.default.resolve(e,t?"src":"","manifest.json");let i={};try{i=function(e){return function(e){return $m(e.replace("\r\n","\n").replace("\r","\n"))}(function(e){let t=O.default.readFileSync(e);return 239===t[0]&&187===t[1]&&191===t[2]&&(t=t.slice(3)),t.toString("utf-8")}(e))}(n)}catch(e){}return i}(c.uri.fsPath);(null===(r=null===(o=null==e?void 0:e.h5)||void 0===o?void 0:o.router)||void 0===r?void 0:r.base)&&(i=null===(a=null===(s=null==e?void 0:e.h5)||void 0===s?void 0:s.router)||void 0===a?void 0:a.base)}const u=O.default.statSync(e),d=u.isDirectory()?Am(e):[e],p=u.isFile();c&&(yield l.appendLine({level:"info",line:yield this.logService.getRawUniCloudLog(`项目【${c.name}】开始上传到${t.spaceName}服务空间...`)}));const f=d.map((t=>{var n;const o=this.context.isCli?t:E.default.relative(c.uri.fsPath,t);let r=p?E.default.basename(t):E.default.relative(e,t);if(p){const e=E.default.extname(r),t=E.default.extname(null!==(n=null==i?void 0:i.split("/").pop())&&void 0!==n?n:"");r=e&&t?E.default.normalize(i):E.default.join(i,r)}else r=E.default.join(i,r);return r=r.replace(new RegExp(`\\${E.default.sep}`,"g"),"/").replace(/^\//,""),{filePath:t,relativeFilePath:o,cloudFilePath:r}}));let h;switch(t.provider){case"tcb":h=yield this.uploadTcbWebHost(f,t.spaceId);break;case"aliyun":h=yield this.uploadAliyunWebHost(f,t.spaceId,i);break;case"alipay":h=yield this.uploadAlipayWebHost(f,t.spaceId);break;default:throw new Error(`暂不支持${t.provider}`)}const m=yield this.getWebHostDomain(t.provider,t.spaceId),g=J.format({protocol:"https",hostname:m,pathname:i});yield l.appendLine({level:"success",line:yield this.logService.getRawUniCloudLog(`总共需上传${f.length}个文件。已成功上传${h.successUploadCount}个文件。  访问地址：${g}`)});const y="web控制台",v=yield this.logService.getRawUniCloudLog("跨域配置、自定义域名、证书等更多设置请到 web控制台 操作。");yield l.appendLine({level:"success",line:v,hyperlinks:[{linkPosition:{start:v.indexOf(y),end:v.indexOf(y)+y.length},onOpen:()=>Cm(this,void 0,void 0,(function*(){C.default.env.openExternal(`https://unicloud.dcloud.net.cn/pages/web-host/web-host?pageid=${t.spaceId}`)}))}]})}))}listWebHostFiles(e,t,n="/"){return Cm(this,void 0,void 0,(function*(){const i={provider:t,spaceId:e,path:n};"tcb"===t&&(n=n.replace(/^\//,""),i.path=n,i.marker=n);const o=yield this.remoteService.getWebHostFileList(i),r=o.directories.map((e=>[E.default.relative(n.replace(/^\//,""),e.prefix),"文件夹"])),s=o.files.map((e=>[e.name,"文件",e.size,e.updatedAt])),a=[].concat(r,s),c=yield this.logService.getCliFormatLog(a);for(const e of c)yield this.logService.writeUniCloudLog({level:"info",message:e})}))}deleteWebHostFile(e,t,n="/"){return Cm(this,void 0,void 0,(function*(){yield this.remoteService.deleteWebHostFile({provider:t,spaceId:e,path:n})}))}getWebHostDomain(e,t){return Cm(this,void 0,void 0,(function*(){const{defaultDomains:n,customDomains:i}=yield this.remoteService.getWebHostInfo({provider:e,spaceId:t});return i.length>0?i[0].domain:n[0].domain}))}uploadAlipayWebHost(e,t){return Cm(this,void 0,void 0,(function*(){const n=this.context.isCli?this.context.outputView:C.default.window.createOutputChannel("前端网页托管");let i=0;for(const{filePath:o,relativeFilePath:r,cloudFilePath:s}of e){try{const{uploadUrl:e}=yield this.remoteService.getAlipayUploadFileUrl({provider:"alipay",spaceId:t,filePath:s,contentType:qm(o)});yield this.uploadCloud(e,o)}catch(e){yield this.logService.writeDebug(e.message),yield n.appendLine({level:"error",line:yield this.logService.getRawUniCloudLog(`${r} 上传失败`)});continue}yield n.appendLine({level:"success",line:yield this.logService.getRawUniCloudLog(`${r} 已成功上传到 ${s}`)}),i+=1}return{successUploadCount:i}}))}uploadAliyunWebHost(e,t,n="/"){return Cm(this,void 0,void 0,(function*(){const i=this.context.isCli?this.context.outputView:C.default.window.createOutputChannel("前端网页托管");let o,r=0;const s=()=>Cm(this,void 0,void 0,(function*(){return(!o||o.expiredTime<Date.now())&&(o=yield this.remoteService.getAliyunUploadCredential({provider:"aliyun",spaceId:t,filePathPrefix:n})),o}));for(const{filePath:t,relativeFilePath:n,cloudFilePath:o}of e){const e=yield s(),a=new Bm,c=E.default.basename(t);a.append("OSSAccessKeyId",e.accessKeyId),a.append("policy",e.policy),a.append("Signature",e.signature),a.append("key",o),a.append("x-oss-security-token",e.securityToken),a.append("file",O.default.readFileSync(t),{filename:c,contentType:qm(c)});try{yield this.uploadAliyunCloud(e.endpoint,a)}catch(e){yield this.logService.writeDebug(e.message),yield i.appendLine({level:"error",line:yield this.logService.getRawUniCloudLog(`${n} 上传失败`)});continue}yield i.appendLine({level:"success",line:yield this.logService.getRawUniCloudLog(`${n} 已成功上传到 ${o}`)}),r+=1}return{successUploadCount:r}}))}uploadTcbWebHost(e,t){return Cm(this,void 0,void 0,(function*(){const n=this.context.isCli?this.context.outputView:C.default.window.createOutputChannel("前端网页托管");let i,o,r=0;const s=()=>Cm(this,void 0,void 0,(function*(){return(!i||i.expiredTime<Date.now())&&(i=yield this.remoteService.getTcbUploadCredential({provider:"tcb",spaceId:t}),o=null),o||(o=new Vm({getAuthorization(e,t){t({StartTime:i.startTime,TmpSecretId:i.tmpSecretId,TmpSecretKey:i.tmpSecretKey,SecurityToken:i.sessionToken,ExpiredTime:i.expiredTime})}})),{cos:o,uploadCredential:i}}));for(const{filePath:t,relativeFilePath:i,cloudFilePath:o}of e){const{cos:e,uploadCredential:a}=yield s();try{yield e.uploadFile({Bucket:a.bucket,Region:a.region,Key:o,FilePath:t,SliceSize:5242880})}catch(e){yield this.logService.writeDebug(e.message),yield n.appendLine({level:"error",line:yield this.logService.getRawUniCloudLog(`${i} 上传失败`)});continue}yield n.appendLine({level:"success",line:yield this.logService.getRawUniCloudLog(`${i} 已成功上传到 ${o}`)}),r+=1}return{successUploadCount:r}}))}uploadCloud(e,t){return Cm(this,void 0,void 0,(function*(){return new Promise(((n,i)=>{const o=O.default.createReadStream(t),r=new J.URL(e),s=H.default.request({hostname:r.hostname,path:r.pathname+r.search,method:"PUT",headers:{"Content-Type":qm(t)}},(e=>{e.on("data",(()=>{})),e.on("end",(()=>{n()}))}));s.on("error",(e=>{i(e)})),o.pipe(s),o.on("end",(()=>{s.end()}))}))}))}uploadAliyunCloud(e,t){return Cm(this,void 0,void 0,(function*(){return new Promise(((n,i)=>{const o=H.default.request({hostname:e,method:"POST",headers:t.getHeaders({})},(e=>{let t;e.on("data",(e=>{t+=e})),e.on("end",(()=>{200!==e.statusCode&&204!==e.statusCode?i(new Error(t.toString())):n()}))}));o.on("error",(e=>{i(e)})),o.write(t.getBuffer()),o.end()}))}))}}_m([fm()],zm.prototype,"context",void 0),_m([pm(Em)],zm.prototype,"logService",void 0),_m([pm(Hm)],zm.prototype,"remoteService",void 0);let Gm=class{init(){return Cm(this,void 0,void 0,(function*(){C.default.vue.defineComponent("uploadWebHostDialog",this.context.isDebug?E.default.join(__dirname,"upload-web-host.vue"):E.default.join(process.env.UNICLOUD_DEBUGGER_PATH,"manager/dialog-components/upload-web-host.vue"))}))}invoke(e){return Cm(this,void 0,void 0,(function*(){const{uploadWebHostDialog:e}=yield this.webHostService.createUploadWebHostDialog(),{buildUniApp:t,spaces:n,uploadDirPath:i}=e,o=n.find((e=>e.selected));this.context._params.specifySpace={spaceId:o.spaceId,spaceName:o.spaceName,provider:o.provider},o&&(yield this.webHostService.uploadWebHost(i,o,t))}))}export(e){return Cm(this,void 0,void 0,(function*(){if(!e.space)throw new Error("请选择服务空间");if(!e.uploadDirPath)throw new Error("请选择上传目录");this.context._params.specifySpace={spaceId:e.space.spaceId,spaceName:e.space.spaceName,provider:e.space.provider},yield this.webHostService.uploadWebHost(e.uploadDirPath,e.space,!1)}))}};var Km;_m([fm()],Gm.prototype,"context",void 0),_m([pm(Em)],Gm.prototype,"logService",void 0),_m([pm(zm)],Gm.prototype,"webHostService",void 0),Gm=_m([(Km={export:!0},function(e){return um.saveCommand("uniCloud.WebHost.Upload",e,Km),e})],Gm);let Zm=class{invoke(e){return Cm(this,void 0,void 0,(function*(){let{prj:t,source:n="",space:i,prefix:o="/"}=e.args,r=n;if(!t&&!n)throw new Error("请指定 prj 或 source 参数");if(t){const e=(yield C.default.workspace.getWorkspaceFolders()).find((e=>e.name===t));if(!e)throw new Error(`未找到项目 ${t}`);r=e.uri.fsPath,o=E.default.join(o,t)}const s=(yield this.remoteService.getAllSpaceList()).find((e=>e.id===i||e.name===i));if(!s)throw new Error(`未找到服务空间 ${i}`);if(!s.haveHostingService)throw new Error(`服务空间 ${i} 未开通前端网页托管`);yield this.webHostService.uploadWebHost(r,{spaceId:s.id,spaceName:s.name,provider:s.provider,spaceProvider:this.spaceService.transformProvider(s.provider)},!1,o)}))}};_m([pm(Em)],Zm.prototype,"logService",void 0),_m([pm(zm)],Zm.prototype,"webHostService",void 0),_m([pm(Hm)],Zm.prototype,"remoteService",void 0),_m([pm(Sm)],Zm.prototype,"spaceService",void 0),Zm=_m([hm("hosting deploy")],Zm);let Ym=class{invoke(e){return Cm(this,void 0,void 0,(function*(){const{space:t,prefix:n="/"}=e.args,i=yield this.spaceService.getSpaceInfo(t);if(!i)throw new Error(`未找到服务空间 ${t}`);if(!i.haveHostingService)throw new Error(`服务空间 ${t} 未开通前端网页托管`);yield this.webHostService.listWebHostFiles(i.id,i.provider,n)}))}};_m([pm(Em)],Ym.prototype,"logService",void 0),_m([pm(zm)],Ym.prototype,"webHostService",void 0),_m([pm(Hm)],Ym.prototype,"remoteService",void 0),_m([pm(Sm)],Ym.prototype,"spaceService",void 0),Ym=_m([hm("hosting list")],Ym);let Xm=class{invoke(e){return Cm(this,void 0,void 0,(function*(){const{space:t,path:n="/"}=e.args,i=yield this.spaceService.getSpaceInfo(t);if(!i)throw new Error(`未找到服务空间 ${t}`);if(!i.haveHostingService)throw new Error(`服务空间 ${t} 未开通前端网页托管`);yield this.webHostService.deleteWebHostFile(i.id,i.provider,n)}))}};function Qm(e){return function(e,t){var n,i,o;const r={};return null===(n=t.middleware)||void 0===n||n.unshift(ym),null===(i=t.middleware)||void 0===i||i.unshift(vm),null===(o=t.middleware)||void 0===o||o.unshift(gm),um.forEach(((n,i)=>{const o=wm[n.type];if(n.type&&o){const{target:s,options:a={}}=n;if(o.useInstance?C.default[o.group][o.command](i,new Proxy(new s,{get:(e,o)=>(...r)=>xm(class{resolve(){return nm(this,void 0,void 0,(function*(){"function"==typeof e.init&&(yield e.init());const t=yield Promise.resolve(e[o](...r));return void 0!==t&&(am()._return=t),t}))}},{},t,{value:n,key:i})})):C.default[o.group][o.command](i,(r=>{const a=new s(e);return xm(class{resolve(){return nm(this,void 0,void 0,(function*(){return"function"==typeof a.init&&(yield a.init()),Promise.resolve(a[o.commandAlias||o.command](r))}))}},r,t,{value:n,key:i})})),a.export){const o="string"==typeof a.export?a.export:i;r[o]=r=>{const a=new s(e);return"function"!=typeof a.export&&console.error(`export [${o}] fail, [export] function not found`),xm(class{resolve(){return nm(this,void 0,void 0,(function*(){return"function"==typeof a.init&&(yield a.init()),Promise.resolve(a.export(r))}))}},r,t,{value:n,key:i})}}}})),r}(e,{middleware:[]})}_m([pm(Em)],Xm.prototype,"logService",void 0),_m([pm(zm)],Xm.prototype,"webHostService",void 0),_m([pm(Hm)],Xm.prototype,"remoteService",void 0),_m([pm(Sm)],Xm.prototype,"spaceService",void 0),Xm=_m([hm("hosting delete")],Xm);class eg extends Error{constructor({code:e,message:t}){super(t),this.code=e}}const tg=require("hbuilderx"),ng=require("net");class ig{constructor({host:e,minPort:t=8e3,maxPort:n=65535}={}){this.host=e,this.minPort=t,this.maxPort=n}_testSinglePort(e,t){return new Promise(((n,i)=>{const o=ng.createServer((function(){}));function r(e){o.removeListener("listening",s),i(e)}function s(){o.removeListener("error",r),o.close(),n(t)}o.once("error",r),o.once("listening",s),o.listen(t,e)}))}async getPort(){for(let e=this.minPort;e<=this.maxPort;e++)try{return this.host&&"0.0.0.0"!==this.host?(await this._testSinglePort("0.0.0.0",e),await this._testSinglePort(this.host,e)):await this._testSinglePort(this.host,e),e}catch(e){if("EADDRINUSE"===e.code||"EACCES"===e.code)continue;throw e}}}class og{constructor(){this.data=new Map}_checkKey(e){const t=this.data.get(e);t&&(-1===t.expired||t.expired>Date.now()||this.data.delete(e))}has(e){return this._checkKey(e),this.data.has(e)}get(e){return this._checkKey(e),this.data.get(e)}set(e,t,n){this.data.set(e,{value:t,expired:n})}remove(e){this.data.delete(e)}clear(){this.data.clear()}}const rg="pending",sg="fullfilled",ag="rejected";class cg{constructor({expireThreshold:e=1e4}={}){this.cache=new og,this.promiseMap=new Map,this.expireThreshold=e}async get(e,t){if(this.cache.has(e)){const{value:t,expired:n}=this.cache.get(e);if(n>Date.now()+this.expireThreshold)return{value:t,expired:n}}let n=this.promiseMap.get(e);if(n&&n.status===rg)return n.promise;const i=t();n={promise:i,status:rg},this.promiseMap.set(e,n);try{const t=await i;n.status=sg;const{value:o,expired:r}=t;return this.cache.set(e,o,r),t}catch(e){throw n.status=ag,e}}clear(){this.cache.clear(),this.promiseMap.clear()}}function lg(e){return new Promise(((t,n)=>{setTimeout((()=>{t()}),e)}))}let ug;function dg(e){void 0===ug&&(ug=O.default.existsSync(E.default.resolve(__dirname,"dcloud.debug")),ug&&(process.on("uncaughtException",dg),process.on("unhandledRejection",dg))),ug&&O.default.appendFileSync(E.default.resolve(__dirname,"log.txt"),(new Date).toLocaleString()+"\t"+process.pid+"\t"+e+"\n")}function pg(e){const t=e&&e.uri&&e.uri.fsPath,n=t.split(":");return 1===n.length?t:(n[0]=n[0].toUpperCase(),n.join(":"))}function fg(e){return"/"!==(e=e.replace(/\\/g,"/"))[e.length-1]&&(e+="/"),new RegExp("^"+e,"i")}async function hg({path:e,body:t}={}){return function(e){if(e.error)throw new eg({code:"NETWORK_ERROR",message:"请求DCloud服务失败："+JSON.stringify(e.error)});const t=JSON.parse(e.data),n=t.header&&t.header.result&&t.header.result.rspcode,i=t.header&&t.header.result&&t.header.result.rspdesc;if("1001"!==n)throw new eg({code:n||"NETWORK_ERROR",message:i});return t.body}(await tg.http.request({url:`https://ide.liuyingyong.cn${e}`,method:"post",serviceOptions:{serviceRequest:!0,body:t},params:{}}))}function mg(){return["<node_internals>/**",process.env.UNICLOUD_DEBUGGER_PATH.replace(/\\/g,"/")+"/**/*.js"]}process.platform;const gg=E.default.resolve(__dirname,"../../npm/node_modules/npm/bin/npm-cli.js");function yg(e){return new Promise((t=>{const n=E.default.resolve(e,"package.json");if(!O.default.existsSync(n))return void t();let i;try{i=JSON.parse(O.default.readFileSync(n).toString())}catch(e){return void t()}const o=i&&i.dependencies&&Object.keys(i.dependencies).every((e=>0===i.dependencies[e].indexOf("file:"))),s=r.spawn(process.execPath,[gg,"ls"],{cwd:e,env:{NODE_SKIP_PLATFORM_CHECK:"1"}});s.on("exit",(()=>{0===s.exitCode?t():t({type:o?"local":"npm"})}))}))}async function vg(e){const t=[];for(let n=0;n<e.length;n++){const i=e[n],o=await yg(i);o&&t.push({dir:i,functionPath:i,...o})}return t}async function wg(e){const t=[];for(let n=0;n<e.length;n++){const i=e[n],o=await yg(i);o&&t.push({dir:i,commonModulePath:i,...o})}return t}function xg(e){const t=E.default.resolve(e,"package-lock.json");return O.default.existsSync(t)&&O.default.unlinkSync(t),new Promise(((t,n)=>{const i=r.spawn(process.execPath,[gg,"install","--production"],{stdio:["pipe","pipe","pipe"],cwd:e});let o=Buffer.alloc(0);i.stderr.on("data",(e=>{o=Buffer.concat([o,e])})),i.on("exit",(()=>{0===i.exitCode?t():n(new Error(`npm进程退出码：${i.exitCode}\n详细错误信息如下：\n${o.toString()}`))}))}))}const bg={tcb:"腾讯云",aliyun:"阿里云",alipay:"支付宝云"};var Sg={exports:{}},kg={BINARY_TYPES:["nodebuffer","arraybuffer","fragments"],EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}};const{EMPTY_BUFFER:Eg}=kg;function _g(e,t){if(0===e.length)return Eg;if(1===e.length)return e[0];const n=Buffer.allocUnsafe(t);let i=0;for(let t=0;t<e.length;t++){const o=e[t];n.set(o,i),i+=o.length}return i<t?n.slice(0,i):n}function Cg(e,t,n,i,o){for(let r=0;r<o;r++)n[i+r]=e[r]^t[3&r]}function Ig(e,t){for(let n=0;n<e.length;n++)e[n]^=t[3&n]}function jg(e){return e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function Og(e){if(Og.readOnly=!0,Buffer.isBuffer(e))return e;let t;return e instanceof ArrayBuffer?t=Buffer.from(e):ArrayBuffer.isView(e)?t=Buffer.from(e.buffer,e.byteOffset,e.byteLength):(t=Buffer.from(e),Og.readOnly=!1),t}try{const e=require("bufferutil");Sg.exports={concat:_g,mask(t,n,i,o,r){r<48?Cg(t,n,i,o,r):e.mask(t,n,i,o,r)},toArrayBuffer:jg,toBuffer:Og,unmask(t,n){t.length<32?Ig(t,n):e.unmask(t,n)}}}catch(o){Sg.exports={concat:_g,mask:Cg,toArrayBuffer:jg,toBuffer:Og,unmask:Ig}}const Pg=Symbol("kDone"),Lg=Symbol("kRun");var Ng=class{constructor(e){this[Pg]=()=>{this.pending--,this[Lg]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[Lg]()}[Lg](){if(this.pending!==this.concurrency&&this.jobs.length){const e=this.jobs.shift();this.pending++,e(this[Pg])}}};const Fg=D.default,Tg=Sg.exports,Dg=Ng,{kStatusCode:$g}=kg,Rg=Buffer.from([0,0,255,255]),Ag=Symbol("permessage-deflate"),Bg=Symbol("total-length"),Mg=Symbol("callback"),Ug=Symbol("buffers"),qg=Symbol("error");let Wg;var Jg=class{constructor(e,t,n){if(this._maxPayload=0|n,this._options=e||{},this._threshold=void 0!==this._options.threshold?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!Wg){const e=void 0!==this._options.concurrencyLimit?this._options.concurrencyLimit:10;Wg=new Dg(e)}}static get extensionName(){return"permessage-deflate"}offer(){const e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){const e=this._deflate[Mg];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){const t=this._options,n=e.find((e=>!(!1===t.serverNoContextTakeover&&e.server_no_context_takeover||e.server_max_window_bits&&(!1===t.serverMaxWindowBits||"number"==typeof t.serverMaxWindowBits&&t.serverMaxWindowBits>e.server_max_window_bits)||"number"==typeof t.clientMaxWindowBits&&!e.client_max_window_bits)));if(!n)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(n.server_no_context_takeover=!0),t.clientNoContextTakeover&&(n.client_no_context_takeover=!0),"number"==typeof t.serverMaxWindowBits&&(n.server_max_window_bits=t.serverMaxWindowBits),"number"==typeof t.clientMaxWindowBits?n.client_max_window_bits=t.clientMaxWindowBits:!0!==n.client_max_window_bits&&!1!==t.clientMaxWindowBits||delete n.client_max_window_bits,n}acceptAsClient(e){const t=e[0];if(!1===this._options.clientNoContextTakeover&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(t.client_max_window_bits){if(!1===this._options.clientMaxWindowBits||"number"==typeof this._options.clientMaxWindowBits&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"')}else"number"==typeof this._options.clientMaxWindowBits&&(t.client_max_window_bits=this._options.clientMaxWindowBits);return t}normalizeParams(e){return e.forEach((e=>{Object.keys(e).forEach((t=>{let n=e[t];if(n.length>1)throw new Error(`Parameter "${t}" must have only a single value`);if(n=n[0],"client_max_window_bits"===t){if(!0!==n){const e=+n;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${n}`);n=e}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${t}": ${n}`)}else if("server_max_window_bits"===t){const e=+n;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${n}`);n=e}else{if("client_no_context_takeover"!==t&&"server_no_context_takeover"!==t)throw new Error(`Unknown parameter "${t}"`);if(!0!==n)throw new TypeError(`Invalid value for parameter "${t}": ${n}`)}e[t]=n}))})),e}decompress(e,t,n){Wg.add((i=>{this._decompress(e,t,((e,t)=>{i(),n(e,t)}))}))}compress(e,t,n){Wg.add((i=>{this._compress(e,t,((e,t)=>{i(),n(e,t)}))}))}_decompress(e,t,n){const i=this._isServer?"client":"server";if(!this._inflate){const e=`${i}_max_window_bits`,t="number"!=typeof this.params[e]?Fg.Z_DEFAULT_WINDOWBITS:this.params[e];this._inflate=Fg.createInflateRaw({...this._options.zlibInflateOptions,windowBits:t}),this._inflate[Ag]=this,this._inflate[Bg]=0,this._inflate[Ug]=[],this._inflate.on("error",zg),this._inflate.on("data",Vg)}this._inflate[Mg]=n,this._inflate.write(e),t&&this._inflate.write(Rg),this._inflate.flush((()=>{const e=this._inflate[qg];if(e)return this._inflate.close(),this._inflate=null,void n(e);const o=Tg.concat(this._inflate[Ug],this._inflate[Bg]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[Bg]=0,this._inflate[Ug]=[],t&&this.params[`${i}_no_context_takeover`]&&this._inflate.reset()),n(null,o)}))}_compress(e,t,n){const i=this._isServer?"server":"client";if(!this._deflate){const e=`${i}_max_window_bits`,t="number"!=typeof this.params[e]?Fg.Z_DEFAULT_WINDOWBITS:this.params[e];this._deflate=Fg.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:t}),this._deflate[Bg]=0,this._deflate[Ug]=[],this._deflate.on("data",Hg)}this._deflate[Mg]=n,this._deflate.write(e),this._deflate.flush(Fg.Z_SYNC_FLUSH,(()=>{if(!this._deflate)return;let e=Tg.concat(this._deflate[Ug],this._deflate[Bg]);t&&(e=e.slice(0,e.length-4)),this._deflate[Mg]=null,this._deflate[Bg]=0,this._deflate[Ug]=[],t&&this.params[`${i}_no_context_takeover`]&&this._deflate.reset(),n(null,e)}))}};function Hg(e){this[Ug].push(e),this[Bg]+=e.length}function Vg(e){this[Bg]+=e.length,this[Ag]._maxPayload<1||this[Bg]<=this[Ag]._maxPayload?this[Ug].push(e):(this[qg]=new RangeError("Max payload size exceeded"),this[qg].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[qg][$g]=1009,this.removeListener("data",Vg),this.reset())}function zg(e){this[Ag]._inflate=null,e[$g]=1007,this[Mg](e)}var Gg={exports:{}};const Kg=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function Zg(e){return e>=1e3&&e<=1014&&1004!==e&&1005!==e&&1006!==e||e>=3e3&&e<=4999}function Yg(e){const t=e.length;let n=0;for(;n<t;)if(0==(128&e[n]))n++;else if(192==(224&e[n])){if(n+1===t||128!=(192&e[n+1])||192==(254&e[n]))return!1;n+=2}else if(224==(240&e[n])){if(n+2>=t||128!=(192&e[n+1])||128!=(192&e[n+2])||224===e[n]&&128==(224&e[n+1])||237===e[n]&&160==(224&e[n+1]))return!1;n+=3}else{if(240!=(248&e[n]))return!1;if(n+3>=t||128!=(192&e[n+1])||128!=(192&e[n+2])||128!=(192&e[n+3])||240===e[n]&&128==(240&e[n+1])||244===e[n]&&e[n+1]>143||e[n]>244)return!1;n+=4}return!0}try{const e=require("utf-8-validate");Gg.exports={isValidStatusCode:Zg,isValidUTF8:t=>t.length<150?Yg(t):e(t),tokenChars:Kg}}catch(o){Gg.exports={isValidStatusCode:Zg,isValidUTF8:Yg,tokenChars:Kg}}const{Writable:Xg}=M.default,Qg=Jg,{BINARY_TYPES:ey,EMPTY_BUFFER:ty,kStatusCode:ny,kWebSocket:iy}=kg,{concat:oy,toArrayBuffer:ry,unmask:sy}=Sg.exports,{isValidStatusCode:ay,isValidUTF8:cy}=Gg.exports;var ly=class extends Xg{constructor(e={}){super(),this._binaryType=e.binaryType||ey[0],this._extensions=e.extensions||{},this._isServer=!!e.isServer,this._maxPayload=0|e.maxPayload,this._skipUTF8Validation=!!e.skipUTF8Validation,this[iy]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._state=0,this._loop=!1}_write(e,t,n){if(8===this._opcode&&0==this._state)return n();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(n)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){const t=this._buffers[0];return this._buffers[0]=t.slice(e),t.slice(0,e)}const t=Buffer.allocUnsafe(e);do{const n=this._buffers[0],i=t.length-e;e>=n.length?t.set(this._buffers.shift(),i):(t.set(new Uint8Array(n.buffer,n.byteOffset,e),i),this._buffers[0]=n.slice(e)),e-=n.length}while(e>0);return t}startLoop(e){let t;this._loop=!0;do{switch(this._state){case 0:t=this.getInfo();break;case 1:t=this.getPayloadLength16();break;case 2:t=this.getPayloadLength64();break;case 3:this.getMask();break;case 4:t=this.getData(e);break;default:return void(this._loop=!1)}}while(this._loop);e(t)}getInfo(){if(this._bufferedBytes<2)return void(this._loop=!1);const e=this.consume(2);if(0!=(48&e[0]))return this._loop=!1,uy(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3");const t=64==(64&e[0]);if(t&&!this._extensions[Qg.extensionName])return this._loop=!1,uy(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(this._fin=128==(128&e[0]),this._opcode=15&e[0],this._payloadLength=127&e[1],0===this._opcode){if(t)return this._loop=!1,uy(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(!this._fragmented)return this._loop=!1,uy(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE");this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented)return this._loop=!1,uy(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");this._compressed=t}else{if(!(this._opcode>7&&this._opcode<11))return this._loop=!1,uy(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");if(!this._fin)return this._loop=!1,uy(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN");if(t)return this._loop=!1,uy(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(this._payloadLength>125)return this._loop=!1,uy(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH")}if(this._fin||this._fragmented||(this._fragmented=this._opcode),this._masked=128==(128&e[1]),this._isServer){if(!this._masked)return this._loop=!1,uy(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK")}else if(this._masked)return this._loop=!1,uy(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK");if(126===this._payloadLength)this._state=1;else{if(127!==this._payloadLength)return this.haveLength();this._state=2}}getPayloadLength16(){if(!(this._bufferedBytes<2))return this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength();this._loop=!1}getPayloadLength64(){if(this._bufferedBytes<8)return void(this._loop=!1);const e=this.consume(8),t=e.readUInt32BE(0);return t>Math.pow(2,21)-1?(this._loop=!1,uy(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH")):(this._payloadLength=t*Math.pow(2,32)+e.readUInt32BE(4),this.haveLength())}haveLength(){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0))return this._loop=!1,uy(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");this._masked?this._state=3:this._state=4}getMask(){this._bufferedBytes<4?this._loop=!1:(this._mask=this.consume(4),this._state=4)}getData(e){let t=ty;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength)return void(this._loop=!1);t=this.consume(this._payloadLength),this._masked&&0!=(this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3])&&sy(t,this._mask)}return this._opcode>7?this.controlMessage(t):this._compressed?(this._state=5,void this.decompress(t,e)):(t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage())}decompress(e,t){this._extensions[Qg.extensionName].decompress(e,this._fin,((e,n)=>{if(e)return t(e);if(n.length){if(this._messageLength+=n.length,this._messageLength>this._maxPayload&&this._maxPayload>0)return t(uy(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"));this._fragments.push(n)}const i=this.dataMessage();if(i)return t(i);this.startLoop(t)}))}dataMessage(){if(this._fin){const e=this._messageLength,t=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],2===this._opcode){let n;n="nodebuffer"===this._binaryType?oy(t,e):"arraybuffer"===this._binaryType?ry(oy(t,e)):t,this.emit("message",n,!0)}else{const n=oy(t,e);if(!this._skipUTF8Validation&&!cy(n))return this._loop=!1,uy(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");this.emit("message",n,!1)}}this._state=0}controlMessage(e){if(8===this._opcode)if(this._loop=!1,0===e.length)this.emit("conclude",1005,ty),this.end();else{if(1===e.length)return uy(RangeError,"invalid payload length 1",!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH");{const t=e.readUInt16BE(0);if(!ay(t))return uy(RangeError,`invalid status code ${t}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");const n=e.slice(2);if(!this._skipUTF8Validation&&!cy(n))return uy(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");this.emit("conclude",t,n),this.end()}}else 9===this._opcode?this.emit("ping",e):this.emit("pong",e);this._state=0}};function uy(e,t,n,i,o){const r=new e(n?`Invalid WebSocket frame: ${t}`:t);return Error.captureStackTrace(r,uy),r.code=o,r[ny]=i,r}const{randomFillSync:dy}=$.default,py=Jg,{EMPTY_BUFFER:fy}=kg,{isValidStatusCode:hy}=Gg.exports,{mask:my,toBuffer:gy}=Sg.exports,yy=Symbol("kByteLength"),vy=Buffer.alloc(4);class wy{constructor(e,t,n){this._extensions=t||{},n&&(this._generateMask=n,this._maskBuffer=Buffer.alloc(4)),this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._deflating=!1,this._queue=[]}static frame(e,t){let n,i,o=!1,r=2,s=!1;t.mask&&(n=t.maskBuffer||vy,t.generateMask?t.generateMask(n):dy(n,0,4),s=0==(n[0]|n[1]|n[2]|n[3]),r=6),"string"==typeof e?i=t.mask&&!s||void 0===t[yy]?(e=Buffer.from(e)).length:t[yy]:(i=e.length,o=t.mask&&t.readOnly&&!s);let a=i;i>=65536?(r+=8,a=127):i>125&&(r+=2,a=126);const c=Buffer.allocUnsafe(o?i+r:r);return c[0]=t.fin?128|t.opcode:t.opcode,t.rsv1&&(c[0]|=64),c[1]=a,126===a?c.writeUInt16BE(i,2):127===a&&(c[2]=c[3]=0,c.writeUIntBE(i,4,6)),t.mask?(c[1]|=128,c[r-4]=n[0],c[r-3]=n[1],c[r-2]=n[2],c[r-1]=n[3],s?[c,e]:o?(my(e,n,c,r,i),[c]):(my(e,n,e,0,i),[c,e])):[c,e]}close(e,t,n,i){let o;if(void 0===e)o=fy;else{if("number"!=typeof e||!hy(e))throw new TypeError("First argument must be a valid error code number");if(void 0!==t&&t.length){const n=Buffer.byteLength(t);if(n>123)throw new RangeError("The message must not be greater than 123 bytes");o=Buffer.allocUnsafe(2+n),o.writeUInt16BE(e,0),"string"==typeof t?o.write(t,2):o.set(t,2)}else o=Buffer.allocUnsafe(2),o.writeUInt16BE(e,0)}const r={[yy]:o.length,fin:!0,generateMask:this._generateMask,mask:n,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};this._deflating?this.enqueue([this.dispatch,o,!1,r,i]):this.sendFrame(wy.frame(o,r),i)}ping(e,t,n){let i,o;if("string"==typeof e?(i=Buffer.byteLength(e),o=!1):(i=(e=gy(e)).length,o=gy.readOnly),i>125)throw new RangeError("The data size must not be greater than 125 bytes");const r={[yy]:i,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:9,readOnly:o,rsv1:!1};this._deflating?this.enqueue([this.dispatch,e,!1,r,n]):this.sendFrame(wy.frame(e,r),n)}pong(e,t,n){let i,o;if("string"==typeof e?(i=Buffer.byteLength(e),o=!1):(i=(e=gy(e)).length,o=gy.readOnly),i>125)throw new RangeError("The data size must not be greater than 125 bytes");const r={[yy]:i,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:10,readOnly:o,rsv1:!1};this._deflating?this.enqueue([this.dispatch,e,!1,r,n]):this.sendFrame(wy.frame(e,r),n)}send(e,t,n){const i=this._extensions[py.extensionName];let o,r,s=t.binary?2:1,a=t.compress;if("string"==typeof e?(o=Buffer.byteLength(e),r=!1):(o=(e=gy(e)).length,r=gy.readOnly),this._firstFragment?(this._firstFragment=!1,a&&i&&i.params[i._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(a=o>=i._threshold),this._compress=a):(a=!1,s=0),t.fin&&(this._firstFragment=!0),i){const i={[yy]:o,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:s,readOnly:r,rsv1:a};this._deflating?this.enqueue([this.dispatch,e,this._compress,i,n]):this.dispatch(e,this._compress,i,n)}else this.sendFrame(wy.frame(e,{[yy]:o,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:s,readOnly:r,rsv1:!1}),n)}dispatch(e,t,n,i){if(!t)return void this.sendFrame(wy.frame(e,n),i);const o=this._extensions[py.extensionName];this._bufferedBytes+=n[yy],this._deflating=!0,o.compress(e,n.fin,((e,t)=>{if(this._socket.destroyed){const e=new Error("The socket was closed while data was being compressed");"function"==typeof i&&i(e);for(let t=0;t<this._queue.length;t++){const n=this._queue[t],i=n[n.length-1];"function"==typeof i&&i(e)}}else this._bufferedBytes-=n[yy],this._deflating=!1,n.readOnly=!1,this.sendFrame(wy.frame(t,n),i),this.dequeue()}))}dequeue(){for(;!this._deflating&&this._queue.length;){const e=this._queue.shift();this._bufferedBytes-=e[3][yy],Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[3][yy],this._queue.push(e)}sendFrame(e,t){2===e.length?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}}var xy=wy;const{kForOnEventAttribute:by,kListener:Sy}=kg,ky=Symbol("kCode"),Ey=Symbol("kData"),_y=Symbol("kError"),Cy=Symbol("kMessage"),Iy=Symbol("kReason"),jy=Symbol("kTarget"),Oy=Symbol("kType"),Py=Symbol("kWasClean");class Ly{constructor(e){this[jy]=null,this[Oy]=e}get target(){return this[jy]}get type(){return this[Oy]}}Object.defineProperty(Ly.prototype,"target",{enumerable:!0}),Object.defineProperty(Ly.prototype,"type",{enumerable:!0});class Ny extends Ly{constructor(e,t={}){super(e),this[ky]=void 0===t.code?0:t.code,this[Iy]=void 0===t.reason?"":t.reason,this[Py]=void 0!==t.wasClean&&t.wasClean}get code(){return this[ky]}get reason(){return this[Iy]}get wasClean(){return this[Py]}}Object.defineProperty(Ny.prototype,"code",{enumerable:!0}),Object.defineProperty(Ny.prototype,"reason",{enumerable:!0}),Object.defineProperty(Ny.prototype,"wasClean",{enumerable:!0});class Fy extends Ly{constructor(e,t={}){super(e),this[_y]=void 0===t.error?null:t.error,this[Cy]=void 0===t.message?"":t.message}get error(){return this[_y]}get message(){return this[Cy]}}Object.defineProperty(Fy.prototype,"error",{enumerable:!0}),Object.defineProperty(Fy.prototype,"message",{enumerable:!0});class Ty extends Ly{constructor(e,t={}){super(e),this[Ey]=void 0===t.data?null:t.data}get data(){return this[Ey]}}Object.defineProperty(Ty.prototype,"data",{enumerable:!0});const Dy={addEventListener(e,t,n={}){let i;if("message"===e)i=function(e,n){const i=new Ty("message",{data:n?e:e.toString()});i[jy]=this,t.call(this,i)};else if("close"===e)i=function(e,n){const i=new Ny("close",{code:e,reason:n.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});i[jy]=this,t.call(this,i)};else if("error"===e)i=function(e){const n=new Fy("error",{error:e,message:e.message});n[jy]=this,t.call(this,n)};else{if("open"!==e)return;i=function(){const e=new Ly("open");e[jy]=this,t.call(this,e)}}i[by]=!!n[by],i[Sy]=t,n.once?this.once(e,i):this.on(e,i)},removeEventListener(e,t){for(const n of this.listeners(e))if(n[Sy]===t&&!n[by]){this.removeListener(e,n);break}}};var $y={CloseEvent:Ny,ErrorEvent:Fy,Event:Ly,EventTarget:Dy,MessageEvent:Ty};const{tokenChars:Ry}=Gg.exports;function Ay(e,t,n){void 0===e[t]?e[t]=[n]:e[t].push(n)}var By={format:function(e){return Object.keys(e).map((t=>{let n=e[t];return Array.isArray(n)||(n=[n]),n.map((e=>[t].concat(Object.keys(e).map((t=>{let n=e[t];return Array.isArray(n)||(n=[n]),n.map((e=>!0===e?t:`${t}=${e}`)).join("; ")}))).join("; "))).join(", ")})).join(", ")},parse:function(e){const t=Object.create(null);let n,i,o=Object.create(null),r=!1,s=!1,a=!1,c=-1,l=-1,u=-1,d=0;for(;d<e.length;d++)if(l=e.charCodeAt(d),void 0===n)if(-1===u&&1===Ry[l])-1===c&&(c=d);else if(0===d||32!==l&&9!==l){if(59!==l&&44!==l)throw new SyntaxError(`Unexpected character at index ${d}`);{if(-1===c)throw new SyntaxError(`Unexpected character at index ${d}`);-1===u&&(u=d);const i=e.slice(c,u);44===l?(Ay(t,i,o),o=Object.create(null)):n=i,c=u=-1}}else-1===u&&-1!==c&&(u=d);else if(void 0===i)if(-1===u&&1===Ry[l])-1===c&&(c=d);else if(32===l||9===l)-1===u&&-1!==c&&(u=d);else if(59===l||44===l){if(-1===c)throw new SyntaxError(`Unexpected character at index ${d}`);-1===u&&(u=d),Ay(o,e.slice(c,u),!0),44===l&&(Ay(t,n,o),o=Object.create(null),n=void 0),c=u=-1}else{if(61!==l||-1===c||-1!==u)throw new SyntaxError(`Unexpected character at index ${d}`);i=e.slice(c,d),c=u=-1}else if(s){if(1!==Ry[l])throw new SyntaxError(`Unexpected character at index ${d}`);-1===c?c=d:r||(r=!0),s=!1}else if(a)if(1===Ry[l])-1===c&&(c=d);else if(34===l&&-1!==c)a=!1,u=d;else{if(92!==l)throw new SyntaxError(`Unexpected character at index ${d}`);s=!0}else if(34===l&&61===e.charCodeAt(d-1))a=!0;else if(-1===u&&1===Ry[l])-1===c&&(c=d);else if(-1===c||32!==l&&9!==l){if(59!==l&&44!==l)throw new SyntaxError(`Unexpected character at index ${d}`);{if(-1===c)throw new SyntaxError(`Unexpected character at index ${d}`);-1===u&&(u=d);let s=e.slice(c,u);r&&(s=s.replace(/\\/g,""),r=!1),Ay(o,i,s),44===l&&(Ay(t,n,o),o=Object.create(null),n=void 0),i=void 0,c=u=-1}}else-1===u&&(u=d);if(-1===c||a||32===l||9===l)throw new SyntaxError("Unexpected end of input");-1===u&&(u=d);const p=e.slice(c,u);return void 0===n?Ay(t,p,o):(void 0===i?Ay(o,p,!0):Ay(o,i,r?p.replace(/\\/g,""):p),Ay(t,n,o)),t}};const My=j.default,Uy=H.default,qy=G.default,Wy=K.default,Jy=Z.default,{randomBytes:Hy,createHash:Vy}=$.default,{URL:zy}=W.default,Gy=Jg,Ky=ly,Zy=xy,{BINARY_TYPES:Yy,EMPTY_BUFFER:Xy,GUID:Qy,kForOnEventAttribute:ev,kListener:tv,kStatusCode:nv,kWebSocket:iv,NOOP:ov}=kg,{EventTarget:{addEventListener:rv,removeEventListener:sv}}=$y,{format:av,parse:cv}=By,{toBuffer:lv}=Sg.exports,uv=["CONNECTING","OPEN","CLOSING","CLOSED"],dv=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/,pv=[8,13];class fv extends My{constructor(e,t,n){super(),this._binaryType=Yy[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=Xy,this._closeTimer=null,this._extensions={},this._paused=!1,this._protocol="",this._readyState=fv.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,null!==e?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,void 0===t?t=[]:Array.isArray(t)||("object"==typeof t&&null!==t?(n=t,t=[]):t=[t]),mv(this,e,t,n)):this._isServer=!0}get binaryType(){return this._binaryType}set binaryType(e){Yy.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,n){const i=new Ky({binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:n.maxPayload,skipUTF8Validation:n.skipUTF8Validation});this._sender=new Zy(e,this._extensions,n.generateMask),this._receiver=i,this._socket=e,i[iv]=this,e[iv]=this,i.on("conclude",bv),i.on("drain",Sv),i.on("error",kv),i.on("message",_v),i.on("ping",Cv),i.on("pong",Iv),e.setTimeout(0),e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",Ov),e.on("data",Pv),e.on("end",Lv),e.on("error",Nv),this._readyState=fv.OPEN,this.emit("open")}emitClose(){if(!this._socket)return this._readyState=fv.CLOSED,void this.emit("close",this._closeCode,this._closeMessage);this._extensions[Gy.extensionName]&&this._extensions[Gy.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=fv.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==fv.CLOSED){if(this.readyState===fv.CONNECTING){const e="WebSocket was closed before the connection was established";return wv(this,this._req,e)}this.readyState!==fv.CLOSING?(this._readyState=fv.CLOSING,this._sender.close(e,t,!this._isServer,(e=>{e||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())})),this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),3e4)):this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end()}}pause(){this.readyState!==fv.CONNECTING&&this.readyState!==fv.CLOSED&&(this._paused=!0,this._socket.pause())}ping(e,t,n){if(this.readyState===fv.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(n=e,e=t=void 0):"function"==typeof t&&(n=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===fv.OPEN?(void 0===t&&(t=!this._isServer),this._sender.ping(e||Xy,t,n)):xv(this,e,n)}pong(e,t,n){if(this.readyState===fv.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(n=e,e=t=void 0):"function"==typeof t&&(n=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===fv.OPEN?(void 0===t&&(t=!this._isServer),this._sender.pong(e||Xy,t,n)):xv(this,e,n)}resume(){this.readyState!==fv.CONNECTING&&this.readyState!==fv.CLOSED&&(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(e,t,n){if(this.readyState===fv.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof t&&(n=t,t={}),"number"==typeof e&&(e=e.toString()),this.readyState!==fv.OPEN)return void xv(this,e,n);const i={binary:"string"!=typeof e,mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[Gy.extensionName]||(i.compress=!1),this._sender.send(e||Xy,i,n)}terminate(){if(this.readyState!==fv.CLOSED){if(this.readyState===fv.CONNECTING){const e="WebSocket was closed before the connection was established";return wv(this,this._req,e)}this._socket&&(this._readyState=fv.CLOSING,this._socket.destroy())}}}Object.defineProperty(fv,"CONNECTING",{enumerable:!0,value:uv.indexOf("CONNECTING")}),Object.defineProperty(fv.prototype,"CONNECTING",{enumerable:!0,value:uv.indexOf("CONNECTING")}),Object.defineProperty(fv,"OPEN",{enumerable:!0,value:uv.indexOf("OPEN")}),Object.defineProperty(fv.prototype,"OPEN",{enumerable:!0,value:uv.indexOf("OPEN")}),Object.defineProperty(fv,"CLOSING",{enumerable:!0,value:uv.indexOf("CLOSING")}),Object.defineProperty(fv.prototype,"CLOSING",{enumerable:!0,value:uv.indexOf("CLOSING")}),Object.defineProperty(fv,"CLOSED",{enumerable:!0,value:uv.indexOf("CLOSED")}),Object.defineProperty(fv.prototype,"CLOSED",{enumerable:!0,value:uv.indexOf("CLOSED")}),["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach((e=>{Object.defineProperty(fv.prototype,e,{enumerable:!0})})),["open","error","close","message"].forEach((e=>{Object.defineProperty(fv.prototype,`on${e}`,{enumerable:!0,get(){for(const t of this.listeners(e))if(t[ev])return t[tv];return null},set(t){for(const t of this.listeners(e))if(t[ev]){this.removeListener(e,t);break}"function"==typeof t&&this.addEventListener(e,t,{[ev]:!0})}})})),fv.prototype.addEventListener=rv,fv.prototype.removeEventListener=sv;var hv=fv;function mv(e,t,n,i){const o={protocolVersion:pv[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...i,createConnection:void 0,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:void 0,host:void 0,path:void 0,port:void 0};if(!pv.includes(o.protocolVersion))throw new RangeError(`Unsupported protocol version: ${o.protocolVersion} (supported versions: ${pv.join(", ")})`);let r;if(t instanceof zy)r=t,e._url=t.href;else{try{r=new zy(t)}catch(e){throw new SyntaxError(`Invalid URL: ${t}`)}e._url=t}const s="wss:"===r.protocol,a="ws+unix:"===r.protocol;let c;if("ws:"===r.protocol||s||a?a&&!r.pathname?c="The URL's pathname is empty":r.hash&&(c="The URL contains a fragment identifier"):c='The URL\'s protocol must be one of "ws:", "wss:", or "ws+unix:"',c){const t=new SyntaxError(c);if(0===e._redirects)throw t;return void gv(e,t)}const l=s?443:80,u=Hy(16).toString("base64"),d=s?Uy.get:qy.get,p=new Set;let f;if(o.createConnection=s?vv:yv,o.defaultPort=o.defaultPort||l,o.port=r.port||l,o.host=r.hostname.startsWith("[")?r.hostname.slice(1,-1):r.hostname,o.headers={"Sec-WebSocket-Version":o.protocolVersion,"Sec-WebSocket-Key":u,Connection:"Upgrade",Upgrade:"websocket",...o.headers},o.path=r.pathname+r.search,o.timeout=o.handshakeTimeout,o.perMessageDeflate&&(f=new Gy(!0!==o.perMessageDeflate?o.perMessageDeflate:{},!1,o.maxPayload),o.headers["Sec-WebSocket-Extensions"]=av({[Gy.extensionName]:f.offer()})),n.length){for(const e of n){if("string"!=typeof e||!dv.test(e)||p.has(e))throw new SyntaxError("An invalid or duplicated subprotocol was specified");p.add(e)}o.headers["Sec-WebSocket-Protocol"]=n.join(",")}if(o.origin&&(o.protocolVersion<13?o.headers["Sec-WebSocket-Origin"]=o.origin:o.headers.Origin=o.origin),(r.username||r.password)&&(o.auth=`${r.username}:${r.password}`),a){const e=o.path.split(":");o.socketPath=e[0],o.path=e[1]}if(o.followRedirects){if(0===e._redirects){e._originalHost=r.host;const t=i&&i.headers;if(i={...i,headers:{}},t)for(const[e,n]of Object.entries(t))i.headers[e.toLowerCase()]=n}else r.host!==e._originalHost&&(delete o.headers.authorization,delete o.headers.cookie,delete o.headers.host,o.auth=void 0);o.auth&&!i.headers.authorization&&(i.headers.authorization="Basic "+Buffer.from(o.auth).toString("base64"))}let h=e._req=d(o);o.timeout&&h.on("timeout",(()=>{wv(e,h,"Opening handshake has timed out")})),h.on("error",(t=>{null===h||h.aborted||(h=e._req=null,gv(e,t))})),h.on("response",(r=>{const s=r.headers.location,a=r.statusCode;if(s&&o.followRedirects&&a>=300&&a<400){if(++e._redirects>o.maxRedirects)return void wv(e,h,"Maximum redirects exceeded");let r;h.abort();try{r=new zy(s,t)}catch(t){const n=new SyntaxError(`Invalid URL: ${s}`);return void gv(e,n)}mv(e,r,n,i)}else e.emit("unexpected-response",h,r)||wv(e,h,`Unexpected server response: ${r.statusCode}`)})),h.on("upgrade",((t,n,i)=>{if(e.emit("upgrade",t),e.readyState!==fv.CONNECTING)return;h=e._req=null;const r=Vy("sha1").update(u+Qy).digest("base64");if(t.headers["sec-websocket-accept"]!==r)return void wv(e,n,"Invalid Sec-WebSocket-Accept header");const s=t.headers["sec-websocket-protocol"];let a;if(void 0!==s?p.size?p.has(s)||(a="Server sent an invalid subprotocol"):a="Server sent a subprotocol but none was requested":p.size&&(a="Server sent no subprotocol"),a)return void wv(e,n,a);s&&(e._protocol=s);const c=t.headers["sec-websocket-extensions"];if(void 0!==c){if(!f)return void wv(e,n,"Server sent a Sec-WebSocket-Extensions header but no extension was requested");let i;try{i=cv(c)}catch(t){return void wv(e,n,"Invalid Sec-WebSocket-Extensions header")}const o=Object.keys(i);if(1!==o.length||o[0]!==Gy.extensionName)return void wv(e,n,"Server indicated an extension that was not requested");try{f.accept(i[Gy.extensionName])}catch(t){return void wv(e,n,"Invalid Sec-WebSocket-Extensions header")}e._extensions[Gy.extensionName]=f}e.setSocket(n,i,{generateMask:o.generateMask,maxPayload:o.maxPayload,skipUTF8Validation:o.skipUTF8Validation})}))}function gv(e,t){e._readyState=fv.CLOSING,e.emit("error",t),e.emitClose()}function yv(e){return e.path=e.socketPath,Wy.connect(e)}function vv(e){return e.path=void 0,e.servername||""===e.servername||(e.servername=Wy.isIP(e.host)?"":e.host),Jy.connect(e)}function wv(e,t,n){e._readyState=fv.CLOSING;const i=new Error(n);Error.captureStackTrace(i,wv),t.setHeader?(t.abort(),t.socket&&!t.socket.destroyed&&t.socket.destroy(),t.once("abort",e.emitClose.bind(e)),e.emit("error",i)):(t.destroy(i),t.once("error",e.emit.bind(e,"error")),t.once("close",e.emitClose.bind(e)))}function xv(e,t,n){if(t){const n=lv(t).length;e._socket?e._sender._bufferedBytes+=n:e._bufferedAmount+=n}n&&n(new Error(`WebSocket is not open: readyState ${e.readyState} (${uv[e.readyState]})`))}function bv(e,t){const n=this[iv];n._closeFrameReceived=!0,n._closeMessage=t,n._closeCode=e,void 0!==n._socket[iv]&&(n._socket.removeListener("data",Pv),process.nextTick(jv,n._socket),1005===e?n.close():n.close(e,t))}function Sv(){const e=this[iv];e.isPaused||e._socket.resume()}function kv(e){const t=this[iv];void 0!==t._socket[iv]&&(t._socket.removeListener("data",Pv),process.nextTick(jv,t._socket),t.close(e[nv])),t.emit("error",e)}function Ev(){this[iv].emitClose()}function _v(e,t){this[iv].emit("message",e,t)}function Cv(e){const t=this[iv];t.pong(e,!t._isServer,ov),t.emit("ping",e)}function Iv(e){this[iv].emit("pong",e)}function jv(e){e.resume()}function Ov(){const e=this[iv];let t;this.removeListener("close",Ov),this.removeListener("data",Pv),this.removeListener("end",Lv),e._readyState=fv.CLOSING,this._readableState.endEmitted||e._closeFrameReceived||e._receiver._writableState.errorEmitted||null===(t=e._socket.read())||e._receiver.write(t),e._receiver.end(),this[iv]=void 0,clearTimeout(e._closeTimer),e._receiver._writableState.finished||e._receiver._writableState.errorEmitted?e.emitClose():(e._receiver.on("error",Ev),e._receiver.on("finish",Ev))}function Pv(e){this[iv]._receiver.write(e)||this.pause()}function Lv(){const e=this[iv];e._readyState=fv.CLOSING,e._receiver.end(),this.end()}function Nv(){const e=this[iv];this.removeListener("error",Nv),this.on("error",ov),e&&(e._readyState=fv.CLOSING,this.destroy())}var Fv={};Object.defineProperty(Fv,"__esModule",{value:!0});const Tv=j.default;class Dv extends Error{constructor(e){super(e.message),this._code=e.code||0,this._data=e.data||null}get code(){return this._code}get data(){return this._data}}Fv.MessageError=Dv;class $v extends Tv.EventEmitter{constructor(e,t){if(super(),this._responsePromiseMap=new Map,this._nextMessageId=0,this._connected=!1,this._emitLog=!1,this._consoleLog=!1,this._requestQueue=[],this.setLogging(t),!e)throw new TypeError("socket cannot be undefined or null");this._socket=e,e.on("open",(()=>{this._connected=!0,this._sendQueuedRequests()})),e.on("message",(e=>this.processMessage(e)))}processMessage(e){let t;this._logMessage(e,"receive");try{t=JSON.parse(e)}catch(e){return this.emit("error",e)}if(t)if(t.id)if(this._responsePromiseMap.has(t.id)){const n=this._responsePromiseMap.get(t.id);t.result?n.resolve(t.result):t.error?n.reject(new Dv(t.error)):this.emit("error",new Error(`Response must have result or error: ${e}`))}else this.emit("error",new Error(`Response with id:${t.id} has no pending request`));else t.method?this.emit(t.method,t.params):this.emit("error",new Error(`Invalid message: ${e}`));else this.emit("error",new Error("Message cannot be null, empty or undefined"))}setLogging({logEmit:e,logConsole:t}={}){this._emitLog=e,this._consoleLog=t}_send(e){this._requestQueue.push(JSON.stringify(e)),this._sendQueuedRequests()}_sendQueuedRequests(){if(this._connected){for(let e of this._requestQueue)this._logMessage(e,"send"),this._socket.send(e);this._requestQueue=[]}}_logMessage(e,t){this._consoleLog&&console.log("Client "+("send"===t?">":"<"),e),this._emitLog&&this.emit(t,e)}call(e,t){const n=++this._nextMessageId,i={id:n,method:e,params:t};return new Promise(((e,t)=>{try{this._send(i),this._responsePromiseMap.set(n,{resolve:e,reject:t})}catch(e){return t(e)}}))}notify(e,t){this._send({method:e,params:t})}api(e){if(!Proxy)throw new Error("api() requires ES6 Proxy. Please use an ES6 compatible engine");return new Proxy({},{get:(t,n)=>{if(t[n])return t[n];if("__proto__"===n||"prototype"===n)return Object.prototype;if(void 0===e)t[n]=this.api(`${n}.`);else if("on"===n)t[n]=(t,n)=>this.on(`${e}${t}`,n);else if("emit"===n)t[n]=(t,n)=>this.notify(`${e}${t}`,n);else if("on"===n.substr(0,2)&&n.length>3){const i=n[2].toLowerCase()+n.substr(3);t[n]=t=>this.on(`${e}${i}`,t)}else if("emit"===n.substr(0,4)&&n.length>5){const i=n[4].toLowerCase()+n.substr(5);t[n]=t=>this.notify(`${e}${i}`,t)}else{const i=n;t[n]=t=>this.call(`${e}${i}`,t)}return t[n]}})}}var Rv=Fv.Client=$v;class Av extends Tv.EventEmitter{constructor(e,t){if(super(),this._exposedMethodsMap=new Map,this._emitLog=!1,this._consoleLog=!1,this.setLogging(t),!e)throw new TypeError("server cannot be undefined or null");this._socketServer=e,e.on("connection",(e=>{e.on("message",(t=>this.processMessage(t,e)))}))}processMessage(e,t){let n;this._logMessage(e,"receive");try{n=JSON.parse(e)}catch(e){return this._sendError(t,n,-32700)}if(n&&n.method&&"string"==typeof n.method)if(n.id&&"number"==typeof n.id){const i=this._exposedMethodsMap.get(n.method);if(i)try{const e=i.call(null,n.params);e instanceof Promise?e.then((e=>{this._send(t,{id:n.id,result:e||{}})})).catch((e=>{this._sendError(t,n,-32603,e)})):this._send(t,{id:n.id,result:e||{}})}catch(e){this._sendError(t,n,-32603,e)}else this._sendError(t,n,-32601)}else this.emit(n.method,n.params);else this._sendError(t,n,-32600)}setLogging({logEmit:e,logConsole:t}={}){this._emitLog=e,this._consoleLog=t}_logMessage(e,t){this._consoleLog&&console.log("Server "+("send"===t?">":"<"),e),this._emitLog&&this.emit(t,e)}_send(e,t){const n=JSON.stringify(t);this._logMessage(n,"send"),e.send(n)}_sendError(e,t,n,i){try{this._send(e,{id:t&&t.id||-1,error:this._errorFromCode(n,i&&i.message||i,t&&t.method)})}catch(i){}}_errorFromCode(e,t,n){let i="";switch(e){case-32603:i=`InternalError: Internal Error when calling '${n}'`;break;case-32601:i=`MethodNotFound: '${n}' wasn't found`;break;case-32600:i="InvalidRequest: JSON sent is not a valid request object";break;case-32700:i="ParseError: invalid JSON received"}return{code:e,message:i,data:t}}expose(e,t){this._exposedMethodsMap.set(e,t)}notify(e,t){if(!this._socketServer.clients)throw new Error('SocketServer does not support broadcasting. No "clients: LikeSocket[]" property found');for(let n of this._socketServer.clients)this._send(n,{method:e,params:t})}api(e){if(!Proxy)throw new Error("api() requires ES6 Proxy. Please use an ES6 compatible engine");return new Proxy({},{get:(t,n)=>{if(t[n])return t[n];if("__proto__"===n||"prototype"===n)return Object.prototype;if(void 0===e)t[n]=this.api(`${n}.`);else if("on"===n)t[n]=(t,n)=>this.on(`${e}${t}`,n);else if("emit"===n)t[n]=(t,n)=>this.notify(`${e}${t}`,n);else if("on"===n.substr(0,2)&&n.length>3){const i=n[2].toLowerCase()+n.substr(3);t[n]=t=>this.on(`${e}${i}`,t)}else if("emit"===n.substr(0,4)&&n.length>5){const i=n[4].toLowerCase()+n.substr(5);t[n]=t=>this.notify(`${e}${i}`,t)}else{if("expose"!==n)return;t[n]=t=>{if(!t||"object"!=typeof t)throw new Error("Expected an iterable object to expose functions");for(let n in t)"function"==typeof t[n]&&this.expose(`${e}${n}`,t[n].bind(t))}}return t[n]}})}}Fv.Server=Av;class Bv extends i.EventEmitter{constructor(){super(),this._port=void 0,this._host=void 0,this._ws=void 0}async connect(e,t){this._port=e,this._host=t;const n=await this._discoverWebsocketPath();this._ws=new hv(n);const i=new Rv(this._ws,{logConsole:!1}).api();i.Runtime.enable(),await lg(100),this._api=i,this._api.Runtime.on("consoleAPICalled",(e=>{this.emit("consoleAPICalled",e)})),this._api.Runtime.on("exceptionThrown",(e=>{this.emit("exceptionThrown",e)})),this._api.Runtime.on("executionContextDestroyed",(e=>{this.emit("executionContextDestroyed",e)}))}async disconnect(){this._ws.close(),this.status="disconnect"}api(){return this._api}async generateObjectStr(e,t=20){let n="{",i=!0;for(let o=0;o<e.length;o++){const r=e[o];if(!r.enumerable)continue;i=!1;const{type:s,subtype:a,description:c,objectId:l,value:u}=r.value,d=a||s;let p=void 0!==u?u:c;switch(d){case"object":case"array":p=await this.getObject(l,d,t-1),p||(p='"<层级过深，无法展示内容>"');break;case"date":p=`new Date("${p}")`}n+=`"${r.name}"`,n+=":",n+="string"===d?JSON.stringify(p):p,n+=","}return i||(n=n.slice(0,-1)),n+="}",n}delayReleaseObject({objectId:e}={}){setTimeout((()=>{"disconnect"!==this.status&&this.api().Runtime.releaseObject({objectId:e})}),18e5)}async generateArrayStr(e,t=20){let n="[",i=!0;for(let o=0;o<e.length;o++){const r=e[o];if(!r.enumerable)continue;i=!1;const{type:s,subtype:a,description:c,objectId:l,value:u}=r.value,d=a||s;let p=void 0!==u?u:c;switch(d){case"object":case"array":p=await this.getObject(l,d,t-1),p||(p='"<层级过深，无法展示内容>"');break;case"date":p=`new Date("${p}")`}n+="string"===d?JSON.stringify(p):p,n+=","}return i||(n=n.slice(0,-1)),n+="]",n}async getObject(e,t,n=20){if(n<0)return!1;const i=await this.api().Runtime.getProperties({objectId:e,ownProperties:!0});switch(t){case"object":return this.generateObjectStr(i.result,n);case"array":return this.generateArrayStr(i.result,n)}}_discoverWebsocketPath(){return this._fetchJSON("/json").then((([{webSocketDebuggerUrl:e}])=>e))}_fetchJSON(e){return new Promise(((t,n)=>{const i=G.default.get({host:this._host,port:this._port,path:e}),o=[];i.on("error",n),i.on("response",(function(e){e.on("error",n),e.on("data",(e=>o.push(e))),e.on("end",(function(){const i=Buffer.concat(o).toString();if(200===e.statusCode)try{t(JSON.parse(i))}catch(e){n(new Error(`Response didn't contain JSON: ${i}`))}else n(new Error(`Unexpected ${e.statusCode}: ${i}`))}))}))}))}}const Mv=/^((?:[A-Za-z]:)?(?:[\\/][^/:?#]+)+)(?::(\d+))?(?::(\d+))?$/,Uv=/\[云(函数|对象)：(\w+)]/;function qv(e,{cloudFunctionDirPath:t}){const n=[],i=e.length;let o=0,r="",s=o;for(;o<=i;){const t=e.charAt(o);if(t&&-1===" \t()<>[]'\"、。｡､，．：；‘“〈《「『【〔（［｛｢｣｝］）〕】』」》〉”’｀～…".indexOf(t))r+=t;else{if(r){const e=r.match(Mv),t=o;if(e){const{1:i,2:o,3:r}=e;n.push({linkPosition:{start:s,end:t},onOpen:function(){tg.workspace.openTextDocument(i).then((e=>{tg.window.showTextDocument(e,{selection:{start:{line:o?Number(o):0,character:r?Number(r)-1:0}}})}))}})}}r="",s=o+1}o++}const a=e.match(Uv);if(a&&t){const{1:i,2:o}=a,r="函数"===i,s=E.default.resolve(t,o,r?"index.js":"index.obj.js");s&&n.push({linkPosition:{start:e.indexOf(o),end:e.indexOf(o)+o.length},onOpen:function(){tg.window.revealFile(s),tg.workspace.openTextDocument(s)}})}return{text:e,hyperlinks:n}}const Wv={INSPECTOR_ASYNC_STACK_TRACES_NOT_AVAILABLE:/\[INSPECTOR_ASYNC_STACK_TRACES_NOT_AVAILABLE\]/,NO_WARNING:/^\(Use `node --trace-warnings ...`/};class Jv extends i.EventEmitter{constructor({title:e,id:t,workspaceFolder:n,provider:i,name:o,uniCloudInfo:r}){super(),this.workspaceFolder=n,this.title=e,this.id=t,this.provider=i,this.name=o,this.uniCloudInfo=r,this._outputView=null,this._show=!1,this.updateProvider(this.provider),this._init()}updateProvider(e){this.provider=e;const t=this.uniCloudInfo.find((t=>t.provider===e));this.spaceName=t&&t.name;const n=bg[this.provider];this.outputPrefix=1===this.uniCloudInfo.length?"[本地调试]":`[本地调试:${n}:${this.spaceName}]`,this.outputPrefixLength=this.outputPrefix.length}appendMultiline({level:e="info",lastFrame:t,lines:n}){for(let i=0;i<n.length;i++){const o=n[i];let r=o.text;const s=o.hyperlinks||[];if(0===i&&t){const e=t.lineNumber+1,n=t.columnNumber,i=`${t.relativeUrl}:${e}:${n}`;s.push({linkPosition:{start:r.length+1,end:r.length+1+i.length},onOpen:async function(){tg.workspace.openTextDocument(t.url).then((t=>{tg.window.showTextDocument(t,{selection:{start:{line:e,character:n}}})}))}}),r=r+" "+i}this.appendLine({level:e,line:r,hyperlinks:s})}}appendConsole({level:e="info",lastFrame:t,lines:n,multiline:i}){let o="",r=[];if(i)this.appendMultiline({level:e,lastFrame:t,lines:n});else{for(let e=0;e<n.length;e++){const t=n[e],i=o.length;o+=t.text+" ",t.hyperlinks&&(r=r.concat(t.hyperlinks.map((e=>(e.linkPosition.start+=i,e.linkPosition.end+=i,e)))))}if(t){const e=o.length,n=t.lineNumber+1,i=t.columnNumber,s=`${t.relativeUrl}:${n}:${i}`;r.push({linkPosition:{start:e,end:e+s.length},onOpen:async function(){tg.workspace.openTextDocument(t.url).then((e=>{tg.window.showTextDocument(e,{selection:{start:{line:n,character:i}}})}))}}),o+=s}this.appendLine({level:e,line:o,hyperlinks:r})}}appendPossibleHyperLink({line:e,hyperlinks:t=[]}={}){const{hyperlinks:n}=qv(e,{cloudFunctionDirPath:E.default.resolve(this.workspaceFolder,`uniCloud-${this.provider}`,"cloudfunctions")});return n.filter((({linkPosition:e}={})=>!t.some((({linkPosition:t}={})=>e.start<=t.end&&e.end>=t.start))))}appendLine(e){(function(e){for(const t in Wv)if(Wv[t].test(e))return t})(e.line)||(e.line=this.outputPrefix+e.line,e.hyperlinks=e.hyperlinks||[],e.hyperlinks.forEach((e=>{e.linkPosition.start=e.linkPosition.start+this.outputPrefixLength,e.linkPosition.end=e.linkPosition.end+this.outputPrefixLength})),e.hyperlinks.push(...this.appendPossibleHyperLink({line:e.line,hyperlinks:e.hyperlinks})),this._outputView.appendLine(e))}_init(){this._outputView=tg.window.createOutputView({id:this.id,title:this.title})}disconnect(){}}function Hv(e){let t="{";const n=e.properties.length>3,i=Math.min(e.properties.length,3);for(let n=0;n<i;n++){const i=e.properties[n],o=i.value;t+=`"${i.name}"`,t+=":",t+="string"===i.type?JSON.stringify(o):o,t+=","}return n?t+="...":i&&(t=t.slice(0,-1)),t+="}",t}function Vv(e){const{properties:t,description:n}=e;if(n&&/Arguments\(\d+\)/.test(n))return n;let i="[";const o=t.length>3,r=Math.min(t.length,3);for(let e=0;e<r;e++){const n=t[e],o=n.value;i+="string"===n.type?JSON.stringify(o):o,i+=","}return o?i+="...":r&&(i=i.slice(0,-1)),i+="]",i}function zv(e){const t=process.env.UNICLOUD_DEBUGGER_PATH.replace(/\\/g,"\\\\"),n=new RegExp("\\W*at ((?:.* )\\("+t+".*\\)|"+t+".*)$");return{multiline:!0,text:e.replace(/\r\n/g,"\n").split("\n").filter((e=>!n.test(e))).join("\n")}}const Gv={plainParser:e=>({text:Hv(e.preview),objectId:e.objectId,objectType:"object"}),typedarrayParser:e=>({text:Vv(e.preview),objectId:e.objectId}),arrayParser:e=>({text:Vv(e.preview),objectId:e.objectId,objectType:"array"}),nullParser:e=>({text:"null",objectId:e.objectId}),errorParser:e=>({...zv(e.description),objectId:e.objectId}),defaultParser:e=>({text:e.description,objectId:e.objectId})},Kv={objectParser:e=>{if(!e.subtype)return Gv.plainParser(e);let t=e.subtype+"Parser";return Gv[t]||(t="defaultParser"),Gv[t](e)},undefinedParser:()=>({text:"undefined"}),stringParser:e=>({multiline:e.value.indexOf("\n")>-1,text:e.value}),defaultParser:e=>({text:void 0!==e.value?e.value+"":e.description})};function Zv(e){return e=e.replace(/\\/g,"/").replace("win32"===process.platform?"file:///":"file://",""),decodeURIComponent(e)}function Yv(){tg.workspace.openTextDocument({content:"此对象已不可预览，请注意为减少内存占用日志内打印的对象生存时间为30分钟，超出30分钟将不可查看",language:"javascript"})}class Xv extends i.EventEmitter{isTimeEndTpl(e){const{type:t,stackTrace:n}=e,{functionName:i,url:o}=n&&n.callFrames&&n.callFrames[0]||{};return"log"===t&&"timeLogImpl"===i&&(0===o.indexOf("internal/")||0===o.indexOf("node:internal/"))}parseConsole(e){const{type:t,args:n,stackTrace:i,timestamp:o}=e;if(dg("parseConsole: "+JSON.stringify(e)),this.isTimeEndTpl(e))return;const r=function(e){return e.map((e=>{let t=e.type?e.type+"Parser":"defaultParser";return Kv[t]||(t="defaultParser"),Kv[t](e)}))}(n),s={error:"error",warn:"warning",warning:"warning"}[t]||"info";let a;const c=fg(this.workspaceFolder),l=fg(process.env.UNICLOUD_DEBUGGER_PATH);if(i&&i.callFrames){if(a=i.callFrames.find((e=>c.test(Zv(e.url)))),!a){const e=i.callFrames[0];l.test(Zv(e.url))||/^internal\//.test(e.url)||/^node:internal\//.test(e.url)||(a=e)}a&&(a.url=Zv(a.url),a.relativeUrl=a.url.replace(c,""))}return{level:s,parsedArgs:r,multiline:r.some((e=>e.multiline)),lastFrame:a,timestamp:o}}parseUncaughtException({exceptionDetails:e,timestamp:t}={}){return this.parseConsole({type:"error",args:[e.exception],stackTrace:e.stackTrace,timestamp:t})}parseText(e){const t=this.inspector;let n=[];for(let i=0;i<e.length;i++){const o=e[i];if(o.objectId&&t.delayReleaseObject({objectId:o.objectId}),o.objectId&&o.objectType){let e="{}";t.getObject(o.objectId,o.objectType).then((t=>{e=t})).catch((()=>{e='{"errCode": "SYSTEM_ERROR","errMsg": "Unable to get object content"}'}));const i={linkPosition:{start:0,end:o.text.length},onOpen:function(){tg.workspace.openTextDocument({content:e,language:"javascript"})}};this.delayDestroyHyperLink(i),o.hyperlinks=[i],n.push(o);continue}const r=o.text.replace(/\r\n/g,"\n").split("\n").map((e=>qv(e,{cloudFunctionDirPath:E.default.resolve(this.workspaceFolder,"uniCloud-"+this.provider,"cloudfunctions")})));n=n.concat(r)}return n}delayDestroyHyperLink(e){setTimeout((()=>{e.onOpen=Yv}),18e5)}}const Qv=new cg({expireThreshold:1e4});async function ew({provider:e,spaceId:t,appId:n}={}){return Qv.get(`${t}@${e}`,(async function(){return async function({provider:e,spaceId:t,appId:n}={}){dg("[GetUniCloudSecret]未命中缓存");const i=await hg({path:"/serverless/space/debug-token",body:{provider:e,spaceId:t,appid:n}});let o;switch(e){case"aliyun":{const{Credentials:e={},EndPoint:n,ClientSecret:r}=i,{Token:s}=e;o={spaceId:t,serverSecret:s,clientSecret:r,endpoint:n};break}case"tcb":{const{TmpSecretId:e,TmpSecretKey:n,Token:r}=i.Credentials;o={spaceId:t,secretId:e,secretKey:n,sessionToken:r};break}case"alipay":{const{AK:e,SK:n,AppId:r,EndPoint:s}=i.Credentials;o={spaceAppId:r,spaceId:t,accessKey:e,secretKey:n,endpoint:s};break}}const r=parseInt(i.RestTime);return dg("[GetUniCloudSecret]请求云端成功"),{value:o,expired:Date.now()+1e3*r}}({provider:e,spaceId:t,appId:n})}))}tg.authorize.onUserLogout((function(){Qv.clear()}));const tw=new cg({expireThreshold:1e4});async function nw({provider:e,spaceId:t,appId:n}={}){return tw.get(`${t}@${e}`,(async function(){return async function({provider:e,spaceId:t,appId:n}={}){dg("[GetRedisToken]未命中缓存");const i=await hg({path:"/serverless/redis/invoke-token",body:{provider:e,spaceId:t,appid:n}}),{token:o,expireTime:r}=i,s=1e3*parseInt(r);return dg("[GetRedisToken]请求云端成功"),{value:o,expired:s}}({provider:e,spaceId:t,appId:n})}))}async function iw({provider:e,spaceId:t,appId:n}={}){const{space:i={},function:o={},extension:r={}}=await hg({path:"/serverless/space/info",body:{provider:e,spaceId:t,appid:n}});return{basicSpaceInfo:{redisEnable:i.redisEnable||!1,blackListEnable:o.blackListEnable||!1,frequencyLimitEnable:o.frequencyLimitEnable||!1,keepOldSpaceIdInRuntime:i.keepOldSpaceIdInRuntime||!1},extensionInfo:{pushConfig:r["uni-cloud-push"]||{},extStorageConfig:r["uni-cloud-ext-storage"]||{}}}}tg.authorize.onUserLogout((function(){tw.clear()}));const ow=new cg({expireThreshold:1e4});async function rw({provider:e,spaceId:t,appId:n}={}){return ow.get(`${t}@${e}`,(async function(){return async function({provider:e,spaceId:t,appId:n}={}){dg("[GetServiceSecret]未命中缓存");const i=await hg({path:"/serverless/space/tmp-secret",body:{provider:e,spaceId:t,appid:n}}),{keyId:o,secret:r,expireTime:s}=i,a=parseInt(s);return dg("[GetServiceSecret]请求云端成功"),{value:{secretKeyId:o,secretKey:r},expired:a}}({provider:e,spaceId:t,appId:n})}))}tg.authorize.onUserLogout((function(){ow.clear()}));const sw=new ig({host:"127.0.0.1",minPort:9e3}),aw=new ig({host:"127.0.0.1",minPort:7e3});class cw extends Xv{constructor({appId:e,workspaceFolder:t,workspaceId:n,name:i,clientInfo:o,uniCloudInfo:r,runMode:s="run"}){super(),this.workspaceFolder=t,this.workspaceId=n,this.clientInfo={},this.name=i,this.appId=e,this.runMode=s,this.addClient(o),this.uniCloudInfo=r;const a=this.getLaunchConfig();let c=a&&a.provider;if(1===this.uniCloudInfo.length&&(c=this.uniCloudInfo[0].provider),this.uniCloudConfig=a,c){if(!this.uniCloudInfo.find((e=>e.provider===c)))throw new eg({code:"SYSTEM_ERROR",message:"项目下.hbuilderx/launch.json内配置的provider在本项目中不可用"});this.provider=c}else switch(r.length){case 0:throw new eg({code:"SYSTEM_ERROR",message:"项目未绑定uniCloud服务空间，uniCloud本地调试服务未启动，请绑定后重试"});case 1:this.provider=r[0].provider;break;case 2:throw new eg({code:"SYSTEM_ERROR",message:"项目绑定了多个服务空间，请在项目目录下的.hbuilderx/launch.json内配置provider指定本地调试使用的服务空间"});default:throw new eg({code:"SYSTEM_ERROR",message:"获取项目uniCloud配置出错"})}const l=this.uniCloudInfo.find((e=>e.provider===this.provider));this.realWorkspace=l.workspaceFolder,this.spaceId=l.spaceId,this.status="ready",this.outputChannelTitle=`[${this.name}] - uniCloud控制台`,this.outputChannelId=`${this.workspaceId}-unicloud`}async getSecret({provider:e}){const t=this.uniCloudInfo.find((t=>t.provider===e)),{spaceId:n}=t;return ew({provider:e,spaceId:n,appId:this.appId,useCache:!0})}notify({level:e="info",info:t,forceshow:n}){this.outputChannel.appendLine({level:e,line:t,forceshow:n})}getLaunchConfig(){const e=E.default.resolve(this.workspaceFolder,".hbuilderx/launch.json");if(O.default.existsSync(e))try{return(lc(e).configurations||[]).find((e=>"uniCloud"===e.type))}catch(e){throw new eg({code:"SYSTEM_ERROR",message:"项目目录下.hbuilderx/launch.json格式不正确，请检查"})}}async checkCloudFunction({provider:e}={}){const t=Pc(this.realWorkspace,e).map((e=>e.name));if(!t.length)return;const n=this.uniCloudInfo.find((t=>t.provider===e)),{appId:i,spaceId:o}=n,r=await async function({provider:e,appId:t,spaceId:n}={}){const{functions:i}=await hg({path:"/serverless/function/list",body:{provider:e,spaceId:n,appid:t,page:1,pageSize:200}});return(i||[]).map((e=>e.name))}({provider:e,appId:i,spaceId:o}),s=t.filter((e=>!r.includes(e)));s.length&&(this.notify({level:"warning",info:"检测到以下加密云函数未上传到云端，可能会影响云函数调试、运行，请检查是否已执行了项目初始化（uniCloud目录右键选择“运行云服务空间初始化向导”）"}),this.notify({level:"warning",info:`未上传的加密云函数列表如下：${s.join("、")}`}))}async checkDatabase({provider:e}={}){const t=Lc(this.workspaceFolder,e);if(!t.length)return;const n=this.uniCloudInfo.find((t=>t.provider===e)),{appId:i,spaceId:o}=n,r=await async function({provider:e,appId:t,spaceId:n}={}){const{collections:i}=await hg({path:"/serverless/database/collections",body:{provider:e,spaceId:n,appid:t,page:1,pageSize:200}});return(i||[]).map((e=>e.name))}({provider:e,appId:i,spaceId:o}),s=t.filter((e=>!r.includes(e)));s.length&&(this.notify({level:"warning",info:"检测到以下数据表未在云端创建，可能会影响云函数调试、运行，请检查是否已执行了项目初始化（uniCloud目录右键选择“运行云服务空间初始化向导”）"}),this.notify({level:"warning",info:`未创建的数据表列表如下：${s.join("、")}`}))}async checkDependency({provider:e}={}){const t=kc(this.realWorkspace,e);for(let n=0;n<t.length;n++){const i=t[n],o=Ec(i),r=await vg(o),s=_c(i),a=await wg(s),c=r.concat(a).filter((e=>"local"!==e.type));if(0===c.length)continue;this.notify({level:"warning",info:"检测到以下本地云函数/公共模块缺失依赖，可能影响本地云函数调试、运行，正在进行安装..."});const l=c.map((({dir:e,commonModulePath:t})=>{const n=e.replace(/\\/g,"/").split("/").pop();return t?"common/"+n:n}));this.notify({level:"info",info:`缺少依赖的本地云函数/公共模块：${l.join("、")}`});for(let t=0;t<c.length;t++){const n=c[t],i=n.dir,o=i.replace(/\\/g,"/").split("/").pop(),r=n.commonModulePath?"公共模块":"云函数";try{"local"!==n.type&&this.notify({level:"info",info:`${r}${o}开始安装依赖`}),await xg(i),"local"!==n.type&&this.notify({level:"info",info:`${r}${o}依赖安装完成`})}catch(e){const t=E.default.resolve(i,"node_modules");O.default.existsSync(t)&&this.notify({level:"warning",info:`文件夹(${i})中存在node_modules，且其中依赖缺失，如果出现依赖安装失败的错误请手动删除此node_modules再试`}),("local"!==n.type?`${r}${o}依赖安装失败\n${e.message}`:`${r}${o}引入公共模块失败\n${e.message}`).split("\n").forEach((e=>{this.notify({level:"error",info:e})}))}}}}exposeMethod(){const e={getSecret:ew,getServiceSecret:rw,getRedisToken:nw},t={provider:this.provider,spaceId:this.spaceId,appId:this.appId};for(const n in e)this._jsonRpcServer.expose(n,(()=>e[n]({...t})))}initBridge(e){this._jsonRpcServer=new nc({bridgeProcess:e}),this.exposeMethod()}heartBeat(e){e&&(this.heartBeatInterval=setInterval((()=>{(function(e){try{return process.kill(e,0)}catch(e){return"EPERM"===e.code}})(e)||(this.notify({level:"warning",info:"uniCloud本地调试服务意外结束，请重新运行项目",forceshow:!0}),this.stop())}),3e3))}stopHeartBeat(){this.heartBeatInterval&&clearInterval(this.heartBeatInterval)}async startServer(){const e=await iw({provider:this.provider,spaceId:this.spaceId,appId:this.appId});this.debugPort=await sw.getPort(),this.servePort=await aw.getPort();const t=r.fork("../server/index.js",{execArgv:[`--inspect=${this.debugPort}`],cwd:__dirname,silent:!0,env:{WORKSPACE_FOLDER:this.workspaceFolder,UNICLOUD_SPACE_LIST:JSON.stringify(this.uniCloudInfo),UNICLOUD_SPACE_PROVIDER:this.provider,UNICLOUD_DEBUGGER_PATH:process.env.UNICLOUD_DEBUGGER_PATH,UNICLOUD_SPACE_INFO:JSON.stringify(e.basicSpaceInfo),UNICLOUD_PUSH_CONFIG:JSON.stringify(e.extensionInfo.pushConfig),UNICLOUD_EXT_STORAGE_CONFIG:JSON.stringify(e.extensionInfo.extStorageConfig),UNICLOUD_PLUGIN_PID:process.pid,UNICLOUD_SERVE_PORT:this.servePort,NODE_SKIP_PLATFORM_CHECK:"1"}});this.initBridge(t);const{Transform:n}=require("stream"),i=new n({transform:function(e,t,n){n()}});t.stdout.pipe(i),this.heartBeat(t.pid),this.serverProcess=t;const o=this;return new Promise(((e,n)=>{t.on("message",(function i(r){if("object"==typeof r)switch(r.action){case"server/start":{const{address:n}=r.data;o.address=n,o.status="start",t.removeListener("message",i),e();break}case"server/error":{const{code:e,message:o,detail:s}=r.data;if(t.removeListener("message",i),"EADDRINUSE"===e)return void n(new eg({code:"EADDRINUSE",message:`指定端口（${s.servePort}）冲突，请重新指定或者直接去除此项配置`}));n(new eg({code:e,message:o}));break}}})),setTimeout((()=>{n(new eg({code:"SERVER_START_TIMEOUT",message:"本地调试服务启动超时"}))}),5e3)}))}updateProvider(e){this.provider=e;const t=this.uniCloudInfo.find((e=>e.provider===this.provider));this.workspaceFolder=t.workspaceFolder,this.spaceId=t.spaceId,this.outputChannel.updateProvider(e)}getPlatformLaunchType(e,t){const n=[t];switch(t){case"web":n.push("h5");break;case"h5":n.push("web");break;case"app":n.push("app-plus");break;case"app-plus":n.push("app")}if(!e)return"remote";n.push("default");let i="remote";for(let t=0;t<n.length;t++){const o=n[t],r=e[o]&&e[o].launchtype;if(r){i=r;break}}return i}checkConfig(){let e;try{e=this.getLaunchConfig()}catch(e){}let t=e&&e.provider;if(1===this.uniCloudInfo.length&&(t=this.uniCloudInfo[0].provider),t&&t!==this.provider){const e=this.uniCloudInfo.find((e=>e.provider===t));if(!e)return void this.notify({level:"error",info:".hbuilderx/launch.json内配置的provider在本项目下不可用"});this.updateProvider(t),this.notify({level:"warning",info:`当前uniCloud本地调试服务使用的服务空间将切换为:[${bg[t]}:${e.name}]`})}const n=this.uniCloudConfig,i=this.uniCloudInfo.find((e=>e.provider===this.provider));["h5","web","app-plus","app","mp-weixin","mp-baidu","mp-alipay","mp-toutiao","mp-qq","mp-360","mp-kuaishou","mp-lark","mp-jd","quickapp-native","quickapp-webview"].forEach((t=>{const o=this.getPlatformLaunchType(e,t),r=this.getPlatformLaunchType(n,t);if(o!==r){const e=Object.keys(this.clientInfo).filter((e=>this.clientInfo[e].type===t));e.length&&e.forEach((e=>{this.clientInfo[e]&&this.clientInfo[e].outputView.appendLine({level:"warning",line:"local"===o?"已连接本地云函数环境。注意事项详见：https://uniapp.dcloud.net.cn/uniCloud/quickstart?id=calllocalfunction":`已连接云端云函数环境，服务空间id为${i.spaceId}`})}))}})),this.uniCloudConfig=e}watchLaunchJson(){const e=E.default.resolve(this.workspaceFolder,".hbuilderx/launch.json");return O.default.watch(e,{},(()=>{this.checkProviderTimeout&&clearTimeout(this.checkProviderTimeout),this.checkProviderTimeout=setTimeout((()=>{this.checkConfig(),this.checkProviderTimeout=null}),300)}))}async start(){this.outputChannel=new Jv({title:this.outputChannelTitle,id:this.outputChannelId,workspaceFolder:this.workspaceFolder,provider:this.provider,name:this.name,uniCloudInfo:this.uniCloudInfo});for(let e=0;e<this.uniCloudInfo.length;e++){const t=this.uniCloudInfo[e].provider;this.checkDependency({provider:t}),this.checkCloudFunction({provider:t}),this.checkDatabase({provider:t})}await this.startServer(),this.launchJsonWatcher=this.watchLaunchJson();const e=new Bv;var t;this.inspector=e,await e.connect(this.debugPort,"localhost"),e.on("consoleAPICalled",(e=>{try{const t=this.parseConsole(e);if(!t)return;t.lines=this.parseText(t.parsedArgs),this.outputChannel.appendConsole(t)}catch(e){console.error(e)}})),e.on("exceptionThrown",(e=>{try{const t=this.parseUncaughtException(e);if(!t)return;t.lines=this.parseText(t.parsedArgs),this.outputChannel.appendConsole(t)}catch(e){console.error(e)}})),e.on("executionContextDestroyed",(({executionContextId:e}={})=>{1===e&&(dg("Server stop"),this.stop())})),this.notify({level:"warning",info:"uniCloud本地调试服务已启动，如需客户端调用本地云函数，请在对应的客户端的运行控制台切换为连接本地云函数",forceshow:!0}),t=this.workspaceFolder,!O.default.existsSync(E.default.resolve(t,"main.uts"))&&this.notify({level:"error",info:"如需调试本地云函数代码，请点击控制台右上角的调试按钮开启断点调试服务（双击行号添加断点）\n",forceshow:!0})}stop(){"stop"!==this.status&&(setTimeout((()=>{this.launchJsonWatcher&&this.launchJsonWatcher.close(),this.inspector&&this.inspector.disconnect(),this._jsonRpcServer&&this._jsonRpcServer.close(),this.serverProcess&&(this.serverProcess.removeAllListeners(),this.serverProcess.kill()),this.outputChannel&&this.outputChannel.disconnect()}),1e3),this.stopHeartBeat(),this.status="stop",this.emit("stop"))}get clientCount(){return Object.keys(this.clientInfo).length}addClient(e){dg("新增客户端信息："+JSON.stringify(e)),this.clientInfo[e.clientConsole._id]=e}deleteClient(e){dg("移除客户端信息："+JSON.stringify(e)),delete this.clientInfo[e.clientConsole._id],0===this.clientCount&&"stop"!==this.status&&(this.notify({level:"warning",info:"所有客户端均已停止，uniCloud调试结束",forceshow:!1}),this.stop())}toEnv({platform:e}){const{address:t,servePort:n,debugPort:i}=this;return{address:t,servePort:n,debugPort:i,initialLaunchType:this.getPlatformLaunchType(this.uniCloudConfig,e)}}}let lw;class uw extends Jv{updateProvider(e){this.provider=e;const t=this.uniCloudInfo.find((t=>t.provider===e));this.spaceName=t&&t.name;const n=bg[this.provider];this.outputPrefix=1===this.uniCloudInfo.length?"[本地运行]":`[本地运行:${n}:${this.spaceName}]`,this.outputPrefixLength=this.outputPrefix.length}}class dw extends Xv{constructor({workspaceFolder:e,workspaceId:t,name:n,uniCloudInfo:i,provider:o,port:r,isHxDebugMode:s}){super(),this.workspaceFolder=e,this.workspaceId=t,this.name=n,this.uniCloudInfo=i,this.provider=o,this.debugPort=r,this.isHxDebugMode=s,this.outputChannelTitle=`[${this.name}] - uniCloud控制台`,this.outputChannelId=`${this.workspaceId}-unicloud`}async start(){this.outputChannel=new uw({title:this.outputChannelTitle,id:this.outputChannelId,workspaceFolder:this.workspaceFolder,provider:this.provider,name:this.name,uniCloudInfo:this.uniCloudInfo});const e=new Bv;this.inspector=e,await e.connect(this.debugPort,"localhost"),e.on("consoleAPICalled",(async e=>{try{const t=this.parseConsole(e);if(!t)return;t.lines=this.parseText(t.parsedArgs),this.outputChannel.appendConsole(t)}catch(e){console.error(e)}})),e.on("exceptionThrown",(async e=>{try{const t=this.parseUncaughtException(e);if(!t)return;t.lines=this.parseText(t.parsedArgs),this.outputChannel.appendConsole(t)}catch(e){console.error(e)}})),e.on("executionContextDestroyed",(({executionContextId:e}={})=>{1===e&&(dg("Runner stop"),this.stop())})),this.isHxDebugMode||e.api().Runtime.runIfWaitingForDebugger()}async stop(){"stop"!==this.status&&(setTimeout((()=>{this.inspector&&this.inspector.disconnect(),this.outputChannel&&this.outputChannel.disconnect()}),1e3),this.status="stop",this.emit("stop"))}}const pw=new Map,fw=new ig({host:"127.0.0.1",minPort:9e3});async function hw({provider:e,spaceId:t,appId:n,workspaceFolder:i,functionName:o,functionPath:s,functionEvent:a,uuid:c,debug:l=!1,extraEnv:u={}}={}){const d=await async function({workspaceFolder:e,provider:t,spaceId:n,appId:i}={}){const o=await ew({provider:t,spaceId:n,appId:i}),r=await rw({provider:t,spaceId:n,appId:i}),s=await iw({provider:t,spaceId:n,appId:i}),{allSpaces:a}=await vt({workspaceFolder:await C.default.workspace.getWorkspaceFolder(e)}),c=a.find((e=>e.spaceId===n)),{value:l}=o,{value:u}=r,d={provider:t,spaceId:n,workspaceFolder:e,appId:i,...c};return"aliyun"===t&&(d.clientSecret=l.clientSecret),{WORKSPACE_FOLDER:e,UNICLOUD_DEBUGGER_PATH:process.env.UNICLOUD_DEBUGGER_PATH,UNICLOUD_SPACE_LIST:JSON.stringify([d]),UNICLOUD_SPACE_PROVIDER:t,UNICLOUD_SECRET:JSON.stringify(l),UNICLOUD_SPACE_INFO:JSON.stringify(s.basicSpaceInfo),UNICLOUD_PUSH_CONFIG:JSON.stringify(s.extensionInfo.pushConfig),UNICLOUD_EXT_STORAGE_CONFIG:JSON.stringify(s.extensionInfo.extStorageConfig),UNICLOUD_SERVICE_SECRET:JSON.stringify(u),NODE_SKIP_PLATFORM_CHECK:"1"}}({workspaceFolder:i,provider:e,spaceId:t,appId:n}),p=(s=E.default.resolve(s)).replace(/\\/g,"/").split("/"),f=p.pop();o=o||f;const h=p.join("/"),m=[];let g;l&&(g=await fw.getPort(),dg("运行云对象/云函数，端口："+g),m.push(`--inspect-brk=127.0.0.1:${g}`)),m.push(E.default.resolve(process.env.UNICLOUD_DEBUGGER_PATH,`${e}/index.js`),o,h),a&&m.push(a);const y=r.spawn(process.execPath,m,{silent:!0,cwd:__dirname,stdio:["pipe","pipe","pipe","ipc"],env:{...d,...u}});pw.set(c,y);const v=new nc({bridgeProcess:y});return y.on("exit",(()=>{pw.delete(c),v.close()})),{debugPort:g,functionProcess:y,jsonRpcServer:v}}function mw({uuid:e}={}){pw.has(e)&&(pw.get(e).kill("SIGKILL"),pw.delete(e))}const gw=new Map;async function yw({jqlContent:e,workspaceFolder:t,uuid:n,useCloudSchema:i=!1}={}){const o=await C.default.workspace.getWorkspaceFolder(t),r=(await C.default.window.getActiveTextEditor()).document.uri.fsPath,{allSpaces:s}=await vt({workspaceFolder:o});if(s.length<=0)throw new Error("检测到项目还未关联云服务空间，请先关联云服务空间后再执行");let a,c=s[0];if(s.length>1){const e=r.match(/uniCloud-(tcb|aliyun|alipay)/)[1],t=s.find((t=>t.provider===e));if(!t)throw new Error("检测到项目还未关联云服务空间，请先关联云服务空间后再执行");c=t}try{a=await hw({provider:c.provider,spaceId:c.spaceId,appId:o.appid,workspaceFolder:t,functionName:"jql-runner",functionPath:E.default.resolve(process.env.UNICLOUD_DEBUGGER_PATH,"internal-functions/jql-runner"),functionEvent:JSON.stringify({jqlPath:void 0,jqlContent:e}),uuid:n,debug:!1,extraEnv:{USE_CLOUD_SCHEMA:i?"true":"false"}})}catch(e){return{code:e.code||"SYSTEM_ERROR",message:e.message}}const{functionProcess:l,jsonRpcServer:u}=a;u.expose("getSchema",(({name:e}={})=>async function({provider:e,appId:t,spaceId:n,name:i}={}){const{list:o}=await hg({path:"/serverless/clientdb/schema-list",body:{provider:e,spaceId:n,appid:t,name:i}}),r={};for(let e=0;e<o.length;e++){const t=o[e];r[t.name]=t.content}return r}({provider:c.provider,spaceId:c.spaceId,appId:o.appid,name:e}))),u.expose("getValidateFunction",(({name:e}={})=>async function({provider:e,appId:t,spaceId:n,name:i}={}){const{list:o}=await hg({path:"/serverless/clientdb/validator-list",body:{provider:e,spaceId:n,appid:t,name:i}}),r={};for(let e=0;e<o.length;e++){const t=o[e];r[t.name]=t.content}return r}({provider:c.provider,spaceId:c.spaceId,appId:o.appid,name:e})));let d=!1,p=Buffer.alloc(0);return l.stderr.on("data",(function(e){p=Buffer.concat([p,e])})),new Promise((e=>{l.on("message",(t=>{if("ExecuteResult"!==t.type)return;d=!0,gw.delete(n);const i={data:t.result.dataList,...t.result,message:vw(t.result),fullRes:{result:t.result}};e(i)})),l.on("exit",(t=>{0!==t&&setTimeout((()=>{d||(gw.delete(n),e({code:"INTERNAL_ERROR",message:"出现未知错误，请到论坛或uniCloud官方QQ群反馈：\n"+p.toString("utf-8")}))}),100)}))}))}function vw(e){if(e.message)return e.message;const{data:t,dataList:n,total:i,count:o,updated:r,deleted:s,inserted:a,ids:c,id:l,timeCost:u}=e;let d="";return void 0!==t?(d+=`查询到${t.length}条数据`,void 0!==o&&(d+=`，满足条件的数据总数为${o}条`),500!==t.length&&1e3!==t.length||(d+='，查询数量限制请参考：<a href="https://uniapp.dcloud.net.cn/uniCloud/cf-database?id=limit" target="_blank">https://uniapp.dcloud.net.cn/uniCloud/cf-database?id=limit</a>')):n?d+="批量请求完成":void 0!==a?d+=`批量插入成功，插入条数：${a}，插入数据的id列表为：${c.join(",")}`:void 0!==s?d+=`删除完成，删除条数：${s}`:void 0!==r?d+=`更新完成，更新条数：${r}`:void 0!==i?d+=`计数完成，总条数：${i}`:void 0!==l&&(d+=`插入成功，插入条数：1，id为${l}`),d+=`，请求耗时（含网络传输）：${u}ms`,d}async function ww({uuid:e}={}){mw({uuid:e})}async function xw(e){e.compileType=e.compileType?.toLowerCase();const{workspaceFolder:t,compileType:n}=e,i={},o=function(e,t){const n=_.resolve(e.uri.fsPath,"manifest.json");if(!P.existsSync(n))return!1;const i=P.readFileSync(n,"utf8"),o=Ka.parse(i);return"develop_wx"===t||"release_wx"===t?o?.["mp-weixin"]?.secureNetwork?.enable??!1:("develop"===t||"release"===t)&&"SecureNetwork"in((o?.["app-plus"]||o?.app||o?.plus||{})?.modules||{})}(t,n),{allSpaces:r}=await vt({workspaceFolder:t});return("develop_wx"===n||"release_wx"===n||"develop"===n||"release"===n)&&o&&r.length&&(i.UNI_SECURE_NETWORK_CONFIG=JSON.stringify(await async function(e){const{provider:t,spaceId:n,allSpaces:i}=await vt({workspaceFolder:e});return async function({provider:e,appId:t,spaceId:n,extSpaces:i=[]}={}){const{rules:o}=await hg({path:"/serverless/secureNetwork/client-rules",body:{provider:e,spaceId:n,appid:t,extSpaces:i}});return o}({provider:t,spaceId:n,appId:wc(e.uri.fsPath),extSpaces:i.map((e=>({spaceId:e.spaceId,provider:e.provider})))})}(t))),i.UNI_CLOUD_SPACES=JSON.stringify(await async function(e){const{allSpaces:t}=await vt({workspaceFolder:e}),n=await tg.workspace.getWorkspaceFolders(),i=[];for(const e of t){const t=JSON.parse(JSON.stringify(e));t.id=t.id||t.spaceId,t.name=t.name||t.spaceName,t.relatedProjectId&&(t.workspaceFolder=pg(n.find((e=>e.id===t.relatedProjectId)))),i.push(t)}return i}(t)),i}const bw=new Map;class Sw{static createInstance(e,t){const n=e.workspaceFolder.id;if(!bw.has(n)){const i=new Sw(e,t);return bw.set(n,i),i}}static getInstance(e){return bw.get(e)}static removeInstance(e){bw.delete(e)}constructor(e,t){this.session=e,this.serverPool=t,this.sessionTitle=`[${e.workspaceFolder.name}] - uniCloud控制台`,this.sessionId=`workbench.view.console.${e.workspaceFolder.id}-unicloud`}async initUniCloudLauncherFile(){const e=this.session.platform||"app";await this.getLauncherConfiguration("default")||await this.setLauncherConfiguration({default:{launchtype:"local"},type:"uniCloud"}),await this.getLauncherConfiguration(e)||await this.setLauncherConfiguration({[e]:{launchtype:"local"}});const{provider:t}=await vt({workspaceFolder:this.session.workspaceFolder});await this.setLauncherConfiguration({provider:t})}async start(){const e={workspaceFolder:this.session.workspaceFolder,runMode:"debug",type:this.session.platform,console:this.session?.console};try{dg("服务启动参数："+JSON.stringify(e)),await this.initUniCloudLauncherFile(),this.debugInfo=await this.serverPool.startServer(e)}catch(e){dg("服务启动时捕获到错误："+(e&&e.stack||JSON.stringify(e))),C.default.window.showErrorMessage("uniCloud本地调试服务启动失败："+(e.message||JSON.stringify(e))+"。请调整后重新运行uni-app项目")}await this.session.changeState(this.session.STATE.STARTING)}async stop(){const e={workspaceFolder:this.session.workspaceFolder,runMode:"debug",type:this.session.platform,console:this.session?.console};dg("服务停止参数："+JSON.stringify(e)),this.debugSession&&A.debug.stopDebugging(this.debugSession),await this.serverPool.stopServer(e),await this.session.changeState(this.session.STATE.STOPPING)}async initSession(){const e=await this.getUniAppConsoleToolBarItems();await this.session.init({autoDelete:!1,consoleOptions:{id:this.sessionId,title:this.sessionTitle,toolbarItems:[{type:"checkbox",when:`viewId == '${this.sessionId}'`,label:"开启调试",onClick:async e=>{this.debugInfo&&e&&(this.debugSession=await A.debug.startDebugging(this.session.workspaceFolder,{type:"pwa-node",request:"attach",name:`uniCloud:${this.session?.workspaceFolder?.name}`,continueOnAttach:!0,port:this.debugInfo.debugPort,skipFiles:this.debugInfo.skipFiles}),await this.session.console.appendLine({line:"",level:"success"}),await this.session.console.appendLine({line:"[本地调试]开启调试成功",level:"success"})),!e&&this.debugSession&&(A.debug.stopDebugging(this.debugSession),this.debugSession=null,await this.session.console.appendLine({line:"[本地调试]调试已关闭",level:"success"}))}},...e]}},!0)}async getUniAppConsoleToolBarItems(){const e=this.session.platform||"app",{provider:t,allSpaces:n}=await vt({workspaceFolder:this.session.workspaceFolder}),i=await this.getLauncherConfiguration(e),o={aliyun:"阿里云",tcb:"腾讯云",alipay:"支付宝云"},r=[{type:"radioGroup",when:`viewId == '${this.sessionId}' && (session.state == 'STARTING' || session.state == 'STARTED')`,radios:[{text:"连接本地云函数",value:"local"},{text:"连接云端云函数",value:"remote"}],checkedRadio:i?.launchtype||"local",onClick:async({value:t="local"}={})=>{await this.setLauncherConfiguration({[e]:{launchtype:t}})}}];return n.length>1&&r.push({type:"radioGroup",when:`viewId == '${this.sessionId}' && (session.state == 'STARTING' || session.state == 'STARTED')`,radios:n.map((({provider:e})=>({text:o[e]||e,value:e}))),checkedRadio:t,onClick:async({value:e=t}={})=>{await this.setLauncherConfiguration({provider:e})}}),r}async getLauncherConfiguration(e){return(await C.default.workspace.resolveLaunchConfiguration("uniCloud",this.session.workspaceFolder.uri.fsPath)).get(e)}async setLauncherConfiguration(e={}){try{const t=await C.default.workspace.resolveLaunchConfiguration("uniCloud",this.session.workspaceFolder.uri.fsPath);if(t){for(const n in e){const i=e[n];t.set(n,i)}await t.save()}}catch(e){console.error("setProjectLaunchJson",e)}}}async function kw(e){dg("startUniCloud方法收到参数："+JSON.stringify(e));const{workspaceFolder:t}=e,{allSpaces:n}=await vt({workspaceFolder:t});if(!(n.length<=0))try{await C.default.workspace.startLaunching(t,{type:"uniCloud",launcherId:`uniCloud:${t.id}`,version:2})}catch(e){dg("startUniCloud 捕获到错误："+(e&&e.stack||JSON.stringify(e))),C.default.window.showErrorMessage("uniCloud本地调试服务启动失败："+(e.message||JSON.stringify(e))+"。请调整后重新运行uni-app项目")}}function Ew(e){const{workspaceFolder:t}=e;return Sw.getInstance(t.id).getUniAppConsoleToolBarItems()}async function _w(e){const t=Sw.getInstance(e.workspaceFolder.id);t&&(t.stop(),Sw.removeInstance(e.workspaceFolder.id))}const Cw=new class{constructor(){if(lw)return lw;this.serverMap=new Map,lw=this}async parseSession(e){const t=pg(e.workspaceFolder),n=e.workspaceFolder.id,i=e.type,o=e.console,r={};r.type={Develop:"app",Develop_WX:"mp-weixin",Previou_Develop_Uniapp:"web",Develop_Baidu:"mp-baidu",Develop_Alipay:"mp-alipay",Develop_Bytedance:"mp-toutiao",Develop_QQ:"mp-qq",Develop_360:"mp-360",Develop_Huawei:"quickapp-webview",Develop_QuickAppUnion:"quickapp-native",Develop_Kuaishou:"mp-kuaishou",Develop_Feishu:"mp-lark",Develop_Jingdong:"mp-jd"}[i]||i,r.clientConsole=o,r.outputView=tg.window.createOutputView({id:o._id,title:o._title});const s=e.workspaceFolder.name,{allSpaces:a}=await vt({workspaceFolder:e.workspaceFolder});if(!a||0===a.length)throw new eg({code:"SPACE_REQUIRED",message:"当前项目未关联uniCloud服务空间"});const c=await tg.workspace.getWorkspaceFolders(),l=a.map((e=>{const n=e.provider;let i=t;e.relatedProjectId&&(i=pg(c.find((t=>t.id===e.relatedProjectId))));const o=wc(i);if(!o)throw new eg({code:"APPID_REQUIRED",message:i===t?"manifest.json内未配置AppId或格式错误，请重新获取后再试":`项目(${i})下manifest.json内未配置AppId或格式错误，请重新获取后再试`});return{appId:o,provider:n,name:e.spaceName,workspaceFolder:i,...e}})),u=wc(t);if(!u)throw new eg({code:"APPID_REQUIRED",message:"manifest.json内未配置AppId，请重新获取后再试"});return{workspaceFolder:t,workspaceId:n,name:s,appId:u,clientInfo:r,uniCloudInfo:l,runMode:e.runMode||"run"}}serverToReturn(e,t){const n=e.toEnv({platform:t.type});return dg(`服务信息：${JSON.stringify(n)}`),{...n,skipFiles:mg()}}async startServer(e){const{appId:t,workspaceFolder:n,workspaceId:i,name:o,clientInfo:r,uniCloudInfo:s,runMode:a}=await this.parseSession(e);if(dg("收到启动服务请求，参数："+JSON.stringify({appId:t,workspaceFolder:n,workspaceId:i,name:o,uniCloudInfo:s,runMode:a})),!s||0===s.length)return;if(dg(`现有服务为：${Array.from(this.serverMap.keys()).join("，")}，即将启动：${n}`),this.serverMap.has(n)){const e=this.serverMap.get(n);if("stop"!==e.status)return dg(`服务已启动，重用现有服务，服务processId：${e.serverProcess.id}`),e.addClient(r),this.serverToReturn(e,r)}const c={appId:t,workspaceFolder:n,workspaceId:i,name:o,clientInfo:r,uniCloudInfo:s,runMode:a};dg("准备启动服务，参数："+JSON.stringify(c));const l=new cw(c);return l.on("stop",(()=>{this.serverMap.get(n)===l&&this.serverMap.delete(n)})),await l.start(),this.serverMap.set(n,l),dg(`服务已启动，服务processId：${l.serverProcess.pid}`),this.serverToReturn(l,r)}killAllServer(){this.serverMap.forEach((e=>{"stop"!==e.status&&e.stop()})),this.serverMap.clear()}killServer(e){this.serverMap.has(e)&&(this.serverMap.get(e).stop(),this.serverMap.delete(e))}async stopServer(e){const{workspaceFolder:t,clientInfo:n}=await this.parseSession(e);if(!this.serverMap.has(t))return{code:"NO_SUCH_SERVER",message:"no such server"};const i=this.serverMap.get(t);return i.deleteClient(n),{code:0,serverStatus:0===Object.keys(i.clientInfo).length?"stop":i.status}}},Iw=new class{constructor(){this.runnerList=[]}async runLocal({functionPath:e,projectId:t,spaceName:n,port:i,provider:o,debugMode:r=!1,functionStopCallback:s}={}){const a=t,c=vc(e=E.default.resolve(e));c||console.error(`invalid function path: ${e}`);const l=[{provider:o,name:n}],u=c.split("/").pop();await this.startRunner({workspaceFolder:c,workspaceId:a,name:u,uniCloudInfo:l,provider:o,port:i,isHxDebugMode:r,functionStopCallback:s})}async startRunner({workspaceFolder:e,workspaceId:t,name:n,uniCloudInfo:i,provider:o,port:r,isHxDebugMode:s,functionStopCallback:a}){const c=new dw({workspaceFolder:e,workspaceId:t,name:n,uniCloudInfo:i,provider:o,port:r,isHxDebugMode:s});await c.start(),this.runnerList.push(c);const l=this;if(!s)return new Promise(((e,t)=>{c.on("stop",(()=>{l.removeRunner(c),e(),a&&a()}))}));c.on("stop",(()=>{l.removeRunner(c),a&&a()}))}removeRunner(e){const t=this.runnerList.indexOf(e);t>-1&&this.runnerList.splice(t,1)}async killAllRunner(){this.runnerList.forEach((e=>{"stop"!==e.status&&e.stop()})),this.runnerList.splice(0,this.runnerList.length)}};async function jw({functionPath:e,objectPath:t,projectId:n,spaceName:i,provider:o,debugMode:r=!1,spaceId:s,appId:a,workspaceFolder:c,uuid:l,callback:u}={}){if(!a)return{code:"PARAM_REQUIRED",message:"appId为空，请在manifest.json内重新获取"};dg("运行云对象/云函数，参数："+JSON.stringify({functionPath:e,objectPath:t,projectId:n,spaceName:i,provider:o,debugMode:r,spaceId:s,appId:a,workspaceFolder:c,uuid:l})),e=e||t;try{const{code:t,message:d,debugPort:p}=await async function({provider:e,spaceId:t,appId:n,workspaceFolder:i,functionName:o,functionPath:r,uuid:s}={}){let a;try{a=await hw({provider:e,spaceId:t,appId:n,workspaceFolder:i,functionName:o,functionPath:r,uuid:s,debug:!0})}catch(e){return{code:e.code||"SYSTEM_ERROR",message:e.message}}const{debugPort:c,jsonRpcServer:l}=a;return l.expose("getRedisToken",(()=>nw({provider:e,spaceId:t,appId:n}))),{code:0,debugPort:c}}({provider:o,spaceId:s,appId:a,workspaceFolder:c,functionPath:e,uuid:l});return dg("运行云函数/云对象[mark-01]:"+JSON.stringify({code:t,message:d,debugPort:p})),t?{code:t,message:d}:(await lg(100),await Iw.runLocal({functionPath:e,port:p,projectId:n,provider:o,spaceName:i,debugMode:r,functionStopCallback:u}),dg("运行云函数/云对象[mark-02]"),{code:0,skipFiles:mg(),debugPort:p,continueOnAttach:r})}catch(e){return dg(e),{code:e.code||"SYSTEM_ERROR",message:e.message}}}exports.activate=function(e){const t=C.default.commands.registerCommand("extension.stopDebugServer",(async()=>(dg("extension.stopDebugServer"),Cw.killAllServer(),{}))),n=C.default.workspace.registerWorkspaceFolderLauncher("uniCloud",(e=>async function(e,t){const n=Sw.createInstance(e,t);return await n.initSession(),n}(e,Cw)));return e.subscriptions.push(t),e.subscriptions.push(n),{...Me(e),...fh.activate(e),...Bh.activate(e),...em.activate(e),...Pd.activate(e),...Qm(e),async startDebugging(e){dg("startDebugging方法收到参数："+JSON.stringify(e));try{return await Cw.startServer(e)}catch(e){dg("服务启动时捕获到错误："+(e&&e.stack||JSON.stringify(e))),C.default.window.showErrorMessage("uniCloud本地调试服务启动失败："+(e.message||JSON.stringify(e))+"。请调整后重新运行uni-app项目")}},stopDebugging:async e=>(dg("stopDebugging方法收到参数："+JSON.stringify(e)),await Cw.stopServer(e)),async runJQL(e){let t;dg("开始JQL查询："+JSON.stringify(e));try{t=await yw(e)}catch(e){t={code:e.code||"INTERNAL_ERROR",message:e.message,detail:e.stack}}return t},stopJQL:async e=>(dg("停止JQL查询："+JSON.stringify(e)),async function({uuid:e}={}){mw({uuid:e})}(e)),runCloudFunction:jw,stopCloudFunction:ww,runCloudObject:jw,stopCloudObject:ww,async customRequest({method:e,params:t}={}){switch(e){case"spaceChanged":{dg("spaceChanged事件触发："+JSON.stringify(t));const e=pg(t&&t.workspaceFolder);return Cw.serverMap.has(e)?(Cw.serverMap.get(e).notify({level:"warning",info:"服务空间已改变，对本项目的本地调试服务自动关闭。请停止本项目所有正在运行的客户端后重新运行"}),Cw.killServer(e),{code:0}):{code:0}}case"localDebugLog":{dg("开始本地运行："+JSON.stringify(t));const{funurl:e,port:n,projectid:i,provider:o,spacename:r,debugMode:s=!1}=t;return await Iw.runLocal({functionPath:e,projectId:i,spaceName:r,port:n,provider:o,debugMode:s}),{code:0,skipFiles:mg()}}}},getFunctionParam:$c,getCompilerEnvs:xw,startUniCloud:kw,stopUniCloud:_w,getUniCloudConsoleToolBarItems:Ew}},exports.deactivate=function(){fh.deactivate(),Bh.deactivate(),em.deactivate(),Pd.deactivate(),dg("deactivate方法被调用"),Cw.killAllServer(),Iw.killAllRunner()};
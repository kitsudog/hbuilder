"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MongoSerializer=exports.authString=exports.validateTimeout=void 0;const bson_1=require("bson"),faas_server_utils_1=require("@alipay/faas-server-utils"),MAX_TIMEOUT=5*60*1e3;function clampTimeout(t,e){return t>MAX_TIMEOUT?(console.log(`${e} is bigger than 5 min, will set it to 5 min`),MAX_TIMEOUT):t}function validateTimeout(t){if(t===void 0)return t;if(!Array.isArray(t))return clampTimeout(t,"timeout");const[e,n]=t;return[clampTimeout(e,"connection timeout"),clampTimeout(n,"response timeout")]}exports.validateTimeout=validateTimeout;function authString(t,e=""){const n=(0,faas_server_utils_1.getAlipayContext)(),s=Date.now(),o={authorization:"","x-from-app-id":n.APPID,"x-from-env-id":t.fromEnvId,"x-to-env-id":t.toEnvId,"x-from-instance-id":t.functionInstanceId,"x-from-function-name":t.functionName,"x-client-timestamp":`${s}`,"x-trace-id":n.TRACEID},c=["x-from-app-id","x-from-env-id","x-from-instance-id","x-from-function-name","x-client-timestamp","x-to-env-id"],l={path:"",query:"",secretId:t.secretId,secretKey:t.secretKey,method:"POST",headers:o,body:e,timestamp:s,signedHeaders:c,isMySql:!0};o.authorization=(0,faas_server_utils_1.sign)(l);const a=[];for(const i in o){if(i==="authorization")continue;const r=o[i];a.push(`${i}:${r}`)}const u=o.authorization.split(" ");a.push(`SecAlgo:${u[0]}`);for(let i=1;i<u.length;i++){let r=u[i];r.endsWith(",")&&(r=r.substring(0,r.length-1)),a.push(r.replace(/=/g,":").replace(/,/g,";"))}return`!cloudbase:${a.join(",")}`}exports.authString=authString;class MongoSerializer{static serialize(e){return MongoSerializer.filterUndefinedKey(e,[]),bson_1.EJSON.stringify(e)}static deserialize(e){return bson_1.EJSON.deserialize(e)}static filterUndefinedKey(e,n){if(!n.includes(e)){if(n.push(e),!e||typeof e!="object")return e;for(const s in e)e[s]===void 0?delete e[s]:MongoSerializer.filterUndefinedKey(e[s],n)}}}exports.MongoSerializer=MongoSerializer;
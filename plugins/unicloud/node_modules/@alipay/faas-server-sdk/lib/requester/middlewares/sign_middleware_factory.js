"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.signMiddlewareFactory=void 0;const faas_server_utils_1=require("@alipay/faas-server-utils");function signMiddlewareFactory(t,a){return async function(e,d){const r=(0,faas_server_utils_1.getAlipayContext)(),i=Date.now(),n={authorization:"","x-from-app-id":r.APPID,"x-from-env-id":e.config.fromEnvId,"x-to-env-id":e.config.toEnvId,"x-from-instance-id":e.config.functionInstanceId,"x-from-function-name":e.config.functionName,"x-client-timestamp":`${i}`,"x-trace-id":r.TRACEID,"sofa-rpcid":`${r.RPCID}.${++r.rpcCount}`};t.length>0&&t.forEach(s=>{n[s]=e.req.requestOptions.headers?.[s]});const c=["x-from-app-id","x-from-env-id","x-from-instance-id","x-from-function-name","x-client-timestamp","x-to-env-id",...t].sort(),o={path:a?.decodePath?decodeURIComponent(e.req.url.pathname):e.req.url.pathname,query:e.req.url.search.substring(1),secretId:e.config.secretId,secretKey:e.config.secretKey,method:e.req.requestOptions.method,headers:n,body:e.req.requestOptions.content,timestamp:i,signedHeaders:c};o.secretId&&(n.authorization=(0,faas_server_utils_1.sign)(o)),e.req.requestOptions.headers={...n,...e.req.requestOptions.headers},await d()}}exports.signMiddlewareFactory=signMiddlewareFactory;
"use strict";var __assign=this&&this.__assign||function(){__assign=Object.assign||function(u){for(var r,t=1,o=arguments.length;t<o;t++){r=arguments[t];for(var i in r)if(Object.prototype.hasOwnProperty.call(r,i))u[i]=r[i]}return u};return __assign.apply(this,arguments)};var __awaiter=this&&this.__awaiter||function(u,r,t,o){function i(e){return e instanceof t?e:new t(function(s){s(e)})}return new(t||(t=Promise))(function(e,s){function a(l){try{n(o.next(l))}catch(f){s(f)}}function h(l){try{n(o["throw"](l))}catch(f){s(f)}}function n(l){l.done?e(l.value):i(l.value).then(a,h)}n((o=o.apply(u,r||[])).next())})};var __generator=this&&this.__generator||function(u,r){var t={label:0,sent:function(){if(e[0]&1)throw e[1];return e[1]},trys:[],ops:[]},o,i,e,s;return s={next:a(0),"throw":a(1),"return":a(2)},typeof Symbol==="function"&&(s[Symbol.iterator]=function(){return this}),s;function a(n){return function(l){return h([n,l])}}function h(n){if(o)throw new TypeError("Generator is already executing.");while(s&&(s=0,n[0]&&(t=0)),t)try{if(o=1,i&&(e=n[0]&2?i["return"]:n[0]?i["throw"]||((e=i["return"])&&e.call(i),0):i.next)&&!(e=e.call(i,n[1])).done)return e;if(i=0,e)n=[n[0]&2,e.value];switch(n[0]){case 0:case 1:e=n;break;case 4:t.label++;return{value:n[1],done:false};case 5:t.label++;i=n[1];n=[0];continue;case 7:n=t.ops.pop();t.trys.pop();continue;default:if(!(e=t.trys,e=e.length>0&&e[e.length-1])&&(n[0]===6||n[0]===2)){t=0;continue}if(n[0]===3&&(!e||n[1]>e[0]&&n[1]<e[3])){t.label=n[1];break}if(n[0]===6&&t.label<e[1]){t.label=e[1];e=n;break}if(e&&t.label<e[2]){t.label=e[2];t.ops.push(n);break}if(e[2])t.ops.pop();t.trys.pop();continue}n=r.call(u,t)}catch(l){n=[6,l];i=0}finally{o=e=0}if(n[0]&5)throw n[1];return{value:n[0]?n[1]:void 0,done:true}}};Object.defineProperty(exports,"__esModule",{value:true});exports.Storage=void 0;var error_1=require("./error");var utils_1=require("./utils");var Storage=function(){function u(r){this.options=r}u.prototype.getUploadPath=function(r){return"/".concat(r,"?upload_url")};u.prototype.getDownloadPath=function(r){return"/".concat(r,"?download_url&expire=3600")};u.prototype.getBatchDeletePath=function(){return"/?delete"};u.prototype.getBatchDownloadPath=function(){return"/?download_url"};u.prototype.checkCloudPath=function(r){if(typeof r!=="string")return"\u5FC5\u987B\u4E3A\u5B57\u7B26\u4E32";r=r.trim();if(!r)return"\u4E0D\u80FD\u4E3A\u7A7A\u5B57\u7B26\u4E32";if(r.startsWith("/"))return"\u4E0D\u80FD\u4EE5 / \u5F00\u5934";if(r.includes("//"))return"\u4E0D\u80FD\u5305\u542B\u8FDE\u7EED\u7684 /";if(r.length>850)return"\u957F\u5EA6\u4E0D\u80FD\u8D85\u8FC7 850 \u5B57\u8282"};u.prototype.checkFileID=function(r){if(typeof r!=="string")return"\u5FC5\u987B\u4E3A\u5B57\u7B26\u4E32";r=r.trim();if(!r)return"\u4E0D\u80FD\u4E3A\u7A7A\u5B57\u7B26\u4E32"};u.prototype.formatFileID=function(r){return"cloud://".concat(this.options.toEnvId,"/").concat(r.replace(/^\/+/,""))};u.prototype.getCloudPathFromFileID=function(r){var t=r.trim().replace(/^cloud:\/\//,"");var o=t.indexOf("/");if(o<=0){throw error_1.FaasError.INVALID_PARAM_ERR("fileID","\u4E0D\u5408\u6CD5")}var i=t.substring(0,o);var e=t.substring(o+1);if(i!==this.options.toEnvId){console.warn("file ".concat(r," does not belong to env ").concat(this.options.toEnvId))}return e};u.prototype.getUploadFileURL=function(r){return __awaiter(this,void 0,void 0,function(){var t,o,i,e,s,a;return __generator(this,function(h){switch(h.label){case 0:t=typeof r==="string"?r:r.cloudPath;o=this.checkCloudPath(t);if(o){throw error_1.FaasError.INVALID_PARAM_ERR("cloudPath",o)}i=this.getUploadPath(t.trim());return[4,this.request({method:"GET",path:i})];case 1:e=h.sent();s=utils_1.ResponseUtil.handleResponse(e);a=this.formatFileID(s.file_id);return[2,{fileID:a,uploadURL:s.upload_url,requestID:e.requestID}]}})})};u.prototype.uploadFile=function(r){return __awaiter(this,void 0,void 0,function(){var t,o,i,e,s;return __generator(this,function(a){switch(a.label){case 0:return[4,this.getUploadFileURL(r)];case 1:t=a.sent(),o=t.fileID,i=t.uploadURL,e=t.requestID;return[4,this.options.fileUploader.upload({fileID:o,uploadURL:i,fileContent:r.fileContent})];case 2:s=a.sent();if(s.statusCode!==200){throw error_1.FaasError.STORAGE_ERR(60004,"\u4E0A\u4F20\u6587\u4EF6 ".concat(i," \u5931\u8D25"),e)}return[2,{fileID:o,statusCode:s.statusCode}]}})})};u.prototype.downloadFile=function(r){return __awaiter(this,void 0,void 0,function(){var t,o,i,e,s,a;return __generator(this,function(h){switch(h.label){case 0:t=this.checkFileID(r.fileID);if(t){throw error_1.FaasError.INVALID_PARAM_ERR("fileID",t)}o=this.getCloudPathFromFileID(r.fileID);i=this.getDownloadPath(o);return[4,this.request({method:"GET",path:i})];case 1:e=h.sent();s=utils_1.ResponseUtil.handleResponse(e);return[4,this.options.fileUploader.download({fileID:r.fileID,downloadURL:s.download_url})];case 2:a=h.sent();if(a.statusCode!==200){throw error_1.FaasError.STORAGE_ERR(60004,"\u4E0B\u8F7D\u6587\u4EF6 ".concat(s.download_url," \u5931\u8D25"),e.requestID)}return[2,a]}})})};u.prototype.deleteFile=function(r){return __awaiter(this,void 0,void 0,function(){var t,o,i,e,s,a,h,n,l,f;var p=this;return __generator(this,function(d){switch(d.label){case 0:t=Array.isArray(r)?r:r.fileList;if(!Array.isArray(t)||t.length===0){throw error_1.FaasError.INVALID_PARAM_ERR("fileList","\u4E0D\u80FD\u4E3A\u7A7A\u6570\u7EC4")}o=[];for(i=0,e=t;i<e.length;i++){s=e[i];a=this.checkFileID(s);if(a){throw error_1.FaasError.INVALID_PARAM_ERR("fileID",a)}h=this.getCloudPathFromFileID(s);o.push(h)}n=this.getBatchDeletePath();return[4,this.request({method:"POST",path:n,data:{file_list:o}})];case 1:l=d.sent();f=utils_1.ResponseUtil.handleResponse(l);return[2,{fileList:f.file_list.map(function(c){return{fileID:p.formatFileID(c.file_id),status:c.status?0:-1,errMsg:c.status?"ok":c.result_message}})}]}})})};u.prototype.getTempFileURL=function(r){return __awaiter(this,void 0,void 0,function(){var t,o,i,e,s,a,h,n,l,f;var p=this;return __generator(this,function(d){switch(d.label){case 0:t=Array.isArray(r)?r:r.fileList;if(!Array.isArray(t)||t.length===0){throw error_1.FaasError.INVALID_PARAM_ERR("fileList","\u4E0D\u80FD\u4E3A\u7A7A\u6570\u7EC4")}if(t.length>50){throw error_1.FaasError.INVALID_PARAM_ERR("fileList","\u6700\u5927\u957F\u5EA6 50")}o=[];for(i=0,e=t;i<e.length;i++){s=e[i];a=this.checkFileID(s);if(a){throw error_1.FaasError.INVALID_PARAM_ERR("fileID",a)}h=this.getCloudPathFromFileID(s);o.push({file_id:h,expire:600})}n=this.getBatchDownloadPath();return[4,this.request({method:"POST",path:n,data:{file_list:o}})];case 1:l=d.sent();f=utils_1.ResponseUtil.handleResponse(l);return[2,{fileList:f.file_list.map(function(c){return{fileID:p.formatFileID(c.file_id),tempFileURL:c.download_url,status:c.status?0:-1,errMsg:c.status?"ok":c.result_message}})}]}})})};u.prototype.request=function(r){return __awaiter(this,arguments,void 0,function(t){var o=t.method,i=t.path,e=t.data,s=t.headers;return __generator(this,function(a){switch(a.label){case 0:return[4,this.options.httpclient.request({method:o,path:i,data:e,headers:__assign({"x-alipay-cloud-mode":"oss","x-data-api-type":"oss","x-expire-timestamp":"".concat(Date.now()+6e4)},s)})];case 1:return[2,a.sent()]}})})};return u}();exports.Storage=Storage;
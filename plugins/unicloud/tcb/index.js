"use strict";var e=require("path"),t=require("fs"),n=require("module");require("vm");var o=require("crypto");function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var r=i(e),s=i(t),c=i(n),a=i(o);const u=process.env.UNICLOUD_DEBUGGER_PATH=process.env.UNICLOUD_DEBUGGER_PATH||r.default.resolve(__dirname,"../");process.env.UNICLOUD_SPACE_LIST=process.env.UNICLOUD_SPACE_LIST||JSON.stringify([]);const l=r.default.resolve(u,"share/index"),{getRealWorkspace:d,getWorkspacePathFromFilePath:f}=require(l);if(process.env.WORKSPACE_FOLDER||(process.env.WORKSPACE_FOLDER=f(process.argv[3]||"")),!process.env.UNICLOUD_SPACE_PROVIDER){let e={};try{e=JSON.parse(process.env.UNICLOUD_SECRET)}catch(e){}e.secretId?process.env.UNICLOUD_SPACE_PROVIDER="tcb":e.serverSecret&&(process.env.UNICLOUD_SPACE_PROVIDER="aliyun")}const p=process.env.UNICLOUD_SPACE_PROVIDER,h=d({uniCloudInfo:JSON.parse(process.env.UNICLOUD_SPACE_LIST),workspaceFolder:process.env.WORKSPACE_FOLDER,provider:p});global.uniCloudDebug={realWorkspace:h,provider:p};class m extends Error{constructor(e={}){super(e.message),this.errMsg=e.message||"",this.code=this.errCode=e.code,this.errSubject=e.subject,this.forceReturn=e.forceReturn||!1,this.cause=e.cause,Object.defineProperties(this,{message:{get(){return this.errMsg},set(e){this.errMsg=e}}})}toJSON(e=0){if(!(e>=10))return e++,{errCode:this.errCode,errMsg:this.errMsg,code:this.errCode,message:this.message,errSubject:this.errSubject,cause:this.cause&&this.cause.toJSON?this.cause.toJSON(e):this.cause}}}const C={ACCESS_DENIED:{code:"ACCESS_DENIED",message:"Access denied"},OPERATION_TOO_FREQUENT:{code:"OPERATION_TOO_FREQUENT",message:"Operation is too frequent, please try again later"},SYSTEM_ERROR:{code:5e4,message:"System error."},APP_ID_REQUIRED:{code:60101,message:"AppId is required, please check your manifest.json."},DEVICE_ID_REQUIRED:{code:60102,message:"DeviceId is required."},OS_NAME_REQUIRED:{code:60103,message:"OsName is required"},SPACE_NOT_ENABLE:{code:60200,message:"Secure network is not enabled, please refer to https://uniapp.dcloud.net.cn/uniCloud/secure-network.html ."},APP_NOT_ENABLE:{code:60201,message:"Secure network is not enabled, appId: {appId}, add this app info to device list of secure network in uniCloud web console to enable secure connection."},PLATFORM_NOT_ENABLE:{code:60202,message:"Secure network is not enabled, appId: {appId}, uniPlatform: {uniPlatform} add this app info to device list of secure network in uniCloud web console to enable secure connection."},TIMESTAMP_INVALID:{code:70001,message:"Client time error."},APP_ID_INVALID:{code:70002,message:"Invalid client with appId: {appId}."},DEVICE_ID_INVALID:{code:70003,message:"Invalid client with deviceId: {deviceId}."},APP_INFO_INVALID:{code:70004,message:"Current app has not been related to secure network of uniCloud space. please refer to https://uniapp.dcloud.net.cn/uniCloud/secure-network.html#app"},ACCOUNT_NOT_EXISTS:{code:70005,message:"User account does not exist"},OPENID_NOT_FOUND:{code:70006,message:"Openid is not found"},GET_ENCRYPT_KEY_FAILED:{code:70007,message:"Get encrypt key failed"},CLIENT_SIGN_INVALID:{code:70008,message:"Client signature is invalid or empty, please refer to https://uniapp.dcloud.net.cn/uniCloud/secure-network.html#err-70008 ."},ENCRYPT_KEY_NOT_FOUND:{code:70009,message:"Encrypt key not found, client info: {clientInfo}"},ROOT_OR_SIMULATOR_FORBIDDEN:{code:70010,message:"Client type (simulator or root device) is forbidden."}},I=Object.prototype.toString,E=Object.prototype.hasOwnProperty;function g(e){return I.call(e).slice(8,-1).toLowerCase()}function O(e,...t){for(let n=0;n<t.length;n++){const o=t[n];e.includes(o)||e.push(o)}}function N(e){return new Promise((t,n)=>{setTimeout(()=>{t()},e)})}function _(e){const t={...e},{OS:n,APPID:o,LOCALE:i,PLATFORM:r,DEVICEID:s,CLIENTIP:c,CLIENTUA:a,SOURCE:u,requestId:l,secretType:d}=t,f=["SPACEINFO","FUNCTION_NAME","FUNCTION_TYPE","SOURCE","OS","APPID","LOCALE","CLIENTIP","CLIENTUA","PLATFORM","DEVICEID","requestId"];for(let e=0;e<f.length;e++){delete t[f[e]]}const p={...t,os:n,appId:o,locale:i,clientIP:c,userAgent:a,platform:"app-plus"===r?"app":r,deviceId:s,source:u,requestId:l,secretType:d};return function e(t){for(const n in t){const o=t[n];switch(g(o)){case"undefined":delete t[n];break;case"object":e(o)}}}(p),p}function b(e,t){let n,o;switch(t.SOURCE){case"timing":n="_timing",o=[];break;case"http":{const t=e.path.replace(/^\//,"");if(""===t)throw new Error(`"${e.path}" is not a valid cloudobject path`);n=t.split("/")[0],o=[e.queryStringParameters||{}];break}case"server":case"client":case"function":default:n=e.method,o=e.params}return"timing"!==t.SOURCE&&function(e){if(!e)throw new Error("Method name is required");if("_"===e[0])throw new Error(`Forbidden, ${e} is a private method`)}(n),{methodName:n,params:o}}var T={extension:{"uni-cloud-jql":{alias:"",abilityList:["databaseForJQL"],href:"https://uniapp.dcloud.net.cn/uniCloud/jql-cloud.html",dependencies:["uni-cloud-redis"]},"uni-cloud-redis":{alias:"",abilityList:["redis"],href:"https://uniapp.dcloud.net.cn/uniCloud/redis-introduction.html"},"uni-cloud-push":{alias:"",abilityList:["getPushManager"],href:"https://uniapp.dcloud.io/uniCloud/uni-push/introduction.html"},"uni-cloud-sms":{alias:"",abilityList:["sendSms"],href:"https://uniapp.dcloud.net.cn/uniCloud/send-sms.html"},"uni-cloud-verify":{alias:"",abilityList:["getPhoneNumber","getFacialRecognitionVerifyManager"],href:{getPhoneNumber:"https://uniapp.dcloud.net.cn/uniCloud/univerify.html",getFacialRecognitionVerifyManager:"https://uniapp.dcloud.net.cn/uniCloud/frv/intro.html"}},"uni-cloud-ai":{alias:"",abilityList:[{name:"ai",type:"variable"}],href:"https://uniapp.dcloud.net.cn/uniCloud/uni-cloud-ai.html"},"uni-cloud-ext-storage":{alias:"",abilityList:["getExtStorageManager"],href:"https://uniapp.dcloud.net.cn/uniCloud/uni-cloud-ext-storage.html"}}};let y;global.__unicloud_store__?y=global.__unicloud_store__:global.__unicloud_store__=y={requestInfo:{}};var P=y;const S="none",v=new Uint8Array(256);let w=v.length;function A(){return w>v.length-16&&(a.default.randomFillSync(v),w=0),v.slice(w,w+=16)}var D=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;const U=[];for(let e=0;e<256;++e)U.push((e+256).toString(16).substr(1));function R(e,t=0){const n=(U[e[t+0]]+U[e[t+1]]+U[e[t+2]]+U[e[t+3]]+"-"+U[e[t+4]]+U[e[t+5]]+"-"+U[e[t+6]]+U[e[t+7]]+"-"+U[e[t+8]]+U[e[t+9]]+"-"+U[e[t+10]]+U[e[t+11]]+U[e[t+12]]+U[e[t+13]]+U[e[t+14]]+U[e[t+15]]).toLowerCase();if(!function(e){return"string"==typeof e&&D.test(e)}(n))throw TypeError("Stringified UUID is invalid");return n}function k(e,t,n){const o=(e=e||{}).random||(e.rng||A)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){n=n||0;for(let e=0;e<16;++e)t[n+e]=o[e];return t}return R(o)}const L=process.env.UNICLOUD_DEBUGGER_PATH,F=r.default.resolve(L,"share/index"),{parseJson:x,parseJsonByPath:j,getType:q,getFunctionType:M,getRealWorkspace:B,getCloudfunctionPathList:$,getFunctionPath:K,getCommonModulePath:J,getActionPath:V,isModuleEncrypted:G,isFileEncrypted:W,JsonRpcClient:Y,getCloudfunctionsPathFromFilePath:H,getRealFunctionPath:Q,getFunctionNameFromFunctionPath:X,getFunctionParam:z,getPossiblePath:Z}=require(F);const ee=module.constructor.length>1?module.constructor:c.default,te=ee._oldResolveFilename||ee._resolveFilename;ee._oldResolveFilename=te;const ne=[{regexp:/.*uniCloud(?:.*?)\/cloudfunctions\/common\/(.*?)\//i,type:"common"},{regexp:/.*uniCloud(?:.*?)\/cloudfunctions\/uni-clientDB-actions\/(.*?)/i,type:"clientDBAction"},{regexp:/.*uniCloud(?:.*?)\/database\/validateFunction\/(.*?)/i,type:"validateFunction"},{regexp:/.*uniCloud(?:.*?)\/database\/(.*?).schema.ext.js/i,type:"schemaJs"},{regexp:/.*uniCloud(?:.*?)\/cloudfunctions\/(.*?)\//i,type:"function"},{regexp:/.*unicloud\/internal-functions\/common\/(.*?)\//i,type:"internalCommon"},{regexp:/.*unicloud\/internal-functions\/(.*?)\//i,type:"internalFunction"}];function oe(e,t){const n=e.match(t.regexp);if(n)return{modulePath:n[0],moduleName:n[1],type:t.type}}function ie(e){let t;try{t=s.default.statSync(e)}catch(e){}if(!t)return;if(t.isFile()||t.isSymbolicLink())return e;const n=Object.keys(ee._extensions);if(t.isDirectory()){const t=r.default.resolve(e,"package.json"),o=s.default.existsSync(t)&&require(t),i=o&&o.main;if(i)return r.default.resolve(e,i);for(let t=0;t<n.length;t++){const o=n[t],i=r.default.resolve(e,"index."+o);if(s.default.existsSync(i))return i}}}function re(e){const t=[],n=r.default.resolve(e,"package.json");if(!s.default.existsSync(n))return t;const{dependencies:o}=require(n);return o?(Object.keys(o).filter(e=>0===o[e].indexOf("file:")).map(n=>{const i=o[n].replace("file:",""),s=r.default.resolve(e,i);t.push({parentPath:e,relativePath:i,moduleName:n,modulePath:s}),t.push(...re(s))}),t):t}const se=[];function ce(e){const t=re(e);!function(e){const t=new Map;for(let n=0;n<e.length;n++){const{moduleName:o}=e[n];t.has(o)||t.set(o,new Set),t.get(o).add(e[n])}let n=!1;const o=[];if(t.forEach((e,t)=>{let i=`公共模块[${t}]只能存在一个，请从下面候选中删除不使用的公共模块：`;const r=new Set;e.forEach(e=>{const{parentPath:t,relativePath:n,modulePath:o}=e;if(!s.default.existsSync(o))throw new Error(`[${t}]依赖公共模块路径[${n}]错误\n请在[${t}]上右键选择“管理公共模块或扩展依赖”重新选择要关联的公共模块并保存以修正依赖路径`);r.has(o)||(r.add(o),i+="\n"+o)}),r.size>1&&(n=!0,console.error(i),o.push(t))}),n)throw new Error(`公共模块[${o.join("、")}]只能存在一个，删除不使用的公共模块后再试`)}(t);const n=function(e){return e.forEach(({moduleName:e,modulePath:t})=>{se.indexOf(e)>-1||G(t)&&se.push(e)}),se}(t);ee._resolveFilename=function(e,t,o,i){function a(){return te.call(ee,e,t,o,i)}if(r.default.isAbsolute(e))return a();const u=e.split("/"),l=u.shift();if("string"!=typeof l||""===l.trim())return a();if(l.startsWith(".")||!t.filename)return a();const d=u.join("/");if(n.indexOf(l)>-1)throw new m({code:"MODULE_ENCRYPTED",message:l+"模块已加密，不支持本地运行"});const f=function(e){e=e.replace(/\\/g,"/");for(let t=0;t<ne.length;t++){const n=oe(e,ne[t]);if(n)return n}}(t.filename);if(!f)return a();const{modulePath:p,moduleName:h,type:C}=f;if("clientDBAction"===C||"validateFunction"===C||"schemaJs"===C||"internalCommon"===C&&"uni-cloud-jql"===h||"internalFunction"===C&&"DCloud-clientDB"===h){if(function(e){return c.default.builtinModules.indexOf(e)>-1}(l)||r.default.isAbsolute(l)||"."===l[0])return a();const{realWorkspace:e,provider:t}=global.uniCloudDebug;let n,o=["uni-id","uni-id-common","uni-config-center"].indexOf(l)>-1;try{n=J(e,t,l)}catch(e){return a()}const i=r.default.resolve(n,"package.json"),u=s.default.existsSync(i)&&require(i);u.includeInClientDB&&console.warn(`在公共模块的package.json[${i}]内配置includeInClientDB已不再推荐使用，建议在database目录上使用右键菜单“管理JQL公共模块或扩展库依赖”来管理依赖。`),o=o||u.includeInClientDB;const f=function(){const{realWorkspace:e,provider:t}=global.uniCloudDebug;return re(r.default.resolve(e,`uniCloud-${t}/database`))}().some(e=>e.moduleName===l);if(!o&&!f)return a();const p=ie(r.default.resolve(n,d));return p||a()}const I=r.default.resolve(p,"package.json"),E=s.default.existsSync(I)&&require(I),g=E&&E.dependencies;if(!g)return a();let O=g[l];if(!O||!O.startsWith("file:"))return a();O=O.replace("file:","");let N=r.default.resolve(p,O);d&&(N=r.default.resolve(N,d));const _=ie(N);return _||a()}}class ae{constructor(e,t){this.__internalObject={event:e,context:t,methodName:"",params:[]};const{methodName:n,params:o}=b(e,t);this.__internalObject.methodName=n,this.__internalObject.params=o}getMethodName(){return this.__internalObject.methodName}getUniIdToken(){return this.__internalObject.context.uniIdToken}getParams(){return this.__internalObject.params}getHttpInfo(){if("http"===this.getClientInfo().source)return this.__internalObject.event}getClientInfo(){return _(this.__internalObject.context)}getCloudInfo(){return function(e){const{provider:t,spaceId:n,useOldSpaceId:o}=e.SPACEINFO,{FUNCTION_NAME:i,FUNCTION_TYPE:r}=e;return{provider:t,spaceId:n,useOldSpaceId:o,functionName:i,functionType:r}}(this.__internalObject.context)}getUniCloudRequestId(){return this.__internalObject.context.requestId}}async function ue({functionPath:e,event:t,context:n}={}){n.FUNCTION_TYPE="cloudobject";const o=new ae(t,n),i=o.getMethodName(),s=o.getParams(),c=r.default.resolve(e,"index.obj.js"),a=require(c);if(!a||!a[i]||!function(e,t){return E.call(e,t)}(a,i)||"function"!=typeof a[i])throw new Error(`Method[${i}] was not found in ${c}`);const u=a._before,l=a._after,d=a[i];if("_timing"===i)return d.apply(o,[t]);if(!l)return u&&await u.call(o),d.apply(o,s);let f,p=null;try{u&&await u.call(o),f=await d.apply(o,s)}catch(e){p=e}return l.call(o,p,f)}require("http");const le=function(e){function t(){return{SPACEINFO:e.SPACEINFO,SOURCE:"function",CLIENTIP:"127.0.0.1",CLIENTUA:"HBuilderX"}}return async function({name:e,data:n}={}){const{realWorkspace:o,provider:i}=global.uniCloudDebug,c=K(o,i,e);let a;try{a=s.default.statSync(r.default.resolve(c,"encrypt"))}catch(e){}if(a&&a.isFile())throw new m({code:"FUNCTION_ENCRYPTED",message:"此云函数已加密，不可本地运行"});ce(c);try{const o=s.default.existsSync(r.default.resolve(c,"index.js")),i=s.default.existsSync(r.default.resolve(c,"index.obj.js"));if(o){if(i)throw new Error("index.js和index.obj.js不可同时存在");return{success:!0,result:await require(c).main(n,{...t(),FUNCTION_NAME:e,FUNCTION_TYPE:"cloudfunction"})}}if(i){return{success:!0,result:await ue({functionPath:c,event:n,context:{...t(),FUNCTION_NAME:e,FUNCTION_TYPE:"cloudobject"}})}}throw new Error("云函数名称错误或所请求云函数在cloudfunctions目录不存在，如果云端已上传可以下载到本地")}catch(e){throw"MODULE_NOT_FOUND"===e.code&&console.error("请求云函数错误，可能是由于云函数名称错误或者引用的其他模块未找到导致的，请参考下方详细错误信息。注意公共模块需要参考 https://uniapp.dcloud.net.cn/uniCloud/cf-common 进行本地安装。"),e}}},de=r.default.resolve(process.env.UNICLOUD_DEBUGGER_PATH,"internal-functions/common");function fe(){!function(){const e=Object.getPrototypeOf(uniCloud);for(const t in T.extension){const n=T.extension[t].abilityList||[];for(let t=0;t<n.length;t++){delete e[n[t]]}}}();const e=Object.getPrototypeOf(uniCloud),t=global.uniCloudDebug.functionPath;let n;try{n=require(r.default.resolve(t,"package.json"))}catch(e){}let o=[];n&&n.extensions&&(o=Object.keys(n.extensions)),(o.includes("uni-cloud-jql")||"DCloud-clientDB"===global.uniCloudDebug.functionName)&&O(o,...function(){const e=["uni-cloud-redis"],{realWorkspace:t,provider:n}=global.uniCloudDebug,o=r.default.resolve(t,`uniCloud-${n}/database/package.json`);if(!s.default.existsSync(o))return e;const i=require(o);return O(e,...Object.keys(i.extensions||{})),e}());for(const t in T.extension){const{abilityList:n=[],href:i=""}=T.extension[t]||{};if(o.includes(t))require(r.default.resolve(de,t)).init();else for(let o=0;o<n.length;o++){let r=n[o];if("string"==typeof r&&(r={name:r,type:"function"}),r.name in e)continue;let s=i;"object"==typeof i&&(s=i[r.name]),"function"===r.type?e[r.name]=function(){throw new Error(`uniCloud.${r.name}由${t}扩展库提供，请确保云函数/云对象/clientDB依赖了此扩展库${s?"，详情参考："+s:""}`)}:Object.defineProperty(e,r.name,{get(){if(e["_"+r.name])return e["_"+r.name];throw new Error(`uniCloud.${r.name}由${t}扩展库提供，请确保云函数/云对象/clientDB依赖了此扩展库${s?"，详情参考："+s:""}`)},set(t){e["_"+r.name]=t}})}}}function pe(e,t,n={}){e||(e={}),e.clientInfo||(e.clientInfo={});const o=function(e,t,{parseSource:n,parseClientIP:o,parseClientUserAgent:i,parseSpaceInfo:r,parseFunctionName:s,parseRequestId:c}={}){const a={};return a.SOURCE=t.SOURCE,a.CLIENTIP=t.CLIENTIP,a.CLIENTUA=t.CLIENTUA,a.SPACEINFO=t.SPACEINFO,a.FUNCTION_NAME=t.FUNCTION_NAME,a.requestId=t.requestId,a.FUNCTION_TYPE="cloudfunction",a}(0,t,n),i=function(e){!function(e){const t=e.clientInfo;let n;try{n=JSON.parse(decodeURIComponent(e.uniCloudClientInfo))}catch(e){n={}}t.DEVICEID||(t.DEVICEID=e.uniCloudDeviceId||n.uuid||t.ID)}(e);const t=e.clientInfo;return t.uniIdToken=e.uniIdToken||t.uniIdToken,delete e.uniCloudDeviceId,delete e.clientInfo,delete e.uniCloudClientInfo,t.APPID=t.appId||t.APPID,t.PLATFORM=t.uniPlatform||t.PLATFORM,t.OS=t.osName||t.OS,t.DEVICEID=t.deviceId||t.DEVICEID,t.LOCALE=t.locale||t.LOCALE,t.secretType=S,function e(t){if(he.indexOf(t)>-1)return;he.push(t);for(const n in t){if(0===n.indexOf("$"))throw new Error(`Invalid client info: "${n}"`);const o=t[n];"object"===g(o)&&e(o)}}(t),t}(e),r=e.headers;"http"===o.SOURCE&&r&&(r.referer||r.Referer),"timing"===o.SOURCE&&"aliyun"===o.SPACEINFO.provider&&(e.Time=e.triggerTime,e.TriggerName=e.triggerName,e.Type="Timer"),o.SOURCE=i.source||o.SOURCE,o.CLIENTIP=i.clientIP||o.CLIENTIP,o.CLIENTUA=i.userAgent||i.ua||o.CLIENTUA;const s={event:e,context:{...i,...o}};return function(e,t){global.__ctx__=t,global.__args__=e,function(){delete process.env.accessKeyID,delete process.env.accessKeySecret,delete process.env.securityToken}()}(s.event,s.context),P.requestInfo[s.context.requestId]={event:s.event,context:s.context},s}const he=[];function me(e){const t=function(e){if(!(e instanceof m))throw e;if(e&&e.forceReturn)return e.toJSON?e.toJSON():{errSubject:e.errSubject,errCode:e.errCode,errMsg:e.errMsg};throw e}(e);return t&&console.error(t),t}class Ce{constructor(e){const[t,n="32"]=e.split("/");this.cidr=e,this.ip=t,this.bit=parseInt(n)||32,this.ipArr=this.formatIp(t,this.bit),this.ipNum=this.parseIp(this.ipArr),this.ipRange=this.getRange();try{this.checkCidr()}catch(t){throw console.warn(`IP error: ${e}, please check your ip black list`),t}}formatIp(e,t){const n=e.split(".").map(e=>parseInt(e));if(void 0!==t&&32!==t)for(let e=0;e<4-n.length;e++)n.push(0);return n}checkCidr(){const e="IP error: "+this.cidr;if(4!==this.ipArr.length)throw new Error(e);if(this.ipArr.some(e=>e<0||e>255))throw new Error(e);if(this.bit<0||this.bit>32)throw new Error(e)}parseIp(e){let t=0;for(let n=0;n<e.length;n++){t+=e[n]*Math.pow(256,3-n)}return t}getRange(){const{ipNum:e,bit:t}=this,n=e.toString(2).padStart(32,"0").substring(0,t);return[parseInt(n.padEnd(32,"0"),2),parseInt(n.padEnd(32,"1"),2)]}contains(e){const t=this.formatIp(e),n=this.parseIp(t);return n>=this.ipRange[0]&&n<=this.ipRange[1]}}class Ie{constructor(e=[]){this.ipList=e,this.ipCidrList=this.ipList.map(e=>new Ce(e))}contains(e){return this.ipCidrList.some(t=>t.contains(e))}}class Ee{constructor(e){this.ip=e,this.freqConfigKey="unicloud:ip-freq-config:hash",this.blackListKey="unicloud:ip-black-list:set",this.ipInfoKey=`unicloud:ip-info:${e}:hash`,this.ipBlockedKey=`unicloud:ip-blocked:${e}:stirng`,this.config={ipFilterForHttpEnable:!1,blackListEnable:!1,frequencyLimitEnable:!1},(this.config.blackListEnable||this.config.frequencyLimitEnable)&&this.init()}init(){this.redis=uniCloud.redis()}async getFreqConfig(){if(this.freqConfig)return this.freqConfig;const[e,t,n]=await this.redis.hmget(this.freqConfigKey,"duration","limit","blockTime");return this.freqConfig={duration:e?parseInt(e):null,limit:t?parseInt(t):null,blockTime:n?parseInt(n):0},this.freqConfig}async check(){this.redis&&(await this.checkBlackList(),await this.checkBlocked(),await this.checkIpFreq())}async checkBlackList(){if(!this.config.blackListEnable)return;const e=await this.redis.smembers(this.blackListKey)||[];let t=!1;try{t=new Ie(e).contains(this.ip)}catch(e){console.error(e)}if(t)throw new m(C.ACCESS_DENIED)}async checkBlocked(){if(!this.config.frequencyLimitEnable)return;const e=this.redis.get(this.ipBlockedKey);if(!e)return;const t=parseInt(e),{blockTime:n}=await this.getFreqConfig();if(n&&t+1e3*n>Date.now())throw new m(C.OPERATION_TOO_FREQUENT)}async checkIpFreq(){if(!this.config.frequencyLimitEnable)return;const{duration:e,limit:t,blockTime:n}=await this.getFreqConfig();if(!e||!t)return;const o=Date.now();if("1"===await this.redis.eval("local duration = tonumber(ARGV[1])\n    local maxBucket = tonumber(ARGV[2])\n    local tokenPerSecond = maxBucket / duration\n    local now = tonumber(ARGV[3])\n    local redisKey = ARGV[4]\n    local ipInfo = redis.call('hmget', redisKey, 'bucket', 'lastTime')\n    local bucket = tonumber(ipInfo[1])\n    local lastTime = tonumber(ipInfo[2])\n\n    bucket = bucket and bucket or maxBucket\n    lastTime = lastTime and lastTime or now\n\n    local timePassed = now - lastTime\n    local tokenAdd = math.floor(timePassed / 1000 * tokenPerSecond)\n    local timeAdd = math.floor(tokenAdd / tokenPerSecond * 1000)\n    local maxTokenAdd = maxBucket - bucket\n    tokenAdd = tokenAdd > maxTokenAdd and maxTokenAdd or tokenAdd\n    bucket = bucket + tokenAdd - 1\n    lastTime = lastTime + timeAdd\n    local status = '0'\n    if bucket < 0 then\n      bucket = 0\n      status = '1'\n    end\n    redis.call('hmset', redisKey, 'bucket', bucket, 'lastTime', lastTime)\n    redis.call('expire', redisKey, duration)\n    return status",4,"duration","limit","now","ipInfoKey",JSON.stringify(e),JSON.stringify(t),JSON.stringify(o),this.ipInfoKey))throw n&&await this.redis.set(this.ipBlockedKey,o,"EX",n),new m(C.OPERATION_TOO_FREQUENT)}}async function ge(e){try{await new Ee(e).check()}catch(e){throw function(e,{forceReturn:t=!0}={}){return new m({code:e.code||e.errCode,message:e.message||e.errMsg,forceReturn:t})}(e)}}async function Oe(e,t){const n={ipFilterForHttpEnable:!1,blackListEnable:!1,frequencyLimitEnable:!1};!("client"===t.SOURCE||"http"===t.SOURCE&&n.ipFilterForHttpEnable)||"DCloud-clientDB"===t.FUNCTION_NAME&&"redis-proxy"===(e&&e.redirectTo)||await ge(t.CLIENTIP);const o=global.uniCloudDebug.functionPath,i=s.default.existsSync(r.default.resolve(o,"index.js")),c=s.default.existsSync(r.default.resolve(o,"index.obj.js"));let a,u=!1;if(i){if(c)throw new Error("index.js和index.obj.js不可同时存在")}else{if(!c)throw new Error("云函数名称错误或所请求云函数在cloudfunctions目录不存在，如果云端已上传可以下载到本地");u=!0}return a=u?await async function(e,t){return ue({functionPath:global.uniCloudDebug.functionPath,event:e,context:t})}(e,t):await require(o).main(e,t),a}var Ne=async(e,t,n)=>{const{event:o,context:i}=function(e,t,n){n.initUniCloud(t);const o=r.default.resolve(__dirname,"../override/index.js");if(s.default.existsSync(o)){const{init:e}=require(o);e()}global.uniCloud.callFunction=le(t);const i=pe(e,t,n);return fe(),i}(e,t,n);try{return await Oe(o,i)}catch(e){return me(e)}finally{!function({context:e}={}){const t=e.requestId;delete P.requestInfo[t]}({event:o,context:i})}};const _e=require("./@dcloudio/serverless/lib/tcb/uni-cloud");let be;function Te(e,t){return process.env.TCB_SOURCE?process.env.TCB_SOURCE.endsWith("client")?"client":process.env.TCB_SOURCE.endsWith("scf")?"function":"tcbgw"===process.env.TCB_SOURCE?"http":"client":"timer"===process.env.TRIGGER_SRC?"timing":"server"}function ye(e,t){const n=process.env.TCB_SOURCE_IP;return n||("http"===Te()&&e&&e.headers?e.headers["x-real-ip"]:"")}function Pe(e,t){return t.requestId}function Se(e,t){let n;if(process.env.TCB_HTTP_CONTEXT)try{const e=Buffer.from(process.env.TCB_HTTP_CONTEXT,"base64").toString();n=JSON.parse(e).ua}catch(e){}return n||("http"===Te()&&e&&e.headers?e.headers["user-agent"]:"")}function ve(e,t){return{spaceId:process.env&&process.env.SCF_NAMESPACE,provider:"tencent",useOldSpaceId:!1}}function we(e,t){return process.env&&process.env.SCF_FUNCTIONNAME||""}function Ae(e){let t;t=JSON.parse(process.env.UNICLOUD_SECRET),process.env.TENCENTCLOUD_SECRETID=t.secretId,process.env.TENCENTCLOUD_SECRETKEY=t.secretKey,process.env.TENCENTCLOUD_SESSIONTOKEN=t.sessionToken,global.uniCloud;try{be=require(r.default.resolve(global.uniCloudDebug.functionPath,"./credentials.json"))}catch(e){}global.uniCloud=new _e({credentials:be,...t,context:e})}async function De(e,{clientIP:t="127.0.0.1",userAgent:n="HBuilderX",source:o,functionName:i,requestId:r}={}){const s=console.warn;let c;console.warn=function(){arguments&&arguments[0]&&0===arguments[0].indexOf("请检查您是否在本地环境")||s.apply(this,arguments)};try{c=JSON.parse(process.env.UNICLOUD_SECRET)}catch(e){throw new Error("未能获取本地调试所需参数，请稍后再试")}const a={CLIENTIP:t,CLIENTUA:n,FUNCTION_NAME:i,SPACEINFO:{provider:"tencent",spaceId:c.spaceId,useOldSpaceId:!1},SOURCE:o||"client",requestId:r};return await async function(e,t){return Ne(e,t,{parseSource:Te,parseClientIP:ye,parseClientUserAgent:Se,parseSpaceInfo:ve,parseFunctionName:we,parseRequestId:Pe,initUniCloud:Ae})}(e,a)}Ne.toString=function(){return""};const Ue=process.argv[2],Re=H(process.argv[3])||process.argv[3],ke=r.default.resolve(Re,Ue);if(process.noDeprecation=!0,G(ke))throw new m({code:"FUNCTION_ENCRYPTED",message:"此云函数已加密，不可本地运行"});ce(ke),process.on("uncaughtException",e=>{console.error(e)}),process.on("unhandledRejection",e=>{console.error(e)}),async function(){Object.assign(global.uniCloudDebug,{functionName:Ue,functionPath:ke});const e=M(ke);let t={};if(process.argv[4])t=JSON.parse(process.argv[4]);else try{t=z(ke)}catch(e){throw console.error("获取运行参数失败"),e}try{const n=await De(t,{clientIP:"127.0.0.1",clientUA:"HBuilderX",functionName:Ue,requestId:k()});"object"===e?console.log(`[云对象：${Ue}]，调用方法：[${t.method}]，执行结果：`,n):console.log(`[云函数：${Ue}]，执行结果：`,n),await N(300),setTimeout(()=>{process.exit(0)},0)}catch(e){throw await N(300),setTimeout(()=>{process.exit(1)},0),e}}();

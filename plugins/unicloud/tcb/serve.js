"use strict";var e=require("path"),n=require("fs"),t=require("module");function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var r=o(e),i=o(n),c=o(t);const s=Object.prototype.toString;function l(e,n,{parseSource:t,parseClientIP:o,parseClientUserAgent:r,parseSpaceInfo:i,parseFunctionName:c}={}){e||(e={}),e.clientInfo||(e.clientInfo={});const l=e.clientInfo;return l.SOURCE=t(e,n),l.CLIENTIP=o(e,n)||"",l.CLIENTUA=r(e,n)||"",l.SPACEINFO=i(e,n)||"",l.FUNCTION_NAME=c(e,n)||"",function(e,n){const t=e.clientInfo;let o;try{o=JSON.parse(decodeURIComponent(e.uniCloudClientInfo))}catch(e){o={}}const r=e.headers;"http"===t.SOURCE&&r&&(t.CLIENTIP||(t.CLIENTIP=r["x-real-ip"]),t.CLIENTUA||(t.CLIENTUA=r["user-agent"]));t.DEVICEID||(t.DEVICEID=e.uniCloudDeviceId||o.uuid||t.ID);if(t&&"[object Object]"===s.call(t))for(const e in t)Object.hasOwnProperty.call(t,e)&&!n[e]&&(n[e]=t[e]);delete e.uniCloudDeviceId,delete e.clientInfo,delete e.uniCloudClientInfo}(e,n),e}const u={"uni-cloud-jql":{alias:"",ability:["databaseForJQL"],href:""},"uni-cloud-redis":{alias:"",ability:["redis"],href:""}};function a(){const e=Object.getPrototypeOf(uniCloud);for(const n in u){const t=u[n]&&u[n].ability||[];for(let o=0;o<t.length;o++){const r=t[o];r in e||Object.defineProperty(e,r,{get(){throw new Error(`uniCloud.${r}由${n}扩展库提供，请确保当前云函数依赖了此扩展库`)}})}}}var d=async(e,n,t)=>{l(e,n,t),t.initUniCloud(n),function(e,n){global.__ctx__=n,global.__args__=e}(e,n=function(e){return{APPID:e.APPID,SOURCE:e.SOURCE,CLIENTIP:e.CLIENTIP,CLIENTUA:e.CLIENTUA,OS:e.OS,PLATFORM:e.PLATFORM,SPACEINFO:e.SPACEINFO,DEVICEID:e.DEVICEID,FUNCTION_NAME:e.FUNCTION_NAME,LOCALE:e.LOCALE}}(n)),delete process.env.accessKeyID,delete process.env.accessKeySecret,delete process.env.securityToken,function(){const e=require("path"),n=e.resolve(process.env.UNICLOUD_DEBUGGER_PATH,"internal-functions/common"),t=global.uniCloudDebug.functionEntry;let o;try{o=require(e.resolve(t,"package.json"))}catch(e){}if(!o||!o.extensions)return void a();Object.keys(o.extensions).forEach(t=>{const o=u[t]&&u[t].alias||t;require(e.resolve(n,o))}),a()}();const o=global.uniCloudDebug.functionEntry;{let t;try{return t=require(o),t.main(e,n)}catch(e){throw"MODULE_NOT_FOUND"===e.code&&(i.default.existsSync(r.default.resolve(o,"index.js"))?console.error("请求云函数错误，可能是由于引用的模块未找到导致的，请参考下方详细错误信息。注意公共模块需要参考 https://uniapp.dcloud.net.cn/uniCloud/cf-common 进行本地安装。"):console.log("云函数名称错误或所请求云函数在cloudfunctions目录不存在，如果云端已上传可以下载到本地")),e}}return require(o).main(e,n)};const f=require("./@dcloudio/serverless/lib/tcb/uni-cloud");let p,C;function E(e,n){return"client"}function g(e,n){return global.uniCloudDebug.clientIP||"127.0.0.1"}function I(e,n){return global.uniCloudDebug.userAgent||"HBuilderX"}function O(e,n){return{spaceId:global.__space_id__,provider:"tencent"}}function v(e,n){return global.uniCloudDebug.functionName}function N(e){global.uniCloud;try{p=require(r.default.resolve(global.uniCloudDebug.functionEntry,"./credentials.json"))}catch(e){}global.uniCloud=new f({credentials:p,...C,context:e});{const e=C||{};if(process.env.TENCENTCLOUD_SECRETID=e.secretId,process.env.TENCENTCLOUD_SECRETKEY=e.secretKey,process.env.TENCENTCLOUD_SESSIONTOKEN=e.sessionToken,global.uniCloud.isLocal=!0,global.uniCloudDebug.isServe){const e=require("./local").callFunction;global.uniCloud.callFunction=e}}}async function D(e,{uniCloudSecret:n}={}){const t=console.warn;let o;console.warn=function(){arguments&&arguments[0]&&0===arguments[0].indexOf("请检查您是否在本地环境")||t.apply(this,arguments)};try{o=n||JSON.parse(process.env.UNICLOUD_SECRET)}catch(e){throw new Error("未能获取本地调试所需参数，请稍后再试")}global.__space_id__=o.spaceId;return await async function(e,n,{uniCloudSecret:t}={}){return C=t,d(e,n,{parseSource:E,parseClientIP:g,parseClientUserAgent:I,parseSpaceInfo:O,parseFunctionName:v,initUniCloud:N})}(e,{},{uniCloudSecret:o})}d.toString=function(){return""};const y=process.env.UNICLOUD_DEBUGGER_PATH=process.env.UNICLOUD_DEBUGGER_PATH||r.default.resolve(__dirname,"../");process.env.UNICLOUD_INFO=process.env.UNICLOUD_INFO||JSON.stringify([]);const h=r.default.resolve(y,"share/index"),{getWorkspacePathFromFilePath:m}=require(h);if(process.env.WORKSPACE_FOLDER||(process.env.WORKSPACE_FOLDER=m(process.argv[3]||"")),!process.env.SPACE_PROVIDER){let e={};try{e=JSON.parse(process.env.UNICLOUD_SECRET)}catch(e){}e.secretId?process.env.SPACE_PROVIDER="tcb":e.serverSecret&&(process.env.SPACE_PROVIDER="aliyun")}const S=process.env.UNICLOUD_DEBUGGER_PATH,_=r.default.resolve(S,"share/index"),{parseJson:b,getType:P,getRealWorkspace:U,getCloudfunctionPathList:L,getFunctionEntry:T,getCommonModulePath:A,getActionPath:F,isModuleEncrypted:R,isFileEncrypted:x,JsonRpcClient:j}=require(_),w=r.default.resolve(S,"internal-functions"),k=i.default.readdirSync(w).filter(e=>i.default.statSync(r.default.resolve(w,e)).isDirectory());const q=[];var M=e=>{const n=function e(n){const t=[];try{const{dependencies:o}=JSON.parse(i.default.readFileSync(r.default.resolve(n,"package.json")));if(!o)return[];Object.keys(o).filter(e=>0===o[e].indexOf("file:")).map(i=>{const c=r.default.resolve(n,o[i].replace("file:",""));t.push({moduleName:i,modulePath:c}),t.push(...e(c))})}catch(e){}return t}(e);return 0===n.length||(function(e){const n={};for(let t=0;t<e.length;t++){const{moduleName:o,modulePath:r}=e[t];n[o]||(n[o]=new Set),n[o].add(r)}let t=!1;const o=[];if(Object.keys(n).forEach(e=>{n[e].size>1&&(t=!0,console.error(`公共模块[${e}]只能存在一个，请从下面候选中删除不使用的公共模块：`),n[e].forEach(e=>{console.error(e)}),o.push(e))}),t)throw new Error(`公共模块[${o.join("、")}]只能存在一个，删除不使用的公共模块后再试`)}(n),n.forEach(({moduleName:e,modulePath:n})=>{q.indexOf(e)>-1||R(n)&&q.push(e)})),q};class B extends Error{constructor(e){super(e.message),this.errMsg=e.message||"",this.code=e.code,Object.defineProperties(this,{message:{get(){return`errCode: ${e.code||""} | errMsg: `+this.errMsg},set(e){this.errMsg=e}}})}}const J=module.constructor.length>1?module.constructor:c.default,W=J._resolveFilename,G=[{regexp:/.*uniCloud(?:.*?)\/cloudfunctions\/common\/(.*)\//i,type:"common"},{regexp:/.*uniCloud(?:.*?)\/cloudfunctions\/uni-clientDB-actions\/(.*)/i,type:"clientDBAction"},{regexp:/.*uniCloud(?:.*?)\/database\/validateFunction\/(.*)/i,type:"validateFunction"},{regexp:/.*uniCloud(?:.*?)\/cloudfunctions\/(.*)\//i,type:"function"},{regexp:/.*unicloud\/internal-functions\/common\/(.*)\//i,type:"inernalCommon"},{regexp:/.*unicloud\/internal-functions\/(.*)\//i,type:"inernalFunction"}];function K(e,n){const t=e.match(n.regexp);if(t)return{modulePath:t[0],moduleName:t[1],type:n.type}}function V(e){let n;try{n=i.default.statSync(e)}catch(e){}if(!n)return;if(n.isFile()||n.isSymbolicLink())return e;const t=Object.keys(J._extensions);if(n.isDirectory()){const n=r.default.resolve(e,"package.json"),o=i.default.existsSync(n)&&require(n),c=o&&o.main;if(c)return r.default.resolve(e,c);for(let n=0;n<t.length;n++){const o=t[n],c=r.default.resolve(e,"index."+o);if(i.default.existsSync(c))return c}}}var H=e=>{J._resolveFilename=function(n,t,o,c){function s(){return W.call(J,n,t,o,c)}const l=n.split("/"),u=l.shift();if(u.startsWith(".")||!t.filename)return s();const a=l.join("/");if(e.indexOf(u)>-1)throw new B({code:"MODULE_ENCRYPTED",message:u+"模块已加密，不支持本地运行"});const d=function(e){e=e.replace(/\\/g,"/");for(let n=0;n<G.length;n++){const t=K(e,G[n]);if(t)return t}}(t.filename);if(!d)return s();const{modulePath:f,moduleName:p,type:C}=d;if("clientDBAction"===C||"validateFunction"===C||"inernalFunction"===C&&"DCloud-clientDB"===p){const{realWorkspace:e,provider:n}=global.uniCloudDebug;let t=["uni-id","uni-config-center"].indexOf(u)>-1;const o=A(e,n,u),c=r.default.resolve(o,"package.json"),l=i.default.existsSync(c)&&require(c);if(t=t||l.includeInClientDB,!t)return s();const a=V(o);return a||s()}const E=r.default.resolve(f,"package.json"),g=i.default.existsSync(E)&&require(E),I=g&&g.dependencies;if(!I)return s();let O=I[u];if(!O||!O.startsWith("file:"))return s();O=O.replace("file:","");let v=r.default.resolve(f,O);a&&(v=r.default.resolve(v,a));const N=V(v);return N||s()}};const $=process.env.SPACE_PROVIDER,Y=U({uniCloudInfo:JSON.parse(process.env.UNICLOUD_INFO),workspaceFolder:process.env.WORKSPACE_FOLDER,provider:$});global.uniCloudDebug={realWorkspace:Y,provider:$},process.noDeprecation=!0,module.exports=async function(e,n,{userAgent:t,clientIP:o,uniCloudSecret:i={}}={}){n=n||{};const c=function(e,n,t){return k.indexOf(t)>-1?r.default.resolve(w,t):T(e,n,t)}(Y,$,e);if(R(c))throw new B({code:"FUNCTION_ENCRYPTED",message:"此云函数已加密，不可本地运行"});Object.assign(global.uniCloudDebug,{functionName:e,functionEntry:c,userAgent:t,clientIP:o,isServe:!0});const s=M(c);return H(s),await D(n,{uniCloudSecret:i})};

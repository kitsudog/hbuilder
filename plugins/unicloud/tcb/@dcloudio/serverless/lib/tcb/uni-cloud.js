"use strict";var e=require("path"),t=require("module"),n=require("@cloudbase/node-sdk"),s=require("crypto");function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var r=o(e),a=o(t),c=o(n),i=o(s);!function(e,t,n){e(n={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&n.path)}},n.exports),n.exports}((function(e){{const t=e.constructor.length>1?e.constructor:a.default,n=r.default.resolve(__dirname,"../../../../@common_modules"),s=t._nodeModulePaths;t._nodeModulePaths=function(e){let t=s.call(this,e);return t=t.concat(n),t}}}));class l extends Error{constructor(e){super(e.message),this.errMsg=e.message||"",this.code=e.code,Object.defineProperties(this,{message:{get(){return`errCode: ${e.code||""} | errMsg: `+this.errMsg},set(e){this.errMsg=e}}})}}const u=[{rule:/Cannot create field (\S+) in element {(\S+): \[\]}/,content:"，不可在{$2}上新增字段{$1}，因为{$2}是一个数组",mode:"append"},{rule:/Db or Table not exist/,content:"，服务空间内不存在名为{collName}的表，请检查表名是否正确",mode:"append"},{rule:/operation exceeded time limit|云数据库执行时间超限/,content:"，集合{collName}操作超时，请参照此文档进行优化：https://uniapp.dcloud.net.cn/uniCloud/db-performance",mode:"append"},{rule:/TransientTransactionError.*WriteConflict/,content:"，事务写数据冲突，请优化事务流程",mode:"append"}];function d(e,t,n){return new Promise((function(s,o){e.then(e=>{e.code?o(new l(n?n(e):e)):s(t?t(e):e)}).catch(e=>{o(new l(n?n(e):e))})}))}const p=Object.prototype.toString,h=Object.prototype.hasOwnProperty;function f(e){return p.call(e).slice(8,-1).toLowerCase()}function m(e,t){return new Error(e.replace("%err%",t))}function g({param:e,rule:t,errTpl:n="%err%",paramPath:s=""}){Object.keys(t).forEach(o=>{if(!function(e,t){return h.call(e,t)}(e,o))throw m(n,`缺少参数${s}${o}`);if(!e[o]&&!1!==e[o]&&0!==e[o])throw m(n,`参数${s}${o}值不可为空`);if("object"===f(t[o]))g({param:e[o],rule:t[o],errTpl:n,paramPath:o+"."});else{const r=f(e[o]);if(-1===t[o].indexOf(r))throw m(n,`参数${s}${o}类型不正确，期望传入类型${t[o].join("、")}，实际传入${r}`)}})}var w=/[\\^$.*+?()[\]{}|]/g,y=RegExp(w.source);function b(e,t,n){return e.replace(new RegExp((s=t)&&y.test(s)?s.replace(w,"\\$&"):s,"g"),n);var s}function _({collName:e}){return function(t){const n=t&&t.message;return n?(t.message=function({message:e="",extraInfo:t={},formatter:n=[]}={}){for(let s=0;s<n.length;s++){const{rule:o,content:r,mode:a}=n[s],c=e.match(o);if(!c)continue;let i=r;for(let e=1;e<c.length;e++)i=b(i,`{$${e}}`,c[e]);for(const e in t)i=b(i,`{${e}}`,t[e]);switch(a){case"replace":return i;case"append":default:return e+i}}return e}({message:n,extraInfo:{collName:e},formatter:u}),t):t}}const $=["uploadFile","getTempFileURL","deleteFile","downloadFile"];const v=Object.prototype.toString;function x(e){return e.map(e=>{if("[object object]"===v.call(e).toLowerCase())try{e=JSON.stringify(e)}catch(t){e=String(e)}else e=String(e);return e}).join(" ")}function j(e,t){const n=t(e);return new Proxy(e,{get:(e,t)=>n[t]?n[t]:e[t],set:(e,t,n)=>(e[t]=n,!0)})}const O=["create","set","update","remove","get"];function S(e){const t={field:t=>j(e.field(t),S)};return O.forEach(n=>{t[n]=function(...t){return d(e[n].apply(e,t))}}),t}function k(e){if("object"!==f(e))return e;const t=Number(e.$numberDouble||e.$numberInt);return t?{$numberDouble:t/6378100+""}:e}function C(e){return{end(){const t=e._stages.find(e=>"$geoNear"===e.stageKey);return t&&function(e){const t=JSON.parse(e.stageValue);t.maxDistance=k(t.maxDistance),t.minDistance=k(t.minDistance),e.stageValue=JSON.stringify(t)}(t),d(e.end(),null,_({collName:e._coll}))}}}const I=["add","get","count","update","remove"],N=["where","orderBy","limit","skip","field"],P={add:function(e){return e.id?e.inserted=1:e.ids&&(e.inserted=e.ids.length),e}};function L(e){const t={doc:t=>j(e.doc(t),S),aggregate:()=>j(e.aggregate(),C)};return N.forEach(n=>{t[n]=function(...t){return j(e[n].apply(e,t),L)}}),I.forEach(n=>{t[n]=function(...t){return d(e[n].apply(e,t),P[n],_({collName:e._coll}))}}),t}function E(e){return{collection:t=>j(e.collection(t),L),createCollection:t=>d(e.createCollection(t))}}async function A(e={}){const t=e.appid||global.__ctx__.APPID||void 0,n=global.__ctx__.SPACEINFO.spaceId,s={aliyun:"aliyun",tencent:"tcb"}[global.__ctx__.SPACEINFO.provider],{apiKey:o,apiSecret:r,access_token:a,openid:c}=e,u={token:a,openid:c,appid:t,spaceId:n,provider:s,apiKey:o};for(const e in u)void 0===u[e]&&delete u[e];const d=Object.keys(u).sort().map(e=>`${e}=${""+u[e]}`);d.push("apiSecret="+r);const p=i.default.createHash("md5");p.update(d.join("&"));const h=p.digest("hex").toLowerCase();let f;try{f=await uniCloud.httpclient.request("https://c2c84d41-a90b-40ed-83e2-025e60889a78.bspapp.com/http/get-mobile-space",{data:{...u,sign:h},dataAsQueryString:!0,dataType:"json",timeout:3e4})}catch(e){f={}}if(f&&f.status>=400)try{f=await uniCloud.httpclient.request("https://hbonshoregewslogypti.dcloud.net.cn/get-mobile-space",{data:{...u,sign:h},dataAsQueryString:!0,dataType:"json",timeout:3e4})}catch(e){f={}}if(f&&f.data){if(0===f.data.ret)return{code:0,success:!0,phoneNumber:f.data.data.mobile};throw 4002===f.data.ret?new l({code:4002,message:"获取手机号码失败：请检查密钥是否正确"}):new l({code:f.data.ret||5e3,message:"获取手机号码失败："+f.data.desc})}throw new l({code:5e3,message:"获取手机号码失败"})}async function T(e){const t={univerify:A},{provider:n}=e;let s;switch(n){case"univerify":s={access_token:["string"],openid:["string"],apiKey:["string"],apiSecret:["string"]};break;case void 0:throw new l({code:1001,message:"getPhoneNumber缺少参数provider"});default:throw new l({code:1001,message:"getPhoneNumber不支持provider:"+n})}try{g({param:e,rule:s,errTpl:"getPhoneNumber%err%"})}catch(e){throw new l({code:1001,message:e.message})}return await t[n](e)}function q(e){if("string"!=typeof e||!/^(0|17951|86|\+86)?(1\d{10})$/.test(e))throw new l({code:1001,message:"手机号格式不正确，仅支持中国大陆手机号"})}async function D(e){const t={smsKey:["string"],smsSecret:["string"],templateId:["string"],data:["object"]};try{g({param:e,rule:t,errTpl:"sendSms%err%"})}catch(e){throw new l({code:1001,message:e.message})}const n=e.appid||global.__ctx__.APPID||void 0,s=global.__ctx__.SPACEINFO.spaceId,o={aliyun:"aliyun",tencent:"tcb"}[global.__ctx__.SPACEINFO.provider],r=""+Date.now(),{smsKey:a,smsSecret:c,templateId:u,data:d,phone:p,phoneList:h}=e;if(p)q(p);else{if(!h)throw new l({code:1001,message:"手机号格式不正确，请传入phone或phoneList参数"});for(let e=0;e<h.length;e++){q(h[e])}}const f=Object.keys(d).reduce((e,t)=>e+=d[t],"");if(/【|】/.test(f))throw new l({code:1001,message:"为避免与签名混淆，短信内容不可包含“【】”符号"});/(测试|test)/i.test(f)&&console.warn("短信内容包含“测试”、“test”字样时，系统可能会被判定为测试用途，不会真正把短信下发到对应手机（此行为由运营商控制，可能真实发送，也可能不发送）");const m={appid:n,apiKey:a,templateId:u,timestamp:r,spaceId:s,provider:o,params:JSON.stringify(d)};p?m.phone=p:h&&(m.phoneList=h.filter((e,t)=>h.indexOf(e)===t).join(","));for(const e in m)void 0===m[e]&&delete m[e];const w=Object.keys(m).sort().map(e=>`${e}=${m[e]}`);w.push("apiSecret="+c);const y=i.default.createHash("md5");y.update(w.join("&"));const b=y.digest("hex").toLowerCase();let _;try{_=await uniCloud.httpclient.request("https://c2c84d41-a90b-40ed-83e2-025e60889a78.bspapp.com/http/send-sms-space",{data:{...m,sign:b},dataAsQueryString:!0,dataType:"json",timeout:3e4})}catch(e){_={}}if(_&&_.status>=400)try{_=await uniCloud.httpclient.request("https://hbonshoregewslogypti.dcloud.net.cn/send-sms-space",{data:{...m,sign:b},dataAsQueryString:!0,dataType:"json",timeout:3e4})}catch(e){_={}}if(_&&_.data){if(0===_.data.ret)return{code:0,errCode:0,success:!0};throw 4002===_.data.ret?new l({code:4002,message:"短信发送失败：请检查密钥是否正确"}):new l({code:_.data.ret||5e3,message:"短信发送失败："+_.data.desc})}throw new l({code:5e3,message:"短信发送失败"})}const F=Array.isArray,K=["{","}"];const M=/^(?:\d)+/,H=/^(?:\w)+/;const z=Object.prototype.hasOwnProperty,R=(e,t)=>z.call(e,t),J=new class{constructor(){this._caches=Object.create(null)}interpolate(e,t,n=K){if(!t)return[e];let s=this._caches[e];return s||(s=function(e,[t,n]){const s=[];let o=0,r="";for(;o<e.length;){let a=e[o++];if(a===t){r&&s.push({type:"text",value:r}),r="";let t="";for(a=e[o++];void 0!==a&&a!==n;)t+=a,a=e[o++];const c=a===n,i=M.test(t)?"list":c&&H.test(t)?"named":"unknown";s.push({value:t,type:i})}else r+=a}return r&&s.push({type:"text",value:r}),s}(e,n),this._caches[e]=s),function(e,t){const n=[];let s=0;const o=F(t)?"list":(r=t,null!==r&&"object"==typeof r?"named":"unknown");var r;if("unknown"===o)return n;for(;s<e.length;){const r=e[s];switch(r.type){case"text":n.push(r.value);break;case"list":n.push(t[parseInt(r.value,10)]);break;case"named":"named"===o&&n.push(t[r.value])}s++}return n}(s,t)}};function Q(e,t){if(!e)return;if(e=e.trim().replace(/_/g,"-"),t&&t[e])return e;if(0===(e=e.toLowerCase()).indexOf("zh"))return e.indexOf("-hans")>-1?"zh-Hans":e.indexOf("-hant")>-1?"zh-Hant":(n=e,["-tw","-hk","-mo","-cht"].find(e=>-1!==n.indexOf(e))?"zh-Hant":"zh-Hans");var n;const s=function(e,t){return t.find(t=>0===e.indexOf(t))}(e,["en","fr","es"]);return s||void 0}class U{constructor({locale:e,fallbackLocale:t,messages:n,watcher:s,formater:o}){this.locale="en",this.fallbackLocale="en",this.message={},this.messages={},this.watchers=[],t&&(this.fallbackLocale=t),this.formater=o||J,this.messages=n||{},this.setLocale(e||"en"),s&&this.watchLocale(s)}setLocale(e){const t=this.locale;this.locale=Q(e,this.messages)||this.fallbackLocale,this.messages[this.locale]||(this.messages[this.locale]={}),this.message=this.messages[this.locale],t!==this.locale&&this.watchers.forEach(e=>{e(this.locale,t)})}getLocale(){return this.locale}watchLocale(e){const t=this.watchers.push(e)-1;return()=>{this.watchers.splice(t,1)}}add(e,t,n=!0){const s=this.messages[e];s?n?Object.assign(s,t):Object.keys(t).forEach(e=>{R(s,e)||(s[e]=t[e])}):this.messages[e]=t}f(e,t,n){return this.formater.interpolate(e,t,n).join("")}t(e,t,n){let s=this.message;return"string"==typeof t?(t=Q(t,this.messages))&&(s=this.messages[t]):n=t,R(s,e)?this.formater.interpolate(s[e],n).join(""):(console.warn(`Cannot translate the value of keypath ${e}. Use the value of keypath as default.`),e)}}function V({locale:e,fallbackLocale:t,messages:n}){return new U({locale:e,fallbackLocale:t,messages:n})}function B(e={}){this.$provider="tencent",this.$options=e,this.$context=e.context||global.__ctx__,function(e){e.$options.spaceId&&(e.$options.env=e.$options.spaceId),e.$options.credentials&&!e.$options.credentials.env_id&&(e.$options.credentials.env_id=e.$options.env),e.$scope=c.default.init(Object.assign({env:c.default.SYMBOL_CURRENT_ENV},e.$options))}(this),function(e){e.auth=function(t){return e.$scope.auth(t)},e.customAuth=e.auth}(this),function(e){const t=e.$scope;$.forEach(n=>{e[n]=function(...e){return d(t[n].apply(t,e))}})}(this),function(e){const t=e.$scope.logger();function n(e){return function(...n){return t[e]({[e]:x(n)})}}e.logger={log:n("log"),info:n("info"),warn:n("warn"),error:n("error")}}(this),function(e){e.database=function(t){return t&&t.spaceId&&(t.env=t.spaceId),j(e.$scope.database(t),E)}}(this),function(e){e.callFunction=function({name:t,data:n}){return d(e.$scope.callFunction({name:t,data:n}))}}(this),function(e){let t;Object.defineProperty(e,"httpclient",{get:function(){return t||(t=require("urllib").create()),t}})}(this),function(e){e.getPhoneNumber=T,e.sendSms=D,e.initI18n=V}(this)}B.prototype.init=function(e){return"tencent"===uniCloud.$provider&&e.context&&!e.spaceId?this:new B(e)},module.exports=B;

"use strict";var e=require("fs"),t=require("path"),s=require("@cloudbase/node-sdk"),n=require("crypto"),r=require("events"),i=require("https"),o=require("http"),a=require("net"),c=require("tls"),l=require("stream"),h=require("url"),u=require("zlib"),d=require("os"),f=require("util");function _(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var p=_(e),m=_(t),g=_(s),v=_(n),y=_(r),b=_(i),w=_(o),S=_(a),E=_(c),x=_(l),k=_(h),O=_(u),C=_(d);class N extends Error{constructor(e={}){super(e.message),this.errMsg=e.message||"",this.code=this.errCode=e.code,this.errSubject=e.subject,this.forceReturn=e.forceReturn||!1,this.cause=e.cause,Object.defineProperties(this,{message:{get(){return this.errMsg},set(e){this.errMsg=e}}})}toJSON(e=0){if(!(e>=10))return e++,{errCode:this.errCode,errMsg:this.errMsg,code:this.errCode,message:this.message,errSubject:this.errSubject,cause:this.cause&&this.cause.toJSON?this.cause.toJSON(e):this.cause}}}const I=[{rule:/Cannot create field (\S+) in element {(\S+): \[\]}/,content:"，不可在{$2}上新增字段{$1}，因为{$2}是一个数组",mode:"append"},{rule:/Db or Table not exist/,content:"，服务空间内不存在名为{collName}的表，请检查表名是否正确",mode:"append"},{rule:/operation exceeded time limit|云数据库执行时间超限/,content:"，集合{collName}操作超时，请参照此文档进行优化：https://uniapp.dcloud.net.cn/uniCloud/db-performance",mode:"append"},{rule:/TransientTransactionError.*WriteConflict/,content:"，事务写数据冲突，请优化事务流程",mode:"append"}];function L(e,t,s){return new Promise((function(n,r){e.then(e=>{e.code?r(new N(s?s(e):e)):n(t?t(e):e)}).catch(e=>{r(new N(s?s(e):e))})}))}const T=Object.prototype.toString;function P(e){return T.call(e).slice(8,-1).toLowerCase()}var R=/[\\^$.*+?()[\]{}|]/g,U=RegExp(R.source);function B(e,t,s){return e.replace(new RegExp((n=t)&&U.test(n)?n.replace(R,"\\$&"):n,"g"),s);var n}function j({collName:e}){return function(t){const s=t&&t.message;return s?(t.message=function({message:e="",extraInfo:t={},formatter:s=[]}={}){for(let n=0;n<s.length;n++){const{rule:r,content:i,mode:o}=s[n],a=e.match(r);if(!a)continue;let c=i;for(let e=1;e<a.length;e++)c=B(c,`{$${e}}`,a[e]);for(const e in t)c=B(c,`{${e}}`,t[e]);switch(o){case"replace":return c;case"append":default:return e+c}}return e}({message:s,extraInfo:{collName:e},formatter:I}),t):t}}function D(e){const t={...e},{OS:s,APPID:n,LOCALE:r,PLATFORM:i,DEVICEID:o,CLIENTIP:a,CLIENTUA:c,SOURCE:l,requestId:h,secretType:u}=t,d=["SPACEINFO","FUNCTION_NAME","FUNCTION_TYPE","SOURCE","OS","APPID","LOCALE","CLIENTIP","CLIENTUA","PLATFORM","DEVICEID","requestId"];for(let e=0;e<d.length;e++){delete t[d[e]]}const f={...t,os:s,appId:n,locale:r,clientIP:a,userAgent:c,platform:"app-plus"===i?"app":i,deviceId:o,source:l,requestId:h,secretType:u};return function e(t){for(const s in t){const n=t[s];switch(P(n)){case"undefined":delete t[s];break;case"object":e(n)}}}(f),f}function A(e){const{provider:t,spaceId:s,useOldSpaceId:n}=e.SPACEINFO,{FUNCTION_NAME:r,FUNCTION_TYPE:i}=e;return{provider:t,spaceId:s,useOldSpaceId:n,functionName:r,functionType:i}}function M(e,t){let s,n;switch(t.SOURCE){case"timing":s="_timing",n=[];break;case"http":{const t=e.path.replace(/^\//,"");if(""===t)throw new Error(`"${e.path}" is not a valid cloudobject path`);s=t.split("/")[0],n=[e.queryStringParameters||{}];break}case"server":case"client":case"function":default:s=e.method,n=e.params}return"timing"!==t.SOURCE&&function(e){if(!e)throw new Error("Method name is required");if("_"===e[0])throw new Error(`Forbidden, ${e} is a private method`)}(s),{methodName:s,params:n}}require("path"),require("module");const W=["uploadFile","getTempFileURL","deleteFile","downloadFile"];const q=Object.prototype.toString;function F(e){return e.map(e=>{if("[object object]"===q.call(e).toLowerCase())try{e=JSON.stringify(e)}catch(t){e=String(e)}else e=String(e);return e}).join(" ")}function $(e,t){const s=t(e);return new Proxy(e,{get:(e,t)=>s[t]?s[t]:e[t],set:(e,t,s)=>(e[t]=s,!0)})}const G=["create","set","update","remove","get"];function V(e){const t={field:t=>$(e.field(t),V)};return G.forEach(s=>{t[s]=function(...t){return L(e[s].apply(e,t))}}),t}function H(e){if("object"!==P(e))return e;const t=Number(e.$numberDouble||e.$numberInt);return t?{$numberDouble:t/6378100+""}:e}function Y(e){return{end(){const t=e._stages.find(e=>"$geoNear"===e.stageKey);return t&&function(e){const t=JSON.parse(e.stageValue);t.maxDistance=H(t.maxDistance),t.minDistance=H(t.minDistance),e.stageValue=JSON.stringify(t)}(t),L(e.end(),null,j({collName:e._coll}))}}}const z=["add","get","count","update","remove"],J=["where","orderBy","limit","skip","field"],X={add:function(e){return e.id?e.inserted=1:e.ids&&(e.inserted=e.ids.length),e}};function K(e){const t={doc:t=>$(e.doc(t),V),aggregate:()=>$(e.aggregate(),Y)};return J.forEach(s=>{t[s]=function(...t){return $(e[s].apply(e,t),K)}}),z.forEach(s=>{t[s]=function(...t){return L(e[s].apply(e,t),X[s],j({collName:e._coll}))}}),t}function Q(e){return{collection:t=>$(e.collection(t),K),createCollection:t=>L(e.createCollection(t))}}function Z(e){var t;e.httpProxyClient=(t="httpProxyClient",function(){throw new Error("腾讯云服务空间暂不支持 "+t)})}const ee=Array.isArray,te=["{","}"];const se=/^(?:\d)+/,ne=/^(?:\w)+/;const re=Object.prototype.hasOwnProperty,ie=(e,t)=>re.call(e,t),oe=new class{constructor(){this._caches=Object.create(null)}interpolate(e,t,s=te){if(!t)return[e];let n=this._caches[e];return n||(n=function(e,[t,s]){const n=[];let r=0,i="";for(;r<e.length;){let o=e[r++];if(o===t){i&&n.push({type:"text",value:i}),i="";let t="";for(o=e[r++];void 0!==o&&o!==s;)t+=o,o=e[r++];const a=o===s,c=se.test(t)?"list":a&&ne.test(t)?"named":"unknown";n.push({value:t,type:c})}else i+=o}return i&&n.push({type:"text",value:i}),n}(e,s),this._caches[e]=n),function(e,t){const s=[];let n=0;const r=ee(t)?"list":(i=t,null!==i&&"object"==typeof i?"named":"unknown");var i;if("unknown"===r)return s;for(;n<e.length;){const i=e[n];switch(i.type){case"text":s.push(i.value);break;case"list":s.push(t[parseInt(i.value,10)]);break;case"named":"named"===r&&s.push(t[i.value])}n++}return s}(n,t)}};function ae(e,t){if(!e)return;if(e=e.trim().replace(/_/g,"-"),t&&t[e])return e;if(0===(e=e.toLowerCase()).indexOf("zh"))return e.indexOf("-hans")>-1?"zh-Hans":e.indexOf("-hant")>-1?"zh-Hant":(s=e,["-tw","-hk","-mo","-cht"].find(e=>-1!==s.indexOf(e))?"zh-Hant":"zh-Hans");var s;const n=function(e,t){return t.find(t=>0===e.indexOf(t))}(e,["en","fr","es"]);return n||void 0}class ce{constructor({locale:e,fallbackLocale:t,messages:s,watcher:n,formater:r}){this.locale="en",this.fallbackLocale="en",this.message={},this.messages={},this.watchers=[],t&&(this.fallbackLocale=t),this.formater=r||oe,this.messages=s||{},this.setLocale(e||"en"),n&&this.watchLocale(n)}setLocale(e){const t=this.locale;this.locale=ae(e,this.messages)||this.fallbackLocale,this.messages[this.locale]||(this.messages[this.locale]={}),this.message=this.messages[this.locale],t!==this.locale&&this.watchers.forEach(e=>{e(this.locale,t)})}getLocale(){return this.locale}watchLocale(e){const t=this.watchers.push(e)-1;return()=>{this.watchers.splice(t,1)}}add(e,t,s=!0){const n=this.messages[e];n?s?Object.assign(n,t):Object.keys(t).forEach(e=>{ie(n,e)||(n[e]=t[e])}):this.messages[e]=t}f(e,t,s){return this.formater.interpolate(e,t,s).join("")}t(e,t,s){let n=this.message;return"string"==typeof t?(t=ae(t,this.messages))&&(n=this.messages[t]):s=t,ie(n,e)?this.formater.interpolate(n[e],s).join(""):(console.warn(`Cannot translate the value of keypath ${e}. Use the value of keypath as default.`),e)}}function le({locale:e,fallbackLocale:t,messages:s={}}){const n=new ce({locale:e,fallbackLocale:t,messages:{...s}});return s[n.locale]||n.setLocale(t),n}function he(e){const t=this;return new Proxy({},{get(s,n){switch(n){case"toString":return"[object UniCloudObject]";case"toJSON":return{}}return async function(...s){const r=await t.callFunction({name:e,data:{method:n,params:s}}),{errCode:i,errMsg:o,errSubject:a}=r.result||{};if(i){const e=new N({code:i,message:o,subject:a});throw e.detail=r.result,e.requestId=r.requestId,e}return r.result}}})}let ue;global.__unicloud_store__?ue=global.__unicloud_store__:global.__unicloud_store__=ue={requestInfo:{}};var de=ue;function fe(){const e=de.requestInfo,t=[];for(const s in e){const n=e[s];if(n.cloudInfo){t.push(n.cloudInfo);continue}const{context:r}=n,i=A(r);i.requestId=s,n.cloudInfo=i,t.push(i)}return t}function _e(){const e=de.requestInfo,t=[];for(const s in e){const n=e[s];if(n.clientInfo){t.push(n.clientInfo);continue}const{event:r,context:i}=n,o={...D(i),requestId:s};if("cloudobject"===i.FUNCTION_TYPE){const{methodName:e,params:t}=M(r,i);o.cloudObjMethodName=e,o.cloudObjParams=t}n.clientInfo=o,t.push(o)}return t}function pe(){return Object.keys(de.requestInfo)}function me(e){const{event:t,context:s}=de.requestInfo[e]||{};if(t&&s&&"http"===s.SOURCE)return t}class ge{constructor({appId:e,pushClientId:t,seqId:s}={}){if(this._appId=e,this._pushClientId=t,this._seqId=s,this._messageQueue=[],!e||!t||!s)throw new Error("Invalid sse channel");this._pushManager=uniCloud.getPushManager({appId:e}),this._messageId=0,this._send=(e,n)=>this._pushManager.sendMessage({push_clientid:t,settings:{strategy:{default:3},ttl:-1},payload:{channel:"UNI_CLOUD_SSE",action:e,seqId:s,messageId:this._messageId++,message:n}})}write(e){const t=this._send("message",e);return this._messageQueue.push(t),t}async end(e){return await Promise.all(this._messageQueue),this._send("end",e)}}function ve(e){return new ge(e)}function ye(e,t,s){return e(s={path:t,exports:{},require:function(e,t){return be(null==t&&s.path)}},s.exports),s.exports}function be(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}var we={BINARY_TYPES:["nodebuffer","arraybuffer","fragments"],GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),EMPTY_BUFFER:Buffer.alloc(0),NOOP:()=>{}},Se="function"==typeof __webpack_require__?__non_webpack_require__:be,Ee=process.config&&process.config.variables||{},xe=!!process.env.PREBUILDS_ONLY,ke=process.versions.modules,Oe=!(!process.versions||!process.versions.electron)||!!process.env.ELECTRON_RUN_AS_NODE||"undefined"!=typeof window&&window.process&&"renderer"===window.process.type?"electron":"node",Ce=C.default.arch(),Ne=C.default.platform(),Ie=process.env.LIBC||(function(e){return"linux"===e&&p.default.existsSync("/etc/alpine-release")}(Ne)?"musl":"glibc"),Le=process.env.ARM_VERSION||("arm64"===Ce?"8":Ee.arm_version)||"",Te=(process.versions.uv||"").split(".")[0],Pe=Re;function Re(e){return Se(Re.path(e))}function Ue(e){try{return p.default.readdirSync(e)}catch(e){return[]}}function Be(e,t){var s=Ue(e).filter(t);return s[0]&&m.default.join(e,s[0])}function je(e){return/\.node$/.test(e)}function De(e){var t=e.split("-");if(2===t.length){var s=t[0],n=t[1].split("+");if(s&&n.length&&n.every(Boolean))return{name:e,platform:s,architectures:n}}}function Ae(e,t){return function(s){return null!=s&&(s.platform===e&&s.architectures.includes(t))}}function Me(e,t){return e.architectures.length-t.architectures.length}function We(e){var t=e.split("."),s={file:e,specificity:0};if("node"===t.pop()){for(var n=0;n<t.length;n++){var r=t[n];if("node"===r||"electron"===r||"node-webkit"===r)s.runtime=r;else if("napi"===r)s.napi=!0;else if("abi"===r.slice(0,3))s.abi=r.slice(3);else if("uv"===r.slice(0,2))s.uv=r.slice(2);else if("armv"===r.slice(0,4))s.armv=r.slice(4);else{if("glibc"!==r&&"musl"!==r)continue;s.libc=r}s.specificity++}return s}}function qe(e,t){return function(s){return null!=s&&(!(s.runtime!==e&&!function(e){return"node"===e.runtime&&e.napi}(s))&&(!(s.abi!==t&&!s.napi)&&((!s.uv||s.uv===Te)&&((!s.armv||s.armv===Le)&&(!s.libc||s.libc===Ie)))))}}function Fe(e){return function(t,s){return t.runtime!==s.runtime?t.runtime===e?-1:1:t.abi!==s.abi?t.abi?-1:1:t.specificity!==s.specificity?t.specificity>s.specificity?-1:1:0}}Re.path=function(e){e=m.default.resolve(e||".");try{var t=Se(m.default.join(e,"package.json")).name.toUpperCase().replace(/-/g,"_");process.env[t+"_PREBUILD"]&&(e=process.env[t+"_PREBUILD"])}catch(e){}if(!xe){var s=Be(m.default.join(e,"build/Release"),je);if(s)return s;var n=Be(m.default.join(e,"build/Debug"),je);if(n)return n}var r=a(e);if(r)return r;var i=a(m.default.dirname(process.execPath));if(i)return i;var o=["platform="+Ne,"arch="+Ce,"runtime="+Oe,"abi="+ke,"uv="+Te,Le?"armv="+Le:"","libc="+Ie,"node="+process.versions.node,process.versions.electron?"electron="+process.versions.electron:"","function"==typeof __webpack_require__?"webpack=true":""].filter(Boolean).join(" ");throw new Error("No native build was found for "+o+"\n    loaded from: "+e+"\n");function a(e){var t=Ue(m.default.join(e,"prebuilds")).map(De).filter(Ae(Ne,Ce)).sort(Me)[0];if(t){var s=m.default.join(e,"prebuilds",t.name),n=Ue(s).map(We).filter(qe(Oe,ke)).sort(Fe(Oe))[0];return n?m.default.join(s,n.file):void 0}}},Re.parseTags=We,Re.matchTags=qe,Re.compareTags=Fe,Re.parseTuple=De,Re.matchTuple=Ae,Re.compareTuples=Me;var $e={mask:(e,t,s,n,r)=>{for(var i=0;i<r;i++)s[n+i]=e[i]^t[3&i]},unmask:(e,t)=>{const s=e.length;for(var n=0;n<s;n++)e[n]^=t[3&n]}},Ge=ye((function(e){try{e.exports=Pe(__dirname)}catch(t){e.exports=$e}})),Ve=ye((function(e){const{EMPTY_BUFFER:t}=we;function s(e,s){if(0===e.length)return t;if(1===e.length)return e[0];const n=Buffer.allocUnsafe(s);let r=0;for(let t=0;t<e.length;t++){const s=e[t];n.set(s,r),r+=s.length}return r<s?n.slice(0,r):n}function n(e,t,s,n,r){for(let i=0;i<r;i++)s[n+i]=e[i]^t[3&i]}function r(e,t){const s=e.length;for(let n=0;n<s;n++)e[n]^=t[3&n]}function i(e){return e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function o(e){if(o.readOnly=!0,Buffer.isBuffer(e))return e;let t;return e instanceof ArrayBuffer?t=Buffer.from(e):ArrayBuffer.isView(e)?t=Buffer.from(e.buffer,e.byteOffset,e.byteLength):(t=Buffer.from(e),o.readOnly=!1),t}try{const t=Ge,a=t.BufferUtil||t;e.exports={concat:s,mask(e,t,s,r,i){i<48?n(e,t,s,r,i):a.mask(e,t,s,r,i)},toArrayBuffer:i,toBuffer:o,unmask(e,t){e.length<32?r(e,t):a.unmask(e,t)}}}catch(t){e.exports={concat:s,mask:n,toArrayBuffer:i,toBuffer:o,unmask:r}}}));const He=Symbol("kDone"),Ye=Symbol("kRun");var ze=class{constructor(e){this[He]=()=>{this.pending--,this[Ye]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[Ye]()}[Ye](){if(this.pending!==this.concurrency&&this.jobs.length){const e=this.jobs.shift();this.pending++,e(this[He])}}};const{kStatusCode:Je,NOOP:Xe}=we,Ke=Buffer.from([0,0,255,255]),Qe=Symbol("permessage-deflate"),Ze=Symbol("total-length"),et=Symbol("callback"),tt=Symbol("buffers"),st=Symbol("error");let nt;var rt=class{constructor(e,t,s){if(this._maxPayload=0|s,this._options=e||{},this._threshold=void 0!==this._options.threshold?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!nt){const e=void 0!==this._options.concurrencyLimit?this._options.concurrencyLimit:10;nt=new ze(e)}}static get extensionName(){return"permessage-deflate"}offer(){const e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){const e=this._deflate[et];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){const t=this._options,s=e.find(e=>!(!1===t.serverNoContextTakeover&&e.server_no_context_takeover||e.server_max_window_bits&&(!1===t.serverMaxWindowBits||"number"==typeof t.serverMaxWindowBits&&t.serverMaxWindowBits>e.server_max_window_bits)||"number"==typeof t.clientMaxWindowBits&&!e.client_max_window_bits));if(!s)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(s.server_no_context_takeover=!0),t.clientNoContextTakeover&&(s.client_no_context_takeover=!0),"number"==typeof t.serverMaxWindowBits&&(s.server_max_window_bits=t.serverMaxWindowBits),"number"==typeof t.clientMaxWindowBits?s.client_max_window_bits=t.clientMaxWindowBits:!0!==s.client_max_window_bits&&!1!==t.clientMaxWindowBits||delete s.client_max_window_bits,s}acceptAsClient(e){const t=e[0];if(!1===this._options.clientNoContextTakeover&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(t.client_max_window_bits){if(!1===this._options.clientMaxWindowBits||"number"==typeof this._options.clientMaxWindowBits&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"')}else"number"==typeof this._options.clientMaxWindowBits&&(t.client_max_window_bits=this._options.clientMaxWindowBits);return t}normalizeParams(e){return e.forEach(e=>{Object.keys(e).forEach(t=>{let s=e[t];if(s.length>1)throw new Error(`Parameter "${t}" must have only a single value`);if(s=s[0],"client_max_window_bits"===t){if(!0!==s){const e=+s;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${s}`);s=e}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${t}": ${s}`)}else if("server_max_window_bits"===t){const e=+s;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${s}`);s=e}else{if("client_no_context_takeover"!==t&&"server_no_context_takeover"!==t)throw new Error(`Unknown parameter "${t}"`);if(!0!==s)throw new TypeError(`Invalid value for parameter "${t}": ${s}`)}e[t]=s})}),e}decompress(e,t,s){nt.add(n=>{this._decompress(e,t,(e,t)=>{n(),s(e,t)})})}compress(e,t,s){nt.add(n=>{this._compress(e,t,(e,t)=>{n(),s(e,t)})})}_decompress(e,t,s){const n=this._isServer?"client":"server";if(!this._inflate){const e=n+"_max_window_bits",t="number"!=typeof this.params[e]?O.default.Z_DEFAULT_WINDOWBITS:this.params[e];this._inflate=O.default.createInflateRaw({...this._options.zlibInflateOptions,windowBits:t}),this._inflate[Qe]=this,this._inflate[Ze]=0,this._inflate[tt]=[],this._inflate.on("error",at),this._inflate.on("data",ot)}this._inflate[et]=s,this._inflate.write(e),t&&this._inflate.write(Ke),this._inflate.flush(()=>{const e=this._inflate[st];if(e)return this._inflate.close(),this._inflate=null,void s(e);const r=Ve.concat(this._inflate[tt],this._inflate[Ze]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[Ze]=0,this._inflate[tt]=[],t&&this.params[n+"_no_context_takeover"]&&this._inflate.reset()),s(null,r)})}_compress(e,t,s){const n=this._isServer?"server":"client";if(!this._deflate){const e=n+"_max_window_bits",t="number"!=typeof this.params[e]?O.default.Z_DEFAULT_WINDOWBITS:this.params[e];this._deflate=O.default.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:t}),this._deflate[Ze]=0,this._deflate[tt]=[],this._deflate.on("error",Xe),this._deflate.on("data",it)}this._deflate[et]=s,this._deflate.write(e),this._deflate.flush(O.default.Z_SYNC_FLUSH,()=>{if(!this._deflate)return;let e=Ve.concat(this._deflate[tt],this._deflate[Ze]);t&&(e=e.slice(0,e.length-4)),this._deflate[et]=null,this._deflate[Ze]=0,this._deflate[tt]=[],t&&this.params[n+"_no_context_takeover"]&&this._deflate.reset(),s(null,e)})}};function it(e){this[tt].push(e),this[Ze]+=e.length}function ot(e){this[Ze]+=e.length,this[Qe]._maxPayload<1||this[Ze]<=this[Qe]._maxPayload?this[tt].push(e):(this[st]=new RangeError("Max payload size exceeded"),this[st].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[st][Je]=1009,this.removeListener("data",ot),this.reset())}function at(e){this[Qe]._inflate=null,e[Je]=1007,this[et](e)}var ct=function(e){const t=e.length;let s=0;for(;s<t;)if(0==(128&e[s]))s++;else if(192==(224&e[s])){if(s+1===t||128!=(192&e[s+1])||192==(254&e[s]))return!1;s+=2}else if(224==(240&e[s])){if(s+2>=t||128!=(192&e[s+1])||128!=(192&e[s+2])||224===e[s]&&128==(224&e[s+1])||237===e[s]&&160==(224&e[s+1]))return!1;s+=3}else{if(240!=(248&e[s]))return!1;if(s+3>=t||128!=(192&e[s+1])||128!=(192&e[s+2])||128!=(192&e[s+3])||240===e[s]&&128==(240&e[s+1])||244===e[s]&&e[s+1]>143||e[s]>244)return!1;s+=4}return!0},lt=ye((function(e){try{e.exports=Pe(__dirname)}catch(t){e.exports=ct}})),ht=ye((function(e){function t(e){return e>=1e3&&e<=1014&&1004!==e&&1005!==e&&1006!==e||e>=3e3&&e<=4999}function s(e){const t=e.length;let s=0;for(;s<t;)if(0==(128&e[s]))s++;else if(192==(224&e[s])){if(s+1===t||128!=(192&e[s+1])||192==(254&e[s]))return!1;s+=2}else if(224==(240&e[s])){if(s+2>=t||128!=(192&e[s+1])||128!=(192&e[s+2])||224===e[s]&&128==(224&e[s+1])||237===e[s]&&160==(224&e[s+1]))return!1;s+=3}else{if(240!=(248&e[s]))return!1;if(s+3>=t||128!=(192&e[s+1])||128!=(192&e[s+2])||128!=(192&e[s+3])||240===e[s]&&128==(240&e[s+1])||244===e[s]&&e[s+1]>143||e[s]>244)return!1;s+=4}return!0}try{let n=lt;"object"==typeof n&&(n=n.Validation.isValidUTF8),e.exports={isValidStatusCode:t,isValidUTF8:e=>e.length<150?s(e):n(e)}}catch(n){e.exports={isValidStatusCode:t,isValidUTF8:s}}}));const{Writable:ut}=x.default,{BINARY_TYPES:dt,EMPTY_BUFFER:ft,kStatusCode:_t,kWebSocket:pt}=we,{concat:mt,toArrayBuffer:gt,unmask:vt}=Ve,{isValidStatusCode:yt,isValidUTF8:bt}=ht;var wt=class extends ut{constructor(e,t,s,n){super(),this._binaryType=e||dt[0],this[pt]=void 0,this._extensions=t||{},this._isServer=!!s,this._maxPayload=0|n,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._state=0,this._loop=!1}_write(e,t,s){if(8===this._opcode&&0==this._state)return s();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(s)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){const t=this._buffers[0];return this._buffers[0]=t.slice(e),t.slice(0,e)}const t=Buffer.allocUnsafe(e);do{const s=this._buffers[0],n=t.length-e;e>=s.length?t.set(this._buffers.shift(),n):(t.set(new Uint8Array(s.buffer,s.byteOffset,e),n),this._buffers[0]=s.slice(e)),e-=s.length}while(e>0);return t}startLoop(e){let t;this._loop=!0;do{switch(this._state){case 0:t=this.getInfo();break;case 1:t=this.getPayloadLength16();break;case 2:t=this.getPayloadLength64();break;case 3:this.getMask();break;case 4:t=this.getData(e);break;default:return void(this._loop=!1)}}while(this._loop);e(t)}getInfo(){if(this._bufferedBytes<2)return void(this._loop=!1);const e=this.consume(2);if(0!=(48&e[0]))return this._loop=!1,St(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3");const t=64==(64&e[0]);if(t&&!this._extensions[rt.extensionName])return this._loop=!1,St(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(this._fin=128==(128&e[0]),this._opcode=15&e[0],this._payloadLength=127&e[1],0===this._opcode){if(t)return this._loop=!1,St(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(!this._fragmented)return this._loop=!1,St(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE");this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented)return this._loop=!1,St(RangeError,"invalid opcode "+this._opcode,!0,1002,"WS_ERR_INVALID_OPCODE");this._compressed=t}else{if(!(this._opcode>7&&this._opcode<11))return this._loop=!1,St(RangeError,"invalid opcode "+this._opcode,!0,1002,"WS_ERR_INVALID_OPCODE");if(!this._fin)return this._loop=!1,St(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN");if(t)return this._loop=!1,St(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(this._payloadLength>125)return this._loop=!1,St(RangeError,"invalid payload length "+this._payloadLength,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH")}if(this._fin||this._fragmented||(this._fragmented=this._opcode),this._masked=128==(128&e[1]),this._isServer){if(!this._masked)return this._loop=!1,St(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK")}else if(this._masked)return this._loop=!1,St(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK");if(126===this._payloadLength)this._state=1;else{if(127!==this._payloadLength)return this.haveLength();this._state=2}}getPayloadLength16(){if(!(this._bufferedBytes<2))return this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength();this._loop=!1}getPayloadLength64(){if(this._bufferedBytes<8)return void(this._loop=!1);const e=this.consume(8),t=e.readUInt32BE(0);return t>Math.pow(2,21)-1?(this._loop=!1,St(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH")):(this._payloadLength=t*Math.pow(2,32)+e.readUInt32BE(4),this.haveLength())}haveLength(){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0))return this._loop=!1,St(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");this._masked?this._state=3:this._state=4}getMask(){this._bufferedBytes<4?this._loop=!1:(this._mask=this.consume(4),this._state=4)}getData(e){let t=ft;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength)return void(this._loop=!1);t=this.consume(this._payloadLength),this._masked&&vt(t,this._mask)}return this._opcode>7?this.controlMessage(t):this._compressed?(this._state=5,void this.decompress(t,e)):(t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage())}decompress(e,t){this._extensions[rt.extensionName].decompress(e,this._fin,(e,s)=>{if(e)return t(e);if(s.length){if(this._messageLength+=s.length,this._messageLength>this._maxPayload&&this._maxPayload>0)return t(St(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"));this._fragments.push(s)}const n=this.dataMessage();if(n)return t(n);this.startLoop(t)})}dataMessage(){if(this._fin){const e=this._messageLength,t=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],2===this._opcode){let s;s="nodebuffer"===this._binaryType?mt(t,e):"arraybuffer"===this._binaryType?gt(mt(t,e)):t,this.emit("message",s)}else{const s=mt(t,e);if(!bt(s))return this._loop=!1,St(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");this.emit("message",s.toString())}}this._state=0}controlMessage(e){if(8===this._opcode)if(this._loop=!1,0===e.length)this.emit("conclude",1005,""),this.end();else{if(1===e.length)return St(RangeError,"invalid payload length 1",!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH");{const t=e.readUInt16BE(0);if(!yt(t))return St(RangeError,"invalid status code "+t,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");const s=e.slice(2);if(!bt(s))return St(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");this.emit("conclude",t,s.toString()),this.end()}}else 9===this._opcode?this.emit("ping",e):this.emit("pong",e);this._state=0}};function St(e,t,s,n,r){const i=new e(s?"Invalid WebSocket frame: "+t:t);return Error.captureStackTrace(i,St),i.code=r,i[_t]=n,i}const{randomFillSync:Et}=v.default,{EMPTY_BUFFER:xt}=we,{isValidStatusCode:kt}=ht,{mask:Ot,toBuffer:Ct}=Ve,Nt=Buffer.alloc(4);class It{constructor(e,t){this._extensions=t||{},this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._deflating=!1,this._queue=[]}static frame(e,t){const s=t.mask&&t.readOnly;let n=t.mask?6:2,r=e.length;e.length>=65536?(n+=8,r=127):e.length>125&&(n+=2,r=126);const i=Buffer.allocUnsafe(s?e.length+n:n);return i[0]=t.fin?128|t.opcode:t.opcode,t.rsv1&&(i[0]|=64),i[1]=r,126===r?i.writeUInt16BE(e.length,2):127===r&&(i.writeUInt32BE(0,2),i.writeUInt32BE(e.length,6)),t.mask?(Et(Nt,0,4),i[1]|=128,i[n-4]=Nt[0],i[n-3]=Nt[1],i[n-2]=Nt[2],i[n-1]=Nt[3],s?(Ot(e,Nt,i,n,e.length),[i]):(Ot(e,Nt,e,0,e.length),[i,e])):[i,e]}close(e,t,s,n){let r;if(void 0===e)r=xt;else{if("number"!=typeof e||!kt(e))throw new TypeError("First argument must be a valid error code number");if(void 0===t||""===t)r=Buffer.allocUnsafe(2),r.writeUInt16BE(e,0);else{const s=Buffer.byteLength(t);if(s>123)throw new RangeError("The message must not be greater than 123 bytes");r=Buffer.allocUnsafe(2+s),r.writeUInt16BE(e,0),r.write(t,2)}}this._deflating?this.enqueue([this.doClose,r,s,n]):this.doClose(r,s,n)}doClose(e,t,s){this.sendFrame(It.frame(e,{fin:!0,rsv1:!1,opcode:8,mask:t,readOnly:!1}),s)}ping(e,t,s){const n=Ct(e);if(n.length>125)throw new RangeError("The data size must not be greater than 125 bytes");this._deflating?this.enqueue([this.doPing,n,t,Ct.readOnly,s]):this.doPing(n,t,Ct.readOnly,s)}doPing(e,t,s,n){this.sendFrame(It.frame(e,{fin:!0,rsv1:!1,opcode:9,mask:t,readOnly:s}),n)}pong(e,t,s){const n=Ct(e);if(n.length>125)throw new RangeError("The data size must not be greater than 125 bytes");this._deflating?this.enqueue([this.doPong,n,t,Ct.readOnly,s]):this.doPong(n,t,Ct.readOnly,s)}doPong(e,t,s,n){this.sendFrame(It.frame(e,{fin:!0,rsv1:!1,opcode:10,mask:t,readOnly:s}),n)}send(e,t,s){const n=Ct(e),r=this._extensions[rt.extensionName];let i=t.binary?2:1,o=t.compress;if(this._firstFragment?(this._firstFragment=!1,o&&r&&(o=n.length>=r._threshold),this._compress=o):(o=!1,i=0),t.fin&&(this._firstFragment=!0),r){const e={fin:t.fin,rsv1:o,opcode:i,mask:t.mask,readOnly:Ct.readOnly};this._deflating?this.enqueue([this.dispatch,n,this._compress,e,s]):this.dispatch(n,this._compress,e,s)}else this.sendFrame(It.frame(n,{fin:t.fin,rsv1:!1,opcode:i,mask:t.mask,readOnly:Ct.readOnly}),s)}dispatch(e,t,s,n){if(!t)return void this.sendFrame(It.frame(e,s),n);const r=this._extensions[rt.extensionName];this._bufferedBytes+=e.length,this._deflating=!0,r.compress(e,s.fin,(t,r)=>{if(this._socket.destroyed){const e=new Error("The socket was closed while data was being compressed");"function"==typeof n&&n(e);for(let t=0;t<this._queue.length;t++){const s=this._queue[t][4];"function"==typeof s&&s(e)}}else this._bufferedBytes-=e.length,this._deflating=!1,s.readOnly=!1,this.sendFrame(It.frame(r,s),n),this.dequeue()})}dequeue(){for(;!this._deflating&&this._queue.length;){const e=this._queue.shift();this._bufferedBytes-=e[1].length,Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[1].length,this._queue.push(e)}sendFrame(e,t){2===e.length?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}}var Lt=It;class Tt{constructor(e,t){this.target=t,this.type=e}}class Pt extends Tt{constructor(e,t){super("message",t),this.data=e}}class Rt extends Tt{constructor(e,t,s){super("close",s),this.wasClean=s._closeFrameReceived&&s._closeFrameSent,this.reason=t,this.code=e}}class Ut extends Tt{constructor(e){super("open",e)}}class Bt extends Tt{constructor(e,t){super("error",t),this.message=e.message,this.error=e}}var jt={addEventListener(e,t,s){if("function"!=typeof t)return;function n(e){t.call(this,new Pt(e,this))}function r(e,s){t.call(this,new Rt(e,s,this))}function i(e){t.call(this,new Bt(e,this))}function o(){t.call(this,new Ut(this))}const a=s&&s.once?"once":"on";"message"===e?(n._listener=t,this[a](e,n)):"close"===e?(r._listener=t,this[a](e,r)):"error"===e?(i._listener=t,this[a](e,i)):"open"===e?(o._listener=t,this[a](e,o)):this[a](e,t)},removeEventListener(e,t){const s=this.listeners(e);for(let n=0;n<s.length;n++)s[n]!==t&&s[n]._listener!==t||this.removeListener(e,s[n])}};const Dt=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function At(e,t,s){void 0===e[t]?e[t]=[s]:e[t].push(s)}var Mt={format:function(e){return Object.keys(e).map(t=>{let s=e[t];return Array.isArray(s)||(s=[s]),s.map(e=>[t].concat(Object.keys(e).map(t=>{let s=e[t];return Array.isArray(s)||(s=[s]),s.map(e=>!0===e?t:`${t}=${e}`).join("; ")})).join("; ")).join(", ")}).join(", ")},parse:function(e){const t=Object.create(null);if(void 0===e||""===e)return t;let s,n,r=Object.create(null),i=!1,o=!1,a=!1,c=-1,l=-1,h=0;for(;h<e.length;h++){const u=e.charCodeAt(h);if(void 0===s)if(-1===l&&1===Dt[u])-1===c&&(c=h);else if(32===u||9===u)-1===l&&-1!==c&&(l=h);else{if(59!==u&&44!==u)throw new SyntaxError("Unexpected character at index "+h);{if(-1===c)throw new SyntaxError("Unexpected character at index "+h);-1===l&&(l=h);const n=e.slice(c,l);44===u?(At(t,n,r),r=Object.create(null)):s=n,c=l=-1}}else if(void 0===n)if(-1===l&&1===Dt[u])-1===c&&(c=h);else if(32===u||9===u)-1===l&&-1!==c&&(l=h);else if(59===u||44===u){if(-1===c)throw new SyntaxError("Unexpected character at index "+h);-1===l&&(l=h),At(r,e.slice(c,l),!0),44===u&&(At(t,s,r),r=Object.create(null),s=void 0),c=l=-1}else{if(61!==u||-1===c||-1!==l)throw new SyntaxError("Unexpected character at index "+h);n=e.slice(c,h),c=l=-1}else if(o){if(1!==Dt[u])throw new SyntaxError("Unexpected character at index "+h);-1===c?c=h:i||(i=!0),o=!1}else if(a)if(1===Dt[u])-1===c&&(c=h);else if(34===u&&-1!==c)a=!1,l=h;else{if(92!==u)throw new SyntaxError("Unexpected character at index "+h);o=!0}else if(34===u&&61===e.charCodeAt(h-1))a=!0;else if(-1===l&&1===Dt[u])-1===c&&(c=h);else if(-1===c||32!==u&&9!==u){if(59!==u&&44!==u)throw new SyntaxError("Unexpected character at index "+h);{if(-1===c)throw new SyntaxError("Unexpected character at index "+h);-1===l&&(l=h);let o=e.slice(c,l);i&&(o=o.replace(/\\/g,""),i=!1),At(r,n,o),44===u&&(At(t,s,r),r=Object.create(null),s=void 0),n=void 0,c=l=-1}}else-1===l&&(l=h)}if(-1===c||a)throw new SyntaxError("Unexpected end of input");-1===l&&(l=h);const u=e.slice(c,l);return void 0===s?At(t,u,r):(void 0===n?At(r,u,!0):At(r,n,i?u.replace(/\\/g,""):u),At(t,s,r)),t}};const{randomBytes:Wt,createHash:qt}=v.default,{URL:Ft}=k.default,{BINARY_TYPES:$t,EMPTY_BUFFER:Gt,GUID:Vt,kStatusCode:Ht,kWebSocket:Yt,NOOP:zt}=we,{addEventListener:Jt,removeEventListener:Xt}=jt,{format:Kt,parse:Qt}=Mt,{toBuffer:Zt}=Ve,es=["CONNECTING","OPEN","CLOSING","CLOSED"],ts=[8,13];class ss extends y.default{constructor(e,t,s){super(),this._binaryType=$t[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage="",this._closeTimer=null,this._extensions={},this._protocol="",this._readyState=ss.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,null!==e?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,Array.isArray(t)?t=t.join(", "):"object"==typeof t&&null!==t&&(s=t,t=void 0),function e(t,s,n,r){const i={protocolVersion:ts[1],maxPayload:104857600,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...r,createConnection:void 0,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:void 0,host:void 0,path:void 0,port:void 0};if(!ts.includes(i.protocolVersion))throw new RangeError(`Unsupported protocol version: ${i.protocolVersion} (supported versions: ${ts.join(", ")})`);let o;s instanceof Ft?(o=s,t._url=s.href):(o=new Ft(s),t._url=s);const a="ws+unix:"===o.protocol;if(!(o.host||a&&o.pathname)){const e=new Error("Invalid URL: "+t.url);if(0===t._redirects)throw e;return void rs(t,e)}const c="wss:"===o.protocol||"https:"===o.protocol,l=c?443:80,h=Wt(16).toString("base64"),u=c?b.default.get:w.default.get;let d;i.createConnection=c?os:is,i.defaultPort=i.defaultPort||l,i.port=o.port||l,i.host=o.hostname.startsWith("[")?o.hostname.slice(1,-1):o.hostname,i.headers={"Sec-WebSocket-Version":i.protocolVersion,"Sec-WebSocket-Key":h,Connection:"Upgrade",Upgrade:"websocket",...i.headers},i.path=o.pathname+o.search,i.timeout=i.handshakeTimeout,i.perMessageDeflate&&(d=new rt(!0!==i.perMessageDeflate?i.perMessageDeflate:{},!1,i.maxPayload),i.headers["Sec-WebSocket-Extensions"]=Kt({[rt.extensionName]:d.offer()}));n&&(i.headers["Sec-WebSocket-Protocol"]=n);i.origin&&(i.protocolVersion<13?i.headers["Sec-WebSocket-Origin"]=i.origin:i.headers.Origin=i.origin);(o.username||o.password)&&(i.auth=`${o.username}:${o.password}`);if(a){const e=i.path.split(":");i.socketPath=e[0],i.path=e[1]}let f=t._req=u(i);i.timeout&&f.on("timeout",()=>{as(t,f,"Opening handshake has timed out")});f.on("error",e=>{null===f||f.aborted||(f=t._req=null,rs(t,e))}),f.on("response",o=>{const a=o.headers.location,c=o.statusCode;if(a&&i.followRedirects&&c>=300&&c<400){if(++t._redirects>i.maxRedirects)return void as(t,f,"Maximum redirects exceeded");let o;f.abort();try{o=new Ft(a,s)}catch(e){return void rs(t,e)}e(t,o,n,r)}else t.emit("unexpected-response",f,o)||as(t,f,"Unexpected server response: "+o.statusCode)}),f.on("upgrade",(e,s,r)=>{if(t.emit("upgrade",e),t.readyState!==ss.CONNECTING)return;f=t._req=null;const o=qt("sha1").update(h+Vt).digest("base64");if(e.headers["sec-websocket-accept"]!==o)return void as(t,s,"Invalid Sec-WebSocket-Accept header");const a=e.headers["sec-websocket-protocol"],c=(n||"").split(/, */);let l;if(!n&&a?l="Server sent a subprotocol but none was requested":n&&!a?l="Server sent no subprotocol":a&&!c.includes(a)&&(l="Server sent an invalid subprotocol"),l)return void as(t,s,l);a&&(t._protocol=a);const u=e.headers["sec-websocket-extensions"];if(void 0!==u){if(!d){return void as(t,s,"Server sent a Sec-WebSocket-Extensions header but no extension was requested")}let e;try{e=Qt(u)}catch(e){return void as(t,s,"Invalid Sec-WebSocket-Extensions header")}const n=Object.keys(e);if(n.length){if(1!==n.length||n[0]!==rt.extensionName){return void as(t,s,"Server indicated an extension that was not requested")}try{d.accept(e[rt.extensionName])}catch(e){return void as(t,s,"Invalid Sec-WebSocket-Extensions header")}t._extensions[rt.extensionName]=d}}t.setSocket(s,r,i.maxPayload)})}(this,e,t,s)):this._isServer=!0}get binaryType(){return this._binaryType}set binaryType(e){$t.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get onclose(){}set onclose(e){}get onerror(){}set onerror(e){}get onopen(){}set onopen(e){}get onmessage(){}set onmessage(e){}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,s){const n=new wt(this.binaryType,this._extensions,this._isServer,s);this._sender=new Lt(e,this._extensions),this._receiver=n,this._socket=e,n[Yt]=this,e[Yt]=this,n.on("conclude",ls),n.on("drain",hs),n.on("error",us),n.on("message",fs),n.on("ping",_s),n.on("pong",ps),e.setTimeout(0),e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",gs),e.on("data",vs),e.on("end",ys),e.on("error",bs),this._readyState=ss.OPEN,this.emit("open")}emitClose(){if(!this._socket)return this._readyState=ss.CLOSED,void this.emit("close",this._closeCode,this._closeMessage);this._extensions[rt.extensionName]&&this._extensions[rt.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=ss.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==ss.CLOSED){if(this.readyState===ss.CONNECTING){const e="WebSocket was closed before the connection was established";return as(this,this._req,e)}this.readyState!==ss.CLOSING?(this._readyState=ss.CLOSING,this._sender.close(e,t,!this._isServer,e=>{e||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())}),this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),3e4)):this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end()}}ping(e,t,s){if(this.readyState===ss.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(s=e,e=t=void 0):"function"==typeof t&&(s=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===ss.OPEN?(void 0===t&&(t=!this._isServer),this._sender.ping(e||Gt,t,s)):cs(this,e,s)}pong(e,t,s){if(this.readyState===ss.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(s=e,e=t=void 0):"function"==typeof t&&(s=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===ss.OPEN?(void 0===t&&(t=!this._isServer),this._sender.pong(e||Gt,t,s)):cs(this,e,s)}send(e,t,s){if(this.readyState===ss.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof t&&(s=t,t={}),"number"==typeof e&&(e=e.toString()),this.readyState!==ss.OPEN)return void cs(this,e,s);const n={binary:"string"!=typeof e,mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[rt.extensionName]||(n.compress=!1),this._sender.send(e||Gt,n,s)}terminate(){if(this.readyState!==ss.CLOSED){if(this.readyState===ss.CONNECTING){const e="WebSocket was closed before the connection was established";return as(this,this._req,e)}this._socket&&(this._readyState=ss.CLOSING,this._socket.destroy())}}}Object.defineProperty(ss,"CONNECTING",{enumerable:!0,value:es.indexOf("CONNECTING")}),Object.defineProperty(ss.prototype,"CONNECTING",{enumerable:!0,value:es.indexOf("CONNECTING")}),Object.defineProperty(ss,"OPEN",{enumerable:!0,value:es.indexOf("OPEN")}),Object.defineProperty(ss.prototype,"OPEN",{enumerable:!0,value:es.indexOf("OPEN")}),Object.defineProperty(ss,"CLOSING",{enumerable:!0,value:es.indexOf("CLOSING")}),Object.defineProperty(ss.prototype,"CLOSING",{enumerable:!0,value:es.indexOf("CLOSING")}),Object.defineProperty(ss,"CLOSED",{enumerable:!0,value:es.indexOf("CLOSED")}),Object.defineProperty(ss.prototype,"CLOSED",{enumerable:!0,value:es.indexOf("CLOSED")}),["binaryType","bufferedAmount","extensions","protocol","readyState","url"].forEach(e=>{Object.defineProperty(ss.prototype,e,{enumerable:!0})}),["open","error","close","message"].forEach(e=>{Object.defineProperty(ss.prototype,"on"+e,{enumerable:!0,get(){const t=this.listeners(e);for(let e=0;e<t.length;e++)if(t[e]._listener)return t[e]._listener},set(t){const s=this.listeners(e);for(let t=0;t<s.length;t++)s[t]._listener&&this.removeListener(e,s[t]);this.addEventListener(e,t)}})}),ss.prototype.addEventListener=Jt,ss.prototype.removeEventListener=Xt;var ns=ss;function rs(e,t){e._readyState=ss.CLOSING,e.emit("error",t),e.emitClose()}function is(e){return e.path=e.socketPath,S.default.connect(e)}function os(e){return e.path=void 0,e.servername||""===e.servername||(e.servername=S.default.isIP(e.host)?"":e.host),E.default.connect(e)}function as(e,t,s){e._readyState=ss.CLOSING;const n=new Error(s);Error.captureStackTrace(n,as),t.setHeader?(t.abort(),t.socket&&!t.socket.destroyed&&t.socket.destroy(),t.once("abort",e.emitClose.bind(e)),e.emit("error",n)):(t.destroy(n),t.once("error",e.emit.bind(e,"error")),t.once("close",e.emitClose.bind(e)))}function cs(e,t,s){if(t){const s=Zt(t).length;e._socket?e._sender._bufferedBytes+=s:e._bufferedAmount+=s}if(s){s(new Error(`WebSocket is not open: readyState ${e.readyState} (${es[e.readyState]})`))}}function ls(e,t){const s=this[Yt];s._closeFrameReceived=!0,s._closeMessage=t,s._closeCode=e,void 0!==s._socket[Yt]&&(s._socket.removeListener("data",vs),process.nextTick(ms,s._socket),1005===e?s.close():s.close(e,t))}function hs(){this[Yt]._socket.resume()}function us(e){const t=this[Yt];void 0!==t._socket[Yt]&&(t._socket.removeListener("data",vs),process.nextTick(ms,t._socket),t.close(e[Ht])),t.emit("error",e)}function ds(){this[Yt].emitClose()}function fs(e){this[Yt].emit("message",e)}function _s(e){const t=this[Yt];t.pong(e,!t._isServer,zt),t.emit("ping",e)}function ps(e){this[Yt].emit("pong",e)}function ms(e){e.resume()}function gs(){const e=this[Yt];let t;this.removeListener("close",gs),this.removeListener("data",vs),this.removeListener("end",ys),e._readyState=ss.CLOSING,this._readableState.endEmitted||e._closeFrameReceived||e._receiver._writableState.errorEmitted||null===(t=e._socket.read())||e._receiver.write(t),e._receiver.end(),this[Yt]=void 0,clearTimeout(e._closeTimer),e._receiver._writableState.finished||e._receiver._writableState.errorEmitted?e.emitClose():(e._receiver.on("error",ds),e._receiver.on("finish",ds))}function vs(e){this[Yt]._receiver.write(e)||this.pause()}function ys(){const e=this[Yt];e._readyState=ss.CLOSING,e._receiver.end(),this.end()}function bs(){const e=this[Yt];this.removeListener("error",bs),this.on("error",zt),e&&(e._readyState=ss.CLOSING,this.destroy())}const{Duplex:ws}=x.default;function Ss(e){e.emit("close")}function Es(){!this.destroyed&&this._writableState.finished&&this.destroy()}function xs(e){this.removeListener("error",xs),this.destroy(),0===this.listenerCount("error")&&this.emit("error",e)}var ks=function(e,t){let s=!0,n=!0;function r(){s&&e._socket.resume()}e.readyState===e.CONNECTING?e.once("open",(function(){e._receiver.removeAllListeners("drain"),e._receiver.on("drain",r)})):(e._receiver.removeAllListeners("drain"),e._receiver.on("drain",r));const i=new ws({...t,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return e.on("message",(function(t){i.push(t)||(s=!1,e._socket.pause())})),e.once("error",(function(e){i.destroyed||(n=!1,i.destroy(e))})),e.once("close",(function(){i.destroyed||i.push(null)})),i._destroy=function(t,s){if(e.readyState===e.CLOSED)return s(t),void process.nextTick(Ss,i);let r=!1;e.once("error",(function(e){r=!0,s(e)})),e.once("close",(function(){r||s(t),process.nextTick(Ss,i)})),n&&e.terminate()},i._final=function(t){e.readyState!==e.CONNECTING?null!==e._socket&&(e._socket._writableState.finished?(t(),i._readableState.endEmitted&&i.destroy()):(e._socket.once("finish",(function(){t()})),e.close())):e.once("open",(function(){i._final(t)}))},i._read=function(){e.readyState!==e.OPEN&&e.readyState!==e.CLOSING||s||(s=!0,e._receiver._writableState.needDrain||e._socket.resume())},i._write=function(t,s,n){e.readyState!==e.CONNECTING?e.send(t,n):e.once("open",(function(){i._write(t,s,n)}))},i.on("end",Es),i.on("error",xs),i};const{createHash:Os}=v.default,{format:Cs,parse:Ns}=Mt,{GUID:Is,kWebSocket:Ls}=we,Ts=/^[+/0-9A-Za-z]{22}==$/;class Ps extends y.default{constructor(e,t){if(super(),null==(e={maxPayload:104857600,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,...e}).port&&!e.server&&!e.noServer||null!=e.port&&(e.server||e.noServer)||e.server&&e.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(null!=e.port?(this._server=w.default.createServer((e,t)=>{const s=w.default.STATUS_CODES[426];t.writeHead(426,{"Content-Length":s.length,"Content-Type":"text/plain"}),t.end(s)}),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server){const e=this.emit.bind(this,"connection");this._removeListeners=function(e,t){for(const s of Object.keys(t))e.on(s,t[s]);return function(){for(const s of Object.keys(t))e.removeListener(s,t[s])}}(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(t,s,n)=>{this.handleUpgrade(t,s,n,e)}})}!0===e.perMessageDeflate&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set),this.options=e,this._state=0}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(e&&this.once("close",e),2===this._state)return void process.nextTick(Us,this);if(1===this._state)return;if(this._state=1,this.clients)for(const e of this.clients)e.terminate();const t=this._server;t&&(this._removeListeners(),this._removeListeners=this._server=null,null!=this.options.port)?t.close(Us.bind(void 0,this)):process.nextTick(Us,this)}shouldHandle(e){if(this.options.path){const t=e.url.indexOf("?");if((-1!==t?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,s,n){t.on("error",Bs);const r=void 0!==e.headers["sec-websocket-key"]&&e.headers["sec-websocket-key"].trim(),i=+e.headers["sec-websocket-version"],o={};if("GET"!==e.method||"websocket"!==e.headers.upgrade.toLowerCase()||!r||!Ts.test(r)||8!==i&&13!==i||!this.shouldHandle(e))return js(t,400);if(this.options.perMessageDeflate){const s=new rt(this.options.perMessageDeflate,!0,this.options.maxPayload);try{const t=Ns(e.headers["sec-websocket-extensions"]);t[rt.extensionName]&&(s.accept(t[rt.extensionName]),o[rt.extensionName]=s)}catch(e){return js(t,400)}}if(this.options.verifyClient){const a={origin:e.headers[""+(8===i?"sec-websocket-origin":"origin")],secure:!(!e.socket.authorized&&!e.socket.encrypted),req:e};if(2===this.options.verifyClient.length)return void this.options.verifyClient(a,(i,a,c,l)=>{if(!i)return js(t,a||401,c,l);this.completeUpgrade(r,o,e,t,s,n)});if(!this.options.verifyClient(a))return js(t,401)}this.completeUpgrade(r,o,e,t,s,n)}completeUpgrade(e,t,s,n,r,i){if(!n.readable||!n.writable)return n.destroy();if(n[Ls])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>0)return js(n,503);const o=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Accept: "+Os("sha1").update(e+Is).digest("base64")],a=new ns(null);let c=s.headers["sec-websocket-protocol"];if(c&&(c=c.split(",").map(Ds),c=this.options.handleProtocols?this.options.handleProtocols(c,s):c[0],c&&(o.push("Sec-WebSocket-Protocol: "+c),a._protocol=c)),t[rt.extensionName]){const e=t[rt.extensionName].params,s=Cs({[rt.extensionName]:[e]});o.push("Sec-WebSocket-Extensions: "+s),a._extensions=t}this.emit("headers",o,s),n.write(o.concat("\r\n").join("\r\n")),n.removeListener("error",Bs),a.setSocket(n,r,this.options.maxPayload),this.clients&&(this.clients.add(a),a.on("close",()=>this.clients.delete(a))),i(a,s)}}var Rs=Ps;function Us(e){e._state=2,e.emit("close")}function Bs(){this.destroy()}function js(e,t,s,n){e.writable&&(s=s||w.default.STATUS_CODES[t],n={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(s),...n},e.write(`HTTP/1.1 ${t} ${w.default.STATUS_CODES[t]}\r\n`+Object.keys(n).map(e=>`${e}: ${n[e]}`).join("\r\n")+"\r\n\r\n"+s)),e.removeListener("error",Bs),e.destroy()}function Ds(e){return e.trim()}ns.createWebSocketStream=ks,ns.Server=Rs,ns.Receiver=wt,ns.Sender=Lt;var As=ns;class Ms extends r.EventEmitter{_setupSocket(e){this._ws=e,this._initEvent()}_initEvent(){const e=["open","message","close","error"];for(let t=0;t<e.length;t++){const s=e[t];this["on"+s.replace(/^(\w)/,(function(e){return e.toUpperCase()}))]=function(e){this.on(s,e)}}this._ws.on("open",()=>{this.emit("open")}),this._ws.on("message",e=>{this.emit("message",{data:e})}),this._ws.on("error",e=>{this.emit("error",{errMsg:e.message})}),this._ws.on("close",(e,t)=>{this.emit("close",{code:e,reason:Buffer.isBuffer(t)?t.toString("utf8"):t})})}send({data:e}={}){return f.promisify(this._ws.send).call(this._ws,e)}close({code:e=1e3,reason:t}={}){this._ws.close(e,t)}}function Ws({url:e,header:t={},protocols:s}={}){const n=new As(e,s,{finishRequest:function(e,s){for(const s in t)e.setHeader(s,t[s]);e.end()}}),r=new Ms;return r._setupSocket(n),r}async function qs({url:e,method:t="GET",data:s,header:n={},dataType:r="json",responseType:i="text",timeout:o=6e4,sslVerify:a=!0}={}){const c={method:t,headers:n,timeout:o,followRedirect:!0},h=t.toLowerCase();c.dataType="text"!==i?"":"json"===r?"json":"text",a||(c.rejectUnauthorized=!1);let u=n[Object.keys(n).find(e=>"content-type"===e.toLowerCase())]||"";if("get"===h)c.dataAsQueryString=!0,c.data=s;else if(s instanceof l.Readable)c.stream=s;else if("post"===h){u||(n["Content-Type"]=u="application/json");const e=u.split(";")[0];if("object"!==P(s))c.content=s;else if("application/json"===e)c.content=JSON.stringify(s);else if("application/x-www-form-urlencoded"===e){const e=[];for(const t in s)e.push(encodeURIComponent(t)+"="+encodeURIComponent(s[t]));c.content=e.join("&")}else c.content=s}else s&&(c.content=s);const d=await uniCloud.httpclient.request(e,c),{status:f,headers:_,data:p}=d;return{statusCode:f,header:_,data:p}}function Fs(e={}){this.$provider="tencent",this.$options=e,this.$context=e.context||global.__ctx__,function(e){e.$options.spaceId&&(e.$options.env=e.$options.spaceId),e.$options.credentials&&!e.$options.credentials.env_id&&(e.$options.credentials.env_id=e.$options.env),e.$scope=g.default.init(Object.assign({env:g.default.SYMBOL_CURRENT_ENV},e.$options))}(this),function(e){e.auth=function(t){return e.$scope.auth(t)},e.customAuth=e.auth}(this),function(e){const t=e.$scope;W.forEach(s=>{e[s]=function(...e){return L(t[s].apply(t,e))}})}(this),function(e){const t=e.$scope.logger();function s(e){return function(...s){return t[e]({[e]:F(s)})}}e.logger={log:s("log"),info:s("info"),warn:s("warn"),error:s("error")}}(this),function(e){e.database=function(t){return t&&t.spaceId&&(t.env=t.spaceId),$(e.$scope.database(t),Q)}}(this),function(e){e.callFunction=function({name:t,data:s}){return L(e.$scope.callFunction({name:t,data:s}))}}(this),function(e){let t;Object.defineProperty(e,"httpclient",{get:function(){return t||(t=require("urllib").create()),t}})}(this),Z(this),function(e){const t=Object.getPrototypeOf(e);t.initI18n=le,t.importObject=he,t.getCloudInfos=fe,t.getClientInfos=_e,t.getRequestList=pe,t.getHttpInfoByRequestId=me,t.deserializeSSEChannel=ve,t.connectSocket=Ws,t.request=qs}(this)}Fs.prototype.init=function(e){return"tencent"===uniCloud.$provider&&e.context&&!e.spaceId?this:new Fs(e)},module.exports=Fs;

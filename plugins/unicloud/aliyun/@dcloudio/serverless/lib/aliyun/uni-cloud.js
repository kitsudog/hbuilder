"use strict";var e=require("path"),t=require("module"),r=require("crypto");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=n(e),i=n(t),s=n(r);!function(e,t,r){e(r={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&r.path)}},r.exports),r.exports}((function(e){{const t=e.constructor.length>1?e.constructor:i.default,r=o.default.resolve(__dirname,"../../../../@common_modules"),n=t._nodeModulePaths;t._nodeModulePaths=function(e){let t=n.call(this,e);return t=t.concat(r),t}}}));class a extends Error{constructor(e){super(e.message),this.errMsg=e.message||"",this.code=e.code,Object.defineProperties(this,{message:{get(){return`errCode: ${e.code||""} | errMsg: `+this.errMsg},set(e){this.errMsg=e}}})}}const c=[{rule:/Cannot create field (\S+) in element {(\S+): \[\]}/,content:"，不可在{$2}上新增字段{$1}，因为{$2}是一个数组",mode:"append"},{rule:/Db or Table not exist/,content:"，服务空间内不存在名为{collName}的表，请检查表名是否正确",mode:"append"},{rule:/operation exceeded time limit|云数据库执行时间超限/,content:"，集合{collName}操作超时，请参照此文档进行优化：https://uniapp.dcloud.net.cn/uniCloud/db-performance",mode:"append"},{rule:/TransientTransactionError.*WriteConflict/,content:"，事务写数据冲突，请优化事务流程",mode:"append"}];function l(e){return function(){throw new Error("阿里云服务空间暂不支持 "+e)}}function d(e,t,r){return new Promise((function(n,o){e.then(e=>{e.code?o(new a(r?r(e):e)):n(t?t(e):e)}).catch(e=>{o(new a(r?r(e):e))})}))}const u=Object.prototype.toString,h=Object.prototype.hasOwnProperty;function p(e,t){return h.call(e,t)}function f(e){return"[object Object]"===u.call(e)}function m(e){return u.call(e).slice(8,-1).toLowerCase()}function w(e,t){return new Error(e.replace("%err%",t))}function _({param:e,rule:t,errTpl:r="%err%",paramPath:n=""}){Object.keys(t).forEach(o=>{if(!p(e,o))throw w(r,`缺少参数${n}${o}`);if(!e[o]&&!1!==e[o]&&0!==e[o])throw w(r,`参数${n}${o}值不可为空`);if("object"===m(t[o]))_({param:e[o],rule:t[o],errTpl:r,paramPath:o+"."});else{const i=m(e[o]);if(-1===t[o].indexOf(i))throw w(r,`参数${n}${o}类型不正确，期望传入类型${t[o].join("、")}，实际传入${i}`)}})}var y=/[\\^$.*+?()[\]{}|]/g,g=RegExp(y.source);function b(e,t,r){return e.replace(new RegExp((n=t)&&g.test(n)?n.replace(y,"\\$&"):n,"g"),r);var n}function O({collName:e}){return function(t){const r=t&&t.message;return r?(t.message=function({message:e="",extraInfo:t={},formatter:r=[]}={}){for(let n=0;n<r.length;n++){const{rule:o,content:i,mode:s}=r[n],a=e.match(o);if(!a)continue;let c=i;for(let e=1;e<a.length;e++)c=b(c,`{$${e}}`,a[e]);for(const e in t)c=b(c,`{${e}}`,t[e]);switch(s){case"replace":return c;case"append":default:return e+c}}return e}({message:r,extraInfo:{collName:e},formatter:c}),t):t}}function E(e){e.uploadFile=function(e){return async function(t={}){const r={fileName:t.cloudPath};return Buffer.isBuffer(t.fileContent)?r.fileBuffer=t.fileContent:r.filePath=t.fileContent,e.$scope.file.uploadFile(r).then(e=>({fileID:e.fileUrl}))}}(e),e.deleteFile=function(e){return async function({fileList:t=[]}={}){if(Array.isArray(t)&&t.length){const r=[];return t.forEach(t=>{t&&r.push(e.$scope.file.deleteFile(t))}),Promise.all(r)}return{}}}(e),e.getUploadFileOptions=function(e){return async function({cloudPath:t=""}={}){return e.$scope.file.getUploadFileOptions({filePath:t})}}(e),e.getTempFileURL=async function({fileList:e}={}){if(!Array.isArray(e)||0===e.length)throw new a({code:"INVALID_PARAM",message:"fileList的元素必须是非空的字符串"});return{fileList:e.map(e=>({fileID:e,tempFileURL:e}))}},e.downloadFile=l("downloadFile")}const A=[],N={};class I extends class{constructor(e){Object.defineProperties(this,{target:{enumerable:!1,writable:!1,configurable:!1,value:e}})}}{constructor(e,t){if(t!==N)throw new TypeError("InternalSymbol cannot be constructed with new operator");super(e)}static for(e){for(let t=0,r=A.length;t<r;t++)if(A[t].target===e)return A[t].instance;const t=new I(e,N);return A.push({target:e,instance:t}),t}}var T=I;const D=T.for("UNSET_FIELD_NAME"),S=T.for("UPDATE_COMMAND"),P=T.for("QUERY_COMMAND"),L=T.for("LOGIC_COMMAND"),v=T.for("GEO_POINT"),M=T.for("SYMBOL_GEO_LINE_STRING"),$=T.for("SYMBOL_GEO_POLYGON"),j=T.for("SYMBOL_GEO_MULTI_POINT"),C=T.for("SYMBOL_GEO_MULTI_LINE_STRING"),R=T.for("SYMBOL_GEO_MULTI_POLYGON"),F=T.for("SERVER_DATE"),x=T.for("REGEXP");var k;!function(e){e.SET="set",e.REMOVE="remove",e.INC="inc",e.MUL="mul",e.PUSH="push",e.PULL="pull",e.PULL_ALL="pullAll",e.POP="pop",e.SHIFT="shift",e.UNSHIFT="unshift",e.ADD_TO_SET="addToSet",e.BIT="bit",e.RENAME="rename",e.MAX="max",e.MIN="min"}(k||(k={}));class q{constructor(e,t,r){this._internalType=S,Object.defineProperties(this,{_internalType:{enumerable:!1,configurable:!1}}),this.operator=e,this.operands=t,this.fieldName=r||D}_setFieldName(e){return new q(this.operator,this.operands,e)}}function U(e){return e&&e instanceof q&&e._internalType===S}const G=e=>Object.prototype.toString.call(e).slice(8,-1).toLowerCase(),W=e=>"object"===G(e),Q=e=>"number"===G(e),V=e=>Array.isArray(e),H=e=>"date"===G(e),B=e=>"regexp"===G(e),J=e=>e&&e._internalType instanceof I;var z,Y;!function(e){e.AND="and",e.OR="or",e.NOT="not",e.NOR="nor"}(z||(z={}));class K{constructor(e,t,r){if(this._internalType=L,Object.defineProperties(this,{_internalType:{enumerable:!1,configurable:!1}}),this.operator=e,this.operands=t,this.fieldName=r||D,this.fieldName!==D)if(Array.isArray(t)){t=t.slice(),this.operands=t;for(let e=0,r=t.length;e<r;e++){const r=t[e];(X(r)||Te(r))&&(t[e]=r._setFieldName(this.fieldName))}}else{const e=t;(X(e)||Te(e))&&(t=e._setFieldName(this.fieldName))}}_setFieldName(e){const t=this.operands.map(t=>t instanceof K?t._setFieldName(e):t);return new K(this.operator,t,e)}and(...e){const t=Array.isArray(arguments[0])?arguments[0]:Array.from(arguments);return t.unshift(this),new K(z.AND,t,this.fieldName)}or(...e){const t=Array.isArray(arguments[0])?arguments[0]:Array.from(arguments);return t.unshift(this),new K(z.OR,t,this.fieldName)}}function X(e){return e&&e instanceof K&&e._internalType===L}!function(e){e.DocIDError="文档ID不合法",e.CollNameError="集合名称不合法",e.OpStrError="操作符不合法",e.DirectionError="排序字符不合法",e.IntergerError="must be integer",e.QueryParamTypeError="查询参数必须为对象",e.QueryParamValueError="查询参数对象值不能均为undefined"}(Y||(Y={}));const Z="Number",ee="Object",te="Array",re="GeoPoint",ne="GeoLineString",oe="GeoPolygon",ie="GeoMultiPoint",se="GeoMultiLineString",ae="GeoMultiPolygon",ce="Date",le="ServerDate",de="BsonDate",ue=["desc","asc"],he=["<","<=","==",">=",">"];var pe,fe;!function(e){e.lt="<",e.gt=">",e.lte="<=",e.gte=">=",e.eq="=="}(pe||(pe={})),pe.eq,pe.lt,pe.lte,pe.gt,pe.gte,function(e){e.WHERE="WHERE",e.DOC="DOC"}(fe||(fe={}));class me{}me.formatResDocumentData=e=>e.map(e=>me.formatField(e)),me.formatField=e=>{const t=Object.keys(e);let r={};return Array.isArray(e)&&(r=[]),t.forEach(t=>{const n=e[t];let o;switch(me.whichType(n)){case re:o=new _e(n.coordinates[0],n.coordinates[1]);break;case ne:o=new ye(n.coordinates.map(e=>new _e(e[0],e[1])));break;case oe:o=new ge(n.coordinates.map(e=>new ye(e.map(([e,t])=>new _e(e,t)))));break;case ie:o=new be(n.coordinates.map(e=>new _e(e[0],e[1])));break;case se:o=new Oe(n.coordinates.map(e=>new ye(e.map(([e,t])=>new _e(e,t)))));break;case ae:o=new Ee(n.coordinates.map(e=>new ge(e.map(e=>new ye(e.map(([e,t])=>new _e(e,t)))))));break;case ce:o=new Date(1e3*n.$timestamp);break;case ee:case te:o=me.formatField(n);break;case le:o=new Date(n.$date);break;default:o=n}Array.isArray(r)?r.push(o):r[t]=o}),r},me.whichType=e=>{let t=Object.prototype.toString.call(e).slice(8,-1);if(t===ce)return de;if(t===ee){if(e instanceof _e)return re;if(e instanceof Date)return ce;if(e instanceof class{constructor({offset:e=0}={}){this.offset=e}get _internalType(){return F}parse(){return{$date:{offset:this.offset}}}})return le;e.$timestamp?t=ce:e.$date?t=le:_e.validate(e)?t=re:ye.validate(e)?t=ne:ge.validate(e)?t=oe:be.validate(e)?t=ie:Oe.validate(e)?t=se:Ee.validate(e)&&(t=ae)}return t},me.generateDocId=()=>{let e="ABCDEFabcdef0123456789",t="";for(let r=0;r<24;r++)t+=e.charAt(Math.floor(Math.random()*e.length));return t};class we{static isGeopoint(e,t){if(me.whichType(t)!==Z)throw new Error("Geo Point must be number type");const r=Math.abs(t);if("latitude"===e&&r>90)throw new Error("latitude should be a number ranges from -90 to 90");if("longitude"===e&&r>180)throw new Error("longitude should be a number ranges from -180 to 180");return!0}static isInteger(e,t){if(!Number.isInteger(t))throw new Error(e+Y.IntergerError);return!0}static isFieldOrder(e){if(-1===ue.indexOf(e))throw new Error(Y.DirectionError);return!0}static isFieldPath(e){if(!/^[a-zA-Z0-9-_\.]/.test(e))throw new Error;return!0}static isOperator(e){if(-1===he.indexOf(e))throw new Error(Y.OpStrError);return!0}static isCollName(e){if(!/^[a-zA-Z0-9]([a-zA-Z0-9-_]){1,32}$/.test(e))throw new Error(Y.CollNameError);return!0}static isDocID(e){if(!/^([a-fA-F0-9]){24}$/.test(e))throw new Error(Y.DocIDError);return!0}}class _e{constructor(e,t){we.isGeopoint("longitude",e),we.isGeopoint("latitude",t),this.longitude=e,this.latitude=t}parse(e){return{[e]:{type:"Point",coordinates:[this.longitude,this.latitude]}}}toJSON(){return{type:"Point",coordinates:[this.longitude,this.latitude]}}toReadableString(){return`[${this.longitude},${this.latitude}]`}static validate(e){return"Point"===e.type&&V(e.coordinates)&&we.isGeopoint("longitude",e.coordinates[0])&&we.isGeopoint("latitude",e.coordinates[1])}get _internalType(){return v}}class ye{constructor(e){if(!V(e))throw new TypeError('"points" must be of type Point[]. Received type '+typeof e);if(e.length<2)throw new Error('"points" must contain 2 points at least');e.forEach(e=>{if(!(e instanceof _e))throw new TypeError(`"points" must be of type Point[]. Received type ${typeof e}[]`)}),this.points=e}parse(e){return{[e]:{type:"LineString",coordinates:this.points.map(e=>e.toJSON().coordinates)}}}toJSON(){return{type:"LineString",coordinates:this.points.map(e=>e.toJSON().coordinates)}}static validate(e){if("LineString"!==e.type||!V(e.coordinates))return!1;for(let t of e.coordinates)if(!Q(t[0])||!Q(t[1]))return!1;return!0}static isClosed(e){const t=e.points[0],r=e.points[e.points.length-1];if(t.latitude===r.latitude&&t.longitude===r.longitude)return!0}get _internalType(){return M}}class ge{constructor(e){if(!V(e))throw new TypeError('"lines" must be of type LineString[]. Received type '+typeof e);if(0===e.length)throw new Error("Polygon must contain 1 linestring at least");e.forEach(e=>{if(!(e instanceof ye))throw new TypeError(`"lines" must be of type LineString[]. Received type ${typeof e}[]`);if(!ye.isClosed(e))throw new Error(`LineString ${e.points.map(e=>e.toReadableString())} is not a closed cycle`)}),this.lines=e}parse(e){return{[e]:{type:"Polygon",coordinates:this.lines.map(e=>e.points.map(e=>[e.longitude,e.latitude]))}}}toJSON(){return{type:"Polygon",coordinates:this.lines.map(e=>e.points.map(e=>[e.longitude,e.latitude]))}}static validate(e){if("Polygon"!==e.type||!V(e.coordinates))return!1;for(let t of e.coordinates){if(!this.isCloseLineString(t))return!1;for(let e of t)if(!Q(e[0])||!Q(e[1]))return!1}return!0}static isCloseLineString(e){const t=e[0],r=e[e.length-1];return t[0]===r[0]&&t[1]===r[1]}get _internalType(){return R}}class be{constructor(e){if(!V(e))throw new TypeError('"points" must be of type Point[]. Received type '+typeof e);if(0===e.length)throw new Error('"points" must contain 1 point at least');e.forEach(e=>{if(!(e instanceof _e))throw new TypeError(`"points" must be of type Point[]. Received type ${typeof e}[]`)}),this.points=e}parse(e){return{[e]:{type:"MultiPoint",coordinates:this.points.map(e=>e.toJSON().coordinates)}}}toJSON(){return{type:"MultiPoint",coordinates:this.points.map(e=>e.toJSON().coordinates)}}static validate(e){if("MultiPoint"!==e.type||!V(e.coordinates))return!1;for(let t of e.coordinates)if(!Q(t[0])||!Q(t[1]))return!1;return!0}get _internalType(){return j}}class Oe{constructor(e){if(!V(e))throw new TypeError('"lines" must be of type LineString[]. Received type '+typeof e);if(0===e.length)throw new Error("Polygon must contain 1 linestring at least");e.forEach(e=>{if(!(e instanceof ye))throw new TypeError(`"lines" must be of type LineString[]. Received type ${typeof e}[]`)}),this.lines=e}parse(e){return{[e]:{type:"MultiLineString",coordinates:this.lines.map(e=>e.points.map(e=>[e.longitude,e.latitude]))}}}toJSON(){return{type:"MultiLineString",coordinates:this.lines.map(e=>e.points.map(e=>[e.longitude,e.latitude]))}}static validate(e){if("MultiLineString"!==e.type||!V(e.coordinates))return!1;for(let t of e.coordinates)for(let e of t)if(!Q(e[0])||!Q(e[1]))return!1;return!0}get _internalType(){return C}}class Ee{constructor(e){if(!V(e))throw new TypeError('"polygons" must be of type Polygon[]. Received type '+typeof e);if(0===e.length)throw new Error("MultiPolygon must contain 1 polygon at least");for(let t of e)if(!(t instanceof ge))throw new TypeError(`"polygon" must be of type Polygon[]. Received type ${typeof t}[]`);this.polygons=e}parse(e){return{[e]:{type:"MultiPolygon",coordinates:this.polygons.map(e=>e.lines.map(e=>e.points.map(e=>[e.longitude,e.latitude])))}}}toJSON(){return{type:"MultiPolygon",coordinates:this.polygons.map(e=>e.lines.map(e=>e.points.map(e=>[e.longitude,e.latitude])))}}static validate(e){if("MultiPolygon"!==e.type||!V(e.coordinates))return!1;for(let t of e.coordinates)for(let e of t)for(let t of e)if(!Q(t[0])||!Q(t[1]))return!1;return!0}get _internalType(){return $}}var Ae,Ne=Object.freeze({__proto__:null,Point:_e,LineString:ye,Polygon:ge,MultiPoint:be,MultiLineString:Oe,MultiPolygon:Ee});!function(e){e.EQ="eq",e.NEQ="neq",e.GT="gt",e.GTE="gte",e.LT="lt",e.LTE="lte",e.IN="in",e.NIN="nin",e.ALL="all",e.ELEM_MATCH="elemMatch",e.EXISTS="exists",e.SIZE="size",e.MOD="mod",e.GEO_NEAR="geoNear",e.GEO_WITHIN="geoWithin",e.GEO_INTERSECTS="geoIntersects"}(Ae||(Ae={}));class Ie extends K{constructor(e,t,r){super(e,t,r),this.operator=e,this._internalType=P}toJSON(){switch(this.operator){case Ae.IN:case Ae.NIN:return{["$"+this.operator]:this.operands};case Ae.NEQ:return{$ne:this.operands[0]};default:return{["$"+this.operator]:this.operands[0]}}}_setFieldName(e){return new Ie(this.operator,this.operands,e)}eq(e){const t=new Ie(Ae.EQ,[e],this.fieldName);return this.and(t)}neq(e){const t=new Ie(Ae.NEQ,[e],this.fieldName);return this.and(t)}gt(e){const t=new Ie(Ae.GT,[e],this.fieldName);return this.and(t)}gte(e){const t=new Ie(Ae.GTE,[e],this.fieldName);return this.and(t)}lt(e){const t=new Ie(Ae.LT,[e],this.fieldName);return this.and(t)}lte(e){const t=new Ie(Ae.LTE,[e],this.fieldName);return this.and(t)}in(e){const t=new Ie(Ae.IN,e,this.fieldName);return this.and(t)}nin(e){const t=new Ie(Ae.NIN,e,this.fieldName);return this.and(t)}geoNear(e){if(!(e.geometry instanceof _e))throw new TypeError('"geometry" must be of type Point. Received type '+typeof e.geometry);if(void 0!==e.maxDistance&&!Q(e.maxDistance))throw new TypeError('"maxDistance" must be of type Number. Received type '+typeof e.maxDistance);if(void 0!==e.minDistance&&!Q(e.minDistance))throw new TypeError('"minDistance" must be of type Number. Received type '+typeof e.minDistance);const t=new Ie(Ae.GEO_NEAR,[e],this.fieldName);return this.and(t)}geoWithin(e){if(!(e.geometry instanceof Ee||e.geometry instanceof ge))throw new TypeError('"geometry" must be of type Polygon or MultiPolygon. Received type '+typeof e.geometry);const t=new Ie(Ae.GEO_WITHIN,[e],this.fieldName);return this.and(t)}geoIntersects(e){if(!(e.geometry instanceof _e||e.geometry instanceof ye||e.geometry instanceof ge||e.geometry instanceof be||e.geometry instanceof Oe||e.geometry instanceof Ee))throw new TypeError('"geometry" must be of type Point, LineString, Polygon, MultiPoint, MultiLineString or MultiPolygon. Received type '+typeof e.geometry);const t=new Ie(Ae.GEO_INTERSECTS,[e],this.fieldName);return this.and(t)}}function Te(e){return e&&e instanceof Ie&&e._internalType===P}function De(e){return Te(e)}const Se={};for(const e in Ae)Se[e]="$"+e;for(const e in z)Se[e]="$"+e;for(const e in k)Se[e]="$"+e;function Pe(e){return Se[e]||"$"+e}function Le(e){return function e(t,r){if(!J(t)){if(H(t))return t;if(B(t))return{$regex:t.source,$options:t.flags};if(V(t))return t.map(t=>{if(r.indexOf(t)>-1)throw new Error("Cannot convert circular structure to JSON");return e(t,[...r,t])});if(W(t)){const n=Object.assign({},t);for(const t in n){if(r.indexOf(n[t])>-1)throw new Error("Cannot convert circular structure to JSON");n[t]=e(n[t],[...r,n[t]])}return n}return t}switch(t._internalType){case v:return t.toJSON();case F:case x:return t.parse();default:return t.toJSON?t.toJSON():t}}(e,[e])}function ve(e){return function e(t,r,n,o){const i=Object.assign({},t);for(const s in t){if(/^\$/.test(s))continue;const a=t[s];if(a&&(W(a)&&!r(a))){if(o.indexOf(a)>-1)throw new Error("Cannot convert circular structure to JSON");const t=e(a,r,[...n,s],[...o,a]);i[s]=t;let c=!1;for(const e in t)/^\$/.test(e)?c=!0:(i[`${s}.${e}`]=t[e],delete i[s][e]);c||delete i[s]}}return i}(e,$e,[],[e])}function Me(e,t,r){t[r]||delete e[r];for(const n in t)e[n]?V(e[n])?e[n].push(t[n]):W(e[n])?W(t[n])?Object.assign(e[n],t[n]):(console.warn(`unmergable condition, query is object but condition is ${G(t)}, can only overwrite`,t,r),e[n]=t[n]):(console.warn(`to-merge query is of type ${G(e)}, can only overwrite`,e,t,r),e[n]=t[n]):e[n]=t[n]}function $e(e){return J(e)||H(e)||B(e)}function je(e){return Le(e)}Se[Ae.NEQ]="$ne",Se[k.REMOVE]="$unset",Se[k.SHIFT]="$pop",Se[k.UNSHIFT]="$push";class Ce{static encode(e){return(new Ce).encodeUpdate(e)}encodeUpdate(e){return U(e)?this.encodeUpdateCommand(e):"object"===G(e)?this.encodeUpdateObject(e):e}encodeUpdateCommand(e){if(e.fieldName===D)throw new Error("Cannot encode a comparison command with unset field name");switch(e.operator){case k.PUSH:case k.PULL:case k.PULL_ALL:case k.POP:case k.SHIFT:case k.UNSHIFT:case k.ADD_TO_SET:return this.encodeArrayUpdateCommand(e);default:return this.encodeFieldUpdateCommand(e)}}encodeFieldUpdateCommand(e){const t=Pe(e.operator);switch(e.operator){case k.REMOVE:return{[t]:{[e.fieldName]:""}};default:return{[t]:{[e.fieldName]:e.operands[0]}}}}encodeArrayUpdateCommand(e){const t=Pe(e.operator);switch(e.operator){case k.PUSH:{let r;return r=V(e.operands)?{$each:e.operands.map(je)}:e.operands,{[t]:{[e.fieldName]:r}}}case k.UNSHIFT:{const r={$each:e.operands.map(je),$position:0};return{[t]:{[e.fieldName]:r}}}case k.POP:return{[t]:{[e.fieldName]:1}};case k.SHIFT:return{[t]:{[e.fieldName]:-1}};default:return{[t]:{[e.fieldName]:je(e.operands)}}}}encodeUpdateObject(e){const t=ve(e);for(const e in t){if(/^\$/.test(e))continue;let r=t[e];if(U(r)){t[e]=r._setFieldName(e);Me(t,this.encodeUpdateCommand(t[e]),e)}else{t[e]=r=je(r);const n=new q(k.SET,[r],e);Me(t,this.encodeUpdateCommand(n),e)}}return t}}function Re(e){if(!f(e))return e;const t={};return Object.keys(e).forEach(r=>{"$"===r.charAt(0)?t[r]=e[r]:(t.$set=t.$set||{},t.$set[r]=e[r])}),t}function Fe(e){return{id:e.result&&e.result.insertedId}}function xe(e){return{affectedDocs:e.affectedDocs,deleted:e.affectedDocs}}function ke(e){return{affectedDocs:e.affectedDocs,updated:e.result.nModified,upserted:e.result.upserted}}function qe(e){let t=null;return e.result&&Array.isArray(e.result.upserted)&&1===e.result.upserted.length&&(t=e.result.upserted[0]._id),{affectedDocs:e.affectedDocs,updated:e.affectedDocs,upsertedId:t}}function Ue(e){return{affectedDocs:e.affectedDocs,data:e.result}}function Ge(e){return{affectedDocs:e.affectedDocs,data:e.result}}function We(e){return{updated:e.affectedDocs,doc:e.result.value}}class Qe{constructor(e,t){this._db=e,this._coll=t}insertOne(e){return d(this._db.collection(this._coll).insertOne(e),Fe)}deleteOne(e){return d(this._db.collection(this._coll).deleteOne(e),xe)}replaceOne(e,t,r){return d(this._db.collection(this._coll).replaceOne(e,t,r),ke)}updateOne(e,t,r){return t=Re(t),d(this._db.collection(this._coll).updateOne(e,t,r),qe)}findOne(e,t){return d(this._db.collection(this._coll).findOne(e,t),Ue)}findOneAndUpdate(e,t,r){return t=Re(t),d(this._db.collection(this._coll).findOneAndUpdate(e,t,r),We,this._errorWrapper)}find(e,t){return d(this._db.collection(this._coll).find(e,t),Ge)}}class Ve{constructor(e,t,r,n={}){this.watch=l("watch"),this._db=e,this._coll=t,this.id=r,this.projection=n}create(e){return this.id&&(e._id=this.id),e=Le(e),new Qe(this._db,this._coll).insertOne(e)}set(e){if(!this.id)throw new a({code:"INVALID_PARAM",message:"docId不能为空"});if(!e||"object"!=typeof e)throw new a({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(p(e,"_id"))throw new a({code:"INVALID_PARAM",message:"不能更新_id的值"});let t=!1;const r=e=>{if("object"==typeof e)for(const n in e)e[n]instanceof q?t=!0:"object"==typeof e[n]&&r(e[n])};if(r(e),t)throw new a({code:"DATABASE_REQUEST_FAILED",message:"update operator complicit"});return new Qe(this._db,this._coll).replaceOne({_id:this.id},Le(e),{upsert:!0}).then(e=>(e.upserted?e.upsertedId=this.id:e.upsertedId=null,delete e.upserted,Promise.resolve(e)))}update(e){if(!e||"object"!=typeof e)throw new a({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(p(e,"_id"))throw new a({code:"INVALID_PARAM",message:"不能更新_id的值"});return new Qe(this._db,this._coll).updateOne({_id:this.id},Ce.encode(e))}updateAndReturn(e){if(!e||"object"!=typeof e)throw new a({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(p(e,"_id"))throw new a({code:"INVALID_PARAM",message:"不能更新_id的值"});return new Qe(this._db,this._coll).findOneAndUpdate({_id:this.id},Ce.encode(e),{returnNewDocument:!0})}remove(){return new Qe(this._db,this._coll).deleteOne({_id:this.id})}get(){return new Qe(this._db,this._coll).findOne({_id:this.id},{projection:this.projection})}field(e){for(const t in e)e[t]?e[t]=1:e[t]=0;return new Ve(this._db,this._coll,this.id,e)}}class He{static encode(e){return(new Be).encodeQuery(e)}}class Be{encodeQuery(e,t){return $e(e)?X(e)?this.encodeLogicCommand(e):Te(e)?this.encodeQueryCommand(e):{[t]:this.encodeQueryObject(e)}:W(e)?this.encodeQueryObject(e):e}encodeRegExp(e){return{$regex:e.source,$options:e.flags}}encodeLogicCommand(e){switch(e.operator){case z.NOR:case z.AND:case z.OR:return{[Pe(e.operator)]:e.operands.map(t=>this.encodeQuery(t,e.fieldName))};case z.NOT:{const t=Pe(e.operator),r=e.operands[0];if(B(r))return{[e.fieldName]:{[t]:this.encodeRegExp(r)}};{const n=this.encodeQuery(r)[e.fieldName];return{[e.fieldName]:{[t]:n}}}}default:{const t=Pe(e.operator);if(1===e.operands.length){return{[t]:this.encodeQuery(e.operands[0])}}return{[t]:e.operands.map(this.encodeQuery.bind(this))}}}}encodeQueryCommand(e){return De(e),this.encodeComparisonCommand(e)}encodeComparisonCommand(e){if(e.fieldName===D)throw new Error("Cannot encode a comparison command with unset field name");const t=Pe(e.operator);switch(e.operator){case Ae.EQ:case Ae.NEQ:case Ae.LT:case Ae.LTE:case Ae.GT:case Ae.GTE:case Ae.ELEM_MATCH:case Ae.EXISTS:case Ae.SIZE:case Ae.MOD:return{[e.fieldName]:{[t]:je(e.operands[0])}};case Ae.IN:case Ae.NIN:case Ae.ALL:return{[e.fieldName]:{[t]:je(e.operands)}};case Ae.GEO_NEAR:{const t=e.operands[0];return{[e.fieldName]:{$nearSphere:{$geometry:t.geometry.toJSON(),$maxDistance:t.maxDistance,$minDistance:t.minDistance}}}}case Ae.GEO_WITHIN:{const t=e.operands[0];return{[e.fieldName]:{$geoWithin:{$geometry:t.geometry.toJSON()}}}}case Ae.GEO_INTERSECTS:{const t=e.operands[0];return{[e.fieldName]:{$geoIntersects:{$geometry:t.geometry.toJSON()}}}}default:return{[e.fieldName]:{[t]:je(e.operands[0])}}}}encodeQueryObject(e){const t=ve(e);for(const e in t){const r=t[e];if(X(r)){t[e]=r._setFieldName(e);const n=this.encodeLogicCommand(t[e]);this.mergeConditionAfterEncode(t,n,e)}else if(De(r)){t[e]=r._setFieldName(e);const n=this.encodeComparisonCommand(t[e]);this.mergeConditionAfterEncode(t,n,e)}else $e(r)&&(t[e]=je(r))}return t}mergeConditionAfterEncode(e,t,r){t[r]||delete e[r];for(const n in t)e[n]?V(e[n])?e[n]=e[n].concat(t[n]):W(e[n])?W(t[n])?Object.assign(e,t):(console.warn(`unmergable condition, query is object but condition is ${G(t)}, can only overwrite`,t,r),e[n]=t[n]):(console.warn(`to-merge query is of type ${G(e)}, can only overwrite`,e,t,r),e[n]=t[n]):e[n]=t[n]}}const Je={asc:1,desc:-1};class ze{constructor(e,t,r,n,o){this._db=e,this._coll=t,this._fieldFilters=r,this._fieldOrders=n||[],this._queryOptions=o||{}}get(){const e={};return this._fieldOrders.length&&(e.sort={},this._fieldOrders.forEach(t=>{Object.assign(e.sort,t)})),this._queryOptions.skip&&(e.skip=this._queryOptions.skip),this._queryOptions.limit?e.limit=this._queryOptions.limit<1e3?this._queryOptions.limit:1e3:e.limit=100,this._queryOptions.projection&&(e.projection=this._queryOptions.projection),new Qe(this._db,this._coll).find(this._fieldFilters||{},e)}update(e){if(!e||"object"!=typeof e)throw new a({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(p(e,"_id"))throw new a({code:"INVALID_PARAM",message:"不能更新_id的值"});return new Qe(this._db,this._coll).updateMany(this._fieldFilters||{},Ce.encode(e))}updateAndReturn(e){if(!e||"object"!=typeof e)throw new a({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(p(e,"_id"))throw new a({code:"INVALID_PARAM",message:"不能更新_id的值"});return new Qe(this._db,this._coll).findOneAndUpdate(this._fieldFilters||{},Ce.encode(e),{returnNewDocument:!0})}remove(e){return Object.keys(this._queryOptions).length>0&&console.warn("`offset`, `limit` and `projection` are not supported in remove() operation"),this._fieldOrders.length>0&&console.warn("`orderBy` is not supported in remove() operation"),new Qe(this._db,this._coll).deleteMany(this._fieldFilters||{})}count(){return new Qe(this._db,this._coll).count(this._fieldFilters||{})}where(e){if(!f(e))throw Error(Y.QueryParamTypeError);const t=Object.keys(e),r=t.some(t=>void 0!==e[t]);if(t.length&&!r)throw Error(Y.QueryParamValueError);return new ze(this._db,this._coll,He.encode(e),this._fieldOrders,this._queryOptions)}orderBy(e,t){we.isFieldPath(e),we.isFieldOrder(t);const r={};r[e]=Je[t];const n=this._fieldOrders.concat([r]);return new ze(this._db,this._coll,this._fieldFilters,n,this._queryOptions)}limit(e){we.isInteger("limit",e);const t={...this._queryOptions};return t.limit=e,new ze(this._db,this._coll,this._fieldFilters,this._fieldOrders,t)}skip(e){we.isInteger("offset",e);const t={...this._queryOptions};return t.skip=e,new ze(this._db,this._coll,this._fieldFilters,this._fieldOrders,t)}field(e){for(const t in e)e[t]?"object"!=typeof e[t]&&(e[t]=1):e[t]=0;const t={...this._queryOptions};return t.projection=e,new ze(this._db,this._coll,this._fieldFilters,this._fieldOrders,t)}watch(e){throw Error(Y.WatchError)}}class Ye extends ze{get name(){return this._coll}doc(e){if("string"!=typeof e&&"number"!=typeof e)throw new Error("docId必须为字符串或数字");return new Ve(this._db,this._coll,e)}add(e){const t=new Ve(this._db,this._coll,void 0);return Array.isArray(e)?t.createMany(e):t.create(e)}}class Ke{constructor(e,t){this._transaction=e,this.config=t}collection(e){if(!e)throw new Error("Collection name is required");return new Ye(this._transaction,e)}commit(){return this._transaction.commit()}rollback(){return this._transaction.rollback()}}function Xe(e){if(!f(e))return e;const t={};return Object.keys(e).forEach(r=>{"$"===r.charAt(0)?t[r]=e[r]:(t.$set=t.$set||{},t.$set[r]=e[r])}),t}function Ze(e){return{id:e.result&&e.result.insertedId}}function et(e){const t=[];return Object.keys(e.result).sort().forEach(r=>{t.push(e.result[r])}),{inserted:e.affectedDocs,result:e.result,ids:t}}function tt(e){return{affectedDocs:e.affectedDocs,deleted:e.affectedDocs}}function rt(e){return{affectedDocs:e.affectedDocs,deleted:e.affectedDocs}}function nt(e){return{affectedDocs:e.affectedDocs,updated:e.result.nModified,upserted:e.result.upserted}}function ot(e){let t=null;return e.result&&Array.isArray(e.result.upserted)&&1===e.result.upserted.length&&(t=e.result.upserted[0]._id),{affectedDocs:e.affectedDocs,updated:e.affectedDocs,upsertedId:t}}function it(e){return{affectedDocs:e.affectedDocs,updated:e.affectedDocs}}function st(e){return{updated:e.affectedDocs,doc:e.result.value}}function at(e){const t=[];return e.result&&t.push(e.result),{affectedDocs:e.affectedDocs,data:t}}function ct(e){return{affectedDocs:e.affectedDocs,data:e.result}}function lt(e){return{affectedDocs:e.affectedDocs,total:e.result}}function dt(e){return{affectedDocs:e.affectedDocs,data:e.result}}class ut{constructor(e,t){this._coll=t,this._errorWrapper=O({collName:t})}get _db(){return global.uniCloud.$scope.db}insertOne(e){return d(this._db.collection(this._coll).insertOne(e),Ze,this._errorWrapper)}insertMany(e){return d(this._db.collection(this._coll).insertMany(e),et,this._errorWrapper)}deleteOne(e){return d(this._db.collection(this._coll).deleteOne(e),tt,this._errorWrapper)}deleteMany(e){return d(this._db.collection(this._coll).deleteMany(e),rt,this._errorWrapper)}replaceOne(e,t,r){return d(this._db.collection(this._coll).replaceOne(e,t,r),nt,this._errorWrapper)}updateOne(e,t,r){return t=Xe(t),d(this._db.collection(this._coll).updateOne(e,t,r),ot,this._errorWrapper)}updateMany(e,t,r){return t=Xe(t),d(this._db.collection(this._coll).updateMany(e,t,r),it,this._errorWrapper)}findOneAndUpdate(e,t,r){return t=Xe(t),d(this._db.collection(this._coll).findOneAndUpdate(e,t,r),st,this._errorWrapper)}findOne(e,t){return d(this._db.collection(this._coll).findOne(e,t),at,this._errorWrapper)}find(e,t){return d(this._db.collection(this._coll).find(e,t),ct,this._errorWrapper)}count(e,t){return d(this._db.collection(this._coll).count(e,t),lt,this._errorWrapper)}aggregate(e){return d(this._db.collection(this._coll).aggregate(e),dt,this._errorWrapper)}}class ht{constructor(e,t){this._stages=[],e&&t&&(this._db=e,this._coll=t)}end(){if(!this._coll||!this._db)throw new Error("Aggregation pipeline cannot send request");return new ut(this._db,this._coll).aggregate(this.done())}unwrap(){return this._stages}done(){return this._stages.map(({stageKey:e,stageValue:t})=>({[e]:JSON.parse(t)}))}_pipe(e,t){return this._stages.push({stageKey:"$"+e,stageValue:JSON.stringify(t)}),this}addFields(e){return this._pipe("addFields",e)}bucket(e){return this._pipe("bucket",e)}bucketAuto(e){return this._pipe("bucketAuto",e)}count(e){return this._pipe("count",e)}geoNear(e){return e.query&&(e.query=He.encode(e.query)),this._pipe("geoNear",e)}group(e){return this._pipe("group",e)}limit(e){return this._pipe("limit",e)}match(e){return this._pipe("match",He.encode(e))}project(e){return this._pipe("project",e)}lookup(e){return this._pipe("lookup",e)}replaceRoot(e){return this._pipe("replaceRoot",e)}sample(e){return this._pipe("sample",e)}skip(e){return this._pipe("skip",e)}sort(e){return this._pipe("sort",e)}sortByCount(e){return this._pipe("sortByCount",e)}unwind(e){return this._pipe("unwind",e)}}const pt={eq:e=>new Ie(Ae.EQ,[e]),neq:e=>new Ie(Ae.NEQ,[e]),lt:e=>new Ie(Ae.LT,[e]),lte:e=>new Ie(Ae.LTE,[e]),gt:e=>new Ie(Ae.GT,[e]),gte:e=>new Ie(Ae.GTE,[e]),in:e=>new Ie(Ae.IN,e),nin:e=>new Ie(Ae.NIN,e),all:e=>new Ie(Ae.ALL,e),elemMatch:e=>new Ie(Ae.ELEM_MATCH,[e]),exists:e=>new Ie(Ae.EXISTS,[e]),size:e=>new Ie(Ae.SIZE,[e]),mod:e=>new Ie(Ae.MOD,[e]),geoNear:e=>new Ie(Ae.GEO_NEAR,[e]),geoWithin:e=>new Ie(Ae.GEO_WITHIN,[e]),geoIntersects:e=>new Ie(Ae.GEO_INTERSECTS,[e]),and(...e){const t=V(arguments[0])?arguments[0]:Array.from(arguments);return new K(z.AND,t)},nor(...e){const t=V(arguments[0])?arguments[0]:Array.from(arguments);return new K(z.NOR,t)},or(...e){const t=V(arguments[0])?arguments[0]:Array.from(arguments);return new K(z.OR,t)},not(...e){const t=V(arguments[0])?arguments[0]:Array.from(arguments);return new K(z.NOT,t)},set:e=>new q(k.SET,[e]),remove:()=>new q(k.REMOVE,[]),inc:e=>new q(k.INC,[e]),mul:e=>new q(k.MUL,[e]),push(...e){let t;if(W(e[0])&&e[0].hasOwnProperty("each")){const r=e[0];t={$each:r.each,$position:r.position,$sort:r.sort,$slice:r.slice}}else t=V(e[0])?e[0]:Array.from(e);return new q(k.PUSH,t)},pull:e=>new q(k.PULL,e),pullAll:e=>new q(k.PULL_ALL,e),pop:()=>new q(k.POP,[]),shift:()=>new q(k.SHIFT,[]),unshift(...e){const t=V(arguments[0])?arguments[0]:Array.from(arguments);return new q(k.UNSHIFT,t)},addToSet:e=>new q(k.ADD_TO_SET,e),rename:e=>new q(k.RENAME,[e]),bit:e=>new q(k.BIT,[e]),max:e=>new q(k.MAX,[e]),min:e=>new q(k.MIN,[e]),expr:e=>({$expr:e}),jsonSchema:e=>({$jsonSchema:e}),text:e=>"string"===G(e)?{$search:e.search}:{$search:e.search,$language:e.language,$caseSensitive:e.caseSensitive,$diacriticSensitive:e.diacriticSensitive},aggregate:{pipeline:()=>new ht,abs:e=>new ft("abs",e),add:e=>new ft("add",e),ceil:e=>new ft("ceil",e),divide:e=>new ft("divide",e),exp:e=>new ft("exp",e),floor:e=>new ft("floor",e),ln:e=>new ft("ln",e),log:e=>new ft("log",e),log10:e=>new ft("log10",e),mod:e=>new ft("mod",e),multiply:e=>new ft("multiply",e),pow:e=>new ft("pow",e),sqrt:e=>new ft("sqrt",e),subtract:e=>new ft("subtract",e),trunc:e=>new ft("trunc",e),arrayElemAt:e=>new ft("arrayElemAt",e),arrayToObject:e=>new ft("arrayToObject",e),concatArrays:e=>new ft("concatArrays",e),filter:e=>new ft("filter",e),in:e=>new ft("in",e),indexOfArray:e=>new ft("indexOfArray",e),isArray:e=>new ft("isArray",e),map:e=>new ft("map",e),range:e=>new ft("range",e),reduce:e=>new ft("reduce",e),reverseArray:e=>new ft("reverseArray",e),size:e=>new ft("size",e),slice:e=>new ft("slice",e),zip:e=>new ft("zip",e),and:e=>new ft("and",e),not:e=>new ft("not",e),or:e=>new ft("or",e),cmp:e=>new ft("cmp",e),eq:e=>new ft("eq",e),gt:e=>new ft("gt",e),gte:e=>new ft("gte",e),lt:e=>new ft("lt",e),lte:e=>new ft("lte",e),neq:e=>new ft("ne",e),cond:e=>new ft("cond",e),ifNull:e=>new ft("ifNull",e),switch:e=>new ft("switch",e),dateFromParts:e=>new ft("dateFromParts",e),dateFromString:e=>new ft("dateFromString",e),dayOfMonth:e=>new ft("dayOfMonth",e),dayOfWeek:e=>new ft("dayOfWeek",e),dayOfYear:e=>new ft("dayOfYear",e),isoDayOfWeek:e=>new ft("isoDayOfWeek",e),isoWeek:e=>new ft("isoWeek",e),isoWeekYear:e=>new ft("isoWeekYear",e),millisecond:e=>new ft("millisecond",e),minute:e=>new ft("minute",e),month:e=>new ft("month",e),second:e=>new ft("second",e),hour:e=>new ft("hour",e),week:e=>new ft("week",e),year:e=>new ft("year",e),literal:e=>new ft("literal",e),mergeObjects:e=>new ft("mergeObjects",e),objectToArray:e=>new ft("objectToArray",e),allElementsTrue:e=>new ft("allElementsTrue",e),anyElementTrue:e=>new ft("anyElementTrue",e),setDifference:e=>new ft("setDifference",e),setEquals:e=>new ft("setEquals",e),setIntersection:e=>new ft("setIntersection",e),setIsSubset:e=>new ft("setIsSubset",e),setUnion:e=>new ft("setUnion",e),concat:e=>new ft("concat",e),dateToString:e=>new ft("dateToString",e),indexOfBytes:e=>new ft("indexOfBytes",e),indexOfCP:e=>new ft("indexOfCP",e),split:e=>new ft("split",e),strLenBytes:e=>new ft("strLenBytes",e),strLenCP:e=>new ft("strLenCP",e),strcasecmp:e=>new ft("strcasecmp",e),substr:e=>new ft("substr",e),substrBytes:e=>new ft("substrBytes",e),substrCP:e=>new ft("substrCP",e),toLower:e=>new ft("toLower",e),toUpper:e=>new ft("toUpper",e),meta:e=>new ft("meta",e),addToSet:e=>new ft("addToSet",e),avg:e=>new ft("avg",e),first:e=>new ft("first",e),last:e=>new ft("last",e),max:e=>new ft("max",e),min:e=>new ft("min",e),push:e=>new ft("push",e),stdDevPop:e=>new ft("stdDevPop",e),stdDevSamp:e=>new ft("stdDevSamp",e),sum:e=>new ft("sum",e),let:e=>new ft("let",e)},project:{slice:e=>new mt("slice",e),elemMatch:e=>new mt("elemMatch",e)}};class ft{constructor(e,t){this["$"+e]=t}}class mt{constructor(e,t){this["$"+e]=t}}class wt{constructor(e,t,r,n={}){this.watch=l("watch"),this._db=e,this._coll=t,this.id=r,this.projection=n}create(e){return this.id&&(e._id=this.id),e=Le(e),new ut(this._db,this._coll).insertOne(e)}createMany(e){return e=Le(e),new ut(this._db,this._coll).insertMany(e)}set(e){if(!this.id)throw new a({code:"INVALID_PARAM",message:"docId不能为空"});if(!e||"object"!=typeof e)throw new a({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(p(e,"_id"))throw new a({code:"INVALID_PARAM",message:"不能更新_id的值"});let t=!1;const r=e=>{if("object"==typeof e)for(const n in e)e[n]instanceof q?t=!0:"object"==typeof e[n]&&r(e[n])};if(r(e),t)throw new a({code:"DATABASE_REQUEST_FAILED",message:"update operator complicit"});return new ut(this._db,this._coll).replaceOne({_id:this.id},Le(e),{upsert:!0}).then(e=>(e.upserted?e.upsertedId=this.id:e.upsertedId=null,delete e.upserted,Promise.resolve(e)))}update(e){if(!e||"object"!=typeof e)throw new a({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(p(e,"_id"))throw new a({code:"INVALID_PARAM",message:"不能更新_id的值"});return new ut(this._db,this._coll).updateOne({_id:this.id},Ce.encode(e))}updateAndReturn(e){if(!e||"object"!=typeof e)throw new a({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(p(e,"_id"))throw new a({code:"INVALID_PARAM",message:"不能更新_id的值"});return new ut(this._db,this._coll).findOneAndUpdate({_id:this.id},Ce.encode(e),{returnNewDocument:!0})}remove(){return new ut(this._db,this._coll).deleteOne({_id:this.id})}get(){return new ut(this._db,this._coll).findOne({_id:this.id},{projection:this.projection})}field(e){for(const t in e)e[t]?e[t]=1:e[t]=0;return new wt(this._db,this._coll,this.id,e)}}const _t={asc:1,desc:-1};class yt{constructor(e,t,r,n,o){this._db=e,this._coll=t,this._fieldFilters=r,this._fieldOrders=n||[],this._queryOptions=o||{}}get(){const e={};return this._fieldOrders.length&&(e.sort={},this._fieldOrders.forEach(t=>{Object.assign(e.sort,t)})),this._queryOptions.skip&&(e.skip=this._queryOptions.skip),this._queryOptions.limit?e.limit=this._queryOptions.limit<1e3?this._queryOptions.limit:1e3:e.limit=100,this._queryOptions.projection&&(e.projection=this._queryOptions.projection),new ut(this._db,this._coll).find(this._fieldFilters||{},e)}update(e){if(!e||"object"!=typeof e)throw new a({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(p(e,"_id"))throw new a({code:"INVALID_PARAM",message:"不能更新_id的值"});return new ut(this._db,this._coll).updateMany(this._fieldFilters||{},Ce.encode(e))}updateAndReturn(e){if(!e||"object"!=typeof e)throw new a({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(p(e,"_id"))throw new a({code:"INVALID_PARAM",message:"不能更新_id的值"});return new ut(this._db,this._coll).findOneAndUpdate(this._fieldFilters||{},Ce.encode(e),{returnNewDocument:!0})}remove(e){return Object.keys(this._queryOptions).length>0&&console.warn("`offset`, `limit` and `projection` are not supported in remove() operation"),this._fieldOrders.length>0&&console.warn("`orderBy` is not supported in remove() operation"),new ut(this._db,this._coll).deleteMany(this._fieldFilters||{})}count(){return new ut(this._db,this._coll).count(this._fieldFilters||{})}where(e){if(!f(e))throw Error(Y.QueryParamTypeError);const t=Object.keys(e),r=t.some(t=>void 0!==e[t]);if(t.length&&!r)throw Error(Y.QueryParamValueError);return new yt(this._db,this._coll,He.encode(e),this._fieldOrders,this._queryOptions)}orderBy(e,t){we.isFieldPath(e),we.isFieldOrder(t);const r={};r[e]=_t[t];const n=this._fieldOrders.concat([r]);return new yt(this._db,this._coll,this._fieldFilters,n,this._queryOptions)}limit(e){we.isInteger("limit",e);const t={...this._queryOptions};return t.limit=e,new yt(this._db,this._coll,this._fieldFilters,this._fieldOrders,t)}skip(e){we.isInteger("offset",e);const t={...this._queryOptions};return t.skip=e,new yt(this._db,this._coll,this._fieldFilters,this._fieldOrders,t)}field(e){for(const t in e)e[t]?"object"!=typeof e[t]&&(e[t]=1):e[t]=0;const t={...this._queryOptions};return t.projection=e,new yt(this._db,this._coll,this._fieldFilters,this._fieldOrders,t)}watch(e){throw Error(Y.WatchError)}}class gt extends yt{get name(){return this._coll}doc(e){if("string"!=typeof e&&"number"!=typeof e)throw new Error("docId必须为字符串或数字");return new wt(this._db,this._coll,e)}add(e){const t=new wt(this._db,this._coll,void 0);return Array.isArray(e)?t.createMany(e):t.create(e)}aggregate(){return new ht(this._db,this._coll)}}const bt=l("createCollection"),Ot=l("serverDate"),Et=l("runTransaction");class At{constructor(e,t){this._db=e,this.config=t,this.Geo=Ne,this.command=pt}get _latestDB(){return global.uniCloud.$scope.db}get serverDate(){return Ot()}get RegExp(){return class{constructor({regex:e,options:t}){return new RegExp(e,t)}}}collection(e){if(!e)throw new Error("Collection name is required");return new gt(this._db,e)}createCollection(e){return bt(e)}async startTransaction(){const e=await(this._latestDB||this._db).startTransaction();return new Ke(e,this.config)}runTransaction(){return Et()}}async function Nt(e={}){const t=e.appid||global.__ctx__.APPID||void 0,r=global.__ctx__.SPACEINFO.spaceId,n={aliyun:"aliyun",tencent:"tcb"}[global.__ctx__.SPACEINFO.provider],{apiKey:o,apiSecret:i,access_token:c,openid:l}=e,d={token:c,openid:l,appid:t,spaceId:r,provider:n,apiKey:o};for(const e in d)void 0===d[e]&&delete d[e];const u=Object.keys(d).sort().map(e=>`${e}=${""+d[e]}`);u.push("apiSecret="+i);const h=s.default.createHash("md5");h.update(u.join("&"));const p=h.digest("hex").toLowerCase();let f;try{f=await uniCloud.httpclient.request("https://c2c84d41-a90b-40ed-83e2-025e60889a78.bspapp.com/http/get-mobile-space",{data:{...d,sign:p},dataAsQueryString:!0,dataType:"json",timeout:3e4})}catch(e){f={}}if(f&&f.status>=400)try{f=await uniCloud.httpclient.request("https://hbonshoregewslogypti.dcloud.net.cn/get-mobile-space",{data:{...d,sign:p},dataAsQueryString:!0,dataType:"json",timeout:3e4})}catch(e){f={}}if(f&&f.data){if(0===f.data.ret)return{code:0,success:!0,phoneNumber:f.data.data.mobile};throw 4002===f.data.ret?new a({code:4002,message:"获取手机号码失败：请检查密钥是否正确"}):new a({code:f.data.ret||5e3,message:"获取手机号码失败："+f.data.desc})}throw new a({code:5e3,message:"获取手机号码失败"})}async function It(e){const t={univerify:Nt},{provider:r}=e;let n;switch(r){case"univerify":n={access_token:["string"],openid:["string"],apiKey:["string"],apiSecret:["string"]};break;case void 0:throw new a({code:1001,message:"getPhoneNumber缺少参数provider"});default:throw new a({code:1001,message:"getPhoneNumber不支持provider:"+r})}try{_({param:e,rule:n,errTpl:"getPhoneNumber%err%"})}catch(e){throw new a({code:1001,message:e.message})}return await t[r](e)}function Tt(e){if("string"!=typeof e||!/^(0|17951|86|\+86)?(1\d{10})$/.test(e))throw new a({code:1001,message:"手机号格式不正确，仅支持中国大陆手机号"})}async function Dt(e){const t={smsKey:["string"],smsSecret:["string"],templateId:["string"],data:["object"]};try{_({param:e,rule:t,errTpl:"sendSms%err%"})}catch(e){throw new a({code:1001,message:e.message})}const r=e.appid||global.__ctx__.APPID||void 0,n=global.__ctx__.SPACEINFO.spaceId,o={aliyun:"aliyun",tencent:"tcb"}[global.__ctx__.SPACEINFO.provider],i=""+Date.now(),{smsKey:c,smsSecret:l,templateId:d,data:u,phone:h,phoneList:p}=e;if(h)Tt(h);else{if(!p)throw new a({code:1001,message:"手机号格式不正确，请传入phone或phoneList参数"});for(let e=0;e<p.length;e++){Tt(p[e])}}const f=Object.keys(u).reduce((e,t)=>e+=u[t],"");if(/【|】/.test(f))throw new a({code:1001,message:"为避免与签名混淆，短信内容不可包含“【】”符号"});/(测试|test)/i.test(f)&&console.warn("短信内容包含“测试”、“test”字样时，系统可能会被判定为测试用途，不会真正把短信下发到对应手机（此行为由运营商控制，可能真实发送，也可能不发送）");const m={appid:r,apiKey:c,templateId:d,timestamp:i,spaceId:n,provider:o,params:JSON.stringify(u)};h?m.phone=h:p&&(m.phoneList=p.filter((e,t)=>p.indexOf(e)===t).join(","));for(const e in m)void 0===m[e]&&delete m[e];const w=Object.keys(m).sort().map(e=>`${e}=${m[e]}`);w.push("apiSecret="+l);const y=s.default.createHash("md5");y.update(w.join("&"));const g=y.digest("hex").toLowerCase();let b;try{b=await uniCloud.httpclient.request("https://c2c84d41-a90b-40ed-83e2-025e60889a78.bspapp.com/http/send-sms-space",{data:{...m,sign:g},dataAsQueryString:!0,dataType:"json",timeout:3e4})}catch(e){b={}}if(b&&b.status>=400)try{b=await uniCloud.httpclient.request("https://hbonshoregewslogypti.dcloud.net.cn/send-sms-space",{data:{...m,sign:g},dataAsQueryString:!0,dataType:"json",timeout:3e4})}catch(e){b={}}if(b&&b.data){if(0===b.data.ret)return{code:0,errCode:0,success:!0};throw 4002===b.data.ret?new a({code:4002,message:"短信发送失败：请检查密钥是否正确"}):new a({code:b.data.ret||5e3,message:"短信发送失败："+b.data.desc})}throw new a({code:5e3,message:"短信发送失败"})}const St=Array.isArray,Pt=["{","}"];const Lt=/^(?:\d)+/,vt=/^(?:\w)+/;const Mt=Object.prototype.hasOwnProperty,$t=(e,t)=>Mt.call(e,t),jt=new class{constructor(){this._caches=Object.create(null)}interpolate(e,t,r=Pt){if(!t)return[e];let n=this._caches[e];return n||(n=function(e,[t,r]){const n=[];let o=0,i="";for(;o<e.length;){let s=e[o++];if(s===t){i&&n.push({type:"text",value:i}),i="";let t="";for(s=e[o++];void 0!==s&&s!==r;)t+=s,s=e[o++];const a=s===r,c=Lt.test(t)?"list":a&&vt.test(t)?"named":"unknown";n.push({value:t,type:c})}else i+=s}return i&&n.push({type:"text",value:i}),n}(e,r),this._caches[e]=n),function(e,t){const r=[];let n=0;const o=St(t)?"list":(i=t,null!==i&&"object"==typeof i?"named":"unknown");var i;if("unknown"===o)return r;for(;n<e.length;){const i=e[n];switch(i.type){case"text":r.push(i.value);break;case"list":r.push(t[parseInt(i.value,10)]);break;case"named":"named"===o&&r.push(t[i.value])}n++}return r}(n,t)}};function Ct(e,t){if(!e)return;if(e=e.trim().replace(/_/g,"-"),t&&t[e])return e;if(0===(e=e.toLowerCase()).indexOf("zh"))return e.indexOf("-hans")>-1?"zh-Hans":e.indexOf("-hant")>-1?"zh-Hant":(r=e,["-tw","-hk","-mo","-cht"].find(e=>-1!==r.indexOf(e))?"zh-Hant":"zh-Hans");var r;const n=function(e,t){return t.find(t=>0===e.indexOf(t))}(e,["en","fr","es"]);return n||void 0}class Rt{constructor({locale:e,fallbackLocale:t,messages:r,watcher:n,formater:o}){this.locale="en",this.fallbackLocale="en",this.message={},this.messages={},this.watchers=[],t&&(this.fallbackLocale=t),this.formater=o||jt,this.messages=r||{},this.setLocale(e||"en"),n&&this.watchLocale(n)}setLocale(e){const t=this.locale;this.locale=Ct(e,this.messages)||this.fallbackLocale,this.messages[this.locale]||(this.messages[this.locale]={}),this.message=this.messages[this.locale],t!==this.locale&&this.watchers.forEach(e=>{e(this.locale,t)})}getLocale(){return this.locale}watchLocale(e){const t=this.watchers.push(e)-1;return()=>{this.watchers.splice(t,1)}}add(e,t,r=!0){const n=this.messages[e];n?r?Object.assign(n,t):Object.keys(t).forEach(e=>{$t(n,e)||(n[e]=t[e])}):this.messages[e]=t}f(e,t,r){return this.formater.interpolate(e,t,r).join("")}t(e,t,r){let n=this.message;return"string"==typeof t?(t=Ct(t,this.messages))&&(n=this.messages[t]):r=t,$t(n,e)?this.formater.interpolate(n[e],r).join(""):(console.warn(`Cannot translate the value of keypath ${e}. Use the value of keypath as default.`),e)}}function Ft({locale:e,fallbackLocale:t,messages:r}){return new Rt({locale:e,fallbackLocale:t,messages:r})}function xt(e={}){this.$provider="aliyun",this.$options=e,this.$context=e.context||global.__ctx__,function(e){e.$scope=e.$context.mpserverless}(this),function(e){e.auth=l("auth"),e.customAuth=e.auth}(this),E(this),function(e){e.logger=console}(this),function(e){e.database=function(t){return e.$scope.db.toJSON=function(){return"_db"},new At(e.$scope.db,t)}}(this),function(e){e.callFunction=function({name:t,data:r}){return new Promise((n,o)=>{e.$scope.function.invoke(t,r).then(e=>{n(e)}).catch(e=>{o(new a(e))})})}}(this),function(e){e.httpclient=e.$context.httpclient}(this),function(e){e.getPhoneNumber=It,e.sendSms=Dt,e.initI18n=Ft}(this)}xt.prototype.init=function(e){return"tencent"===uniCloud.$provider&&e.context&&!e.spaceId?this:new xt(e)},module.exports=xt;

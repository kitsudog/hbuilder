"use strict";var e=require("fs"),t=require("path"),r=require("crypto"),n=require("events"),s=require("https"),i=require("http"),o=require("net"),a=require("tls"),c=require("stream"),l=require("url"),d=require("zlib"),h=require("os"),u=require("util");function f(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var p=f(e),_=f(t),m=f(r),w=f(n),y=f(s),g=f(i),b=f(o),E=f(a),v=f(c),O=f(l),S=f(d),N=f(h);class I extends Error{constructor(e={}){super(e.message),this.errMsg=e.message||"",this.code=this.errCode=e.code,this.errSubject=e.subject,this.forceReturn=e.forceReturn||!1,this.cause=e.cause,Object.defineProperties(this,{message:{get(){return this.errMsg},set(e){this.errMsg=e}}})}toJSON(e=0){if(!(e>=10))return e++,{errCode:this.errCode,errMsg:this.errMsg,code:this.errCode,message:this.message,errSubject:this.errSubject,cause:this.cause&&this.cause.toJSON?this.cause.toJSON(e):this.cause}}}const T=[{rule:/Cannot create field (\S+) in element {(\S+): \[\]}/,content:"，不可在{$2}上新增字段{$1}，因为{$2}是一个数组",mode:"append"},{rule:/Db or Table not exist/,content:"，服务空间内不存在名为{collName}的表，请检查表名是否正确",mode:"append"},{rule:/operation exceeded time limit|云数据库执行时间超限/,content:"，集合{collName}操作超时，请参照此文档进行优化：https://uniapp.dcloud.net.cn/uniCloud/db-performance",mode:"append"},{rule:/TransientTransactionError.*WriteConflict/,content:"，事务写数据冲突，请优化事务流程",mode:"append"}];function A(e){return function(){throw new Error("阿里云服务空间暂不支持 "+e)}}function L(e,t,r){return new Promise((function(n,s){e.then(e=>{e.code?s(new I(r?r(e):e)):n(t?t(e):e)}).catch(e=>{s(new I(r?r(e):e))})}))}const x=Object.prototype.toString,C=Object.prototype.hasOwnProperty;function P(e,t){return C.call(e,t)}function k(e){return"[object Object]"===x.call(e)}function D(e){return x.call(e).slice(8,-1).toLowerCase()}var R=/[\\^$.*+?()[\]{}|]/g,M=RegExp(R.source);function j(e,t,r){return e.replace(new RegExp((n=t)&&M.test(n)?n.replace(R,"\\$&"):n,"g"),r);var n}function U({collName:e}){return function(t){const r=t&&t.message;return r?(t.message=function({message:e="",extraInfo:t={},formatter:r=[]}={}){for(let n=0;n<r.length;n++){const{rule:s,content:i,mode:o}=r[n],a=e.match(s);if(!a)continue;let c=i;for(let e=1;e<a.length;e++)c=j(c,`{$${e}}`,a[e]);for(const e in t)c=j(c,`{${e}}`,t[e]);switch(o){case"replace":return c;case"append":default:return e+c}}return e}({message:r,extraInfo:{collName:e},formatter:T}),t):t}}function F(e){const t={...e},{OS:r,APPID:n,LOCALE:s,PLATFORM:i,DEVICEID:o,CLIENTIP:a,CLIENTUA:c,SOURCE:l,requestId:d,secretType:h}=t,u=["SPACEINFO","FUNCTION_NAME","FUNCTION_TYPE","SOURCE","OS","APPID","LOCALE","CLIENTIP","CLIENTUA","PLATFORM","DEVICEID","requestId"];for(let e=0;e<u.length;e++){delete t[u[e]]}const f={...t,os:r,appId:n,locale:s,clientIP:a,userAgent:c,platform:"app-plus"===i?"app":i,deviceId:o,source:l,requestId:d,secretType:h};return function e(t){for(const r in t){const n=t[r];switch(D(n)){case"undefined":delete t[r];break;case"object":e(n)}}}(f),f}function $(e){const{provider:t,spaceId:r,useOldSpaceId:n}=e.SPACEINFO,{FUNCTION_NAME:s,FUNCTION_TYPE:i}=e;return{provider:t,spaceId:r,useOldSpaceId:n,functionName:s,functionType:i}}function B(e,t){let r,n;switch(t.SOURCE){case"timing":r="_timing",n=[];break;case"http":{const t=e.path.replace(/^\//,"");if(""===t)throw new Error(`"${e.path}" is not a valid cloudobject path`);r=t.split("/")[0],n=[e.queryStringParameters||{}];break}case"server":case"client":case"function":default:r=e.method,n=e.params}return"timing"!==t.SOURCE&&function(e){if(!e)throw new Error("Method name is required");if("_"===e[0])throw new Error(`Forbidden, ${e} is a private method`)}(r),{methodName:r,params:n}}async function q(e){try{return await uniCloud.$scope.file.deleteFile(e),{fileID:e}}catch(t){return{code:t.code,fileID:e}}}async function W(e){const t=await uniCloud.$scope.file.deleteFile(e.map(e=>e.split("?")[0]).join(","));if(!t.success)throw new Error("delete file failed");return{fileList:t.result.map(e=>({code:e.code||e.errorCode,message:e.message||e.errorMessage,fileID:e.fileId}))}}function G(e){return async function({fileList:t=[]}={}){if(!Array.isArray(t)||!t.length)return{fileList:[]};if(function(e){const t=e.env.MP_RUNTIME_VERSION;return!(!t||"string"!=typeof t)&&parseInt(t.split(".")[0])>=2}(e.$context))return W(t);const r=[];t.forEach(e=>{e&&r.push(q(e))});return{fileList:await Promise.all(r)}}}function V(e){e.uploadFile=function(e){return async function(t={}){const{cloudPathAsRealPath:r=!1}=t||{};let n=t.cloudPath;if("string"!=typeof n)throw new I({code:"INVALID_PARAM",message:"cloudPath不可为空"});if(r&&("/"!==n[0]&&(n="/"+n),n.indexOf("\\")>-1))throw new I({code:"INVALID_PARAM",message:"使用cloudPath作为路径时，cloudPath不可包含“\\”"});const s={fileName:r?n.split("/").pop():n,cloudPath:r?n:void 0};return Buffer.isBuffer(t.fileContent)?s.fileBuffer=t.fileContent:s.filePath=t.fileContent,e.$scope.file.uploadFile(s).then(e=>({fileID:e.fileUrl}))}}(e),e.deleteFile=G(e),e.getUploadFileOptions=function(e){return async function({cloudPath:t=""}={}){return e.$scope.file.getUploadFileOptions({filePath:t})}}(e),e.getTempFileURL=async function({fileList:e}={}){if(!Array.isArray(e)||0===e.length)throw new I({code:"INVALID_PARAM",message:"fileList的元素必须是非空的字符串"});return{fileList:e.map(e=>({fileID:e,tempFileURL:e}))}},e.getFileInfo=function(e){return async function({fileList:t}={}){if(!Array.isArray(t)||0===t.length)throw new I({code:"INVALID_PARAM",message:"fileList的元素必须是非空的字符串"});const{result:r}=await e.$scope.file.info(t);return{fileList:r}}}(e),e.downloadFile=A("downloadFile")}require("path"),require("module");const H=[],Q={};class J extends class{constructor(e){Object.defineProperties(this,{target:{enumerable:!1,writable:!1,configurable:!1,value:e}})}}{constructor(e,t){if(t!==Q)throw new TypeError("InternalSymbol cannot be constructed with new operator");super(e)}static for(e){for(let t=0,r=H.length;t<r;t++)if(H[t].target===e)return H[t].instance;const t=new J(e,Q);return H.push({target:e,instance:t}),t}}var Y=J;const z=Y.for("UNSET_FIELD_NAME"),X=Y.for("UPDATE_COMMAND"),Z=Y.for("QUERY_COMMAND"),K=Y.for("LOGIC_COMMAND"),ee=Y.for("GEO_POINT"),te=Y.for("SYMBOL_GEO_LINE_STRING"),re=Y.for("SYMBOL_GEO_POLYGON"),ne=Y.for("SYMBOL_GEO_MULTI_POINT"),se=Y.for("SYMBOL_GEO_MULTI_LINE_STRING"),ie=Y.for("SYMBOL_GEO_MULTI_POLYGON"),oe=Y.for("SERVER_DATE"),ae=Y.for("REGEXP");var ce;!function(e){e.SET="set",e.REMOVE="remove",e.INC="inc",e.MUL="mul",e.PUSH="push",e.PULL="pull",e.PULL_ALL="pullAll",e.POP="pop",e.SHIFT="shift",e.UNSHIFT="unshift",e.ADD_TO_SET="addToSet",e.BIT="bit",e.RENAME="rename",e.MAX="max",e.MIN="min"}(ce||(ce={}));class le{constructor(e,t,r){this._internalType=X,Object.defineProperties(this,{_internalType:{enumerable:!1,configurable:!1}}),this.operator=e,this.operands=t,this.fieldName=r||z}_setFieldName(e){return new le(this.operator,this.operands,e)}}function de(e){return e&&e instanceof le&&e._internalType===X}const he=e=>Object.prototype.toString.call(e).slice(8,-1).toLowerCase(),ue=e=>"object"===he(e),fe=e=>"number"===he(e),pe=e=>Array.isArray(e),_e=e=>"date"===he(e),me=e=>"regexp"===he(e),we=e=>e&&e._internalType instanceof J;var ye,ge;!function(e){e.AND="and",e.OR="or",e.NOT="not",e.NOR="nor"}(ye||(ye={}));class be{constructor(e,t,r){if(this._internalType=K,Object.defineProperties(this,{_internalType:{enumerable:!1,configurable:!1}}),this.operator=e,this.operands=t,this.fieldName=r||z,this.fieldName!==z)if(Array.isArray(t)){t=t.slice(),this.operands=t;for(let e=0,r=t.length;e<r;e++){const r=t[e];(Ee(r)||Ye(r))&&(t[e]=r._setFieldName(this.fieldName))}}else{const e=t;(Ee(e)||Ye(e))&&(t=e._setFieldName(this.fieldName))}}_setFieldName(e){const t=this.operands.map(t=>t instanceof be?t._setFieldName(e):t);return new be(this.operator,t,e)}and(...e){const t=Array.isArray(arguments[0])?arguments[0]:Array.from(arguments);return t.unshift(this),new be(ye.AND,t,this.fieldName)}or(...e){const t=Array.isArray(arguments[0])?arguments[0]:Array.from(arguments);return t.unshift(this),new be(ye.OR,t,this.fieldName)}}function Ee(e){return e&&e instanceof be&&e._internalType===K}!function(e){e.DocIDError="文档ID不合法",e.CollNameError="集合名称不合法",e.OpStrError="操作符不合法",e.DirectionError="排序字符不合法",e.IntergerError="must be integer",e.QueryParamTypeError="查询参数必须为对象",e.QueryParamValueError="查询参数对象值不能均为undefined"}(ge||(ge={}));const ve="Number",Oe="Object",Se="Array",Ne="GeoPoint",Ie="GeoLineString",Te="GeoPolygon",Ae="GeoMultiPoint",Le="GeoMultiLineString",xe="GeoMultiPolygon",Ce="Date",Pe="ServerDate",ke="BsonDate",De=["desc","asc"],Re=["<","<=","==",">=",">"];var Me,je;!function(e){e.lt="<",e.gt=">",e.lte="<=",e.gte=">=",e.eq="=="}(Me||(Me={})),Me.eq,Me.lt,Me.lte,Me.gt,Me.gte,function(e){e.WHERE="WHERE",e.DOC="DOC"}(je||(je={}));class Ue{}Ue.formatResDocumentData=e=>e.map(e=>Ue.formatField(e)),Ue.formatField=e=>{const t=Object.keys(e);let r={};return Array.isArray(e)&&(r=[]),t.forEach(t=>{const n=e[t];let s;switch(Ue.whichType(n)){case Ne:s=new $e(n.coordinates[0],n.coordinates[1]);break;case Ie:s=new Be(n.coordinates.map(e=>new $e(e[0],e[1])));break;case Te:s=new qe(n.coordinates.map(e=>new Be(e.map(([e,t])=>new $e(e,t)))));break;case Ae:s=new We(n.coordinates.map(e=>new $e(e[0],e[1])));break;case Le:s=new Ge(n.coordinates.map(e=>new Be(e.map(([e,t])=>new $e(e,t)))));break;case xe:s=new Ve(n.coordinates.map(e=>new qe(e.map(e=>new Be(e.map(([e,t])=>new $e(e,t)))))));break;case Ce:s=new Date(1e3*n.$timestamp);break;case Oe:case Se:s=Ue.formatField(n);break;case Pe:s=new Date(n.$date);break;default:s=n}Array.isArray(r)?r.push(s):r[t]=s}),r},Ue.whichType=e=>{let t=Object.prototype.toString.call(e).slice(8,-1);if(t===Ce)return ke;if(t===Oe){if(e instanceof $e)return Ne;if(e instanceof Date)return Ce;if(e instanceof class{constructor({offset:e=0}={}){this.offset=e}get _internalType(){return oe}parse(){return{$date:{offset:this.offset}}}})return Pe;e.$timestamp?t=Ce:e.$date?t=Pe:$e.validate(e)?t=Ne:Be.validate(e)?t=Ie:qe.validate(e)?t=Te:We.validate(e)?t=Ae:Ge.validate(e)?t=Le:Ve.validate(e)&&(t=xe)}return t},Ue.generateDocId=()=>{let e="ABCDEFabcdef0123456789",t="";for(let r=0;r<24;r++)t+=e.charAt(Math.floor(Math.random()*e.length));return t};class Fe{static isGeopoint(e,t){if(Ue.whichType(t)!==ve)throw new Error("Geo Point must be number type");const r=Math.abs(t);if("latitude"===e&&r>90)throw new Error("latitude should be a number ranges from -90 to 90");if("longitude"===e&&r>180)throw new Error("longitude should be a number ranges from -180 to 180");return!0}static isInteger(e,t){if(!Number.isInteger(t))throw new Error(e+ge.IntergerError);return!0}static isFieldOrder(e){if(-1===De.indexOf(e))throw new Error(ge.DirectionError);return!0}static isFieldPath(e){if(!/^[a-zA-Z0-9-_\.]/.test(e))throw new Error;return!0}static isOperator(e){if(-1===Re.indexOf(e))throw new Error(ge.OpStrError);return!0}static isCollName(e){if(!/^[a-zA-Z0-9]([a-zA-Z0-9-_]){1,32}$/.test(e))throw new Error(ge.CollNameError);return!0}static isDocID(e){if(!/^([a-fA-F0-9]){24}$/.test(e))throw new Error(ge.DocIDError);return!0}}class $e{constructor(e,t){Fe.isGeopoint("longitude",e),Fe.isGeopoint("latitude",t),this.longitude=e,this.latitude=t}parse(e){return{[e]:{type:"Point",coordinates:[this.longitude,this.latitude]}}}toJSON(){return{type:"Point",coordinates:[this.longitude,this.latitude]}}toReadableString(){return`[${this.longitude},${this.latitude}]`}static validate(e){return"Point"===e.type&&pe(e.coordinates)&&Fe.isGeopoint("longitude",e.coordinates[0])&&Fe.isGeopoint("latitude",e.coordinates[1])}get _internalType(){return ee}}class Be{constructor(e){if(!pe(e))throw new TypeError('"points" must be of type Point[]. Received type '+typeof e);if(e.length<2)throw new Error('"points" must contain 2 points at least');e.forEach(e=>{if(!(e instanceof $e))throw new TypeError(`"points" must be of type Point[]. Received type ${typeof e}[]`)}),this.points=e}parse(e){return{[e]:{type:"LineString",coordinates:this.points.map(e=>e.toJSON().coordinates)}}}toJSON(){return{type:"LineString",coordinates:this.points.map(e=>e.toJSON().coordinates)}}static validate(e){if("LineString"!==e.type||!pe(e.coordinates))return!1;for(let t of e.coordinates)if(!fe(t[0])||!fe(t[1]))return!1;return!0}static isClosed(e){const t=e.points[0],r=e.points[e.points.length-1];if(t.latitude===r.latitude&&t.longitude===r.longitude)return!0}get _internalType(){return te}}class qe{constructor(e){if(!pe(e))throw new TypeError('"lines" must be of type LineString[]. Received type '+typeof e);if(0===e.length)throw new Error("Polygon must contain 1 linestring at least");e.forEach(e=>{if(!(e instanceof Be))throw new TypeError(`"lines" must be of type LineString[]. Received type ${typeof e}[]`);if(!Be.isClosed(e))throw new Error(`LineString ${e.points.map(e=>e.toReadableString())} is not a closed cycle`)}),this.lines=e}parse(e){return{[e]:{type:"Polygon",coordinates:this.lines.map(e=>e.points.map(e=>[e.longitude,e.latitude]))}}}toJSON(){return{type:"Polygon",coordinates:this.lines.map(e=>e.points.map(e=>[e.longitude,e.latitude]))}}static validate(e){if("Polygon"!==e.type||!pe(e.coordinates))return!1;for(let t of e.coordinates){if(!this.isCloseLineString(t))return!1;for(let e of t)if(!fe(e[0])||!fe(e[1]))return!1}return!0}static isCloseLineString(e){const t=e[0],r=e[e.length-1];return t[0]===r[0]&&t[1]===r[1]}get _internalType(){return ie}}class We{constructor(e){if(!pe(e))throw new TypeError('"points" must be of type Point[]. Received type '+typeof e);if(0===e.length)throw new Error('"points" must contain 1 point at least');e.forEach(e=>{if(!(e instanceof $e))throw new TypeError(`"points" must be of type Point[]. Received type ${typeof e}[]`)}),this.points=e}parse(e){return{[e]:{type:"MultiPoint",coordinates:this.points.map(e=>e.toJSON().coordinates)}}}toJSON(){return{type:"MultiPoint",coordinates:this.points.map(e=>e.toJSON().coordinates)}}static validate(e){if("MultiPoint"!==e.type||!pe(e.coordinates))return!1;for(let t of e.coordinates)if(!fe(t[0])||!fe(t[1]))return!1;return!0}get _internalType(){return ne}}class Ge{constructor(e){if(!pe(e))throw new TypeError('"lines" must be of type LineString[]. Received type '+typeof e);if(0===e.length)throw new Error("Polygon must contain 1 linestring at least");e.forEach(e=>{if(!(e instanceof Be))throw new TypeError(`"lines" must be of type LineString[]. Received type ${typeof e}[]`)}),this.lines=e}parse(e){return{[e]:{type:"MultiLineString",coordinates:this.lines.map(e=>e.points.map(e=>[e.longitude,e.latitude]))}}}toJSON(){return{type:"MultiLineString",coordinates:this.lines.map(e=>e.points.map(e=>[e.longitude,e.latitude]))}}static validate(e){if("MultiLineString"!==e.type||!pe(e.coordinates))return!1;for(let t of e.coordinates)for(let e of t)if(!fe(e[0])||!fe(e[1]))return!1;return!0}get _internalType(){return se}}class Ve{constructor(e){if(!pe(e))throw new TypeError('"polygons" must be of type Polygon[]. Received type '+typeof e);if(0===e.length)throw new Error("MultiPolygon must contain 1 polygon at least");for(let t of e)if(!(t instanceof qe))throw new TypeError(`"polygon" must be of type Polygon[]. Received type ${typeof t}[]`);this.polygons=e}parse(e){return{[e]:{type:"MultiPolygon",coordinates:this.polygons.map(e=>e.lines.map(e=>e.points.map(e=>[e.longitude,e.latitude])))}}}toJSON(){return{type:"MultiPolygon",coordinates:this.polygons.map(e=>e.lines.map(e=>e.points.map(e=>[e.longitude,e.latitude])))}}static validate(e){if("MultiPolygon"!==e.type||!pe(e.coordinates))return!1;for(let t of e.coordinates)for(let e of t)for(let t of e)if(!fe(t[0])||!fe(t[1]))return!1;return!0}get _internalType(){return re}}var He,Qe=Object.freeze({__proto__:null,Point:$e,LineString:Be,Polygon:qe,MultiPoint:We,MultiLineString:Ge,MultiPolygon:Ve});!function(e){e.EQ="eq",e.NEQ="neq",e.GT="gt",e.GTE="gte",e.LT="lt",e.LTE="lte",e.IN="in",e.NIN="nin",e.ALL="all",e.ELEM_MATCH="elemMatch",e.EXISTS="exists",e.SIZE="size",e.MOD="mod",e.GEO_NEAR="geoNear",e.GEO_WITHIN="geoWithin",e.GEO_INTERSECTS="geoIntersects"}(He||(He={}));class Je extends be{constructor(e,t,r){super(e,t,r),this.operator=e,this._internalType=Z}toJSON(){switch(this.operator){case He.IN:case He.NIN:return{["$"+this.operator]:this.operands};case He.NEQ:return{$ne:this.operands[0]};default:return{["$"+this.operator]:this.operands[0]}}}_setFieldName(e){return new Je(this.operator,this.operands,e)}eq(e){const t=new Je(He.EQ,[e],this.fieldName);return this.and(t)}neq(e){const t=new Je(He.NEQ,[e],this.fieldName);return this.and(t)}gt(e){const t=new Je(He.GT,[e],this.fieldName);return this.and(t)}gte(e){const t=new Je(He.GTE,[e],this.fieldName);return this.and(t)}lt(e){const t=new Je(He.LT,[e],this.fieldName);return this.and(t)}lte(e){const t=new Je(He.LTE,[e],this.fieldName);return this.and(t)}in(e){const t=new Je(He.IN,e,this.fieldName);return this.and(t)}nin(e){const t=new Je(He.NIN,e,this.fieldName);return this.and(t)}geoNear(e){if(!(e.geometry instanceof $e))throw new TypeError('"geometry" must be of type Point. Received type '+typeof e.geometry);if(void 0!==e.maxDistance&&!fe(e.maxDistance))throw new TypeError('"maxDistance" must be of type Number. Received type '+typeof e.maxDistance);if(void 0!==e.minDistance&&!fe(e.minDistance))throw new TypeError('"minDistance" must be of type Number. Received type '+typeof e.minDistance);const t=new Je(He.GEO_NEAR,[e],this.fieldName);return this.and(t)}geoWithin(e){if(!(e.geometry instanceof Ve||e.geometry instanceof qe))throw new TypeError('"geometry" must be of type Polygon or MultiPolygon. Received type '+typeof e.geometry);const t=new Je(He.GEO_WITHIN,[e],this.fieldName);return this.and(t)}geoIntersects(e){if(!(e.geometry instanceof $e||e.geometry instanceof Be||e.geometry instanceof qe||e.geometry instanceof We||e.geometry instanceof Ge||e.geometry instanceof Ve))throw new TypeError('"geometry" must be of type Point, LineString, Polygon, MultiPoint, MultiLineString or MultiPolygon. Received type '+typeof e.geometry);const t=new Je(He.GEO_INTERSECTS,[e],this.fieldName);return this.and(t)}}function Ye(e){return e&&e instanceof Je&&e._internalType===Z}function ze(e){return Ye(e)}const Xe={};for(const e in He)Xe[e]="$"+e;for(const e in ye)Xe[e]="$"+e;for(const e in ce)Xe[e]="$"+e;function Ze(e){return Xe[e]||"$"+e}function Ke(e){return function e(t,r){if(!we(t)){if(_e(t))return t;if(me(t))return{$regex:t.source,$options:t.flags};if(pe(t))return t.map(t=>{if(r.indexOf(t)>-1)throw new Error("Cannot convert circular structure to JSON");return e(t,[...r,t])});if(ue(t)){const n=Object.assign({},t);for(const t in n){if(r.indexOf(n[t])>-1)throw new Error("Cannot convert circular structure to JSON");n[t]=e(n[t],[...r,n[t]])}return n}return t}switch(t._internalType){case ee:return t.toJSON();case oe:case ae:return t.parse();default:return t.toJSON?t.toJSON():t}}(e,[e])}function et(e){return function e(t,r,n,s){const i=Object.assign({},t);for(const o in t){if(/^\$/.test(o))continue;const a=t[o];if(a&&(ue(a)&&!r(a))){if(s.indexOf(a)>-1)throw new Error("Cannot convert circular structure to JSON");const t=e(a,r,[...n,o],[...s,a]);i[o]=t;let c=!1;for(const e in t)/^\$/.test(e)?c=!0:(i[`${o}.${e}`]=t[e],delete i[o][e]);c||delete i[o]}}return i}(e,rt,[],[e])}function tt(e,t,r){t[r]||delete e[r];for(const n in t)e[n]?pe(e[n])?e[n].push(t[n]):ue(e[n])?ue(t[n])?Object.assign(e[n],t[n]):(console.warn(`unmergable condition, query is object but condition is ${he(t)}, can only overwrite`,t,r),e[n]=t[n]):(console.warn(`to-merge query is of type ${he(e)}, can only overwrite`,e,t,r),e[n]=t[n]):e[n]=t[n]}function rt(e){return we(e)||_e(e)||me(e)}function nt(e){return Ke(e)}Xe[He.NEQ]="$ne",Xe[ce.REMOVE]="$unset",Xe[ce.SHIFT]="$pop",Xe[ce.UNSHIFT]="$push";class st{static encode(e){return(new st).encodeUpdate(e)}encodeUpdate(e){return de(e)?this.encodeUpdateCommand(e):"object"===he(e)?this.encodeUpdateObject(e):e}encodeUpdateCommand(e){if(e.fieldName===z)throw new Error("Cannot encode a comparison command with unset field name");switch(e.operator){case ce.PUSH:case ce.PULL:case ce.PULL_ALL:case ce.POP:case ce.SHIFT:case ce.UNSHIFT:case ce.ADD_TO_SET:return this.encodeArrayUpdateCommand(e);default:return this.encodeFieldUpdateCommand(e)}}encodeFieldUpdateCommand(e){const t=Ze(e.operator);switch(e.operator){case ce.REMOVE:return{[t]:{[e.fieldName]:""}};default:return{[t]:{[e.fieldName]:e.operands[0]}}}}encodeArrayUpdateCommand(e){const t=Ze(e.operator);switch(e.operator){case ce.PUSH:{let r;return r=pe(e.operands)?{$each:e.operands.map(nt)}:e.operands,{[t]:{[e.fieldName]:r}}}case ce.UNSHIFT:{const r={$each:e.operands.map(nt),$position:0};return{[t]:{[e.fieldName]:r}}}case ce.POP:return{[t]:{[e.fieldName]:1}};case ce.SHIFT:return{[t]:{[e.fieldName]:-1}};default:return{[t]:{[e.fieldName]:nt(e.operands)}}}}encodeUpdateObject(e){const t=et(e);for(const e in t){if(/^\$/.test(e))continue;let r=t[e];if(de(r)){t[e]=r._setFieldName(e);tt(t,this.encodeUpdateCommand(t[e]),e)}else{t[e]=r=nt(r);const n=new le(ce.SET,[r],e);tt(t,this.encodeUpdateCommand(n),e)}}return t}}function it(e){if(!k(e))return e;const t={};return Object.keys(e).forEach(r=>{"$"===r.charAt(0)?t[r]=e[r]:(t.$set=t.$set||{},t.$set[r]=e[r])}),t}function ot(e){return{id:e.result&&e.result.insertedId}}function at(e){return{affectedDocs:e.affectedDocs,deleted:e.affectedDocs}}function ct(e){return{affectedDocs:e.affectedDocs,updated:e.result.nModified,upserted:e.result.upserted}}function lt(e){let t=null;return e.result&&Array.isArray(e.result.upserted)&&1===e.result.upserted.length&&(t=e.result.upserted[0]._id),{affectedDocs:e.affectedDocs,updated:e.affectedDocs,upsertedId:t}}function dt(e){return{affectedDocs:e.affectedDocs,data:e.result}}function ht(e){return{affectedDocs:e.affectedDocs,data:e.result}}function ut(e){return{updated:e.affectedDocs,doc:e.result.value}}class ft{constructor(e,t){this._db=e,this._coll=t}insertOne(e){return L(this._db.collection(this._coll).insertOne(e),ot)}deleteOne(e){return L(this._db.collection(this._coll).deleteOne(e),at)}replaceOne(e,t,r){return L(this._db.collection(this._coll).replaceOne(e,t,r),ct)}updateOne(e,t,r){return t=it(t),L(this._db.collection(this._coll).updateOne(e,t,r),lt)}findOne(e,t){return L(this._db.collection(this._coll).findOne(e,t),dt)}findOneAndUpdate(e,t,r){return t=it(t),L(this._db.collection(this._coll).findOneAndUpdate(e,t,r),ut,this._errorWrapper)}find(e,t){return L(this._db.collection(this._coll).find(e,t),ht)}}class pt{constructor(e,t,r,n={}){this.watch=A("watch"),this._db=e,this._coll=t,this.id=r,this.projection=n}create(e){return this.id&&(e._id=this.id),e=Ke(e),new ft(this._db,this._coll).insertOne(e)}set(e){if(!this.id)throw new I({code:"INVALID_PARAM",message:"docId不能为空"});if(!e||"object"!=typeof e)throw new I({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(P(e,"_id"))throw new I({code:"INVALID_PARAM",message:"不能更新_id的值"});let t=!1;const r=e=>{if("object"==typeof e)for(const n in e)e[n]instanceof le?t=!0:"object"==typeof e[n]&&r(e[n])};if(r(e),t)throw new I({code:"DATABASE_REQUEST_FAILED",message:"update operator complicit"});return new ft(this._db,this._coll).replaceOne({_id:this.id},Ke(e),{upsert:!0}).then(e=>(e.upserted?e.upsertedId=this.id:e.upsertedId=null,delete e.upserted,Promise.resolve(e)))}update(e){if(!e||"object"!=typeof e)throw new I({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(P(e,"_id"))throw new I({code:"INVALID_PARAM",message:"不能更新_id的值"});return new ft(this._db,this._coll).updateOne({_id:this.id},st.encode(e))}updateAndReturn(e){if(!e||"object"!=typeof e)throw new I({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(P(e,"_id"))throw new I({code:"INVALID_PARAM",message:"不能更新_id的值"});return new ft(this._db,this._coll).findOneAndUpdate({_id:this.id},st.encode(e),{returnNewDocument:!0})}remove(){return new ft(this._db,this._coll).deleteOne({_id:this.id})}get(){return new ft(this._db,this._coll).findOne({_id:this.id},{projection:this.projection})}field(e){for(const t in e)e[t]?e[t]=1:e[t]=0;return new pt(this._db,this._coll,this.id,e)}}class _t{static encode(e){return(new mt).encodeQuery(e)}}class mt{encodeQuery(e,t){return rt(e)?Ee(e)?this.encodeLogicCommand(e):Ye(e)?this.encodeQueryCommand(e):{[t]:this.encodeQueryObject(e)}:ue(e)?this.encodeQueryObject(e):e}encodeRegExp(e){return{$regex:e.source,$options:e.flags}}encodeLogicCommand(e){switch(e.operator){case ye.NOR:case ye.AND:case ye.OR:return{[Ze(e.operator)]:e.operands.map(t=>this.encodeQuery(t,e.fieldName))};case ye.NOT:{const t=Ze(e.operator),r=e.operands[0];if(me(r))return{[e.fieldName]:{[t]:this.encodeRegExp(r)}};{const n=this.encodeQuery(r)[e.fieldName];return{[e.fieldName]:{[t]:n}}}}default:{const t=Ze(e.operator);if(1===e.operands.length){return{[t]:this.encodeQuery(e.operands[0])}}return{[t]:e.operands.map(this.encodeQuery.bind(this))}}}}encodeQueryCommand(e){return ze(e),this.encodeComparisonCommand(e)}encodeComparisonCommand(e){if(e.fieldName===z)throw new Error("Cannot encode a comparison command with unset field name");const t=Ze(e.operator);switch(e.operator){case He.EQ:case He.NEQ:case He.LT:case He.LTE:case He.GT:case He.GTE:case He.ELEM_MATCH:case He.EXISTS:case He.SIZE:case He.MOD:return{[e.fieldName]:{[t]:nt(e.operands[0])}};case He.IN:case He.NIN:case He.ALL:return{[e.fieldName]:{[t]:nt(e.operands)}};case He.GEO_NEAR:{const t=e.operands[0];return{[e.fieldName]:{$nearSphere:{$geometry:t.geometry.toJSON(),$maxDistance:t.maxDistance,$minDistance:t.minDistance}}}}case He.GEO_WITHIN:{const t=e.operands[0];return{[e.fieldName]:{$geoWithin:{$geometry:t.geometry.toJSON()}}}}case He.GEO_INTERSECTS:{const t=e.operands[0];return{[e.fieldName]:{$geoIntersects:{$geometry:t.geometry.toJSON()}}}}default:return{[e.fieldName]:{[t]:nt(e.operands[0])}}}}encodeQueryObject(e){const t=et(e);for(const e in t){const r=t[e];if(Ee(r)){t[e]=r._setFieldName(e);const n=this.encodeLogicCommand(t[e]);this.mergeConditionAfterEncode(t,n,e)}else if(ze(r)){t[e]=r._setFieldName(e);const n=this.encodeComparisonCommand(t[e]);this.mergeConditionAfterEncode(t,n,e)}else rt(r)&&(t[e]=nt(r))}return t}mergeConditionAfterEncode(e,t,r){t[r]||delete e[r];for(const n in t)e[n]?pe(e[n])?e[n]=e[n].concat(t[n]):ue(e[n])?ue(t[n])?Object.assign(e,t):(console.warn(`unmergable condition, query is object but condition is ${he(t)}, can only overwrite`,t,r),e[n]=t[n]):(console.warn(`to-merge query is of type ${he(e)}, can only overwrite`,e,t,r),e[n]=t[n]):e[n]=t[n]}}const wt={asc:1,desc:-1};class yt{constructor(e,t,r,n,s){this._db=e,this._coll=t,this._fieldFilters=r,this._fieldOrders=n||[],this._queryOptions=s||{}}get(){const e={};return this._fieldOrders.length&&(e.sort={},this._fieldOrders.forEach(t=>{Object.assign(e.sort,t)})),this._queryOptions.skip&&(e.skip=this._queryOptions.skip),this._queryOptions.limit?e.limit=this._queryOptions.limit<1e3?this._queryOptions.limit:1e3:e.limit=100,this._queryOptions.projection&&(e.projection=this._queryOptions.projection),new ft(this._db,this._coll).find(this._fieldFilters||{},e)}update(e){if(!e||"object"!=typeof e)throw new I({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(P(e,"_id"))throw new I({code:"INVALID_PARAM",message:"不能更新_id的值"});return new ft(this._db,this._coll).updateMany(this._fieldFilters||{},st.encode(e))}updateAndReturn(e){if(!e||"object"!=typeof e)throw new I({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(P(e,"_id"))throw new I({code:"INVALID_PARAM",message:"不能更新_id的值"});return new ft(this._db,this._coll).findOneAndUpdate(this._fieldFilters||{},st.encode(e),{returnNewDocument:!0})}remove(e){return Object.keys(this._queryOptions).length>0&&console.warn("`offset`, `limit` and `projection` are not supported in remove() operation"),this._fieldOrders.length>0&&console.warn("`orderBy` is not supported in remove() operation"),new ft(this._db,this._coll).deleteMany(this._fieldFilters||{})}count(){return new ft(this._db,this._coll).count(this._fieldFilters||{})}where(e){if(!k(e))throw Error(ge.QueryParamTypeError);const t=Object.keys(e),r=t.some(t=>void 0!==e[t]);if(t.length&&!r)throw Error(ge.QueryParamValueError);return new yt(this._db,this._coll,_t.encode(e),this._fieldOrders,this._queryOptions)}orderBy(e,t){Fe.isFieldPath(e),Fe.isFieldOrder(t);const r={};r[e]=wt[t];const n=this._fieldOrders.concat([r]);return new yt(this._db,this._coll,this._fieldFilters,n,this._queryOptions)}limit(e){Fe.isInteger("limit",e);const t={...this._queryOptions};return t.limit=e,new yt(this._db,this._coll,this._fieldFilters,this._fieldOrders,t)}skip(e){Fe.isInteger("offset",e);const t={...this._queryOptions};return t.skip=e,new yt(this._db,this._coll,this._fieldFilters,this._fieldOrders,t)}field(e){for(const t in e)e[t]?"object"!=typeof e[t]&&(e[t]=1):e[t]=0;const t={...this._queryOptions};return t.projection=e,new yt(this._db,this._coll,this._fieldFilters,this._fieldOrders,t)}watch(e){throw Error(ge.WatchError)}}class gt extends yt{get name(){return this._coll}doc(e){if("string"!=typeof e&&"number"!=typeof e)throw new Error("docId必须为字符串或数字");return new pt(this._db,this._coll,e)}add(e){const t=new pt(this._db,this._coll,void 0);return Array.isArray(e)?t.createMany(e):t.create(e)}}class bt{constructor(e,t){this._transaction=e,this.config=t}collection(e){if(!e)throw new Error("Collection name is required");return new gt(this._transaction,e)}commit(){return this._transaction.commit()}rollback(){return this._transaction.rollback()}}function Et(e){if(!k(e))return e;const t={};return Object.keys(e).forEach(r=>{"$"===r.charAt(0)?t[r]=e[r]:(t.$set=t.$set||{},t.$set[r]=e[r])}),t}function vt(e){return{id:e.result&&e.result.insertedId}}function Ot(e){const t=[];return Object.keys(e.result).sort().forEach(r=>{t.push(e.result[r])}),{inserted:e.affectedDocs,ids:t}}function St(e){return{affectedDocs:e.affectedDocs,deleted:e.affectedDocs}}function Nt(e){return{affectedDocs:e.affectedDocs,deleted:e.affectedDocs}}function It(e){return{affectedDocs:e.affectedDocs,updated:e.result.nModified,upserted:e.result.upserted}}function Tt(e){let t=null;return e.result&&Array.isArray(e.result.upserted)&&1===e.result.upserted.length&&(t=e.result.upserted[0]._id),{affectedDocs:e.affectedDocs,updated:e.affectedDocs,upsertedId:t}}function At(e){return{affectedDocs:e.affectedDocs,updated:e.affectedDocs}}function Lt(e){return{updated:e.affectedDocs,doc:e.result.value}}function xt(e){const t=[];return e.result&&t.push(e.result),{affectedDocs:e.affectedDocs,data:t}}function Ct(e){return{affectedDocs:e.affectedDocs,data:e.result}}function Pt(e){return{affectedDocs:e.affectedDocs,total:e.result}}function kt(e){return{affectedDocs:e.affectedDocs,data:e.result}}class Dt{constructor(e,t){this._coll=t,this._errorWrapper=U({collName:t})}get _db(){return global.uniCloud.$scope.db}_mergeOptions(e){return Object.assign({maxTimeMS:5e3},e)}insertOne(e){return L(this._db.collection(this._coll).insertOne(e),vt,this._errorWrapper)}insertMany(e){return L(this._db.collection(this._coll).insertMany(e),Ot,this._errorWrapper)}deleteOne(e){return L(this._db.collection(this._coll).deleteOne(e),St,this._errorWrapper)}deleteMany(e){return L(this._db.collection(this._coll).deleteMany(e),Nt,this._errorWrapper)}replaceOne(e,t,r){return L(this._db.collection(this._coll).replaceOne(e,t,this._mergeOptions(r)),It,this._errorWrapper)}updateOne(e,t,r){return t=Et(t),L(this._db.collection(this._coll).updateOne(e,t,r),Tt,this._errorWrapper)}updateMany(e,t,r){return t=Et(t),L(this._db.collection(this._coll).updateMany(e,t,r),At,this._errorWrapper)}findOneAndUpdate(e,t,r){return t=Et(t),L(this._db.collection(this._coll).findOneAndUpdate(e,t,this._mergeOptions(r)),Lt,this._errorWrapper)}findOne(e,t){return L(this._db.collection(this._coll).findOne(e,this._mergeOptions(t)),xt,this._errorWrapper)}find(e,t){return L(this._db.collection(this._coll).find(e,this._mergeOptions(t)),Ct,this._errorWrapper)}count(e,t){return L(this._db.collection(this._coll).count(e,this._mergeOptions(t)),Pt,this._errorWrapper)}aggregate(e,t){return L(this._db.collection(this._coll).aggregate(e,this._mergeOptions(t)),kt,this._errorWrapper)}}class Rt{constructor(e,t){this._stages=[],e&&t&&(this._db=e,this._coll=t)}end(){if(!this._coll||!this._db)throw new Error("Aggregation pipeline cannot send request");return new Dt(this._db,this._coll).aggregate(this.done())}unwrap(){return this._stages}done(){return this._stages.map(({stageKey:e,stageValue:t})=>({[e]:JSON.parse(t)}))}_pipe(e,t){return this._stages.push({stageKey:"$"+e,stageValue:JSON.stringify(t)}),this}addFields(e){return this._pipe("addFields",e)}bucket(e){return this._pipe("bucket",e)}bucketAuto(e){return this._pipe("bucketAuto",e)}count(e){return this._pipe("count",e)}geoNear(e){return e.query&&(e.query=_t.encode(e.query)),this._pipe("geoNear",e)}group(e){return this._pipe("group",e)}limit(e){return this._pipe("limit",e)}match(e){return this._pipe("match",_t.encode(e))}project(e){return this._pipe("project",e)}lookup(e){return this._pipe("lookup",e)}replaceRoot(e){return this._pipe("replaceRoot",e)}sample(e){return this._pipe("sample",e)}skip(e){return this._pipe("skip",e)}sort(e){return this._pipe("sort",e)}sortByCount(e){return this._pipe("sortByCount",e)}unwind(e){return this._pipe("unwind",e)}}const Mt={eq:e=>new Je(He.EQ,[e]),neq:e=>new Je(He.NEQ,[e]),lt:e=>new Je(He.LT,[e]),lte:e=>new Je(He.LTE,[e]),gt:e=>new Je(He.GT,[e]),gte:e=>new Je(He.GTE,[e]),in:e=>new Je(He.IN,e),nin:e=>new Je(He.NIN,e),all:e=>new Je(He.ALL,e),elemMatch:e=>new Je(He.ELEM_MATCH,[e]),exists:e=>new Je(He.EXISTS,[e]),size:e=>new Je(He.SIZE,[e]),mod:e=>new Je(He.MOD,[e]),geoNear:e=>new Je(He.GEO_NEAR,[e]),geoWithin:e=>new Je(He.GEO_WITHIN,[e]),geoIntersects:e=>new Je(He.GEO_INTERSECTS,[e]),and(...e){const t=pe(arguments[0])?arguments[0]:Array.from(arguments);return new be(ye.AND,t)},nor(...e){const t=pe(arguments[0])?arguments[0]:Array.from(arguments);return new be(ye.NOR,t)},or(...e){const t=pe(arguments[0])?arguments[0]:Array.from(arguments);return new be(ye.OR,t)},not(...e){const t=pe(arguments[0])?arguments[0]:Array.from(arguments);return new be(ye.NOT,t)},set:e=>new le(ce.SET,[e]),remove:()=>new le(ce.REMOVE,[]),inc:e=>new le(ce.INC,[e]),mul:e=>new le(ce.MUL,[e]),push(...e){let t;if(ue(e[0])&&e[0].hasOwnProperty("each")){const r=e[0];t={$each:r.each,$position:r.position,$sort:r.sort,$slice:r.slice}}else t=pe(e[0])?e[0]:Array.from(e);return new le(ce.PUSH,t)},pull:e=>new le(ce.PULL,e),pullAll:e=>new le(ce.PULL_ALL,e),pop:()=>new le(ce.POP,[]),shift:()=>new le(ce.SHIFT,[]),unshift(...e){const t=pe(arguments[0])?arguments[0]:Array.from(arguments);return new le(ce.UNSHIFT,t)},addToSet:e=>new le(ce.ADD_TO_SET,e),rename:e=>new le(ce.RENAME,[e]),bit:e=>new le(ce.BIT,[e]),max:e=>new le(ce.MAX,[e]),min:e=>new le(ce.MIN,[e]),expr:e=>({$expr:e}),jsonSchema:e=>({$jsonSchema:e}),text:e=>"string"===he(e)?{$search:e.search}:{$search:e.search,$language:e.language,$caseSensitive:e.caseSensitive,$diacriticSensitive:e.diacriticSensitive},aggregate:{pipeline:()=>new Rt,abs:e=>new jt("abs",e),add:e=>new jt("add",e),ceil:e=>new jt("ceil",e),divide:e=>new jt("divide",e),exp:e=>new jt("exp",e),floor:e=>new jt("floor",e),ln:e=>new jt("ln",e),log:e=>new jt("log",e),log10:e=>new jt("log10",e),mod:e=>new jt("mod",e),multiply:e=>new jt("multiply",e),pow:e=>new jt("pow",e),sqrt:e=>new jt("sqrt",e),subtract:e=>new jt("subtract",e),trunc:e=>new jt("trunc",e),arrayElemAt:e=>new jt("arrayElemAt",e),arrayToObject:e=>new jt("arrayToObject",e),concatArrays:e=>new jt("concatArrays",e),filter:e=>new jt("filter",e),in:e=>new jt("in",e),indexOfArray:e=>new jt("indexOfArray",e),isArray:e=>new jt("isArray",e),map:e=>new jt("map",e),range:e=>new jt("range",e),reduce:e=>new jt("reduce",e),reverseArray:e=>new jt("reverseArray",e),size:e=>new jt("size",e),slice:e=>new jt("slice",e),zip:e=>new jt("zip",e),and:e=>new jt("and",e),not:e=>new jt("not",e),or:e=>new jt("or",e),cmp:e=>new jt("cmp",e),eq:e=>new jt("eq",e),gt:e=>new jt("gt",e),gte:e=>new jt("gte",e),lt:e=>new jt("lt",e),lte:e=>new jt("lte",e),neq:e=>new jt("ne",e),cond:e=>new jt("cond",e),ifNull:e=>new jt("ifNull",e),switch:e=>new jt("switch",e),dateFromParts:e=>new jt("dateFromParts",e),dateFromString:e=>new jt("dateFromString",e),dayOfMonth:e=>new jt("dayOfMonth",e),dayOfWeek:e=>new jt("dayOfWeek",e),dayOfYear:e=>new jt("dayOfYear",e),isoDayOfWeek:e=>new jt("isoDayOfWeek",e),isoWeek:e=>new jt("isoWeek",e),isoWeekYear:e=>new jt("isoWeekYear",e),millisecond:e=>new jt("millisecond",e),minute:e=>new jt("minute",e),month:e=>new jt("month",e),second:e=>new jt("second",e),hour:e=>new jt("hour",e),week:e=>new jt("week",e),year:e=>new jt("year",e),literal:e=>new jt("literal",e),mergeObjects:e=>new jt("mergeObjects",e),objectToArray:e=>new jt("objectToArray",e),allElementsTrue:e=>new jt("allElementsTrue",e),anyElementTrue:e=>new jt("anyElementTrue",e),setDifference:e=>new jt("setDifference",e),setEquals:e=>new jt("setEquals",e),setIntersection:e=>new jt("setIntersection",e),setIsSubset:e=>new jt("setIsSubset",e),setUnion:e=>new jt("setUnion",e),concat:e=>new jt("concat",e),dateToString:e=>new jt("dateToString",e),indexOfBytes:e=>new jt("indexOfBytes",e),indexOfCP:e=>new jt("indexOfCP",e),split:e=>new jt("split",e),strLenBytes:e=>new jt("strLenBytes",e),strLenCP:e=>new jt("strLenCP",e),strcasecmp:e=>new jt("strcasecmp",e),substr:e=>new jt("substr",e),substrBytes:e=>new jt("substrBytes",e),substrCP:e=>new jt("substrCP",e),toLower:e=>new jt("toLower",e),toUpper:e=>new jt("toUpper",e),meta:e=>new jt("meta",e),addToSet:e=>new jt("addToSet",e),avg:e=>new jt("avg",e),first:e=>new jt("first",e),last:e=>new jt("last",e),max:e=>new jt("max",e),min:e=>new jt("min",e),push:e=>new jt("push",e),stdDevPop:e=>new jt("stdDevPop",e),stdDevSamp:e=>new jt("stdDevSamp",e),sum:e=>new jt("sum",e),let:e=>new jt("let",e)},project:{slice:e=>new Ut("slice",e),elemMatch:e=>new Ut("elemMatch",e)}};class jt{constructor(e,t){this["$"+e]=t}}class Ut{constructor(e,t){this["$"+e]=t}}class Ft{constructor(e,t,r,n={}){this.watch=A("watch"),this._db=e,this._coll=t,this.id=r,this.projection=n}create(e){return this.id&&(e._id=this.id),e=Ke(e),new Dt(this._db,this._coll).insertOne(e)}createMany(e){return e=Ke(e),new Dt(this._db,this._coll).insertMany(e)}set(e){if(!this.id)throw new I({code:"INVALID_PARAM",message:"docId不能为空"});if(!e||"object"!=typeof e)throw new I({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(P(e,"_id"))throw new I({code:"INVALID_PARAM",message:"不能更新_id的值"});let t=!1;const r=e=>{if("object"==typeof e)for(const n in e)e[n]instanceof le?t=!0:"object"==typeof e[n]&&r(e[n])};if(r(e),t)throw new I({code:"DATABASE_REQUEST_FAILED",message:"update operator complicit"});return new Dt(this._db,this._coll).replaceOne({_id:this.id},Ke(e),{upsert:!0}).then(e=>(e.upserted?e.upsertedId=this.id:e.upsertedId=null,delete e.upserted,Promise.resolve(e)))}update(e){if(!e||"object"!=typeof e)throw new I({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(P(e,"_id"))throw new I({code:"INVALID_PARAM",message:"不能更新_id的值"});return new Dt(this._db,this._coll).updateOne({_id:this.id},st.encode(e))}updateAndReturn(e){if(!e||"object"!=typeof e)throw new I({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(P(e,"_id"))throw new I({code:"INVALID_PARAM",message:"不能更新_id的值"});return new Dt(this._db,this._coll).findOneAndUpdate({_id:this.id},st.encode(e),{returnNewDocument:!0})}remove(){return new Dt(this._db,this._coll).deleteOne({_id:this.id})}get(){return new Dt(this._db,this._coll).findOne({_id:this.id},{projection:this.projection})}field(e){for(const t in e)e[t]?e[t]=1:e[t]=0;return new Ft(this._db,this._coll,this.id,e)}}const $t={asc:1,desc:-1};class Bt{constructor(e,t,r,n,s){this._db=e,this._coll=t,this._fieldFilters=r,this._fieldOrders=n||[],this._queryOptions=s||{}}get(){const e={};return this._fieldOrders.length&&(e.sort={},this._fieldOrders.forEach(t=>{Object.assign(e.sort,t)})),this._queryOptions.skip&&(e.skip=this._queryOptions.skip),this._queryOptions.limit?e.limit=this._queryOptions.limit<1e3?this._queryOptions.limit:1e3:e.limit=100,this._queryOptions.projection&&(e.projection=this._queryOptions.projection),new Dt(this._db,this._coll).find(this._fieldFilters||{},e)}update(e){if(!e||"object"!=typeof e)throw new I({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(P(e,"_id"))throw new I({code:"INVALID_PARAM",message:"不能更新_id的值"});return new Dt(this._db,this._coll).updateMany(this._fieldFilters||{},st.encode(e))}updateAndReturn(e){if(!e||"object"!=typeof e)throw new I({code:"INVALID_PARAM",message:"参数必需是非空对象"});if(P(e,"_id"))throw new I({code:"INVALID_PARAM",message:"不能更新_id的值"});return new Dt(this._db,this._coll).findOneAndUpdate(this._fieldFilters||{},st.encode(e),{returnNewDocument:!0})}remove(e){return Object.keys(this._queryOptions).length>0&&console.warn("`offset`, `limit` and `projection` are not supported in remove() operation"),this._fieldOrders.length>0&&console.warn("`orderBy` is not supported in remove() operation"),new Dt(this._db,this._coll).deleteMany(this._fieldFilters||{})}count(){return new Dt(this._db,this._coll).count(this._fieldFilters||{})}where(e){if(!k(e))throw Error(ge.QueryParamTypeError);const t=Object.keys(e),r=t.some(t=>void 0!==e[t]);if(t.length&&!r)throw Error(ge.QueryParamValueError);return new Bt(this._db,this._coll,_t.encode(e),this._fieldOrders,this._queryOptions)}orderBy(e,t){Fe.isFieldPath(e),Fe.isFieldOrder(t);const r={};r[e]=$t[t];const n=this._fieldOrders.concat([r]);return new Bt(this._db,this._coll,this._fieldFilters,n,this._queryOptions)}limit(e){Fe.isInteger("limit",e);const t={...this._queryOptions};return t.limit=e,new Bt(this._db,this._coll,this._fieldFilters,this._fieldOrders,t)}skip(e){Fe.isInteger("offset",e);const t={...this._queryOptions};return t.skip=e,new Bt(this._db,this._coll,this._fieldFilters,this._fieldOrders,t)}field(e){for(const t in e)e[t]?"object"!=typeof e[t]&&(e[t]=1):e[t]=0;const t={...this._queryOptions};return t.projection=e,new Bt(this._db,this._coll,this._fieldFilters,this._fieldOrders,t)}watch(e){throw Error(ge.WatchError)}}class qt extends Bt{get name(){return this._coll}doc(e){if("string"!=typeof e&&"number"!=typeof e)throw new Error("docId必须为字符串或数字");return new Ft(this._db,this._coll,e)}add(e){const t=new Ft(this._db,this._coll,void 0);return Array.isArray(e)?t.createMany(e):t.create(e)}aggregate(){return new Rt(this._db,this._coll)}}const Wt=A("createCollection"),Gt=A("serverDate"),Vt=A("runTransaction");class Ht{constructor(e,t){this._db=e,this.config=t,this.Geo=Qe,this.command=Mt}get _latestDB(){return global.uniCloud.$scope.db}get serverDate(){return Gt()}get RegExp(){return class{constructor({regex:e,options:t}){return new RegExp(e,t)}}}collection(e){if(!e)throw new Error("Collection name is required");return new qt(this._db,e)}createCollection(e){return Wt(e)}async startTransaction(){const e=await(this._latestDB||this._db).startTransaction();return new bt(e,this.config)}runTransaction(){return Vt()}}function Qt(e){e.httpProxyForEip=function(e){const t=["get","postForm","postJson","post"],r={};for(let n=0;n<t.length;n++){const s=t[n],i=e[s].bind(e);r[s]=async function(...e){const t=await i(...e);let r,n;return"string"==typeof t?(r=t,n=JSON.parse(r)):(n=t,r=JSON.stringify(n)),Object.defineProperty(n,"toString",{get:()=>function(){return r}}),n}}return r}(e.$context.httpProxyClient)}const Jt=Array.isArray,Yt=["{","}"];const zt=/^(?:\d)+/,Xt=/^(?:\w)+/;const Zt=Object.prototype.hasOwnProperty,Kt=(e,t)=>Zt.call(e,t),er=new class{constructor(){this._caches=Object.create(null)}interpolate(e,t,r=Yt){if(!t)return[e];let n=this._caches[e];return n||(n=function(e,[t,r]){const n=[];let s=0,i="";for(;s<e.length;){let o=e[s++];if(o===t){i&&n.push({type:"text",value:i}),i="";let t="";for(o=e[s++];void 0!==o&&o!==r;)t+=o,o=e[s++];const a=o===r,c=zt.test(t)?"list":a&&Xt.test(t)?"named":"unknown";n.push({value:t,type:c})}else i+=o}return i&&n.push({type:"text",value:i}),n}(e,r),this._caches[e]=n),function(e,t){const r=[];let n=0;const s=Jt(t)?"list":(i=t,null!==i&&"object"==typeof i?"named":"unknown");var i;if("unknown"===s)return r;for(;n<e.length;){const i=e[n];switch(i.type){case"text":r.push(i.value);break;case"list":r.push(t[parseInt(i.value,10)]);break;case"named":"named"===s&&r.push(t[i.value])}n++}return r}(n,t)}};function tr(e,t){if(!e)return;if(e=e.trim().replace(/_/g,"-"),t&&t[e])return e;if(0===(e=e.toLowerCase()).indexOf("zh"))return e.indexOf("-hans")>-1?"zh-Hans":e.indexOf("-hant")>-1?"zh-Hant":(r=e,["-tw","-hk","-mo","-cht"].find(e=>-1!==r.indexOf(e))?"zh-Hant":"zh-Hans");var r;const n=function(e,t){return t.find(t=>0===e.indexOf(t))}(e,["en","fr","es"]);return n||void 0}class rr{constructor({locale:e,fallbackLocale:t,messages:r,watcher:n,formater:s}){this.locale="en",this.fallbackLocale="en",this.message={},this.messages={},this.watchers=[],t&&(this.fallbackLocale=t),this.formater=s||er,this.messages=r||{},this.setLocale(e||"en"),n&&this.watchLocale(n)}setLocale(e){const t=this.locale;this.locale=tr(e,this.messages)||this.fallbackLocale,this.messages[this.locale]||(this.messages[this.locale]={}),this.message=this.messages[this.locale],t!==this.locale&&this.watchers.forEach(e=>{e(this.locale,t)})}getLocale(){return this.locale}watchLocale(e){const t=this.watchers.push(e)-1;return()=>{this.watchers.splice(t,1)}}add(e,t,r=!0){const n=this.messages[e];n?r?Object.assign(n,t):Object.keys(t).forEach(e=>{Kt(n,e)||(n[e]=t[e])}):this.messages[e]=t}f(e,t,r){return this.formater.interpolate(e,t,r).join("")}t(e,t,r){let n=this.message;return"string"==typeof t?(t=tr(t,this.messages))&&(n=this.messages[t]):r=t,Kt(n,e)?this.formater.interpolate(n[e],r).join(""):(console.warn(`Cannot translate the value of keypath ${e}. Use the value of keypath as default.`),e)}}function nr({locale:e,fallbackLocale:t,messages:r={}}){const n=new rr({locale:e,fallbackLocale:t,messages:{...r}});return r[n.locale]||n.setLocale(t),n}function sr(e){const t=this;return new Proxy({},{get(r,n){switch(n){case"toString":return"[object UniCloudObject]";case"toJSON":return{}}return async function(...r){const s=await t.callFunction({name:e,data:{method:n,params:r}}),{errCode:i,errMsg:o,errSubject:a}=s.result||{};if(i){const e=new I({code:i,message:o,subject:a});throw e.detail=s.result,e.requestId=s.requestId,e}return s.result}}})}let ir;global.__unicloud_store__?ir=global.__unicloud_store__:global.__unicloud_store__=ir={requestInfo:{}};var or=ir;function ar(){const e=or.requestInfo,t=[];for(const r in e){const n=e[r];if(n.cloudInfo){t.push(n.cloudInfo);continue}const{context:s}=n,i=$(s);i.requestId=r,n.cloudInfo=i,t.push(i)}return t}function cr(){const e=or.requestInfo,t=[];for(const r in e){const n=e[r];if(n.clientInfo){t.push(n.clientInfo);continue}const{event:s,context:i}=n,o={...F(i),requestId:r};if("cloudobject"===i.FUNCTION_TYPE){const{methodName:e,params:t}=B(s,i);o.cloudObjMethodName=e,o.cloudObjParams=t}n.clientInfo=o,t.push(o)}return t}function lr(){return Object.keys(or.requestInfo)}function dr(e){const{event:t,context:r}=or.requestInfo[e]||{};if(t&&r&&"http"===r.SOURCE)return t}class hr{constructor({appId:e,pushClientId:t,seqId:r}={}){if(this._appId=e,this._pushClientId=t,this._seqId=r,this._messageQueue=[],!e||!t||!r)throw new Error("Invalid sse channel");this._pushManager=uniCloud.getPushManager({appId:e}),this._messageId=0,this._send=(e,n)=>this._pushManager.sendMessage({push_clientid:t,settings:{strategy:{default:3},ttl:-1},payload:{channel:"UNI_CLOUD_SSE",action:e,seqId:r,messageId:this._messageId++,message:n}})}write(e){const t=this._send("message",e);return this._messageQueue.push(t),t}async end(e){return await Promise.all(this._messageQueue),this._send("end",e)}}function ur(e){return new hr(e)}function fr(e,t,r){return e(r={path:t,exports:{},require:function(e,t){return pr(null==t&&r.path)}},r.exports),r.exports}function pr(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}var _r={BINARY_TYPES:["nodebuffer","arraybuffer","fragments"],GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),EMPTY_BUFFER:Buffer.alloc(0),NOOP:()=>{}},mr="function"==typeof __webpack_require__?__non_webpack_require__:pr,wr=process.config&&process.config.variables||{},yr=!!process.env.PREBUILDS_ONLY,gr=process.versions.modules,br=!(!process.versions||!process.versions.electron)||!!process.env.ELECTRON_RUN_AS_NODE||"undefined"!=typeof window&&window.process&&"renderer"===window.process.type?"electron":"node",Er=N.default.arch(),vr=N.default.platform(),Or=process.env.LIBC||(function(e){return"linux"===e&&p.default.existsSync("/etc/alpine-release")}(vr)?"musl":"glibc"),Sr=process.env.ARM_VERSION||("arm64"===Er?"8":wr.arm_version)||"",Nr=(process.versions.uv||"").split(".")[0],Ir=Tr;function Tr(e){return mr(Tr.path(e))}function Ar(e){try{return p.default.readdirSync(e)}catch(e){return[]}}function Lr(e,t){var r=Ar(e).filter(t);return r[0]&&_.default.join(e,r[0])}function xr(e){return/\.node$/.test(e)}function Cr(e){var t=e.split("-");if(2===t.length){var r=t[0],n=t[1].split("+");if(r&&n.length&&n.every(Boolean))return{name:e,platform:r,architectures:n}}}function Pr(e,t){return function(r){return null!=r&&(r.platform===e&&r.architectures.includes(t))}}function kr(e,t){return e.architectures.length-t.architectures.length}function Dr(e){var t=e.split("."),r={file:e,specificity:0};if("node"===t.pop()){for(var n=0;n<t.length;n++){var s=t[n];if("node"===s||"electron"===s||"node-webkit"===s)r.runtime=s;else if("napi"===s)r.napi=!0;else if("abi"===s.slice(0,3))r.abi=s.slice(3);else if("uv"===s.slice(0,2))r.uv=s.slice(2);else if("armv"===s.slice(0,4))r.armv=s.slice(4);else{if("glibc"!==s&&"musl"!==s)continue;r.libc=s}r.specificity++}return r}}function Rr(e,t){return function(r){return null!=r&&(!(r.runtime!==e&&!function(e){return"node"===e.runtime&&e.napi}(r))&&(!(r.abi!==t&&!r.napi)&&((!r.uv||r.uv===Nr)&&((!r.armv||r.armv===Sr)&&(!r.libc||r.libc===Or)))))}}function Mr(e){return function(t,r){return t.runtime!==r.runtime?t.runtime===e?-1:1:t.abi!==r.abi?t.abi?-1:1:t.specificity!==r.specificity?t.specificity>r.specificity?-1:1:0}}Tr.path=function(e){e=_.default.resolve(e||".");try{var t=mr(_.default.join(e,"package.json")).name.toUpperCase().replace(/-/g,"_");process.env[t+"_PREBUILD"]&&(e=process.env[t+"_PREBUILD"])}catch(e){}if(!yr){var r=Lr(_.default.join(e,"build/Release"),xr);if(r)return r;var n=Lr(_.default.join(e,"build/Debug"),xr);if(n)return n}var s=a(e);if(s)return s;var i=a(_.default.dirname(process.execPath));if(i)return i;var o=["platform="+vr,"arch="+Er,"runtime="+br,"abi="+gr,"uv="+Nr,Sr?"armv="+Sr:"","libc="+Or,"node="+process.versions.node,process.versions.electron?"electron="+process.versions.electron:"","function"==typeof __webpack_require__?"webpack=true":""].filter(Boolean).join(" ");throw new Error("No native build was found for "+o+"\n    loaded from: "+e+"\n");function a(e){var t=Ar(_.default.join(e,"prebuilds")).map(Cr).filter(Pr(vr,Er)).sort(kr)[0];if(t){var r=_.default.join(e,"prebuilds",t.name),n=Ar(r).map(Dr).filter(Rr(br,gr)).sort(Mr(br))[0];return n?_.default.join(r,n.file):void 0}}},Tr.parseTags=Dr,Tr.matchTags=Rr,Tr.compareTags=Mr,Tr.parseTuple=Cr,Tr.matchTuple=Pr,Tr.compareTuples=kr;var jr={mask:(e,t,r,n,s)=>{for(var i=0;i<s;i++)r[n+i]=e[i]^t[3&i]},unmask:(e,t)=>{const r=e.length;for(var n=0;n<r;n++)e[n]^=t[3&n]}},Ur=fr((function(e){try{e.exports=Ir(__dirname)}catch(t){e.exports=jr}})),Fr=fr((function(e){const{EMPTY_BUFFER:t}=_r;function r(e,r){if(0===e.length)return t;if(1===e.length)return e[0];const n=Buffer.allocUnsafe(r);let s=0;for(let t=0;t<e.length;t++){const r=e[t];n.set(r,s),s+=r.length}return s<r?n.slice(0,s):n}function n(e,t,r,n,s){for(let i=0;i<s;i++)r[n+i]=e[i]^t[3&i]}function s(e,t){const r=e.length;for(let n=0;n<r;n++)e[n]^=t[3&n]}function i(e){return e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function o(e){if(o.readOnly=!0,Buffer.isBuffer(e))return e;let t;return e instanceof ArrayBuffer?t=Buffer.from(e):ArrayBuffer.isView(e)?t=Buffer.from(e.buffer,e.byteOffset,e.byteLength):(t=Buffer.from(e),o.readOnly=!1),t}try{const t=Ur,a=t.BufferUtil||t;e.exports={concat:r,mask(e,t,r,s,i){i<48?n(e,t,r,s,i):a.mask(e,t,r,s,i)},toArrayBuffer:i,toBuffer:o,unmask(e,t){e.length<32?s(e,t):a.unmask(e,t)}}}catch(t){e.exports={concat:r,mask:n,toArrayBuffer:i,toBuffer:o,unmask:s}}}));const $r=Symbol("kDone"),Br=Symbol("kRun");var qr=class{constructor(e){this[$r]=()=>{this.pending--,this[Br]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[Br]()}[Br](){if(this.pending!==this.concurrency&&this.jobs.length){const e=this.jobs.shift();this.pending++,e(this[$r])}}};const{kStatusCode:Wr,NOOP:Gr}=_r,Vr=Buffer.from([0,0,255,255]),Hr=Symbol("permessage-deflate"),Qr=Symbol("total-length"),Jr=Symbol("callback"),Yr=Symbol("buffers"),zr=Symbol("error");let Xr;var Zr=class{constructor(e,t,r){if(this._maxPayload=0|r,this._options=e||{},this._threshold=void 0!==this._options.threshold?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!Xr){const e=void 0!==this._options.concurrencyLimit?this._options.concurrencyLimit:10;Xr=new qr(e)}}static get extensionName(){return"permessage-deflate"}offer(){const e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){const e=this._deflate[Jr];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){const t=this._options,r=e.find(e=>!(!1===t.serverNoContextTakeover&&e.server_no_context_takeover||e.server_max_window_bits&&(!1===t.serverMaxWindowBits||"number"==typeof t.serverMaxWindowBits&&t.serverMaxWindowBits>e.server_max_window_bits)||"number"==typeof t.clientMaxWindowBits&&!e.client_max_window_bits));if(!r)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(r.server_no_context_takeover=!0),t.clientNoContextTakeover&&(r.client_no_context_takeover=!0),"number"==typeof t.serverMaxWindowBits&&(r.server_max_window_bits=t.serverMaxWindowBits),"number"==typeof t.clientMaxWindowBits?r.client_max_window_bits=t.clientMaxWindowBits:!0!==r.client_max_window_bits&&!1!==t.clientMaxWindowBits||delete r.client_max_window_bits,r}acceptAsClient(e){const t=e[0];if(!1===this._options.clientNoContextTakeover&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(t.client_max_window_bits){if(!1===this._options.clientMaxWindowBits||"number"==typeof this._options.clientMaxWindowBits&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"')}else"number"==typeof this._options.clientMaxWindowBits&&(t.client_max_window_bits=this._options.clientMaxWindowBits);return t}normalizeParams(e){return e.forEach(e=>{Object.keys(e).forEach(t=>{let r=e[t];if(r.length>1)throw new Error(`Parameter "${t}" must have only a single value`);if(r=r[0],"client_max_window_bits"===t){if(!0!==r){const e=+r;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${r}`);r=e}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${t}": ${r}`)}else if("server_max_window_bits"===t){const e=+r;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${r}`);r=e}else{if("client_no_context_takeover"!==t&&"server_no_context_takeover"!==t)throw new Error(`Unknown parameter "${t}"`);if(!0!==r)throw new TypeError(`Invalid value for parameter "${t}": ${r}`)}e[t]=r})}),e}decompress(e,t,r){Xr.add(n=>{this._decompress(e,t,(e,t)=>{n(),r(e,t)})})}compress(e,t,r){Xr.add(n=>{this._compress(e,t,(e,t)=>{n(),r(e,t)})})}_decompress(e,t,r){const n=this._isServer?"client":"server";if(!this._inflate){const e=n+"_max_window_bits",t="number"!=typeof this.params[e]?S.default.Z_DEFAULT_WINDOWBITS:this.params[e];this._inflate=S.default.createInflateRaw({...this._options.zlibInflateOptions,windowBits:t}),this._inflate[Hr]=this,this._inflate[Qr]=0,this._inflate[Yr]=[],this._inflate.on("error",tn),this._inflate.on("data",en)}this._inflate[Jr]=r,this._inflate.write(e),t&&this._inflate.write(Vr),this._inflate.flush(()=>{const e=this._inflate[zr];if(e)return this._inflate.close(),this._inflate=null,void r(e);const s=Fr.concat(this._inflate[Yr],this._inflate[Qr]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[Qr]=0,this._inflate[Yr]=[],t&&this.params[n+"_no_context_takeover"]&&this._inflate.reset()),r(null,s)})}_compress(e,t,r){const n=this._isServer?"server":"client";if(!this._deflate){const e=n+"_max_window_bits",t="number"!=typeof this.params[e]?S.default.Z_DEFAULT_WINDOWBITS:this.params[e];this._deflate=S.default.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:t}),this._deflate[Qr]=0,this._deflate[Yr]=[],this._deflate.on("error",Gr),this._deflate.on("data",Kr)}this._deflate[Jr]=r,this._deflate.write(e),this._deflate.flush(S.default.Z_SYNC_FLUSH,()=>{if(!this._deflate)return;let e=Fr.concat(this._deflate[Yr],this._deflate[Qr]);t&&(e=e.slice(0,e.length-4)),this._deflate[Jr]=null,this._deflate[Qr]=0,this._deflate[Yr]=[],t&&this.params[n+"_no_context_takeover"]&&this._deflate.reset(),r(null,e)})}};function Kr(e){this[Yr].push(e),this[Qr]+=e.length}function en(e){this[Qr]+=e.length,this[Hr]._maxPayload<1||this[Qr]<=this[Hr]._maxPayload?this[Yr].push(e):(this[zr]=new RangeError("Max payload size exceeded"),this[zr].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[zr][Wr]=1009,this.removeListener("data",en),this.reset())}function tn(e){this[Hr]._inflate=null,e[Wr]=1007,this[Jr](e)}var rn=function(e){const t=e.length;let r=0;for(;r<t;)if(0==(128&e[r]))r++;else if(192==(224&e[r])){if(r+1===t||128!=(192&e[r+1])||192==(254&e[r]))return!1;r+=2}else if(224==(240&e[r])){if(r+2>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||224===e[r]&&128==(224&e[r+1])||237===e[r]&&160==(224&e[r+1]))return!1;r+=3}else{if(240!=(248&e[r]))return!1;if(r+3>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||128!=(192&e[r+3])||240===e[r]&&128==(240&e[r+1])||244===e[r]&&e[r+1]>143||e[r]>244)return!1;r+=4}return!0},nn=fr((function(e){try{e.exports=Ir(__dirname)}catch(t){e.exports=rn}})),sn=fr((function(e){function t(e){return e>=1e3&&e<=1014&&1004!==e&&1005!==e&&1006!==e||e>=3e3&&e<=4999}function r(e){const t=e.length;let r=0;for(;r<t;)if(0==(128&e[r]))r++;else if(192==(224&e[r])){if(r+1===t||128!=(192&e[r+1])||192==(254&e[r]))return!1;r+=2}else if(224==(240&e[r])){if(r+2>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||224===e[r]&&128==(224&e[r+1])||237===e[r]&&160==(224&e[r+1]))return!1;r+=3}else{if(240!=(248&e[r]))return!1;if(r+3>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||128!=(192&e[r+3])||240===e[r]&&128==(240&e[r+1])||244===e[r]&&e[r+1]>143||e[r]>244)return!1;r+=4}return!0}try{let n=nn;"object"==typeof n&&(n=n.Validation.isValidUTF8),e.exports={isValidStatusCode:t,isValidUTF8:e=>e.length<150?r(e):n(e)}}catch(n){e.exports={isValidStatusCode:t,isValidUTF8:r}}}));const{Writable:on}=v.default,{BINARY_TYPES:an,EMPTY_BUFFER:cn,kStatusCode:ln,kWebSocket:dn}=_r,{concat:hn,toArrayBuffer:un,unmask:fn}=Fr,{isValidStatusCode:pn,isValidUTF8:_n}=sn;var mn=class extends on{constructor(e,t,r,n){super(),this._binaryType=e||an[0],this[dn]=void 0,this._extensions=t||{},this._isServer=!!r,this._maxPayload=0|n,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._state=0,this._loop=!1}_write(e,t,r){if(8===this._opcode&&0==this._state)return r();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(r)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){const t=this._buffers[0];return this._buffers[0]=t.slice(e),t.slice(0,e)}const t=Buffer.allocUnsafe(e);do{const r=this._buffers[0],n=t.length-e;e>=r.length?t.set(this._buffers.shift(),n):(t.set(new Uint8Array(r.buffer,r.byteOffset,e),n),this._buffers[0]=r.slice(e)),e-=r.length}while(e>0);return t}startLoop(e){let t;this._loop=!0;do{switch(this._state){case 0:t=this.getInfo();break;case 1:t=this.getPayloadLength16();break;case 2:t=this.getPayloadLength64();break;case 3:this.getMask();break;case 4:t=this.getData(e);break;default:return void(this._loop=!1)}}while(this._loop);e(t)}getInfo(){if(this._bufferedBytes<2)return void(this._loop=!1);const e=this.consume(2);if(0!=(48&e[0]))return this._loop=!1,wn(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3");const t=64==(64&e[0]);if(t&&!this._extensions[Zr.extensionName])return this._loop=!1,wn(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(this._fin=128==(128&e[0]),this._opcode=15&e[0],this._payloadLength=127&e[1],0===this._opcode){if(t)return this._loop=!1,wn(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(!this._fragmented)return this._loop=!1,wn(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE");this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented)return this._loop=!1,wn(RangeError,"invalid opcode "+this._opcode,!0,1002,"WS_ERR_INVALID_OPCODE");this._compressed=t}else{if(!(this._opcode>7&&this._opcode<11))return this._loop=!1,wn(RangeError,"invalid opcode "+this._opcode,!0,1002,"WS_ERR_INVALID_OPCODE");if(!this._fin)return this._loop=!1,wn(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN");if(t)return this._loop=!1,wn(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(this._payloadLength>125)return this._loop=!1,wn(RangeError,"invalid payload length "+this._payloadLength,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH")}if(this._fin||this._fragmented||(this._fragmented=this._opcode),this._masked=128==(128&e[1]),this._isServer){if(!this._masked)return this._loop=!1,wn(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK")}else if(this._masked)return this._loop=!1,wn(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK");if(126===this._payloadLength)this._state=1;else{if(127!==this._payloadLength)return this.haveLength();this._state=2}}getPayloadLength16(){if(!(this._bufferedBytes<2))return this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength();this._loop=!1}getPayloadLength64(){if(this._bufferedBytes<8)return void(this._loop=!1);const e=this.consume(8),t=e.readUInt32BE(0);return t>Math.pow(2,21)-1?(this._loop=!1,wn(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH")):(this._payloadLength=t*Math.pow(2,32)+e.readUInt32BE(4),this.haveLength())}haveLength(){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0))return this._loop=!1,wn(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");this._masked?this._state=3:this._state=4}getMask(){this._bufferedBytes<4?this._loop=!1:(this._mask=this.consume(4),this._state=4)}getData(e){let t=cn;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength)return void(this._loop=!1);t=this.consume(this._payloadLength),this._masked&&fn(t,this._mask)}return this._opcode>7?this.controlMessage(t):this._compressed?(this._state=5,void this.decompress(t,e)):(t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage())}decompress(e,t){this._extensions[Zr.extensionName].decompress(e,this._fin,(e,r)=>{if(e)return t(e);if(r.length){if(this._messageLength+=r.length,this._messageLength>this._maxPayload&&this._maxPayload>0)return t(wn(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"));this._fragments.push(r)}const n=this.dataMessage();if(n)return t(n);this.startLoop(t)})}dataMessage(){if(this._fin){const e=this._messageLength,t=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],2===this._opcode){let r;r="nodebuffer"===this._binaryType?hn(t,e):"arraybuffer"===this._binaryType?un(hn(t,e)):t,this.emit("message",r)}else{const r=hn(t,e);if(!_n(r))return this._loop=!1,wn(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");this.emit("message",r.toString())}}this._state=0}controlMessage(e){if(8===this._opcode)if(this._loop=!1,0===e.length)this.emit("conclude",1005,""),this.end();else{if(1===e.length)return wn(RangeError,"invalid payload length 1",!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH");{const t=e.readUInt16BE(0);if(!pn(t))return wn(RangeError,"invalid status code "+t,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");const r=e.slice(2);if(!_n(r))return wn(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");this.emit("conclude",t,r.toString()),this.end()}}else 9===this._opcode?this.emit("ping",e):this.emit("pong",e);this._state=0}};function wn(e,t,r,n,s){const i=new e(r?"Invalid WebSocket frame: "+t:t);return Error.captureStackTrace(i,wn),i.code=s,i[ln]=n,i}const{randomFillSync:yn}=m.default,{EMPTY_BUFFER:gn}=_r,{isValidStatusCode:bn}=sn,{mask:En,toBuffer:vn}=Fr,On=Buffer.alloc(4);class Sn{constructor(e,t){this._extensions=t||{},this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._deflating=!1,this._queue=[]}static frame(e,t){const r=t.mask&&t.readOnly;let n=t.mask?6:2,s=e.length;e.length>=65536?(n+=8,s=127):e.length>125&&(n+=2,s=126);const i=Buffer.allocUnsafe(r?e.length+n:n);return i[0]=t.fin?128|t.opcode:t.opcode,t.rsv1&&(i[0]|=64),i[1]=s,126===s?i.writeUInt16BE(e.length,2):127===s&&(i.writeUInt32BE(0,2),i.writeUInt32BE(e.length,6)),t.mask?(yn(On,0,4),i[1]|=128,i[n-4]=On[0],i[n-3]=On[1],i[n-2]=On[2],i[n-1]=On[3],r?(En(e,On,i,n,e.length),[i]):(En(e,On,e,0,e.length),[i,e])):[i,e]}close(e,t,r,n){let s;if(void 0===e)s=gn;else{if("number"!=typeof e||!bn(e))throw new TypeError("First argument must be a valid error code number");if(void 0===t||""===t)s=Buffer.allocUnsafe(2),s.writeUInt16BE(e,0);else{const r=Buffer.byteLength(t);if(r>123)throw new RangeError("The message must not be greater than 123 bytes");s=Buffer.allocUnsafe(2+r),s.writeUInt16BE(e,0),s.write(t,2)}}this._deflating?this.enqueue([this.doClose,s,r,n]):this.doClose(s,r,n)}doClose(e,t,r){this.sendFrame(Sn.frame(e,{fin:!0,rsv1:!1,opcode:8,mask:t,readOnly:!1}),r)}ping(e,t,r){const n=vn(e);if(n.length>125)throw new RangeError("The data size must not be greater than 125 bytes");this._deflating?this.enqueue([this.doPing,n,t,vn.readOnly,r]):this.doPing(n,t,vn.readOnly,r)}doPing(e,t,r,n){this.sendFrame(Sn.frame(e,{fin:!0,rsv1:!1,opcode:9,mask:t,readOnly:r}),n)}pong(e,t,r){const n=vn(e);if(n.length>125)throw new RangeError("The data size must not be greater than 125 bytes");this._deflating?this.enqueue([this.doPong,n,t,vn.readOnly,r]):this.doPong(n,t,vn.readOnly,r)}doPong(e,t,r,n){this.sendFrame(Sn.frame(e,{fin:!0,rsv1:!1,opcode:10,mask:t,readOnly:r}),n)}send(e,t,r){const n=vn(e),s=this._extensions[Zr.extensionName];let i=t.binary?2:1,o=t.compress;if(this._firstFragment?(this._firstFragment=!1,o&&s&&(o=n.length>=s._threshold),this._compress=o):(o=!1,i=0),t.fin&&(this._firstFragment=!0),s){const e={fin:t.fin,rsv1:o,opcode:i,mask:t.mask,readOnly:vn.readOnly};this._deflating?this.enqueue([this.dispatch,n,this._compress,e,r]):this.dispatch(n,this._compress,e,r)}else this.sendFrame(Sn.frame(n,{fin:t.fin,rsv1:!1,opcode:i,mask:t.mask,readOnly:vn.readOnly}),r)}dispatch(e,t,r,n){if(!t)return void this.sendFrame(Sn.frame(e,r),n);const s=this._extensions[Zr.extensionName];this._bufferedBytes+=e.length,this._deflating=!0,s.compress(e,r.fin,(t,s)=>{if(this._socket.destroyed){const e=new Error("The socket was closed while data was being compressed");"function"==typeof n&&n(e);for(let t=0;t<this._queue.length;t++){const r=this._queue[t][4];"function"==typeof r&&r(e)}}else this._bufferedBytes-=e.length,this._deflating=!1,r.readOnly=!1,this.sendFrame(Sn.frame(s,r),n),this.dequeue()})}dequeue(){for(;!this._deflating&&this._queue.length;){const e=this._queue.shift();this._bufferedBytes-=e[1].length,Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[1].length,this._queue.push(e)}sendFrame(e,t){2===e.length?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}}var Nn=Sn;class In{constructor(e,t){this.target=t,this.type=e}}class Tn extends In{constructor(e,t){super("message",t),this.data=e}}class An extends In{constructor(e,t,r){super("close",r),this.wasClean=r._closeFrameReceived&&r._closeFrameSent,this.reason=t,this.code=e}}class Ln extends In{constructor(e){super("open",e)}}class xn extends In{constructor(e,t){super("error",t),this.message=e.message,this.error=e}}var Cn={addEventListener(e,t,r){if("function"!=typeof t)return;function n(e){t.call(this,new Tn(e,this))}function s(e,r){t.call(this,new An(e,r,this))}function i(e){t.call(this,new xn(e,this))}function o(){t.call(this,new Ln(this))}const a=r&&r.once?"once":"on";"message"===e?(n._listener=t,this[a](e,n)):"close"===e?(s._listener=t,this[a](e,s)):"error"===e?(i._listener=t,this[a](e,i)):"open"===e?(o._listener=t,this[a](e,o)):this[a](e,t)},removeEventListener(e,t){const r=this.listeners(e);for(let n=0;n<r.length;n++)r[n]!==t&&r[n]._listener!==t||this.removeListener(e,r[n])}};const Pn=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function kn(e,t,r){void 0===e[t]?e[t]=[r]:e[t].push(r)}var Dn={format:function(e){return Object.keys(e).map(t=>{let r=e[t];return Array.isArray(r)||(r=[r]),r.map(e=>[t].concat(Object.keys(e).map(t=>{let r=e[t];return Array.isArray(r)||(r=[r]),r.map(e=>!0===e?t:`${t}=${e}`).join("; ")})).join("; ")).join(", ")}).join(", ")},parse:function(e){const t=Object.create(null);if(void 0===e||""===e)return t;let r,n,s=Object.create(null),i=!1,o=!1,a=!1,c=-1,l=-1,d=0;for(;d<e.length;d++){const h=e.charCodeAt(d);if(void 0===r)if(-1===l&&1===Pn[h])-1===c&&(c=d);else if(32===h||9===h)-1===l&&-1!==c&&(l=d);else{if(59!==h&&44!==h)throw new SyntaxError("Unexpected character at index "+d);{if(-1===c)throw new SyntaxError("Unexpected character at index "+d);-1===l&&(l=d);const n=e.slice(c,l);44===h?(kn(t,n,s),s=Object.create(null)):r=n,c=l=-1}}else if(void 0===n)if(-1===l&&1===Pn[h])-1===c&&(c=d);else if(32===h||9===h)-1===l&&-1!==c&&(l=d);else if(59===h||44===h){if(-1===c)throw new SyntaxError("Unexpected character at index "+d);-1===l&&(l=d),kn(s,e.slice(c,l),!0),44===h&&(kn(t,r,s),s=Object.create(null),r=void 0),c=l=-1}else{if(61!==h||-1===c||-1!==l)throw new SyntaxError("Unexpected character at index "+d);n=e.slice(c,d),c=l=-1}else if(o){if(1!==Pn[h])throw new SyntaxError("Unexpected character at index "+d);-1===c?c=d:i||(i=!0),o=!1}else if(a)if(1===Pn[h])-1===c&&(c=d);else if(34===h&&-1!==c)a=!1,l=d;else{if(92!==h)throw new SyntaxError("Unexpected character at index "+d);o=!0}else if(34===h&&61===e.charCodeAt(d-1))a=!0;else if(-1===l&&1===Pn[h])-1===c&&(c=d);else if(-1===c||32!==h&&9!==h){if(59!==h&&44!==h)throw new SyntaxError("Unexpected character at index "+d);{if(-1===c)throw new SyntaxError("Unexpected character at index "+d);-1===l&&(l=d);let o=e.slice(c,l);i&&(o=o.replace(/\\/g,""),i=!1),kn(s,n,o),44===h&&(kn(t,r,s),s=Object.create(null),r=void 0),n=void 0,c=l=-1}}else-1===l&&(l=d)}if(-1===c||a)throw new SyntaxError("Unexpected end of input");-1===l&&(l=d);const h=e.slice(c,l);return void 0===r?kn(t,h,s):(void 0===n?kn(s,h,!0):kn(s,n,i?h.replace(/\\/g,""):h),kn(t,r,s)),t}};const{randomBytes:Rn,createHash:Mn}=m.default,{URL:jn}=O.default,{BINARY_TYPES:Un,EMPTY_BUFFER:Fn,GUID:$n,kStatusCode:Bn,kWebSocket:qn,NOOP:Wn}=_r,{addEventListener:Gn,removeEventListener:Vn}=Cn,{format:Hn,parse:Qn}=Dn,{toBuffer:Jn}=Fr,Yn=["CONNECTING","OPEN","CLOSING","CLOSED"],zn=[8,13];class Xn extends w.default{constructor(e,t,r){super(),this._binaryType=Un[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage="",this._closeTimer=null,this._extensions={},this._protocol="",this._readyState=Xn.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,null!==e?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,Array.isArray(t)?t=t.join(", "):"object"==typeof t&&null!==t&&(r=t,t=void 0),function e(t,r,n,s){const i={protocolVersion:zn[1],maxPayload:104857600,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...s,createConnection:void 0,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:void 0,host:void 0,path:void 0,port:void 0};if(!zn.includes(i.protocolVersion))throw new RangeError(`Unsupported protocol version: ${i.protocolVersion} (supported versions: ${zn.join(", ")})`);let o;r instanceof jn?(o=r,t._url=r.href):(o=new jn(r),t._url=r);const a="ws+unix:"===o.protocol;if(!(o.host||a&&o.pathname)){const e=new Error("Invalid URL: "+t.url);if(0===t._redirects)throw e;return void Kn(t,e)}const c="wss:"===o.protocol||"https:"===o.protocol,l=c?443:80,d=Rn(16).toString("base64"),h=c?y.default.get:g.default.get;let u;i.createConnection=c?ts:es,i.defaultPort=i.defaultPort||l,i.port=o.port||l,i.host=o.hostname.startsWith("[")?o.hostname.slice(1,-1):o.hostname,i.headers={"Sec-WebSocket-Version":i.protocolVersion,"Sec-WebSocket-Key":d,Connection:"Upgrade",Upgrade:"websocket",...i.headers},i.path=o.pathname+o.search,i.timeout=i.handshakeTimeout,i.perMessageDeflate&&(u=new Zr(!0!==i.perMessageDeflate?i.perMessageDeflate:{},!1,i.maxPayload),i.headers["Sec-WebSocket-Extensions"]=Hn({[Zr.extensionName]:u.offer()}));n&&(i.headers["Sec-WebSocket-Protocol"]=n);i.origin&&(i.protocolVersion<13?i.headers["Sec-WebSocket-Origin"]=i.origin:i.headers.Origin=i.origin);(o.username||o.password)&&(i.auth=`${o.username}:${o.password}`);if(a){const e=i.path.split(":");i.socketPath=e[0],i.path=e[1]}let f=t._req=h(i);i.timeout&&f.on("timeout",()=>{rs(t,f,"Opening handshake has timed out")});f.on("error",e=>{null===f||f.aborted||(f=t._req=null,Kn(t,e))}),f.on("response",o=>{const a=o.headers.location,c=o.statusCode;if(a&&i.followRedirects&&c>=300&&c<400){if(++t._redirects>i.maxRedirects)return void rs(t,f,"Maximum redirects exceeded");let o;f.abort();try{o=new jn(a,r)}catch(e){return void Kn(t,e)}e(t,o,n,s)}else t.emit("unexpected-response",f,o)||rs(t,f,"Unexpected server response: "+o.statusCode)}),f.on("upgrade",(e,r,s)=>{if(t.emit("upgrade",e),t.readyState!==Xn.CONNECTING)return;f=t._req=null;const o=Mn("sha1").update(d+$n).digest("base64");if(e.headers["sec-websocket-accept"]!==o)return void rs(t,r,"Invalid Sec-WebSocket-Accept header");const a=e.headers["sec-websocket-protocol"],c=(n||"").split(/, */);let l;if(!n&&a?l="Server sent a subprotocol but none was requested":n&&!a?l="Server sent no subprotocol":a&&!c.includes(a)&&(l="Server sent an invalid subprotocol"),l)return void rs(t,r,l);a&&(t._protocol=a);const h=e.headers["sec-websocket-extensions"];if(void 0!==h){if(!u){return void rs(t,r,"Server sent a Sec-WebSocket-Extensions header but no extension was requested")}let e;try{e=Qn(h)}catch(e){return void rs(t,r,"Invalid Sec-WebSocket-Extensions header")}const n=Object.keys(e);if(n.length){if(1!==n.length||n[0]!==Zr.extensionName){return void rs(t,r,"Server indicated an extension that was not requested")}try{u.accept(e[Zr.extensionName])}catch(e){return void rs(t,r,"Invalid Sec-WebSocket-Extensions header")}t._extensions[Zr.extensionName]=u}}t.setSocket(r,s,i.maxPayload)})}(this,e,t,r)):this._isServer=!0}get binaryType(){return this._binaryType}set binaryType(e){Un.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get onclose(){}set onclose(e){}get onerror(){}set onerror(e){}get onopen(){}set onopen(e){}get onmessage(){}set onmessage(e){}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,r){const n=new mn(this.binaryType,this._extensions,this._isServer,r);this._sender=new Nn(e,this._extensions),this._receiver=n,this._socket=e,n[qn]=this,e[qn]=this,n.on("conclude",ss),n.on("drain",is),n.on("error",os),n.on("message",cs),n.on("ping",ls),n.on("pong",ds),e.setTimeout(0),e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",us),e.on("data",fs),e.on("end",ps),e.on("error",_s),this._readyState=Xn.OPEN,this.emit("open")}emitClose(){if(!this._socket)return this._readyState=Xn.CLOSED,void this.emit("close",this._closeCode,this._closeMessage);this._extensions[Zr.extensionName]&&this._extensions[Zr.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=Xn.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==Xn.CLOSED){if(this.readyState===Xn.CONNECTING){const e="WebSocket was closed before the connection was established";return rs(this,this._req,e)}this.readyState!==Xn.CLOSING?(this._readyState=Xn.CLOSING,this._sender.close(e,t,!this._isServer,e=>{e||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())}),this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),3e4)):this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end()}}ping(e,t,r){if(this.readyState===Xn.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(r=e,e=t=void 0):"function"==typeof t&&(r=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===Xn.OPEN?(void 0===t&&(t=!this._isServer),this._sender.ping(e||Fn,t,r)):ns(this,e,r)}pong(e,t,r){if(this.readyState===Xn.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(r=e,e=t=void 0):"function"==typeof t&&(r=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===Xn.OPEN?(void 0===t&&(t=!this._isServer),this._sender.pong(e||Fn,t,r)):ns(this,e,r)}send(e,t,r){if(this.readyState===Xn.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof t&&(r=t,t={}),"number"==typeof e&&(e=e.toString()),this.readyState!==Xn.OPEN)return void ns(this,e,r);const n={binary:"string"!=typeof e,mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[Zr.extensionName]||(n.compress=!1),this._sender.send(e||Fn,n,r)}terminate(){if(this.readyState!==Xn.CLOSED){if(this.readyState===Xn.CONNECTING){const e="WebSocket was closed before the connection was established";return rs(this,this._req,e)}this._socket&&(this._readyState=Xn.CLOSING,this._socket.destroy())}}}Object.defineProperty(Xn,"CONNECTING",{enumerable:!0,value:Yn.indexOf("CONNECTING")}),Object.defineProperty(Xn.prototype,"CONNECTING",{enumerable:!0,value:Yn.indexOf("CONNECTING")}),Object.defineProperty(Xn,"OPEN",{enumerable:!0,value:Yn.indexOf("OPEN")}),Object.defineProperty(Xn.prototype,"OPEN",{enumerable:!0,value:Yn.indexOf("OPEN")}),Object.defineProperty(Xn,"CLOSING",{enumerable:!0,value:Yn.indexOf("CLOSING")}),Object.defineProperty(Xn.prototype,"CLOSING",{enumerable:!0,value:Yn.indexOf("CLOSING")}),Object.defineProperty(Xn,"CLOSED",{enumerable:!0,value:Yn.indexOf("CLOSED")}),Object.defineProperty(Xn.prototype,"CLOSED",{enumerable:!0,value:Yn.indexOf("CLOSED")}),["binaryType","bufferedAmount","extensions","protocol","readyState","url"].forEach(e=>{Object.defineProperty(Xn.prototype,e,{enumerable:!0})}),["open","error","close","message"].forEach(e=>{Object.defineProperty(Xn.prototype,"on"+e,{enumerable:!0,get(){const t=this.listeners(e);for(let e=0;e<t.length;e++)if(t[e]._listener)return t[e]._listener},set(t){const r=this.listeners(e);for(let t=0;t<r.length;t++)r[t]._listener&&this.removeListener(e,r[t]);this.addEventListener(e,t)}})}),Xn.prototype.addEventListener=Gn,Xn.prototype.removeEventListener=Vn;var Zn=Xn;function Kn(e,t){e._readyState=Xn.CLOSING,e.emit("error",t),e.emitClose()}function es(e){return e.path=e.socketPath,b.default.connect(e)}function ts(e){return e.path=void 0,e.servername||""===e.servername||(e.servername=b.default.isIP(e.host)?"":e.host),E.default.connect(e)}function rs(e,t,r){e._readyState=Xn.CLOSING;const n=new Error(r);Error.captureStackTrace(n,rs),t.setHeader?(t.abort(),t.socket&&!t.socket.destroyed&&t.socket.destroy(),t.once("abort",e.emitClose.bind(e)),e.emit("error",n)):(t.destroy(n),t.once("error",e.emit.bind(e,"error")),t.once("close",e.emitClose.bind(e)))}function ns(e,t,r){if(t){const r=Jn(t).length;e._socket?e._sender._bufferedBytes+=r:e._bufferedAmount+=r}if(r){r(new Error(`WebSocket is not open: readyState ${e.readyState} (${Yn[e.readyState]})`))}}function ss(e,t){const r=this[qn];r._closeFrameReceived=!0,r._closeMessage=t,r._closeCode=e,void 0!==r._socket[qn]&&(r._socket.removeListener("data",fs),process.nextTick(hs,r._socket),1005===e?r.close():r.close(e,t))}function is(){this[qn]._socket.resume()}function os(e){const t=this[qn];void 0!==t._socket[qn]&&(t._socket.removeListener("data",fs),process.nextTick(hs,t._socket),t.close(e[Bn])),t.emit("error",e)}function as(){this[qn].emitClose()}function cs(e){this[qn].emit("message",e)}function ls(e){const t=this[qn];t.pong(e,!t._isServer,Wn),t.emit("ping",e)}function ds(e){this[qn].emit("pong",e)}function hs(e){e.resume()}function us(){const e=this[qn];let t;this.removeListener("close",us),this.removeListener("data",fs),this.removeListener("end",ps),e._readyState=Xn.CLOSING,this._readableState.endEmitted||e._closeFrameReceived||e._receiver._writableState.errorEmitted||null===(t=e._socket.read())||e._receiver.write(t),e._receiver.end(),this[qn]=void 0,clearTimeout(e._closeTimer),e._receiver._writableState.finished||e._receiver._writableState.errorEmitted?e.emitClose():(e._receiver.on("error",as),e._receiver.on("finish",as))}function fs(e){this[qn]._receiver.write(e)||this.pause()}function ps(){const e=this[qn];e._readyState=Xn.CLOSING,e._receiver.end(),this.end()}function _s(){const e=this[qn];this.removeListener("error",_s),this.on("error",Wn),e&&(e._readyState=Xn.CLOSING,this.destroy())}const{Duplex:ms}=v.default;function ws(e){e.emit("close")}function ys(){!this.destroyed&&this._writableState.finished&&this.destroy()}function gs(e){this.removeListener("error",gs),this.destroy(),0===this.listenerCount("error")&&this.emit("error",e)}var bs=function(e,t){let r=!0,n=!0;function s(){r&&e._socket.resume()}e.readyState===e.CONNECTING?e.once("open",(function(){e._receiver.removeAllListeners("drain"),e._receiver.on("drain",s)})):(e._receiver.removeAllListeners("drain"),e._receiver.on("drain",s));const i=new ms({...t,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return e.on("message",(function(t){i.push(t)||(r=!1,e._socket.pause())})),e.once("error",(function(e){i.destroyed||(n=!1,i.destroy(e))})),e.once("close",(function(){i.destroyed||i.push(null)})),i._destroy=function(t,r){if(e.readyState===e.CLOSED)return r(t),void process.nextTick(ws,i);let s=!1;e.once("error",(function(e){s=!0,r(e)})),e.once("close",(function(){s||r(t),process.nextTick(ws,i)})),n&&e.terminate()},i._final=function(t){e.readyState!==e.CONNECTING?null!==e._socket&&(e._socket._writableState.finished?(t(),i._readableState.endEmitted&&i.destroy()):(e._socket.once("finish",(function(){t()})),e.close())):e.once("open",(function(){i._final(t)}))},i._read=function(){e.readyState!==e.OPEN&&e.readyState!==e.CLOSING||r||(r=!0,e._receiver._writableState.needDrain||e._socket.resume())},i._write=function(t,r,n){e.readyState!==e.CONNECTING?e.send(t,n):e.once("open",(function(){i._write(t,r,n)}))},i.on("end",ys),i.on("error",gs),i};const{createHash:Es}=m.default,{format:vs,parse:Os}=Dn,{GUID:Ss,kWebSocket:Ns}=_r,Is=/^[+/0-9A-Za-z]{22}==$/;class Ts extends w.default{constructor(e,t){if(super(),null==(e={maxPayload:104857600,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,...e}).port&&!e.server&&!e.noServer||null!=e.port&&(e.server||e.noServer)||e.server&&e.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(null!=e.port?(this._server=g.default.createServer((e,t)=>{const r=g.default.STATUS_CODES[426];t.writeHead(426,{"Content-Length":r.length,"Content-Type":"text/plain"}),t.end(r)}),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server){const e=this.emit.bind(this,"connection");this._removeListeners=function(e,t){for(const r of Object.keys(t))e.on(r,t[r]);return function(){for(const r of Object.keys(t))e.removeListener(r,t[r])}}(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(t,r,n)=>{this.handleUpgrade(t,r,n,e)}})}!0===e.perMessageDeflate&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set),this.options=e,this._state=0}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(e&&this.once("close",e),2===this._state)return void process.nextTick(Ls,this);if(1===this._state)return;if(this._state=1,this.clients)for(const e of this.clients)e.terminate();const t=this._server;t&&(this._removeListeners(),this._removeListeners=this._server=null,null!=this.options.port)?t.close(Ls.bind(void 0,this)):process.nextTick(Ls,this)}shouldHandle(e){if(this.options.path){const t=e.url.indexOf("?");if((-1!==t?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,r,n){t.on("error",xs);const s=void 0!==e.headers["sec-websocket-key"]&&e.headers["sec-websocket-key"].trim(),i=+e.headers["sec-websocket-version"],o={};if("GET"!==e.method||"websocket"!==e.headers.upgrade.toLowerCase()||!s||!Is.test(s)||8!==i&&13!==i||!this.shouldHandle(e))return Cs(t,400);if(this.options.perMessageDeflate){const r=new Zr(this.options.perMessageDeflate,!0,this.options.maxPayload);try{const t=Os(e.headers["sec-websocket-extensions"]);t[Zr.extensionName]&&(r.accept(t[Zr.extensionName]),o[Zr.extensionName]=r)}catch(e){return Cs(t,400)}}if(this.options.verifyClient){const a={origin:e.headers[""+(8===i?"sec-websocket-origin":"origin")],secure:!(!e.socket.authorized&&!e.socket.encrypted),req:e};if(2===this.options.verifyClient.length)return void this.options.verifyClient(a,(i,a,c,l)=>{if(!i)return Cs(t,a||401,c,l);this.completeUpgrade(s,o,e,t,r,n)});if(!this.options.verifyClient(a))return Cs(t,401)}this.completeUpgrade(s,o,e,t,r,n)}completeUpgrade(e,t,r,n,s,i){if(!n.readable||!n.writable)return n.destroy();if(n[Ns])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>0)return Cs(n,503);const o=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Accept: "+Es("sha1").update(e+Ss).digest("base64")],a=new Zn(null);let c=r.headers["sec-websocket-protocol"];if(c&&(c=c.split(",").map(Ps),c=this.options.handleProtocols?this.options.handleProtocols(c,r):c[0],c&&(o.push("Sec-WebSocket-Protocol: "+c),a._protocol=c)),t[Zr.extensionName]){const e=t[Zr.extensionName].params,r=vs({[Zr.extensionName]:[e]});o.push("Sec-WebSocket-Extensions: "+r),a._extensions=t}this.emit("headers",o,r),n.write(o.concat("\r\n").join("\r\n")),n.removeListener("error",xs),a.setSocket(n,s,this.options.maxPayload),this.clients&&(this.clients.add(a),a.on("close",()=>this.clients.delete(a))),i(a,r)}}var As=Ts;function Ls(e){e._state=2,e.emit("close")}function xs(){this.destroy()}function Cs(e,t,r,n){e.writable&&(r=r||g.default.STATUS_CODES[t],n={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(r),...n},e.write(`HTTP/1.1 ${t} ${g.default.STATUS_CODES[t]}\r\n`+Object.keys(n).map(e=>`${e}: ${n[e]}`).join("\r\n")+"\r\n\r\n"+r)),e.removeListener("error",xs),e.destroy()}function Ps(e){return e.trim()}Zn.createWebSocketStream=bs,Zn.Server=As,Zn.Receiver=mn,Zn.Sender=Nn;var ks=Zn;class Ds extends n.EventEmitter{_setupSocket(e){this._ws=e,this._initEvent()}_initEvent(){const e=["open","message","close","error"];for(let t=0;t<e.length;t++){const r=e[t];this["on"+r.replace(/^(\w)/,(function(e){return e.toUpperCase()}))]=function(e){this.on(r,e)}}this._ws.on("open",()=>{this.emit("open")}),this._ws.on("message",e=>{this.emit("message",{data:e})}),this._ws.on("error",e=>{this.emit("error",{errMsg:e.message})}),this._ws.on("close",(e,t)=>{this.emit("close",{code:e,reason:Buffer.isBuffer(t)?t.toString("utf8"):t})})}send({data:e}={}){return u.promisify(this._ws.send).call(this._ws,e)}close({code:e=1e3,reason:t}={}){this._ws.close(e,t)}}function Rs({url:e,header:t={},protocols:r}={}){const n=new ks(e,r,{finishRequest:function(e,r){for(const r in t)e.setHeader(r,t[r]);e.end()}}),s=new Ds;return s._setupSocket(n),s}async function Ms({url:e,method:t="GET",data:r,header:n={},dataType:s="json",responseType:i="text",timeout:o=6e4,sslVerify:a=!0}={}){const l={method:t,headers:n,timeout:o,followRedirect:!0},d=t.toLowerCase();l.dataType="text"!==i?"":"json"===s?"json":"text",a||(l.rejectUnauthorized=!1);let h=n[Object.keys(n).find(e=>"content-type"===e.toLowerCase())]||"";if("get"===d)l.dataAsQueryString=!0,l.data=r;else if(r instanceof c.Readable)l.stream=r;else if("post"===d){h||(n["Content-Type"]=h="application/json");const e=h.split(";")[0];if("object"!==D(r))l.content=r;else if("application/json"===e)l.content=JSON.stringify(r);else if("application/x-www-form-urlencoded"===e){const e=[];for(const t in r)e.push(encodeURIComponent(t)+"="+encodeURIComponent(r[t]));l.content=e.join("&")}else l.content=r}else r&&(l.content=r);const u=await uniCloud.httpclient.request(e,l),{status:f,headers:p,data:_}=u;return{statusCode:f,header:p,data:_}}function js(e={}){this.$provider="aliyun",this.$options=e,this.$context=e.context||global.__ctx__,function(e){e.$scope=e.$context.mpserverless}(this),function(e){e.auth=A("auth"),e.customAuth=e.auth}(this),V(this),function(e){e.logger=console}(this),function(e){e.database=function(t){return e.$scope.db.toJSON=function(){return"_db"},new Ht(e.$scope.db,t)}}(this),function(e){e.callFunction=function({name:t,data:r}){return new Promise((n,s)=>{e.$scope.function.invoke(t,r).then(e=>{n(e)}).catch(e=>{s(new I(e))})})}}(this),function(e){e.httpclient=e.$context.httpclient}(this),Qt(this),function(e){const t=Object.getPrototypeOf(e);t.initI18n=nr,t.importObject=sr,t.getCloudInfos=ar,t.getClientInfos=cr,t.getRequestList=lr,t.getHttpInfoByRequestId=dr,t.deserializeSSEChannel=ur,t.connectSocket=Rs,t.request=Ms}(this)}js.prototype.init=function(e){return"tencent"===uniCloud.$provider&&e.context&&!e.spaceId?this:new js(e)},module.exports=js;

"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("fs"),t=require("path"),n=require("module");function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=r(e),s=r(t),c=r(n);const i=process.env.UNICLOUD_DEBUGGER_PATH=process.env.UNICLOUD_DEBUGGER_PATH||s.default.resolve(__dirname,"../");process.env.UNICLOUD_INFO=process.env.UNICLOUD_INFO||JSON.stringify([]);const l=s.default.resolve(i,"share/index"),{getWorkspacePathFromFilePath:u}=require(l);if(process.env.WORKSPACE_FOLDER||(process.env.WORKSPACE_FOLDER=u(process.argv[3]||"")),!process.env.SPACE_PROVIDER){let e={};try{e=JSON.parse(process.env.UNICLOUD_SECRET)}catch(e){}e.secretId?process.env.SPACE_PROVIDER="tcb":e.serverSecret&&(process.env.SPACE_PROVIDER="aliyun")}const a=process.env.UNICLOUD_DEBUGGER_PATH,d=s.default.resolve(a,"share/index"),{parseJson:f,getType:p,getRealWorkspace:m,getCloudfunctionPathList:h,getFunctionEntry:g,getCommonModulePath:v,getActionPath:y,isModuleEncrypted:E,isFileEncrypted:O,JsonRpcClient:C}=require(d),D=s.default.resolve(a,"internal-functions");o.default.readdirSync(D).filter(e=>o.default.statSync(s.default.resolve(D,e)).isDirectory());const _=[];var P=e=>{const t=function e(t){const n=[];try{const{dependencies:r}=JSON.parse(o.default.readFileSync(s.default.resolve(t,"package.json")));if(!r)return[];Object.keys(r).filter(e=>0===r[e].indexOf("file:")).map(o=>{const c=s.default.resolve(t,r[o].replace("file:",""));n.push({moduleName:o,modulePath:c}),n.push(...e(c))})}catch(e){}return n}(e);return 0===t.length||(function(e){const t={};for(let n=0;n<e.length;n++){const{moduleName:r,modulePath:o}=e[n];t[r]||(t[r]=new Set),t[r].add(o)}let n=!1;const r=[];if(Object.keys(t).forEach(e=>{t[e].size>1&&(n=!0,console.error(`公共模块[${e}]只能存在一个，请从下面候选中删除不使用的公共模块：`),t[e].forEach(e=>{console.error(e)}),r.push(e))}),n)throw new Error(`公共模块[${r.join("、")}]只能存在一个，删除不使用的公共模块后再试`)}(t),t.forEach(({moduleName:e,modulePath:t})=>{_.indexOf(e)>-1||E(t)&&_.push(e)})),_};class N extends Error{constructor(e){super(e.message),this.errMsg=e.message||"",this.code=e.code,Object.defineProperties(this,{message:{get(){return`errCode: ${e.code||""} | errMsg: `+this.errMsg},set(e){this.errMsg=e}}})}}const x=module.constructor.length>1?module.constructor:c.default,F=x._resolveFilename,S=[{regexp:/.*uniCloud(?:.*?)\/cloudfunctions\/common\/(.*)\//i,type:"common"},{regexp:/.*uniCloud(?:.*?)\/cloudfunctions\/uni-clientDB-actions\/(.*)/i,type:"clientDBAction"},{regexp:/.*uniCloud(?:.*?)\/database\/validateFunction\/(.*)/i,type:"validateFunction"},{regexp:/.*uniCloud(?:.*?)\/cloudfunctions\/(.*)\//i,type:"function"},{regexp:/.*unicloud\/internal-functions\/common\/(.*)\//i,type:"inernalCommon"},{regexp:/.*unicloud\/internal-functions\/(.*)\//i,type:"inernalFunction"}];function U(e,t){const n=e.match(t.regexp);if(n)return{modulePath:n[0],moduleName:n[1],type:t.type}}function R(e){let t;try{t=o.default.statSync(e)}catch(e){}if(!t)return;if(t.isFile()||t.isSymbolicLink())return e;const n=Object.keys(x._extensions);if(t.isDirectory()){const t=s.default.resolve(e,"package.json"),r=o.default.existsSync(t)&&require(t),c=r&&r.main;if(c)return s.default.resolve(e,c);for(let t=0;t<n.length;t++){const r=n[t],c=s.default.resolve(e,"index."+r);if(o.default.existsSync(c))return c}}}var I=e=>{x._resolveFilename=function(t,n,r,c){function i(){return F.call(x,t,n,r,c)}const l=t.split("/"),u=l.shift();if(u.startsWith(".")||!n.filename)return i();const a=l.join("/");if(e.indexOf(u)>-1)throw new N({code:"MODULE_ENCRYPTED",message:u+"模块已加密，不支持本地运行"});const d=function(e){e=e.replace(/\\/g,"/");for(let t=0;t<S.length;t++){const n=U(e,S[t]);if(n)return n}}(n.filename);if(!d)return i();const{modulePath:f,moduleName:p,type:m}=d;if("clientDBAction"===m||"validateFunction"===m||"inernalFunction"===m&&"DCloud-clientDB"===p){const{realWorkspace:e,provider:t}=global.uniCloudDebug;let n=["uni-id","uni-config-center"].indexOf(u)>-1;const r=v(e,t,u),c=s.default.resolve(r,"package.json"),l=o.default.existsSync(c)&&require(c);if(n=n||l.includeInClientDB,!n)return i();const a=R(r);return a||i()}const h=s.default.resolve(f,"package.json"),g=o.default.existsSync(h)&&require(h),y=g&&g.dependencies;if(!y)return i();let E=y[u];if(!E||!E.startsWith("file:"))return i();E=E.replace("file:","");let O=s.default.resolve(f,E);a&&(O=s.default.resolve(O,a));const C=R(O);return C||i()}};exports.callFunction=async function({name:e,data:t}={}){const{realWorkspace:n,provider:r}=global.uniCloudDebug,c=g(n,r,e);let i;try{i=o.default.statSync(s.default.resolve(c,"encrypt"))}catch(e){}if(i&&i.isFile())throw new N({code:"FUNCTION_ENCRYPTED",message:"此云函数已加密，不可本地运行"});const l=P(c);let u;I(l);try{u=require(c);return{result:await u.main(t,{SPACEINFO:global.__ctx__.SPACEINFO}),success:!0}}catch(e){throw"MODULE_NOT_FOUND"===e.code&&console.error("请求云函数错误，可能是由于云函数名称错误或者引用的其他模块未找到导致的，请参考下方详细错误信息。注意公共模块需要参考 https://uniapp.dcloud.net.cn/uniCloud/cf-common 进行本地安装。"),e}};

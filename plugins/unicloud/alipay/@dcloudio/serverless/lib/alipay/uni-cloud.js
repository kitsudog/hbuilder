"use strict";var e=require("fs"),t=require("path"),s=require("crypto"),r=require("events"),n=require("https"),i=require("http"),o=require("net"),a=require("tls"),c=require("stream"),l=require("url"),h=require("zlib"),d=require("os"),u=require("util");function f(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var _=f(e),p=f(t),m=f(s),g=f(r),y=f(n),v=f(i),b=f(o),w=f(a),S=f(c),E=f(l),x=f(h),k=f(d);class O extends Error{constructor(e={}){super(e.message),this.errMsg=e.message||"",this.code=this.errCode=e.code,this.errSubject=e.subject,this.forceReturn=e.forceReturn||!1,this.cause=e.cause,Object.defineProperties(this,{message:{get(){return this.errMsg},set(e){this.errMsg=e}}})}toJSON(e=0){if(!(e>=10))return e++,{errCode:this.errCode,errMsg:this.errMsg,code:this.errCode,message:this.message,errSubject:this.errSubject,cause:this.cause&&this.cause.toJSON?this.cause.toJSON(e):this.cause}}}function C(e){return function(){throw new Error("支付宝云服务空间暂不支持 "+e)}}const N=Object.prototype.toString;function I(e){return N.call(e).slice(8,-1).toLowerCase()}function L(e){const t={...e},{OS:s,APPID:r,LOCALE:n,PLATFORM:i,DEVICEID:o,CLIENTIP:a,CLIENTUA:c,SOURCE:l,requestId:h,secretType:d}=t,u=["SPACEINFO","FUNCTION_NAME","FUNCTION_TYPE","SOURCE","OS","APPID","LOCALE","CLIENTIP","CLIENTUA","PLATFORM","DEVICEID","requestId"];for(let e=0;e<u.length;e++){delete t[u[e]]}const f={...t,os:s,appId:r,locale:n,clientIP:a,userAgent:c,platform:"app-plus"===i?"app":i,deviceId:o,source:l,requestId:h,secretType:d};return function e(t){for(const s in t){const r=t[s];switch(I(r)){case"undefined":delete t[s];break;case"object":e(r)}}}(f),f}function T(e){const{provider:t,spaceId:s,useOldSpaceId:r}=e.SPACEINFO,{FUNCTION_NAME:n,FUNCTION_TYPE:i}=e;return{provider:t,spaceId:s,useOldSpaceId:r,functionName:n,functionType:i}}function P(e,t){let s,r;switch(t.SOURCE){case"timing":s="_timing",r=[];break;case"http":{const t=e.path.replace(/^\//,"");if(""===t)throw new Error(`"${e.path}" is not a valid cloudobject path`);s=t.split("/")[0],r=[e.queryStringParameters||{}];break}case"server":case"client":case"function":default:s=e.method,r=e.params}return"timing"!==t.SOURCE&&function(e){if(!e)throw new Error("Method name is required");if("_"===e[0])throw new Error(`Forbidden, ${e} is a private method`)}(s),{methodName:s,params:r}}require("path"),require("module");const R=require("@alipay/faas-server-sdk");const U=[{name:"uploadFile"},{name:"getTempFileURL"},{name:"deleteFile",resultHandler(e){const{error:t={}}=e;return{fileList:e.fileList.map(e=>{const s="ok"===e.errMsg?void 0:e.errMsg;return{code:(0===e.status?void 0:String(e.status))||t.code,message:s||t.message,fileID:e.fileID}})}}},{name:"downloadFile"}];const j=Object.prototype.toString;function B(e){return e.map(e=>{if("[object object]"===j.call(e).toLowerCase())try{e=JSON.stringify(e)}catch(t){e=String(e)}else e=String(e);return e}).join(" ")}const A=new Proxy({get:{normalizeResult:e=>({data:e instanceof Array?e:null===e?[]:[e]})},set:{normalizeParams:e=>({data:e}),normalizeResult:e=>({updated:e&&e.count||0})},add:{normalizeParams:e=>({data:e}),normalizeResult:e=>(e._id&&(e.id=e._id,delete e._id),e._ids&&(e.ids=e._ids,e.inserted=Array.isArray(e.ids)?e.ids.length:0,delete e._ids),e)},update:{normalizeParams:e=>({data:e}),normalizeResult:e=>({updated:e&&e.count||0})},remove:{normalizeResult:e=>({deleted:e&&e.count||0})},updateAndReturn:{normalizeParams:e=>({data:e})},where:{progress:!0,normalizeParams:(e={})=>z(e)},limit:{},orderBy:{},skip:{},field:{},geoNear:{}},{get:(e,t)=>["where","limit","orderBy","skip","field","geoNear"].includes(t)?Object.assign(e[t],e):e[t]}),D=new Proxy({end:{normalizeResult:e=>({data:e instanceof Array?e:[e]})},addFields:{},bucket:{},bucketAuto:{},count:{},geoNear:{},group:{},limit:{},match:{progress:!0,normalizeParams:(e={})=>z(e)},project:{},lookup:{},replaceRoot:{},sample:{},skip:{},sort:{},sortByCount:{},unwind:{}},{get:(e,t)=>["end"].includes(t)?e[t]:Object.assign(e[t],e)}),M={...A,doc:{...A},aggregate:{...D}},q={collection:{...M,get:{normalizeResult:e=>({data:e})},doc:{...M.doc,get:{normalizeResult:e=>({data:e})}}}},W={database:{collection:{...M},startTransaction:q,runTransaction:q}};function F(e){if("object"!=typeof e||null===e||"[object Object]"!==Object.prototype.toString.call(e))return!1;const t=Object.getPrototypeOf(e);return null===t||null===Object.getPrototypeOf(t)}function G(e){return e&&e.lastCmd&&e.lastCmd.name&&["and","or","not","nor","elemMatch"].includes(e.lastCmd.name)}function $(e){const t=e.lastCmd.commands;for(let e=0;e<t.length;e++)t[e]=z(t[e])}function z(e){return G(e)?$(e):F(e)&&function(e){for(const t in e){const s=e[t];if(!t.startsWith("$"))if(G(s))$(s);else if(F(s)){if(Object.keys(s).some(e=>e.startsWith("$")))continue;const r=z(s);for(const s in r)e[`${t}.${s}`]=r[s];delete e[t]}}}(e),e}function V(e,t){return new Proxy(e,{get(e,s){const r=t[s];return r&&!r.progress?function(...t){if(r.normalizeParams||r.normalizeResult){const n=r.normalizeParams?[r.normalizeParams(t[0])]:t;return e[s].apply(e,n).then(e=>r.normalizeResult?r.normalizeResult(e):e)}if(!e[s])throw new Error(s+" 不支持");const n=e[s].apply(e,t);if(n)return n instanceof Promise?n.then(e=>V(e,r)):V(n,r)}:e[s]instanceof Function?r&&r.progress?function(...t){const n=r.normalizeParams?[r.normalizeParams(t[0])]:t,i=e[s].apply(e,n);return i?V(i,r):i}:e[s].bind(e):e[s]}})}const H=Array.isArray,Y=["{","}"];const X=/^(?:\d)+/,J=/^(?:\w)+/;const K=Object.prototype.hasOwnProperty,Q=(e,t)=>K.call(e,t),Z=new class{constructor(){this._caches=Object.create(null)}interpolate(e,t,s=Y){if(!t)return[e];let r=this._caches[e];return r||(r=function(e,[t,s]){const r=[];let n=0,i="";for(;n<e.length;){let o=e[n++];if(o===t){i&&r.push({type:"text",value:i}),i="";let t="";for(o=e[n++];void 0!==o&&o!==s;)t+=o,o=e[n++];const a=o===s,c=X.test(t)?"list":a&&J.test(t)?"named":"unknown";r.push({value:t,type:c})}else i+=o}return i&&r.push({type:"text",value:i}),r}(e,s),this._caches[e]=r),function(e,t){const s=[];let r=0;const n=H(t)?"list":(i=t,null!==i&&"object"==typeof i?"named":"unknown");var i;if("unknown"===n)return s;for(;r<e.length;){const i=e[r];switch(i.type){case"text":s.push(i.value);break;case"list":s.push(t[parseInt(i.value,10)]);break;case"named":"named"===n&&s.push(t[i.value])}r++}return s}(r,t)}};function ee(e,t){if(!e)return;if(e=e.trim().replace(/_/g,"-"),t&&t[e])return e;if(0===(e=e.toLowerCase()).indexOf("zh"))return e.indexOf("-hans")>-1?"zh-Hans":e.indexOf("-hant")>-1?"zh-Hant":(s=e,["-tw","-hk","-mo","-cht"].find(e=>-1!==s.indexOf(e))?"zh-Hant":"zh-Hans");var s;const r=function(e,t){return t.find(t=>0===e.indexOf(t))}(e,["en","fr","es"]);return r||void 0}class te{constructor({locale:e,fallbackLocale:t,messages:s,watcher:r,formater:n}){this.locale="en",this.fallbackLocale="en",this.message={},this.messages={},this.watchers=[],t&&(this.fallbackLocale=t),this.formater=n||Z,this.messages=s||{},this.setLocale(e||"en"),r&&this.watchLocale(r)}setLocale(e){const t=this.locale;this.locale=ee(e,this.messages)||this.fallbackLocale,this.messages[this.locale]||(this.messages[this.locale]={}),this.message=this.messages[this.locale],t!==this.locale&&this.watchers.forEach(e=>{e(this.locale,t)})}getLocale(){return this.locale}watchLocale(e){const t=this.watchers.push(e)-1;return()=>{this.watchers.splice(t,1)}}add(e,t,s=!0){const r=this.messages[e];r?s?Object.assign(r,t):Object.keys(t).forEach(e=>{Q(r,e)||(r[e]=t[e])}):this.messages[e]=t}f(e,t,s){return this.formater.interpolate(e,t,s).join("")}t(e,t,s){let r=this.message;return"string"==typeof t?(t=ee(t,this.messages))&&(r=this.messages[t]):s=t,Q(r,e)?this.formater.interpolate(r[e],s).join(""):(console.warn(`Cannot translate the value of keypath ${e}. Use the value of keypath as default.`),e)}}function se({locale:e,fallbackLocale:t,messages:s={}}){const r=new te({locale:e,fallbackLocale:t,messages:{...s}});return s[r.locale]||r.setLocale(t),r}function re(e){const t=this;return new Proxy({},{get(s,r){switch(r){case"toString":return"[object UniCloudObject]";case"toJSON":return{}}return async function(...s){const n=await t.callFunction({name:e,data:{method:r,params:s}}),{errCode:i,errMsg:o,errSubject:a}=n.result||{};if(i){const e=new O({code:i,message:o,subject:a});throw e.detail=n.result,e.requestId=n.requestId,e}return n.result}}})}let ne;global.__unicloud_store__?ne=global.__unicloud_store__:global.__unicloud_store__=ne={requestInfo:{}};var ie=ne;function oe(){const e=ie.requestInfo,t=[];for(const s in e){const r=e[s];if(r.cloudInfo){t.push(r.cloudInfo);continue}const{context:n}=r,i=T(n);i.requestId=s,r.cloudInfo=i,t.push(i)}return t}function ae(){const e=ie.requestInfo,t=[];for(const s in e){const r=e[s];if(r.clientInfo){t.push(r.clientInfo);continue}const{event:n,context:i}=r,o={...L(i),requestId:s};if("cloudobject"===i.FUNCTION_TYPE){const{methodName:e,params:t}=P(n,i);o.cloudObjMethodName=e,o.cloudObjParams=t}r.clientInfo=o,t.push(o)}return t}function ce(){return Object.keys(ie.requestInfo)}function le(e){const{event:t,context:s}=ie.requestInfo[e]||{};if(t&&s&&"http"===s.SOURCE)return t}class he{constructor({appId:e,pushClientId:t,seqId:s}={}){if(this._appId=e,this._pushClientId=t,this._seqId=s,this._messageQueue=[],!e||!t||!s)throw new Error("Invalid sse channel");this._pushManager=uniCloud.getPushManager({appId:e}),this._messageId=0,this._send=(e,r)=>this._pushManager.sendMessage({push_clientid:t,settings:{strategy:{default:3},ttl:-1},payload:{channel:"UNI_CLOUD_SSE",action:e,seqId:s,messageId:this._messageId++,message:r}})}write(e){const t=this._send("message",e);return this._messageQueue.push(t),t}async end(e){return await Promise.all(this._messageQueue),this._send("end",e)}}function de(e){return new he(e)}function ue(e,t,s){return e(s={path:t,exports:{},require:function(e,t){return fe(null==t&&s.path)}},s.exports),s.exports}function fe(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}var _e={BINARY_TYPES:["nodebuffer","arraybuffer","fragments"],GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),EMPTY_BUFFER:Buffer.alloc(0),NOOP:()=>{}},pe="function"==typeof __webpack_require__?__non_webpack_require__:fe,me=process.config&&process.config.variables||{},ge=!!process.env.PREBUILDS_ONLY,ye=process.versions.modules,ve=!(!process.versions||!process.versions.electron)||!!process.env.ELECTRON_RUN_AS_NODE||"undefined"!=typeof window&&window.process&&"renderer"===window.process.type?"electron":"node",be=k.default.arch(),we=k.default.platform(),Se=process.env.LIBC||(function(e){return"linux"===e&&_.default.existsSync("/etc/alpine-release")}(we)?"musl":"glibc"),Ee=process.env.ARM_VERSION||("arm64"===be?"8":me.arm_version)||"",xe=(process.versions.uv||"").split(".")[0],ke=Oe;function Oe(e){return pe(Oe.path(e))}function Ce(e){try{return _.default.readdirSync(e)}catch(e){return[]}}function Ne(e,t){var s=Ce(e).filter(t);return s[0]&&p.default.join(e,s[0])}function Ie(e){return/\.node$/.test(e)}function Le(e){var t=e.split("-");if(2===t.length){var s=t[0],r=t[1].split("+");if(s&&r.length&&r.every(Boolean))return{name:e,platform:s,architectures:r}}}function Te(e,t){return function(s){return null!=s&&(s.platform===e&&s.architectures.includes(t))}}function Pe(e,t){return e.architectures.length-t.architectures.length}function Re(e){var t=e.split("."),s={file:e,specificity:0};if("node"===t.pop()){for(var r=0;r<t.length;r++){var n=t[r];if("node"===n||"electron"===n||"node-webkit"===n)s.runtime=n;else if("napi"===n)s.napi=!0;else if("abi"===n.slice(0,3))s.abi=n.slice(3);else if("uv"===n.slice(0,2))s.uv=n.slice(2);else if("armv"===n.slice(0,4))s.armv=n.slice(4);else{if("glibc"!==n&&"musl"!==n)continue;s.libc=n}s.specificity++}return s}}function Ue(e,t){return function(s){return null!=s&&(!(s.runtime!==e&&!function(e){return"node"===e.runtime&&e.napi}(s))&&(!(s.abi!==t&&!s.napi)&&((!s.uv||s.uv===xe)&&((!s.armv||s.armv===Ee)&&(!s.libc||s.libc===Se)))))}}function je(e){return function(t,s){return t.runtime!==s.runtime?t.runtime===e?-1:1:t.abi!==s.abi?t.abi?-1:1:t.specificity!==s.specificity?t.specificity>s.specificity?-1:1:0}}Oe.path=function(e){e=p.default.resolve(e||".");try{var t=pe(p.default.join(e,"package.json")).name.toUpperCase().replace(/-/g,"_");process.env[t+"_PREBUILD"]&&(e=process.env[t+"_PREBUILD"])}catch(e){}if(!ge){var s=Ne(p.default.join(e,"build/Release"),Ie);if(s)return s;var r=Ne(p.default.join(e,"build/Debug"),Ie);if(r)return r}var n=a(e);if(n)return n;var i=a(p.default.dirname(process.execPath));if(i)return i;var o=["platform="+we,"arch="+be,"runtime="+ve,"abi="+ye,"uv="+xe,Ee?"armv="+Ee:"","libc="+Se,"node="+process.versions.node,process.versions.electron?"electron="+process.versions.electron:"","function"==typeof __webpack_require__?"webpack=true":""].filter(Boolean).join(" ");throw new Error("No native build was found for "+o+"\n    loaded from: "+e+"\n");function a(e){var t=Ce(p.default.join(e,"prebuilds")).map(Le).filter(Te(we,be)).sort(Pe)[0];if(t){var s=p.default.join(e,"prebuilds",t.name),r=Ce(s).map(Re).filter(Ue(ve,ye)).sort(je(ve))[0];return r?p.default.join(s,r.file):void 0}}},Oe.parseTags=Re,Oe.matchTags=Ue,Oe.compareTags=je,Oe.parseTuple=Le,Oe.matchTuple=Te,Oe.compareTuples=Pe;var Be={mask:(e,t,s,r,n)=>{for(var i=0;i<n;i++)s[r+i]=e[i]^t[3&i]},unmask:(e,t)=>{const s=e.length;for(var r=0;r<s;r++)e[r]^=t[3&r]}},Ae=ue((function(e){try{e.exports=ke(__dirname)}catch(t){e.exports=Be}})),De=ue((function(e){const{EMPTY_BUFFER:t}=_e;function s(e,s){if(0===e.length)return t;if(1===e.length)return e[0];const r=Buffer.allocUnsafe(s);let n=0;for(let t=0;t<e.length;t++){const s=e[t];r.set(s,n),n+=s.length}return n<s?r.slice(0,n):r}function r(e,t,s,r,n){for(let i=0;i<n;i++)s[r+i]=e[i]^t[3&i]}function n(e,t){const s=e.length;for(let r=0;r<s;r++)e[r]^=t[3&r]}function i(e){return e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function o(e){if(o.readOnly=!0,Buffer.isBuffer(e))return e;let t;return e instanceof ArrayBuffer?t=Buffer.from(e):ArrayBuffer.isView(e)?t=Buffer.from(e.buffer,e.byteOffset,e.byteLength):(t=Buffer.from(e),o.readOnly=!1),t}try{const t=Ae,a=t.BufferUtil||t;e.exports={concat:s,mask(e,t,s,n,i){i<48?r(e,t,s,n,i):a.mask(e,t,s,n,i)},toArrayBuffer:i,toBuffer:o,unmask(e,t){e.length<32?n(e,t):a.unmask(e,t)}}}catch(t){e.exports={concat:s,mask:r,toArrayBuffer:i,toBuffer:o,unmask:n}}}));const Me=Symbol("kDone"),qe=Symbol("kRun");var We=class{constructor(e){this[Me]=()=>{this.pending--,this[qe]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[qe]()}[qe](){if(this.pending!==this.concurrency&&this.jobs.length){const e=this.jobs.shift();this.pending++,e(this[Me])}}};const{kStatusCode:Fe,NOOP:Ge}=_e,$e=Buffer.from([0,0,255,255]),ze=Symbol("permessage-deflate"),Ve=Symbol("total-length"),He=Symbol("callback"),Ye=Symbol("buffers"),Xe=Symbol("error");let Je;var Ke=class{constructor(e,t,s){if(this._maxPayload=0|s,this._options=e||{},this._threshold=void 0!==this._options.threshold?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!Je){const e=void 0!==this._options.concurrencyLimit?this._options.concurrencyLimit:10;Je=new We(e)}}static get extensionName(){return"permessage-deflate"}offer(){const e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){const e=this._deflate[He];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){const t=this._options,s=e.find(e=>!(!1===t.serverNoContextTakeover&&e.server_no_context_takeover||e.server_max_window_bits&&(!1===t.serverMaxWindowBits||"number"==typeof t.serverMaxWindowBits&&t.serverMaxWindowBits>e.server_max_window_bits)||"number"==typeof t.clientMaxWindowBits&&!e.client_max_window_bits));if(!s)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(s.server_no_context_takeover=!0),t.clientNoContextTakeover&&(s.client_no_context_takeover=!0),"number"==typeof t.serverMaxWindowBits&&(s.server_max_window_bits=t.serverMaxWindowBits),"number"==typeof t.clientMaxWindowBits?s.client_max_window_bits=t.clientMaxWindowBits:!0!==s.client_max_window_bits&&!1!==t.clientMaxWindowBits||delete s.client_max_window_bits,s}acceptAsClient(e){const t=e[0];if(!1===this._options.clientNoContextTakeover&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(t.client_max_window_bits){if(!1===this._options.clientMaxWindowBits||"number"==typeof this._options.clientMaxWindowBits&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"')}else"number"==typeof this._options.clientMaxWindowBits&&(t.client_max_window_bits=this._options.clientMaxWindowBits);return t}normalizeParams(e){return e.forEach(e=>{Object.keys(e).forEach(t=>{let s=e[t];if(s.length>1)throw new Error(`Parameter "${t}" must have only a single value`);if(s=s[0],"client_max_window_bits"===t){if(!0!==s){const e=+s;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${s}`);s=e}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${t}": ${s}`)}else if("server_max_window_bits"===t){const e=+s;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${s}`);s=e}else{if("client_no_context_takeover"!==t&&"server_no_context_takeover"!==t)throw new Error(`Unknown parameter "${t}"`);if(!0!==s)throw new TypeError(`Invalid value for parameter "${t}": ${s}`)}e[t]=s})}),e}decompress(e,t,s){Je.add(r=>{this._decompress(e,t,(e,t)=>{r(),s(e,t)})})}compress(e,t,s){Je.add(r=>{this._compress(e,t,(e,t)=>{r(),s(e,t)})})}_decompress(e,t,s){const r=this._isServer?"client":"server";if(!this._inflate){const e=r+"_max_window_bits",t="number"!=typeof this.params[e]?x.default.Z_DEFAULT_WINDOWBITS:this.params[e];this._inflate=x.default.createInflateRaw({...this._options.zlibInflateOptions,windowBits:t}),this._inflate[ze]=this,this._inflate[Ve]=0,this._inflate[Ye]=[],this._inflate.on("error",et),this._inflate.on("data",Ze)}this._inflate[He]=s,this._inflate.write(e),t&&this._inflate.write($e),this._inflate.flush(()=>{const e=this._inflate[Xe];if(e)return this._inflate.close(),this._inflate=null,void s(e);const n=De.concat(this._inflate[Ye],this._inflate[Ve]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[Ve]=0,this._inflate[Ye]=[],t&&this.params[r+"_no_context_takeover"]&&this._inflate.reset()),s(null,n)})}_compress(e,t,s){const r=this._isServer?"server":"client";if(!this._deflate){const e=r+"_max_window_bits",t="number"!=typeof this.params[e]?x.default.Z_DEFAULT_WINDOWBITS:this.params[e];this._deflate=x.default.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:t}),this._deflate[Ve]=0,this._deflate[Ye]=[],this._deflate.on("error",Ge),this._deflate.on("data",Qe)}this._deflate[He]=s,this._deflate.write(e),this._deflate.flush(x.default.Z_SYNC_FLUSH,()=>{if(!this._deflate)return;let e=De.concat(this._deflate[Ye],this._deflate[Ve]);t&&(e=e.slice(0,e.length-4)),this._deflate[He]=null,this._deflate[Ve]=0,this._deflate[Ye]=[],t&&this.params[r+"_no_context_takeover"]&&this._deflate.reset(),s(null,e)})}};function Qe(e){this[Ye].push(e),this[Ve]+=e.length}function Ze(e){this[Ve]+=e.length,this[ze]._maxPayload<1||this[Ve]<=this[ze]._maxPayload?this[Ye].push(e):(this[Xe]=new RangeError("Max payload size exceeded"),this[Xe].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[Xe][Fe]=1009,this.removeListener("data",Ze),this.reset())}function et(e){this[ze]._inflate=null,e[Fe]=1007,this[He](e)}var tt=function(e){const t=e.length;let s=0;for(;s<t;)if(0==(128&e[s]))s++;else if(192==(224&e[s])){if(s+1===t||128!=(192&e[s+1])||192==(254&e[s]))return!1;s+=2}else if(224==(240&e[s])){if(s+2>=t||128!=(192&e[s+1])||128!=(192&e[s+2])||224===e[s]&&128==(224&e[s+1])||237===e[s]&&160==(224&e[s+1]))return!1;s+=3}else{if(240!=(248&e[s]))return!1;if(s+3>=t||128!=(192&e[s+1])||128!=(192&e[s+2])||128!=(192&e[s+3])||240===e[s]&&128==(240&e[s+1])||244===e[s]&&e[s+1]>143||e[s]>244)return!1;s+=4}return!0},st=ue((function(e){try{e.exports=ke(__dirname)}catch(t){e.exports=tt}})),rt=ue((function(e){function t(e){return e>=1e3&&e<=1014&&1004!==e&&1005!==e&&1006!==e||e>=3e3&&e<=4999}function s(e){const t=e.length;let s=0;for(;s<t;)if(0==(128&e[s]))s++;else if(192==(224&e[s])){if(s+1===t||128!=(192&e[s+1])||192==(254&e[s]))return!1;s+=2}else if(224==(240&e[s])){if(s+2>=t||128!=(192&e[s+1])||128!=(192&e[s+2])||224===e[s]&&128==(224&e[s+1])||237===e[s]&&160==(224&e[s+1]))return!1;s+=3}else{if(240!=(248&e[s]))return!1;if(s+3>=t||128!=(192&e[s+1])||128!=(192&e[s+2])||128!=(192&e[s+3])||240===e[s]&&128==(240&e[s+1])||244===e[s]&&e[s+1]>143||e[s]>244)return!1;s+=4}return!0}try{let r=st;"object"==typeof r&&(r=r.Validation.isValidUTF8),e.exports={isValidStatusCode:t,isValidUTF8:e=>e.length<150?s(e):r(e)}}catch(r){e.exports={isValidStatusCode:t,isValidUTF8:s}}}));const{Writable:nt}=S.default,{BINARY_TYPES:it,EMPTY_BUFFER:ot,kStatusCode:at,kWebSocket:ct}=_e,{concat:lt,toArrayBuffer:ht,unmask:dt}=De,{isValidStatusCode:ut,isValidUTF8:ft}=rt;var _t=class extends nt{constructor(e,t,s,r){super(),this._binaryType=e||it[0],this[ct]=void 0,this._extensions=t||{},this._isServer=!!s,this._maxPayload=0|r,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._state=0,this._loop=!1}_write(e,t,s){if(8===this._opcode&&0==this._state)return s();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(s)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){const t=this._buffers[0];return this._buffers[0]=t.slice(e),t.slice(0,e)}const t=Buffer.allocUnsafe(e);do{const s=this._buffers[0],r=t.length-e;e>=s.length?t.set(this._buffers.shift(),r):(t.set(new Uint8Array(s.buffer,s.byteOffset,e),r),this._buffers[0]=s.slice(e)),e-=s.length}while(e>0);return t}startLoop(e){let t;this._loop=!0;do{switch(this._state){case 0:t=this.getInfo();break;case 1:t=this.getPayloadLength16();break;case 2:t=this.getPayloadLength64();break;case 3:this.getMask();break;case 4:t=this.getData(e);break;default:return void(this._loop=!1)}}while(this._loop);e(t)}getInfo(){if(this._bufferedBytes<2)return void(this._loop=!1);const e=this.consume(2);if(0!=(48&e[0]))return this._loop=!1,pt(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3");const t=64==(64&e[0]);if(t&&!this._extensions[Ke.extensionName])return this._loop=!1,pt(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(this._fin=128==(128&e[0]),this._opcode=15&e[0],this._payloadLength=127&e[1],0===this._opcode){if(t)return this._loop=!1,pt(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(!this._fragmented)return this._loop=!1,pt(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE");this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented)return this._loop=!1,pt(RangeError,"invalid opcode "+this._opcode,!0,1002,"WS_ERR_INVALID_OPCODE");this._compressed=t}else{if(!(this._opcode>7&&this._opcode<11))return this._loop=!1,pt(RangeError,"invalid opcode "+this._opcode,!0,1002,"WS_ERR_INVALID_OPCODE");if(!this._fin)return this._loop=!1,pt(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN");if(t)return this._loop=!1,pt(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(this._payloadLength>125)return this._loop=!1,pt(RangeError,"invalid payload length "+this._payloadLength,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH")}if(this._fin||this._fragmented||(this._fragmented=this._opcode),this._masked=128==(128&e[1]),this._isServer){if(!this._masked)return this._loop=!1,pt(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK")}else if(this._masked)return this._loop=!1,pt(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK");if(126===this._payloadLength)this._state=1;else{if(127!==this._payloadLength)return this.haveLength();this._state=2}}getPayloadLength16(){if(!(this._bufferedBytes<2))return this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength();this._loop=!1}getPayloadLength64(){if(this._bufferedBytes<8)return void(this._loop=!1);const e=this.consume(8),t=e.readUInt32BE(0);return t>Math.pow(2,21)-1?(this._loop=!1,pt(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH")):(this._payloadLength=t*Math.pow(2,32)+e.readUInt32BE(4),this.haveLength())}haveLength(){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0))return this._loop=!1,pt(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");this._masked?this._state=3:this._state=4}getMask(){this._bufferedBytes<4?this._loop=!1:(this._mask=this.consume(4),this._state=4)}getData(e){let t=ot;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength)return void(this._loop=!1);t=this.consume(this._payloadLength),this._masked&&dt(t,this._mask)}return this._opcode>7?this.controlMessage(t):this._compressed?(this._state=5,void this.decompress(t,e)):(t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage())}decompress(e,t){this._extensions[Ke.extensionName].decompress(e,this._fin,(e,s)=>{if(e)return t(e);if(s.length){if(this._messageLength+=s.length,this._messageLength>this._maxPayload&&this._maxPayload>0)return t(pt(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"));this._fragments.push(s)}const r=this.dataMessage();if(r)return t(r);this.startLoop(t)})}dataMessage(){if(this._fin){const e=this._messageLength,t=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],2===this._opcode){let s;s="nodebuffer"===this._binaryType?lt(t,e):"arraybuffer"===this._binaryType?ht(lt(t,e)):t,this.emit("message",s)}else{const s=lt(t,e);if(!ft(s))return this._loop=!1,pt(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");this.emit("message",s.toString())}}this._state=0}controlMessage(e){if(8===this._opcode)if(this._loop=!1,0===e.length)this.emit("conclude",1005,""),this.end();else{if(1===e.length)return pt(RangeError,"invalid payload length 1",!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH");{const t=e.readUInt16BE(0);if(!ut(t))return pt(RangeError,"invalid status code "+t,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");const s=e.slice(2);if(!ft(s))return pt(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");this.emit("conclude",t,s.toString()),this.end()}}else 9===this._opcode?this.emit("ping",e):this.emit("pong",e);this._state=0}};function pt(e,t,s,r,n){const i=new e(s?"Invalid WebSocket frame: "+t:t);return Error.captureStackTrace(i,pt),i.code=n,i[at]=r,i}const{randomFillSync:mt}=m.default,{EMPTY_BUFFER:gt}=_e,{isValidStatusCode:yt}=rt,{mask:vt,toBuffer:bt}=De,wt=Buffer.alloc(4);class St{constructor(e,t){this._extensions=t||{},this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._deflating=!1,this._queue=[]}static frame(e,t){const s=t.mask&&t.readOnly;let r=t.mask?6:2,n=e.length;e.length>=65536?(r+=8,n=127):e.length>125&&(r+=2,n=126);const i=Buffer.allocUnsafe(s?e.length+r:r);return i[0]=t.fin?128|t.opcode:t.opcode,t.rsv1&&(i[0]|=64),i[1]=n,126===n?i.writeUInt16BE(e.length,2):127===n&&(i.writeUInt32BE(0,2),i.writeUInt32BE(e.length,6)),t.mask?(mt(wt,0,4),i[1]|=128,i[r-4]=wt[0],i[r-3]=wt[1],i[r-2]=wt[2],i[r-1]=wt[3],s?(vt(e,wt,i,r,e.length),[i]):(vt(e,wt,e,0,e.length),[i,e])):[i,e]}close(e,t,s,r){let n;if(void 0===e)n=gt;else{if("number"!=typeof e||!yt(e))throw new TypeError("First argument must be a valid error code number");if(void 0===t||""===t)n=Buffer.allocUnsafe(2),n.writeUInt16BE(e,0);else{const s=Buffer.byteLength(t);if(s>123)throw new RangeError("The message must not be greater than 123 bytes");n=Buffer.allocUnsafe(2+s),n.writeUInt16BE(e,0),n.write(t,2)}}this._deflating?this.enqueue([this.doClose,n,s,r]):this.doClose(n,s,r)}doClose(e,t,s){this.sendFrame(St.frame(e,{fin:!0,rsv1:!1,opcode:8,mask:t,readOnly:!1}),s)}ping(e,t,s){const r=bt(e);if(r.length>125)throw new RangeError("The data size must not be greater than 125 bytes");this._deflating?this.enqueue([this.doPing,r,t,bt.readOnly,s]):this.doPing(r,t,bt.readOnly,s)}doPing(e,t,s,r){this.sendFrame(St.frame(e,{fin:!0,rsv1:!1,opcode:9,mask:t,readOnly:s}),r)}pong(e,t,s){const r=bt(e);if(r.length>125)throw new RangeError("The data size must not be greater than 125 bytes");this._deflating?this.enqueue([this.doPong,r,t,bt.readOnly,s]):this.doPong(r,t,bt.readOnly,s)}doPong(e,t,s,r){this.sendFrame(St.frame(e,{fin:!0,rsv1:!1,opcode:10,mask:t,readOnly:s}),r)}send(e,t,s){const r=bt(e),n=this._extensions[Ke.extensionName];let i=t.binary?2:1,o=t.compress;if(this._firstFragment?(this._firstFragment=!1,o&&n&&(o=r.length>=n._threshold),this._compress=o):(o=!1,i=0),t.fin&&(this._firstFragment=!0),n){const e={fin:t.fin,rsv1:o,opcode:i,mask:t.mask,readOnly:bt.readOnly};this._deflating?this.enqueue([this.dispatch,r,this._compress,e,s]):this.dispatch(r,this._compress,e,s)}else this.sendFrame(St.frame(r,{fin:t.fin,rsv1:!1,opcode:i,mask:t.mask,readOnly:bt.readOnly}),s)}dispatch(e,t,s,r){if(!t)return void this.sendFrame(St.frame(e,s),r);const n=this._extensions[Ke.extensionName];this._bufferedBytes+=e.length,this._deflating=!0,n.compress(e,s.fin,(t,n)=>{if(this._socket.destroyed){const e=new Error("The socket was closed while data was being compressed");"function"==typeof r&&r(e);for(let t=0;t<this._queue.length;t++){const s=this._queue[t][4];"function"==typeof s&&s(e)}}else this._bufferedBytes-=e.length,this._deflating=!1,s.readOnly=!1,this.sendFrame(St.frame(n,s),r),this.dequeue()})}dequeue(){for(;!this._deflating&&this._queue.length;){const e=this._queue.shift();this._bufferedBytes-=e[1].length,Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[1].length,this._queue.push(e)}sendFrame(e,t){2===e.length?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}}var Et=St;class xt{constructor(e,t){this.target=t,this.type=e}}class kt extends xt{constructor(e,t){super("message",t),this.data=e}}class Ot extends xt{constructor(e,t,s){super("close",s),this.wasClean=s._closeFrameReceived&&s._closeFrameSent,this.reason=t,this.code=e}}class Ct extends xt{constructor(e){super("open",e)}}class Nt extends xt{constructor(e,t){super("error",t),this.message=e.message,this.error=e}}var It={addEventListener(e,t,s){if("function"!=typeof t)return;function r(e){t.call(this,new kt(e,this))}function n(e,s){t.call(this,new Ot(e,s,this))}function i(e){t.call(this,new Nt(e,this))}function o(){t.call(this,new Ct(this))}const a=s&&s.once?"once":"on";"message"===e?(r._listener=t,this[a](e,r)):"close"===e?(n._listener=t,this[a](e,n)):"error"===e?(i._listener=t,this[a](e,i)):"open"===e?(o._listener=t,this[a](e,o)):this[a](e,t)},removeEventListener(e,t){const s=this.listeners(e);for(let r=0;r<s.length;r++)s[r]!==t&&s[r]._listener!==t||this.removeListener(e,s[r])}};const Lt=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function Tt(e,t,s){void 0===e[t]?e[t]=[s]:e[t].push(s)}var Pt={format:function(e){return Object.keys(e).map(t=>{let s=e[t];return Array.isArray(s)||(s=[s]),s.map(e=>[t].concat(Object.keys(e).map(t=>{let s=e[t];return Array.isArray(s)||(s=[s]),s.map(e=>!0===e?t:`${t}=${e}`).join("; ")})).join("; ")).join(", ")}).join(", ")},parse:function(e){const t=Object.create(null);if(void 0===e||""===e)return t;let s,r,n=Object.create(null),i=!1,o=!1,a=!1,c=-1,l=-1,h=0;for(;h<e.length;h++){const d=e.charCodeAt(h);if(void 0===s)if(-1===l&&1===Lt[d])-1===c&&(c=h);else if(32===d||9===d)-1===l&&-1!==c&&(l=h);else{if(59!==d&&44!==d)throw new SyntaxError("Unexpected character at index "+h);{if(-1===c)throw new SyntaxError("Unexpected character at index "+h);-1===l&&(l=h);const r=e.slice(c,l);44===d?(Tt(t,r,n),n=Object.create(null)):s=r,c=l=-1}}else if(void 0===r)if(-1===l&&1===Lt[d])-1===c&&(c=h);else if(32===d||9===d)-1===l&&-1!==c&&(l=h);else if(59===d||44===d){if(-1===c)throw new SyntaxError("Unexpected character at index "+h);-1===l&&(l=h),Tt(n,e.slice(c,l),!0),44===d&&(Tt(t,s,n),n=Object.create(null),s=void 0),c=l=-1}else{if(61!==d||-1===c||-1!==l)throw new SyntaxError("Unexpected character at index "+h);r=e.slice(c,h),c=l=-1}else if(o){if(1!==Lt[d])throw new SyntaxError("Unexpected character at index "+h);-1===c?c=h:i||(i=!0),o=!1}else if(a)if(1===Lt[d])-1===c&&(c=h);else if(34===d&&-1!==c)a=!1,l=h;else{if(92!==d)throw new SyntaxError("Unexpected character at index "+h);o=!0}else if(34===d&&61===e.charCodeAt(h-1))a=!0;else if(-1===l&&1===Lt[d])-1===c&&(c=h);else if(-1===c||32!==d&&9!==d){if(59!==d&&44!==d)throw new SyntaxError("Unexpected character at index "+h);{if(-1===c)throw new SyntaxError("Unexpected character at index "+h);-1===l&&(l=h);let o=e.slice(c,l);i&&(o=o.replace(/\\/g,""),i=!1),Tt(n,r,o),44===d&&(Tt(t,s,n),n=Object.create(null),s=void 0),r=void 0,c=l=-1}}else-1===l&&(l=h)}if(-1===c||a)throw new SyntaxError("Unexpected end of input");-1===l&&(l=h);const d=e.slice(c,l);return void 0===s?Tt(t,d,n):(void 0===r?Tt(n,d,!0):Tt(n,r,i?d.replace(/\\/g,""):d),Tt(t,s,n)),t}};const{randomBytes:Rt,createHash:Ut}=m.default,{URL:jt}=E.default,{BINARY_TYPES:Bt,EMPTY_BUFFER:At,GUID:Dt,kStatusCode:Mt,kWebSocket:qt,NOOP:Wt}=_e,{addEventListener:Ft,removeEventListener:Gt}=It,{format:$t,parse:zt}=Pt,{toBuffer:Vt}=De,Ht=["CONNECTING","OPEN","CLOSING","CLOSED"],Yt=[8,13];class Xt extends g.default{constructor(e,t,s){super(),this._binaryType=Bt[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage="",this._closeTimer=null,this._extensions={},this._protocol="",this._readyState=Xt.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,null!==e?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,Array.isArray(t)?t=t.join(", "):"object"==typeof t&&null!==t&&(s=t,t=void 0),function e(t,s,r,n){const i={protocolVersion:Yt[1],maxPayload:104857600,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...n,createConnection:void 0,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:void 0,host:void 0,path:void 0,port:void 0};if(!Yt.includes(i.protocolVersion))throw new RangeError(`Unsupported protocol version: ${i.protocolVersion} (supported versions: ${Yt.join(", ")})`);let o;s instanceof jt?(o=s,t._url=s.href):(o=new jt(s),t._url=s);const a="ws+unix:"===o.protocol;if(!(o.host||a&&o.pathname)){const e=new Error("Invalid URL: "+t.url);if(0===t._redirects)throw e;return void Kt(t,e)}const c="wss:"===o.protocol||"https:"===o.protocol,l=c?443:80,h=Rt(16).toString("base64"),d=c?y.default.get:v.default.get;let u;i.createConnection=c?Zt:Qt,i.defaultPort=i.defaultPort||l,i.port=o.port||l,i.host=o.hostname.startsWith("[")?o.hostname.slice(1,-1):o.hostname,i.headers={"Sec-WebSocket-Version":i.protocolVersion,"Sec-WebSocket-Key":h,Connection:"Upgrade",Upgrade:"websocket",...i.headers},i.path=o.pathname+o.search,i.timeout=i.handshakeTimeout,i.perMessageDeflate&&(u=new Ke(!0!==i.perMessageDeflate?i.perMessageDeflate:{},!1,i.maxPayload),i.headers["Sec-WebSocket-Extensions"]=$t({[Ke.extensionName]:u.offer()}));r&&(i.headers["Sec-WebSocket-Protocol"]=r);i.origin&&(i.protocolVersion<13?i.headers["Sec-WebSocket-Origin"]=i.origin:i.headers.Origin=i.origin);(o.username||o.password)&&(i.auth=`${o.username}:${o.password}`);if(a){const e=i.path.split(":");i.socketPath=e[0],i.path=e[1]}let f=t._req=d(i);i.timeout&&f.on("timeout",()=>{es(t,f,"Opening handshake has timed out")});f.on("error",e=>{null===f||f.aborted||(f=t._req=null,Kt(t,e))}),f.on("response",o=>{const a=o.headers.location,c=o.statusCode;if(a&&i.followRedirects&&c>=300&&c<400){if(++t._redirects>i.maxRedirects)return void es(t,f,"Maximum redirects exceeded");let o;f.abort();try{o=new jt(a,s)}catch(e){return void Kt(t,e)}e(t,o,r,n)}else t.emit("unexpected-response",f,o)||es(t,f,"Unexpected server response: "+o.statusCode)}),f.on("upgrade",(e,s,n)=>{if(t.emit("upgrade",e),t.readyState!==Xt.CONNECTING)return;f=t._req=null;const o=Ut("sha1").update(h+Dt).digest("base64");if(e.headers["sec-websocket-accept"]!==o)return void es(t,s,"Invalid Sec-WebSocket-Accept header");const a=e.headers["sec-websocket-protocol"],c=(r||"").split(/, */);let l;if(!r&&a?l="Server sent a subprotocol but none was requested":r&&!a?l="Server sent no subprotocol":a&&!c.includes(a)&&(l="Server sent an invalid subprotocol"),l)return void es(t,s,l);a&&(t._protocol=a);const d=e.headers["sec-websocket-extensions"];if(void 0!==d){if(!u){return void es(t,s,"Server sent a Sec-WebSocket-Extensions header but no extension was requested")}let e;try{e=zt(d)}catch(e){return void es(t,s,"Invalid Sec-WebSocket-Extensions header")}const r=Object.keys(e);if(r.length){if(1!==r.length||r[0]!==Ke.extensionName){return void es(t,s,"Server indicated an extension that was not requested")}try{u.accept(e[Ke.extensionName])}catch(e){return void es(t,s,"Invalid Sec-WebSocket-Extensions header")}t._extensions[Ke.extensionName]=u}}t.setSocket(s,n,i.maxPayload)})}(this,e,t,s)):this._isServer=!0}get binaryType(){return this._binaryType}set binaryType(e){Bt.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get onclose(){}set onclose(e){}get onerror(){}set onerror(e){}get onopen(){}set onopen(e){}get onmessage(){}set onmessage(e){}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,s){const r=new _t(this.binaryType,this._extensions,this._isServer,s);this._sender=new Et(e,this._extensions),this._receiver=r,this._socket=e,r[qt]=this,e[qt]=this,r.on("conclude",ss),r.on("drain",rs),r.on("error",ns),r.on("message",os),r.on("ping",as),r.on("pong",cs),e.setTimeout(0),e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",hs),e.on("data",ds),e.on("end",us),e.on("error",fs),this._readyState=Xt.OPEN,this.emit("open")}emitClose(){if(!this._socket)return this._readyState=Xt.CLOSED,void this.emit("close",this._closeCode,this._closeMessage);this._extensions[Ke.extensionName]&&this._extensions[Ke.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=Xt.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==Xt.CLOSED){if(this.readyState===Xt.CONNECTING){const e="WebSocket was closed before the connection was established";return es(this,this._req,e)}this.readyState!==Xt.CLOSING?(this._readyState=Xt.CLOSING,this._sender.close(e,t,!this._isServer,e=>{e||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())}),this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),3e4)):this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end()}}ping(e,t,s){if(this.readyState===Xt.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(s=e,e=t=void 0):"function"==typeof t&&(s=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===Xt.OPEN?(void 0===t&&(t=!this._isServer),this._sender.ping(e||At,t,s)):ts(this,e,s)}pong(e,t,s){if(this.readyState===Xt.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(s=e,e=t=void 0):"function"==typeof t&&(s=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===Xt.OPEN?(void 0===t&&(t=!this._isServer),this._sender.pong(e||At,t,s)):ts(this,e,s)}send(e,t,s){if(this.readyState===Xt.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof t&&(s=t,t={}),"number"==typeof e&&(e=e.toString()),this.readyState!==Xt.OPEN)return void ts(this,e,s);const r={binary:"string"!=typeof e,mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[Ke.extensionName]||(r.compress=!1),this._sender.send(e||At,r,s)}terminate(){if(this.readyState!==Xt.CLOSED){if(this.readyState===Xt.CONNECTING){const e="WebSocket was closed before the connection was established";return es(this,this._req,e)}this._socket&&(this._readyState=Xt.CLOSING,this._socket.destroy())}}}Object.defineProperty(Xt,"CONNECTING",{enumerable:!0,value:Ht.indexOf("CONNECTING")}),Object.defineProperty(Xt.prototype,"CONNECTING",{enumerable:!0,value:Ht.indexOf("CONNECTING")}),Object.defineProperty(Xt,"OPEN",{enumerable:!0,value:Ht.indexOf("OPEN")}),Object.defineProperty(Xt.prototype,"OPEN",{enumerable:!0,value:Ht.indexOf("OPEN")}),Object.defineProperty(Xt,"CLOSING",{enumerable:!0,value:Ht.indexOf("CLOSING")}),Object.defineProperty(Xt.prototype,"CLOSING",{enumerable:!0,value:Ht.indexOf("CLOSING")}),Object.defineProperty(Xt,"CLOSED",{enumerable:!0,value:Ht.indexOf("CLOSED")}),Object.defineProperty(Xt.prototype,"CLOSED",{enumerable:!0,value:Ht.indexOf("CLOSED")}),["binaryType","bufferedAmount","extensions","protocol","readyState","url"].forEach(e=>{Object.defineProperty(Xt.prototype,e,{enumerable:!0})}),["open","error","close","message"].forEach(e=>{Object.defineProperty(Xt.prototype,"on"+e,{enumerable:!0,get(){const t=this.listeners(e);for(let e=0;e<t.length;e++)if(t[e]._listener)return t[e]._listener},set(t){const s=this.listeners(e);for(let t=0;t<s.length;t++)s[t]._listener&&this.removeListener(e,s[t]);this.addEventListener(e,t)}})}),Xt.prototype.addEventListener=Ft,Xt.prototype.removeEventListener=Gt;var Jt=Xt;function Kt(e,t){e._readyState=Xt.CLOSING,e.emit("error",t),e.emitClose()}function Qt(e){return e.path=e.socketPath,b.default.connect(e)}function Zt(e){return e.path=void 0,e.servername||""===e.servername||(e.servername=b.default.isIP(e.host)?"":e.host),w.default.connect(e)}function es(e,t,s){e._readyState=Xt.CLOSING;const r=new Error(s);Error.captureStackTrace(r,es),t.setHeader?(t.abort(),t.socket&&!t.socket.destroyed&&t.socket.destroy(),t.once("abort",e.emitClose.bind(e)),e.emit("error",r)):(t.destroy(r),t.once("error",e.emit.bind(e,"error")),t.once("close",e.emitClose.bind(e)))}function ts(e,t,s){if(t){const s=Vt(t).length;e._socket?e._sender._bufferedBytes+=s:e._bufferedAmount+=s}if(s){s(new Error(`WebSocket is not open: readyState ${e.readyState} (${Ht[e.readyState]})`))}}function ss(e,t){const s=this[qt];s._closeFrameReceived=!0,s._closeMessage=t,s._closeCode=e,void 0!==s._socket[qt]&&(s._socket.removeListener("data",ds),process.nextTick(ls,s._socket),1005===e?s.close():s.close(e,t))}function rs(){this[qt]._socket.resume()}function ns(e){const t=this[qt];void 0!==t._socket[qt]&&(t._socket.removeListener("data",ds),process.nextTick(ls,t._socket),t.close(e[Mt])),t.emit("error",e)}function is(){this[qt].emitClose()}function os(e){this[qt].emit("message",e)}function as(e){const t=this[qt];t.pong(e,!t._isServer,Wt),t.emit("ping",e)}function cs(e){this[qt].emit("pong",e)}function ls(e){e.resume()}function hs(){const e=this[qt];let t;this.removeListener("close",hs),this.removeListener("data",ds),this.removeListener("end",us),e._readyState=Xt.CLOSING,this._readableState.endEmitted||e._closeFrameReceived||e._receiver._writableState.errorEmitted||null===(t=e._socket.read())||e._receiver.write(t),e._receiver.end(),this[qt]=void 0,clearTimeout(e._closeTimer),e._receiver._writableState.finished||e._receiver._writableState.errorEmitted?e.emitClose():(e._receiver.on("error",is),e._receiver.on("finish",is))}function ds(e){this[qt]._receiver.write(e)||this.pause()}function us(){const e=this[qt];e._readyState=Xt.CLOSING,e._receiver.end(),this.end()}function fs(){const e=this[qt];this.removeListener("error",fs),this.on("error",Wt),e&&(e._readyState=Xt.CLOSING,this.destroy())}const{Duplex:_s}=S.default;function ps(e){e.emit("close")}function ms(){!this.destroyed&&this._writableState.finished&&this.destroy()}function gs(e){this.removeListener("error",gs),this.destroy(),0===this.listenerCount("error")&&this.emit("error",e)}var ys=function(e,t){let s=!0,r=!0;function n(){s&&e._socket.resume()}e.readyState===e.CONNECTING?e.once("open",(function(){e._receiver.removeAllListeners("drain"),e._receiver.on("drain",n)})):(e._receiver.removeAllListeners("drain"),e._receiver.on("drain",n));const i=new _s({...t,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return e.on("message",(function(t){i.push(t)||(s=!1,e._socket.pause())})),e.once("error",(function(e){i.destroyed||(r=!1,i.destroy(e))})),e.once("close",(function(){i.destroyed||i.push(null)})),i._destroy=function(t,s){if(e.readyState===e.CLOSED)return s(t),void process.nextTick(ps,i);let n=!1;e.once("error",(function(e){n=!0,s(e)})),e.once("close",(function(){n||s(t),process.nextTick(ps,i)})),r&&e.terminate()},i._final=function(t){e.readyState!==e.CONNECTING?null!==e._socket&&(e._socket._writableState.finished?(t(),i._readableState.endEmitted&&i.destroy()):(e._socket.once("finish",(function(){t()})),e.close())):e.once("open",(function(){i._final(t)}))},i._read=function(){e.readyState!==e.OPEN&&e.readyState!==e.CLOSING||s||(s=!0,e._receiver._writableState.needDrain||e._socket.resume())},i._write=function(t,s,r){e.readyState!==e.CONNECTING?e.send(t,r):e.once("open",(function(){i._write(t,s,r)}))},i.on("end",ms),i.on("error",gs),i};const{createHash:vs}=m.default,{format:bs,parse:ws}=Pt,{GUID:Ss,kWebSocket:Es}=_e,xs=/^[+/0-9A-Za-z]{22}==$/;class ks extends g.default{constructor(e,t){if(super(),null==(e={maxPayload:104857600,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,...e}).port&&!e.server&&!e.noServer||null!=e.port&&(e.server||e.noServer)||e.server&&e.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(null!=e.port?(this._server=v.default.createServer((e,t)=>{const s=v.default.STATUS_CODES[426];t.writeHead(426,{"Content-Length":s.length,"Content-Type":"text/plain"}),t.end(s)}),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server){const e=this.emit.bind(this,"connection");this._removeListeners=function(e,t){for(const s of Object.keys(t))e.on(s,t[s]);return function(){for(const s of Object.keys(t))e.removeListener(s,t[s])}}(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(t,s,r)=>{this.handleUpgrade(t,s,r,e)}})}!0===e.perMessageDeflate&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set),this.options=e,this._state=0}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(e&&this.once("close",e),2===this._state)return void process.nextTick(Cs,this);if(1===this._state)return;if(this._state=1,this.clients)for(const e of this.clients)e.terminate();const t=this._server;t&&(this._removeListeners(),this._removeListeners=this._server=null,null!=this.options.port)?t.close(Cs.bind(void 0,this)):process.nextTick(Cs,this)}shouldHandle(e){if(this.options.path){const t=e.url.indexOf("?");if((-1!==t?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,s,r){t.on("error",Ns);const n=void 0!==e.headers["sec-websocket-key"]&&e.headers["sec-websocket-key"].trim(),i=+e.headers["sec-websocket-version"],o={};if("GET"!==e.method||"websocket"!==e.headers.upgrade.toLowerCase()||!n||!xs.test(n)||8!==i&&13!==i||!this.shouldHandle(e))return Is(t,400);if(this.options.perMessageDeflate){const s=new Ke(this.options.perMessageDeflate,!0,this.options.maxPayload);try{const t=ws(e.headers["sec-websocket-extensions"]);t[Ke.extensionName]&&(s.accept(t[Ke.extensionName]),o[Ke.extensionName]=s)}catch(e){return Is(t,400)}}if(this.options.verifyClient){const a={origin:e.headers[""+(8===i?"sec-websocket-origin":"origin")],secure:!(!e.socket.authorized&&!e.socket.encrypted),req:e};if(2===this.options.verifyClient.length)return void this.options.verifyClient(a,(i,a,c,l)=>{if(!i)return Is(t,a||401,c,l);this.completeUpgrade(n,o,e,t,s,r)});if(!this.options.verifyClient(a))return Is(t,401)}this.completeUpgrade(n,o,e,t,s,r)}completeUpgrade(e,t,s,r,n,i){if(!r.readable||!r.writable)return r.destroy();if(r[Es])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>0)return Is(r,503);const o=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Accept: "+vs("sha1").update(e+Ss).digest("base64")],a=new Jt(null);let c=s.headers["sec-websocket-protocol"];if(c&&(c=c.split(",").map(Ls),c=this.options.handleProtocols?this.options.handleProtocols(c,s):c[0],c&&(o.push("Sec-WebSocket-Protocol: "+c),a._protocol=c)),t[Ke.extensionName]){const e=t[Ke.extensionName].params,s=bs({[Ke.extensionName]:[e]});o.push("Sec-WebSocket-Extensions: "+s),a._extensions=t}this.emit("headers",o,s),r.write(o.concat("\r\n").join("\r\n")),r.removeListener("error",Ns),a.setSocket(r,n,this.options.maxPayload),this.clients&&(this.clients.add(a),a.on("close",()=>this.clients.delete(a))),i(a,s)}}var Os=ks;function Cs(e){e._state=2,e.emit("close")}function Ns(){this.destroy()}function Is(e,t,s,r){e.writable&&(s=s||v.default.STATUS_CODES[t],r={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(s),...r},e.write(`HTTP/1.1 ${t} ${v.default.STATUS_CODES[t]}\r\n`+Object.keys(r).map(e=>`${e}: ${r[e]}`).join("\r\n")+"\r\n\r\n"+s)),e.removeListener("error",Ns),e.destroy()}function Ls(e){return e.trim()}Jt.createWebSocketStream=ys,Jt.Server=Os,Jt.Receiver=_t,Jt.Sender=Et;var Ts=Jt;class Ps extends r.EventEmitter{_setupSocket(e){this._ws=e,this._initEvent()}_initEvent(){const e=["open","message","close","error"];for(let t=0;t<e.length;t++){const s=e[t];this["on"+s.replace(/^(\w)/,(function(e){return e.toUpperCase()}))]=function(e){this.on(s,e)}}this._ws.on("open",()=>{this.emit("open")}),this._ws.on("message",e=>{this.emit("message",{data:e})}),this._ws.on("error",e=>{this.emit("error",{errMsg:e.message})}),this._ws.on("close",(e,t)=>{this.emit("close",{code:e,reason:Buffer.isBuffer(t)?t.toString("utf8"):t})})}send({data:e}={}){return u.promisify(this._ws.send).call(this._ws,e)}close({code:e=1e3,reason:t}={}){this._ws.close(e,t)}}function Rs({url:e,header:t={},protocols:s}={}){const r=new Ts(e,s,{finishRequest:function(e,s){for(const s in t)e.setHeader(s,t[s]);e.end()}}),n=new Ps;return n._setupSocket(r),n}async function Us({url:e,method:t="GET",data:s,header:r={},dataType:n="json",responseType:i="text",timeout:o=6e4,sslVerify:a=!0}={}){const l={method:t,headers:r,timeout:o,followRedirect:!0},h=t.toLowerCase();l.dataType="text"!==i?"":"json"===n?"json":"text",a||(l.rejectUnauthorized=!1);let d=r[Object.keys(r).find(e=>"content-type"===e.toLowerCase())]||"";if("get"===h)l.dataAsQueryString=!0,l.data=s;else if(s instanceof c.Readable)l.stream=s;else if("post"===h){d||(r["Content-Type"]=d="application/json");const e=d.split(";")[0];if("object"!==I(s))l.content=s;else if("application/json"===e)l.content=JSON.stringify(s);else if("application/x-www-form-urlencoded"===e){const e=[];for(const t in s)e.push(encodeURIComponent(t)+"="+encodeURIComponent(s[t]));l.content=e.join("&")}else l.content=s}else s&&(l.content=s);const u=await uniCloud.httpclient.request(e,l),{status:f,headers:_,data:p}=u;return{statusCode:f,header:_,data:p}}function js(e={}){this.$provider="alipay",this.$options=e,this.$context=e.context||global.__ctx__,function(e){e.$options.spaceId&&(e.$options.envId=e.$options.spaceId);const t=new R.Cloud;t.init(e.$options),e.$scope=t}(this),function(e){e.auth=C("auth"),e.customAuth=e.auth}(this),function(e){const t=e.$scope;U.forEach(({name:s,resultHandler:r})=>{e[s]=function(...e){return t[s].apply(t,e).then(e=>(delete e.requestID,r?r(e):e)).catch(e=>{const t=e.error||{};return new O({code:t.code||e.errCode,message:t.message||e.errMsg,requestId:t.requestID||e.requestID||e.requestId})})}})}(this),function(e){const t=global.console;function s(e){return function(...s){return t[e]({[e]:B(s)})}}e.logger={log:s("log"),info:s("info"),warn:s("warn"),error:s("error")}}(this),function(e){e.database=function(t){t&&t.spaceId&&(t.env=t.spaceId);const s=e.$scope.database(Object.assign({},t,{throwOnNotFound:!1})),r=s.runTransaction;return s.runTransaction=function(e){r(t=>{e(V(t,W.database.runTransaction))})},V(s,W.database)}}(this),function(e){e.callFunction=function({name:t,data:s}){return e.$scope.callFunction({name:t,data:s}).then(e=>(e.errCode=0,e.requestId=e.requestID||e.requestId,delete e.requestID,e)).catch(e=>new O({code:e.errCode,message:e.errMsg,requestId:e.requestID||e.requestId}))}}(this),function(e){let t;Object.defineProperty(e,"httpclient",{get:function(){return t||(t=require("urllib").create()),t}})}(this),function(e){e.httpProxyClient=C("httpProxyClient")}(this),function(e){const t=Object.getPrototypeOf(e);t.initI18n=se,t.importObject=re,t.getCloudInfos=oe,t.getClientInfos=ae,t.getRequestList=ce,t.getHttpInfoByRequestId=le,t.deserializeSSEChannel=de,t.connectSocket=Rs,t.request=Us}(this)}js.prototype.init=function(e){return"tencent"===uniCloud.$provider&&e.context&&!e.spaceId?this:new js(e)},module.exports=js;

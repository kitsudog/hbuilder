"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.tryCatchJSONParse=exports.mergeIndexData=exports.loadOldIndexDataFromPath=exports.loadNewIndexDataFromPath=exports.iterateGetReference=exports.iterateGetBackReference=exports.getObjectSize=exports.filterIndexData=exports.deleteSaveObjectItem=exports.assemblyKindData=void 0;const fs=require("fs-extra"),path=require("path"),vscode_uri_1=require("vscode-uri"),indexDataType_1=require("./indexDataType");function pGetType(e){const t=typeof e;return"object"!==t?t:Object.prototype.toString.call(e).replace(/^\[object (\S+)\]$/,"$1")}function pObjToMap(e){let t=new Map;return"object"==typeof e&&(t=new Map(Object.entries(e))),t}function pUriToPath(e){return vscode_uri_1.URI.parse(e).fsPath.replace(/\\/g,"/")}function pNoTsToNormalizedPath(e){let t=e,r=e;e.startsWith("file:/")||(t=vscode_uri_1.URI.file(e).toString());try{r=vscode_uri_1.URI.parse(t).fsPath}catch(e){return}return r=r.replace(/\\/g,"/"),r}function pNoTsToNormalizedUri(e){let t=e;return e.startsWith("file:/")||(t=vscode_uri_1.URI.file(e).toString()),t}function mergeIndexData(e){if(0===e.length)return;if(1===e.length)return e[0];let t={canonicalVersion:"",projectVersion:0,projectUri:"",kindMap:new Map};return e.forEach((e=>{if(""===t.canonicalVersion)t=e;else for(const r of e.kindMap.keys()){let n=e.kindMap.get(r);if(n){if(t.kindMap.has(r)){let e=t.kindMap.get(r);e&&(n=mergeFileData(e,n))}t.kindMap.set(r,n)}}})),t}function mergeFileData(e,t){for(const r of t.keys())if(e.has(r)){const n=e.get(r);if(!n)continue;const a=t.get(r);if(!a)continue;n.fileVersion=a.fileVersion,n.indexValues.push(...a.indexValues),e.set(r,n)}else{const n=t.get(r);if(!n)continue;e.set(r,n)}return e}function loadNewIndexDataFromPath(e){if(!fs.existsSync(e))return;const t=fs.readdirSync(e);if(0===t.length)return;let r=[];return t.forEach((t=>{const n=path.join(e,t);if(!fs.existsSync(n))return;const a=tryCatchJSONParse(fs.readFileSync(n,{encoding:"utf-8"}));if(!a)return;const i={canonicalVersion:a.canonicalVersion,projectVersion:0,projectUri:a.projectUri,kindMap:new Map};let o=a.data;"Object"===pGetType(o)&&(o=pObjToMap(o)),i.kindMap.set(t,o),r.push(i)})),mergeIndexData(r)}function loadOldIndexDataFromPath(e,t){const r=["html.class","html.id","color"],n=["CLASS","ID","COLOR"],a=tryCatchJSONParse(fs.readFileSync(t,{encoding:"utf-8"}));if(!a)return;const i={canonicalVersion:`${indexDataType_1.VersionPrefix}20221209`,projectVersion:0,projectUri:e,kindMap:new Map};for(let e in a){const t=a[e],o=pNoTsToNormalizedUri(e);if(o)for(let e=0;e<r.length;e++){if(!t[r[e]])continue;const a=new Map,s=[];t[r[e]].forEach((e=>{const t={value:e.label,lineText:e.label};s.push(t)}));const c={fileVersion:"0",indexValues:s};a.set(o,c),i.kindMap.set(n[e],a)}}return 0!==i.kindMap.size?i:void 0}function loadIndexDataFromFileUri(e,t,r){const n=new Map;if(r.forEach((r=>{const a=e.kindMap.get(r);if(!a)return;const i=new Map;a.forEach(((e,r)=>{r===t&&i.set(r,e)})),0!==i.size&&n.set(r,i)})),0!==n.size)return n}function iterateGetReference(e,t,r){if(!e)return new Map;const n=[];return t.forEach((t=>{if(r.has(t))return;if(!e.kindMap.has("REF"))return;const a=e.kindMap.get("REF");if(!a)return;if(!a.has(t))return;const i=a.get(t);if(!i)return;let o=[];i.indexValues.forEach((e=>{const t=pNoTsToNormalizedUri(e.value);t&&(o.push(t),n.push(t))})),r.set(t,o)})),n.length>0&&iterateGetReference(e,n,r),r}function iterateGetBackReference(e,t,r){if(!e)return new Map;const n=[];return t.forEach((t=>{const a=pUriToPath(t);if(r.has(t))return;if(!e.kindMap.has("REF"))return;const i=e.kindMap.get("REF");if(!i)return;let o=[];for(const e of i.keys()){if(!i.has(e))continue;const t=i.get(e);t&&t.indexValues.forEach((t=>{t.value.toLocaleLowerCase()===a.toLocaleLowerCase()&&(o.push(e),n.push(e))}))}r.set(t,o)})),n.length>0&&iterateGetBackReference(e,n,r),r}function iterateGetAllReference(e,t){if(!e)return new Map;let r=new Map,n=new Map;r=iterateGetReference(e,t,new Map),n=iterateGetBackReference(e,t,new Map);return mergeReferenceList(r,n)}function mergeReferenceList(e,t){for(const r of t.keys())if(e.has(r)){const n=e.get(r);if(!n)continue;const a=t.get(r);if(!a)continue;n.push(...a),e.set(r,n)}else{const n=t.get(r);if(!n)continue;e.set(r,n)}return e}function assemblyKindData(e,t,r){const n={canonicalVersion:indexDataType_1.CanonicalVersion,projectVersion:0,projectUri:t,kindMap:new Map},a=pUriToPath(r);let i="0";if(fs.existsSync(a)&&!a.includes("vue.")){i=fs.statSync(a).mtime.toISOString()}for(const t of e.keys()){const a=new Map;if(!e.has(t))continue;const o=e.get(t);if(!o||0===o.length)continue;const s={fileVersion:i,indexValues:o};a.set(r,s),n.kindMap.set(t,a)}return n}function supportedPrefix(e,t,r=!1){let n=t.prefixText,a=e.value;r||(n=n.toLowerCase(),a=a.toLowerCase());let i=0;for(let e=0;e<n.length;e++){const t=n.charAt(e);if(i=a.indexOf(t,i),-1===i)return!1;i++}return!0}function filterIndexValue(e,t){const r=e.excludeFileUris,n=e.limit,a=e.fields,i=e.distinct,o=e.prefix;let s=new Map;const c=new Set;let f=0;return t.forEach(((e,t)=>{if(n&&f>n)return;const l={fileVersion:e.fileVersion,indexValues:[]},u=[];r&&0!==r.length&&r.includes(t)||(e.indexValues.forEach((e=>{if(o){if(!supportedPrefix(e,o))return}if(!(n&&f>n)){if(i){if(c.has(e.value))return;c.add(e.value)}if(f++,a){const t={value:e.value};a.forEach((r=>{switch(r){case"lineText":t.lineText=e.lineText;break;case"kind":t.kind=e.kind;break;case"range":t.range=e.range;break;case"context":t.context=e.context;break;case"describe":t.describe=e.describe;break;case"easyComPath":t.easyComPath=e.easyComPath;break;case"platforms":t.platforms=e.platforms}})),u.push(t)}else u.push(e)}})),l.indexValues=u,s.set(t,l))})),s}function filterIndexData(e,t){const r=e.kind,n=e.fileUri;if(!t.kindMap.has(r))return;const a=t.kindMap.get(r);if(!a)return;const i={canonicalVersion:t.canonicalVersion,projectVersion:t.projectVersion,projectUri:t.projectUri,kindMap:new Map};let o=new Map;if(n){if(!a.has(n))return;const e=a.get(n);if(!e)return;o.set(n,e)}else o=a;const s=filterIndexValue(e,o);return i.kindMap.set(r,s),i}function getObjectSize(e){let t=0;for(const[t,a]of Object.entries(e))r(t),n(a);function r(e){try{t+=Buffer.byteLength(e,"utf8")}catch(e){throw console.error(e),new Error("字符串超出了JavaScript限制")}}function n(e){const r=typeof e;if("object"===r){if(Array.isArray(e))e.forEach((e=>{n(e)}));else{const r=getObjectSize(e);t+=r}}else if("string"===r)try{t+=Buffer.byteLength(e,"utf8")}catch(e){throw console.error(e),new Error("字符串超出了JavaScript限制")}else"number"===r?t+=8:"boolean"===r&&(t+=4)}return t}function deleteSaveObjectItem(e){Object.entries(e).forEach((([t,r])=>{"object"==typeof r&&Object.entries(r).forEach((([t,r])=>{"object"==typeof r&&Object.entries(r).forEach((([t,r])=>{let n=!1;Array.isArray(r)&&r.forEach((t=>{if(n)return;const a=getObjectSize(e),i=267386880;if(a>i){const e=(a-i)/(a/r.length);for(let t=0;t<e;t++)r.pop()}else n=!0}))}))}))}))}function tryCatchJSONParse(e){let t;try{t=JSON.parse(e)}catch(e){console.error("[IndexLib] JSONParse Error!")}return t}exports.mergeIndexData=mergeIndexData,exports.loadNewIndexDataFromPath=loadNewIndexDataFromPath,exports.loadOldIndexDataFromPath=loadOldIndexDataFromPath,exports.iterateGetReference=iterateGetReference,exports.iterateGetBackReference=iterateGetBackReference,exports.assemblyKindData=assemblyKindData,exports.filterIndexData=filterIndexData,exports.getObjectSize=getObjectSize,exports.deleteSaveObjectItem=deleteSaveObjectItem,exports.tryCatchJSONParse=tryCatchJSONParse;
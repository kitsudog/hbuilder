"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getRefSortLevel=exports.matchAll=exports.deepAssign=exports.toNormalizedUri=exports.toNormalizedPath=exports.readFileToString=exports.isSameTextSpan=exports.getRootPathRecursively=exports.getExtensionRootPath=exports.getAppDataPath=exports.getRealFileNameFromVirtualFile=exports.cloneDeep=void 0;const fs=require("fs-extra"),path=require("path"),vscode_uri_1=require("vscode-uri"),tsapi_1=require("../tsapi"),lspUtil_1=require("./lspUtil"),pathUtils_1=require("./pathUtils"),indexlib_1=require("../indexlib"),lspIndexUtils_1=require("./lspIndexUtils");function getExtensionRootPath(){return path.resolve(__dirname,"../../../")}function getAppDataPath(e){return(0,lspUtil_1.getSysArgsData)(e,"--vscodeEnvAppData")}function readFileWorker(e,t){let r;try{r=fs.readFileSync(e)}catch(e){return}let o=r.length;if(o>=2&&254===r[0]&&255===r[1]){o&=-2;for(let e=0;e<o;e+=2){const t=r[e];r[e]=r[e+1],r[e+1]=t}return r.toString("utf16le",2)}return o>=2&&255===r[0]&&254===r[1]?r.toString("utf16le",2):o>=3&&239===r[0]&&187===r[1]&&191===r[2]?r.toString("utf8",3):r.toString("utf8")}function readFileToString(e){return readFileWorker(e)}function toNormalizedPath(e,t){return tsapi_1.ts.server.toNormalizedPath(e)}function toNormalizedUri(e,t){if(e.startsWith("file:/")){let t=toNormalizedPath(vscode_uri_1.URI.parse(e).fsPath,tsapi_1.ts);return vscode_uri_1.URI.file(t).toString()}let r=toNormalizedPath(e,tsapi_1.ts);return vscode_uri_1.URI.file(r).toString()}function isSameTextSpan(e,t){return!(!e||!t)&&(e.start===t.start&&e.length===t.length)}function getRootPathRecursively(e){if(1===e.length){const t=e[0].lastIndexOf("/");if(t<0)return"";return e[0].substring(0,t)}if(0===(e=e.filter((e=>""!==e))).length)return"";e.sort(((e,t)=>e.length-t.length));const t=e[0].length;return 1!==(e=e.filter((e=>e.length===t))).length&&(e=e.map((e=>{const t=e.lastIndexOf("/");if(t<0)return"";return e.substring(0,t)}))),getRootPathRecursively(e)}function getRealFileNameFromVirtualFile(e){let t=(0,pathUtils_1.noTsToNormalizedUri)(e);if(t)return t.includes(".vue.")&&(t=t.replace(/\.vue\.(.*)/,".vue")),t.includes(".nvue.")&&(t=t.replace(/\.nvue\.(.*)/,".nvue")),t.includes(".uvue.")&&(t=t.replace(/\.uvue\.(.*)/,".uvue")),t}function deepAssign(e,t){if(!e||!t)return e||t;if("object"!=typeof e&&"object"!=typeof t)return t;let r=Object.prototype.toString.call(e),o=Object.prototype.toString.call(t);if("[object Object]"===r&&"[object Object]"===o){let r={};return new Set([...Object.keys(e),...Object.keys(t)]).forEach((o=>{r[o]=deepAssign(e[o],t[o])})),r}return"[object Array]"===r&&"[object Array]"===o?[...e,...t]:t}function matchAll(e,t){const r=[];if(-1==t.flags.indexOf("g"))return r;let o;for(;o=t.exec(e);)r.push(o);return r}async function getRefSortLevel(e,t,r){const o=new Map;t.forEach((e=>{const t=(0,pathUtils_1.noTsToNormalizedUri)(e);if(!t)return;o.set(t,"a");const r=getRealFileNameFromVirtualFile(t);r&&t!==r&&o.set(r,"a")}));const i=(0,indexlib_1.iterateGetReference)(e,t,new Map),s=(0,lspIndexUtils_1.getReferenceList)(i);s&&s.forEach((e=>{const t=(0,pathUtils_1.noTsToNormalizedUri)(e);t&&o.set(t,"b")}));const n=(0,pathUtils_1.noTsToNormalizedUri)(path.join(r,"App.vue")),a=(0,pathUtils_1.noTsToNormalizedUri)(path.join(r,"App.uvue")),l=(0,pathUtils_1.noTsToNormalizedUri)(path.join(r,"uni.scss")),p=[];n&&(o.set(n,"c"),p.push(n)),a&&(o.set(a,"c"),p.push(a)),l&&(o.set(l,"c"),p.push(l));const u=(0,indexlib_1.iterateGetReference)(e,p,new Map),c=(0,lspIndexUtils_1.getReferenceList)(u);return c&&c.forEach((e=>{const t=(0,pathUtils_1.noTsToNormalizedUri)(e);t&&o.set(t,"d")})),o}exports.cloneDeep=require("../../../lib/cloneDeep"),exports.getExtensionRootPath=getExtensionRootPath,exports.getAppDataPath=getAppDataPath,exports.readFileToString=readFileToString,exports.toNormalizedPath=toNormalizedPath,exports.toNormalizedUri=toNormalizedUri,exports.isSameTextSpan=isSameTextSpan,exports.getRootPathRecursively=getRootPathRecursively,exports.getRealFileNameFromVirtualFile=getRealFileNameFromVirtualFile,exports.deepAssign=deepAssign,exports.matchAll=matchAll,exports.getRefSortLevel=getRefSortLevel;
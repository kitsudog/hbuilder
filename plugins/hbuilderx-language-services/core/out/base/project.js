"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.isUniAppXProjectByPath=exports.isUniAppXProject=exports.tryGetProjectByAnyFileCaseSensitive=exports.tryGetProjectByAnyFile=exports.getProjectByPath=exports.createProject=exports.getBuiltinUniappModule=exports.resolveModuleName=exports.detectProjectKind=exports.HXProject=exports.HXProjectKind=void 0;const fs=require("fs"),jsonc=require("jsonc-parser"),path=require("path"),vscode_uri_1=require("vscode-uri"),fileProperties_1=require("./fileProperties"),pathUtils_1=require("./pathUtils"),util=require("./util"),vueVersion_1=require("./vueVersion"),tsapi_1=require("../tsapi");var HXProjectKind;!function(e){e[e.UniApp=0]="UniApp",e[e.UniApp_Cli=1]="UniApp_Cli",e[e.Web=2]="Web",e[e.App=3]="App",e[e.Wap2App=4]="Wap2App",e[e.Extension=5]="Extension",e[e.WxApp=6]="WxApp",e[e.Unkown=7]="Unkown"}(HXProjectKind||(exports.HXProjectKind=HXProjectKind={}));class HXProject{constructor(e,t,i){this._kind=HXProjectKind.Unkown,this._sourceRoot="",this.globalDocumentRegistry=t,this._fsPath=e.getCurrentDirectory(),this._tsProject=e,this._indexPipeHandler=i}get documentRegistry(){return this.globalDocumentRegistry}get name(){return path.basename(this._fsPath)}get kind(){return this._kind!=HXProjectKind.Unkown?this._kind:this._kind=detectProjectKind(this._fsPath)}get fsPath(){return this._fsPath}get sourceRoot(){return this._sourceRoot&&this._sourceRoot.length>0||(this._sourceRoot=this._fsPath,this.kind==HXProjectKind.UniApp_Cli&&(this._sourceRoot=path.join(this._fsPath,"src"))),this._sourceRoot}get indexPipeHandler(){return this._indexPipeHandler}isProjectOf(e,t){const i=util.toNormalizedUri(e,t);let n=vscode_uri_1.URI.parse(i).fsPath,o=path.relative(this.fsPath.toLowerCase(),n.toLowerCase());return!o.startsWith("..")&&!path.isAbsolute(o)}}function detectProjectKind(e){let t=[{kind:HXProjectKind.UniApp_Cli,existsFiles:[["src/manifest.json"],["src/pages.json"],["src/App.vue","src/App.nvue","src/App.uvue"],["src/main.js","src/main.ts","src/main.uts"]]},{kind:HXProjectKind.UniApp,existsFiles:[["manifest.json"],["pages.json"],["App.vue","App.nvue","App.uvue"],["main.js","main.ts","main.uts"]]},{kind:HXProjectKind.Wap2App,existsFiles:[["manifest.json"],["sitemap.json"]]},{kind:HXProjectKind.App,existsFiles:[["manifest.json"]]},{kind:HXProjectKind.WxApp,existsFiles:[["project.config.json"],["app.json"]]},{kind:HXProjectKind.Extension,existsFiles:function(e){var t;if(fs.existsSync(path.join(e,"package.json"))){let i=require(path.join(e,"package.json"));if((null===(t=null==i?void 0:i.engines)||void 0===t?void 0:t.HBuilderX)&&(null==i?void 0:i.main)&&(null==i?void 0:i.contributes))return!0}return!1}}];for(let i of t){let t=i.kind,n=i.existsFiles,o=!0;if("function"==typeof n)o=n(e);else for(let t of n){let i=!1;for(let n of t)if(fs.existsSync(path.join(e,n))){i=!0;break}if(o=o&&i,!o)break}if(o)return t}return HXProjectKind.Web}function resolveModuleName(e,t,i,n,o,r,s,p,u){let a,c=HXProjectKind.Web;t&&(c=t.kind),c!=HXProjectKind.UniApp&&c!=HXProjectKind.UniApp_Cli||i.startsWith("@/")&&(i=path.join(t.sourceRoot,i.substring(2)));let l=tsapi_1.ts.resolveModuleName(i,n,o,r);if(l.resolvedModule)a=l.resolvedModule;else{let e=tsapi_1.ts.nodeModuleNameResolver(i,n,o,r);e.resolvedModule&&(a=e.resolvedModule)}if(!a&&c===HXProjectKind.UniApp){let e=getBuiltinUniappModule(i,t);if(e)a={isExternalLibraryImport:!0,resolvedFileName:e,extension:".d.ts"};else{let e=path.join(util.getExtensionRootPath(),"builtin-dts","index.js"),t=tsapi_1.ts.nodeModuleNameResolver(i,e,o,r);t.resolvedModule&&(a=t.resolvedModule)}}return a}function getBuiltinUniappModule(e,t){let i=util.getExtensionRootPath(),n=(0,vueVersion_1.vueVersion)(t);return{"@dcloudio/uni-app":path.join(i,"builtin-dts/uniapp@vue2/node_modules/@dcloudio/uni-app/dist/uni-app.d.ts"),vue:path.join(i,"builtin-dts/common/vue2And3.d.ts"),vuex:2===n?path.join(i,"builtin-dts/uniapp@vue2/node_modules/vuex/types/index.d.ts"):path.join(i,"builtin-dts/uniapp@vue3/node_modules/vuex/types/index.d.ts"),"vue-router":2===n?path.join(i,"builtin-dts/uniapp@vue2/node_modules/vue-router/types/index.d.ts"):path.join(i,"builtin-dts/uniapp@vue3/node_modules/vue-router/dist/vue-router.d.ts"),"vue-i18n":2===n?path.join(i,"builtin-dts/uniapp@vue2/node_modules/vue-i18n/types/index.d.ts"):path.join(i,"builtin-dts/uniapp@vue3/node_modules/vue-i18n/dist/vue-i18n.d.ts"),pinia:path.join(i,"builtin-dts/uniapp@vue3/node_modules/pinia/dist/pinia.d.ts")}[e]}exports.HXProject=HXProject,exports.detectProjectKind=detectProjectKind,exports.resolveModuleName=resolveModuleName,exports.getBuiltinUniappModule=getBuiltinUniappModule;const g_project_caches=new Map;function createProject(e,t,i){let n=new HXProject(e,t,i);return g_project_caches.set(n.fsPath,n),n}function getProjectByPath(e){if(g_project_caches.has(e))return g_project_caches.get(e)}function tryGetProjectByAnyFile(e){let t=(0,pathUtils_1.noTsToNormalizedPath)(e);if(!t)return;let i,n=t.split("/");for(;n.length>1&&(i=getProjectByPath(n.join("/")),!i);)n.pop();return i}function tryGetProjectByAnyFileCaseSensitive(e){let t=(0,pathUtils_1.noTsToNormalizedPath)(e);if(!t)return;let i=t.split("/");for(let[e,t]of g_project_caches){let n=[...i];for(;n.length>1;){if((0,pathUtils_1.pathIsPath)(n.join("/"),e))return t;n.pop()}}}function isUniAppXProject(e){if(e.kind!==HXProjectKind.UniApp&&e.kind!==HXProjectKind.UniApp_Cli)return!1;const t=path.join(e.sourceRoot,"manifest.json"),i=(0,fileProperties_1.getFileProperty)(t,"isUniAppX",((e,t)=>{try{const t=fs.readFileSync(e,"utf8"),i=jsonc.parse(t);if(!i)return!1;if(i.hasOwnProperty("uni-app-x"))return!0}catch(e){return!1}}));return null!=i&&i}function isUniAppXProjectByPath(e){if(void 0===e)return!1;const t=detectProjectKind(e);if(t!==HXProjectKind.UniApp&&t!==HXProjectKind.UniApp_Cli)return!1;const i=path.join(e,""+(t===HXProjectKind.UniApp_Cli?"src":""),"manifest.json"),n=(0,fileProperties_1.getFileProperty)(i,"isUniAppX",((e,t)=>{try{const t=fs.readFileSync(e,"utf8"),i=jsonc.parse(t);if(!i)return!1;if(i.hasOwnProperty("uni-app-x"))return!0}catch(e){return!1}}));return null!=n&&n}exports.createProject=createProject,exports.getProjectByPath=getProjectByPath,exports.tryGetProjectByAnyFile=tryGetProjectByAnyFile,exports.tryGetProjectByAnyFileCaseSensitive=tryGetProjectByAnyFileCaseSensitive,exports.isUniAppXProject=isUniAppXProject,exports.isUniAppXProjectByPath=isUniAppXProjectByPath;
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.createLanguageServiceHost=exports.getDefaultLibs=exports.getNodeLibs=void 0;const fs=require("fs"),path=require("path"),vscode_uri_1=require("vscode-uri"),pathUtils_1=require("./pathUtils"),project_1=require("./project"),util=require("./util");function getNodeLibs(e,t){let i=[],s=path.join(e,"builtin-dts","node_modules","node");return fs.readdirSync(s).forEach((e=>{let n=!0;t.forEach((t=>{e.includes(t)&&(n=!1)})),n&&e.endsWith(".d.ts")&&i.push(path.join(s,e))})),i}function getDefaultLibs(e){let t=[],i=util.getExtensionRootPath();if(e.kind==project_1.HXProjectKind.UniApp){if((0,project_1.isUniAppXProject)(e))return t;t.push(path.join(i,"builtin-dts","uniapp@vue2","node_modules","vue","types","index.d.ts")),t.push(path.join(i,"builtin-dts","uniapp@vue3","node_modules","vue","dist","vue.d.ts")),t.push(path.join(i,"builtin-dts","uniapp@vue2","node_modules","vuex","types","index.d.ts")),t.push(path.join(i,"builtin-dts","uniapp@vue3","node_modules","vuex","types","index.d.ts")),t.push(path.join(i,"builtin-dts","uniapp@vue2","node_modules","vue-router","types","index.d.ts")),t.push(path.join(i,"builtin-dts","uniapp@vue3","node_modules","vue-router","dist","vue-router.d.ts")),t.push(path.join(i,"builtin-dts","uniapp@vue2","node_modules","vue-i18n","types","index.d.ts")),t.push(path.join(i,"builtin-dts","uniapp@vue3","node_modules","vue-i18n","dist","vue-i18n.d.ts")),t.push(path.join(i,"builtin-dts","uniapp@vue2","node_modules","@dcloudio","types","index.d.ts")),t.push(path.join(i,"builtin-dts","uniapp@vue2","node_modules","@dcloudio","uni-app","dist","uni-app.d.ts")),t.push(path.join(i,"frameworkdts","wechat-miniprogram","index.d.ts"))}else if(e.kind==project_1.HXProjectKind.App||e.kind==project_1.HXProjectKind.Wap2App)t.push(path.join(i,"builtin-dts","uniapp@vue2","node_modules","@dcloudio","types","html5plus","plus.d.ts")),t.push(path.join(i,"builtin-dts","node_modules","jQuery","jquery.d.ts"));else if(e.kind==project_1.HXProjectKind.UniApp_Cli){let s=path.join(e.fsPath,"node_modules/@dcloudio/types/index.d.ts");fs.existsSync(s)&&t.push(s),t.push(path.join(i,"frameworkdts","wechat-miniprogram","index.d.ts"))}else e.kind==project_1.HXProjectKind.Web?(t.push(path.join(i,"builtin-dts","node_modules","jQuery","jquery.d.ts")),t.push(path.join(i,"builtin-dts","web","vue-web.d.ts"))):e.kind==project_1.HXProjectKind.Extension?(t.push(path.join(i,"builtin-dts","common","extension_js.d.ts")),t.push(...getNodeLibs(i,["globals.d.ts","index.d.ts"]))):e.kind===project_1.HXProjectKind.WxApp&&t.push(path.join(i,"frameworkdts","wechat-miniprogram","index.d.ts"));t.push(path.join(i,"builtin-dts","node_modules","node","globals.d.ts")),t.push(path.join(i,"builtin-dts","common","lib.dom2.d.ts")),t.push(path.join(i,"builtin-dts","common","HBuilderX.d.ts"));const s=[];return t.forEach((e=>{const t=(0,pathUtils_1.noTsToNormalizedPath)(e);t&&s.push(t)})),s}function createLanguageServiceHost(e,t,i){const{ts:s,tsinfo:{languageServiceHost:n}}=i,o=getDefaultLibs(t),u=e.compilerOptions;let r=path.dirname(s.getDefaultLibFilePath(u));return{getCompilationSettings:()=>n?{...n.getCompilationSettings(),...e.compilerOptions}:e.compilerOptions,getScriptFileNames(){let i=[].concat(e.getDefaultLibs?e.getDefaultLibs(t):o);for(let t of e.documents)i.push(t);return i},getScriptKind(t){const i=util.toNormalizedUri(t,s);return e.getDocumentKind?e.getDocumentKind(i):"ts"===t.substr(t.length-2)?s.ScriptKind.TS:s.ScriptKind.JS},getProjectVersion:()=>String(e.version),getScriptVersion(t){const i=util.toNormalizedUri(t,s);return e.hasDocument(i)?e.getDocumentVersion(i):"1"},getScriptSnapshot(t){const i=util.toNormalizedUri(t,s);if(e.hasDocument(i))return e.getDocumentSnapshot(i);let n=vscode_uri_1.URI.parse(i).fsPath;if(fs.existsSync(n)&&fs.statSync(n).isFile()){let e=fs.readFileSync(n).toString();return{getText:(t,i)=>e.substring(t,i),getLength:()=>e.length,getChangeRange:()=>{}}}},getCurrentDirectory:()=>t.fsPath,getDefaultLibFileName:e=>e.lib&&e.lib.length>0?path.join(r,e.lib[0]):path.join(r,"lib.esnext.d.ts"),resolveModuleNames(i,n,o,r,d){const p=[];for(let o of i){let i,r={fileExists(t){const i=util.toNormalizedUri(t,s),n=vscode_uri_1.URI.parse(i);return!!e.hasDocument(i)||fs.existsSync(n.fsPath)},readFile(t){const i=util.toNormalizedUri(t,s);if(e.hasDocument(i)){let t=e.getDocumentSnapshot(i);return t.getText(0,t.getLength()-1)}const n=vscode_uri_1.URI.parse(i);return fs.readFileSync(n.fsPath).toString()}};i=e.resolveModuleNameOverride?e.resolveModuleNameOverride(t,o,n,u,r):(0,project_1.resolveModuleName)(s,t,o,n,u,r),p.push(i)}return p},readFile:function(e,t){return i.tsinfo.serverHost.readFile(e,t)},fileExists:function(e){return i.tsinfo.serverHost.fileExists(e)}}}exports.getNodeLibs=getNodeLibs,exports.getDefaultLibs=getDefaultLibs,exports.createLanguageServiceHost=createLanguageServiceHost;
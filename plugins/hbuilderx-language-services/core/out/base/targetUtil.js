"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.targetUtils=void 0;const uni_preprocess_1=require("@dcloudio/uni-preprocess"),source_map_js_1=require("source-map-js"),hxPluginCreateFactory_1=require("../hxPluginCreateFactory"),lspUtil_1=require("./lspUtil"),pathUtils_1=require("./pathUtils"),project_1=require("./project");class TargetUtils{constructor(){this._fileMap=new Map}sourcePosToTargetPos(e,t){if(!t)return e;const r=new source_map_js_1.SourceMapConsumer(t),o={line:e.line+1,column:e.character,source:t.sources[0]},s=r.generatedPositionFor(o);return{line:s.line-1,character:s.column}}targetPosTosourcePos(e,t){if(!t)return e;const r=new source_map_js_1.SourceMapConsumer(t),o={line:e.line+1,column:e.character},s=r.originalPositionFor(o);return{line:s.line-1,character:s.column}}sourceRangeToTargetRange(e,t){return{start:this.sourcePosToTargetPos(e.start,t),end:this.sourcePosToTargetPos(e.end,t)}}targetRangeToSourceRange(e,t){return{start:this.targetPosTosourcePos(e.start,t),end:this.targetPosTosourcePos(e.end,t)}}hasTarget(e){const t=-1!==e.indexOf("#ifdef"),r=-1!==e.indexOf("#ifndef"),o=-1!==e.indexOf("#endif");return t||r||o}getProcessContextFromTarget(e){switch(e){case hxPluginCreateFactory_1.TargetKind["APP-ANDROID"]:return{UNI_APP_X:!0,APP:!0,APP_ANDROID:!0,APP_IOS:!1,H5:!1,WEB:!1};case hxPluginCreateFactory_1.TargetKind.WEB:return{UNI_APP_X:!0,WEB:!0,H5:!0,APP_ANDROID:!1,APP_IOS:!1,APP:!1};case hxPluginCreateFactory_1.TargetKind["APP-IOS"]:return{UNI_APP_X:!0,APP:!0,APP_IOS:!0,APP_ANDROID:!1,WEB:!1,H5:!1};case hxPluginCreateFactory_1.TargetKind.UNKNOWN:default:return{UNI_APP_X:!1,APP:!1,APP_ANDROID:!1,WEB:!1,H5:!1,APP_IOS:!1}}}getTargetFileInfo(e,t,r){const o={type:"auto",context:this.getProcessContextFromTarget(r),sourceMap:{hires:!0,file:`${r}.${e}.map.json`,source:`${r}.${e}`,includeContent:!0}};return(0,uni_preprocess_1.preprocess)(t,o)}isSupport(e,t){const r={support:!1,fileText:""},o=(0,pathUtils_1.noTsToNormalizedPath)(e);if(!o)return r;if(!(0,project_1.isUniAppXProjectByPath)(o))return r;const s=t.getText();return this.hasTarget(s)?(r.support=!0,r.fileText=s,r):r}getAllTargetFileInfo(e,t,r=[hxPluginCreateFactory_1.TargetKind.UNKNOWN]){const o=new Map,s=this.isSupport(e,t);if(!s.support)return;const n=(0,pathUtils_1.noTsToNormalizedPath)(t.uri);if(n){for(const e of Object.values(hxPluginCreateFactory_1.TargetKind)){if(r.includes(e))continue;const t=this.getTargetFileInfo(n,s.fileText,e);o.set(e,t)}return o}}mergeValuesFromRange(e){const t=[];return e.forEach((e=>{var r;const o=t.find((t=>{if(t.range&&e.range){if((0,lspUtil_1.isSameRange)(t.range,e.range))return t}}));o?e.platforms&&(o.platforms||console.error("sameRangeData.platforms is undefined"),o.platforms=null!==(r=o.platforms)&&void 0!==r?r:[],o.platforms.push(...e.platforms)):t.push(e)})),t}getTargetRange(e,t){const r={...t,version:t.version.toString()};return this.sourceRangeToTargetRange(e,r)}getSourceRange(e,t){const r={...t,version:t.version.toString()};return this.targetRangeToSourceRange(e,r)}indexGetTarget(e,t,r){const o=e.offsetAt(t.start);if(!r.targetKind)return;if(!r.targetFileInfo)return;return r.targetFileInfo.isInPreprocessor(o)?[r.targetKind]:void 0}}const targetUtils=new TargetUtils;exports.targetUtils=targetUtils;
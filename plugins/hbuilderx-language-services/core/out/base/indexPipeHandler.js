"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.IndexPipeHandler=void 0;const rpc=require("vscode-jsonrpc/node"),indexlib_1=require("../indexlib");function timeout(e,n){const r=new Promise(((n,r)=>{setTimeout((()=>{r(new Error("Timeout"))}),e)}));return Promise.race([n,r])}async function promiseTimeOut(e,n,r){try{return await timeout(e,n)}catch(n){return console.error(`[TsLanguageServer] Query Timeout! Timeout: ${e}`,"ERROR"),void console.error(`[TsLanguageServer] Query Param: ${JSON.stringify(r)}`,"ERROR")}}class IndexPipeHandler{static instance(e,n){return void 0===IndexPipeHandler._instance&&(IndexPipeHandler._instance=new IndexPipeHandler(e,n)),IndexPipeHandler._instance}constructor(e,n){this._pipeName=e,this._serverType=n}createIndexConnection(e=!1){if(this._indexConnection)return;e?console.log("[TsLanguageServer] IndexClient PipeConnection Restart!"):console.log("[TsLanguageServer] IndexClient PipeConnection Start!");const n=rpc.createServerPipeTransport(this._pipeName,"utf-8");this._indexConnection=rpc.createMessageConnection(n[0],n[1]),this._indexConnection.listen(),this._indexConnection.onError((e=>{console.error(`[TsLanguageServer] [PipeConnection ERROR!] ${e}`)})),this._indexConnection.onClose((()=>{this._indexConnection=void 0,console.error("[TsLanguageServer] IndexClient PipeConnection CLose!"),this.createIndexConnection(!0)}))}async getIndexDataRequest(e,n){if("syntax"===this._serverType){console.warn("[TsLanguageServer] ServerType is Syntax!");return(0,indexlib_1.onDiskQuery)(e)}let r=3e3;n&&(r=6e4);try{this.createIndexConnection();const t=this._indexConnection.sendRequest(indexlib_1.PipeGetIndexDataRequest.type,e,n);return await promiseTimeOut(r,t,e)}catch(e){return void console.error(`[TsServer Query Error!] ${e}`,"ERROR")}}}exports.IndexPipeHandler=IndexPipeHandler;
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.tagNormalizedData=exports.styleNormalizedData=exports.normalizationIndexData=exports.lspFilterIndexData=exports.getReferenceList=exports.getRefList=exports.getIndexDataOptionsFromList=exports.getBackRefList=exports.getAllKindData=exports.creatorVueHoverFromIndexData=exports.creatorVueDirectiveFromIndexData=exports.creatorVueComponentFromIndexData=exports.creatorExtLocationLinksFromIndexData=exports.creatorCompletionFromIndexData=exports.createFileRefDataFromIndex=void 0;const path=require("path"),vscode_languageserver_1=require("vscode-languageserver"),vscode_uri_1=require("vscode-uri"),indexlib_1=require("../indexlib"),lspUtil_1=require("./lspUtil"),pathUtils_1=require("./pathUtils");function normalizationIndexData(e){const t={canonicalVersion:e.canonicalVersion,projectVersion:e.projectVersion,projectUri:e.projectUri,kindMap:new Map};let a=e.kindMap;return"Object"===(0,lspUtil_1.getType)(a)&&(a=(0,lspUtil_1.objToMap)(a)),t.kindMap=a,a.forEach(((e,a)=>{"Object"===(0,lspUtil_1.getType)(e)&&(e=(0,lspUtil_1.objToMap)(e),t.kindMap.set(a,e))})),t}function tagNormalizedData(e){const t={canonicalVersion:e.canonicalVersion,projectVersion:e.projectVersion,projectUri:e.projectUri,kindMap:new Map};return(e=normalizationIndexData(e)).kindMap.forEach(((e,a)=>{"ID"===a&&e.forEach(((e,t)=>{e.indexValues.forEach((e=>{e.value.startsWith("#")&&(e.value=e.value.substring(1))}))})),"CLASS"===a&&e.forEach(((e,t)=>{e.indexValues.forEach((e=>{e.value.startsWith(".")&&(e.value=e.value.substring(1))}))})),t.kindMap.set(a,e)})),t}function styleNormalizedData(e){const t={canonicalVersion:e.canonicalVersion,projectVersion:e.projectVersion,projectUri:e.projectUri,kindMap:new Map};return(e=normalizationIndexData(e)).kindMap.forEach(((e,a)=>{"ID"===a&&e.forEach(((e,t)=>{e.indexValues.forEach((e=>{e.value.startsWith("#")||(e.value="#"+e.value)}))})),"CLASS"===a&&e.forEach(((e,t)=>{e.indexValues.forEach((e=>{e.value.startsWith(".")||(e.value="."+e.value)}))})),t.kindMap.set(a,e)})),t}function lspFilterIndexData(e,t){const a=normalizationIndexData(e).kindMap,n={canonicalVersion:e.canonicalVersion,projectVersion:e.projectVersion,projectUri:e.projectUri,kindMap:new Map};return a.forEach(((e,a)=>{const r=new Map;e.forEach(((e,a)=>{if(t.options.specifyFileUri&&t.options.specifyFileUri!==a)return;const n=[];e.indexValues.forEach((e=>{t.filter(e,t)||n.push(e)})),0!==n.length&&r.set(a,{fileVersion:e.fileVersion,indexValues:n})})),0!==r.size&&n.kindMap.set(a,r)})),n}function autoGetKind(e,t){let a=vscode_languageserver_1.CompletionItemKind.Property,n=lspUtil_1.HxIconKind.ATTRIBUTE;return"ID"===e?n=lspUtil_1.HxIconKind.ID:"CLASS"===e?n=lspUtil_1.HxIconKind.CLASS:"COLOR"===e?(a=vscode_languageserver_1.CompletionItemKind.Color,n=void 0):"VUE_COMPONENT"===e&&(n=lspUtil_1.HxIconKind.ELEMENT),{tsKind:a,hxKind:n}}function getSort(e,t){let a="z";return t?(t.has(e)&&(a=t.get(e)),`${a}`):`${a}`}function creatorCompletionFromIndexData(e,t){const a=[];return normalizationIndexData(e).kindMap.forEach(((e,n)=>{const{tsKind:r,hxKind:o}=autoGetKind(n,t);e.forEach(((e,n)=>{let i="";if(t.needFilePath){const e=vscode_uri_1.URI.parse(n);i=`定义于\n                [${path.basename(e.fsPath)}](${e.fsPath})`}const s=getSort(n,t.sortLevel);e.indexValues.forEach((e=>{if(e.range&&t.currentFileUri&&t.currentText&&""!==t.currentText){const a=t.currentFileUri.startsWith(n),r=t.currentText===e.value,o=(0,lspUtil_1.isSameRange)(e.range,t.replaceRange);if(a&&r&&o)return}const c=e.value,l={label:c,documentation:i,textEdit:vscode_languageserver_1.TextEdit.replace(t.replaceRange,c),kind:r,sortText:`${s}_${c}`,data:{hxKind:o}};if(t.filter){if(!t.filter(e))return}a.push(l)}))}))})),a}function creatorExtLocationLinksFromIndexData(e,t){const a=[];return normalizationIndexData(e).kindMap.forEach(((e,n)=>{e.forEach(((e,n)=>{e.indexValues.forEach((e=>{var r,o,i;if(!e.range)return;const s={extRefItems:{range:{start:{line:e.range.start.line,offset:e.range.start.character},end:{line:e.range.end.line,offset:e.range.end.character}},name:e.value,lineText:null!==(r=e.lineText)&&void 0!==r?r:"",isIndex:!0,display:e.describe},targetUri:n,targetRange:null!==(o=e.range)&&void 0!==o?o:t,targetSelectionRange:null!==(i=e.range)&&void 0!==i?i:t,originSelectionRange:t};a.push(s)}))}))})),a}function getIndexDataOptionsFromList(e,t){const a=[];return e?(e.forEach((e=>{e.startsWith("file")||console.log("");const n=(0,pathUtils_1.noTsToNormalizedUri)(e);a.push({...t,fileUri:n})})),a):a}function getReferenceList(e){let t=[];if(0!==e.size){for(const a of e.keys()){const n=e.get(a);n&&(t=t.concat(n))}if(t=[...new Set(t)],0!==t.length)return t}}async function getAllKindData(e,t,a){var n;const r=(0,pathUtils_1.noTsToNormalizedUri)(e.fsPath);if(!r)return;const o=[{projectUri:r,kind:t}];let i;if(i=(null===(n=e.indexPipeHandler)||void 0===n?void 0:n.getIndexDataRequest)?await e.indexPipeHandler.getIndexDataRequest(o,!1):(0,indexlib_1.onDiskQuery)(o),!i)return;if(1!==i.length)return;return normalizationIndexData(i[0])}function getRefList(e,t){const a=new Map;return e.forEach((e=>{(0,indexlib_1.iterateGetReference)(e,[t],new Map).forEach(((e,t)=>{a.set(t,e)}))})),a}function getBackRefList(e,t){const a=new Map;return e.forEach((e=>{(0,indexlib_1.iterateGetBackReference)(e,[t],new Map).forEach(((e,t)=>{a.set(t,e)}))})),a}async function getAllRefData(e){return await getAllKindData(e,"REF",!0)}function createRefFileList(e,t,a){let n=getReferenceList(t),r=getReferenceList(a);n||(n=[]),r||(r=[]);const o=n.concat(r);return o.push(e),o}async function getIndexData(e,t){let a;if(a=await e.indexPipeHandler.getIndexDataRequest(t,!0),a&&0!==a.length)return a.forEach((e=>{e=styleNormalizedData(e)})),a}function filterAndGeneration(e,t,a){const n=[];e.forEach((e=>{const a=lspFilterIndexData(e,t);n.push(a)}));const r=[];return n.forEach((e=>{const t=creatorExtLocationLinksFromIndexData(e,a);r.unshift(...t)})),r}function creatorVueComponentFromIndexData(e,t){const a=[];return normalizationIndexData(e).kindMap.forEach(((e,n)=>{const{tsKind:r,hxKind:o}=autoGetKind(n,t);e.forEach(((e,n)=>{e.indexValues.forEach((e=>{let i="";if(t.needFilePath){const e=vscode_uri_1.URI.parse(n);i=`定义于\n                    [${path.basename(e.fsPath)}](${e.fsPath})`}const s={label:e.value,documentation:i,textEdit:vscode_languageserver_1.TextEdit.replace(t.replaceRange,`${e.value}$0></${e.value}>`),kind:r,insertTextFormat:vscode_languageserver_1.InsertTextFormat.Snippet,data:{hxKind:o}};a.push(s)}))}))})),a}function creatorVueDirectiveFromIndexData(e,t){const a=[];return normalizationIndexData(e).kindMap.forEach(((e,n)=>{const{tsKind:r,hxKind:o}=autoGetKind(n,t);e.forEach(((e,n)=>{e.indexValues.forEach((e=>{let i="";if(t.needFilePath){const e=vscode_uri_1.URI.parse(n);i=`定义于\n                    [${path.basename(e.fsPath)}](${e.fsPath})`}const s=`v-${e.value}`,c={label:s,documentation:i,textEdit:vscode_languageserver_1.TextEdit.replace(t.replaceRange,s),kind:r,data:{hxKind:o}};a.push(c)}))}))})),a}function creatorVueHoverFromIndexData(e){const t=[];return normalizationIndexData(e).kindMap.forEach(((e,a)=>{e.forEach(((e,a)=>{e.indexValues.forEach((e=>{const n=vscode_uri_1.URI.parse(a),r={contents:`定义于 [${path.basename(n.fsPath)}](${n.fsPath})`,name:e.value};t.push(r)}))}))})),t}async function createFileRefDataFromIndex(e,t){const a=await getAllKindData(e,"REF",!0);if(!a)return[];const n=[],r=lspFilterIndexData(a,{options:{text:t,needRange:!0},filter:function(e,t){let a=!1,n=!1;void 0!==t.options.text&&t.options.text.toLowerCase()===e.value.toLowerCase()&&(a=!0),t.options.needRange&&e.range&&(n=!0);return!(a&&n)}});n.push(r);const o=[];return n.forEach((e=>{const t=creatorExtLocationLinksFromIndexData(e,(0,lspUtil_1.getNullRange)());o.unshift(...t)})),o}exports.normalizationIndexData=normalizationIndexData,exports.tagNormalizedData=tagNormalizedData,exports.styleNormalizedData=styleNormalizedData,exports.lspFilterIndexData=lspFilterIndexData,exports.creatorCompletionFromIndexData=creatorCompletionFromIndexData,exports.creatorExtLocationLinksFromIndexData=creatorExtLocationLinksFromIndexData,exports.getIndexDataOptionsFromList=getIndexDataOptionsFromList,exports.getReferenceList=getReferenceList,exports.getAllKindData=getAllKindData,exports.getRefList=getRefList,exports.getBackRefList=getBackRefList,exports.creatorVueComponentFromIndexData=creatorVueComponentFromIndexData,exports.creatorVueDirectiveFromIndexData=creatorVueDirectiveFromIndexData,exports.creatorVueHoverFromIndexData=creatorVueHoverFromIndexData,exports.createFileRefDataFromIndex=createFileRefDataFromIndex;
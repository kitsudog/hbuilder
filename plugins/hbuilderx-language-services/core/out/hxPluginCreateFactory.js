"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.createRouterLanguageService=exports.getMainExternalFiles=exports.createMainLanguageService=exports.overrideTsApis=exports.emptyResolvedModules=exports.getRegisteredPlugins=exports.registerServerPlugin=exports.ExtLanguageService=exports.TargetKind=void 0;const indexPipeHandler_1=require("./base/indexPipeHandler"),lspUtil_1=require("./base/lspUtil"),hx=require("./base/project"),TsServerApiI18nPlugin_1=require("./plugins/TsServerApiI18nPlugin"),TsServerBasePlugin_1=require("./plugins/TsServerBasePlugin"),TsServerFileReferencesPlugin_1=require("./plugins/TsServerFileReferencesPlugin");var TargetKind,ExtLanguageService;!function(e){e.UNKNOWN="UNKNOWN",e["APP-ANDROID"]="APP-ANDROID",e.WEB="WEB",e["APP-IOS"]="APP-IOS"}(TargetKind||(exports.TargetKind=TargetKind={})),function(e){e.create=function(e){const t=Object.create(null);for(let n of Object.keys(e)){const i=e[n];t[n]="function"==typeof i?(...t)=>i.apply(e,t):new Proxy(i,{})}return e.target||(t.target=()=>{}),e.isEnabled||(t.isEnabled=(e,t)=>!1),e.getCompletionsAtPositionAsync||(t.getCompletionsAtPositionAsync=async(t,n,i)=>e.getCompletionsAtPosition(t,n,i)),e.getDefinitionAndBoundSpanAsync||(t.getDefinitionAndBoundSpanAsync=async(t,n)=>e.getDefinitionAndBoundSpan(t,n)),e.getQuickInfoAtPositionAsync||(t.getQuickInfoAtPositionAsync=async(t,n)=>e.getQuickInfoAtPosition(t,n)),e.getFileReferencesAsync||(t.getFileReferencesAsync=async t=>e.getFileReferences(t)),e.findReferencesAsync||(t.findReferencesAsync=async(t,n)=>e.findReferences(t,n)),e.getSyntacticDiagnosticsAsync||(t.getSyntacticDiagnosticsAsync=async t=>e.getSyntacticDiagnostics(t)),e.getSemanticDiagnosticsAsync||(t.getSemanticDiagnosticsAsync=async t=>e.getSemanticDiagnostics(t)),e.getSuggestionDiagnosticsAsync||(t.getSuggestionDiagnosticsAsync=async t=>e.getSuggestionDiagnostics(t)),t}}(ExtLanguageService||(exports.ExtLanguageService=ExtLanguageService={}));const hxLsPlugins=[];function registerServerPlugin(e){hxLsPlugins.push(e)}function getRegisteredPlugins(){return hxLsPlugins}function emptyResolvedModules(e){return e.map((e=>({resolvedModule:void 0})))}function overrideTsApis(e){e&&!e.__overridedTsApis&&(e.__overridedTsApis=!0,e.createLanguageService2=function(t,n,i,r){return e.createLanguageService(n,i,r)},e&&e.JsDoc&&(e.JsDoc.getJsDocTagsFromSignatures=function(e,t){let n=[];const i=[...e];if(i.length>0){const e="uniPlatform";n=i[0].getJsDocTags();let t=!1;for(const i of n)i.name===e&&(t=!0);if(!t){i.shift();for(const t of i){const i=t.getJsDocTags();for(const t of i)if(t.name===e){n.push(t);break}}}}return n})),e&&e.supportedJSExtensions&&e.supportedJSExtensions.push([".uts"]),e&&e.supportedJSExtensionsFlat&&e.supportedJSExtensionsFlat.push(".uts"),e&&e.supportedTSExtensions&&e.supportedTSExtensions.push([".uts"]),e&&e.supportedTSExtensionsFlat&&e.supportedTSExtensionsFlat.push(".uts")}function setupExitTimer(e){if(!e)return;if(e.__overridedTsApis)return;const t=(0,lspUtil_1.getSysArgsData)(e,"--clientProcessId");try{let e=parseInt(t);isNaN(e)||(n=e,setInterval((()=>{try{process.kill(n,0)}catch(e){process.exit(0)}}),3e3))}catch(e){}var n}function createMainLanguageService(e,t){var n;setupExitTimer(t),overrideTsApis(t);let i=(0,lspUtil_1.getSysArgsData)(t,"--indexServerPipeName"),r=(0,lspUtil_1.getSysArgsData)(t,"--indexServerType"),s=e.project.documentRegistry,o=hx.createProject(e.project,s,indexPipeHandler_1.IndexPipeHandler.instance(i,r)),c=hxLsPlugins;c[c.length-1]!==TsServerApiI18nPlugin_1.TsServerApiI18nPlugin&&c.push(TsServerApiI18nPlugin_1.TsServerApiI18nPlugin);const g=e.languageService,a=e.languageServiceHost;let u=[],l={languageService:g,languageServiceHost:a,project:o,tsinfo:e,ts:t};for(var f=0;f<c.length;f++)if(l.languageService=c[f].create(l),c[f].createTypeCheckerPlugins){let e=c[f].createTypeCheckerPlugins(l);e&&u.push(...e)}let p=e.project.getCompilationSettings.bind(e.project);return e.project.getCompilationSettings=()=>{let e=p();return e.checkExpressionOverride=(t,n,i,r)=>{for(let s=0;s<u.length;s++){let c=u[s];try{if(!c||!c.checkExpression)continue;let s=c.checkExpression(o,e,t,n,i,r);if(s)return s}catch(e){console.error(e)}}},e.getContextualTypeOverride=(t,n,i)=>{for(let r=0;r<u.length;r++){let s=u[r];try{if(!s||!s.getContextualType)continue;let r=s.getContextualType(o,e,t,n,i);if(r)return r}catch(e){console.error(e)}}},e.collectCustomModuleReferences=function(t){let n=[];for(let i=0;i<u.length;i++){let r=u[i];try{if(!r||!r.collectCustomModuleReferences)continue;let i=r.collectCustomModuleReferences(o,e,t);i&&n.push(...i)}catch(e){console.error(e)}}return n},o.kind!==hx.HXProjectKind.UniApp&&o.kind!==hx.HXProjectKind.UniApp_Cli||!hx.isUniAppXProject(o)||(e.noLib=!0),e},null===(n=l.tsinfo.session)||void 0===n||n.event({},"pluginloaded"),l.languageService}function getMainExternalFiles(e,t){let n=[],i=hxLsPlugins,r=hx.getProjectByPath(e.getCurrentDirectory());if(!r)return n;for(var s=0;s<i.length;s++){if(!i[s].getExternalFiles)continue;let e=i[s].getExternalFiles(r,t);e&&e.length>0&&n.push(...e)}return n}function createRouterLanguageService(e,t,n){let i=e.languageService;const r=e.languageServiceHost,s=getRegisteredPlugins();for(let t=0;t<s.length;++t)s[t].__isTargetPlugin||s[t].create&&(i=s[t].create({...e,languageService:i}));const o=[],c=[],g=Object.create(null);for(let e of Object.keys(i)){const t=i[e];g[e]="function"==typeof t?(...e)=>t.apply(i,e):new Proxy(t,{})}g.isEnabled=function(e,t){return!0},g.getCompletionsAtPositionAsync=function(t,n,r){for(let i of o)if(i.isEnabled(t,e.project)){return i.getCompletionsAtPositionAsync(t,n,r)}return i.getCompletionsAtPositionAsync?i.getCompletionsAtPositionAsync(t,n,r):Promise.resolve(i.getCompletionsAtPosition(t,n,r))},g.findReferencesAsync=async function(t,n){for(let i of o)if(i.isEnabled(t,e.project)){return i.findReferencesAsync(t,n)}return i.findReferencesAsync?i.findReferencesAsync(t,n):i.findReferences(t,n)},g.getDefinitionAndBoundSpanAsync=async function(t,n){for(let i of o)if(i.isEnabled(t,e.project)){return i.getDefinitionAndBoundSpanAsync(t,n)}return i.getDefinitionAndBoundSpanAsync?i.getDefinitionAndBoundSpanAsync(t,n):i.getDefinitionAndBoundSpan(t,n)},g.getFileReferencesAsync=async function(t){for(let n of o)if(n.isEnabled(t,e.project)){return n.getFileReferencesAsync(t)}return i.getFileReferencesAsync?i.getFileReferencesAsync(t):i.getFileReferences(t)},g.getQuickInfoAtPositionAsync=async function(t,n){for(let i of o)if(i.isEnabled(t,e.project)){return i.getQuickInfoAtPositionAsync(t,n)}return i.getQuickInfoAtPositionAsync?i.getQuickInfoAtPositionAsync(t,n):i.getQuickInfoAtPosition(t,n)},g.getSyntacticDiagnosticsAsync=async function(t){for(let n of o)if(n.isEnabled(t,e.project)){return await n.getSyntacticDiagnosticsAsync(t)}return i.getSyntacticDiagnostics(t)},g.getSemanticDiagnosticsAsync=async function(t){for(let n of o)if(n.isEnabled(t,e.project)){return await n.getSemanticDiagnosticsAsync(t)}return i.getSemanticDiagnostics(t)},g.getSuggestionDiagnosticsAsync=async function(t){for(let n of o)if(n.isEnabled(t,e.project)){return await n.getSuggestionDiagnosticsAsync(t)}return i.getSuggestionDiagnostics(t)},g.getCompletionEntryDetails=function(t,n,r,s,c,g,a){for(let i of o)if(i.isEnabled(t,e.project)){return i.getCompletionEntryDetails(t,n,r,s,c,g,a)}return i.getCompletionEntryDetails(t,n,r,s,c,g,a)},g.getSignatureHelpItems=function(t,n,r){for(let i of o)if(i.isEnabled(t,e.project)){return i.getSignatureHelpItems(t,n,r)}return i.getSignatureHelpItems(t,n,r)},g.getNavigationTree=function(t){for(let n of o)if(n.isEnabled(t,e.project)){return n.getNavigationTree(t)}return i.getNavigationTree(t)},g.getCodeFixesAtPosition=function(t,n,r,s,c,g){for(let i of o)if(i.isEnabled(t,e.project)){return i.getCodeFixesAtPosition(t,n,r,s,c,g)}return i.getCodeFixesAtPosition(t,n,r,s,c,g)},g.toLineColumnOffset=function(t,n){for(let i of o)if(i.isEnabled(t,e.project)){if(!i.toLineColumnOffset){e.tsinfo.project.log(`[hxPluginCreateFactory] ext.toLineColumnOffset is empty! FileName: ${t}`);break}return i.toLineColumnOffset(t,n)}i.toLineColumnOffset||e.tsinfo.project.log(`[hxPluginCreateFactory] originalLs.toLineColumnOffset is empty! FileName: ${t}`);return i.toLineColumnOffset(t,n)},g.target=()=>t;const a={...e,languageService:i,languageServiceHost:r,languageServiceRouter:g,languageServiceSourceMap:n,target:t};for(let e=0;e<s.length;++e){if(s[e].createExtService){let t=s[e].createExtService(a);t&&o.push(t)}if(s[e].createTypeCheckerPlugins){let t=s[e].createTypeCheckerPlugins(a);t&&c.push(...t)}}return[g,c]}exports.registerServerPlugin=registerServerPlugin,exports.getRegisteredPlugins=getRegisteredPlugins,exports.emptyResolvedModules=emptyResolvedModules,exports.overrideTsApis=overrideTsApis,exports.createMainLanguageService=createMainLanguageService,exports.getMainExternalFiles=getMainExternalFiles,exports.createRouterLanguageService=createRouterLanguageService,registerServerPlugin(TsServerBasePlugin_1.TsServerBasePlugin),registerServerPlugin(TsServerFileReferencesPlugin_1.TsServerFileReferencesPlugin);
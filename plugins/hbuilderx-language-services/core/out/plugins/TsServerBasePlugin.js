"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TsServerBasePlugin=void 0;const fs=require("fs"),path=require("path"),documents_1=require("../base/documents"),utils=require("./utils");function initFrameWorkLibs(e){let t=e.project.fsPath,s=new Map,n=path.resolve(__dirname,"../../../frameworkdts");fs.existsSync(n)&&fs.statSync(n).isDirectory()&&fs.readdirSync(n).forEach((e=>{let t=path.join(n,e,"index.d.ts");s.set(e,t)})),utils.getLibraries(t).forEach((t=>{if(s.has(t)){let n=s.get(t);utils.addRoot(e,n)}}));let i=e.tsinfo.session.handlers;e.tsinfo.session&&i&&!i.has("updateFrameworkLibs")&&e.tsinfo.session.addProtocolHandler("updateFrameworkLibs",(t=>{const{type:n,lib:i}=t.arguments;let o={response:{success:!1},responseRequired:!1};const r=s.get(i);if(!fs.existsSync(r))return o;if("add"==n)try{utils.addRoot(e,r),o.response.success=!0}catch(e){o.response.success=!1}else if("remove"==n)try{o.response.success=utils.removeRoot(e,r)}catch(e){o.response.success=!1}return o}))}function create(e){const t=e.languageService,s=Object.create(null);for(let e of Object.keys(t)){const n=t[e];s[e]=(...e)=>n.apply(t,e)}initFrameWorkLibs(e);let n=e.tsinfo.languageServiceHost,i=n.getScriptFileNames.bind(n),o=n.getCompilationSettings.bind(n),r=(0,documents_1.getDefaultLibs)(e.project);return n.getScriptFileNames=function(){let e=[],t=i();return t&&e.push(...t),n.getCompilationSettings().noCustomResolve||e.push(...r),e},n.getCompilationSettings=()=>({...o(),forceConsistentCasingInFileNames:!1}),s.getCompletionsAtPositionAsync=async function(s,n,i){var o;const r=t.getCompletionsAtPosition(s,n,i);if(!r)return;const c=null===(o=t.getProgram())||void 0===o?void 0:o.getSourceFile(s);if(!c)return r;const a=e.ts.getTokenAtPosition(c,n);if(a.kind===e.ts.SyntaxKind.Identifier){const e=[],t=a.getText(),s=t.length-(a.end-n);if(s<0)return r;r.entries.forEach((n=>{if("async"===n.name||"await"===n.name||"static"===n.name){const i=t.substring(s);""!==t&&e.push({...n,kindModifiers:"Snippet",insertText:n.name+"$0 "+i})}else e.push(n)})),r.entries=e}return r},s.findReferencesAsync=async function(e,s){return t.findReferences(e,s)},s.getDefinitionAndBoundSpanAsync=async function(e,s){return t.getDefinitionAndBoundSpan(e,s)},s.getFileReferencesAsync=async function(e){return t.getFileReferences(e)},s.getQuickInfoAtPositionAsync=async function(e,s){return t.getQuickInfoAtPosition(e,s)},s}exports.TsServerBasePlugin={create:e=>create(e)};
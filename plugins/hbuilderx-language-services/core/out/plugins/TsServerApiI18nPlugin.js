"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TsServerApiI18nPlugin=void 0;const fs=require("fs"),utils_1=require("./utils");var Global;!function(t){t.i18nCache=new Map}(Global||(Global={}));class getI18nData{constructor(t){this._info=t,this.i18nData={}}getDirectoryName(){let t=this._info.ts.server.findArgument("--locale");if(t){const e=t.toLowerCase(),n=/^([a-z]+)([_\-]([a-z]+))?$/.exec(e);if(n){const t=n[1],e=n[3];let i=t;return e&&(i=t+"-"+e),i}}}setI18nData(t){if(t&&t.declarations&&t.declarations.length>0){let e=t.declarations[0].getSourceFile().fileName,n=this.getDirectoryName();if(e.endsWith(".d.ts")&&n){let t=`${e.slice(0,-5)}.i18n.${n}.json`;if(Global.i18nCache.has(t))return void(this.i18nData=Global.i18nCache.get(t));if(fs.existsSync(t))try{const e=fs.readFileSync(t,"utf-8"),n=JSON.parse(e);this.i18nData=n,Global.i18nCache.set(t,n)}catch(t){}}}}getTags(t){let e="",n=[];if(!t)return;let i=t.find((t=>"i18nkey"===t.name));return i&&i.text&&i.text.length>0&&(e=i.text[0].text),e&&e.length>0?(t.forEach((t=>{var i;if("i18nkey"!==t.name){let a=`${e}.${t.name}`;if("param"===t.name){let e=null===(i=t.text)||void 0===i?void 0:i.find((t=>"parameterName"===t.kind));e&&(a=`${a}.${e.text}`)}let r=this.getI18nFromDoc(a);r?n.push({name:t.name,text:[{kind:"text",text:r}]}):n.push(t)}})),n):t}getDocumentation(t){let e="",n=[];if(!t)return;let i=t.find((t=>"i18nkey"===t.name));if(i&&i.text&&i.text.length>0&&(e=i.text[0].text),e&&e.length>0){let t=this.getI18nFromDoc(e);t&&(n=[{kind:"text",text:t}])}return n}getI18nFromDoc(t){if(t){let e=this.i18nData[t];if(e)return e}}}function create(t){const e=t.languageService,n=Object.create(null);for(let t of Object.keys(e)){const i=e[t];n[t]=(...t)=>i.apply(e,t)}return n.getCompletionEntryDetails=function(n,i,a,r,o,s,l){let c=e.getCompletionEntryDetails(n,i,a,r,o,s,l);if(!c)return;let u=t.ts.displayPartsToString(c.documentation);return c.documentation=[{kind:"text",text:(0,utils_1.translateText)(u)}],c},n.getQuickInfoAtPositionAsync=async function(n,i){let a=await e.getQuickInfoAtPositionAsync(n,i);if(!a)return;let r=t.ts.displayPartsToString(a.documentation);return a.documentation=[{kind:"text",text:(0,utils_1.translateText)(r)}],a},n}exports.TsServerApiI18nPlugin={create:create};
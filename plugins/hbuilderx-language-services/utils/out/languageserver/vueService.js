"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getVueThisLangusgeService=void 0;const path=require("path"),core_1=require("../../../core"),vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),vscode_uri_1=require("vscode-uri"),string_1=require("../common/string"),type_resolve_1=require("../common/type-resolve"),ParseUtil_1=require("../languageserver/ParseUtil"),vueVersion_1=require("../vueParse/vueVersion"),cVueDataString="VueDataString",cVueEventString="VueEventString",cVuexCommitString="Store<any>.commit: Commit\n(type: string, payload?: any, options?: CommitOptions)",cVuexDispatchString="Store<any>.dispatch: Dispatch\n(type: string, payload?: any, options?: DispatchOptions)";let currentTextDocument=vscode_languageserver_textdocument_1.TextDocument.create("init","javascript",0,""),vueThisDocVersion=1;const vueThisDocProvider=function(){let e=new Map;return{get version(){return""+vueThisDocVersion},setDocuments(t){e.clear(),t.forEach((t=>{e.set(t.uri,t)}))},get documents(){let t=[];return e.forEach(((e,i)=>{t.push(i)})),t.push(),t},compilerOptions:{allowNonTsExtensions:!0,allowJs:!0,lib:["lib.esnext.d.ts"],target:core_1.ts.ScriptTarget.Latest,moduleResolution:core_1.ts.ModuleResolutionKind.Classic,experimentalDecorators:!1},getDocumentSnapshot(t){let i="";return e.has(t)&&(i=e.get(t).getText()),{getText:(e,t)=>i.substring(e,t),getLength:()=>i.length,getChangeRange:()=>{}}},hasDocument:t=>e.has(t),getDocumentVersion:t=>""+e.get(t).version}}();function makeFilePath(e,t){return vscode_uri_1.URI.file(path.join(e,t)).toString()}function getVueThisLangusgeService(e,t){var i;let n=e.createTSLanguageService(vueThisDocProvider);const r=Object.create(null);for(let e of Object.keys(n)){const t=n[e];r[e]=(...e)=>t.apply(n,e)}let o=e.fsPath,s=t.getText(),l=!1,u=n.getProgram();if(!u)return;let c=0,a=!1;if(t&&t.expression){let e=t.expression,n=u.getTypeChecker();if(e.kind==core_1.ts.SyntaxKind.ThisKeyword)a=!0;else{let t=0;for(;e.kind==core_1.ts.SyntaxKind.PropertyAccessExpression;)t++,e=e.expression;let r=n.getSymbolAtLocation(e);if(r&&r.valueDeclaration&&r.valueDeclaration.kind==core_1.ts.SyntaxKind.VariableDeclaration){c=(null===(i=null==e?void 0:e.getText())||void 0===i?void 0:i.length)||0;let n=r.valueDeclaration.initializer;(null==n?void 0:n.kind)==core_1.ts.SyntaxKind.ThisKeyword&&(l=!0,a=0==t)}}}if(!s.startsWith("this.")&&!l)return;let p=t.getSourceFile().statements.find(core_1.ts.isExportAssignment);if(!p||!core_1.ts.isObjectLiteralExpression(p.expression))return;let g="import { ComponentPublicInstance } from 'vue';\n\timport VueRouter, { Route } from 'vue-router';\n\timport { Store } from 'vuex';\n\tlet _vue: ComponentPublicInstance & {\t$route: Route; $router: VueRouter; } & { $store: Store<any>; };";2===(0,vueVersion_1.vueVersion)(o)&&(g="import Vue from 'vue';\n\t\timport VueRouter from 'vue-router';\n\t\timport Vuex from 'vuex';\n\t\tlet _vue: Vue;");let d=`import scriptExport from './__virtual-script.vue';\n\t${g}\n\tlet $$_dataType = scriptExport.data();\n\tlet $$_setupType = scriptExport.setup();\n\tlet $$_methods = scriptExport.methods;\n\tlet $$_props = scriptExport.props;\n\tlet $$_computed = scriptExport.computed;\n\t$$_dataType.;\n`,m=d.length-2;c=0==c?5:c+1;let f=d.length;d+="_vue."+s.slice(c)+";\r\n";let v=d.length,h="$e$t",x={start:v,end:v};vueThisDocVersion++;const S=t.getSourceFile().getFullText();let _=makeFilePath(o,"__virtual-script.vue.ts"),y=vscode_languageserver_textdocument_1.TextDocument.create(_,"typescript",vueThisDocVersion,S),D=makeFilePath(o,"interpolation-script.ts"),T=vscode_languageserver_textdocument_1.TextDocument.create(D,"typescript",vueThisDocVersion,d);if(vueThisDocProvider.setDocuments([y,T]),u=n.getProgram(),u){let e=u.getTypeChecker(),t=u.getSourceFile(T.uri);if(t){let i=e.getSymbolsInScope(t,core_1.ts.SymbolFlags.Variable);if(i){let t=[],n=[];for(let r of i){let i=r.escapedName.toString();if(i.startsWith("$$_")){let o=e.getTypeOfSymbolAtLocation(r,r.valueDeclaration),s=e.getPropertiesOfType(o);for(let e of s){let r=e.escapedName.toString();t.push(`let ${r} = ${i}.${r};`),n.push(r)}}}d+=t.join("\r\n"),x.end=d.length,d+="\r\nconst $e$t={\r\n"+n.join(",")+"\r\n};\r\n",v=d.length,d+="$e$t."+s.slice(c),vueThisDocVersion++,T=vscode_languageserver_textdocument_1.TextDocument.create(D,"typescript",vueThisDocVersion,d),vueThisDocProvider.setDocuments([y,T])}}}v===d.length&&(d+=s,vueThisDocVersion++,T=vscode_languageserver_textdocument_1.TextDocument.create(D,"typescript",vueThisDocVersion,d),vueThisDocProvider.setDocuments([y,T])),r.getCompletionsAtPosition=(e,i,r)=>{let s="this.".length;const l=i-t.getStart()-c+5;let u=null;if(t.kind===core_1.ts.SyntaxKind.CallExpression){u=t;let e=t.expression,i=null==e?void 0:e.getText();i&&(s=i.length-1)}let p=n.getQuickInfoAtPosition(T.uri,s+f);if("method"===(null==p?void 0:p.kind)){let e=core_1.ts.displayPartsToString(p.displayParts);if(null==e?void 0:e.includes(cVueDataString)){let e=n.getCompletionsAtPosition(T.uri,m,r);if(e)return e}else if(null==e?void 0:e.includes(cVueEventString))return getVueComponentEventCompletions(t.getSourceFile(),i,o)}else if("property"===(null==p?void 0:p.kind)&&u){let e=checkVuexStoreMethod(i,p,u);if(e)return getVuexMethodsCompletions(e,o)}let g,d=[];return d.push(n.getCompletionsAtPosition(T.uri,l+v,r)),d.push(n.getCompletionsAtPosition(T.uri,l+f,r)),a&&d.push(getVuexMapStateCompletion(t.getSourceFile())),d.forEach((e=>{e&&(g?g.entries.push(...e.entries):g=e)})),g},r.getCompletionEntryDetails=(e,i,r,o,s,l,u)=>{const a=i-t.getStart()-c+5;let p=a+v,g=n.getCompletionEntryDetails(T.uri,p,r,o,s,l,u);if(!g){let e=a+f;return n.getCompletionEntryDetails(T.uri,e,r,o,s,l,u)}return g};const V=(e,i)=>{var r;let s=(0,type_resolve_1.getTouchingPropertyName)(t.getSourceFile(),i),l=core_1.ts.createTextSpan(s.getStart(),s.getWidth());const u=i-t.getStart()-c+5;if(t.kind===core_1.ts.SyntaxKind.CallExpression){let u=t,c=u.expression;if(c&&c.kind===core_1.ts.SyntaxKind.PropertyAccessExpression){let t=n.getQuickInfoAtPosition(T.uri,f+(null===(r=c.getText())||void 0===r?void 0:r.length));if("property"===(null==t?void 0:t.kind)){core_1.ts.displayPartsToString(t.displayParts);let n=checkVuexStoreMethod(i,t,u);if(n&&(null==s?void 0:s.kind)===core_1.ts.SyntaxKind.StringLiteral){return{textSpan:l,definitions:findVuexMethodsDefinition(e,n,s.getText(),o)}}}}}let a=n.getDefinitionAtPosition(T.uri,u+v);if((null==a?void 0:a.length)>0){let e=[];for(e.push(...a);e.length>0;){let i=e.pop();if(i.fileName==D)if(i.kind!=core_1.ts.ScriptElementKind.memberVariableElement&&i.kind!=core_1.ts.ScriptElementKind.functionElement||i.containerName!=h){if((i.kind==core_1.ts.ScriptElementKind.letElement||i.kind==core_1.ts.ScriptElementKind.functionElement)&&x.start<i.textSpan.start&&i.textSpan.start+i.textSpan.length<x.end){let t=n.getDefinitionAtPosition(T.uri,i.contextSpan.start+i.contextSpan.length-1);t&&e.push(...t)}}else{let t=n.getDefinitionAtPosition(T.uri,i.textSpan.start);t&&e.push(...t)}else if(i.fileName===_)return i.fileName=t.getSourceFile().fileName,{textSpan:l,definitions:[i]}}}else{let e=n.getDefinitionAtPosition(T.uri,u+f);if(e)return{textSpan:l,definitions:e}}if(a)return{textSpan:l,definitions:a}};return r.getDefinitionAtPosition=(e,t)=>{var i;return null===(i=V(e,t))||void 0===i?void 0:i.definitions},r.getDefinitionAndBoundSpan=V,r.getQuickInfoAtPosition=(e,i)=>{let r=i-t.getStart()-c+5;if(r>4){let e=n.getQuickInfoAtPosition(T.uri,r+v);return e&&e.kind||(e=n.getQuickInfoAtPosition(T.uri,r+f)),e}},r}function getVueComponentEventCompletions(e,t,i){let n=function(){let t=e.statements.find(core_1.ts.isExportAssignment);if(t){let e=t.getChildren().find(core_1.ts.isObjectLiteralExpression);if(e){let t=e.properties.find((e=>e.kind==core_1.ts.SyntaxKind.PropertyAssignment&&/['\"]?name['\"]?/.test(e.name.getText())));if(t){let e=t.initializer;if(core_1.ts.isStringLiteral(e)){let t=e.text,i=t[0];"'"!=i&&'"'!=i||(t=t.slice(0));let n=t[t.length-1];return"'"!=n&&'"'!=n||(t=t.slice(0,-1)),t}}}}return""}();if(n){const e=/[A-Z]/;let t=n.search(e),r="";for(;t>=0;)r+=n.slice(0,t),r+="-"+n[t].toLocaleLowerCase(),n=n.slice(t+1),t=n.search(e);r+=n;vscode_uri_1.URI.file(i).toString();return{entries:[],isGlobalCompletion:!1,isMemberCompletion:!0,isNewIdentifierLocation:!1}}}function checkVuexStoreMethod(e,t,i){let n=i.arguments,r=n&&n.length>0?n[0]:void 0;if(r&&r.kind===core_1.ts.SyntaxKind.StringLiteral&&r.pos<=e&&e<=r.end){const e=core_1.ts.displayPartsToString(t.displayParts);if(e.includes(cVuexCommitString))return"commit";if(e.includes(cVuexDispatchString))return"dispatch"}return""}function getVuexMethodsCompletions(e,t){vscode_uri_1.URI.file(t).toString();let i={entries:[],isGlobalCompletion:!1,isMemberCompletion:!0,isNewIdentifierLocation:!1};if(i.entries.length>0)return i}function findVuexMethodsDefinition(e,t,i,n){if(!(0,string_1.removeQuote)(i))return[];vscode_uri_1.URI.file(n).toString();return[]}function getVuexMapStateCompletion(e){let t=[],i={entries:t,isGlobalCompletion:!1,isMemberCompletion:!0,isNewIdentifierLocation:!1};return ParseUtil_1.ParseUtil.getVuexState(e).forEach((e=>{t.push({name:e,kind:core_1.ts.ScriptElementKind.memberVariableElement,sortText:e})})),i}exports.getVueThisLangusgeService=getVueThisLangusgeService;
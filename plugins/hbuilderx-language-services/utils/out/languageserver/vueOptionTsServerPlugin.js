"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const hxproject_1=require("./hxproject"),core_1=require("../../../core"),path=require("path"),type_resolve_1=require("../common/type-resolve"),vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument");let optionTextDocument=vscode_languageserver_textdocument_1.TextDocument.create("","typescript",1,"");const vueOptionDocProvider={get version(){return""+optionTextDocument.version},compilerOptions:{allowNonTsExtensions:!0,allowJs:!0,lib:["lib.esnext.d.ts"],target:core_1.ts.ScriptTarget.Latest,moduleResolution:core_1.ts.ModuleResolutionKind.Node10,experimentalDecorators:!1},getDefaultLibs(e){let t=[],o=hxproject_1.hx.getExtensionRootPath();return t.push(path.join(o,"builtin-dts","node_modules","vue","types","index.d.ts")),t.push(path.join(o,"builtin-dts","node_modules","@vue","composition-api/dist/vue-composition-api.d.ts")),t.push(path.join(o,"builtin-dts","node_modules","vue@3","types","index.d.ts")),t.push(path.join(o,"builtin-dts","node_modules","vuex","types","index.d.ts")),e.kind!==hxproject_1.hx.HXProjectKind.UniApp&&e.kind!==hxproject_1.hx.HXProjectKind.UniApp_Cli||t.push(path.join(o,"builtin-dts","node_modules","@dcloudio","types","index.d.ts")),t},get documents(){return[optionTextDocument.uri]},getDocumentSnapshot(e){let t="";return e==optionTextDocument.uri&&(t=optionTextDocument.getText()),{getText:(e,o)=>t.substring(e,o),getLength:()=>t.length,getChangeRange:()=>{}}},getDocumentVersion:e=>e==optionTextDocument.uri?""+optionTextDocument.version:"1",hasDocument:e=>e==optionTextDocument.uri,resolveModuleNameOverride(e,t,o,n,i,r,u,s){if("vue"==t){let e=hxproject_1.hx.getExtensionRootPath();return{isExternalLibraryImport:!0,resolvedFileName:path.join(e,"builtin-dts","node_modules","vue","types","index.d.ts")}}}};function createOptionHelperDocument(e,t,o,n){let i="import Vue from 'vue';\n\t\t\t  new Vue(\n\t\t\t",r=i.length-o-1;return i+=t,i+=")",{doc:vscode_languageserver_textdocument_1.TextDocument.create(e,"typescript",n,i),offsetDelta:r}}function getVueLanguageService(e,t){let o=e.createTSLanguageService(vueOptionDocProvider);return optionTextDocument=t,o}function create(e){const t=e.languageService,o=e.languageServiceHost,n=e.project,i=Object.create(null);for(let e of Object.keys(t)){const o=t[e];i[e]=(...e)=>o.apply(t,e)}return i.getCompletionEntryDetails=(e,i,r,u,s,l,c)=>{let p=t.getProgram().getSourceFile(e);if(e.endsWith(".vue")||e.endsWith(".nvue")||e.endsWith(".uvue")){let t=(0,type_resolve_1.findExportDefaultObjectExpressionAtKeyOffset)(p,i);if(t){let{doc:a,offsetDelta:d}=createOptionHelperDocument(e+".ts",t.getText(p),t.pos,parseInt(null==o?void 0:o.getProjectVersion()));return getVueLanguageService(n,a).getCompletionEntryDetails(a.uri,i+d,r,u,s,l,c)}}return t.getCompletionEntryDetails(e,i,r,u,s,l,c)},i.getCompletionsAtPosition=(e,i,r)=>{let u=t.getProgram().getSourceFile(e);if(e.endsWith(".vue")||e.endsWith(".nvue")||e.endsWith(".uvue")){let t=(0,type_resolve_1.findExportDefaultObjectExpressionAtKeyOffset)(u,i);if(t){let{doc:s,offsetDelta:l}=createOptionHelperDocument(e+".ts",t.getText(u),t.pos,parseInt(null==o?void 0:o.getProjectVersion()));return getVueLanguageService(n,s).getCompletionsAtPosition(s.uri,i+l,r)}}return t.getCompletionsAtPosition(e,i,r)},i.getDefinitionAtPosition=(e,i)=>{if(e.endsWith(".vue")||e.endsWith(".nvue")||e.endsWith(".uvue")){let r=t.getProgram().getSourceFile(e),u=(0,type_resolve_1.findExportDefaultObjectExpressionAtKeyOffset)(r,i);if(u){let{doc:t,offsetDelta:s}=createOptionHelperDocument(e+".ts",u.getText(r),u.pos,parseInt(null==o?void 0:o.getProjectVersion()));return getVueLanguageService(n,t).getDefinitionAtPosition(t.uri,i+s)}}return t.getDefinitionAtPosition(e,i)},i.getQuickInfoAtPosition=(e,i)=>{if(e.endsWith(".vue")||e.endsWith(".nvue")||e.endsWith(".uvue")){let r=t.getProgram().getSourceFile(e),u=(0,type_resolve_1.findExportDefaultObjectExpressionAtKeyOffset)(r,i);if(u){let{doc:t,offsetDelta:s}=createOptionHelperDocument(e+".ts",u.getText(r),u.pos,parseInt(null==o?void 0:o.getProjectVersion()));return getVueLanguageService(n,t).getQuickInfoAtPosition(t.uri,i+s)}}return t.getQuickInfoAtPosition(e,i)},i.getDefinitionAndBoundSpan=(e,o)=>t.getDefinitionAndBoundSpan(e,o),i}exports.default={create:create};
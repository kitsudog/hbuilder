"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const hxproject_1=require("./hxproject"),uniCloudPath_1=require("../common/uniCloudPath"),core_1=require("../../../core"),fs=require("fs"),path=require("path");function getType(e,t,n){let r=n.getSymbolsInScope(t,core_1.ts.SymbolFlags.Type).find((t=>t.escapedName===e));if(r)return n.getDeclaredTypeOfSymbol(r)}function isUniCloudImportObjectExpression(e,t){var n,r;if(e.kind!==core_1.ts.SyntaxKind.PropertyAccessExpression)return!1;let o=e,i=o.expression;if("importObject"!==(null===(n=o.name)||void 0===n?void 0:n.text))return!1;let l=t.getSymbolAtLocation(i);if(l){let e=t.getTypeOfSymbol(l);if("UniCloud"==(null===(r=null==e?void 0:e.symbol)||void 0===r?void 0:r.escapedName))return!0}return!1}function checkCallExpression(e,t,n,r,o,i){if(isUniCloudImportObjectExpression(r.expression,n)&&r.arguments.length>=1&&core_1.ts.isStringLiteralLike(r.arguments[0])){let o,i=r.arguments[0].text;(0,uniCloudPath_1.getAllCloudFunctions)(e.fsPath).forEach((e=>{e.name==i&&fs.existsSync(path.join(e.path,"index.obj.js"))&&(o=path.join(e.path,"index.obj.js"))}));let l=core_1.ts.createSourceFile(o,hxproject_1.hx.readFiletoString(o),core_1.ts.ScriptTarget.Latest);n.bindSourceFile(l,t);let s=n.getSymbolOfNode(l);if(s){const e=n.resolveExternalModuleSymbol(s);if(e)return n.getTypeOfSymbol(e)}}}function getContextualType(e,t,n,r,o){var i,l,s,a;let c=r.parent;if(c&&c.kind==core_1.ts.SyntaxKind.ReturnStatement){let t=r.getSourceFile();if(e.isUnicloudSource(t.fileName)&&"index.obj.js"===path.basename(t.fileName)){let e,t=core_1.ts.findAncestor(c,core_1.ts.isFunctionLike);if((null===(i=null==t?void 0:t.parent)||void 0===i?void 0:i.kind)===core_1.ts.SyntaxKind.PropertyAssignment){let n=t.parent;n.parent&&n.parent.kind===core_1.ts.SyntaxKind.ObjectLiteralExpression&&(e=n.parent)}else(null===(l=null==t?void 0:t.parent)||void 0===l?void 0:l.kind)===core_1.ts.SyntaxKind.ObjectLiteralExpression&&(e=t.parent);if((null===(s=null==e?void 0:e.parent)||void 0===s?void 0:s.getText()).startsWith("module.exports")){let e=n.getSymbolsInScope(c,core_1.ts.SymbolFlags.Namespace).find((e=>"UniCloud"===e.escapedName||"UniCloudNamespace"===e.escapedName));if(e){let t=null===(a=e.exports)||void 0===a?void 0:a.get("UniCloudError");if(t)return n.getDeclaredTypeOfSymbol(t)}}}}}function checkExpression(e,t,n,r,o,i){var l,s,a,c;const d=r.kind;if(d===core_1.ts.SyntaxKind.Identifier){let e=r,t=n.getResolvedSymbol(e);if(t&&t.valueDeclaration){let e=t.valueDeclaration;if((null===(l=e.parent)||void 0===l?void 0:l.kind)===core_1.ts.SyntaxKind.CatchClause&&(null===(a=null===(s=e.parent)||void 0===s?void 0:s.parent)||void 0===a?void 0:a.kind)===core_1.ts.SyntaxKind.TryStatement){let t=e.parent.parent.tryBlock.statements;if(t&&t.length>0){let e=n.getSymbolsInScope(t[0],core_1.ts.SymbolFlags.Variable);for(let o=0;o<t.length;o++){let i=t[o],l=/(\w+)\.(\w+)\s*\(/.exec(i.getText());if(l){let o=l[1],i=e.find((e=>e.escapedName===o));if(i&&i.valueDeclaration&&i.valueDeclaration.getText().indexOf(".importObject(")>=0){let e=n.getSymbolsInScope(t[0],core_1.ts.SymbolFlags.Namespace).find((e=>"UniCloud"===e.escapedName||"UniCloudNamespace"===e.escapedName));if(!e)return getType("Error",r,n);let o=null===(c=e.exports)||void 0===c?void 0:c.get("UniCloudError");if(o)return n.getDeclaredTypeOfSymbol(o)}}}}return getType("Error",r,n)}}}else if(d===core_1.ts.SyntaxKind.PropertyAccessExpression){if(isUniCloudImportObjectExpression(r,n)&&r.parent.kind===core_1.ts.SyntaxKind.CallExpression){let l=n.defaultCheckExpression(r,o,i),s=n.getSignaturesOfType(l,core_1.ts.SignatureKind.Call);return s&&s.forEach((l=>{l.resolvedReturnType=checkCallExpression(e,t,n,r.parent,o,i)})),l}}else if(d===core_1.ts.SyntaxKind.CallExpression){return checkCallExpression(e,t,n,r,o,i)}}exports.default={checkExpression:checkExpression,getContextualType:getContextualType};
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.doComplete=void 0;const vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),vscode_uri_1=require("vscode-uri"),ts=require("typescript/lib/tsserverlibrary"),type_resolve_1=require("../common/type-resolve"),ProjectFileFilter_1=require("../languageserver/ProjectFileFilter"),htmlCustomDataProvider_1=require("../languageserver/htmlCustomDataProvider"),hxIconKind_1=require("../languageserver/hxIconKind"),idClassDataProvider_1=require("../languageserver/idClassDataProvider"),htmlDataUtils_1=require("./htmlDataUtils"),valuesCache=new Map;function getDistinctAttrsValues(e){var t,r;if(valuesCache.size>0)return null!==(t=valuesCache.get(e))&&void 0!==t?t:[];let o=new Set;return[(0,htmlDataUtils_1.htmlDataProvider)(),(0,htmlCustomDataProvider_1.getCustomHTMLDataProvider)()].forEach((e=>{var t;let r=e.provideTags();for(let l of r){let r=e.provideAttributes(l.name);for(let i of r){let r=e.provideValues(l.name,i.name),a=[];r.forEach((e=>{const t=`${i.name}:${e.name}`;o.has(t)||(a.push(e),o.add(t))})),valuesCache.has(i.name)?null===(t=valuesCache.get(i.name))||void 0===t||t.push(...a):valuesCache.set(i.name,a)}}})),null!==(r=valuesCache.get(e))&&void 0!==r?r:[]}function getCompletionsForAttr(e,t){return getDistinctAttrsValues(e).map((e=>({label:e.name,kind:vscode_languageserver_protocol_1.CompletionItemKind.Unit,textEdit:t?vscode_languageserver_protocol_1.TextEdit.replace(t,e.name):void 0,data:{hxKind:hxIconKind_1.HxIconKind.ATTRIBUTE}})))}const DQ='"'.charCodeAt(0),SQ="'".charCodeAt(0);function getFileCompletions(e,t,r,o,l){var i,a;const n=e.getText();let s=o,d=l.getStart();for(;s>d;){let e=n.charCodeAt(s-1);if(e==DQ||e==SQ)break;s--}let u={extensionFilters:[],prefixPath:n.slice(s,o),timeout:200,withAllCurrentLevelFiles:!0},c=null!==(a=null===(i=(0,ProjectFileFilter_1.getCompletionFilesSync)(t,u,e.uri))||void 0===i?void 0:i.files)&&void 0!==a?a:[],v=[];return c.forEach((e=>{v.push({label:e.relative,kind:e.isDir?vscode_languageserver_protocol_1.CompletionItemKind.Folder:vscode_languageserver_protocol_1.CompletionItemKind.File,data:{hxKind:e.isDir?hxIconKind_1.HxIconKind.FOLDER:hxIconKind_1.HxIconKind.FILE}})})),v}function getIdCompletions(e,t){let r=[];return(0,idClassDataProvider_1.filterIdData)(t,e,!0).forEach((e=>{r.push(...e.names.map((e=>({label:e}))))})),r}function getClassCompletions(e,t){let r=[];return(0,idClassDataProvider_1.filterClassData)(t,e,!0).forEach((e=>{r.push(...e.names.map((e=>({label:e}))))})),r}function doComplete(e,t,r){if(!r.sourceFile)return[];let o=r.sourceFile,l=t.offsetAt(e),i=(0,type_resolve_1.getTokenAtPosition)(o,l);if(i){let e=i.parent;if(e&&e.kind==ts.SyntaxKind.CallExpression){let o=e.arguments,i=-1;for(let e=0;e<o.length;e++){let t=o[e];if(l>=t.getStart()&&l<=t.getEnd()){i=e-1;break}}if(i>=0){let e=o[i];if(e.kind==ts.SyntaxKind.StringLiteral){let o=e.getText(),i=o.charCodeAt(0);i!=DQ&&i!=SQ||(o=o.slice(1,-1));let a=r.workspaceFolder.toString(),n={name:"",uri:vscode_uri_1.URI.file(a).toString()};return"src"==o?n?getFileCompletions(t,n,r.replaceRange,l,e):[]:"id"==o?n?getIdCompletions(t,n):[]:"class"==o?n?getClassCompletions(t,n):[]:getCompletionsForAttr(o,null==r?void 0:r.replaceRange)}}}}return[]}exports.doComplete=doComplete;
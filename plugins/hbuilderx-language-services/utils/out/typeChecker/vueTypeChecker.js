"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getMembersAtType=exports.getMembersAtProperty=exports.getMixinsOptionsType=exports.getVueNodes=exports.getExportDefaultPropertiesNode=void 0;const path=require("path"),core_1=require("../../../core");function fixTsNodeText(e){let t=e.trim();return(t.startsWith('"')&&t.endsWith('"')||t.startsWith("'")&&t.endsWith("'"))&&(t=t.slice(1,-1)),t}function getExportDefaultPropertiesNode(e,t,s,i){var r;const o=new Map,a=e.getSymbolAtLocation(t);if(a){const e=null===(r=a.exports)||void 0===r?void 0:r.get("default");if(e&&e.valueDeclaration&&core_1.ts.isExportAssignment(e.valueDeclaration)){const t=e.valueDeclaration,s=t.expression&&core_1.ts.isCallExpression(t.expression)?t.expression:void 0;if(s){const e=s.arguments.length>0?s.arguments[0]:void 0;if(e&&core_1.ts.isObjectLiteralExpression(e)){e.properties.forEach((e=>{if(core_1.ts.isMethodDeclaration(e)){const t=e;i.includes(t.name.escapedText)&&o.set(t.name.escapedText,e)}else if(core_1.ts.isPropertyAssignment(e)){const t=e;i.includes(t.name.escapedText)&&o.set(t.name.escapedText,e)}}))}}}}return o}function getVueNodes(e,t,s){const i=new Map;return t.forEach((t=>{if(core_1.ts.isMethodDeclaration(t)){const s=t;e.includes(s.name.escapedText)&&i.set(s.name.escapedText,t)}else if(core_1.ts.isPropertyAssignment(t)){const s=t;e.includes(s.name.escapedText)&&i.set(s.name.escapedText,t)}})),i}function getPropsType(e,t,s){var i;let r=s.getAnyType(),o=e.initializer,a=null===(i=null==o?void 0:o.properties)||void 0===i?void 0:i.find((e=>{var t;return"type"===fixTsNodeText(null===(t=null==e?void 0:e.name)||void 0===t?void 0:t.getText().trim())}));if(a){let e=s.getSymbolOfNode(a);if(e){switch(s.typeToString(s.getTypeOfSymbolAtLocation(e,e.valueDeclaration))){case"NumberConstructor":r=s.getNumberType();break;case"StringConstructor":r=s.getStringType();break;case"BooleanConstructor":r=s.getBooleanType();break;case"FunctionConstructor":r=e&&s.getTypeOfSymbol(e);break;default:r=s.getTypeOfSymbolAtLocation(e,e.valueDeclaration)}}}let n=s.getSymbolOfNode(e);r||(r=s.getAnyType());let p=s.createSymbol(core_1.ts.SymbolFlags.Property,fixTsNodeText(e.name.getText()),8);return s.getSymbolLinks(p).type=r,p.declarations=n.declarations,p.valueDeclaration=n.valueDeclaration,p}function getComputedReturnType(e,t,s){const i=t.getSymbolOfNode(e);if(!i)return;const r=t.getTypeOfSymbolAtLocation(i,i.valueDeclaration),o=t.getSignaturesOfType(r,0),a=t.createSymbol(core_1.ts.SymbolFlags.Property,i.escapedName,8);if(a.declarations=i.declarations,a.valueDeclaration=i.valueDeclaration,o.length>0){const e=o[0],s=t.getReturnTypeOfSignature(e);t.getSymbolLinks(a).type=s}return a}function isVueOption(e,t,s){return!(!s.ts.isMethodDeclaration(e)||fixTsNodeText(e.name.getText())!==t)||(!(!s.ts.isPropertyAssignment(e)||!s.ts.isFunctionExpression(e.initializer)||fixTsNodeText(e.name.getText())!==t)||!(!s.ts.isPropertyAssignment(e)||!s.ts.isArrowFunction(e.initializer)||fixTsNodeText(e.name.getText())!==t))}function getReturnNode(e,t){var s;let i;t.ts.isMethodDeclaration(e)?i=e:(t.ts.isPropertyAssignment(e)&&t.ts.isFunctionExpression(e.initializer)||t.ts.isPropertyAssignment(e)&&t.ts.isArrowFunction(e.initializer))&&(i=e.initializer);return null===(s=i.body)||void 0===s?void 0:s.statements.find((e=>t.ts.isReturnStatement(e)))}function getMixinsOptionsType(e,t,s,i){var r;let o=t.ts.createSymbolTable();const a=["data","props","methods","computed","mixins"];if(e&&t.ts.isArrayLiteralExpression(e)&&e.elements.forEach((e=>{let r=s.getTypeAtLocation(e);if(r){let e=r.getProperties();if(e){let r=new Map;e.forEach((e=>{e.declarations&&e.declarations.length>0&&r.set(e.escapedName,e)})),getMembersAtType(a,r,t,s,i).forEach(((e,t)=>{o.set(t,e)}))}}})),i){let e=path.join(i.sourceRoot,"main.uts"),n=null===(r=t.languageService.getProgram())||void 0===r?void 0:r.getSourceFile(e);n&&n.forEachChild((function e(r){if(t.ts.isExpressionStatement(r)&&t.ts.isCallExpression(r.expression)&&t.ts.isPropertyAccessExpression(r.expression.expression)&&"mixin"===fixTsNodeText(r.expression.expression.name.getText())){let e=r.expression.arguments[0],n=s.getTypeAtLocation(e);if(n){let e=n.getProperties();if(e){let r=new Map;e.forEach((e=>{e.declarations&&e.declarations.length>0&&r.set(e.escapedName,e)})),getMembersAtType(a,r,t,s,i).forEach(((e,t)=>{o.set(t,e)}))}}}t.ts.forEachChild(r,e)}))}return o}function getMembersAtProperty(e,t,s,i){let r=s.ts.createSymbolTable();return e.forEach((e=>{if(t.has(e)){const o=t.get(e);if(o)if(isVueOption(o,"data",s)){const e=getReturnNode(o,s);e&&e.expression&&s.ts.isObjectLiteralExpression(e.expression)&&e.expression.properties.forEach((e=>{if(s.ts.isPropertyAssignment(e)){const t=i.getSymbolOfNode(e);t&&r.set(t.escapedName,t)}}))}else if(isVueOption(o,"setup",s)){const e=getReturnNode(o,s);e&&e.expression&&s.ts.isObjectLiteralExpression(e.expression)&&e.expression.properties.forEach((e=>{const t=i.getSymbolOfNode(e);t&&r.set(t.escapedName,t)}))}else if(s.ts.isPropertyAssignment(o)&&s.ts.isObjectLiteralExpression(o.initializer)){if("props"===fixTsNodeText(o.name.getText())){return void o.initializer.properties.forEach((e=>{let t=getPropsType(e,s.ts,i);t&&r.set(t.escapedName,t)}))}if("inject"===fixTsNodeText(o.name.getText())){return void o.initializer.properties.forEach((e=>{let t=getPropsType(e,s.ts,i);t&&r.set(t.escapedName,t)}))}if("computed"===fixTsNodeText(o.name.getText())){return void o.initializer.properties.forEach((e=>{let t=getComputedReturnType(e,i,s.ts);t&&r.set(t.escapedName,t)}))}o.initializer.properties.forEach((e=>{let t=i.getSymbolOfNode(e);t&&r.set(t.escapedName,t)}))}else if(s.ts.isPropertyAssignment(o)&&s.ts.isArrayLiteralExpression(o.initializer)&&"inject"===fixTsNodeText(o.name.getText())){let e=i.getAnyType();s.ts.isArrayLiteralExpression(o.initializer)&&o.initializer.elements.forEach((t=>{if(s.ts.isStringLiteral(t)){let s=i.createSymbol(core_1.ts.SymbolFlags.Property,fixTsNodeText(t.text),8);i.getSymbolLinks(s).type=e,r.set(s.escapedName,s)}}))}}})),r}function getMembersAtType(e,t,s,i,r){let o=s.ts.createSymbolTable();return e.forEach((e=>{if(t.has(e)){const a=t.get(e);if(a)if("data"===a.escapedName||"setup"===a.escapedName){let e=i.getTypeOfSymbol(a).getCallSignatures();e&&e.length>0&&e.forEach((e=>{let t=e.getReturnType().getProperties();t&&t.length>0&&t.forEach((e=>{if("$props"===e.escapedName){i.getTypeOfSymbol(e).getProperties().forEach((e=>{let t=e.declarations&&e.declarations[0];if(t){let e=getPropsType(t,s.ts,i);e&&o.set(e.escapedName,e)}else o.set(e.escapedName,e)}))}o.set(e.escapedName,e)}))}))}else if("computed"===a.escapedName){i.getTypeOfSymbol(a).getProperties().forEach((e=>{let t=i.getTypeOfSymbol(e).getCallSignatures();if(t&&t.length>0){let s=t[0].getReturnType();const r=i.createSymbol(core_1.ts.SymbolFlags.Property,e.escapedName,8);r.declarations=e.declarations,r.valueDeclaration=e.valueDeclaration,i.getSymbolLinks(r).type=s,o.set(e.escapedName,r)}}))}else if("methods"===a.escapedName){i.getTypeOfSymbol(a).getProperties().forEach((e=>{o.set(e.escapedName,e)}))}else if("props"===a.escapedName){i.getTypeOfSymbol(a).getProperties().forEach((e=>{let t=e.declarations[0];if(t){let e=getPropsType(t,s.ts,i);e&&o.set(e.escapedName,e)}}))}else if("mixins"===a.escapedName){let e=a.declarations[0];if(e&&s.ts.isPropertyAssignment(e)&&s.ts.isArrayLiteralExpression(e.initializer)){let t=getMixinsOptionsType(e.initializer,s,i,r);t&&t.forEach(((e,t)=>{o.set(t,e)}))}}else if("inject"===a.escapedName){let e=a.declarations[0];if(core_1.ts.isPropertyAssignment(e)&&core_1.ts.isArrayLiteralExpression(e.initializer)){let t=i.getAnyType();e.initializer.elements.forEach((e=>{if(s.ts.isStringLiteral(e)){let s=i.createSymbol(core_1.ts.SymbolFlags.Property,fixTsNodeText(e.text),8);i.getSymbolLinks(s).type=t,o.set(s.escapedName,s)}}))}else if(core_1.ts.isPropertyAssignment(e)&&core_1.ts.isObjectLiteralExpression(e.initializer)){i.getTypeOfSymbol(a).getProperties().forEach((e=>{let t=e.declarations[0];if(t){let e=getPropsType(t,s.ts,i);e&&o.set(e.escapedName,e)}}))}}}})),o}exports.getExportDefaultPropertiesNode=getExportDefaultPropertiesNode,exports.getVueNodes=getVueNodes,exports.getMixinsOptionsType=getMixinsOptionsType,exports.getMembersAtProperty=getMembersAtProperty,exports.getMembersAtType=getMembersAtType;
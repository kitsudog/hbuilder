"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.isFollowedBy=exports.isStringLiteral=exports.isImportElement=exports.isObjectLiteralKey=exports.findExportThisExpressionAtOffset=exports.findExportDefaultObjectExpressionAtKeyOffset=exports.inExportDefaultObjectExpression=exports.getTouchingPropertyName=exports.getTokenAtPosition=exports.getRelevantTokens=exports.isInString=exports.getArgumentsSpecialStringType=void 0;const core_1=require("../../../core"),nodes_1=require("../common/nodes");function getArgumentsSpecialStringType(e,t,n){var i;let o=n.languageService.getSignatureHelpItems(e,t,void 0);if(o){let e=o.items;if(e.length>0){let t=e[0],n=o.argumentIndex;if((null==t?void 0:t.parameters)&&(null===(i=null==t?void 0:t.parameters)||void 0===i?void 0:i.length)>n){let e=t.parameters[n],i="";null==e||e.displayParts.forEach((e=>{i+=e.text}));let o=i.split(":");if(2===o.length){return o[1].split("|")}}}}return[]}function getTokenAtPosition(e,t){return getTokenAtPositionWorker(e,t,!0,void 0,!1)}function getTokenAtPositionWorker(e,t,n,i,o){let r=e;e:for(;;){for(const s of r.getChildren(e)){if((n?s.getFullStart():s.getStart(e,!0))>t)break;const a=s.getEnd();if(t<a||t===a&&(s.kind===core_1.ts.SyntaxKind.EndOfFileToken||o)){r=s;continue e}if(i&&a===t){const n=findPrecedingToken(t,e,s);if(n&&i(n))return n}}return r}}function isNonWhitespaceToken(e){return core_1.ts.isToken(e)}function some(e,t){if(e){if(!t)return e.length>0;for(const n of e)if(t(n))return!0}return!1}function binarySearchKey(e,t,n,i,o){if(!some(e))return-1;let r=o||0,s=e.length-1;for(;r<=s;){const o=r+(s-r>>1);switch(i(n(e[o],o),t)){case-1:r=o+1;break;case 0:return o;case 1:s=o-1}}return~r}function nodeHasTokens(e,t){return e.kind!==core_1.ts.SyntaxKind.EndOfFileToken&&0!==e.getWidth(t)}function findRightmostChildNodeWithTokens(e,t,n){for(let i=t-1;i>=0;i--){e[i];if(nodeHasTokens(e[i],n))return e[i]}}function findRightmostToken(e,t){if(isNonWhitespaceToken(e))return e;const n=e.getChildren(t);if(0===n.length)return e;const i=findRightmostChildNodeWithTokens(n,n.length,t);return i&&findRightmostToken(i,t)}function findPrecedingToken(e,t,n,i){const o=function n(o){if(isNonWhitespaceToken(o)&&o.kind!==core_1.ts.SyntaxKind.EndOfFileToken)return o;const r=o.getChildren(t),s=binarySearchKey(r,e,((e,t)=>t),((t,n)=>e<r[t].end?!r[t-1]||e>=r[t-1].end?0:1:-1));if(s>=0&&r[s]){const o=r[s];if(e<o.end){const a=o.getStart(t,!i);if(a>=e||!nodeHasTokens(o,t)){const e=findRightmostChildNodeWithTokens(r,s,t);return e&&findRightmostToken(e,t)}return n(o)}}const a=findRightmostChildNodeWithTokens(r,r.length,t);return a&&findRightmostToken(a,t)}(n||t);return o}function getRelevantTokens(e,t){console.log(`getRelevantTokens params: ${e}`);const n=findPrecedingToken(e,t);if(console.log(`previous token pos: ${null==n?void 0:n.pos}`),console.log(`previous token end: ${null==n?void 0:n.end}`),console.log(`previous token kind: ${null==n?void 0:n.kind}`),n&&e<=n.end&&(isMemberName(n)||isKeyword(n.kind))){console.log("getRelevatTokens enter if");const e=findPrecedingToken(n.getFullStart(),t,void 0);return console.log(`context token pos: ${null==e?void 0:e.pos}`),console.log(`context token end: ${null==e?void 0:e.end}`),{contextToken:e,previousToken:n}}return{contextToken:n,previousToken:n}}function isMemberName(e){return e.kind===core_1.ts.SyntaxKind.Identifier}function isKeyword(e){return core_1.ts.SyntaxKind.FirstKeyword<=e&&e<=core_1.ts.SyntaxKind.LastKeyword}function getTouchingPropertyName(e,t){return getTouchingToken(e,t,(e=>isPropertyNameLiteral(e)||isKeyword(e.kind)))}function getTouchingToken(e,t,n){return getTokenAtPositionWorker(e,t,!1,n,!1)}function isPropertyNameLiteral(e){switch(e.kind){case core_1.ts.SyntaxKind.Identifier:case core_1.ts.SyntaxKind.StringLiteral:case core_1.ts.SyntaxKind.NoSubstitutionTemplateLiteral:case core_1.ts.SyntaxKind.NumericLiteral:return!0;default:return!1}}function getLeftmostAccessExpression(e){for(;isAccessExpression(e);)e=e.expression;return e}function isAccessExpression(e){return e.kind===core_1.ts.SyntaxKind.PropertyAccessExpression||e.kind===core_1.ts.SyntaxKind.ElementAccessExpression}function nodeIsMissing(e){return void 0===e||e.pos===e.end&&e.pos>=0&&e.kind!==core_1.ts.SyntaxKind.EndOfFileToken}function isCallExpression(e){return e.kind===core_1.ts.SyntaxKind.CallExpression}function last(e){return e[e.length-1]}function isLiteralImportTypeNode(e){return core_1.ts.isImportTypeNode(e)&&core_1.ts.isLiteralTypeNode(e.argument)&&core_1.ts.isStringLiteral(e.argument.literal)}function isInRightSideOfInternalImportEqualsDeclaration(e){for(;e.parent.kind===core_1.ts.SyntaxKind.QualifiedName;)e=e.parent;return isInternalModuleImportEqualsDeclaration(e.parent)}function isInternalModuleImportEqualsDeclaration(e){return e.kind===core_1.ts.SyntaxKind.ImportEqualsDeclaration&&e.moduleReference.kind!==core_1.ts.SyntaxKind.ExternalModuleReference}function skipAlias(e,t){return e.flags&core_1.ts.SymbolFlags.Alias?t.getAliasedSymbol(e):e}function symbolCanBeReferencedAtTypeLocation(e,t,n=new Map){const i=e;return!!(i.flags&core_1.ts.SymbolFlags.Type)||t.isUnknownSymbol(i)||!!(i.flags&core_1.ts.SymbolFlags.Module)&&t.getExportsOfModule(i).some((e=>symbolCanBeReferencedAtTypeLocation(e,t,n)))}function isInString(e,t,n=findPrecedingToken(t,e)){if(n&&isStringTextContainingNode(n)){const i=n.getStart(e),o=n.getEnd();if(i<t&&t<o)return!0;if(t===o)return!!n.isUnterminated}return!1}function isStringTextContainingNode(e){return e.kind===core_1.ts.SyntaxKind.StringLiteral||isTemplateLiteralKind(e.kind)}function isTemplateLiteralKind(e){return core_1.ts.SyntaxKind.FirstTemplateToken<=e&&e<=core_1.ts.SyntaxKind.LastTemplateToken}function findExportThisExpressionAtOffset(e,t){if(!e)return;if(e.statements.find(core_1.ts.isExportAssignment)){let n=getTokenAtPosition(e,t-1);if(n.getStart()<=t&&t<=n.getEnd()){let n=(0,nodes_1.findNodePathByOffset)(e,t);for(let e=n.length-1;e>=0;--e){let i=n[e];if(i.getStart()<=t&&t<=i.getEnd()&&(i.kind==core_1.ts.SyntaxKind.CallExpression||i.kind==core_1.ts.SyntaxKind.ElementAccessExpression||i.kind==core_1.ts.SyntaxKind.PropertyAccessExpression)){if(i.expression){let e=i.parent;for(;e&&e.kind!==core_1.ts.SyntaxKind.ExportAssignment&&e.kind!==core_1.ts.SyntaxKind.FunctionDeclaration;)e=e.parent;if(!e||e.kind!=core_1.ts.SyntaxKind.FunctionDeclaration)return i}}}}return n||void 0}}function findExportDefaultObjectExpressionAtKeyOffset(e,t){if(!e)return;let n=e.statements.find(core_1.ts.isExportAssignment);if(n){let e=n.expression;if(e&&core_1.ts.isObjectLiteralExpression(e)&&e.pos<=t&&e.end>=t){let n=e.properties,i=n.find((n=>{if(!(n.pos>t||n.end<t))return n.name&&n.name.pos<=t&&n.name.end>=t?e:void 0})),o=n.length>0?n[n.length-1]:void 0;if(i||null==o||o.end<t)return e}}}function inExportDefaultObjectExpression(e,t){return void 0!==findExportDefaultObjectExpressionAtKeyOffset(e,t)}function isStringLiteral(e,t){let n=getTokenAtPosition(e,t);if((null==n?void 0:n.kind)===core_1.ts.SyntaxKind.StringLiteral){return{isInString:!0,flag:n.getText().startsWith("'")?"'":'"'}}return{isInString:!1}}function isObjectLiteralKey(e,t){let n=getTokenAtPosition(e,t);for(;n&&!core_1.ts.isSourceFile(n)&&!core_1.ts.isObjectLiteralExpression(n);)n=n.parent;if(n&&core_1.ts.isObjectLiteralExpression(n)){let e=n.properties,i=e.find((e=>!(e.pos>t||e.end<t)&&!!(e.name&&e.name.pos<=t&&e.name.end>=t))),o=e.length>0?e[e.length-1]:void 0;if(i||null==o||o.end<t)return!0}return!1}function isImportElement(e,t){let n=getTokenAtPosition(e,t);return!(!n.parent||n.parent.kind!=core_1.ts.SyntaxKind.NamedImports&&n.parent.kind!=core_1.ts.SyntaxKind.ImportEqualsDeclaration&&n.parent.kind!=core_1.ts.SyntaxKind.ImportSpecifier&&!isJSX(n))||(!(!n||!n.parent||n.parent.kind!==core_1.ts.SyntaxKind.ObjectBindingPattern&&n.parent.kind!==core_1.ts.SyntaxKind.BindingElement)||!(!n||n.kind!==core_1.ts.SyntaxKind.ObjectBindingPattern))}function isFollowedBy(e,t,n){let i=getTokenAtPosition(e,t);if(i){if(core_1.ts.createScanner(core_1.ts.ScriptTarget.ESNext,!0,core_1.ts.LanguageVariant.Standard,e.text,void 0,i.end).scan()===core_1.ts.SyntaxKind.OpenParenToken)return!0}return!1}function isJSX(e){return(e.kind===core_1.ts.SyntaxKind.JsxText||e.kind===core_1.ts.SyntaxKind.Identifier)&&(e.parent.kind===core_1.ts.SyntaxKind.JsxSelfClosingElement||e.parent.kind===core_1.ts.SyntaxKind.JsxElement)}exports.getArgumentsSpecialStringType=getArgumentsSpecialStringType,exports.getTokenAtPosition=getTokenAtPosition,exports.getRelevantTokens=getRelevantTokens,exports.getTouchingPropertyName=getTouchingPropertyName,exports.isInString=isInString,exports.findExportThisExpressionAtOffset=findExportThisExpressionAtOffset,exports.findExportDefaultObjectExpressionAtKeyOffset=findExportDefaultObjectExpressionAtKeyOffset,exports.inExportDefaultObjectExpression=inExportDefaultObjectExpression,exports.isStringLiteral=isStringLiteral,exports.isObjectLiteralKey=isObjectLiteralKey,exports.isImportElement=isImportElement,exports.isFollowedBy=isFollowedBy;
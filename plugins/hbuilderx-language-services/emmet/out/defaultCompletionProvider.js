"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.DefaultCompletionItemProvider=void 0;const vscode=require("vscode"),vscode_css_languageservice_1=require("../../packages/vscode-css-languageservice"),utils_1=require("../../utils"),abbreviationActions_1=require("./abbreviationActions"),parseDocument_1=require("./parseDocument"),util_1=require("./util");class DefaultCompletionItem extends vscode.CompletionItem{}const autisticList=["br","hr","img","link","area","input","source","meta"];function inTheAutisticList(e){for(const t of autisticList){if(e.startsWith(t))return!0;if("base"===e)return!0}return!1}class DefaultCompletionItemProvider{provideCompletionItems(e,t,i,n){const o=this.provideCompletionItemsInternal(e,t,n);if(o)return o.then((e=>{if(!e||!e.items.length)return this.lastCompletionType=void 0,e;const t=e.items[0],i=t.documentation?t.documentation.toString():"";return i.startsWith("<")?this.lastCompletionType="html":i.indexOf(":")>0&&i.endsWith(";")?this.lastCompletionType="css":this.lastCompletionType=void 0,e}));this.lastCompletionType=void 0}provideCompletionItemsInternal(e,t,i){var n,o,s,a;let r=vscode.workspace.getConfiguration().get("emmet.codeassist");if(void 0===r&&(r=!0),!r)return;const l=(0,util_1.getPackageJsonConfiguration)(),u=l.excludeLanguages?l.excludeLanguages:[];if(u.indexOf(e.languageId)>-1)return;if(("vue"===e.languageId||"nvue"===e.languageId)&&e.getText(new vscode.Range(new vscode.Position(t.line,0),t)).replace(/\s/g,"").includes("<style"))return;if(("vue"===e.languageId||"nvue"===e.languageId||"html"===e.languageId)&&e.getText(new vscode.Range(new vscode.Position(t.line,0),t)).replace(/\s/g,"").includes("{{"))return;const c=(0,util_1.getMappingForIncludedLanguages)(),d=!!c[e.languageId];let g=(0,util_1.getEmmetMode)(d?c[e.languageId]:e.languageId,c,u);if(!g||"never"===l.showExpandedAbbreviation||(d||"jsx"===g)&&"always"!==l.showExpandedAbbreviation)return;let m,v,p=g,f="html"===p||"jsx"===p||"xml"===p;const h=(0,util_1.toLSTextDocument)(e);t=e.validatePosition(t);const x=new vscode.Range(t.line,0,t.line,t.character);if(e.getText(x).trimStart().startsWith("//"))return;const b=(0,util_1.getEmmetHelper)();if("html"===p){if(i.triggerKind===vscode.CompletionTriggerKind.TriggerForIncompleteCompletions)switch(this.lastCompletionType){case"html":f=!1;break;case"css":f=!1,p="css"}if(f){const i=e.offsetAt(t);let r;try{r=(0,parseDocument_1.getRootNode)(e,!0)}catch(e){console.log(`[PluginHost] Emmet <getRootNode> Error!: ${e}`)}const l=(0,util_1.getHtmlFlatNode)(e.getText(),r,i,!1);if(l)if("script"===l.name){const e=null===(n=l.attributes)||void 0===n?void 0:n.find((e=>"type"===e.name.toString()));if(!e)return;{const t=e.value.toString();if("application/javascript"===t||"text/javascript"===t){if(!(0,abbreviationActions_1.getSyntaxFromArgs)({language:"javascript"}))return;f=!1}else util_1.allowedMimeTypesInScriptTag.includes(t)&&(f=!1)}}else if("style"===l.name)p="css",f=!1;else{const e=null===(o=l.attributes)||void 0===o?void 0:o.find((e=>"style"===e.name.toString()));e&&(null===(s=e.value)||void 0===s?void 0:s.start)<=i&&i<=(null===(a=e.value)||void 0===a?void 0:a.end)&&(p="css",f=!1)}}}const _=(0,util_1.isStyleSheet)(p)?{lookAhead:!1,syntax:"stylesheet"}:{lookAhead:!0,syntax:"markup"},I=b.extractAbbreviation(h,t,_);if(!I||!b.isAbbreviationValid(p,I.abbreviation))return;const S=e.offsetAt(t);if((0,util_1.isStyleSheet)(e.languageId)&&i.triggerKind!==vscode.CompletionTriggerKind.TriggerForIncompleteCompletions){if(f=!0,m=!0===l.optimizeStylesheetParsing&&e.lineCount>1e3?(0,util_1.parsePartialStylesheet)(e,t):(0,parseDocument_1.getRootNode)(e,!0),!m)return;v=(0,util_1.getFlatNode)(m,S,!0)}if(!(0,util_1.isStyleSheet)(e.languageId)&&(0,util_1.isStyleSheet)(p)&&i.triggerKind!==vscode.CompletionTriggerKind.TriggerForIncompleteCompletions){if(f=!0,m=(0,parseDocument_1.getRootNode)(e,!0),!m)return;let i=(0,util_1.getFlatNode)(m,S,!0),n=(0,util_1.getEmbeddedCssNodeIfAny)(e,i,t);v=(0,util_1.getFlatNode)(n,S,!0)}if(f&&!(0,abbreviationActions_1.isValidLocationForEmmetAbbreviation)(e,m,v,p,S,toRange(I.abbreviationRange)))return;let T=Promise.resolve();if(!(0,util_1.isStyleSheet)(p)&&("javascript"===e.languageId||"javascriptreact"===e.languageId||"typescript"===e.languageId||"typescriptreact"===e.languageId)){let t=I.abbreviation;T=t.startsWith("this.")?Promise.resolve(!0):vscode.commands.executeCommand("vscode.executeDocumentSymbolProvider",e.uri).then((e=>e&&e.find((e=>t===e.name||t.startsWith(e.name+".")&&!/>|\*|\+/.test(t)))))}return T.then((i=>{var n;if(i)return;const o=(0,util_1.getEmmetConfiguration)(p),s=b.doComplete((0,util_1.toLSTextDocument)(e),t,p,o);if(s&&s.items&&1===s.items.length){if("widows: ;"===s.items[0].label)return;const i=e.getText(new vscode.Range(new vscode.Position(t.line,0),t));if("max-resolution: ;"===s.items[0].label&&!i.includes("media"))return;if(s.items[0].label.startsWith("@media")&&i.includes("saturate("))return;if("html"===p){let t=null===(n=s.items[0].textEdit)||void 0===n?void 0:n.range;if(t){let i=new vscode.Position(t.start.line,t.start.character-1),n=new vscode.Position(t.start.line,t.start.character),o=e.getText(new vscode.Range(i,n));if(/.*[\u4e00-\u9fa5]+.*$/.test(o))return}}}let a=[];return s&&s.items&&s.items.forEach((e=>{var t,i;if(inTheAutisticList(e.label)){let t=e.documentation.toString();e.documentation=t.replace(/>/," />");let i=e.textEdit.newText;e.textEdit.newText=i.replace(/>/," />")}let n=new DefaultCompletionItem(e.label);if(null===(t=e.documentation)||void 0===t?void 0:t.toString().startsWith("<")){let t=e.documentation.toString();e.documentation=t.replace(/</g,"&lt;").replace(/>/g,"&gt;")}n.documentation=e.documentation,n.detail=e.detail,n.insertText=new vscode.SnippetString(e.textEdit.newText);let o=e.textEdit.range;n.range=new vscode.Range(o.start.line,o.start.character,o.end.line,o.end.character),n.filterText=e.filterText,n.sortText=e.sortText,!0===l.showSuggestionsAsSnippets&&(n.kind=vscode.CompletionItemKind.Snippet);const s=e.documentation?e.documentation.toString():"";if(s.includes(":")){const e=s.indexOf(":"),t=s.substring(0,e).trim();let i=!1;const o=(0,vscode_css_languageservice_1.getDefaultCSSDataProvider)().provideProperties().find((e=>e.name===t));if(o&&o.restrictions){for(const e of o.restrictions){(0,utils_1.includesList)(e,utils_1.numberType)&&(i=!0);break}i&&(n.data={hxOption:{altMode:!0}})}}(null===(i=e.documentation)||void 0===i?void 0:i.toString().startsWith("&lt;"))&&e.label.includes("*")&&(n.data={hxOption:{altMode:!0}}),a.push(n)})),new vscode.CompletionList(a,!0)}))}}function toRange(e){return new vscode.Range(e.start.line,e.start.character,e.end.line,e.end.character)}exports.DefaultCompletionItemProvider=DefaultCompletionItemProvider;
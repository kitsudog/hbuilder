"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o);var i=Object.getOwnPropertyDescriptor(t,o);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,r,i)}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ScssCompletionProcessor=void 0;const fs=__importStar(require("fs")),path=__importStar(require("path")),vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),vscode_uri_1=require("vscode-uri"),core_1=require("../../../../../../core"),node_1=require("../../../../../../htmlservice/entry/out/node"),serviceTypes_1=require("../../../../serviceTypes"),contextCompletionProcessor_1=require("../context/contextCompletionProcessor"),extraProcessor_1=require("../grammar/extraProcessor"),grammarProcessor_1=require("../grammar/grammarProcessor"),util_1=require("../utils/util"),baseCompletionProcessor_1=require("./baseCompletionProcessor");class ScssCompletionProcessor extends baseCompletionProcessor_1.BaseCompletionProcessor{constructor(){super(...arguments),this.baseCompletionProcessor=new baseCompletionProcessor_1.BaseCompletionProcessor}getTagCompletionData(e,t,o,r,i){if(!(0,util_1.styleIsRightCompletionType)(r,[serviceTypes_1.NodeType.Media,serviceTypes_1.NodeType.MediaQuery],void 0,serviceTypes_1.NodeType.Media))return i;const s=t.offsetAt(o),n=(0,core_1.getContextData)(t,s,void 0).leftText;let a=(0,node_1.getHtmlTags)(e),l=vscode_languageserver_protocol_1.Position.create(o.line,o.character-n.length);for(const e of a)i.items.push({label:e,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(vscode_languageserver_protocol_1.Range.create(l,o),e),kind:vscode_languageserver_protocol_1.CompletionItemKind.Keyword,data:{hxKind:core_1.HxIconKind.ELEMENT}});return i}getExclamatoryKeyword(e,t,o,r,i){const s=(0,util_1.styleIsRightCompletionType)(r,[serviceTypes_1.NodeType.Declaration,serviceTypes_1.NodeType.Declarations,serviceTypes_1.NodeType.VariableDeclaration],void 0,serviceTypes_1.NodeType.Declaration),n=t.offsetAt(o),a=(0,core_1.getContextData)(t,n,' \t\n\r":{[()]},*>+;');if(!s){if((null==r?void 0:r.parentNodeType)!==serviceTypes_1.NodeType.ElementNameSelector)return i;if(!"!default".includes(a.context))return i}const l=(0,core_1.getLineTextFromOffset)(t,n);let c=["!global","!default"];if((0,core_1.getLeftLineTextFromOffset)(t,n).includes("$"));else{if(!l.includes("@extend"))return i;c=["!optional"]}a.context.length>1&&(i.items=[]);for(const e of c)i.items.push({label:e,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(a.contextRange,e),kind:vscode_languageserver_protocol_1.CompletionItemKind.Property});return i}getScssGrammarCompletionData(e,t,o,r,i){if((null==r?void 0:r.parentType)===serviceTypes_1.NodeType.MixinReference)return i;r&&!r.isNode||(r=this.getCompletionTypeFromScanner(t,o,this._tokenList));const s=(0,util_1.styleIsRightCompletionType)(r,[serviceTypes_1.NodeType.Identifier],[serviceTypes_1.NodeType.Property],serviceTypes_1.NodeType.Property);return r&&s&&(r.nodeType=serviceTypes_1.NodeType.Selector),(0,grammarProcessor_1.getGrammarCompletionData)(e,t,o,r,i)}getGrammarCompletionData(e,t,o,r,i){let s={uri:vscode_uri_1.URI.parse(e.sourceRoot).toString(),name:e.sourceRoot};return this.getScssGrammarCompletionData(s,t,o,r,i)}getScopedFunctionsCompletionData(e,t,o,r,i){if(!r)return i;const s=t.offsetAt(o),n=(0,core_1.getContextData)(t,s,' \t\n\r":{[()]},*>+;');if(""===n.context){if(!(0,util_1.styleIsRightCompletionType)(r,[serviceTypes_1.NodeType.Declarations,serviceTypes_1.NodeType.Ruleset],void 0,serviceTypes_1.NodeType.Value))return i}else{const e=(0,util_1.styleIsRightCompletionType)(r,[serviceTypes_1.NodeType.Identifier,serviceTypes_1.NodeType.Term],void 0,serviceTypes_1.NodeType.Value);if(r.parentType===serviceTypes_1.NodeType.MixinReference)return i;if(!e)return i}let a=vscode_uri_1.URI.parse(t.uri).fsPath;if(a.includes(".nvue.")||a.includes(".vue.")||a.includes(".uvue."))for(const e of extraProcessor_1.vueStyleScopedFunction)i.items.push({label:e.label,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(n.contextRange,e.insertText),kind:vscode_languageserver_protocol_1.CompletionItemKind.Function,data:{hxKind:core_1.HxIconKind.FUNCTION}});return i}getGlobalVariable(e,t,o,r,i){if(r&&!r.isNode||(r=(0,contextCompletionProcessor_1.getCompletionTypeFromScanner)(t,o,this._tokenList)),!r)return i;if(!(0,util_1.styleIsRightCompletionType)(r,void 0,void 0,serviceTypes_1.NodeType.Value))return i;if(e.kind!==core_1.HXProjectKind.UniApp)return i;let s=path.resolve(e.fsPath,"uni.scss");if(!fs.existsSync(s))return i;let n=vscode_languageserver_textdocument_1.TextDocument.create(s,"scss",0,fs.readFileSync(s,{encoding:"utf-8"})),a=(0,serviceTypes_1.getSCSSLanguageService)().parseStylesheet(n),l=[];a.accept((e=>{var t;return e.type===serviceTypes_1.NodeType.VariableDeclaration&&e.children&&2===e.children.length&&e.children[0]&&e.children[0].getText()&&l.push({label:e.children[0].getText(),detail:null===(t=e.children[1])||void 0===t?void 0:t.getText()}),!0}));const c=t.offsetAt(o),p=(0,core_1.getContextData)(t,c,' \t\n\r":{[()]},*>+;');let d="file://";"win32"===process.platform&&(d="file:///");for(const e of l)i.items.push({label:e.label,documentation:`${e.detail}\n                定义于：<br><a href="${d}${s}">${s}</a>`,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(p.contextRange,e.label),kind:vscode_languageserver_protocol_1.CompletionItemKind.Property});return i}getExtraCompletionData(e,t,o,r,i){let s={uri:vscode_uri_1.URI.parse(e.sourceRoot).toString(),name:e.sourceRoot};return i=this.baseCompletionProcessor.getExtraCompletionData(e,t,o,r,i),i=this.getTagCompletionData(s,t,o,r,i),i=this.getExclamatoryKeyword(s,t,o,r,i),i=this.getScopedFunctionsCompletionData(e,t,o,r,i),i=this.getGlobalVariable(e,t,o,r,i)}async doExtraCompletion(e,t,o,r,i,s,n,a,l){this._tokenList=(0,contextCompletionProcessor_1.getTokenList)(t);const c=(0,util_1.isErrorAstNode)(t,o,r);let p=(0,util_1.getAstNodeTypeFromPosition)(t,o,r);return(c||0===i.items.length)&&(p=this.getCompletionTypeFromScanner(t,o,this._tokenList),i=this.getCompletionDataFromScanner(t,o,p,n)),i.items&&(i.items=i.items.map((e=>(e=this.initData(e),e=this.kindConverted(e),e=this.addReplace(t,o,e))))),i=this.getUniPlatformCompletionData(i,e,l),i=this.getDeprecatedCompletionData(t,o,p,i),i=this.filterCalcFunction(t,o,i,n),i=this.getMediaCompletionData(t,o,p,i),i=this.getCharsetCompletionData(t,o,p,i),i=await this.getPathCompletionData(e,t,o,p,i,n),i=this.getPropertySelectorCompletionData(e,t,o,p,i),i=this.getExtraCompletionData(e,t,o,p,i),i=this.getSelfIdSelectorCompletionData(t,o,p,i),i=await this.getIndexIdSelectorsCompletionData(e,t,o,p,i),i=await this.getIndexClassSelectorsCompletionData(e,t,o,p,i),i=this.getGrammarCompletionData(e,t,o,p,i),i=this.getPxConversionCompletionData(e,t,o,p,i,s),i=this.getDeduplicationData(i),i=this.getFiltrationPseudoData(t,o,p,i),i=this.retrieveRange(t,o,p,i),i=this.getMoveCursorData(t,o,p,i),i=this.getAltMode(t,o,p,i),i=this.setData(i)}}exports.ScssCompletionProcessor=ScssCompletionProcessor;
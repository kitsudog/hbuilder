"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BaseCompletionProcessor=void 0;const vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),vscode_uri_1=require("vscode-uri"),serviceTypes_1=require("../../../../serviceTypes"),core_1=require("../../../../../../core"),node_1=require("../../../../../../htmlservice/entry/out/node"),specialStringPlugin_1=require("../../../../../../specialStringPlugin"),contextCompletionProcessor_1=require("../context/contextCompletionProcessor"),extraProcessor_1=require("../grammar/extraProcessor"),grammarProcessor_1=require("../grammar/grammarProcessor"),util_1=require("../utils/util"),SnippetFormat=vscode_languageserver_protocol_1.InsertTextFormat.Snippet;class BaseCompletionProcessor{constructor(){this._tokenList=[],this.getCompletionTypeFromScanner=contextCompletionProcessor_1.getCompletionTypeFromScanner,this.getCompletionDataFromScanner=contextCompletionProcessor_1.getCompletionDataFromScanner}async doExtraCompletion(e,t,o,r,i,n,s,a,c){this._tokenList=(0,contextCompletionProcessor_1.getTokenList)(t);const l=(0,util_1.isErrorAstNode)(t,o,r);let d=(0,util_1.getAstNodeTypeFromPosition)(t,o,r);return(l||0===i.items.length)&&(d=this.getCompletionTypeFromScanner(t,o,this._tokenList),i=this.getCompletionDataFromScanner(t,o,d,s)),i.items&&(i.items=i.items.map((e=>(e=this.initData(e),e=this.kindConverted(e),e=this.addReplace(t,o,e))))),i=this.getUniPlatformCompletionData(i,e,c),i=this.getDeprecatedCompletionData(t,o,d,i),i=this.filterCalcFunction(t,o,i,s),i=this.getMediaCompletionData(t,o,d,i),i=this.getCharsetCompletionData(t,o,d,i),i=await this.getPathCompletionData(e,t,o,d,i,s),i=this.getPropertySelectorCompletionData(e,t,o,d,i),i=this.getExtraCompletionData(e,t,o,d,i),i=this.getSelfIdSelectorCompletionData(t,o,d,i),i=await this.getIndexIdSelectorsCompletionData(e,t,o,d,i),i=await this.getIndexClassSelectorsCompletionData(e,t,o,d,i),i=this.getGrammarCompletionData(e,t,o,d,i),(i=this.getPxConversionCompletionData(e,t,o,d,i,n)).items&&(i.items=i.items.map((e=>(e=this.initData(e),e=this.kindConverted(e))))),i=this.getDeduplicationData(i),i=this.getFiltrationPseudoData(t,o,d,i),i=this.retrieveRange(t,o,d,i),i=this.getMoveCursorData(t,o,d,i),i=this.getAltMode(t,o,d,i),i=this.setData(i)}initData(e){let t={data:e.data};return e.data=t,e}getHxKind(e,t,o){if(e)return e;if(t||(t=vscode_languageserver_protocol_1.CompletionItemKind.Text),t===vscode_languageserver_protocol_1.CompletionItemKind.Keyword){const e=Object.keys(serviceTypes_1.html5Tags),t=Object.keys(serviceTypes_1.svgElements);if(e.includes(o)||t.includes(o))return core_1.HxIconKind.ELEMENT;if(o.startsWith("."))return core_1.HxIconKind.CLASS;if(o.startsWith("#"))return core_1.HxIconKind.ID;if(o.startsWith("@"))return core_1.HxIconKind.ATTRIBUTE}else if(t===vscode_languageserver_protocol_1.CompletionItemKind.Function)return o.startsWith(":")?core_1.HxIconKind.CLASS:core_1.HxIconKind.FUNCTION;return core_1.HxIconKind.DEFAULT}kindConverted(e){var t;let o=e.data,r=e.label,i=e.kind,n=null===(t=e.data)||void 0===t?void 0:t.hxKind;return o.hxKind=this.getHxKind(n,i,r),e.data=o,e}addReplace(e,t,o){var r;if(!o.textEdit){const i=e.offsetAt(t),n=(0,core_1.getContextData)(e,i,void 0);o.textEdit=vscode_languageserver_protocol_1.TextEdit.replace(n.contextRange,null!==(r=o.insertText)&&void 0!==r?r:o.label)}return o}getUniPlatformCompletionData(e,t,o){if(!(0,core_1.isUniAppXProject)(t))return e;const r=e.items.filter((e=>!e.fromDataProvider||!!e.uniPlatform&&(0,core_1.uniPlatformCompletionSupport)(e.uniPlatform,o)));return e.items=r,e}getDeprecatedCompletionData(e,t,o,r){return(0,contextCompletionProcessor_1.getDeprecatedPseudoList)(e,t,this._tokenList,o,r)}filterCalcFunction(e,t,o,r){const i=this.getCompletionTypeFromScanner(e,t,this._tokenList);if(!(0,util_1.styleIsRightCompletionType)(i,void 0,void 0,serviceTypes_1.NodeType.Value))return o;if(!i||!i.context)return o;const n=i.context;let s=!1;return r.forEach((e=>{if(s)return;const t=e.provideProperties();for(const e of t){if(n!==e.name)continue;const t=e.restrictions;if(t&&t.length>0)for(const e of t)if(s=(0,core_1.includesList)(e,serviceTypes_1.calcRestrictions),s)break;if(s)break}})),s||(o.items=o.items.filter((e=>"calc()"!==e.label))),o}getMediaType(e){if(e.endsWith("@media"))return"all";if(e.endsWith("not")||e.endsWith("only")||e.endsWith(","))return"mediaType";if(e.endsWith("("))return"mediaFeature";if(e.endsWith(")"))return"mediaLogicalOperator";for(const t of extraProcessor_1.mediaTypes)if(e.endsWith(t.name))return"mediaLogicalOperator"}getMediaCompletionData(e,t,o,r){if(!(0,util_1.styleIsRightCompletionType)(o,[serviceTypes_1.NodeType.Media,serviceTypes_1.NodeType.MediaQuery],void 0,serviceTypes_1.NodeType.Media))return r;const i=e.offsetAt(t),n=(0,core_1.getContextData)(e,i,void 0);let s=vscode_languageserver_protocol_1.Range.create(vscode_languageserver_protocol_1.Position.create(t.line,0),n.contextRange.start),a=e.getText(s).trim(),c=this.getMediaType(a);if(!c)return r;switch(r.items=[],"all"===c&&(r.items.push({label:"ont",detail:"mediaLogicalOperator",textEdit:vscode_languageserver_protocol_1.TextEdit.replace(n.contextRange,"ont"),kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,data:{hxKind:core_1.HxIconKind.ATTRIBUTE}}),r.items.push({label:"only",detail:"mediaLogicalOperator",textEdit:vscode_languageserver_protocol_1.TextEdit.replace(n.contextRange,"only"),kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,data:{hxKind:core_1.HxIconKind.ATTRIBUTE}})),c){case"all":case"mediaType":for(const e of extraProcessor_1.mediaTypes)r.items.push({label:e.name,detail:"mediaType",documentation:e.description,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(n.contextRange,e.name),kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,data:{hxKind:core_1.HxIconKind.ATTRIBUTE}});break;case"mediaLogicalOperator":for(const e of extraProcessor_1.mediaLogicalOperators)r.items.push({label:e,detail:"mediaLogicalOperator",textEdit:vscode_languageserver_protocol_1.TextEdit.replace(n.contextRange,e),kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,data:{hxKind:core_1.HxIconKind.ATTRIBUTE}});break;case"mediaFeature":for(const e of extraProcessor_1.mediaFeatures)r.items.push({label:e.name,detail:"mediaFeature",documentation:e.description,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(n.contextRange,e.name),kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,data:{hxKind:core_1.HxIconKind.ATTRIBUTE}})}return r}getCharsetCompletionData(e,t,o,r){if(!(0,util_1.styleIsRightCompletionType)(o,[serviceTypes_1.NodeType.Stylesheet],void 0,void 0,"charset"))return r;const i=e.offsetAt(t);if(!(0,core_1.getLineTextFromOffset)(e,i).includes("@charset"))return r;const n=(0,core_1.getContextData)(e,i," \t\n\r\"':{[()]},*>+").contextRange;r.items=[];for(const e of extraProcessor_1.charsetFeatures)r.items.push({label:e.name,documentation:e.description,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(n,e.name),kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,data:{hxKind:core_1.HxIconKind.ATTRIBUTE}});return r}async getPathCompletionData(e,t,o,r,i,n){if(!r)return i;const s=(0,util_1.styleIsRightCompletionType)(r,[serviceTypes_1.NodeType.Import,serviceTypes_1.NodeType.StringLiteral],void 0,serviceTypes_1.NodeType.Import),a=(0,util_1.styleIsRightCompletionType)(r,[serviceTypes_1.NodeType.URILiteral],[serviceTypes_1.NodeType.URILiteral],serviceTypes_1.NodeType.URILiteral);if(!s&&!a)return i;const c=(0,core_1.getLineTextFromPosition)(t,o);if(s&&!c.includes("@import"))return i;let l=!1;(s||a&&c.includes("@import"))&&(l=!0);const d=t.offsetAt(o),p=(0,core_1.getContextData)(t,d," \t\n\r'\":{[()]},*>+");let _=[],g={range:p.contextRange,kind:a?specialStringPlugin_1.StringLocationInfoKind.IN_CSS_URL_LIKE:specialStringPlugin_1.StringLocationInfoKind.IN_CSS_LIKE,ast:void 0,project:e},u=new Map,m=specialStringPlugin_1.StringServicesContainer.create(u),x=new Map;if(x.set("css",["HBuilderX.CssImportURIString"]),x.set("scss",["HBuilderX.ScssImportURIString"]),x.set("less",["HBuilderX.LessImportURIString"]),x.set("image",["HBuilderX.ImageURIString"]),x.set("font",["HBuilderX.FontURIString"]),l){let e=x.get(t.languageId);e&&(_=e),i=await(0,specialStringPlugin_1.specialStringDoCompleteAsync)(_,t,o,g,m,[])}else{const e=c.indexOf(":"),r=c.substring(0,e).trim();if(n.forEach((e=>{const t=e.provideProperties().find((e=>e.name===r));t&&t.restrictions&&t.restrictions.forEach((e=>{let t=x.get(e);t&&_.push(...t)}))})),0===_.length)return i;i=await(0,specialStringPlugin_1.specialStringDoCompleteAsync)(_,t,o,g,m,[])}return i}getPropertySelectorCompletionData(e,t,o,r,i){if(r&&!r.isNode||(r=(0,contextCompletionProcessor_1.getCompletionTypeFromScanner)(t,o,this._tokenList)),!r)return i;if(!(0,util_1.styleIsRightCompletionType)(r,void 0,void 0,serviceTypes_1.NodeType.AttributeSelector))return i;const n=t.offsetAt(o),s=(0,core_1.getContextData)(t,n,void 0),a=r.context;let c=[],l={uri:vscode_uri_1.URI.parse(e.sourceRoot).toString(),name:e.sourceRoot};const d=Object.keys(serviceTypes_1.html5Tags);c=a&&d.includes(a)?(0,node_1.getTagAttributes)(l,a):(0,node_1.getTagAttributes)(l),i.items=[];for(const e of c)i.items.push({label:e,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(s.contextRange,e),kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,data:{hxKind:core_1.HxIconKind.ATTRIBUTE}});return i}getScopedSelectorCompletionData(e,t,o,r,i){let n=vscode_uri_1.URI.parse(t.uri).fsPath;if(!(n.includes(".nvue.")||n.includes(".vue.")||n.includes(".uvue.")))return i;if(r&&!r.isNode||(r=this.getCompletionTypeFromScanner(t,o,this._tokenList)),!r)return i;if(!r.context)return i;if(!(0,util_1.styleIsRightCompletionType)(r,void 0,void 0,serviceTypes_1.NodeType.PseudoSelector))return i;const s=t.offsetAt(o),a=(0,core_1.getContextData)(t,s,' \t\n\r":{[()]},*>+').contextRange;a.start.character=a.start.character-r.context.length;for(const e of extraProcessor_1.vueStyleScopedSelector)i.items.push({label:e,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(a,e),kind:vscode_languageserver_protocol_1.CompletionItemKind.Function,data:{hxKind:core_1.HxIconKind.CLASS}});return i}getScopedFunctionsCompletionData(e,t,o,r,i){if((0,core_1.isUniAppXProject)(e))return i;let n=vscode_uri_1.URI.parse(t.uri).fsPath;if(!(n.includes(".nvue.")||n.includes(".vue.")||n.includes(".uvue.")))return i;if(r&&!r.isNode||(r=(0,contextCompletionProcessor_1.getCompletionTypeFromScanner)(t,o,this._tokenList)),!r)return i;if(!(0,util_1.styleIsRightCompletionType)(r,void 0,void 0,serviceTypes_1.NodeType.Value))return i;const s=t.offsetAt(o),a=(0,core_1.getContextData)(t,s,' \t\n\r":{[()]},*>+;');for(const e of extraProcessor_1.vueStyleScopedFunction)i.items.push({label:e.label,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(a.contextRange,e.insertText),kind:vscode_languageserver_protocol_1.CompletionItemKind.Function,data:{hxKind:core_1.HxIconKind.FUNCTION}});return i}getExtraCompletionData(e,t,o,r,i){return i=this.getScopedSelectorCompletionData(e,t,o,r,i),i=this.getScopedFunctionsCompletionData(e,t,o,r,i)}getSelfIdSelectorCompletionData(e,t,o,r){if(!(0,util_1.styleIsRightCompletionType)(o,void 0,[serviceTypes_1.NodeType.ClassSelector,serviceTypes_1.NodeType.IdentifierSelector,serviceTypes_1.NodeType.ElementNameSelector],serviceTypes_1.NodeType.Selector))return r;const i=e.offsetAt(t),n=(0,core_1.getContextData)(e,i,void 0),s=n.context,a={};a[s]=!0;return(0,contextCompletionProcessor_1.getTokenList)(e).forEach((e=>{e.type===serviceTypes_1.TokenType.Hash&&"#"===e.text.charAt(0)&&(a[e.text]||(a[e.text]=!0,r.items.push({label:e.text,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(n.contextRange,e.text),kind:vscode_languageserver_protocol_1.CompletionItemKind.Keyword,data:{hxKind:core_1.HxIconKind.ID}})))})),r}getSelfClassSelectorCompletionData(e,t,o,r){if(!(0,util_1.styleIsRightCompletionType)(o,void 0,[serviceTypes_1.NodeType.ClassSelector,serviceTypes_1.NodeType.IdentifierSelector,serviceTypes_1.NodeType.ElementNameSelector],serviceTypes_1.NodeType.Selector))return r;const i=e.offsetAt(t),n=(0,core_1.getContextData)(e,i,void 0),s=n.context,a={};a[s]=!0;return(0,contextCompletionProcessor_1.getTokenList)(e).forEach((e=>{e.type===serviceTypes_1.TokenType.Hash&&"."===e.text.charAt(0)&&(a[e.text]||(a[e.text]=!0,r.items.push({label:e.text,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(n.contextRange,e.text),kind:vscode_languageserver_protocol_1.CompletionItemKind.Keyword,data:{hxKind:core_1.HxIconKind.CLASS}})))})),r}async getIndexIdSelectorsCompletionData(e,t,o,r,i){if(!(0,util_1.styleIsRightCompletionType)(r,void 0,[serviceTypes_1.NodeType.ClassSelector,serviceTypes_1.NodeType.IdentifierSelector,serviceTypes_1.NodeType.ElementNameSelector],serviceTypes_1.NodeType.Selector))return i;const n=t.offsetAt(o),s=(0,core_1.getContextData)(t,n,void 0),a={range:s.contextRange,kind:specialStringPlugin_1.StringLocationInfoKind.IN_HTML_LIKE,ast:void 0,project:e};let c=new Map;const l=specialStringPlugin_1.StringServicesContainer.create(c),d=await(0,specialStringPlugin_1.specialStringDoCompleteAsync)(["HBuilderX.IDString"],t,o,a,l,[]);for(const e of d.items)e.label="#"+e.label,e.textEdit=vscode_languageserver_protocol_1.TextEdit.replace(s.contextRange,e.label);return i.items.push(...d.items),i}async getIndexClassSelectorsCompletionData(e,t,o,r,i){if(!(0,util_1.styleIsRightCompletionType)(r,void 0,[serviceTypes_1.NodeType.ClassSelector,serviceTypes_1.NodeType.IdentifierSelector,serviceTypes_1.NodeType.ElementNameSelector],serviceTypes_1.NodeType.Selector))return i;const n=t.offsetAt(o),s=(0,core_1.getContextData)(t,n,void 0),a={range:s.contextRange,kind:specialStringPlugin_1.StringLocationInfoKind.IN_HTML_LIKE,ast:void 0,project:e};let c=new Map;const l=specialStringPlugin_1.StringServicesContainer.create(c),d=await(0,specialStringPlugin_1.specialStringDoCompleteAsync)(["HBuilderX.ClassString"],t,o,a,l,[]);for(const e of d.items)e.label="."+e.label,e.textEdit=vscode_languageserver_protocol_1.TextEdit.replace(s.contextRange,e.label);return i.items.push(...d.items),i}getGrammarCompletionData(e,t,o,r,i){let n={uri:vscode_uri_1.URI.parse(e.sourceRoot).toString(),name:e.sourceRoot};return(0,grammarProcessor_1.getGrammarCompletionData)(n,t,o,r,i)}pxConversion(e,t,o,r,i){const n=e.offsetAt(t),s=(0,core_1.getContextData)(e,n,' \t\n\r":{[()]},*>+;'),a=s.context;if(!a.endsWith("p")&&!a.endsWith("px"))return o;const c=r.getHostPreferences();let l=1,d=2;if(i){if(!(0,core_1.getConfigurationValue)(c,"editor.codeassist.px2upx.enabel",!0))return o;let e=(0,core_1.getConfigurationValue)(c,"editor.codeassist.px2upx.proportion","1"),t=(0,core_1.getConfigurationValue)(c,"editor.codeassist.px2upx.decimalLength",2);l=parseFloat(e),d=t}else{if(!(0,core_1.getConfigurationValue)(c,"editor.codeassist.px2rem.enabel",!0))return o;let e=(0,core_1.getConfigurationValue)(c,"editor.codeassist.px2rem.proportion","16"),t=(0,core_1.getConfigurationValue)(c,"editor.codeassist.px2rem.decimalLength",6);l=parseFloat(e),d=t}a.endsWith("px")&&(o.items=[]),o.isIncomplete=!0;const p=a.match(/\d+/);let _="";if(p&&(_=p[0]),""===_)return o;let g=(parseFloat(_)/l).toFixed(d);return g=g.replace(/0+$/,""),g.endsWith(".")&&(g=g.substring(0,g.length-1)),i?(o.items.push({label:p+"px->"+g+"upx",sortText:"!_"+p+"px->"+g+"upx",textEdit:vscode_languageserver_protocol_1.TextEdit.replace(s.contextRange,g+"upx"),kind:vscode_languageserver_protocol_1.CompletionItemKind.Snippet,data:{hxKind:core_1.HxIconKind.SNIPPET}}),o.items.push({label:p+"px->"+g+"rpx",sortText:"!_"+p+"px->"+g+"rpx",textEdit:vscode_languageserver_protocol_1.TextEdit.replace(s.contextRange,g+"rpx"),kind:vscode_languageserver_protocol_1.CompletionItemKind.Snippet,data:{hxKind:core_1.HxIconKind.SNIPPET}})):o.items.push({label:p+"px->"+g+"rem",sortText:"!_"+p+"px->"+g+"rem",textEdit:vscode_languageserver_protocol_1.TextEdit.replace(s.contextRange,g+"rem"),kind:vscode_languageserver_protocol_1.CompletionItemKind.Snippet,data:{hxKind:core_1.HxIconKind.SNIPPET}}),o}getPxConversionCompletionData(e,t,o,r,i,n){return(0,util_1.styleIsRightCompletionType)(r,[serviceTypes_1.NodeType.NumericValue],void 0,serviceTypes_1.NodeType.Value)?e.kind===core_1.HXProjectKind.UniApp||e.kind===core_1.HXProjectKind.UniApp_Cli?this.pxConversion(t,o,i,n,!0):this.pxConversion(t,o,i,n,!1):i}getDeduplicationData(e){let t=[];for(var o=e.items.length-1;o>=0;--o)t.includes(e.items[o].label)?e.items.splice(o,1):t.push(e.items[o].label);return e}getMoveCursorData(e,t,o,r){if(o&&!o.isNode||(o=(0,contextCompletionProcessor_1.getCompletionTypeFromScanner)(e,t,this._tokenList)),!o)return r;if(!(0,util_1.styleIsRightCompletionType)(o,void 0,void 0,serviceTypes_1.NodeType.Value))return r;const i=e.offsetAt(t);let n=(0,core_1.getContextData)(e,i,void 0).leftText;const s=vscode_languageserver_protocol_1.Position.create(t.line,t.character-n.length),a=(0,core_1.getRightLineTextFromOffset)(e,i).indexOf(";"),c=((0,core_1.getLineTextFromOffset)(e,i),(0,core_1.getRightLineTextFromOffset)(e,i).trim()),l=(0,core_1.getLeftLineTextFromOffset)(e,i),d=l.lastIndexOf(";"),p=l.lastIndexOf(":");c.indexOf(";"),c.indexOf(":");if(-1===a)return r;if(p<d)return r;if(p<t.character&&p>0){if((0,core_1.includesList)(o.context,serviceTypes_1.notMoveCursorProperty,!0))for(const t of r.items){if(t.textEdit&&t.textEdit.newText.includes("$0"))continue;if(t.textEdit&&t.textEdit.newText.includes("$1"))continue;if(t.kind===vscode_languageserver_protocol_1.CompletionItemKind.Function&&t.textEdit&&t.textEdit.newText.includes("$"))continue;if(t.label.endsWith(")"))continue;let o=t.label;t.textEdit?(o=t.textEdit.newText,o.includes("$")&&(o=o.replace(/\$/g,"\\$")),t.textEdit=vscode_languageserver_protocol_1.TextEdit.replace(vscode_languageserver_protocol_1.Range.create(s,e.positionAt(i+a+1)),`${o};$0`)):(o.includes("$")&&(o=o.replace(/\$/g,"\\$")),t.insertText=`${o};$0`),t.command=void 0,t.insertTextFormat=SnippetFormat}return r}return r}getFiltrationPseudoData(e,t,o,r){if(!(0,util_1.styleIsRightCompletionType)(o,[serviceTypes_1.NodeType.PseudoSelector],[serviceTypes_1.NodeType.PseudoSelector],serviceTypes_1.NodeType.PseudoSelector))return r;let i=[];for(const e of r.items)e.label.startsWith(":")&&i.push(e);return r.items=i,r}retrieveRange(e,t,o,r){const i=(0,util_1.styleIsRightCompletionType)(o,[serviceTypes_1.NodeType.ElementNameSelector],[serviceTypes_1.NodeType.ElementNameSelector],serviceTypes_1.NodeType.Property),n=(0,util_1.styleIsRightCompletionType)(o,[serviceTypes_1.NodeType.Identifier],[serviceTypes_1.NodeType.Property],serviceTypes_1.NodeType.Property),s=(0,util_1.styleIsRightCompletionType)(o,[serviceTypes_1.NodeType.Ruleset,serviceTypes_1.NodeType.Declarations],void 0,serviceTypes_1.NodeType.Property);if(!i&&!n&&!s)return r;const a=e.offsetAt(t),c=((0,core_1.getLineTextFromOffset)(e,a),(0,core_1.getRightLineTextFromOffset)(e,a)),l=(0,core_1.getLeftLineTextFromOffset)(e,a);let d=(0,core_1.getContextData)(e,a,void 0).context;const p=l.lastIndexOf(";"),_=l.lastIndexOf(":"),g=c.indexOf(";"),u=(c.indexOf(";",g+1),c.indexOf(":"));c.indexOf(":",u+1);if(_>p)return r;let m=vscode_languageserver_protocol_1.Position.create(t.line,t.character),x=vscode_languageserver_protocol_1.Position.create(t.line,t.character),v=!1;if(-1===p)return r;if(-1!==p){if(l.substring(0,l.length-d.length).endsWith(" ")&&(c.startsWith(" ")||c.startsWith("}")))return r;if(0===c.trim().length&&d.endsWith(";"))v=!0;else{if(0===c.trim().length&&!d.includes(";"))return r;0===c.trim().length&&d.includes(";")||c.startsWith(" ")&&d.includes(";")?(m.character=p+1,x.character=p+d.substring(d.indexOf(";")).length):-1!==u&&-1!==g&&u<g?c.trim().endsWith(":;")||c.trim().endsWith(": ;")?(v=!0,m.character=p+1,x.character=x.character+g+1):d.includes(";")?(m.character=p+1,x.character=x.character+c.indexOf(":")):(m.character=m.character-d.length,x.character=x.character+c.indexOf(":")):-1!==u?(v=!0,d.includes(";")&&(m.character=p+1),m.character=m.character-d.length,x.character=x.character+c.indexOf(":")+1):(m.character=p+1,x.character=p+d.substring(d.indexOf(";")).length)}}let T=vscode_languageserver_protocol_1.Range.create(m,x);return r.items.forEach((e=>{let t=e.label;e.textEdit&&(t=e.textEdit.newText),v&&e.kind==vscode_languageserver_protocol_1.CompletionItemKind.Property&&(t=e.label+": $0;",e.kind=vscode_languageserver_protocol_1.CompletionItemKind.Property,e.insertTextFormat=SnippetFormat,e.command=core_1.retriggerCommand),e.textEdit=vscode_languageserver_protocol_1.TextEdit.replace(T,t)})),r}getAltMode(e,t,o,r){if(o&&!o.isNode||(o=(0,contextCompletionProcessor_1.getCompletionTypeFromScanner)(e,t,this._tokenList)),!o)return r;if(!(0,util_1.styleIsRightCompletionType)(o,void 0,void 0,serviceTypes_1.NodeType.Value))return r;let i=!1;const n=(0,serviceTypes_1.getDefaultCSSDataProvider)().provideProperties().find((e=>e.name===o.context));if(!n||!n.restrictions)return r;for(const e of n.restrictions){(0,core_1.includesList)(e,serviceTypes_1.numberRestrictions)&&(i=!0);break}return i?(r.items.map((e=>{var t,o;let r={data:null===(t=e.data)||void 0===t?void 0:t.data,hxKind:null===(o=e.data)||void 0===o?void 0:o.hxKind,hxOption:{altMode:!0}};return e.data=r,e})),r):r}setData(e){var t,o,r,i;for(const n of e.items){let e={data:null===(t=n.data)||void 0===t?void 0:t.data,hxKind:null!==(r=null===(o=n.data)||void 0===o?void 0:o.hxKind)&&void 0!==r?r:core_1.HxIconKind.ATTRIBUTE,hxOption:null===(i=n.data)||void 0===i?void 0:i.hxOption};n.data=e}return e}}exports.BaseCompletionProcessor=BaseCompletionProcessor;
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getTokenList=exports.getDeprecatedPseudoList=exports.getCompletionTypeFromScanner=exports.getCompletionDataFromScanner=void 0;const vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),core_1=require("../../../../../../core"),serviceTypes_1=require("../../../../serviceTypes"),extraProcessor_1=require("../grammar/extraProcessor"),util_1=require("../utils/util"),SnippetFormat=vscode_languageserver_protocol_1.InsertTextFormat.Snippet,retriggerCommand={title:"Suggest",command:"editor.action.triggerSuggest"};function getTokenList(e){let t=serviceTypes_1.Scanner;"scss"===e.languageId&&(t=serviceTypes_1.SCSSScanner),"less"===e.languageId&&(t=serviceTypes_1.LESSScanner),t.prototype.setSource(e.getText());let o,r=[];for(;o=t.prototype.scan(),r.push(o),o.type!==serviceTypes_1.TokenType.EOF;);return r}function getContextTokenCollection(e,t){let o;if(!(e.length<2)){for(let r=0;r<e.length-1&&r!==e.length-1;r++)if(e[r].offset<=t&&e[r+1].offset>t){o={peekToken:e[r],nextToken:e[r+1],peekIndex:r,nextIndex:r+1};break}return o}}function getNoEmptyTokenIndex(e,t,o){if(e.length<1)return-1;for(;e[t].type===serviceTypes_1.TokenType.Whitespace||e[t].type===serviceTypes_1.TokenType.Comment;){if("prev"===o&&t--,"next"===o&&t++,t>=e.length)return-1;if(t<0)return-1}return t}function getCompletionType(e,t){return{type:e,parentType:e,nodeType:e,parentNodeType:e,isNode:!1,context:t}}function getSimpleCompletionType(e,t){for(let o=e.length-1;o>=0;o--){if(e[o].offset>=t)continue;const r=e[o];if(r.type===serviceTypes_1.TokenType.CurlyR)return getCompletionType(serviceTypes_1.NodeType.Selector);if(r.type===serviceTypes_1.TokenType.BracketL){let t;return t=e[o-1].type===serviceTypes_1.TokenType.Whitespace?e[Math.max(o-2,0)].text:e[o-1].text,getCompletionType(serviceTypes_1.NodeType.AttributeSelector,t)}if(r.type===serviceTypes_1.TokenType.CurlyL)return getCompletionType(serviceTypes_1.NodeType.Property);if(r.type===serviceTypes_1.TokenType.SemiColon)return getCompletionType(serviceTypes_1.NodeType.Property);if(r.type===serviceTypes_1.TokenType.Colon){let t;return t=e[o-1].type===serviceTypes_1.TokenType.Whitespace?e[Math.max(o-2,0)].text:e[o-1].text,getCompletionType(serviceTypes_1.NodeType.Value,t)}}}function inParentheses(e,t,o,r){let n={peekToken:void 0,nextToken:void 0,peekIndex:0,nextIndex:0},s=e.peekIndex-1;for(;s>=0;s--){const e=t[s];if(n.peekToken&&n.nextToken)break;e.type!==o||n.peekToken||(n.peekToken=e,n.peekIndex=s),e.type!==r||n.nextToken||(n.nextToken=e,n.nextIndex=s)}if(n.peekToken&&!(n.nextToken&&n.nextToken.offset>n.peekToken.offset))return n}function isURILiteral(e,t){let o=e.includes("url("),r=t.includes(")");if(o&&r)return getCompletionType(serviceTypes_1.NodeType.URILiteral)}function isMedia(e){if(e.includes("@media"))return getCompletionType(serviceTypes_1.NodeType.Media)}function isImport(e){if(e.includes("@import"))return getCompletionType(serviceTypes_1.NodeType.Import)}function isCharset(e){if(e.includes("@charset"))return{isNode:!1,context:"charset"}}function isAttributeSelector(e,t){const o=inParentheses(e,t,serviceTypes_1.TokenType.BracketL,serviceTypes_1.TokenType.BracketR);if(o&&o){let e,r=o.peekIndex-1;return r>0&&(r=getNoEmptyTokenIndex(t,r,"prev"),r>0&&(e=t[r].text)),getCompletionType(serviceTypes_1.NodeType.AttributeSelector,e)}}function isPseudoSelector(e,t,o){const r=inParentheses(t,o,serviceTypes_1.TokenType.CurlyL,serviceTypes_1.TokenType.CurlyR);let n,s=!1;if(r){if(!(0,core_1.getLineTextFromOffset)(e,r.peekToken.offset).includes("@media")&&"css"===e.languageId)return;s=!0}let i=t.peekIndex-1;if(!(i<0||(o[i].type===serviceTypes_1.TokenType.Ident&&i--,i<0||o[i].type!==serviceTypes_1.TokenType.Colon||(i--,n=":",i<0)))){if(s){let e=t.nextIndex-1;if(o[e].type===serviceTypes_1.TokenType.Ident&&e++,e>o.length-1)return;if(o[e].type===serviceTypes_1.TokenType.Whitespace&&e++,e>o.length-1)return;if(o[e].type===serviceTypes_1.TokenType.SemiColon)return;o[i].type===serviceTypes_1.TokenType.Colon&&(n="::")}else o[i].type===serviceTypes_1.TokenType.Colon&&(n="::");return getCompletionType(serviceTypes_1.NodeType.PseudoSelector,n)}}function isSelector(e,t,o,r){const n=inParentheses(t,o,serviceTypes_1.TokenType.CurlyL,serviceTypes_1.TokenType.CurlyR);let s;if(n){if(!(0,core_1.getLineTextFromOffset)(e,n.peekToken.offset).includes("@media")&&"css"===e.languageId)return;const t=(0,core_1.getLineTextFromOffset)(e,r);if(t.includes(":")||t.includes(";"))return;s="isExtStyle"}return getCompletionType(serviceTypes_1.NodeType.Selector,s)}function isAttribute(e,t,o){if(inParentheses(e,t,serviceTypes_1.TokenType.CurlyL,serviceTypes_1.TokenType.CurlyR)){let o=e.peekIndex-1;if(o<0)return;if(t[o].type===serviceTypes_1.TokenType.SemiColon)return getCompletionType(serviceTypes_1.NodeType.Property);if(t[o].type===serviceTypes_1.TokenType.Ident&&o--,o<0)return;if(o=getNoEmptyTokenIndex(t,o,"prev"),o<0)return;if(t[o].type===serviceTypes_1.TokenType.Colon)return;if(t[o].type!==serviceTypes_1.TokenType.SemiColon&&t[o].type!==serviceTypes_1.TokenType.CurlyL)return;return getCompletionType(serviceTypes_1.NodeType.Property)}}function isExclamatory(e,t,o){if(inParentheses(t,o,serviceTypes_1.TokenType.CurlyL,serviceTypes_1.TokenType.CurlyR)){let e=t.peekIndex;if(o[e].type!==serviceTypes_1.TokenType.Exclamation&&e--,o[e].type===serviceTypes_1.TokenType.Exclamation)return getCompletionType(serviceTypes_1.NodeType.Declaration)}}function isValue(e,t){if(!inParentheses(e,t,serviceTypes_1.TokenType.CurlyL,serviceTypes_1.TokenType.CurlyR))return;let o=!1,r=e.nextIndex-1;if(t[r].type===serviceTypes_1.TokenType.Ident&&r++,t[r].type===serviceTypes_1.TokenType.Hash&&r++,t[r].type===serviceTypes_1.TokenType.Whitespace&&r++,t[r].type===serviceTypes_1.TokenType.Exclamation&&r++,t[r].type===serviceTypes_1.TokenType.Ident&&r++,r<t.length-1&&t[r].type===serviceTypes_1.TokenType.SemiColon&&(o=!0),!o)return;let n=!1,s=e.peekIndex-1;if(!(s<0||(t[s].type===serviceTypes_1.TokenType.CustomToken&&s--,t[s].type===serviceTypes_1.TokenType.Whitespace&&(s--,s<0)))){for(;t[s].type===serviceTypes_1.TokenType.Dimension;){if(s--,s<0)return;if(t[s].type===serviceTypes_1.TokenType.Whitespace&&s--,s<0)return}if(t[s].type===serviceTypes_1.TokenType.Ident&&s--,!(s<0)&&(t[s].type===serviceTypes_1.TokenType.Length&&s--,!(s<0)&&(t[s].type===serviceTypes_1.TokenType.CustomToken&&s--,!(s<0)&&(t[s].type===serviceTypes_1.TokenType.Whitespace&&s--,!(s<0)&&(t[s].type===serviceTypes_1.TokenType.Length&&s--,!(s<0)&&(t[s].type===serviceTypes_1.TokenType.Colon&&(n=!0),n)))))){if(s--,s<0)return;let e;if(t[s].type===serviceTypes_1.TokenType.Whitespace&&s--,s<0)return;return e=t[s].text,getCompletionType(serviceTypes_1.NodeType.Value,e)}}}function getCompletionTypeFromScanner(e,t,o){if(o.length<1)return;const r=e.offsetAt(t);let n=(0,core_1.getLineTextFromOffset)(e,r);const s=(0,core_1.getLeftLineTextFromOffset)(e,r),i=(0,core_1.getRightLineTextFromOffset)(e,r),p=e.positionAt(r),c=e.positionAt(r),a=vscode_languageserver_protocol_1.Range.create(p,c),l=(0,core_1.getContextLineText)(e,a);let d=!1;n.length>500&&(d=!0,n=l);const T=getContextTokenCollection(o,r);if(!T&&o.length>2){let e=getSimpleCompletionType(o,r);if(!e){const e=isURILiteral(s,i);if(e)return e;const t=isMedia(n);if(t)return t;const o=isImport(n);if(o)return o;const r=isCharset(n);if(r)return r}return e}if(!T)return;if(!d){const e=isURILiteral(s,i);if(e)return e}const u=isMedia(n);if(u)return u;const y=isImport(n);if(y)return y;const _=isCharset(n);if(_)return _;const v=isAttributeSelector(T,o);if(v)return v;const m=isPseudoSelector(e,T,o);if(m)return m;const g=isSelector(e,T,o,r);if(g)return g;const f=isAttribute(T,o,r);if(f)return f;const x=isExclamatory(n,T,o);if(x)return x;const k=isValue(T,o);return k||void 0}function getSelectorData(e,t,o){let r=[];r=getPseudoSelectorData(e,t);const n=e.provideAtDirectives();for(const e of n)r.push({label:e.name,documentation:e.description,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(t,e.name),kind:vscode_languageserver_protocol_1.CompletionItemKind.Keyword,uniPlatform:e.uniPlatform,fromDataProvider:!0});for(const e in serviceTypes_1.html5Tags)r.push({label:e,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(t,e),kind:vscode_languageserver_protocol_1.CompletionItemKind.Keyword});for(const e in serviceTypes_1.svgElements)r.push({label:e,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(t,e),kind:vscode_languageserver_protocol_1.CompletionItemKind.Keyword});return"isExtStyle"===o.context&&(r=r.concat(getPropertyData(e,t))),r}function getPropertyData(e,t){let o=[];const r=e.provideProperties();for(const e of r){const r=(255-("number"==typeof e.relevance?Math.min(Math.max(e.relevance,0),99):50)).toString(16),n=(0,serviceTypes_1.startsWith)(e.name,"-")?serviceTypes_1.SortTexts.VendorPrefixed:serviceTypes_1.SortTexts.Normal;let s=e.name+": $0;";o.push({label:e.name,documentation:e.description,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(t,`${s}`),sortText:n+"_"+r,kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,command:retriggerCommand,insertTextFormat:vscode_languageserver_protocol_1.InsertTextFormat.Snippet,uniPlatform:e.uniPlatform,fromDataProvider:!0})}return o}function getColorProposals(e,t){for(const o in serviceTypes_1.colors)e.push({label:o,detail:serviceTypes_1.colors[o].detail,documentation:serviceTypes_1.colors[o].documentation,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(t,o),kind:vscode_languageserver_protocol_1.CompletionItemKind.Color});for(const o in serviceTypes_1.colorKeywords)e.push({label:o,documentation:serviceTypes_1.colorKeywords[o].documentation,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(t,o),kind:vscode_languageserver_protocol_1.CompletionItemKind.Value});for(const o in serviceTypes_1.colorFunctions){const r=serviceTypes_1.colorFunctions[o];e.push({label:r.label,detail:r.detail,documentation:r.documentation,textEdit:t?vscode_languageserver_protocol_1.TextEdit.replace(t,r.insertText):void 0,insertTextFormat:vscode_languageserver_protocol_1.InsertTextFormat.Snippet,kind:vscode_languageserver_protocol_1.CompletionItemKind.Function})}return e}function getPositionProposals(e,t){for(const o in serviceTypes_1.positionKeywords)e.push({label:o,documentation:serviceTypes_1.positionKeywords[o].documentation,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(t,o),kind:vscode_languageserver_protocol_1.CompletionItemKind.Value});return e}function getRepeatStyleProposals(e,t){for(const o in serviceTypes_1.repeatStyleKeywords)e.push({label:o,documentation:serviceTypes_1.repeatStyleKeywords[o].documentation,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(t,o),kind:vscode_languageserver_protocol_1.CompletionItemKind.Value});return e}function getLineStyleProposals(e,t){for(const o in serviceTypes_1.lineStyleKeywords)e.push({label:o,documentation:serviceTypes_1.lineStyleKeywords[o].documentation,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(t,o),kind:vscode_languageserver_protocol_1.CompletionItemKind.Value});return e}function getLineWidthProposals(e,t){for(const o in serviceTypes_1.lineWidthKeywords)e.push({label:o,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(t,o),kind:vscode_languageserver_protocol_1.CompletionItemKind.Value});return e}function getGeometryBoxProposals(e,t){for(const o in serviceTypes_1.geometryBoxKeywords)e.push({label:o,documentation:serviceTypes_1.geometryBoxKeywords[o].documentation,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(t,o),kind:vscode_languageserver_protocol_1.CompletionItemKind.Value});return e}function getBoxProposals(e,t){for(const o in serviceTypes_1.boxKeywords)e.push({label:o,documentation:serviceTypes_1.boxKeywords[o].documentation,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(t,o),kind:vscode_languageserver_protocol_1.CompletionItemKind.Value});return e}function moveCursorInsideParenthesis(e){return e.replace(/\(\)$/,"($1)")}function getImageProposals(e,t){for(const o in serviceTypes_1.imageFunctions){const r=moveCursorInsideParenthesis(o);e.push({label:o,documentation:serviceTypes_1.imageFunctions[o].documentation,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(t,r),kind:vscode_languageserver_protocol_1.CompletionItemKind.Function,insertTextFormat:o!==r?SnippetFormat:void 0})}return e}function getBasicShapeProposals(e,t){for(const o in serviceTypes_1.basicShapeFunctions){const r=moveCursorInsideParenthesis(o);e.push({label:o,documentation:serviceTypes_1.basicShapeFunctions[o].documentation,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(t,r),kind:vscode_languageserver_protocol_1.CompletionItemKind.Function,insertTextFormat:o!==r?SnippetFormat:void 0})}return e}function getTimingFunctionProposals(e,t){for(const o in serviceTypes_1.transitionTimingFunctions){const r=moveCursorInsideParenthesis(o);e.push({label:o,documentation:serviceTypes_1.transitionTimingFunctions[o].documentation,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(t,r),kind:vscode_languageserver_protocol_1.CompletionItemKind.Function,insertTextFormat:o!==r?SnippetFormat:void 0})}return e}function getCSSWideKeywordProposals(e,t){for(const o in serviceTypes_1.cssWideKeywords)e.push({label:o,documentation:serviceTypes_1.cssWideKeywords[o].documentation,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(t,o),kind:vscode_languageserver_protocol_1.CompletionItemKind.Value});for(const o in serviceTypes_1.cssWideFunctions){const r=serviceTypes_1.cssWideFunctions[o],n=moveCursorInsideParenthesis(o);e.push({label:o,documentation:r.documentation,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(t,n),kind:vscode_languageserver_protocol_1.CompletionItemKind.Function,insertTextFormat:SnippetFormat,command:o.startsWith("var")?retriggerCommand:void 0,uniPlatform:r.uniPlatform,fromDataProvider:!0})}return e}function getValueData(e,t,o){let r=[];if(o.context){const n=e.provideProperties().find((e=>e.name===o.context)),s=null==n?void 0:n.values,i=null==n?void 0:n.restrictions;if(s&&s.map((e=>{r.push({label:e.name,documentation:e.description,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(t,e.name),kind:vscode_languageserver_protocol_1.CompletionItemKind.Value,uniPlatform:e.uniPlatform,fromDataProvider:!0})})),i)for(const e of i)switch(e){case"color":r=getColorProposals(r,t);break;case"position":r=getPositionProposals(r,t);break;case"repeat":r=getRepeatStyleProposals(r,t);break;case"line-style":r=getLineStyleProposals(r,t);break;case"line-width":r=getLineWidthProposals(r,t);break;case"geometry-box":r=getGeometryBoxProposals(r,t);break;case"box":r=getBoxProposals(r,t);break;case"image":r=getImageProposals(r,t);break;case"timing-function":r=getTimingFunctionProposals(r,t);break;case"shape":r=getBasicShapeProposals(r,t)}}return r=getCSSWideKeywordProposals(r,t),r}function getPseudoSelectorData(e,t){let o=[];const r=e.providePseudoClasses(),n=e.providePseudoElements();for(const e of r)o.push({label:e.name,documentation:e.description,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(t,e.name),kind:vscode_languageserver_protocol_1.CompletionItemKind.Function,uniPlatform:e.uniPlatform,fromDataProvider:!0});for(const e of n)o.push({label:e.name,documentation:e.description,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(t,e.name),kind:vscode_languageserver_protocol_1.CompletionItemKind.Function,uniPlatform:e.uniPlatform,fromDataProvider:!0});return o}function getCompletionDataFromScanner(e,t,o,r){let n=[];if(!o)return{isIncomplete:false,items:n};const s=e.offsetAt(t);let i=(0,core_1.getContextData)(e,s,' \t\n\r":{[()]},*>+;').contextRange;r.forEach((t=>{let r=[];if(o.nodeType===serviceTypes_1.NodeType.Selector){const n=(0,core_1.getContextData)(e,s,' \t\n\r"{[()]},*>+;');i=n.contextRange,r=getSelectorData(t,i,o)}else o.nodeType===serviceTypes_1.NodeType.Property?r=getPropertyData(t,i):o.nodeType===serviceTypes_1.NodeType.Value?r=getValueData(t,i,o):o.nodeType===serviceTypes_1.NodeType.PseudoSelector&&(i.start.character=i.start.character-o.context.length,r=getPseudoSelectorData(t,i));n=n.concat(r)}));let p=[];return n=n.filter((e=>!p.includes(e.label)&&(p.push(e.label),!0))),{isIncomplete:false,items:n}}function getDeprecatedPseudoList(e,t,o,r,n){r&&!r.isNode||(r=getCompletionTypeFromScanner(e,t,o));if(!(0,util_1.styleIsRightCompletionType)(r,[serviceTypes_1.NodeType.PseudoSelector],[serviceTypes_1.NodeType.PseudoSelector],serviceTypes_1.NodeType.PseudoSelector))return n;const s=e.offsetAt(t),i=(0,core_1.getContextData)(e,s,' \t\n\r"{[()]},*>+;$&');for(const e of extraProcessor_1.deprecatedPseudoElementList)n.items.push({label:e.name,documentation:e.description,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(i.contextRange,e.name),kind:vscode_languageserver_protocol_1.CompletionItemKind.Function,data:{hxKind:core_1.HxIconKind.CLASS}});return n}exports.getTokenList=getTokenList,exports.getCompletionTypeFromScanner=getCompletionTypeFromScanner,exports.getCompletionDataFromScanner=getCompletionDataFromScanner,exports.getDeprecatedPseudoList=getDeprecatedPseudoList;
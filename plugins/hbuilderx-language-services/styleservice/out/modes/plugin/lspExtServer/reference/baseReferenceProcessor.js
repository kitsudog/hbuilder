"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var o=Object.getOwnPropertyDescriptor(t,r);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,o)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.BaseReferenceProcessor=void 0;const path=__importStar(require("path")),core_1=require("../../../../../../core"),serviceTypes_1=require("../../../../serviceTypes"),contextCompletionProcessor_1=require("../context/contextCompletionProcessor"),util_1=require("../utils/util");function isVueFile(e){return(0,core_1.fileEndsWith)(e,[".vue",".uvue",".nvue",".swan",".axml",".ttml",".qml",".nml",".ux"])}class BaseReferenceProcessor{async getAllRefData(e){return await(0,core_1.getAllKindData)(e,"REF",!0)}createRefFileList(e,t,r){let n=(0,core_1.getReferenceList)(t),o=(0,core_1.getReferenceList)(r);n||(n=[]),o||(o=[]);const i=n.concat(o);return i.push(e),i}async getIndexData(e,t){let r;if(r=await e.indexPipeHandler.getIndexDataRequest(t,!0),r&&0!==r.length)return r.forEach((e=>{e=(0,core_1.styleNormalizedData)(e)})),r}filterAndGeneration(e,t,r){const n=[];e.forEach((e=>{const r=(0,core_1.lspFilterIndexData)(e,t);n.push(r)}));const o=[];return n.forEach((e=>{const t=(0,core_1.creatorExtLocationLinksFromIndexData)(e,r);o.unshift(...t)})),o}async getReferencesData(e,t,r){const n=e.project,o=(e.completionType,e.fileUri),i=e.contextData,s=(0,core_1.noTsToNormalizedUri)(n.fsPath);if(!s)return t;const c=await this.getAllRefData(n),a=(0,core_1.iterateGetReference)(c,[o],new Map),l=(0,core_1.iterateGetBackReference)(c,[o],new Map),u=this.createRefFileList(o,a,l),f=(0,core_1.noTsToNormalizedUri)(path.join(n.fsPath,"uni.scss"));f&&u&&u.push(f);let p=!1;for(let e of l.keys()){if(path.basename(e).startsWith("App.")){p=!0;break}}let d=[];if(p)d=[{projectUri:s,kind:r}];else{const e={projectUri:s,kind:r};d=(0,core_1.getIndexDataOptionsFromList)(u,e)}const _=await this.getIndexData(n,d);if(!_)return t;const h={options:{text:i.context,needRange:!0},filter:function(e,t){let r=!1,n=!1;void 0!==t.options.text&&t.options.text===e.value&&(r=!0),t.options.needRange&&e.range&&(n=!0);return!(r&&n)}};let y=this.filterAndGeneration(_,h,i.contextRange);return p&&(y=y.filter((e=>!!isVueFile(e.targetUri)||!!(null==u?void 0:u.includes(e.targetUri))))),t||(t=[]),t.unshift(...y),t}async getIdReferences(e,t){const r=e.completionType,n=e.contextData;if(!(0,util_1.styleIsRightCompletionType)(r,void 0,[serviceTypes_1.NodeType.IdentifierSelector],serviceTypes_1.NodeType.Selector))return t;if(!r.isNode&&!n.context.startsWith("#"))return t;const o=await this.getReferencesData(e,t,"ID");return o?(t||(t=[]),t.unshift(...o),t):t}async getClassReferences(e,t){const r=e.completionType,n=e.contextData;if(!(0,util_1.styleIsRightCompletionType)(r,void 0,[serviceTypes_1.NodeType.ClassSelector],serviceTypes_1.NodeType.Selector))return t;if(!r.isNode&&!n.context.startsWith("."))return t;const o=await this.getReferencesData(e,t,"CLASS");return o?(t||(t=[]),t.unshift(...o),t):t}initialize(e,t,r,n){const o=n,i=(0,util_1.isErrorAstNode)(t,r,o);let s=(0,util_1.getAstNodeTypeFromPosition)(t,r,o);if(i){const e=(0,contextCompletionProcessor_1.getTokenList)(t);s=(0,contextCompletionProcessor_1.getCompletionTypeFromScanner)(t,r,e)}if(!s)return;const c=t.offsetAt(r),a=(0,core_1.getContextData)(t,c,void 0);let l=(0,core_1.noTsToNormalizedPath)(t.uri);if(!l)return;l.includes(".vue.")&&(l=l.replace(/\.vue\.(.*)/,".vue")),l.includes(".nvue.")&&(l=l.replace(/\.nvue\.(.*)/,".nvue")),l.includes(".uvue.")&&(l=l.replace(/\.uvue\.(.*)/,".uvue"));const u=(0,core_1.noTsToNormalizedUri)(l);if(!u)return;return{project:e,contextData:a,fileUri:u,completionType:s}}async doExtraReferencesAsync(e,t,r,n,o){const i=this.initialize(e,t,r,n);return i?(o=await this.getIdReferences(i,o),o=await this.getClassReferences(i,o)):o}async doExtraFileReferencesAsync(e,t){}}exports.BaseReferenceProcessor=BaseReferenceProcessor;
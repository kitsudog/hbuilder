"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.StyleMode=void 0;const vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),vscode_uri_1=require("vscode-uri"),core_1=require("../../../core"),cssLanguageService_1=require("../../../packages/vscode-css-languageservice/out/cssLanguageService");class StyleMode{constructor(e,t,i,s){this.info=e,this.styleScriptCache=t,this.styleLanguageServiceList=i}toNumber(e){const t=e.match(/(\d+)/);if(t)return parseInt(t[0],10)}initialize(e,t){const i=this.info,s=this.styleScriptCache,n=this.styleLanguageServiceList,o=core_1.fileTypesTool.findFileAbbrFromType(e,"style");if(!o)return;const r=n.get(o);if(!r)return;if(!i.tsinfo.project.getScriptInfo(e))return;const c=s.getUpToDateInfo(e);if(!c)return;let a=vscode_uri_1.URI.file(e).toString();const l=this.toNumber(c.version)||0,u=vscode_languageserver_textdocument_1.TextDocument.create(a,o,l,c.styleDocument.getText()),g=r.parseStylesheet(u),y=u.positionAt(t);return{styleDocument:u,stylesheet:g,position:y,languageServer:r}}async getCompletionsAtPositionAsync(e,t,i){let s=this.initialize(e,t);if(!s)return;const n=s.styleDocument,o=s.stylesheet,r=s.position,c=s.languageServer,a=await c.doCompleteAsync(n,r,o);return(0,core_1.fromLspCompletions)(a,n,this.info.ts)}getCompletionEntryDetails(e,t,i,s,n,o,r){if(!n)return;let c=vscode_uri_1.URI.parse(n).query,a=JSON.parse(c),l=this.initialize(e,t);if(!l)return;const u=l.styleDocument,g=l.stylesheet,y=l.position,f={label:i,...a},p=l.languageServer.doResolve(f,u,y,g);return(0,core_1.fromLspCompletionDetail)(p,u,this.info.ts)}async getQuickInfoAtPositionAsync(e,t){let i=this.initialize(e,t);if(!i)return;const s=i.styleDocument,n=i.stylesheet,o=i.position,r=i.languageServer.doHover(s,o,n);return(0,core_1.fromLspHover)(r,s,this.info.ts)}async getDefinitionAndBoundSpanAsync(e,t){let i=this.initialize(e,t);if(!i)return;const s=i.styleDocument,n=i.stylesheet,o=i.position,r=i.languageServer,c=await r.tsFindDefinitionAsync(s,o,n);return(0,core_1.fromLspDefinition)(c,s,this.info,void 0)}getNavigationTree(e){let t=this.initialize(e,0);if(!t)return;const i=t.styleDocument,s=t.stylesheet,n=(t.position,t.languageServer.findDocumentSymbols(i,s));return(0,core_1.fromLspNavigation)(n,i,this.info.ts,!1)}async findReferencesAsync(e,t){let i=this.initialize(e,t);if(!i)return;const s=i.styleDocument,n=i.stylesheet,o=i.position,r=i.languageServer,c=await r.tsFindReferencesAsync(s,o,n);return(0,core_1.fromLspReferences)(this.info,c)}async getFileReferencesAsync(e){}async getSyntacticDiagnosticsAsync(e){let t=this.initialize(e,0);if(!t)return[];const i=t.styleDocument,s=t.stylesheet,n=t.languageServer;return await(0,cssLanguageService_1.getStyleSyntacticDiagnostics)(this.info,i,s,n,e)}async getSemanticDiagnosticsAsync(e){return[]}async getSuggestionDiagnosticsAsync(e){return[]}}exports.StyleMode=StyleMode;
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.NodeHandle=void 0;const vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),core_1=require("../../../../core"),pathHandle_1=require("./pathHandle");class NodeHandle{constructor(){this._pathHandle=new pathHandle_1.PathHandle}getRefLineText(e,t){const r=t.offset,n=t.length,a=(0,core_1.getLineTextFromOffset)(e,r);let o=a;if(a.length>500){const t=e.positionAt(r),a=e.positionAt(r);a.character=a.character+n;const s=vscode_languageserver_protocol_1.Range.create(t,a);console.warn("[Indexer] LineTextIsLong!","WARN"),o=(0,core_1.getContextLineText)(e,s)}if(!(o.length>500))return o;console.error("[Indexer] ContextLineTextIsLong!","ERROR")}getImportPath(e,t,r){const n=r.match(/\s*(@import)\s*(['"])([^"\r\n()<>]+)(['"])/);if(!n)return;if(n[2]!==n[4])return;if(!n[3])return;return this._pathHandle.getObtainFormattedPath(e,t,n[3])}createdUrlRefData(e,t,r){const n=r.match(/(url\()(\s*)([^\s()<>]+)(\s*)(\))/);if(!n)return;if(!n[3])return;const a=n[3].trim();let o=a;(a.startsWith("'")||a.startsWith('"'))&&(o=a.substring(1,a.length-1));return this._pathHandle.getObtainFormattedPath(e,t,o)}createdRefIndexData(e,t,r,n,a){const o=e.positionAt(t.offset),s=e.positionAt(t.offset);s.character=s.character+t.length;let c=vscode_languageserver_protocol_1.Range.create(o,s);if("ref"===r){const e=/\s*(@import)\s*(['"])([^"\r\n()<>]+)(['"])/,t=a.match(e);if(!t)return;if(t[2]!==t[4])return;if(!t[3])return;o.character=o.character+t[1].length+1,c=vscode_languageserver_protocol_1.Range.create(o,s)}else{if("url"!==r)return;{const e=/(url\()(\s*)([^\s()<>]+)(\s*)(\))/,t=a.match(e);if(!t)return;if(!t[1])return;if(void 0===t[2])return;o.character=o.character+t[1].length+t[2].length,s.character=o.character+t[3].length,c=vscode_languageserver_protocol_1.Range.create(o,s)}}e.getText(c);return{range:c,nodeText:t.getText()}}createdRefIndexValue(e,t,r,n,a){const o=this.getRefLineText(t,n);if(!o)return;let s;const c=t.uri;if("ref"===a)s=this.getImportPath(e,c,o);else{if("url"!==a)return;s=this.createdUrlRefData(e,c,o)}if(!s)return;s=s.replace(/\\/g,"/");const i=this.createdRefIndexData(t,n,a,s,o);if(!i)return;const l=core_1.targetUtils.indexGetTarget(t,i.range,r);return{value:s,lineText:o,kind:core_1.IndexItemType.REF,range:i.range,context:i.nodeText,describe:"absolutePath",platforms:l}}createdIndexValue(e,t,r,n,a,o){const s=n.getText(),c=t.positionAt(n.offset),i=t.positionAt(n.offset);i.character=i.character+n.length;const l=vscode_languageserver_protocol_1.Range.create(c,i),g=core_1.targetUtils.indexGetTarget(t,l,r),u={value:s,lineText:(0,core_1.getContextLineText)(t,l),kind:a,range:l,platforms:g};return"CLASS"!==o&&"ID"!==o||(u.value=s.substring(1)),u}}exports.NodeHandle=NodeHandle;
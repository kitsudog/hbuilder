"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TokenHandle=void 0;const vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),core_1=require("../../../../core"),serviceTypes_1=require("../../serviceTypes"),pathHandle_1=require("./pathHandle");class TokenHandle{constructor(){this._pathHandle=new pathHandle_1.PathHandle,this._count=0,this._longLineCatch=[]}getLineText(e,t){const n=t.offset,o=t.len,r=e.positionAt(n);let s,a=this._longLineCatch.includes(r.line);if(!a){const t=(0,core_1.getLineTextFromOffset)(e,n);t.length>500?(this._longLineCatch.push(r.line),a=!0):s=t}if(a){console.warn("[Indexer] LineTextIsLong!","WARN");const t=e.positionAt(n),r=e.positionAt(n);r.character=r.character+o;const a=vscode_languageserver_protocol_1.Range.create(t,r);s=(0,core_1.getContextLineText)(e,a)}if(void 0===s)return;if(!(s.length>500))return s;console.error("[Indexer] ContextLineTextIsLong!","ERROR")}getImportData(e,t,n,o){let r={tokenRange:vscode_languageserver_protocol_1.Range.create(0,0,0,0),refTokenRange:vscode_languageserver_protocol_1.Range.create(0,0,0,0),absolutePath:"string"};const s=t.positionAt(o.offset),a=t.positionAt(o.offset);a.character=a.character+o.len;const c=vscode_languageserver_protocol_1.Range.create(s,a);r.tokenRange=c;const i=t.positionAt(n.offset),l=vscode_languageserver_protocol_1.Range.create(i,a);r.refTokenRange=l;let g=o.text;g=g.substring(1,g.length-1);const p=t.uri,T=this._pathHandle.getObtainFormattedPath(e,p,g);if(T)return r.absolutePath=T,r}getUrlData(e,t,n,o){let r={tokenRange:vscode_languageserver_protocol_1.Range.create(0,0,0,0),refTokenRange:vscode_languageserver_protocol_1.Range.create(0,0,0,0),absolutePath:"string"};const s=t.positionAt(n.offset+n.len+1),a=t.positionAt(o.offset),c=vscode_languageserver_protocol_1.Range.create(s,a);r.tokenRange=c;const i=t.positionAt(n.offset),l=t.positionAt(o.offset+1),g=vscode_languageserver_protocol_1.Range.create(i,l);r.refTokenRange=g;const p=t.getText(c);t.getText(g);let T=p.trim();const _=p.trim(),u=p.search(/\S/),h=p.length-u-_.length;s.character=s.character+u,a.character=a.character-h;const d=vscode_languageserver_protocol_1.Range.create(s,a);r.tokenRange=d;t.getText(d);(T.startsWith("'")||T.startsWith('"'))&&(T=T.substring(1,T.length-1));const x=t.uri,f=this._pathHandle.getObtainFormattedPath(e,x,T);if(f)return r.absolutePath=f,r}createdRefIndexValueFromToken(e,t,n,o,r,s){let a;if("ref"===s)a=this.getImportData(e,t,o,r);else{if("url"!==s)return;a=this.getUrlData(e,t,o,r)}if(!a)return;const c=this.getLineText(t,r);if(!c)return;const i=a.absolutePath.replace(/\\/g,"/"),l=t.getText(a.refTokenRange),g=(t.getText(a.tokenRange),core_1.targetUtils.indexGetTarget(t,a.tokenRange,n));return{value:i,lineText:c,kind:core_1.IndexItemType.REF,range:a.tokenRange,context:l,describe:"absolutePath",platforms:g}}createdIndexValueFromContext(e,t,n,o,r,s){const a=(0,core_1.getContextData)(e,n.offset,r),c=(0,core_1.getContextLineText)(e,a.contextRange),i=core_1.targetUtils.indexGetTarget(e,a.contextRange,t);let l={value:a.context,lineText:c,kind:o,range:a.contextRange,platforms:i};return"CLASS"!==s&&"ID"!==s||(l.value=a.context.substring(1)),l}tokenTextIsColor(e){return/#([0-9a-fA-F]{3}){1,2}/.test(e)}async newIndexFromToken(e,t,n){let o=serviceTypes_1.Scanner;"scss"===t.languageId&&(o=serviceTypes_1.SCSSScanner),"less"===t.languageId&&(o=serviceTypes_1.LESSScanner);const r=t.getText(),s=r.length;o.prototype.setSource(r);const a=[],c=[],i=[],l=[],g=(0,core_1.noTsToNormalizedPath)(t.uri);console.warn(`[Indexer] TokenIndexStart! FilePath: ${g}`,"WARN");let p,T,_=!1,u=!1,h=!1,d=!1,x=[];for(;s>this._count;){this._count++;0===this._count%300&&await(0,core_1.hxSleep)(1);const r=o.prototype.scan();if(d){if(r.type!==serviceTypes_1.TokenType.ParenthesisR)continue;{d=!1;const o=this.createdRefIndexValueFromToken(e,t,n,T,r,"url");o&&a.push(o)}}if(r.type===serviceTypes_1.TokenType.CurlyL&&x.push(!0),x&&r.type===serviceTypes_1.TokenType.CurlyR&&x.pop(),r.type===serviceTypes_1.TokenType.String&&_){const o=this.createdRefIndexValueFromToken(e,t,n,p,r,"ref");o&&a.push(o)}if(r.type===serviceTypes_1.TokenType.AtKeyword?"@import"===r.text&&(p=r,_=!0):r.type!==serviceTypes_1.TokenType.Whitespace&&(_=!1),r.type===serviceTypes_1.TokenType.Delim)"."===r.text&&(h=!0);else if(0===x.length&&h&&r.type===serviceTypes_1.TokenType.Ident){const e=this.createdIndexValueFromContext(t,n,r,core_1.IndexItemType.DEF,void 0,"CLASS");e&&c.push(e)}else h=!1;if(r.type===serviceTypes_1.TokenType.Ident?"url"===r.text?(T=r,u=!0):u=!1:u&&r.type===serviceTypes_1.TokenType.ParenthesisL&&(d=!0),r.type===serviceTypes_1.TokenType.Hash){const e=this.tokenTextIsColor(r.text);if(e&&0!==x.length){const e=this.createdIndexValueFromContext(t,n,r,core_1.IndexItemType.REF,' \t\n\r":{[()]},*>+;');e&&l.push(e)}else if(!e&&0===x.length){const e=this.createdIndexValueFromContext(t,n,r,core_1.IndexItemType.REF,void 0,"ID");e&&i.push(e)}}if(r.type===serviceTypes_1.TokenType.EOF)break}console.warn(`[Indexer] TokenIndexEnd! FilePath: ${g}`,"WARN");const f=new Map;f.set("REF",a);const y=c.filter((e=>"."!==e.value.trim()));f.set("CLASS",y),f.set("ID",i),f.set("COLOR",l);const v=(0,core_1.assemblyKindData)(f,e,t.uri);if(0!==v.kindMap.size)return this._count=0,v}}exports.TokenHandle=TokenHandle;
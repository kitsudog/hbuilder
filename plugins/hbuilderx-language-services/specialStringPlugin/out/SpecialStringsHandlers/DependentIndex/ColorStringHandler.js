"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const path=require("path"),vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),core_1=require("../../../../core"),vscode_css_languageservice_1=require("../../../../packages/vscode-css-languageservice"),handlerType_1=require("../handlerType"),utils_1=require("../utils"),indexBaseHandler_1=require("./indexBaseHandler");function getColorNameMap(){const e=Object.keys(vscode_css_languageservice_1.colors),o=new Map;return e.forEach((e=>{const r=vscode_css_languageservice_1.colors[e];o.set(e,r.detail)})),o}const colorMap=getColorNameMap();function toFullHex(e){if(!e.startsWith("#"))return colorMap.get(e);if(4!==e.length)return colorMap.get(e);const o=e.slice(1),r=o.length,t=Array(6-r).fill("0");return t.unshift(...o),`#${t.join("")}`}class ColorStringHandler extends indexBaseHandler_1.IndexBaseHandler{getBaseColor(e,o){const r=[];return o.forEach((e=>{const o=toFullHex(e.label);o?r.push(o):r.push(e.label)})),colorMap.forEach(((t,a)=>{r.includes(t)||o.push({label:t,kind:vscode_languageserver_protocol_1.CompletionItemKind.Color,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(e.range,t),sortText:`zzzz_${t}`,detail:t,documentation:a})})),o}async doCompleteExt(e,o,r,t,a,n){var i;const s=(0,core_1.noTsToNormalizedUri)(r.project.fsPath);if(!s)return a;const l=[{projectUri:s,excludeFileUris:n,kind:"COLOR",limit:2e3,fields:["value"],distinct:!0}];let c;if(c=(null===(i=r.project.indexPipeHandler)||void 0===i?void 0:i.getIndexDataRequest)?await r.project.indexPipeHandler.getIndexDataRequest(l,!1):(0,core_1.onDiskQuery)(l),!c)return a;if(0===c.length)return a;c.forEach((e=>{e=(0,utils_1.specialNormalizationIndexData)(handlerType_1.StringLocationInfoKind.IN_CSS_URL_LIKE,e)}));const d={replaceRange:r.range,needFilePath:!0},u=[];return c.forEach((e=>{u.push(...(0,core_1.creatorCompletionFromIndexData)(e,d))})),u}async doCompleteAsync(e,o,r,t,a){var n;const i=(0,core_1.noTsToNormalizedUri)(r.project.fsPath);if(!i)return a;const s=(0,core_1.noTsToNormalizedUri)(e.uri);if(!s)return a;const l=(0,core_1.noTsToNormalizedPath)(e.uri),c=[s],d=await(0,core_1.getAllKindData)(r.project,"REF",!1);let u=[];const p=(0,core_1.iterateGetReference)(d,c,new Map);let h=(0,core_1.getReferenceList)(p);h||(h=[]),u=h,l&&u.push(l);const _=(0,core_1.noTsToNormalizedPath)(path.join(r.project.fsPath,"App.vue")),g=(0,core_1.noTsToNormalizedPath)(path.join(r.project.fsPath,"App.uvue")),f=(0,core_1.noTsToNormalizedPath)(path.join(r.project.fsPath,"uni.scss"));if(_&&u.push(_),g&&u.push(g),f&&u.push(f),0===u.length)return this.getBaseColor(r,[]);const x={projectUri:i,kind:"COLOR",limit:2e3,fields:["value"],distinct:!0},v=(0,core_1.getIndexDataOptionsFromList)(u,x);let m;if(m=(null===(n=r.project.indexPipeHandler)||void 0===n?void 0:n.getIndexDataRequest)?await r.project.indexPipeHandler.getIndexDataRequest(v,!1):(0,core_1.onDiskQuery)(v),!m)return this.getBaseColor(r,[]);if(0===m.length)return this.getBaseColor(r,[]);m.forEach((e=>{e=(0,utils_1.specialNormalizationIndexData)(handlerType_1.StringLocationInfoKind.IN_CSS_URL_LIKE,e)}));const T={replaceRange:r.range,needFilePath:!0},C=[];if(m.forEach((e=>{C.push(...(0,core_1.creatorCompletionFromIndexData)(e,T))})),C.length<2e3){const n=[];u.forEach((e=>{const o=(0,core_1.noTsToNormalizedUri)(e);o&&n.push(o)}));const i=await this.doCompleteExt(e,o,r,t,a,n);C.push(...i)}return this.getBaseColor(r,C)}}exports.default=ColorStringHandler;
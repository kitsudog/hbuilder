"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const path=require("path"),vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),core_1=require("../../../../core"),vscode_css_languageservice_1=require("../../../../packages/vscode-css-languageservice"),handlerType_1=require("../handlerType"),utils_1=require("../utils"),indexBaseHandler_1=require("./indexBaseHandler");class CssSelectorStringHandler extends indexBaseHandler_1.IndexBaseHandler{getElementCompletion(){const e=[],t={hxKind:core_1.HxIconKind.ELEMENT};for(const o in vscode_css_languageservice_1.html5Tags)e.push({label:o,kind:vscode_languageserver_protocol_1.CompletionItemKind.Keyword,data:t,sortText:vscode_css_languageservice_1.SortTexts.Normal});for(const o in vscode_css_languageservice_1.svgElements)e.push({label:o,kind:vscode_languageserver_protocol_1.CompletionItemKind.Keyword,data:t,sortText:vscode_css_languageservice_1.SortTexts.Normal});return e}async doCompleteExt(e,t,o,r,n,a){const s=(0,core_1.noTsToNormalizedUri)(o.project.fsPath);if(!s)return n;const i=[{projectUri:s,excludeFileUris:a,kind:"CLASS",limit:2e3,fields:["value"],distinct:!0},{projectUri:s,excludeFileUris:a,kind:"ID",limit:2e3,fields:["value"],distinct:!0}];let c;if(c=await o.project.indexPipeHandler.getIndexDataRequest(i,!1),!c)return n;if(0===c.length)return n;c.forEach((e=>{e=(0,utils_1.specialNormalizationIndexData)(handlerType_1.StringLocationInfoKind.IN_CSS_LIKE,e)}));const l=e.offsetAt(t),d={replaceRange:(0,core_1.getContextData)(e,l," \t\n\r\"'").contextRange,needFilePath:!0},p=[];c.forEach((e=>{p.push(...(0,core_1.creatorCompletionFromIndexData)(e,d))}));const u=this.getElementCompletion();return p.push(...u),p}async doCompleteAsync(e,t,o,r,n){const a=(0,core_1.noTsToNormalizedUri)(o.project.fsPath);if(!a)return n;const s=(0,core_1.noTsToNormalizedUri)(e.uri);if(!s)return n;const i=(0,core_1.noTsToNormalizedPath)(e.uri),c=[s],l=await(0,core_1.getAllKindData)(o.project,"REF",!1);let d=[];const p=(0,core_1.iterateGetReference)(l,c,new Map);let u=(0,core_1.getReferenceList)(p);u||(u=[]),d=u,i&&d.push(i);const _=(0,core_1.noTsToNormalizedPath)(path.join(o.project.fsPath,"App.vue")),g=(0,core_1.noTsToNormalizedPath)(path.join(o.project.fsPath,"App.uvue")),h=(0,core_1.noTsToNormalizedPath)(path.join(o.project.fsPath,"uni.scss"));if(_&&d.push(_),g&&d.push(g),h&&d.push(h),0===d.length)return[];const m={projectUri:a,kind:"CLASS",limit:2e3,fields:["value"],distinct:!0},f={projectUri:a,kind:"ID",limit:2e3,fields:["value"],distinct:!0},x=(0,core_1.getIndexDataOptionsFromList)(d,m),v=(0,core_1.getIndexDataOptionsFromList)(d,f),T=x.concat(v);let I;if(I=await o.project.indexPipeHandler.getIndexDataRequest(T,!1),!I)return[];if(0===I.length)return[];I.forEach((e=>{e=(0,utils_1.specialNormalizationIndexData)(handlerType_1.StringLocationInfoKind.IN_CSS_LIKE,e)}));const C=e.offsetAt(t),E={replaceRange:(0,core_1.getContextData)(e,C," \t\n\r\"'").contextRange,needFilePath:!0},j=[];I.forEach((e=>{j.push(...(0,core_1.creatorCompletionFromIndexData)(e,E))}));const S=this.getElementCompletion();if(j.push(...S),j.length<1e3){const a=[];d.forEach((e=>{const t=(0,core_1.noTsToNormalizedUri)(e);t&&a.push(t)}));const s=await this.doCompleteExt(e,t,o,r,n,a);return j.push(...s),j}return j}}exports.default=CssSelectorStringHandler;
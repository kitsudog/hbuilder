"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.sortProcessing=exports.getSortText=exports.getPathCompletionItem=exports.getFileIconType=exports.getCurrentPathListSync=exports.getCompletionPathListSync=void 0;const fs=require("fs"),path=require("path"),vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),vscode_uri_1=require("vscode-uri"),core_1=require("../../../../core"),handlerType_1=require("../handlerType"),URIType_1=require("./URIType"),imageSize=require("image-size");function getFileIconType(e){let t=core_1.HxIconKind.FILE;return(0,core_1.includesList)(e,URIType_1.ImageURIString)?t=core_1.HxIconKind.IMAGE:(0,core_1.includesList)(e,[".css",".scss",".less"])?t=core_1.HxIconKind.CSS:(0,core_1.includesList)(e,[".js"])?t=core_1.HxIconKind.JS:(0,core_1.includesList)(e,[".html"])&&(t=core_1.HxIconKind.HTML),t}function getSortText(e,t,r){let o="z",i="z",n="z",s="z",a="z";t||(o="b"),r&&(o="a"),e.startsWith("@")&&(i="a");let l=48;if(e.includes("/")){const t=e.match(/\//gim);l=48+(t?t.length:0)}n=String.fromCharCode(l);let c=48+e.length;return s=String.fromCharCode(c),(e.endsWith(".scss")||e.endsWith(".less"))&&(a="a"),o+i+n+s+a+"_"+e}function sortProcessing(e,t){for(const r of e){if(!r.documentation)return e;if("external module name"!==r.documentation)return e;r.textEdit=vscode_languageserver_protocol_1.TextEdit.replace(t,r.label),r.sortText=getSortText(r.label,!0,!0)}return e}function getPathCompletionItem(e,t,r,o,i,n){if(!e)return[];let s=[],a=[];for(const l of e.pathList){if(e.referencePath&&(l.relativePath=`${e.referencePath}/`+l.relativePath),""===l.relativePath.replace(/..\//g,""))continue;if((t.uri.startsWith("file://")?vscode_uri_1.URI.parse(t.uri).fsPath:t.uri).toLowerCase().replace(/\\/g,"/").startsWith(l.absolutePath.toLowerCase().replace(/\\/g,"/")))continue;let c,h,p=core_1.HxIconKind.FOLDER;if(l.isDir)c=core_1.retriggerCommand;else{p=getFileIconType(path.extname(l.absolutePath))}if(h={kind:vscode_languageserver_protocol_1.MarkupKind.Markdown,value:l.absolutePath.replace(/\\/g,"/")},p===core_1.HxIconKind.IMAGE)try{let e={width:230,height:180},t=l.absolutePath,r=imageSize(t),o="";if(".svg"!=t.slice(-4).toLocaleLowerCase()){let t=Math.min(e.width/r.width,e.height/r.height);t=Math.min(t,1),t<1&&(o=r.width>r.height?`width="${r.width*t}"`:`height="${r.height*t}"`)}h={kind:vscode_languageserver_protocol_1.MarkupKind.Markdown,value:`<div align='center'><br/><img ${o} src="${t}"/></div>`}}catch(e){}let d=getSortText(l.relativePath,l.isDir),g=l.relativePath;if(i&&(g=l.relativePath.slice(e.referencePath.length+1)),s.push({label:g,documentation:h,kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,sortText:d,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(r,g),command:c,data:{hxKind:p}}),(o.project.kind===core_1.HXProjectKind.UniApp||o.project.kind===core_1.HXProjectKind.UniApp_Cli)&&!l.isDir&&!i&&n&&o.kind!==handlerType_1.StringLocationInfoKind.IN_JSON_LIKE){let e=path.resolve(o.project.kind===core_1.HXProjectKind.UniApp_Cli?o.project.sourceRoot:o.project.fsPath).toLowerCase().replace(/\\/g,"/"),t=l.absolutePath.replace(/\\/g,"/").substring(e.length);t="@"+t;let i=getSortText(t,l.isDir);a.push({label:t,documentation:h,kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,sortText:i,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(r,t),command:c,data:{hxKind:p}})}}return e.referencePath.startsWith("@")&&n?s=a:n&&s.push(...a),s}function getCompletionPathListSync(e,t,r,o){var i,n,s,a,l;const c=t;if(!fs.existsSync(c))return;let h=o.startsWith("file://")?vscode_uri_1.URI.parse(o).fsPath:o;if(fs.existsSync(h))h=(0,core_1.toLocalRealPath)(h);else{const e=path.dirname(h);fs.existsSync(e)&&(h=path.join((0,core_1.toLocalRealPath)(e),path.basename(e)))}let p=r.extSuffixFilterList,d=null!==(i=r.extFoldersFilterList)&&void 0!==i?i:[];r.disabledDefaultFoldersFilterList||(d=[...new Set(URIType_1.filterDirs.concat(...d))]);let g=null!==(n=r.prefixPath)&&void 0!==n?n:"";const u=null!==(s=r.fileMax)&&void 0!==s?s:-1,f=null!==(a=r.timeOut)&&void 0!==a?a:1e3;let _=null!==(l=r.ignoredFiles)&&void 0!==l?l:[],x=!!r.enableShowFolders;0===r.extSuffixFilterList.length&&(x=!0);let m=!!r.onlyFolders,P=!!r.onlyCurrentLevel,v=!!r.enableAllPath;const S={isMaximumExceeded:!1,isTimeOut:!1,referencePath:"",pathList:[]};let L="",y="",C=!1,I=0,T=!1;if(g){const t=g.lastIndexOf("/"),r=t>=0?g.slice(0,t):"",o=path.dirname(h);g.startsWith("/")&&!g.startsWith("//")?(L=path.resolve(e,r.slice(1)),S.referencePath=r,C=!0,I=g.split("").filter((e=>"/"===e)).length):g.startsWith("@")?(L=e,S.referencePath=r,T=!0):"."===g||"./"===g||"."===r||"./"===r?(L=path.dirname(h),S.referencePath=r.length>0?r:"."):".."===g||"../"===g?(L=path.resolve(o,"../"),S.referencePath=".."):(L=path.resolve(o,r),S.referencePath=r);let i=e.toLowerCase().replace(/\\/g,"/"),n=L.toLowerCase().replace(/\\/g,"/");if(n!==i&&!n.startsWith(i))return;if(!fs.existsSync(L))return;y=T?path.dirname(h):L}else L=c,y=path.dirname(h);const b=e=>{let t="";C&&1===I&&(t="/");const r=[],o=process.uptime();let i=[L];for(;i.length>0&&(u<0||r.length<u);){let n=i.shift();fs.readdirSync(n,{withFileTypes:!0}).forEach((o=>{const s=o.name.toLowerCase(),a=path.join(n,o.name);if(o.isFile()&&!m){let e=v||0===p.length;if(e||(e=p.some((e=>s.endsWith(e)))),e){let e=path.relative(y,a).replace(/\\/g,"/"),o=path.basename(a);a===h||_.includes(o)||r.push({absolutePath:a,relativePath:t+e,isDir:!1})}}else if(o.isDirectory()&&!URIType_1.filterDirs.includes(o.name.toLocaleLowerCase())&&(P&&e||i.push(a),x)){let e=path.relative(y,a).replace(/\\/g,"/");e&&r.push({absolutePath:a,relativePath:t+e+"/",isDir:!0})}})),x=!1,v=!1;const s=process.uptime();if(f>0&&1e3*(s-o)>f){S.isTimeOut=!0;break}}return r.length===u&&(S.isMaximumExceeded=!0),S.pathList=r,S};let F=b(!1);return F.isMaximumExceeded||F.isTimeOut?b(!0):F}function getCurrentPathListSync(e,t,r,o){const i={isMaximumExceeded:!1,isTimeOut:!1,referencePath:"",pathList:[]},n={absolutePath:e,relativePath:path.parse(o).base,isDir:!0};return i.pathList.push(n),i}exports.getFileIconType=getFileIconType,exports.getSortText=getSortText,exports.sortProcessing=sortProcessing,exports.getPathCompletionItem=getPathCompletionItem,exports.getCompletionPathListSync=getCompletionPathListSync,exports.getCurrentPathListSync=getCurrentPathListSync;class URIHandler{constructor(e,t){this.exts=e,this.enableShowFolders=t,this._exts=e,this._enableShowFolders=t}async doCompleteAsync(e,t,r,o,i){let n=r.project.fsPath,s=r.project.sourceRoot,a=(0,core_1.getContextData)(e,e.offsetAt(t),"\r\n'\"");if(r.kind===handlerType_1.StringLocationInfoKind.IN_CSS_URL_LIKE){(0,core_1.getLineTextFromPosition)(e,t).trim()===a.context.trim()&&(a=(0,core_1.getContextData)(e,e.offsetAt(t)," \t\n\r'\":{[()]},*>+"))}if(o.get(handlerType_1.LanguageServiceType.TS)&&(i=sortProcessing(i,a.contextRange)),r.project.kind!==core_1.HXProjectKind.UniApp&&r.project.kind!==core_1.HXProjectKind.UniApp_Cli&&a.context.startsWith("@"))return i;let l={extSuffixFilterList:this._exts,prefixPath:a.leftText,enableShowFolders:this._enableShowFolders},c=a.contextRange,h=!1;if(this._enableShowFolders){let r=e.offsetAt(t)-e.offsetAt(a.leftRange.start),o=(0,core_1.getFragmentString)(a.context,r,"\\/"),i=(0,core_1.getContextData)(e,e.offsetAt(t),"\\/");o===i.context&&(l.onlyFolders=!0,l.onlyCurrentLevel=!0,c=i.contextRange,c.end.character+=1,h=!0)}let p=getPathCompletionItem(getCompletionPathListSync(n,s,l,e.uri),e,c,r,h,a.context.startsWith("@"));return i.push(...p),i}doCompleteResolve(e,t,r,o,i){return e}async doHoverAsync(e,t,r,o){}async doDefinitionAsync(e,t,r,o,i){let n=e.getText(r.range);if(!n.startsWith("@"))return[];let s=[],a=vscode_languageserver_protocol_1.Range.create(vscode_languageserver_protocol_1.Position.create(0,0),vscode_languageserver_protocol_1.Position.create(0,0));return s.push({targetUri:n.replace("@",r.project.fsPath),targetRange:a,targetSelectionRange:a,originSelectionRange:r.range}),s}doReference(e,t,r,o){return[]}}exports.default=URIHandler;
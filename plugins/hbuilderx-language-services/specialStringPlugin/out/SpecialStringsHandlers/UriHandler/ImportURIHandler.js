"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.resolveUtsPluginRootPath=void 0;const fs=require("fs"),path=require("path"),vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),core_1=require("../../../../core"),uniCloudPath_1=require("../../common/uniCloudPath"),handlerType_1=require("../handlerType"),URIHandler_1=require("./URIHandler");function isUtsFile(e){return e.endsWith(".uts")}function isUtsPluginFile(e,t){if((0,uniCloudPath_1.isUniModule)(e)){const t=(0,uniCloudPath_1.getUniModuleRoot)(e);if(t){const e=path.join(t,"utssdk");return fs.existsSync(e)&&fs.statSync(e).isDirectory()}}else{let o=path.join(t.sourceRoot,"utssdk");if(fs.existsSync(o)){let t=fs.readdirSync(o);for(let s of t)if(e.startsWith(path.join(o,s)))return!0}}return!1}function isUtsPluginRoot(e,t){if((0,uniCloudPath_1.isUniModule)(e)){let t=path.join(e,"utssdk");return fs.existsSync(t)&&fs.statSync(t).isDirectory()}let o=path.basename(e);return path.join(t.sourceRoot,"utssdk",o)===e}function resolveUtsPluginRootPath(e,t){if((0,uniCloudPath_1.isUniModule)(e))return(0,uniCloudPath_1.getUniModuleRoot)(e);let o=path.join(t.sourceRoot,"utssdk");if(fs.existsSync(o)){let t=fs.readdirSync(o);for(let s of t){let t=path.join(o,s);if(e.startsWith(t))return t}}}exports.resolveUtsPluginRootPath=resolveUtsPluginRootPath;const UtsPlatform=["app-android","app-ios","web","mp-weixin","mp-alipay","mp-baidu","mp-qq","mp-toutiao","mp-lark","mp-kuaishou","mp-jd"];class ImportURIHandler extends URIHandler_1.default{constructor(e,t){super(e,t),this.builtinNodeModulesCache=void 0,this._nodeModulesIgnoreSet=new Set(["jQuery","node","vue-demi","@intlify","csstype","source-map"])}async doCompleteAsync(e,t,o,s,r){let n=o.project.fsPath,i=o.project.sourceRoot,a=(0,core_1.getContextData)(e,e.offsetAt(t),"'\"");if(s.get(handlerType_1.LanguageServiceType.TS)&&(r=(0,URIHandler_1.sortProcessing)(r,a.contextRange)),o.project.kind!==core_1.HXProjectKind.UniApp&&o.project.kind!==core_1.HXProjectKind.UniApp_Cli&&a.context.startsWith("@"))return r;let l={extSuffixFilterList:this._exts,prefixPath:a.leftText,enableShowFolders:this._enableShowFolders};o.project.kind!==core_1.HXProjectKind.UniApp&&o.project.kind!==core_1.HXProjectKind.UniApp_Cli||(l.extSuffixFilterList=[".js",".uts"]);let u=a.contextRange,c=!1;if(this._enableShowFolders){let o=e.offsetAt(t)-e.offsetAt(a.leftRange.start),s=(0,core_1.getFragmentString)(a.context,o,"\\/"),r=(0,core_1.getContextData)(e,e.offsetAt(t),"\\/");s===r.context&&(l.onlyFolders=!0,l.onlyCurrentLevel=!0,u=r.contextRange,u.end.character+=1,c=!0)}let d=(0,URIHandler_1.getCompletionPathListSync)(n,i,l,e.uri),p=a.context.startsWith("@"),h=(0,URIHandler_1.getPathCompletionItem)(d,e,u,o,c,p);return r.push(...h),o.project.kind===core_1.HXProjectKind.UniApp&&r.push(...this.getNodeModeuls(a.leftText)),r}async doDefinitionAsync(e,t,o,s,r){let n=[],i=vscode_languageserver_protocol_1.Range.create(vscode_languageserver_protocol_1.Position.create(0,0),vscode_languageserver_protocol_1.Position.create(0,0)),a=e.getText(o.range);return a.startsWith("@")?(n.push({targetUri:a.replace("@",o.project.fsPath),targetRange:i,targetSelectionRange:i,originSelectionRange:o.range}),n.push(...r),n):r}getNodeModeuls(e){if(this.builtinNodeModulesCache)return e?this.builtinNodeModulesCache.filter((t=>t.label.toLowerCase().startsWith(e.toLowerCase()))):[...this.builtinNodeModulesCache];const t=[],o=new Set,s=(0,core_1.getExtensionRootPath)(),r=[path.join(s,"builtin-dts/node_modules"),path.join(s,"builtin-dts/uniapp@vue2/node_modules"),path.join(s,"builtin-dts/uniapp@vue3/node_modules")];for(const e of r)if(fs.existsSync(e)){fs.readdirSync(e).forEach((s=>{if(this._nodeModulesIgnoreSet.has(s)||o.has(s))return;const r=path.join(e,s);if(!fs.statSync(r).isDirectory())return;o.add(s);let n=s;if(s.startsWith("@")){fs.readdirSync(r).forEach((e=>{const o=path.join(r,e);"types"!==e&&fs.statSync(o).isDirectory()&&(n=s+"/"+e,t.push({label:n,sortText:n,insertText:n}))}))}else t.push({label:n,sortText:n,insertText:n})}))}return this.builtinNodeModulesCache=t,this.getNodeModeuls(e)}}exports.default=ImportURIHandler;
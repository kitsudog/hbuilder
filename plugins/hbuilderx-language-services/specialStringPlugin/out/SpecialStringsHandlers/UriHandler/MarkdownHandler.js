"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const fs=require("fs"),path=require("path"),vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),vscode_uri_1=require("vscode-uri"),core_1=require("../../../../core"),handlerType_1=require("../handlerType"),URIHandler_1=require("./URIHandler"),URIType_1=require("./URIType");class MarkdownHandler extends URIHandler_1.default{constructor(e,t){super(e,t)}async doCompleteAsync(e,t,r,n,o){let a=r.project.fsPath,l=r.project.sourceRoot,i=(0,core_1.getContextData)(e,e.offsetAt(t),"\r\n"),s=i.leftText.indexOf("(")+1;for(let e=t.character;e>=0;e--)if("("===i.leftText.charAt(e)){s=e+1;break}const c=i.leftText.slice(s,i.leftText.length),d={range:{start:{line:i.contextRange.start.line,character:s},end:{line:i.contextRange.end.line,character:c?i.leftText.length-1:i.leftText.length}},kind:handlerType_1.StringLocationInfoKind.IN_JSON_LIKE,ast:void 0,project:r.project};if(n.get(handlerType_1.LanguageServiceType.TS)&&(o=(0,URIHandler_1.sortProcessing)(o,i.contextRange)),d.project.kind!==core_1.HXProjectKind.UniApp&&d.project.kind!==core_1.HXProjectKind.UniApp_Cli&&i.context.startsWith("@"))return o;let f=Number(i.leftText.indexOf("!")),x=Number(i.leftText.indexOf("["));for(let e=t.character;e>=0;e--)if("!"===i.leftText.charAt(e)){f=e+1;break}for(let e=t.character;e>=0;e--)if("["===i.leftText.charAt(e)){x=e+1;break}this._exts=f>=0&&f+1===x?URIType_1.ImageURIString:URIType_1.MarkdownFileURIString;let p,g={extSuffixFilterList:this._exts,prefixPath:c,enableShowFolders:this._enableShowFolders},h=d.range;if(this._enableShowFolders){let r=e.offsetAt(t)-e.offsetAt(i.leftRange.start);(0,core_1.getFragmentString)(i.context,r,"\\/")===(0,core_1.getContextData)(e,e.offsetAt(t),"\\/").context&&(g.onlyFolders=!1,g.onlyCurrentLevel=!0,h.end.character+=1)}let _=i.context.startsWith("@");new RegExp(/\[[\s\S]*\]\(/g).test(i.leftText)&&(p=(0,URIHandler_1.getCompletionPathListSync)(a,l,g,e.uri));const u=new RegExp(/\[[\s\S]*\]\[/g).test(i.leftText);u&&(p=(0,URIHandler_1.getCurrentPathListSync)(a,l,g,e.uri));let T=(0,URIHandler_1.getPathCompletionItem)(p,e,h,d,!1,_);const v=vscode_uri_1.URI.parse(e.uri).fsPath,R=(0,core_1.getContextData)(e,e.offsetAt(t),"\r\n");let S=R.leftText.slice(s,R.leftText.length);return u?T=this.markdownLink(e,t,T,v,g):"#"!==S&&-1===S.indexOf(".md#")||(T=this.markdownHash(e,t,T,v)),o.push(...T),o}markdownHash(e,t,r,n){const o=(0,core_1.getContextData)(e,e.offsetAt(t),"\r\n"),a=o.leftText.indexOf("(")+1,l=o.leftText.slice(a,o.leftText.length),i=new RegExp(/^[#* ]/g),s=e.getText();let c=[],d=[],f=[];const x=path.parse(n),p=l.indexOf("#");let g="";if("#"===l)c=s.split(/\r\n|\r|\n/);else{g=l.slice(0,p);const e=path.join(x.dir,g);c=fs.readFileSync(e,{encoding:"utf8",flag:"r"}).split(/\r\n|\r|\n/)}return c.length&&(c.forEach((e=>{i.test(e)&&d.push(e)})),d=d.map((e=>e.split(" ")[1])),d=[...new Set(d)],r.length&&d.forEach(((e,t)=>{var n;let o=JSON.parse(JSON.stringify(r[0]));o.label="#"+e;let a=null===(n=o.sortText)||void 0===n?void 0:n.split("_");a&&(a[1]=o.label);const l=a?a[0]+"_"+a[1]:"";o.sortText=l,o.textEdit.newText=g?g+"#"+e:"#"+e,o.command=void 0,f.push(o)})),r=f),r}markdownLink(e,t,r,n,o){return e.getText().split(/\r\n|\r|\n/).forEach((e=>{const a=new RegExp(/\[[\s\S]*\]\: [\s\S]*/g),l=new RegExp(/\[[\s\S]*\]\[/g),i=a.test(e),s=o.prefixPath?l.test(o.prefixPath):void 0;if(i&&s&&o.prefixPath){const a=e.indexOf("["),l=e.indexOf("]"),i=e.slice(a+1,l),s=o.prefixPath.indexOf("]");let c,d={start:{line:t.line,character:s+2},end:t};c={kind:vscode_languageserver_protocol_1.MarkupKind.Markdown,value:n},r.push({label:i,documentation:c,kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,sortText:i,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(d,i),command:void 0,data:{hxKind:8}})}})),r}}exports.default=MarkdownHandler;
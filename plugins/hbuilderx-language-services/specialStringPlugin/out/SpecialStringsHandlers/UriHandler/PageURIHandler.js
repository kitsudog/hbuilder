"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const fs=require("fs"),path=require("path"),vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),vscode_uri_1=require("vscode-uri"),core_1=require("../../../../core"),handlerType_1=require("../handlerType"),URIHandler_1=require("./URIHandler");function getDefAbsolutePath(e,t,n){const o=t.split("?")[0],r=(0,core_1.noTsToNormalizedPath)(e);if(!r)return[];let s="";if(o.startsWith("@/")){let t=vscode_uri_1.URI.parse(e).fsPath;const n=path.resolve(t,"src");fs.existsSync(n)&&(t=n),s=o.replace("@",t)}else path.isAbsolute(o)&&o.startsWith("/")&&(s=r+o);s=s.replace(/\\/g,"/");const a=[];let i=["vue","nvue"];(0,core_1.isUniAppXProject)(n)&&(i=["uvue","vue"]);for(let e=0;e<i.length;e++){const t=`${s}.${i[e]}`;if(fs.existsSync(t)){a.push(t);break}}return a}class PageURIHandler extends URIHandler_1.default{constructor(e,t){super(e,t)}async doCompleteAsync(e,t,n,o,r){const s=(0,core_1.getContextData)(e,e.offsetAt(t),"'\"");r=(0,URIHandler_1.sortProcessing)(r,s.contextRange);const a=n.project.fsPath,i=n.project.sourceRoot,c={extSuffixFilterList:this._exts,ignoredFiles:["App.vue"],prefixPath:""};if(n.kind===handlerType_1.StringLocationInfoKind.IN_JS_LIKE||n.kind===handlerType_1.StringLocationInfoKind.IN_HTML_LIKE){const f=s.context.indexOf("/");let p=s.context;function h(e,t){const n=e.length,o=t.length;n>o&&(e=e.substring(0,o));let r=!1;for(let n=1;n<=t.length;n++){if(t.substring(0,n)===e){r=!0;break}}return r}-1!==f&&(p=s.context.substring(0,f)),h(p,"pages")||""===s.leftText?c.prefixPath="/":c.prefixPath=s.leftText}const l=s.contextRange,u=(0,URIHandler_1.getCompletionPathListSync)(a,i,c,e.uri);let d=(0,URIHandler_1.getPathCompletionItem)(u,e,l,n,!1,!1);d=d.filter((e=>{if(e.documentation&&"string"!=typeof e.documentation&&e.documentation.value.includes("page"))return e})),d=d.map((e=>{const t=e.label.lastIndexOf(".");return e.label=e.label.substring(0,t),e.textEdit.newText=e.textEdit.newText.substring(0,t),e}));const g=(0,core_1.isUniAppXProject)(n.project);return d=function(e){const t=new Map,n=new Set;let o=!1;for(const r of e)if(n.has(r.label)){const e=t.get(r.label);if(e){const t=e.documentation.value,n=r.documentation.value;if(g){n.endsWith(".uvue")&&!o?(e.documentation=r.documentation,o=!0):!o&&n.length<t.length&&(e.documentation=r.documentation)}else n.length<t.length&&(e.documentation=r.documentation)}}else{n.add(r.label),t.set(r.label,r);r.documentation.value.endsWith(".uvue")&&(o=!0)}return[...t.values()]}(d),r.push(...d),r}async doDefinitionAsync(e,t,n,o,r){const s=[],a=vscode_languageserver_protocol_1.Range.create(vscode_languageserver_protocol_1.Position.create(0,0),vscode_languageserver_protocol_1.Position.create(0,0)),i=e.getText(n.range),c=(0,core_1.noTsToNormalizedUri)(n.project.fsPath);if(!c)return r;const l=getDefAbsolutePath(c,i,n.project);if(0===l.length)return s;const u=l[0];return s.push({targetUri:u,targetRange:a,targetSelectionRange:a,originSelectionRange:n.range}),s}}exports.default=PageURIHandler;
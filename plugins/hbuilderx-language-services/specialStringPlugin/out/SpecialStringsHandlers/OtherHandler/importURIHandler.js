"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.doDefinition=exports.doComplete=void 0;const fs=require("fs"),jsonc_1=require("jsonc"),path=require("path"),vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),vscode_uri_1=require("vscode-uri"),hx=require("../../../../core"),core_1=require("../../../../core"),type_resolve_1=require("../../common/type-resolve"),ProjectFileFilter_1=require("../../tool/ProjectFileFilter"),handlerType_1=require("../handlerType");function getBuiltInLibs(e){const t=(0,core_1.detectProjectKind)(e),o=t===core_1.HXProjectKind.UniApp,i=t===core_1.HXProjectKind.UniApp_Cli;return o&&!i?["vue","vuex","vue-router","@dcloudio/uni-app"]:[]}function doComplete(e,t,o,i){let r=[],n=(e.uri.endsWith(".vue")||e.uri.endsWith(".nvue")||e.uri.endsWith(".uvue"),i.get(handlerType_1.LanguageServiceType.TS)),l=(0,type_resolve_1.getTokenAtPosition)(o.ast,e.offsetAt(t)),s="";l.kind===n.SyntaxKind.StringLiteral&&(s=l.text);let c=o.project.fsPath,a=(0,ProjectFileFilter_1.getCompletionFilesSync)(c,{extensionFilters:[".js",".vue"],prefixPath:s,timeout:1e3},e.uri);if(c){const e=(0,core_1.detectProjectKind)(c),t=e===core_1.HXProjectKind.UniApp,o=e===core_1.HXProjectKind.UniApp_Cli;if(t&&!o){let e=path.join(c,"abc.js");e=vscode_uri_1.URI.file(e).toString();let t=(0,ProjectFileFilter_1.getCompletionFilesSync)(c,{extensionFilters:[".js",".vue"],prefixPath:"",timeout:1e3},e);null==t||t.files.forEach((e=>{r.push({label:"@/"+e.relative,kind:e.isDir?vscode_languageserver_protocol_1.CompletionItemKind.Folder:vscode_languageserver_protocol_1.CompletionItemKind.File})}))}}if(null==a||a.files.forEach((e=>{r.push({label:e.relative,kind:e.isDir?vscode_languageserver_protocol_1.CompletionItemKind.Folder:vscode_languageserver_protocol_1.CompletionItemKind.File})})),c){let e=c+"/package.json";if(fs.existsSync(e)){const[t,o]=jsonc_1.jsonc.safe.parse(fs.readFileSync(e).toString());if(!t)if(o.dependencies&&"object"==typeof o.dependencies)for(let e of Object.keys(o.dependencies))r.push({label:e});else if(o.devDependencies&&"object"==typeof o.devDependencies)for(let e of Object.keys(o.devDependencies))r.push({label:e})}""===s&&getBuiltInLibs(c).forEach((e=>{r.push({label:e})}))}return r}function doDefinition(e,t,o,i){let r=[],n=e.getText(o.range);if(n.startsWith("@/")){let e=o.project.fsPath,t=n.replace("@",e).replace(/\\/g,"/"),l={start:vscode_languageserver_protocol_1.Position.create(0,0),end:vscode_languageserver_protocol_1.Position.create(0,0)};r.unshift({originSelectionRange:o.range,targetUri:hx.toNormalizedUri(t,i.get(handlerType_1.LanguageServiceType.TS)),targetRange:l,targetSelectionRange:l})}return r}exports.doComplete=doComplete,exports.doDefinition=doDefinition;
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),vscode_uri_1=require("vscode-uri"),ts=require("typescript/lib/tsserverlibrary"),core_1=require("../../../../core"),type_resolve_1=require("../../common/type-resolve"),ProjectFileFilter_1=require("../../tool/ProjectFileFilter"),htmlCustomDataProvider_1=require("../../tool/htmlCustomDataProvider"),htmlDataUtils_1=require("../../tool/htmlDataUtils"),handlerType_1=require("../handlerType"),utils_1=require("../utils"),BaseHandler_1=require("./BaseHandler"),valuesCache=new Map;function getDistinctAttrsValues(e){var t,r;if(valuesCache.size>0)return null!==(t=valuesCache.get(e))&&void 0!==t?t:[];let o=new Set;return[(0,htmlDataUtils_1.htmlDataProvider)(),(0,htmlCustomDataProvider_1.getCustomHTMLDataProvider)()].forEach((e=>{var t;let r=e.provideTags();for(let i of r){let r=e.provideAttributes(i.name);for(let n of r){let r=e.provideValues(i.name,n.name),a=[];r.forEach((e=>{const t=`${n.name}:${e.name}`;o.has(t)||(a.push(e),o.add(t))})),valuesCache.has(n.name)?null===(t=valuesCache.get(n.name))||void 0===t||t.push(...a):valuesCache.set(n.name,a)}}})),null!==(r=valuesCache.get(e))&&void 0!==r?r:[]}function getCompletionsForAttr(e,t){return getDistinctAttrsValues(e).map((e=>({label:e.name,kind:vscode_languageserver_protocol_1.CompletionItemKind.Unit,textEdit:t?vscode_languageserver_protocol_1.TextEdit.replace(t,e.name):void 0,data:{hxKind:core_1.HxIconKind.ATTRIBUTE}})))}const DQ='"'.charCodeAt(0),SQ="'".charCodeAt(0);function getFileCompletions(e,t,r,o,i){var n,a;const l=e.getText();let s=o,c=i.getStart();for(;s>c;){let e=l.charCodeAt(s-1);if(e==DQ||e==SQ)break;s--}let d={extensionFilters:[],prefixPath:l.slice(s,o),timeout:200,withAllCurrentLevelFiles:!0},u=null!==(a=null===(n=(0,ProjectFileFilter_1.getCompletionFilesSync)(t,d,e.uri))||void 0===n?void 0:n.files)&&void 0!==a?a:[],p=[];return u.forEach((e=>{p.push({label:e.relative,kind:e.isDir?vscode_languageserver_protocol_1.CompletionItemKind.Folder:vscode_languageserver_protocol_1.CompletionItemKind.File,data:{hxKind:e.isDir?core_1.HxIconKind.FOLDER:core_1.HxIconKind.FILE}})})),p}async function getIdCompletions(e,t,r){let o=[];const i=await(0,core_1.getAllKindData)(r.project,"REF",!1);if(!i)return o;const n=(0,core_1.noTsToNormalizedUri)(e.uri);if(!n)return o;(0,core_1.noTsToNormalizedPath)(e.uri);let a=[n];const l=(0,core_1.iterateGetBackReference)(i,[n],new Map);let s=(0,core_1.getReferenceList)(l);if(s||(s=[]),a=s,a.push(n),0===a.length)return o;const c=(0,core_1.noTsToNormalizedUri)(r.project.fsPath);if(!c)return o;const d={projectUri:c,kind:"ID",limit:2e3,fields:["value"],distinct:!0},u=(0,core_1.getIndexDataOptionsFromList)(a,d);let p;if(p=await r.project.indexPipeHandler.getIndexDataRequest(u,!1),!p)return o;if(0===p.length)return o;p.forEach((e=>{e=(0,utils_1.specialNormalizationIndexData)(r.kind,e)}));const _={replaceRange:r.range,needFilePath:!0};return p.forEach((e=>{o.push(...(0,core_1.creatorCompletionFromIndexData)(e,_))})),o}async function getClassCompletions(e,t,r){let o=[];const i=await(0,core_1.getAllKindData)(r.project,"REF",!1);if(!i)return o;const n=(0,core_1.noTsToNormalizedUri)(e.uri),a=(0,core_1.noTsToNormalizedPath)(e.uri);if(!n)return o;if(!a)return o;let l=[n];if(a.endsWith(".js")||a.endsWith(".ts")){const e=(0,core_1.iterateGetBackReference)(i,[n],new Map);let t=(0,core_1.getReferenceList)(e);t||(t=[]),l=t}let s=[];const c=(0,core_1.iterateGetReference)(i,l,new Map);let d=(0,core_1.getReferenceList)(c);if(d||(d=[]),s=d,s.push(a),0===s.length)return o;const u=(0,core_1.noTsToNormalizedUri)(r.project.fsPath);if(!u)return o;const p={projectUri:u,kind:"CLASS",limit:2e3,fields:["value"],distinct:!0},_=(0,core_1.getIndexDataOptionsFromList)(s,p);let m;if(m=await r.project.indexPipeHandler.getIndexDataRequest(_,!1),!m)return o;if(0===m.length)return o;m.forEach((e=>{e=(0,utils_1.specialNormalizationIndexData)(r.kind,e)}));const f={replaceRange:r.range,needFilePath:!0};return m.forEach((e=>{o.push(...(0,core_1.creatorCompletionFromIndexData)(e,f))})),o}class HtmlAttributeValueHandler extends BaseHandler_1.BaseHandler{async doCompleteAsync(e,t,r,o,i){let n;if(r.kind===handlerType_1.StringLocationInfoKind.IN_JS_LIKE&&(n=r.ast),!n)return[];let a=e.offsetAt(t),l=(0,type_resolve_1.getTokenAtPosition)(n,a);if(l){let t=l.parent;if(t&&t.kind==ts.SyntaxKind.CallExpression){let o=t.arguments,i=-1;for(let e=0;e<o.length;e++){let t=o[e];if(a>=t.getStart()&&a<=t.getEnd()){i=e-1;break}}if(i>=0){let t=o[i];if(t.kind==ts.SyntaxKind.StringLiteral){let o=t.getText(),i=o.charCodeAt(0);i!=DQ&&i!=SQ||(o=o.slice(1,-1));let n=r.project.fsPath,l={name:"",uri:vscode_uri_1.URI.file(n).toString()};return"src"==o?l?getFileCompletions(e,l,r.range,a,t):[]:"id"==o?l?getIdCompletions(e,l,r):[]:"class"==o?l?getClassCompletions(e,l,r):[]:getCompletionsForAttr(o,r.range)}}}}return[]}}exports.default=HtmlAttributeValueHandler;
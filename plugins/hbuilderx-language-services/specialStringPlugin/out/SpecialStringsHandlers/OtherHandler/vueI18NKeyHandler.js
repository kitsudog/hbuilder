"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const fs=require("fs"),path=require("path"),vscode_languageserver_1=require("vscode-languageserver"),vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),vscode_uri_1=require("vscode-uri"),core_1=require("../../../../core"),vscode_json_languageservice_1=require("../../../../packages/vscode-json-languageservice"),BaseHandler_1=require("./BaseHandler");function getJsonServer(){const e={resolveRelativePath:(e,t)=>{const r=t.substring(0,t.lastIndexOf("/")+1);return vscode_uri_1.Utils.resolvePath(vscode_uri_1.URI.parse(r),e).toString()}};return(0,vscode_json_languageservice_1.getLanguageService)({workspaceContext:e,contributions:[],clientCapabilities:vscode_json_languageservice_1.ClientCapabilities.LATEST})}function treeApply(e,t){e&&t(e)&&e.children&&e.children.forEach((e=>{treeApply(e,t)}))}function getNodeFromKey(e,t){let r=[];const n=e.root;return n?(treeApply(n,(e=>("property"===e.type&&e.keyNode.value===t&&r.push(e),!0))),r):r}function getNodeFromValue(e,t){let r=[];const n=e.root;return n?(treeApply(n,(e=>{var n;return"property"===e.type&&(null===(n=e.valueNode)||void 0===n?void 0:n.value)===t&&r.push(e),!0})),r):r}function getCurrentI18nLanguageFile(e){var t;let r,n=path.join(e.sourceRoot,"manifest.json");if(!fs.existsSync(n))return;let o=fs.readFileSync(n),i=vscode_languageserver_textdocument_1.TextDocument.create(n,"json",1,o.toString()),s=getJsonServer().parseJSONDocument(i),a=getNodeFromKey(s,"locale"),c="zh-Hans";if(a.length>0){c=null===(t=a[0].valueNode)||void 0===t?void 0:t.value}let u=path.join(e.sourceRoot,"locale");if(!fs.existsSync(u))return;let l=fs.readdirSync(u);if(!l)return r;if(l.length<1)return r;let d=l.filter((e=>{if(!e.includes("uni")&&e.endsWith(".json"))return e}));if(!d.includes(c+".json")){let e=getNodeFromKey(s,"fallbackLocale"),t="en";if(a.length>0&&(t=e[0].value),!d.includes(c+".json"))return}return r=path.join(u,c+".json"),r}class VueI18NKeyHandler extends BaseHandler_1.BaseHandler{async doCompleteAsync(e,t,r,n,o){if(!r.project.sourceRoot)return o;let i=r.project;if(!i)return o;if(i.kind!==core_1.HXProjectKind.UniApp&&i.kind!==core_1.HXProjectKind.UniApp_Cli)return o;let s=getCurrentI18nLanguageFile(i);if(s){const e=getJsonServer();if(!fs.existsSync(s))return o;const t=fs.readFileSync(s),n=vscode_languageserver_textdocument_1.TextDocument.create(s,"json",1,t.toString()),i=e.parseJSONDocument(n).root;if(!i)return o;treeApply(i,(e=>{var t;return"property"===e.type&&o.push({label:e.keyNode.value,detail:s,documentation:null===(t=e.valueNode)||void 0===t?void 0:t.value,textEdit:vscode_json_languageservice_1.TextEdit.replace(r.range,e.keyNode.value),kind:vscode_languageserver_1.CompletionItemKind.Text,data:{hxKind:core_1.HxIconKind.ATTRIBUTE}}),!0}))}return o}async doHoverAsync(e,t,r,n){var o;if(!r.project.sourceRoot)return;let i=r.project;if(!i)return;if(i.kind!==core_1.HXProjectKind.UniApp&&i.kind!==core_1.HXProjectKind.UniApp_Cli)return;let s=e.getText(r.range),a=getCurrentI18nLanguageFile(i);if(a){const e=getJsonServer();if(!fs.existsSync(a))return;const t=fs.readFileSync(a),n=vscode_languageserver_textdocument_1.TextDocument.create(a,"json",1,t.toString()),i=getNodeFromKey(e.parseJSONDocument(n),s);if(!i)return;const c=i[0];if(!c||!c.keyNode)return;return{contents:null===(o=c.valueNode)||void 0===o?void 0:o.value,range:r.range}}}async doDefinitionAsync(e,t,r,n,o){if(!r.project.sourceRoot)return[];let i=r.project;if(!i)return[];if(i.kind!==core_1.HXProjectKind.UniApp&&i.kind!==core_1.HXProjectKind.UniApp_Cli)return[];let s=e.getText(r.range),a=getCurrentI18nLanguageFile(i);if(a){const e=getJsonServer();if(!fs.existsSync(a))return[];const t=fs.readFileSync(a),n=vscode_languageserver_textdocument_1.TextDocument.create(a,"json",1,t.toString()),o=getNodeFromKey(e.parseJSONDocument(n),s);if(!o)return[];const i=o[0];if(!i||!i.keyNode)return[];let c=n.positionAt(i.keyNode.offset),u=n.positionAt(i.keyNode.offset+i.keyNode.length),l=vscode_json_languageservice_1.Range.create(c,u),d={targetUri:a,targetRange:l,targetSelectionRange:l,originSelectionRange:r.range},g=[];return g.push(d),g}return[]}}exports.default=VueI18NKeyHandler;
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const fs=require("fs"),path=require("path"),vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),core_1=require("../../../../core"),uniCloudPath_1=require("../../common/uniCloudPath"),BaseHandler_1=require("./BaseHandler");function getUniModuleValidateFunction(e,t){let n=path.join(t,(0,uniCloudPath_1.getUniModulesDir)());fs.existsSync(n)&&fs.statSync(n).isDirectory()&&fs.readdirSync(n).forEach((i=>{let a=path.join(n,i);if(fs.statSync(a).isDirectory()){let n=path.join(t,(0,uniCloudPath_1.getUniModuleValidate)(i,""));if(!fs.existsSync(n))return;if(!fs.statSync(n).isDirectory())return;fs.readdirSync(n).forEach((t=>{let i=path.join(n,t);fs.statSync(i).isFile()&&t.endsWith(".js")&&e.add(t.substr(0,t.lastIndexOf(".")))}))}}))}class ValidateFunctionHandler extends BaseHandler_1.BaseHandler{async doCompleteAsync(e,t,n,i,a){let r=[],s=new Set,o=n.project.fsPath;for(let e=0;e<uniCloudPath_1.providers.length;++e){let t=path.join(o,(0,uniCloudPath_1.getValidationRoot)(uniCloudPath_1.providers[e]));fs.existsSync(t)&&(fs.statSync(t).isDirectory()&&fs.readdirSync(t).forEach((e=>{let n=path.join(t,e);fs.statSync(n).isFile()&&e.endsWith(".js")&&s.add(e.substr(0,e.lastIndexOf(".")))})))}return getUniModuleValidateFunction(s,o),s.forEach((e=>{r.push({label:e,kind:vscode_languageserver_protocol_1.CompletionItemKind.File,documentation:e})})),r}async doDefinitionAsync(e,t,n,i,a){let r=n.project.fsPath,s=e.getText(n.range);for(let e=0;e<uniCloudPath_1.providers.length;++e){let t=path.join(r,(0,uniCloudPath_1.getValidationRoot)(uniCloudPath_1.providers[e]));if(!fs.existsSync(t))continue;if(!fs.statSync(t).isDirectory())continue;let i=fs.readdirSync(t);for(let e of i){let i=path.join(t,e);if(fs.statSync(i).isFile()&&e.endsWith(".js")){if(path.basename(i,".js")==s)return[{targetUri:i,targetRange:(0,core_1.getNullRange)(),targetSelectionRange:(0,core_1.getNullRange)(),originSelectionRange:n.range}]}}}let o=path.join(r,(0,uniCloudPath_1.getUniModulesDir)());if(!fs.existsSync(o))return[];if(!fs.statSync(o).isDirectory())return[];let l=fs.readdirSync(o);for(let e of l){let t=path.join(o,e);if(fs.statSync(t).isDirectory()){let t=path.join(r,(0,uniCloudPath_1.getUniModuleValidate)(e,""));if(!fs.existsSync(t))continue;if(!fs.statSync(t).isDirectory())continue;let i=fs.readdirSync(t);for(let e of i){let i=path.join(t,e);if(fs.statSync(i).isFile()&&e.endsWith(".js")){if(path.basename(i,".js")==s)return[{targetUri:i,targetRange:(0,core_1.getNullRange)(),targetSelectionRange:(0,core_1.getNullRange)(),originSelectionRange:n.range}]}}}}return[]}}exports.default=ValidateFunctionHandler;
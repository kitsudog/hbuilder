"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getTagAttributes=exports.getHtmlTags=exports.getLanguageServerExt=void 0;const chardet=require("chardet"),fs=require("fs"),vscode_languageserver_1=require("vscode-languageserver"),vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),vscode_uri_1=require("vscode-uri"),core_1=require("../../../core"),vscode_html_languageservice_1=require("../../../packages/vscode-html-languageservice"),serverinterface_1=require("../../../serverinterface"),dataProviderManager_1=require("./dataProviderManager"),utils_1=require("./utils"),dataManager=(0,dataProviderManager_1.getDataManager)();class HtmlLanguageServiceExt{constructor(){this.languageService=(0,vscode_html_languageservice_1.getLanguageService)()}findSymbol(e,r,t){return t?Promise.resolve().then((()=>{if(r.type!=serverinterface_1.SymbolType.ElementId)return[];let t=new Map,a=[];return t.forEach(((t,n)=>{t.references.find((t=>{if(t.uri===e.uri){let e=this.findIdInDocument(n,r.text);if(e)return a=vscode_languageserver_1.Location.create(n,e),!0}return!1}))})),a})):Promise.resolve([])}findIdInDocument(e,r){try{let t=fs.readFileSync(vscode_uri_1.URI.parse(e).fsPath),a=chardet.detect(t),n=t.toString(a||"utf-8");t=void 0;let i=vscode_languageserver_textdocument_1.TextDocument.create(e,"html",1,n),s=this.languageService.parseHTMLDocument(i),o=null;return utils_1.HtmlServiceExtUtils.searchHtmlNode(s.roots,(e=>{let t=utils_1.HtmlServiceExtUtils.getAttributeInDocument(i,this.languageService,e,"id");return!t||r!=i.getText(t)||(o=t,!1)})),o}catch(r){console.log("find id symbol in "+e+" faild:"+r)}return null}}function getLanguageServerExt(){let e=new HtmlLanguageServiceExt;return{findSymbol:(r,t,a)=>e.findSymbol(r,t,a)}}function getHtmlTags(e){let r=new Set,t=!1;if(e){const r=vscode_uri_1.URI.parse(e.uri).fsPath;t=(0,core_1.detectProjectKind)(r)===core_1.HXProjectKind.UniApp}return e&&t?dataManager.vueDataProvides().forEach((e=>{e.provideTags().forEach((e=>{r.has(e.name)||r.add(e.name)}))})):dataManager.defaultDataProvider().provideTags().forEach((e=>{r.has(e.name)||r.add(e.name)})),Array.from(r.values())}function getTagAttributes(e,r){let t=new Set,a=[],n=!1;if(e){const r=vscode_uri_1.URI.parse(e.uri).fsPath;n=(0,core_1.detectProjectKind)(r)===core_1.HXProjectKind.UniApp}a=e&&n?dataManager.vueDataProvides():[dataManager.defaultDataProvider()];const i=e=>{e.name.startsWith("[event]")||e.name.startsWith("on")||t.has(e.name)||t.add(e.name)};return void 0===r?a.forEach((e=>{var r;null==e||e._tags.forEach((e=>{e.attributes.forEach(i)})),null===(r=null==e?void 0:e._globalAttributes)||void 0===r||r.forEach(i)})):a.forEach((e=>{e.provideAttributes(r).forEach(i)})),Array.from(t.values())}exports.getLanguageServerExt=getLanguageServerExt,exports.getHtmlTags=getHtmlTags,exports.getTagAttributes=getTagAttributes;
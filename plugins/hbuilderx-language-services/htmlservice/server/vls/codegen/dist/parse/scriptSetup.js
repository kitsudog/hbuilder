"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,d){void 0===d&&(d=n);var a=Object.getOwnPropertyDescriptor(t,n);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,d,a)}:function(e,t,n,d){void 0===d&&(d=n),e[d]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.parseScriptSetups=void 0;const utils_1=require("../utils"),path=__importStar(require("path"));function parseScriptSetups({ts:e,ast:t,baseFileName:n,script:d,codeGen:a,vueLibName:r,baseName:o,tsCodegen:s,identifiers:i}){let p=!1,T=0,x={start:0,end:0},_=[];if(_.push({typeBindings:(0,utils_1.parseBindingRanges)(e,t,!0),bindings:(0,utils_1.parseBindingRanges)(e,t,!1),content:d.text}),t.forEachChild((n=>{var d;const a=(e.isTypeAliasDeclaration(n)||e.isInterfaceDeclaration(n))&&(null===(d=n.modifiers)||void 0===d?void 0:d.some((t=>t.kind===e.SyntaxKind.ExportKeyword)));p||a||e.isImportDeclaration(n)||e.isEmptyStatement(n)||e.isImportEqualsDeclaration(n)||(T=n.getStart(t),p=!0)})),t.forEachChild((e=>u(e,t))),a.addCode2(d.text.substring(0,T),0+d.range.start,void 0),s.addCode2(d.text.substring(0,T),0+d.range.start,void 0),a.addText("export default await (async () => {\n"),s.addText("export default await (async () => {\n"),a.addCode2(d.text.substring(T),T+d.range.start,void 0),s.addCode2(d.text.substring(T),T+d.range.start,void 0),a.addText(`const __VLS_Component = (await import('${r}')).defineComponent({\n`),s.addText(`const __VLS_Component = (await import('${r}')).defineComponent({\n`),a.addText("props: ("),a.addText("{} as "),a.addText("__VLS_TypePropsToRuntimeProps<"),a.addText(d.text.substring(x.start,x.end)),a.addText(">"),a.addText("),\n"),s.addText("props: ("),s.addText("{} as "),s.addText("__VLS_TypePropsToRuntimeProps<"),s.addText(d.text.substring(x.start,x.end)),s.addText(">"),s.addText("),\n"),a.addText("setup() {\n"),s.addText("setup() {\n"),a.addText("return {\n"),s.addText("() => {\n"),s.addText("// @ts-ignore\n"),s.addText("["),_&&_.length>0)for(const{bindings:e,content:t}of _)for(const n of e){const e=t.substring(n.start,n.end);a.addText(e),a.addText(": "),a.addText(e),a.addText(",\n")}s.addText("];\n"),s.addText("// @ts-ignore\n"),s.addText("["),s.addText([...i].join(", ")),s.addText("];\n"),s.addText("};\n"),s.addText("return {\n"),s.addText("};\n"),s.addText("},\n"),s.addText("});\n"),s.addText(`const __VLS_slots = (await import('./${o}.__VLS_template')).default;\n`),s.addText(`return {} as typeof __VLS_Component & (new () => { ${getSlotsPropertyName(3)}: typeof __VLS_slots });\n`),s.addText("})();"),s.addText("\n"),a.addText("};\n"),a.addText("},\n"),a.addText("});\n"),a.addText("return __VLS_Component;\n"),a.addText("})();"),a.addText("\n"),a.addText("type __VLS_NonUndefinedable<T> = T extends undefined ? never : T;\n"),a.addText(`type __VLS_TypePropsToRuntimeProps<T> = { [K in keyof T]-?: {} extends Pick<T, K> ? { type: import('${r}').PropType<__VLS_NonUndefinedable<T[K]>> } : { type: import('${r}').PropType<T[K]>, required: true } };\n`),s.addText("type __VLS_NonUndefinedable<T> = T extends undefined ? never : T;\n"),s.addText(`type __VLS_TypePropsToRuntimeProps<T> = { [K in keyof T]-?: {} extends Pick<T, K> ? { type: import('${r}').PropType<__VLS_NonUndefinedable<T[K]>> } : { type: import('${r}').PropType<T[K]>, required: true } };\n`),a.addText("\n"),a.addText("export const __VLS_options = {\n"),a.addText("props: ({} as "),a.addText(d.text.substring(x.start,x.end)),a.addText("),\n"),a.addText("};\n"),a.addText("\n"),a.addText(`export declare const __VLS_name: '${path.basename(o.substring(0,o.lastIndexOf(".")))}';\n`),a.addText("export {\n");for(const e of _)for(const t of e.typeBindings){const n=e.content.substring(t.start,t.end);a.addText(n),a.addText(`  as __VLS_types_${n},\n`)}function u(n,d){var a;if(e.isCallExpression(n)&&e.isIdentifier(n.expression)){const e=n.expression.getText(t);if(("defineProps"===e||"defineEmits"===e||"defineExpose"===e)&&(null===(a=n.typeArguments)||void 0===a?void 0:a.length)){const d=n.typeArguments[0];"defineProps"===e&&(x=(0,utils_1.getStartEnd)(d,t))}}n.forEachChild((e=>u(e,n)))}a.addText("};\n")}function getSlotsPropertyName(e){return e<3?"$scopedSlots":"$slots"}exports.parseScriptSetups=parseScriptSetups;
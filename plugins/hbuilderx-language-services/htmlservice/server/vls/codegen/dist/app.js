"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,a){void 0===a&&(a=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,a,r)}:function(e,t,n,a){void 0===a&&(a=n),e[a]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.codeGen=void 0;const vue=__importStar(require("./vueParser")),path=__importStar(require("path")),code_gen_1=require("./code-gen"),ts=__importStar(require("typescript/lib/tsserverlibrary")),core_1=require("../../../../../core"),utils_1=require("./utils"),transform_1=require("./transform"),source_map_1=require("./source-map"),template_1=require("./helper/template"),type_1=require("./helper/type");let parser=vue.createParser();function codeGen(e,t,n){let a=e,r=path.basename(a),i=(path.dirname(a),(0,type_1.getType)(r)),d=new code_gen_1.CodeGen,o=new code_gen_1.CodeGen,l=new code_gen_1.CodeGen,s=new code_gen_1.CodeGen,u=0,v={},c=null,p=new Map,_=!1,f="js",x="js";new Map;new Map;let g=new Set;function T(e,t,n=null){var a,r,i;const d=null===(a=t.name)||void 0===a?void 0:a.text;if(e)if(e.children&&0!==e.children.length){for(const t of e.attributes){const e=null===(i=t.name)||void 0===i?void 0:i.text,n=p.get(e);void 0===n?p.set(e,0):p.set(e,n-1)}T(e.children[0],t,e)}else{(null===(r=e.name)||void 0===r?void 0:r.text)===d&&(n?n.children=null:c=null)}}function m(e,t=null,n){var a;if(!e)return;if(!e.children||0===e.children.length)return{curTag:e,parentTag:t};let r=e.children.length;if(n)for(var i=0,d=e.attributes.length;i<d;i++)n.add(null===(a=e.attributes[i].name)||void 0===a?void 0:a.text);return m(e.children[r-1],e,n)}function h(e,t,n){var a,r,i;const o=null===(a=e.name)||void 0===a?void 0:a.text,l=(0,utils_1.isHTMLTag)(null===(r=t.name)||void 0===r?void 0:r.text);let s="";s=o.replace(/^@|(v-on:)/,"");const p="__VLS_"+u++,_="__VLS_"+u++;if(l||(d.addText(`const ${p} = new ${n}({ `),function(e,t){var n,a,r;let i=e.attributes;for(const e of i){let i=null===(n=e.name)||void 0===n?void 0:n.text,d=null===(a=null==e?void 0:e.value)||void 0===a?void 0:a.text;if(!y(i)&&!(0,utils_1.isDirectAttr)(e)){let n=(0,template_1.parseAttribute)(i);6===n.type?(t.addText(`${n.content}: `),t.addText("("),d?(t.addText('"'),t.addCode2((0,utils_1.toUnicode)(d),e.value.range.start,void 0),t.addText('"')):t.addText("true"),t.addText(")")):7!==n.type||n.arg?7===n.type&&(t.addText(`${null===(r=null==n?void 0:n.arg)||void 0===r?void 0:r.content}: `),t.addText("("),(0,transform_1.writeInterpolation)(d,e.value.range.start,"(",")",t,c,g),t.addText(")")):(t.addText("..."),(0,transform_1.writeInterpolation)(d,e.value.range.start,"(",")",t,c,g)),t.addText(",")}}}(t,d),d.addText("});\n"),d.addText(`type ${_} = typeof ${p} extends { $props: infer Props } ? Props & Record<string, unknown> : typeof ${n} & Record<string, unknown>;\n`)),d.addText(`const __VLS_${u++}: {\n`),d.addText(`'${s}': __VLS_types.FillingEventArg<\n`),!l){d.addText("__VLS_types.FirstFunction<\n"),d.addText(`__VLS_types.EmitEvent<typeof ${n}, '${s}'>,\n`),d.addText(`${_}[`);const t=(0,utils_1.camelize)("on-"+s),a="on"+(0,utils_1.capitalize)(s);d.addCode2(`'${t}'`,e.name.range.start,void 0),d.addText("],\n"),a!==t&&(d.addText(`${_}[`),d.addCode2(`'${a}'`,e.name.range.start,void 0),d.addText("],\n")),d.addText(`typeof ${p} extends { $emit: infer Emit } ? __VLS_types.EmitEvent2<Emit, '${s}'> : unknown,\n`)}d.addText(`__VLS_types.GlobalAttrs['${(0,utils_1.camelize)("on-"+s)}'],\n`),d.addText(">\n"),l||d.addText(">\n"),d.addText("} = {\n"),d.addText(`'${s}': $event => `),e.value&&(0,transform_1.writeInterpolation)(null===(i=e.value)||void 0===i?void 0:i.text,e.value.range.start,"(",")",d,v,g),d.addText("};\n")}function y(e){return e.startsWith("@")||e.startsWith("v-on")}parser.onStartTag((e=>{var t,n,a,r,i,o,l,s,p,m,y,$,b,w,S,C,M,V,L,I,j;if(!e)return;let E=!1,P=null===(t=e.name)||void 0===t?void 0:t.text;if(c){if((0,utils_1.isHTMLTag)(P)&&"script"!==P){const t=e.attributes;d.addText("{\n"),t&&!e.isSelfCloseTag&&t.map((e=>{var t,n;"id"===(null===(t=e.name)||void 0===t?void 0:t.text)&&d.addText(`\n\t\t\t\t\t\t  /**\n\t\t\t\t\t\t  * @id ${null===(n=e.value)||void 0===n?void 0:n.text}\n\t\t\t\t\t\t  */ \n\n\t\t\t\t\t\t declare let __VLS_ctx: typeof globalThis & typeof __VLS_types.InfererVueType;\n\t\t\t\t\t\t`)}))}c.children&&c.children.length>0||(c.children=[],c.children.push(e))}else c=e;if("script"===P){const t=e.attributes;if(t.length>0)for(var G=0,q=t.length;G<q;G++){if("setup"===t[G].name.text){_=!0;break}"lang"===t[G].name.text&&(f=null!==(n=t[G].value.text)&&void 0!==n?n:"js"),"type"===t[G].name.text&&(x="text/typescript"===t[G].value.text?"ts":"js")}}let O=(0,utils_1.isHTMLTag)(P);E=function(e){var t,n;let a=!1;if(e&&e.length>0)for(var r=0,i=e.length;r<i;r++)if("v-for"===(null===(n=null===(t=e[r])||void 0===t?void 0:t.name)||void 0===n?void 0:n.text)){a=!0;break}return a}(e.attributes);new Set([P,(0,utils_1.camelize)(P),(0,utils_1.capitalize)((0,utils_1.camelize)(P))]);u++;const W=(0,utils_1.capitalize)(P);u++;if(e.attributes){let t=e.attributes.length;for(G=0;G<t;G++){let t=e.attributes[G],n=null===(a=t.name)||void 0===a?void 0:a.text,u=(0,template_1.parseAttribute)(n);if(!t||!t.value)return;if(n.startsWith(":")){if(E&&":key"===n){d.addText("("),d.addCode2(`${null===(r=t.value)||void 0===r?void 0:r.text}`,t.value.range.start,void 0),d.addText(");\n");continue}O?(t.value&&(null===(l=t.value)||void 0===l?void 0:l.text)&&(0,transform_1.writeInterpolation)(t.value.text,t.value.range.start,"(",")",d,v,g),d.addText(";\n")):(d.addText(`${W}['`),d.addCode2(`${null===(i=null==u?void 0:u.arg)||void 0===i?void 0:i.content}`,t.name.range.start+1,void 0),d.addText("'] = "),(null===(o=null==t?void 0:t.value)||void 0===o?void 0:o.text)?(0,transform_1.writeInterpolation)(t.value.text,t.value.range.start,"(",")",d,v,g):d.addText("true"),d.addText(";\n"))}else{if(n.startsWith("@")){h(t,e,W);continue}if("v-for"===n){const e=null===(s=t.value)||void 0===s?void 0:s.text.trim().match(utils_1.forAliasRE);if(!e)continue;const[n,a,r]=e;let i=a.trim().replace(utils_1.stripParensRE,"").trim(),o=[];d.addText("for(let [");const l=ts.createSourceFile("/foo.ts",`const [${i}]`,ts.ScriptTarget.ESNext);(0,transform_1.colletVars)(ts,l,o),d.addCode2(`${i}`,t.value.range.start,void 0);for(const e of o)v[e]=(null!==(p=v[e])&&void 0!==p?p:0)+1;d.addText("] of __VLS_types.getVforSourceType("+(v[r]?"":"__VLS_ctx.")),d.addCode2(`${r}`,t.value.range.start+n.length-r.length,void 0),d.addText(")"),d.addText("){\n")}else if(n.startsWith("v-")){if(n.startsWith("v-on:")){h(t,e,W);continue}if("v-if"===n){d.addText("if ("),(0,transform_1.writeInterpolation)(null===(m=t.value)||void 0===m?void 0:m.text,t.value.range.start,"","",d,v,g),d.addText(") {\n");continue}if("v-else-if"===n){d.addText("else if ("),(0,transform_1.writeInterpolation)(null===(y=t.value)||void 0===y?void 0:y.text,t.value.range.start,"","",d,v,g),d.addText(") {\n");continue}if("v-else"===n){d.addText("else {\n");continue}if(n.startsWith("v-bind")){if(!(null===($=null==u?void 0:u.arg)||void 0===$?void 0:$.content)){d.addText("{..."),(0,transform_1.writeInterpolation)(null===(w=t.value)||void 0===w?void 0:w.text,t.value.range.start,"(",")",d,v,g),d.addText("};\n");continue}d.addText(`${W}.`),d.addCode2(`${null===(b=null==u?void 0:u.arg)||void 0===b?void 0:b.content}`,t.value.range.start,void 0),d.addText("=")}if(n.startsWith("v-html")){if(!(null===(S=null==u?void 0:u.arg)||void 0===S?void 0:S.content)){d.addText("{"),(0,transform_1.writeInterpolation)(null===(M=t.value)||void 0===M?void 0:M.text,t.value.range.start,"(",")",d,v,g),d.addText("};\n");continue}d.addText(`${W}.`),d.addCode2(`${null===(C=null==u?void 0:u.arg)||void 0===C?void 0:C.content}`,t.value.range.start,void 0),d.addText("=")}if(n.startsWith("v-model")){if(!(null===(V=null==u?void 0:u.arg)||void 0===V?void 0:V.content)){d.addText("{"),(0,transform_1.writeInterpolation)(null===(I=t.value)||void 0===I?void 0:I.text,t.value.range.start,"(",")",d,v,g),d.addText("};\n");continue}d.addText(`${W}.`),d.addCode2(`${null===(L=null==u?void 0:u.arg)||void 0===L?void 0:L.content}`,t.value.range.start,void 0),d.addText("=")}t&&t.value&&(0,transform_1.writeInterpolation)(null===(j=t.value)||void 0===j?void 0:j.text,t.value.range.start,"","",d,v,g),d.addText(";\n")}}}}e.isSelfCloseTag&&T(c,e)})),parser.onEndTag((e=>{var t;if(!e)return;let n=null===(t=e.name)||void 0===t?void 0:t.text,a=(0,utils_1.isHTMLTag)(n),r=new Set,i=m(c,null,r);if(!i)return;let{curTag:o,parentTag:l}=i;for(const e of o.attributes)(0,utils_1.isDirectAttr)(e)&&d.addText("}\n");a&&"script"!==n&&d.addText("}\n"),!["script","style"].includes(n)&&c&&T(c,e)})),parser.onInterpolation((e=>{const t=e.text;(0,transform_1.writeInterpolation)(t,e.range.start,"(",")",d,v,g),d.addText(";\n")})),parser.onScript((e=>{let t=(0,core_1.getConfigurationValue)(n.getUserPreferences(),"typescript.validate.enable",!0),a=(0,core_1.getConfigurationValue)(n.getUserPreferences(),"javascript.validate.enable",!1);"ts"!==x||t||l.addText("// @ts-nocheck\n"),"js"!==x||a||l.addText("// @ts-nocheck\n"),l.addCode2(e.text,e.range.start,void 0)})),parser.onStyle((e=>{s.addCode2(e.text,e.range.start,void 0)})),parser.parse(t),(0,utils_1.mergeCodeGen)(i,o),(0,utils_1.mergeCodeGen)(i,d);let $=new source_map_1.SourceMapBase(i.getMappings()),b=new source_map_1.SourceMapBase(l.getMappings()),w=new source_map_1.SourceMapBase(s.getMappings());console.timeEnd("timer");return{templateCodegen:{...i,sourceMap:$,hostFileName:a},scriptCodegen:{...l,sourceMap:b,hostFileName:a},styleCodegen:{...s,sourceMap:w,hostFileName:a}}}exports.codeGen=codeGen;
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.HTMLScriptCache=exports.HTMLEmbedsCacheInfo=void 0;const vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),core_1=require("../../core"),embeddedSupport_1=require("./modes/embeddedSupport"),codegen_1=require("../server/vls/codegen");class HTMLEmbedsCacheInfo{constructor(e,t,s,r,i){this._version=s,this._scriptLanguageId=t.scriptLanguageId,this._regions=t,this._tsImpl=r,this._scriptSnapshot=void 0,this._allEmbeds=i,this._htmlDocument=e}get scriptDocument(){return this._regions.getEmbeddedDocument(this.scriptLanguageId,!1)}get sourceFile(){return this._vueSourceFile}getEmbedFile(e){let t=(0,core_1.toNormalizedPath)(e,this._tsImpl);if(t=t.toLowerCase(),this._allEmbeds.has(t))return this._allEmbeds.get(t)}get allEmbedFiles(){let e=[];for(let t of this._allEmbeds.keys()){let s=this._allEmbeds.get(t);s&&(s.fileName=t,e.push(s))}return e}get htmlDocument(){return this._htmlDocument}get scriptLanguageId(){return this._scriptLanguageId?this._scriptLanguageId:"javascript"}get scriptSnapshot(){if(this._scriptSnapshot)return this._scriptSnapshot;let e=this.getEmbeddedDocument(this.scriptLanguageId,!1).getText(),t=this._regions.getImportedScripts();if(t&&t.length>0){let s=[""];t.forEach((e=>{e&&e.length>0&&s.push(`require("./${e}")`)})),e+=s.join("\n")}let s=this._tsImpl.ScriptSnapshot.fromString(e);return this._scriptSnapshot=s}get version(){return this._version}getLanguageAtPosition(e){return this._regions.getLanguageAtPosition(e)}getEmbeddedDocument(e,t){return this._regions.getEmbeddedDocument(e,t)}}exports.HTMLEmbedsCacheInfo=HTMLEmbedsCacheInfo;class HTMLScriptCache{constructor(e,t,s){this.tsImpl=e,this.tsServerHost=s,this.cache=new Map,this.htmlLanguageService=t}getScriptKind(e){let t=this.getUpToDateInfo(e);return t?"typescript"===t.scriptLanguageId?this.tsImpl.ScriptKind.TS:this.tsImpl.ScriptKind.JS:this.tsImpl.ScriptKind.Unknown}getAllEmbedsByCache(){let e=new Map;return this.cache.forEach((t=>{t.allEmbedFiles.forEach((t=>{e.set(t.fileName,t)}))})),e}get allSourceFiles(){return this.getAllEmbedsByCache()}getEmbeddedFile(e){let t=this.getAllEmbedsByCache();if(t.has(e))return t.get(e)}hasEmbeddedFile(e){return!!this.getAllEmbedsByCache().has(e)}getScriptSnapshot(e){let t=this.getUpToDateInfo(e);if(t)return t.scriptSnapshot}getScriptVersion(e){for(let t of this.cache.keys()){let s=this.cache.get(t);if(null==s?void 0:s.getEmbedFile(e))return s.version}return this.tsServerHost.getScriptVersion(e)}getUpToDateInfo(e){let t=this.cache.get(e),s=this.tsServerHost.getScriptVersion(e);if(t&&t.version===s)return t;let r=this.tsServerHost.getScriptSnapshot(e);if(!r)return;let i,n=r.getText(0,r.getLength()),o=vscode_languageserver_textdocument_1.TextDocument.create(e,"html",0,n),h=(0,embeddedSupport_1.getDocumentRegions)(this.htmlLanguageService,o),c=new Map;if(e.endsWith(".html")&&!e.endsWith(".vue.html")&&!e.endsWith(".nvue.html")&&!e.endsWith(".uvue.html")){i=(0,codegen_1.codeGen)(e,n,this.tsServerHost);let t=i.templateCodegen,s=i.scriptCodegen,r=(i.styleCodegen,(0,core_1.toNormalizedPath)(e+".__VLS_script.ts",this.tsImpl)),o=(0,core_1.toNormalizedPath)(e+".__VLS_template.ts",this.tsImpl);(0,core_1.toNormalizedPath)(e+".__VLS_style.css",this.tsImpl);c.set(r,s),c.set(o,t)}let a=new HTMLEmbedsCacheInfo(o,h,s,this.tsImpl,c);return this.cache.set(e,a),a}getTsImpl(){return this.tsImpl}isVueFile(e){let t=!1,s=this.tsServerHost.getScriptSnapshot(e);if(s)return s.getText(0,s.getLength()).startsWith("var Vue=function")&&(t=!0),t}}exports.HTMLScriptCache=HTMLScriptCache;
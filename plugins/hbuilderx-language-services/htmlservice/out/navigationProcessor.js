"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.NavigationProcessor=void 0;const util_1=require("./utils/util");class NavigationProcessor{static instance(t,e,i,s){return void 0===this._instance&&(this._instance=new NavigationProcessor(t,e,i,s)),this._instance}constructor(t,e,i,s){this._htmlCachesInProjectScope=t,this._info=e,this._tsLS=e.languageService,this._htmlLanguageModes=i,this._htmlLanguageServer=s}changeChildRange(t,e,i){return t=t.map((t=>(t.spans=t.spans.map((t=>{let s=(0,util_1.htmlVirtualToRealityFromRange)(this._htmlCachesInProjectScope,e,i,t);return s&&(t=s),t})),t.nameSpan=(0,util_1.htmlVirtualToRealityFromRange)(this._htmlCachesInProjectScope,e,i,t.nameSpan),t.childItems&&(t.childItems=this.changeChildRange(t.childItems,e,i)),t)))}changeNavigationRange(t,e,i){return t.childItems?(t.childItems=this.changeChildRange(t.childItems,e,i),t):t}mergeNavigationScriptData(t,e){return t=t.map((t=>{if("script"===t.text){if(t.spans.length<1)return t;if(t.childItems||(t.childItems=[]),!e.childItems||e.childItems.length<1)return t;e.childItems.forEach((e=>{var i;let s=e.spans[0],a=s.start,n=a+s.length;t.spans[0].start<a&&t.spans[0].start+t.spans[0].length>n&&(null===(i=t.childItems)||void 0===i||i.push(e))}))}else t.childItems&&t.childItems.length>0&&(t.childItems=this.mergeNavigationScriptData(t.childItems,e));return t}))}mergeNavigationStyleData(t,e){return t.forEach((t=>{if("style"===t.text){if(t.spans.length<1)return;if(t.childItems||(t.childItems=[]),!e.childItems||e.childItems.length<1)return;e.childItems.forEach((e=>{var i;let s=e.spans[0],a=s.start,n=a+s.length;t.spans[0].start<a&&t.spans[0].start+t.spans[0].length>n&&(null===(i=t.childItems)||void 0===i||i.push(e))}))}else t.childItems&&t.childItems.length>0&&this.mergeNavigationStyleData(t.childItems,e)})),t}mergeNavigationData(t,e,i){return t?("javascript"===i&&t.childItems?t.childItems=this.mergeNavigationScriptData(t.childItems,e):"css"===i&&t.childItems&&(t.childItems=this.mergeNavigationStyleData(t.childItems,e)),t):e}getNavigationTreeImpl(t){let e=this._htmlCachesInProjectScope,i={text:"",kind:this._info.ts.ScriptElementKind.alias,kindModifiers:"",spans:[],nameSpan:void 0};if(!this._info.tsinfo.project.getScriptInfo(t))return i;if(!e.getUpToDateInfo(t))return i;let s;return["html","javascript","css"].forEach((e=>{let i=this._htmlLanguageModes.get(e);if(!i)return;let a=i.getNavigationTree(this._tsLS,t,this._htmlLanguageServer);a&&a.childItems&&("html"!==e&&(a=this.changeNavigationRange(a,t,e)),s=this.mergeNavigationData(s,a,e))})),s||i}}exports.NavigationProcessor=NavigationProcessor;
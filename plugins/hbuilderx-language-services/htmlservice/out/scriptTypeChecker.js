"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.createVueComponentTypeChecker=exports.createVueThisTypeChecker=void 0;const core_1=require("../../core"),core_2=require("../../core"),path_1=__importDefault(require("path")),utils_1=require("../../utils");function getCallSignatures(e,t,r,i){let n=findFunctionDeclaration(e,core_2.ts,r);if(!n)return;let o=i.getSymbolOfNode(n);return o?i.getTypeOfSymbolAtLocation(o,n).getCallSignatures():void 0}function findFunctionDeclaration(e,t,r){let i;return function e(t){if(core_2.ts.isVariableStatement(t)&&t.declarationList&&t.declarationList.declarations){let e=t.declarationList.declarations[0];core_2.ts.isObjectBindingPattern(e.name)&&e.name.elements&&(i=e.name.elements.find((e=>core_2.ts.isBindingElement(e)&&e.getText()===r)))}i||core_2.ts.forEachChild(t,e)}(e),i}function getVueOptions(e,t,r,i,n,o){let s;return function e(r){var n;let o=r.parent;if(o)if(core_2.ts.isObjectLiteralExpression(o)&&o.properties&&o.properties.find((e=>core_2.ts.isPropertyAssignment(e)&&"el"===e.name.getText())))s=o;else if(core_2.ts.isObjectLiteralExpression(o)&&o.properties&&core_2.ts.isCallExpression(o.parent)&&core_2.ts.isPropertyAccessExpression(o.parent.expression)&&"component"===o.parent.expression.name.getText())s=o;else{if(core_2.ts.isCallExpression(o)&&"createApp"===o.expression.getText()){const e=o.arguments[0];if(core_2.ts.isObjectLiteralExpression(e)){let r=getCallSignatures(t,core_2.ts,o.expression.getText(),i);r&&r[0].parameters.find((e=>"rootComponent"===e.name))&&(s=e)}if(s)return}if(core_2.ts.isCallExpression(o)&&core_2.ts.isPropertyAccessExpression(o.expression)&&"createApp"===o.expression.name.getText()){const e=o.arguments[0];if(core_2.ts.isObjectLiteralExpression(e)&&(s=e),s)return}if(core_2.ts.isFunctionLike(o)){if("setup"===(null===(n=o.name)||void 0===n?void 0:n.getText())&&core_2.ts.isObjectLiteralExpression(o.parent)&&core_2.ts.isCallExpression(o.parent.parent)&&"createApp"===o.parent.parent.expression.getText())return void(s=void 0)}o&&o.kind!==core_2.ts.SyntaxKind.NewExpression&&e(o)}}(e),s}function getVueComponent(e,t){let r=!1;return function(t){let i=t.parent;i&&core_2.ts.isObjectLiteralExpression(e)&&core_2.ts.isCallExpression(i)&&"Vue.component"===i.expression.getText()&&(r=!0)}(e),r}function getVueExample(e,t){let r=!1;return function e(t){let i=t.parent;i&&(core_2.ts.isVariableDeclaration(i)&&i.initializer&&"Vue"===i.initializer.getText()?r=!0:e(i))}(e),r}function createVueThisTypeChecker(e){return{checkExpression(t,r,i,n,o,s){var a;const c=n.kind;let l=n.getSourceFile().fileName;if(l.endsWith("html.__VLS_script.ts")){let t=null===(a=e.languageService.getProgram())||void 0===a?void 0:a.getSourceFile(l);if(!(null==t?void 0:t.getChildAt(0))||!t)return;let r=getVueOptions(n,t,e.ts,i,o,s);if(c===e.ts.SyntaxKind.ThisKeyword&&r){if(r&&e.ts.isObjectLiteralExpression(r)&&i){const t=["data","props","methods","computed","setup"];let n=(0,utils_1.getVueNodes)(t,r.properties,e),o=(0,utils_1.getMembersAtProperty)(t,n,e,i);return i.createAnonymousType(void 0,o,[],[],[])}return}}else;}}}function createVueComponentTypeChecker(e){return{getContextualType(t,r,i,n,o,s){var a,c;if(n.getSourceFile().fileName.endsWith("html.__VLS_script.ts")){if(getVueComponent(n,e.ts)){let t=(0,core_1.getExtensionRootPath)(),r=path_1.default.join(t,"builtin-dts","uniapp@vue2","node_modules","vue","types","options.d.ts"),n=null===(a=e.languageService.getProgram())||void 0===a?void 0:a.getSourceFile(r);if(n&&i){let e=i.getSymbolsInScope(n,core_2.ts.SymbolFlags.Interface).find((e=>"ComponentOptions"===e.escapedName));if(e&&e.declarations){return i.getTypeAtLocation(e.declarations[0])}}}if(getVueExample(n,e.ts)){let t=(0,core_1.getExtensionRootPath)(),r=path_1.default.join(t,"builtin-dts","web","vue-web.d.ts"),n=null===(c=e.languageService.getProgram())||void 0===c?void 0:c.getSourceFile(r);if(n&&i){let e=i.getSymbolsInScope(n,core_2.ts.SymbolFlags.Variable).find((e=>"Vue"===e.escapedName));if(e&&e.declarations){return i.getTypeAtLocation(e.declarations[0])}}}}}}}exports.createVueThisTypeChecker=createVueThisTypeChecker,exports.createVueComponentTypeChecker=createVueComponentTypeChecker;
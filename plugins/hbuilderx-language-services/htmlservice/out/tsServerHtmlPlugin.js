"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TsServerHTMLPlugin=void 0;const core_1=require("../../core"),styleservice_1=require("../../styleservice"),HTMLScriptCache_1=require("./HTMLScriptCache"),domTypeChecker_1=require("./domTypeChecker"),htmlEmbedMode_1=require("./langModes/htmlEmbedMode"),scriptEmbedMode_1=require("./langModes/scriptEmbedMode"),styleEmbedMode_1=require("./langModes/styleEmbedMode"),HTMLAdditionalPlugin_1=require("./lspHtmlPlugin/additional/HTMLAdditionalPlugin"),htmlVueAdditionalPlugin_1=require("./lspHtmlPlugin/htmlVueAdditional/htmlVueAdditionalPlugin"),HTMLIdAndClassPlugin_1=require("./lspHtmlPlugin/idAndClass/HTMLIdAndClassPlugin"),HTMLRevisePLugin_1=require("./lspHtmlPlugin/revise/HTMLRevisePLugin"),navigationProcessor_1=require("./navigationProcessor"),plugins_1=require("./plugins"),scriptTypeChecker_1=require("./scriptTypeChecker"),serviceTypes_1=require("./serviceTypes"),localTypes_1=require("./utils/localTypes"),util_1=require("./utils/util");function isHTMLFile(e){return core_1.fileTypesTool.isHtmlType(e)}function initialize(e){let t=e.languageServiceHost;const i=t.getScriptKind.bind(t),n=t.getScriptSnapshot.bind(t),r=t.getScriptVersion.bind(t),a=t.getCompilationSettings.bind(t),o=t.getScriptFileNames.bind(t),s=new Map,l={getScriptVersion:e=>t.getScriptVersion(e),getScriptSnapshot(t){if(t.endsWith(".html")&&(t.includes(".vue.")||t.includes(".nvue.")||t.includes(".uvue."))){if(s.has(t)){let i=e.tsinfo.serverHost.readFile(t);return e.ts.ScriptSnapshot.fromString(i)}s.set(t,!0)}return n(t)},getCompilationSettings:a,getUserPreferences:function(){return e.tsinfo.project.projectService.getHostPreferences()}},c=(0,serviceTypes_1.getHTMLLanguageService)({}),u=[];u.push(new serviceTypes_1.HTMLDataProvider("html5",serviceTypes_1.htmlData)),u.push(new serviceTypes_1.HTMLDataProvider("vue-html",serviceTypes_1.vue2Data)),u.push(new serviceTypes_1.HTMLDataProvider("vue3-html",serviceTypes_1.vue3Data)),c.setDataProviders(!1,u);const p=new HTMLScriptCache_1.HTMLScriptCache(e.ts,c,l);!function(){const t=e.tsinfo.serverHost.readFile.bind(e.tsinfo.serverHost),i=e.tsinfo.serverHost.fileExists.bind(e.tsinfo.serverHost);e.tsinfo.serverHost.readFile=function(e,i){if(p.hasEmbeddedFile(e)){let t=p.getEmbeddedFile(e);if(t)return t.text}return e.endsWith(localTypes_1.typesFileName)?(0,localTypes_1.getTypesCode)(2):t(e,i)},e.tsinfo.serverHost.fileExists=function(e){return!!i(e)||(!!e.endsWith(localTypes_1.typesFileName)||p.hasEmbeddedFile(e))}}(),t.getScriptKind=function(e){return isHTMLFile(e)?p.getScriptKind(e):i(e)},t.getScriptSnapshot=t=>{if(isHTMLFile(t))return p.getUpToDateInfo(t),p.getScriptSnapshot(t);if(t.endsWith(".js")&&p.isVueFile(t))return p.getScriptSnapshot(t);if(t.endsWith(localTypes_1.typesFileName)){let i=e.tsinfo.serverHost.readFile(t);return e.ts.ScriptSnapshot.fromString(i)}if(p.hasEmbeddedFile(t)){if(t.endsWith(".html"))return n(t);let i=e.tsinfo.serverHost.readFile(t);return e.ts.ScriptSnapshot.fromString(i)}return n(t)},t.getScriptVersion=function(e){if(p.hasEmbeddedFile(e)){let t=p.getEmbeddedFile(e);return r(t.hostFileName)}return r(e)},t.getScriptFileNames=function(){let e=[],t=o();t&&(e.push(...t),t.map((e=>{isHTMLFile(e)&&p.getUpToDateInfo(e)})));let i=p.allSourceFiles;for(let t of i.keys())e.push(t);return e};let d=(0,plugins_1.enablePluginProxy)({languageService:c,project:e.project});const f=[];f.push(new HTMLRevisePLugin_1.HTMLRevisePLugin(e)),f.push(new HTMLAdditionalPlugin_1.HTMLAdditionalPlugin(e,u)),f.push(new HTMLIdAndClassPlugin_1.HTMLIdAndClassPlugin(e)),f.push(new htmlVueAdditionalPlugin_1.HTMLVueAdditionalPlugin(e,u)),f.forEach((t=>{d=t.create({languageService:d,project:e.project})}));const g=new Map;g.set("javascript",new scriptEmbedMode_1.ScriptEmbedMode(e,p)),g.set("html",new htmlEmbedMode_1.HtmlEmbedMode(e,p,d));const m=new Map;m.set("css",(0,serviceTypes_1.getCSSLanguageService)()),m.set("scss",(0,serviceTypes_1.getSCSSLanguageService)()),m.set("less",(0,serviceTypes_1.getLESSLanguageService)());const S={data:serviceTypes_1.webCssDataProvider,enable:function(e){return!(0,core_1.isUniAppXProject)(e)}},h={data:serviceTypes_1.uniappxCssDataProvider,enable:function(e){return(0,core_1.isUniAppXProject)(e)}},v=[new serviceTypes_1.MergeDataProvider(e.project,serviceTypes_1.styleI18nData,[S,h])],y=new Map;m.forEach(((e,t)=>{e.setDataProviders(!1,v),y.set(t,v)}));let T=(0,styleservice_1.styleServerListEnablePluginProxy)({styleLanguageServiceList:m,project:e.project});return T=new styleservice_1.StyleExtraPluginModule(e,y,u).create({styleLanguageServiceList:T,project:e.project}),g.set("css",new styleEmbedMode_1.StyleEmbedMode(e,p,T)),{htmlCachesInProjectScope:p,htmlLanguageModes:g,htmlLanguageService:d}}function create(e){let t=e.languageService;const i=Object.create(null);for(let e of Object.keys(t)){const n=t[e];i[e]=(...e)=>n.apply(t,e)}const{htmlCachesInProjectScope:n,htmlLanguageModes:r,htmlLanguageService:a}=initialize(e);i.isEnabled=function(e,t){return isHTMLFile(e)},i.getCompletionsAtPositionAsync=async function(i,a,o){const s=(0,util_1.initializeModeData)(e,n,r,i,a);if(!s)return;const l=s.modeLang,c=s.embeddedList;let u;for(var p=0;p<c.length;p++){let e=c[p].sourceMap,i=e.getMappedRange(a);if(c[p].fileName&&i){let n=(0,util_1.getModeAtEmbeddedFile)(c[p].fileName,r);if(n){if(u=await n.getCompletionsAtPositionAsync(t,c[p].fileName,i[0].start,o),!u)return;let r,a;return u.entries.forEach((t=>{r?((0,core_1.isSameTextSpan)(r,t.replacementSpan)||(r=t.replacementSpan,a=(0,util_1.vueVirtualToRealityFromRange)(e,t.replacementSpan)),t.replacementSpan=a):((0,util_1.vueVirtualToRealityFromRange)(e,t.replacementSpan),r=t.replacementSpan,a=(0,util_1.vueVirtualToRealityFromRange)(e,t.replacementSpan),t.replacementSpan=a)})),u}}}if(!u){let e,r=s.modeOffset,a=s.modeServer;if(u=await a.getCompletionsAtPositionAsync(t,i,r,o),!u)return;u.entries.forEach((t=>{e=(0,util_1.htmlVirtualToRealityFromRange)(n,i,l,t.replacementSpan),t.replacementSpan=e}));let c=[],p=[];return u.entries.forEach((e=>{c.includes(e.name)||(c.push(e.name),p.push(e))})),u.entries=p,u}return u},i.getCompletionEntryDetails=function(i,a,o,s,l,c,u){const p=(0,util_1.initializeModeData)(e,n,r,i,a);if(!p)return;const d=p.embeddedList,f=p.modeOffset,g=(p.modeLang,p.modeServer);let m;for(var S=0;S<d.length;S++){let e=d[S].sourceMap.getMappedRange(a);if(d[S].fileName&&e){let i=(0,util_1.getModeAtEmbeddedFile)(d[S].fileName,r);if(i)return m=i.getCompletionEntryDetails(t,d[S].fileName,e[0].start,o,s,l,c,u),m&&(m.codeActions=void 0,m.source=m.sourceDisplay=void 0),m}}return m||(m=g.getCompletionEntryDetails(t,i,f,o,s,l,c,u),m&&(m.codeActions=void 0,m.source=m.sourceDisplay=void 0)),m},i.getQuickInfoAtPositionAsync=async function(i,a){var o,s;const l=(0,util_1.initializeModeData)(e,n,r,i,a);if(!l)return;let c;const u=l.embeddedList,p=l.modeOffset,d=l.modeLang,f=l.modeServer;for(var g=0;g<u.length;g++){let e=u[g].sourceMap,i=e.getMappedRange(a);if(u[g].fileName&&i){let n=(0,util_1.getModeAtEmbeddedFile)(u[g].fileName,r);if(n){let r=await n.getQuickInfoAtPositionAsync(t,u[g].fileName,i[0].start);if(!r)return;return r.textSpan=null!==(o=(0,util_1.vueVirtualToRealityFromRange)(e,r.textSpan))&&void 0!==o?o:r.textSpan,r}}}return c||(c=await f.getQuickInfoAtPositionAsync(t,i,p),c&&(c.textSpan=null!==(s=(0,util_1.htmlVirtualToRealityFromRange)(n,i,d,c.textSpan))&&void 0!==s?s:c.textSpan),c)},i.getSignatureHelpItems=function(i,a,o){const s=(0,util_1.initializeModeData)(e,n,r,i,a);if(!s)return;const l=s.embeddedList,c=s.modeOffset;s.modeLang;for(var u=0;u<l.length;u++){let e=l[u].sourceMap.getMappedRange(a);if(l[u].fileName&&e){let i=(0,util_1.getModeAtEmbeddedFile)(l[u].fileName,r);if(i){let n=i.getSignatureHelpItems(t,l[u].fileName,e[0].start,o);if(!n)return;return n}}}return s.modeServer.getSignatureHelpItems(t,i,c,o)},i.getDefinitionAndBoundSpanAsync=async function(i,a){var o,s;const l=(0,util_1.initializeModeData)(e,n,r,i,a);if(!l)return;const c=l.modeOffset,u=l.modeLang,p=l.modeServer,d=l.embeddedList;let f;for(var g=0;g<d.length;g++){let e=d[g].sourceMap,s=e.getMappedRange(a);if(d[g].fileName&&s){let a=(0,util_1.getModeAtEmbeddedFile)(d[g].fileName,r);if(a){let r=await a.getDefinitionAndBoundSpanAsync(t,d[g].fileName,s[0].start);if(!r)return;return{textSpan:null!==(o=(0,util_1.vueVirtualToRealityFromRange)(e,r.textSpan))&&void 0!==o?o:r.textSpan,definitions:r.definitions.map((e=>{let t=n.getEmbeddedFile(e.fileName);if(!t)return e;let r=t.sourceMap;if(!r)return e;let a=i;return{...e,fileName:a,textSpan:(0,util_1.vueVirtualToRealityFromRange)(r,e.textSpan),contextSpan:(0,util_1.vueVirtualToRealityFromRange)(r,e.contextSpan)}}))}}}}if(f=await p.getDefinitionAndBoundSpanAsync(t,i,c),f&&f.definitions&&0!==f.definitions.length){if(f.textSpan=null!==(s=(0,util_1.htmlVirtualToRealityFromRange)(n,i,u,f.textSpan))&&void 0!==s?s:f.textSpan,"javascript"===u){let e=[];return f.definitions.forEach((t=>{if(t.fileName!==i)return void e.push(t);if(t.unverified)return void e.push(t);let r=(0,util_1.htmlVirtualToRealityFromRange)(n,i,u,t.textSpan);r&&e.push({kind:core_1.ts.ScriptElementKind.unknown,name:t.name,containerKind:core_1.ts.ScriptElementKind.unknown,containerName:"",textSpan:r,fileName:i})})),{textSpan:f.textSpan,definitions:e}}return f}};const o=new navigationProcessor_1.NavigationProcessor(n,e,r,a);let s={getNavigationTree:o.getNavigationTreeImpl.bind(o),isHTMLFile:isHTMLFile};return e.html=s,i.getNavigationTree=function(e){return s.getNavigationTree(e)},i.toLineColumnOffset=function(e,t){let i=n.getUpToDateInfo(e);if(i){let e=i.htmlDocument.positionAt(t);return{line:e.line,character:e.character}}throw new Error("[HtmlService] cacheInfo not found")},i.getSyntacticDiagnosticsAsync=async function(i){if(!(0,core_1.getConfigurationValue)(e.tsinfo.project.projectService.getHostPreferences(),"javascript.validate.enable",!1))return[];const r=n.getUpToDateInfo(i);if(!r)return[];const a=r.scriptDocument;if(!a)return[];const o=[];return t.getSyntacticDiagnostics(i).forEach((e=>{const t=a.positionAt(e.start-1);o.push({...e,start:r.htmlDocument.offsetAt(t)+1})})),o},i.getSemanticDiagnosticsAsync=async function(i){if(!(0,core_1.getConfigurationValue)(e.tsinfo.project.projectService.getHostPreferences(),"javascript.validate.enable",!1))return[];const r=n.getUpToDateInfo(i);if(!r)return[];const a=r.scriptDocument;if(!a)return[];const o=[];return t.getSemanticDiagnostics(i).forEach((e=>{if(e.start){const t=a.positionAt(e.start-1);o.push({...e,start:r.htmlDocument.offsetAt(t)+1})}else o.push({...e})})),o},i.getSuggestionDiagnosticsAsync=async function(i){if(!(0,core_1.getConfigurationValue)(e.tsinfo.project.projectService.getHostPreferences(),"javascript.validate.enable",!1))return[];const r=n.getUpToDateInfo(i);if(!r)return[];const a=r.scriptDocument;if(!a)return[];const o=[];return t.getSuggestionDiagnostics(i).forEach((e=>{const t=a.positionAt(e.start-1);o.push({...e,start:r.htmlDocument.offsetAt(t)+1})})),o},i.findReferencesAsync=async function(i,a){const o=(0,util_1.initializeModeData)(e,n,r,i,a);if(!o)return;const s=o.modeOffset,l=o.modeLang,c=o.modeServer;let u=await c.findReferencesAsync(t,i,s);if(u&&0!==u.length){if("javascript"===l){let e=[];return u.forEach((t=>{t.definition.fileName===i&&(t.definition={...t.definition,contextSpan:(0,util_1.htmlVirtualToRealityFromRange)(n,i,l,t.definition.contextSpan),originalContextSpan:(0,util_1.htmlVirtualToRealityFromRange)(n,i,l,t.definition.originalContextSpan),textSpan:(0,util_1.htmlVirtualToRealityFromRange)(n,i,l,t.definition.textSpan)}),t.references=t.references.map((e=>(e.fileName===i&&(e.textSpan=(0,util_1.htmlVirtualToRealityFromRange)(n,i,l,e.textSpan),e.contextSpan=(0,util_1.htmlVirtualToRealityFromRange)(n,i,l,e.contextSpan),e.originalContextSpan=(0,util_1.htmlVirtualToRealityFromRange)(n,i,l,e.originalContextSpan)),e))),e.push(t)})),e}return u}},i.getFileReferencesAsync=async function(i){const n=await t.getFileReferencesAsync(i);if(!n)return[];if(i.endsWith("js")||i.endsWith("ts")){const t=[];n.forEach((e=>{e.fileName.endsWith("html")||t.push(e)}));const r=await(0,core_1.createFileRefDataFromIndex)(e.project,i),a=(0,core_1.fromLspFileReferences)(e,r);return a?(t.push(...a),t):t}return n},i.getCodeFixesAtPosition=function(i,a,o,s,l,c){const u=(0,util_1.initializeModeData)(e,n,r,i,a);if(!u)return[];const p=u.embeddedList;for(let e=0;e<p.length;e++){const n=p[e];let u=n.sourceMap,d=u.getMappedRange(a,o);if(!n.fileName)continue;if(!d)continue;if(!(0,util_1.getModeAtEmbeddedFile)(n.fileName,r))continue;const f=t.getCodeFixesAtPosition(n.fileName,d[0].start,d[0].end,s,l,c);return f.forEach((e=>{e.changes.forEach((e=>{e.fileName=i,e.textChanges.forEach((e=>{const t=(0,util_1.vueVirtualToRealityFromRange)(u,e.span);t&&(e.span=t)}))}))})),f}return[]},i}const TsServerHTMLPlugin={create:e=>e.languageService,createExtService:e=>create(e),createTypeCheckerPlugins:e=>[new domTypeChecker_1.DomCheckerPlugin(e,isHTMLFile),(0,domTypeChecker_1.creatHtmlVueChecker)(e),(0,scriptTypeChecker_1.createVueThisTypeChecker)(e),(0,scriptTypeChecker_1.createVueComponentTypeChecker)(e)]};exports.TsServerHTMLPlugin=TsServerHTMLPlugin;
"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,s,n)}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.TagIndex=void 0;const fs=__importStar(require("fs")),path=__importStar(require("path")),vscode_uri_1=require("vscode-uri"),core_1=require("../../../core"),vscode_html_languageservice_1=require("../../../packages/vscode-html-languageservice"),documentContext_1=require("../utils/documentContext");function accept(e,t){if(e(t)&&t.children)for(const r of t.children)accept(e,r)}function normalizeValue(e){const t=e[0];return t!==e[e.length-1]||"'"!==t&&'"'!==t||(e=e.substring(1,e.length-1)),e}function validateRef(e,t){return!!e.length&&(("handlebars"!==t||!/{{|}}/.test(e))&&/\b(w[\w\d+.-]*:\/\/)?[^\s()<>]+(?:\([\w\d]+\)|([^[:punct:]\s]|\/?))/.test(e))}function parseReferenceUri(e,t,r,s){const n=normalizeValue(t);if(validateRef(n,e.languageId)&&!(/^\s*javascript\:/i.test(n)||/[\n\r]/.test(n)||/^\#/i.test(n)||/^\/\//i.test(n)||/^https?:\/\//i.test(n)))return/^file:\/\//i.test(n)?n:r.resolveReference(n,s||e.uri)}function normalizeRefUri(e){if(!e.includes(".")){let t=e+".vue";fs.existsSync(t)&&(e=t),t=e+".nvue",fs.existsSync(t)&&(e=t),t=e+".uvue",fs.existsSync(t)&&(e=t)}if(e.match(/(.*)\.(.+)\?(.*)/)){const t=e.indexOf("?");e=e.substring(0,t)}return e}function setTagAttrs(e,t,r,s,n){e[t]={tagName:r,attributeValue:s,attributeValueOffset:n.getTokenOffset()+1}}function isNetworkPath(e){return/^(https?:\/\/|\/\/)/.test(e)}function createdIndexValue(e,t,r,s,n,a){let i=core_1.IndexItemType.REF,o="",c="",u=!1;if("REF"===n){if(!a)return;const r=(0,core_1.uriToPath)(a),n=(0,core_1.uriToPath)(t.uri),i=path.dirname(n);let u="";if(r.startsWith("@/")){let t=vscode_uri_1.URI.parse(e).fsPath;const s=path.resolve(t,"src");fs.existsSync(s)&&(t=s),u=r.replace("@",t)}else u=path.isAbsolute(r)?r:path.resolve(i,r);if(u=u.replace(/\\/g,"/"),u=normalizeRefUri(u),isNetworkPath(u))return;if(!fs.existsSync(u))return;o=u,c=s.attributeValue}else"ID"!==n&&"CLASS"!==n||("ID"===n&&(i=core_1.IndexItemType.DEF),o=s.attributeValue,u=!0);let l=[];u?l=o.split(" "):l.push(o);const g=[];let f=s.attributeValueOffset;return l.forEach((e=>{if(""===e)return void f++;if(e.includes(":")&&"REF"!==n)return;const a=t.positionAt(f),o=t.positionAt(f);o.character=o.character+e.length;const u=vscode_html_languageservice_1.Range.create(a,o),l=(0,core_1.getContextLineText)(t,u),d=core_1.targetUtils.indexGetTarget(t,u,r),h={value:e,lineText:l,kind:i,range:u,context:"TagName: "+s.tagName,describe:c,platforms:d};g.push(h),f+=e.length,f++})),g}class TagIndex{constructor(e){this.languageService=(0,vscode_html_languageservice_1.getLanguageService)(),this.isVue=!1,this.isVue=e}getNodePositionList(e){const t=this.languageService.parseHTMLDocument(e).roots.find((e=>"html"===e.tag));if(!t)return;let r=[];return accept((e=>{if(!e.attributes)return!0;let t=!1;if("base"===e.tag){const r=e.attributes.href;r&&null!==r&&(t=!0)}if("link"===e.tag){const r=e.attributes.rel,s=e.attributes.href;r&&null!==r&&s&&null!==s&&(t=!0)}if("script"===e.tag){const r=e.attributes.src;r&&null!==r&&(t=!0)}const s=e.attributes.class,n=e.attributes.id;if((s&&null!==s||n&&null!==n)&&(t=!0),t){const t={start:e.start,startTagEnd:e.startTagEnd};r.push(t)}return!0}),t),0!==r.length?r:void 0}getVueNodePositionList(e){const t=this.languageService.parseHTMLDocument(e).roots.find((e=>"template"===e.tag));if(!t)return;let r=[];return accept((e=>{const t={start:e.start,startTagEnd:e.startTagEnd};return r.push(t),!0}),t),0!==r.length?r:void 0}scannerGetIndexData(e,t,r,s){const n=r.getText(),a={uri:t,name:(0,core_1.uriToPath)(t)},i=(0,documentContext_1.getDocumentContext)(r.uri,[a]),o=r.uri;let c,u=[],l=[],g=[],f=[];e.forEach((e=>{e.startTagEnd||(e.startTagEnd=0);const a=this.languageService.createScanner(n,e.start),d=e.startTagEnd;let h=a.scan(),_={},p="",T="",v=r.getText().length;for(;h!==vscode_html_languageservice_1.TokenType.EOS&&a.getTokenOffset()<=d&&(v--,!(v<0));){switch(h){case vscode_html_languageservice_1.TokenType.StartTag:if(T=a.getTokenText(),this.isVue){const e=r.positionAt(a.getTokenOffset()),t=r.positionAt(a.getTokenOffset()+a.getTokenLength()),n=vscode_html_languageservice_1.Range.create(e,t),i=(0,core_1.getContextLineText)(r,n),c=core_1.targetUtils.indexGetTarget(r,n,s);let u={value:T,lineText:i,kind:core_1.IndexItemType.REF,range:n,describe:o,platforms:c};f.push(u)}_={};break;case vscode_html_languageservice_1.TokenType.EndTag:T="";break;case vscode_html_languageservice_1.TokenType.AttributeName:p=a.getTokenText();break;case vscode_html_languageservice_1.TokenType.AttributeValue:{const e=normalizeValue(a.getTokenText());if("base"===T&&"href"===p)c=e,c&&i&&(c=i.resolveReference(c,o));else if("link"===T){if("rel"!==p&&"href"!==p||setTagAttrs(_,p,T,e,a),_.rel&&_.href&&"stylesheet"===_.rel.attributeValue&&_.href.attributeValue){let e=parseReferenceUri(r,_.href.attributeValue,i,c);const n=createdIndexValue(t,r,s,_.href,"REF",e);n&&u.push(...n)}}else if("src"==p){setTagAttrs(_,p,T,e,a);let n=parseReferenceUri(r,e,i,c);const o=createdIndexValue(t,r,s,_[p],"REF",n);o&&u.push(...o)}else if("id"===p){setTagAttrs(_,p,T,e,a);const n=createdIndexValue(t,r,s,_[p],"ID");n&&g.push(...n)}else if("class"===p){setTagAttrs(_,p,T,e,a);const n=createdIndexValue(t,r,s,_[p],"CLASS");n&&l.push(...n)}}}h=a.scan()}}));let d=new Map;d.set("REF",u),d.set("CLASS",l),d.set("ID",g),d.set("VUE_COMPONENT_TAG",f);const h=(0,core_1.assemblyKindData)(d,t,r.uri);if(0!==h.kindMap.size)return h}createTagIndex(e,t,r){let s=this.getNodePositionList(t);if(this.isVue&&(s=this.getVueNodePositionList(t)),!s)return;return this.scannerGetIndexData(s,e,t,r)}}exports.TagIndex=TagIndex;
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.creatHtmlVueChecker=exports.DomCheckerPlugin=void 0;const core_1=require("../../core"),vscode_html_languageservice_1=require("../../packages/vscode-html-languageservice"),utils_1=require("../../utils");class DomCheckerPlugin{constructor(e,t){this.info=e,this.isHTML=t}checkExpression(e,t,r,i,s,n){var o,l;let a=null===(o=i.getSourceFile())||void 0===o?void 0:o.fileName;if(!a||!this.isHTML(a))return;let c=this.info.tsinfo.project.getScriptInfo(a);if(!c)return;let u=(0,vscode_html_languageservice_1.getLanguageService)({}),g=c.getSnapshot().getText(0,c.getSnapshot().getLength()),p=vscode_html_languageservice_1.TextDocument.create(a,"html",0,g),f=u.parseHTMLDocument(p);if(i.kind===this.info.ts.SyntaxKind.PropertyAccessExpression){if((null===(l=i.parent)||void 0===l?void 0:l.kind)===this.info.ts.SyntaxKind.CallExpression){let e=r.defaultCheckExpression(i,s,n),t=r.getSignaturesOfType(e,this.info.ts.SignatureKind.Call);return t&&t.forEach((e=>{var t;let s=e.getReturnType();if(s&&"HTMLElement"===(null===(t=s.symbol)||void 0===t?void 0:t.escapedName)||s.getProperty("getElementsByTagName")){let t=i.parent,s=t.getFullText(i.getSourceFile()),n="";if(s.indexOf(".getElementById")>0){let e=m(t.arguments);e&&e.kind==this.info.ts.SyntaxKind.StringLiteral&&(n=e.text)}else if(s.indexOf(".querySelector")){let e=m(t.arguments);if(e&&e.kind==this.info.ts.SyntaxKind.StringLiteral){let t=e.text;t&&t.startsWith("#")&&(n=t.substring(1))}}if(null==n||0==n.length)return;let o="";if(d(null==f?void 0:f.roots,(e=>{if(e.attributes&&e.attributes.id){let t=e.attributes.id;if((t.startsWith('"')&&t.startsWith('"')||t.startsWith("'")&&t.startsWith("'"))&&(t=t.substring(1,t.length-1)),t===n&&e.tag)return o=e.tag,!1}return!0})),o&&o.length>0){o=o.toLowerCase();let t={a:"Link",img:"Image",li:"LI",ul:"UList",textarea:"TextArea",p:"Paragraph",ol:"OList",iframe:"IFrame",hr:"HR",br:"BR"};if(t[o])o=t[o];else{let e=o[0].toUpperCase();o=e+o.substring(1)}let s=r.getSymbolsInScope(i,core_1.ts.SymbolFlags.Interface|core_1.ts.SymbolFlags.Class).find((e=>e.escapedName===`HTML${o}Element`));s&&(e.resolvedReturnType=r.getDeclaredTypeOfSymbol(s))}}})),e}}return;function d(e,t){if(e&&e.length>0)for(let r=0;r<e.length;r++)t(e[r])&&d(e[r].children,t)}function m(e){if(e&&e.length>0)return e[0]}}}function getVueCxt(e,t,r){let i=[];if(e){let t=e._children;if(t)return t.forEach((e=>{const t=s(e);if(t&&t.arguments&&t.arguments.length>0){const e=t.arguments[0];core_1.ts.isObjectLiteralExpression(e)&&i.push(...e.properties)}})),i}function s(e){if(core_1.ts.isVariableDeclaration(e)&&e.initializer&&core_1.ts.isNewExpression(e.initializer)&&"Vue"===e.initializer.expression.getText())return e.initializer;if(core_1.ts.isNewExpression(e))return e;let t=null;return core_1.ts.forEachChild(e,(e=>{const r=s(e);if(r)return t=r,!0})),t}}function detectVueVersion(e,t,r){let i=null;return function e(t){if(core_1.ts.isCallExpression(t)||core_1.ts.isExpressionStatement(t)||core_1.ts.isNewExpression(t)){const e=t.expression;if(core_1.ts.isIdentifier(e)&&"createApp"===e.getText()||core_1.ts.isPropertyAccessExpression(e)&&"createApp"===e.name.getText()||core_1.ts.isPropertyAccessExpression(e)&&"mount"===e.name.getText())return void(i=3);i=2}core_1.ts.forEachChild(t,e)}(e),i}function getVue3BindApp(e,t,r){let i=e,s=new Map,n=new Map,o=i._children;return o&&o.map((e=>{let t,r;if(core_1.ts.isVariableStatement(e)&&e.declarationList&&e.declarationList.declarations){let t=e.declarationList.declarations[0];n.set(t.name.getText(),t)}!function e(i){if(core_1.ts.isCallExpression(i)){const e=i.expression;if(core_1.ts.isPropertyAccessExpression(e)&&"mount"===e.name.getText()){const i=e.parent;if(core_1.ts.isCallExpression(i)&&i.arguments&&i.arguments[0]&&(t=i.arguments[0].getText().slice(1,-1)),core_1.ts.isIdentifier(e.expression)&&n.get(e.expression.getText())){const t=n.get(e.expression.getText()).initializer.arguments[0];core_1.ts.isObjectLiteralExpression(t)&&(r=t.properties)}}if(core_1.ts.isPropertyAccessExpression(e)&&"createApp"===e.name.getText()){const e=i.arguments[0];core_1.ts.isObjectLiteralExpression(e)&&(r=e.properties)}if(core_1.ts.isCallExpression(i)&&"createApp"===i.expression.getText()){const e=i.arguments[0];core_1.ts.isObjectLiteralExpression(e)&&(r=e.properties)}}t&&r&&s.set(t,r),core_1.ts.forEachChild(i,e)}(e)})),s}function getJsDoc(e,t){for(;e&&e.kind!==core_1.ts.SyntaxKind.SourceFile;){const t=core_1.ts.getJSDocTags(e);if(t)for(const e of t)if("id"===e.tagName.text)return e.comment||"";e=e.parent}return""}function getResult(e,t,r,i){let s;return function e(n){var o;const l=n.parent;if(i.ts.isSourceFile(n))return s;if("__VLS_types.InfererVueType"===n.getText()){let e=t.slice(0,-17)+"__VLS_script.ts",l=null===(o=i.languageService.getProgram())||void 0===o?void 0:o.getSourceFile(e);const a=null==l?void 0:l.getChildAt(0);if(!a)return;let c=getJsDoc(n,i.ts),u=detectVueVersion(l,i.ts,r),g=`#${c}`;const p=["data","props","methods","computed","setup"];if(c){let e;if(3===u){if(e=getVue3BindApp(a,i.ts,r).get(g),!e||!l)return;let t=(0,utils_1.getVueNodes)(p,e,i),n=(0,utils_1.getMembersAtProperty)(p,t,i,r);return s=r.createAnonymousType(void 0,n,[],[],[]),s}if(2===u){if(e=getVueCxt(a,i.ts,r),!e)return;let t=e&&e.find((e=>"el"===e.name.text)),n=i.ts.isPropertyAssignment(t)&&i.ts.isStringLiteral(t.initializer)&&t.initializer.text;if(t&&n===g){let t=(0,utils_1.getVueNodes)(p,e,i),n=(0,utils_1.getMembersAtProperty)(p,t,i,r);return s=r.createAnonymousType(void 0,n,[],[],[]),s}}}}s||e(l)}(e),s}function creatHtmlVueChecker(e){return{checkExpression(t,r,i,s,n,o){let l,a=s.getSourceFile().fileName;if(a.endsWith("html.__VLS_template.ts"))return l=getResult(s,a,i,e),l}}}exports.DomCheckerPlugin=DomCheckerPlugin,exports.creatHtmlVueChecker=creatHtmlVueChecker;
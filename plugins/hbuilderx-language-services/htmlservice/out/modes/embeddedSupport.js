"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getDocumentRegions=exports.CSS_STYLE_RULE=exports.VueLanguageModeId=void 0;const vscode_html_languageservice_1=require("../../../packages/vscode-html-languageservice");var VueLanguageModeId;!function(e){e.Style="vue-style",e.Script="vue-script",e.Template="vue-template"}(VueLanguageModeId||(exports.VueLanguageModeId=VueLanguageModeId={})),exports.CSS_STYLE_RULE="__";const whiteSpaceCharCode=[" ".charCodeAt(0),"\n".charCodeAt(0),"\t".charCodeAt(0),"\f".charCodeAt(0),"\r".charCodeAt(0)];function regionLanguage(e,t){if("vue"===e.languageId||!e.languageId&&e.uri.toLowerCase().endsWith(".vue")){if("css"===t)return"vue:css";if("scss"===t||"less"===t||"stylus"===t)return"vue:"+t;if("html"===t)return VueLanguageModeId.Template}return t}function isVueLanguage(e){return"vue"===e.languageId||!e.languageId&&e.uri.toLowerCase().endsWith(".vue")}function getDocumentRegions(e,t){let a,n=[],g=e.createScanner(t.getText()),s="",u=null,r=[],o=g.scan(),i=isVueLanguage(t),l="";for(;o!==vscode_html_languageservice_1.TokenType.EOS;){switch(o){case vscode_html_languageservice_1.TokenType.StartTag:s=g.getTokenText(),u=null,a="javascript";break;case vscode_html_languageservice_1.TokenType.Styles:let e=i&&l?l:"css";n.push({languageId:regionLanguage(t,e),start:g.getTokenOffset(),end:g.getTokenEnd()}),l="";break;case vscode_html_languageservice_1.TokenType.Script:n.push({languageId:a?regionLanguage(t,a):void 0,start:g.getTokenOffset(),end:g.getTokenEnd()});break;case vscode_html_languageservice_1.TokenType.AttributeName:u=g.getTokenText();break;case vscode_html_languageservice_1.TokenType.AttributeValue:if("lang"===u&&"script"===s.toLowerCase()){let e=g.getTokenText();"'"!==e[0]&&'"'!==e[0]||(e=e.substring(1,e.length-1)),a="javascript"}else if("src"===u&&"script"===s.toLowerCase()){let e=g.getTokenText();"'"!==e[0]&&'"'!==e[0]||(e=e.substring(1,e.length-1)),r.push(e)}else if("type"===u&&"script"===s.toLowerCase())a=/["'](module|(text|application)\/(java|ecma)script|text\/babel)["']/.test(g.getTokenText())||/["']text\/typescript["']/.test(g.getTokenText())?"javascript":void 0;else if("lang"===u&&"style"===s.toLowerCase())l=g.getTokenText(),"'"!==l[0]&&'"'!==l[0]||(l=l.substring(1,l.length-1));else{let e=getAttributeLanguage(u);if(e){let a=g.getTokenOffset(),s=g.getTokenEnd(),u=t.getText()[a];"'"!==u&&'"'!==u||(a++,s--),n.push({languageId:regionLanguage(t,e),start:a,end:s,attributeValue:!0})}}u=null;case vscode_html_languageservice_1.TokenType.Content:}o=g.scan()}return{getLanguageRanges:e=>getLanguageRanges(t,n,e),getEmbeddedDocument:(e,a)=>getEmbeddedDocument(t,n,e,a),getLanguageAtPosition:e=>getLanguageAtPosition(t,n,e),getLanguagesInDocument:()=>getLanguagesInDocument(t,n),getImportedScripts:()=>r,get scriptLanguageId(){return a},get allRegions(){return n}}}function getLanguageRanges(e,t,a){let n=[],g=a?a.start:vscode_html_languageservice_1.Position.create(0,0),s=a?e.offsetAt(a.start):0,u=a?e.offsetAt(a.end):e.getText().length;for(let a of t)if(a.end>s&&a.start<u){let t=Math.max(a.start,s),r=e.positionAt(t);s<a.start&&n.push({start:g,end:r,languageId:regionLanguage(e,"html")});let o=Math.min(a.end,u),i=e.positionAt(o);o>a.start&&n.push({start:r,end:i,languageId:a.languageId,attributeValue:a.attributeValue}),s=o,g=i}if(s<u){let t=a?a.end:e.positionAt(u);n.push({start:g,end:t,languageId:regionLanguage(e,"html")})}return n}function getLanguagesInDocument(e,t){let a=[];for(let e of t)if(e.languageId&&-1===a.indexOf(e.languageId)&&(a.push(e.languageId),3===a.length))return a;return a.push(regionLanguage(e,"html")),a}function getLanguageAtPosition(e,t,a){let n=e.offsetAt(a);for(let e of t){if(!(e.start<=n))break;if(n<=e.end)return e.languageId}return regionLanguage(e,"html")}function getEmbeddedDocument(e,t,a,n){let g=0,s=e.getText(),u="",r="";for(let e of t)e.languageId!==a||n&&e.attributeValue||(u=substituteWithWhitespace(u,g,e.start,s,r,getPrefix(e)),u+=s.substring(e.start,e.end),g=e.end,r=getSuffix(e));return u=substituteWithWhitespace(u,g,s.length,s,r,""),vscode_html_languageservice_1.TextDocument.create(e.uri,a,e.version,u)}function getPrefix(e){if(e.attributeValue)switch(e.languageId){case"css":case"vue:css":return exports.CSS_STYLE_RULE+"{"}return""}function getSuffix(e){if(e.attributeValue)switch(e.languageId){case"css":case"vue:css":return"}";case"javascript":return";"}return""}function substituteWithWhitespace(e,t,a,n,g,s){let u=0;e+=g;for(let s=t+g.length;s<a;s++){let t=n[s];"\n"===t||"\r"===t?(u=0,e+=t):u++}return e=append(e," ",u-s.length),e+=s}function append(e,t,a){for(;a>0;)1&a&&(e+=t),a>>=1,t+=t;return e}function getAttributeLanguage(e){let t=e.match(/^(style)$|^(on\w+)$/i);return t?t[1]?"css":"javascript":null}exports.getDocumentRegions=getDocumentRegions;
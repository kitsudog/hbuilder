"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.IdClassDefinition=void 0;const path=__importStar(require("path")),core_1=require("../../../../core"),specialStringPlugin_1=require("../../../../specialStringPlugin"),plugins_1=require("../../plugins"),serviceTypes_1=require("../../serviceTypes");class IdClassDefinition{constructor(e,t){this.ls=e,this.allInfo=t,this.cssLanguageServer=(0,serviceTypes_1.getCSSLanguageService)()}async doExtraDefinition(e,t,i,n){let r=this.ls.getLocationInfoAtPosition(t,i,n);if(!r)return e;if(!r.activeAttribute)return e;if(e||(e=[]),r.kind===plugins_1.LocationInfoKind.AttributeValue)e=await this.getDefinitionFromId(e,t,i,r),e=await this.getDefinitionFromClass(e,t,i,r),e=await this.getDefinitionFromGlobal(e,t,i,r);return e}async getDefinitionFromId(e,t,i,n){if("id"!==n.activeAttribute)return e;const r=t.offsetAt(i),o={range:(0,core_1.getContextData)(t,r,void 0).contextRange,kind:specialStringPlugin_1.StringLocationInfoKind.IN_HTML_LIKE,ast:void 0,project:this.allInfo.project};let a=new Map;const s=specialStringPlugin_1.StringServicesContainer.create(a),c=await(0,specialStringPlugin_1.specialStringDoDefinition)(["HBuilderX.IDString"],t,i,o,s,[]);return e||(e=[]),e.unshift(...c),e}async getDefinitionFromClass(e,t,i,n){if("class"!==n.activeAttribute)return e;const r=t.offsetAt(i),o={range:(0,core_1.getContextData)(t,r,void 0).contextRange,kind:specialStringPlugin_1.StringLocationInfoKind.IN_HTML_LIKE,ast:void 0,project:this.allInfo.project};let a=new Map;const s=specialStringPlugin_1.StringServicesContainer.create(a),c=await(0,specialStringPlugin_1.specialStringDoDefinition)(["HBuilderX.ClassString"],t,i,o,s,[]);return e||(e=[]),e.unshift(...c),e}async getAllRefData(e){return await(0,core_1.getAllKindData)(e,"REF",!1)}createRefFileList(e,t,i){let n=(0,core_1.getReferenceList)(t),r=(0,core_1.getReferenceList)(i);n||(n=[]),r||(r=[]);const o=n.concat(r);return o.push(e),o}async getIndexData(e,t){let i;if(i=await e.indexPipeHandler.getIndexDataRequest(t,!1),i&&0!==i.length)return i.forEach((e=>{e=(0,core_1.tagNormalizedData)(e)})),i}filterAndGeneration(e,t,i){const n=[];e.forEach((e=>{const i=(0,core_1.lspFilterIndexData)(e,t);n.push(i)}));const r=[];return n.forEach((e=>{const t=(0,core_1.creatorExtLocationLinksFromIndexData)(e,i);r.unshift(...t)})),r}async getGlobalData(e,t,i){const n=await this.getIndexData(e,t);if(!n)return;const r={options:{text:i.context,kind:core_1.IndexItemType.DEF,needRange:!0},filter:function(e,t){let i=!1,n=!1,r=!1;void 0!==t.options.text&&t.options.text===e.value&&(i=!0),void 0!==t.options.kind&&t.options.kind===e.kind&&(n=!0),t.options.needRange&&e.range&&(r=!0);return!(i&&r&&n)}};return this.filterAndGeneration(n,r,i.contextRange)}async getDefinitionFromGlobal(e,t,i,n){if("vue"!==t.languageId&&"nvue"!==t.languageId)return e;if("id"!==n.activeAttribute&&"class"!==n.activeAttribute)return e;let r="CLASS";"id"===n.activeAttribute&&(r="ID");const o=this.allInfo.project,a=(0,core_1.noTsToNormalizedUri)(o.fsPath);if(!a)return e;const s=t.offsetAt(i),c=(0,core_1.getContextData)(t,s," '\""),l=await this.getAllRefData(o);let u;if(u=(0,core_1.isUniAppXProject)(o)?(0,core_1.noTsToNormalizedUri)(path.join(o.fsPath,"App.uvue")):(0,core_1.noTsToNormalizedUri)(path.join(o.fsPath,"App.vue")),!u)return e;const f=(0,core_1.iterateGetReference)(l,[u],new Map),g=(0,core_1.iterateGetBackReference)(l,[u],new Map),d=this.createRefFileList(u,f,g),p={projectUri:a,kind:r},_=(0,core_1.getIndexDataOptionsFromList)(d,p),h=await this.getGlobalData(o,_,c),D=(0,core_1.noTsToNormalizedUri)(path.join(o.fsPath,"uni.scss"));if(!D)return e;const v=(0,core_1.iterateGetReference)(l,[D],new Map),I=(0,core_1.iterateGetBackReference)(l,[D],new Map),S=this.createRefFileList(D,v,I),x=(0,core_1.getIndexDataOptionsFromList)(S,p),b=await this.getGlobalData(o,x,c);if(e||(e=[]),h){const t=(0,core_1.extLocationToOld)(h);e.push(...t)}if(b){const t=(0,core_1.extLocationToOld)(b);e.push(...t)}return e}}exports.IdClassDefinition=IdClassDefinition;
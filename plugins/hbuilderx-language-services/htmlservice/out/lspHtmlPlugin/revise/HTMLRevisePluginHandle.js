"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TsHtmlExtraCompletionHandle=void 0;const core_1=require("../../../../core"),vscode_html_languageservice_1=require("../../../../packages/vscode-html-languageservice"),plugins_1=require("../../plugins"),vueModifierData_1=require("./vueModifierData"),selfClosingTags=["br","hr","img","link","base","area","input","source","meta"],VueEventPrefix="[event]";var VueDirectiveType;function getVueBindOrOnDirective(e){return e?e.startsWith("v-on:")?"v-on:":e.startsWith("@")?"@":e.startsWith("v-bind:")?"v-bind:":e.startsWith(":")?":":"":""}function vueDirectiveType(e){return"v-on"==e||"@"==e?VueDirectiveType.Event:"v-bind"==e||":"==e?VueDirectiveType.Attribute:"v-pre"==e||"v-cloak"==e||"v-once"==e||"v-else"==e?VueDirectiveType.Empty:VueDirectiveType.String}function checkVueModifierDirective(e){return e.startsWith("v-on:")?"v-on:":e.startsWith("@")?"@":e.startsWith("v-bind:")?"v-bind":e.startsWith(":")?":":e.startsWith("v-model")?"v-model":""}function normalizeMarkupContent(e){if(e)return"string"==typeof e?{kind:"markdown",value:e}:{kind:"markdown",value:e.value}}function vueModifierHandle(e,t,i){const n=(0,vueModifierData_1.getModifierProvider)();let a=[];if(!t.activeAttribute)return e;let o=checkVueModifierDirective(t.activeAttribute);if(""===o)return e;let r=t.activeAttribute.split("."),s=r.slice(0,1),l=r.slice(0,-1);if(t.activeAttribute===s[0])return e;let d=s[0].substring(o.length);if("@"===o||"v-on:"===o){const e=["keydown","keypress","keyup"],t=["click","dblclick","mouseup","mousedown"];a.push(...n.eventModifiers),e.includes(d)?(a.push(...n.keyModifiers),a.push(...n.systemModifiers)):t.includes(d)&&(a.push(...n.mouseModifiers),a.push(...n.systemModifiers))}else":"===o||"v-bind"===o?a.push(...n.propsModifiers):"v-model"===o&&(a.push(...n.propsModifiers),a.push(...n.vModelModifiers));let c=l.join("."),u=i.offsetAt(t.activeRange.start)+c.length+1,v=i.positionAt(u),m=t.activeRange.end,p=vscode_html_languageservice_1.Range.create(v,m);return e.items=[],a.forEach((t=>{e.items.push({label:t.label,kind:vscode_html_languageservice_1.CompletionItemKind.Method,textEdit:vscode_html_languageservice_1.TextEdit.replace(p,t.label),insertTextFormat:vscode_html_languageservice_1.InsertTextFormat.PlainText,documentation:normalizeMarkupContent(t.documentation),data:{hxKind:core_1.HxIconKind.ATTRIBUTE}})})),e}!function(e){e[e.Empty=0]="Empty",e[e.String=1]="String",e[e.Event=2]="Event",e[e.Attribute=3]="Attribute"}(VueDirectiveType||(VueDirectiveType={}));class TsHtmlExtraCompletionHandle{constructor(e){this.ls=e}doExtraCompletion(e,t,i,n){let a=this.ls.getLocationInfoAtPosition(t,i,n);if(!a)return e;let o=a;switch(e.items.forEach((e=>{e=this.initData(e)})),o.kind){case plugins_1.LocationInfoKind.StartTagOpen:case plugins_1.LocationInfoKind.StartTag:case plugins_1.LocationInfoKind.EndTag:e.items.forEach((e=>{e=this.addEndTag(e,t,i),e=this.addHxKind(e,o.kind)})),e=this.deleteEndTagCompletions(e);break;case plugins_1.LocationInfoKind.AttributeName:e.items.forEach((e=>{e=this.addHxKind(e,o.kind),e=this.addCommand(e,a),e=this.correctionData(e,a)}))}return e}initData(e){let t={data:e.data};return e.data=t,e}addEndTag(e,t,i){const n=t.offsetAt(i);return(0,core_1.getContextData)(t,n,' \t\n\r":{[()]},*<+').context.includes(">")||(selfClosingTags.includes(e.label)?e.textEdit&&(e.insertTextFormat=vscode_html_languageservice_1.InsertTextFormat.Snippet,e.textEdit.newText=e.label+" $0/>"):e.kind===vscode_html_languageservice_1.CompletionItemKind.Property&&e.textEdit&&(e.insertTextFormat=vscode_html_languageservice_1.InsertTextFormat.Snippet,e.textEdit.newText=e.label+"$0></"+e.label+">")),e}addHxKind(e,t){let i=core_1.HxIconKind.ATTRIBUTE;switch(t){case plugins_1.LocationInfoKind.StartTagOpen:case plugins_1.LocationInfoKind.StartTag:case plugins_1.LocationInfoKind.EndTag:i=core_1.HxIconKind.ELEMENT;break;case plugins_1.LocationInfoKind.AttributeName:(e.label.startsWith("on")||e.kind===vscode_html_languageservice_1.CompletionItemKind.Function)&&(i=core_1.HxIconKind.EVENT)}let n=e.data;return n.hxKind=i,e.data=n,e}addCommand(e,t){if(e.command)return e;if(t.kind===plugins_1.LocationInfoKind.AttributeName)e.command=core_1.retriggerCommand,"script"===t.activeTag&&"defer"===e.label&&(e.command=void 0),"script"===t.activeTag&&"setup"===e.label&&(e.command=void 0),"style"===t.activeTag&&"scoped"===e.label&&(e.command=void 0);return e}correctionData(e,t){if(t.kind===plugins_1.LocationInfoKind.AttributeName)"style"===t.activeTag&&"scoped"===e.label&&e.textEdit&&(e.textEdit.newText=e.label);return e}deleteEndTagCompletions(e){return e.items=e.items.filter((e=>!e.label.includes("/"))),e}htmlVueComplete(e,t,i,n,a){if("html"===t.languageId){let a=this.ls.getLocationInfoAtPosition(t,i,n);if(!a)return e;let o=getVueBindOrOnDirective(a.activeAttribute),r={isIncomplete:e.isIncomplete,items:[]};return e.items.forEach((e=>{var t,i,n,a;if(e.label&&((null===(t=e.data)||void 0===t?void 0:t.hxKind)!==core_1.HxIconKind.EVENT||0!==o.length||!(null===(i=e.data)||void 0===i?void 0:i.source))){if(e.label.startsWith("[event]")&&(e.data||(e.data={}),e.data.hxKind=core_1.HxIconKind.EVENT,e.label=e.label.slice("[event]".length),e.textEdit)){let t=e.textEdit.newText.startsWith("[event]")?e.textEdit.newText.slice("[event]".length):e.textEdit.newText;e.textEdit.newText=t}if(e.label.startsWith("v-")){let t=vueDirectiveType(e.label);t!=VueDirectiveType.Event&&t!=VueDirectiveType.Attribute||e.textEdit&&(e.textEdit.newText=e.label+":"),t!=VueDirectiveType.Empty&&(e.command={title:"Suggest",command:"editor.action.triggerSuggest"})}else if(o.length>0&&e.textEdit)if("@"===o||"v-on:"===o){if((null===(n=e.data)||void 0===n?void 0:n.hxKind)===core_1.HxIconKind.EVENT){if(e.label.startsWith("on")&&(e.label=e.label.slice(2),e.textEdit)){let t=e.textEdit.newText.startsWith("on")?e.textEdit.newText.slice(2):e.textEdit.newText;e.textEdit.newText=t}e.label=o+e.label,e.textEdit.newText=o+e.textEdit.newText}}else(null===(a=e.data)||void 0===a?void 0:a.hxKind)!==core_1.HxIconKind.EVENT&&(e.label=o+e.label,e.textEdit.newText=o+e.textEdit.newText);r.items.push(e)}})),r=vueModifierHandle(e,a,t),r}return e}}exports.TsHtmlExtraCompletionHandle=TsHtmlExtraCompletionHandle;
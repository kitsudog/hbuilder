"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ReviseCompletion=void 0;const core_1=require("../../../../core"),vscode_html_languageservice_1=require("../../../../packages/vscode-html-languageservice"),plugins_1=require("../../plugins"),selfClosingTags=["br","hr","img","link","base","area","input","source","meta"];class ReviseCompletion{constructor(e){this._htmlLanguageServer=e}isNeedEndTag(e,t,n){const i=e.kind,a=new Map;if(i===plugins_1.LocationInfoKind.StartTagOpen)a.set(vscode_html_languageservice_1.ScannerState.AfterOpeningStartTag,[vscode_html_languageservice_1.TokenType.StartTagClose,vscode_html_languageservice_1.TokenType.StartTag]);else if(i===plugins_1.LocationInfoKind.StartTag){const i=t.offsetAt(e.activeRange.end);if(n<i)return!1;a.set(vscode_html_languageservice_1.ScannerState.WithinTag,[vscode_html_languageservice_1.TokenType.StartTagClose,vscode_html_languageservice_1.TokenType.AttributeName])}const o=t.getText();let s=!0;return a.forEach(((e,t)=>{s&&e.forEach((e=>{if(!s)return;const i=this._htmlLanguageServer.isFollowedBy(o,n,t,e);s=!i}))})),s}doExtraCompletion(e,t,n,i){const a=this._htmlLanguageServer.getLocationInfoAtPosition(t,n,i);if(!a)return e;const o=a;e.items.forEach((e=>{e=this.initData(e)}));const s=t.offsetAt(n);switch(o.kind){case plugins_1.LocationInfoKind.StartTagOpen:case plugins_1.LocationInfoKind.StartTag:case plugins_1.LocationInfoKind.EndTag:const n=this.isNeedEndTag(o,t,s);e.items.forEach((e=>{e=this.addEndTag(e,o.kind,n),e=this.addHxKind(e,o.kind)}));break;case plugins_1.LocationInfoKind.AttributeName:e.items.forEach((e=>{e=this.addHxKind(e,o.kind),e=this.correctionData(e,a)}))}return e}initData(e){const t={data:e.data};return e.data=t,e}addEndTag(e,t,n){return e.label.startsWith("/")||t===plugins_1.LocationInfoKind.EndTag?e:n?(selfClosingTags.includes(e.label)?e.textEdit&&(e.insertTextFormat=vscode_html_languageservice_1.InsertTextFormat.Snippet,e.textEdit.newText=e.label+" $0/>"):e.kind===vscode_html_languageservice_1.CompletionItemKind.Property&&e.textEdit&&(e.insertTextFormat=vscode_html_languageservice_1.InsertTextFormat.Snippet,e.textEdit.newText=e.label+"$0></"+e.label+">"),e):e}addHxKind(e,t){let n=core_1.HxIconKind.ATTRIBUTE;switch(t){case plugins_1.LocationInfoKind.StartTagOpen:case plugins_1.LocationInfoKind.StartTag:case plugins_1.LocationInfoKind.EndTag:n=core_1.HxIconKind.ELEMENT;break;case plugins_1.LocationInfoKind.AttributeName:(e.label.startsWith("on")||e.kind===vscode_html_languageservice_1.CompletionItemKind.Function)&&(n=core_1.HxIconKind.EVENT)}const i=e.data;return i.hxKind=n,e.data=i,e}correctionData(e,t){if(t.kind===plugins_1.LocationInfoKind.AttributeName)"style"===t.activeTag&&"scoped"===e.label&&e.textEdit&&(e.textEdit.newText=e.label);return e}filterUniappxCompletion(e,t,n){if(!(0,core_1.isUniAppXProject)(t))return e;let i=e.items.filter((e=>!e.fromDataProvider||!!e.uniPlatform&&(0,core_1.uniPlatformCompletionSupport)(e.uniPlatform,n)));return e.items=i,e}}exports.ReviseCompletion=ReviseCompletion;
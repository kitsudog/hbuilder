"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AdditionalReferences=void 0;const core_1=require("../../../../core"),plugins_1=require("../../plugins");class AdditionalReferences{constructor(e,t){this.ls=e,this.allInfo=t}async getAllRefData(e){return await(0,core_1.getAllKindData)(e,"REF",!0)}createRefFileList(e,t,n){let r=(0,core_1.getReferenceList)(t),i=(0,core_1.getReferenceList)(n);r||(r=[]),i||(i=[]);const o=r.concat(i);return o.push(e),o}async getIndexData(e,t){let n;if(n=await e.indexPipeHandler.getIndexDataRequest(t,!0),n&&0!==n.length)return n.forEach((e=>{e=(0,core_1.tagNormalizedData)(e)})),n}async getReferencesData(e,t,n,r,i){const o=this.allInfo.project,a=(0,core_1.noTsToNormalizedUri)(o.fsPath),s=(0,core_1.noTsToNormalizedUri)(t.uri);if(!s)return e;if(!a)return e;const c=await this.getAllRefData(o),f=(0,core_1.iterateGetReference)(c,[s],new Map),l=(0,core_1.iterateGetBackReference)(c,[s],new Map),d=this.createRefFileList(s,f,l),u={projectUri:a,kind:i},g=(0,core_1.getIndexDataOptionsFromList)(d,u),p=await this.getIndexData(o,g);if(!p)return e;const R=t.offsetAt(n);let h="\t\n\r =>";"component"===r&&(h="<>");let x=(0,core_1.getContextData)(t,R,h);const _={options:{text:x.context,needRange:!0},filter:function(e,t){let n=!1,i=!1;"directive"===r&&void 0!==t.options.text&&t.options.text===`v-${e.value}`&&(n=!0),void 0!==t.options.text&&t.options.text===e.value&&(n=!0),t.options.needRange&&e.range&&(i=!0);return!(n&&i)}},D=this.filterAndGeneration(p,_,x.contextRange);return e||(e=[]),e.unshift(...D),e}filterAndGeneration(e,t,n){const r=[];e.forEach((e=>{const n=(0,core_1.lspFilterIndexData)(e,t);r.push(n)}));const i=[];return r.forEach((e=>{const t=(0,core_1.creatorExtLocationLinksFromIndexData)(e,n);i.unshift(...t)})),i}async getDirectiveReferences(e,t,n,r){return this.getReferencesData(e,t,n,"directive","VUE_DIRECTIVE")}async getComponentReferences(e,t,n,r){return this.getReferencesData(e,t,n,"component","VUE_COMPONENT")}async doExtraReferencesAsync(e,t,n,r){let i=this.ls.getLocationInfoAtPosition(t,n,r);if(i){switch(i.kind){case plugins_1.LocationInfoKind.AttributeName:e=await this.getDirectiveReferences(e,t,n,i);break;case plugins_1.LocationInfoKind.StartTag:e=await this.getComponentReferences(e,t,n,i)}return e}}}exports.AdditionalReferences=AdditionalReferences;
"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,a){void 0===a&&(a=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,a,r)}:function(e,t,n,a){void 0===a&&(a=n),e[a]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.createScanner=void 0;const l10n=__importStar(require("@vscode/l10n")),htmlLanguageTypes_1=require("../htmlLanguageTypes");class MultiLineStream{constructor(e,t){this.source=e,this.len=e.length,this.position=t}eos(){return this.len<=this.position}getSource(){return this.source}pos(){return this.position}goBackTo(e){this.position=e}goBack(e){this.position-=e}advance(e){this.position+=e}goToEnd(){this.position=this.source.length}nextChar(){return this.source.charCodeAt(this.position++)||0}peekChar(e=0){return this.source.charCodeAt(this.position+e)||0}advanceIfChar(e){return e===this.source.charCodeAt(this.position)&&(this.position++,!0)}advanceIfChars(e){let t;if(this.position+e.length>this.source.length)return!1;for(t=0;t<e.length;t++)if(this.source.charCodeAt(this.position+t)!==e[t])return!1;return this.advance(t),!0}advanceIfRegExp(e){const t=this.source.substr(this.position).match(e);return t?(this.position=this.position+t.index+t[0].length,t[0]):""}advanceUntilRegExp(e){const t=this.source.substr(this.position).match(e);return t?(this.position=this.position+t.index,t[0]):(this.goToEnd(),"")}advanceUntilChar(e){for(;this.position<this.source.length;){if(this.source.charCodeAt(this.position)===e)return!0;this.advance(1)}return!1}advanceUntilChars(e){for(;this.position+e.length<=this.source.length;){let t=0;for(;t<e.length&&this.source.charCodeAt(this.position+t)===e[t];t++);if(t===e.length)return!0;this.advance(1)}return this.goToEnd(),!1}skipWhitespace(){return this.advanceWhileChar((e=>e===_WSP||e===_TAB||e===_NWL||e===_LFD||e===_CAR))>0}advanceWhileChar(e){const t=this.position;for(;this.position<this.len&&e(this.source.charCodeAt(this.position));)this.position++;return this.position-t}}const _BNG="!".charCodeAt(0),_MIN="-".charCodeAt(0),_LAN="<".charCodeAt(0),_RAN=">".charCodeAt(0),_FSL="/".charCodeAt(0),_EQS="=".charCodeAt(0),_DQO='"'.charCodeAt(0),_SQO="'".charCodeAt(0),_NWL="\n".charCodeAt(0),_CAR="\r".charCodeAt(0),_LFD="\f".charCodeAt(0),_WSP=" ".charCodeAt(0),_TAB="\t".charCodeAt(0),htmlScriptContents={"text/x-handlebars-template":!0,"text/html":!0};function createScanner(e,t=0,n=htmlLanguageTypes_1.ScannerState.WithinContent,a=!1){const r=new MultiLineStream(e,t);let s,i,o,h,g,p=n,c=0,T=htmlLanguageTypes_1.TokenType.Unknown;function u(){return r.advanceIfRegExp(/^[_:\w][_:\w-.\d]*/).toLowerCase()}function l(e,t,n){return T=t,c=e,s=n,t}function _(){const e=r.pos();if(r.eos())return l(e,htmlLanguageTypes_1.TokenType.EOS);let t;switch(p){case htmlLanguageTypes_1.ScannerState.WithinComment:return r.advanceIfChars([_MIN,_MIN,_RAN])?(p=htmlLanguageTypes_1.ScannerState.WithinContent,l(e,htmlLanguageTypes_1.TokenType.EndCommentTag)):(r.advanceUntilChars([_MIN,_MIN,_RAN]),l(e,htmlLanguageTypes_1.TokenType.Comment));case htmlLanguageTypes_1.ScannerState.WithinDoctype:return r.advanceIfChar(_RAN)?(p=htmlLanguageTypes_1.ScannerState.WithinContent,l(e,htmlLanguageTypes_1.TokenType.EndDoctypeTag)):(r.advanceUntilChar(_RAN),l(e,htmlLanguageTypes_1.TokenType.Doctype));case htmlLanguageTypes_1.ScannerState.WithinContent:if(r.advanceIfChar(_LAN)){if(!r.eos()&&r.peekChar()===_BNG){if(r.advanceIfChars([_BNG,_MIN,_MIN]))return p=htmlLanguageTypes_1.ScannerState.WithinComment,l(e,htmlLanguageTypes_1.TokenType.StartCommentTag);if(r.advanceIfRegExp(/^!doctype/i))return p=htmlLanguageTypes_1.ScannerState.WithinDoctype,l(e,htmlLanguageTypes_1.TokenType.StartDoctypeTag)}return r.advanceIfChar(_FSL)?(p=htmlLanguageTypes_1.ScannerState.AfterOpeningEndTag,l(e,htmlLanguageTypes_1.TokenType.EndTagOpen)):(p=htmlLanguageTypes_1.ScannerState.AfterOpeningStartTag,l(e,htmlLanguageTypes_1.TokenType.StartTagOpen))}return r.advanceUntilChar(_LAN),l(e,htmlLanguageTypes_1.TokenType.Content);case htmlLanguageTypes_1.ScannerState.AfterOpeningEndTag:return u().length>0?(p=htmlLanguageTypes_1.ScannerState.WithinEndTag,l(e,htmlLanguageTypes_1.TokenType.EndTag)):r.skipWhitespace()?l(e,htmlLanguageTypes_1.TokenType.Whitespace,l10n.t("Tag name must directly follow the open bracket.")):(p=htmlLanguageTypes_1.ScannerState.WithinEndTag,r.advanceUntilChar(_RAN),e<r.pos()?l(e,htmlLanguageTypes_1.TokenType.Unknown,l10n.t("End tag name expected.")):_());case htmlLanguageTypes_1.ScannerState.WithinEndTag:if(r.skipWhitespace())return l(e,htmlLanguageTypes_1.TokenType.Whitespace);if(r.advanceIfChar(_RAN))return p=htmlLanguageTypes_1.ScannerState.WithinContent,l(e,htmlLanguageTypes_1.TokenType.EndTagClose);if(a&&r.peekChar()===_LAN)return p=htmlLanguageTypes_1.ScannerState.WithinContent,l(e,htmlLanguageTypes_1.TokenType.EndTagClose,l10n.t("Closing bracket missing."));t=l10n.t("Closing bracket expected.");break;case htmlLanguageTypes_1.ScannerState.AfterOpeningStartTag:return o=u(),g=void 0,h=void 0,o.length>0?(i=!1,p=htmlLanguageTypes_1.ScannerState.WithinTag,l(e,htmlLanguageTypes_1.TokenType.StartTag)):r.skipWhitespace()?l(e,htmlLanguageTypes_1.TokenType.Whitespace,l10n.t("Tag name must directly follow the open bracket.")):(p=htmlLanguageTypes_1.ScannerState.WithinTag,r.advanceUntilChar(_RAN),e<r.pos()?l(e,htmlLanguageTypes_1.TokenType.Unknown,l10n.t("Start tag name expected.")):_());case htmlLanguageTypes_1.ScannerState.WithinTag:return r.skipWhitespace()?(i=!0,l(e,htmlLanguageTypes_1.TokenType.Whitespace)):i&&(h=r.advanceIfRegExp(/^[^\s"'></=\x00-\x0F\x7F\x80-\x9F]*/).toLowerCase(),h.length>0)?(p=htmlLanguageTypes_1.ScannerState.AfterAttributeName,i=!1,l(e,htmlLanguageTypes_1.TokenType.AttributeName)):r.advanceIfChars([_FSL,_RAN])?(p=htmlLanguageTypes_1.ScannerState.WithinContent,l(e,htmlLanguageTypes_1.TokenType.StartTagSelfClose)):r.advanceIfChar(_RAN)?(p="script"===o?g&&htmlScriptContents[g]?htmlLanguageTypes_1.ScannerState.WithinContent:htmlLanguageTypes_1.ScannerState.WithinScriptContent:"style"===o?htmlLanguageTypes_1.ScannerState.WithinStyleContent:htmlLanguageTypes_1.ScannerState.WithinContent,l(e,htmlLanguageTypes_1.TokenType.StartTagClose)):a&&r.peekChar()===_LAN?(p=htmlLanguageTypes_1.ScannerState.WithinContent,l(e,htmlLanguageTypes_1.TokenType.StartTagClose,l10n.t("Closing bracket missing."))):(r.advance(1),l(e,htmlLanguageTypes_1.TokenType.Unknown,l10n.t("Unexpected character in tag.")));case htmlLanguageTypes_1.ScannerState.AfterAttributeName:return r.skipWhitespace()?(i=!0,l(e,htmlLanguageTypes_1.TokenType.Whitespace)):r.advanceIfChar(_EQS)?(p=htmlLanguageTypes_1.ScannerState.BeforeAttributeValue,l(e,htmlLanguageTypes_1.TokenType.DelimiterAssign)):(p=htmlLanguageTypes_1.ScannerState.WithinTag,_());case htmlLanguageTypes_1.ScannerState.BeforeAttributeValue:if(r.skipWhitespace())return l(e,htmlLanguageTypes_1.TokenType.Whitespace);let n=r.advanceIfRegExp(/^[^\s"'`=<>]+/);if(n.length>0&&(r.peekChar()===_RAN&&r.peekChar(-1)===_FSL&&(r.goBack(1),n=n.substring(0,n.length-1)),"type"===h&&(g=n),n.length>0))return p=htmlLanguageTypes_1.ScannerState.WithinTag,i=!1,l(e,htmlLanguageTypes_1.TokenType.AttributeValue);const s=r.peekChar();return s===_SQO||s===_DQO?(r.advance(1),r.advanceUntilChar(s)&&r.advance(1),"type"===h&&(g=r.getSource().substring(e+1,r.pos()-1)),p=htmlLanguageTypes_1.ScannerState.WithinTag,i=!1,l(e,htmlLanguageTypes_1.TokenType.AttributeValue)):(p=htmlLanguageTypes_1.ScannerState.WithinTag,i=!1,_());case htmlLanguageTypes_1.ScannerState.WithinScriptContent:let c=1;for(;!r.eos();){const t=r.advanceIfRegExp(/<!--|-->|<\/?script\s*\/?>?/i);if(0===t.length)return r.goToEnd(),l(e,htmlLanguageTypes_1.TokenType.Script);if("\x3c!--"===t)1===c&&(c=2);else if("--\x3e"===t)c=1;else if("/"!==t[1])2===c&&(c=3);else{if(3!==c){r.goBack(t.length);break}c=2}}return p=htmlLanguageTypes_1.ScannerState.WithinContent,e<r.pos()?l(e,htmlLanguageTypes_1.TokenType.Script):_();case htmlLanguageTypes_1.ScannerState.WithinStyleContent:return r.advanceUntilRegExp(/<\/style/i),p=htmlLanguageTypes_1.ScannerState.WithinContent,e<r.pos()?l(e,htmlLanguageTypes_1.TokenType.Styles):_()}return r.advance(1),p=htmlLanguageTypes_1.ScannerState.WithinContent,l(e,htmlLanguageTypes_1.TokenType.Unknown,t)}return{scan:function(){const e=r.pos(),t=p,n=_();return n===htmlLanguageTypes_1.TokenType.EOS||e!==r.pos()||a&&(n===htmlLanguageTypes_1.TokenType.StartTagClose||n===htmlLanguageTypes_1.TokenType.EndTagClose)?n:(console.warn("Scanner.scan has not advanced at offset "+e+", state before: "+t+" after: "+p),r.advance(1),l(e,htmlLanguageTypes_1.TokenType.Unknown))},getTokenType:()=>T,getTokenOffset:()=>c,getTokenLength:()=>r.pos()-c,getTokenEnd:()=>r.pos(),getTokenText:()=>r.getSource().substring(c,r.pos()),getScannerState:()=>p,getTokenError:()=>s}}exports.createScanner=createScanner;
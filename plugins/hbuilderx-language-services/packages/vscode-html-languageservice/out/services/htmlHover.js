"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(e,n);i&&!("get"in i?!e.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return e[n]}}),Object.defineProperty(t,r,i)}:function(t,e,n,r){void 0===r&&(r=n),t[r]=e[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)"default"!==n&&Object.prototype.hasOwnProperty.call(t,n)&&__createBinding(e,t,n);return __setModuleDefault(e,t),e};Object.defineProperty(exports,"__esModule",{value:!0}),exports.HTMLHover=void 0;const htmlScanner_1=require("../parser/htmlScanner"),htmlLanguageTypes_1=require("../htmlLanguageTypes"),object_1=require("../utils/object"),dataProvider_1=require("../languageFacts/dataProvider"),htmlEntities_1=require("../parser/htmlEntities"),strings_1=require("../utils/strings"),l10n=__importStar(require("@vscode/l10n"));class HTMLHover{constructor(t,e){this.lsOptions=t,this.dataManager=e}doHover(t,e,n,r){const i=this.convertContents.bind(this),o=this.doesSupportMarkdown(),a=t.offsetAt(e),s=n.findNodeAt(a),l=t.getText();if(!s||!s.tag)return null;const u=this.dataManager.getDataProviders().filter((e=>e.isApplicable(t.languageId)));function c(t,e,n){for(const n of u){let a=null;if(n.provideTags().forEach((n=>{if(n.name.toLowerCase()===t.toLowerCase()){let t=(0,dataProvider_1.generateDocumentation)(n,r,o);t||(t={kind:o?"markdown":"plaintext",value:""}),a={contents:t,range:e}}})),a)return a.contents=i(a.contents),a}return null}function g(e,n){const r=(0,htmlScanner_1.createScanner)(t.getText(),n);let i=r.scan();for(;i!==htmlLanguageTypes_1.TokenType.EOS&&(r.getTokenEnd()<a||r.getTokenEnd()===a&&i!==e);)i=r.scan();return i===e&&a<=r.getTokenEnd()?{start:t.positionAt(r.getTokenOffset()),end:t.positionAt(r.getTokenEnd())}:null}if(s.endTagStart&&a>=s.endTagStart){const t=g(htmlLanguageTypes_1.TokenType.EndTag,s.endTagStart);return t?c(s.tag,t):null}const f=g(htmlLanguageTypes_1.TokenType.StartTag,s.start);if(f)return c(s.tag,f);const d=g(htmlLanguageTypes_1.TokenType.AttributeName,s.start);if(d){return function(t,e,n){for(const a of u){let s=null;if(a.provideAttributes(t).forEach((t=>{if(e===t.name&&t.description){const e=(0,dataProvider_1.generateDocumentation)(t,r,o);s=e?{contents:e,range:n}:null}})),s)return s.contents=i(s.contents),s}return null}(s.tag,t.getText(d),d)}const p=function(){let t=a-1,n=e.character;for(;t>=0&&(0,strings_1.isLetterOrDigit)(l,t);)t--,n--;let r=t+1,i=n;for(;(0,strings_1.isLetterOrDigit)(l,r);)r++,i++;if(t>=0&&"&"===l[t]){let t=null;return t=";"===l[r]?htmlLanguageTypes_1.Range.create(htmlLanguageTypes_1.Position.create(e.line,n),htmlLanguageTypes_1.Position.create(e.line,i+1)):htmlLanguageTypes_1.Range.create(htmlLanguageTypes_1.Position.create(e.line,n),htmlLanguageTypes_1.Position.create(e.line,i)),t}return null}();if(p)return function(t,e){let n=function(t){let e=a-1,n="&";for(;e>=0&&(0,strings_1.isLetterOrDigit)(t,e);)e--;for(e+=1;(0,strings_1.isLetterOrDigit)(t,e);)n+=t[e],e+=1;return n+=";",n}(t);for(const t in htmlEntities_1.entities){let r=null;if(n==="&"+t){let n=htmlEntities_1.entities[t].charCodeAt(0).toString(16).toUpperCase(),i="U+";if(n.length<4){const t=4-n.length;let e=0;for(;e<t;)i+="0",e+=1}i+=n;const o=l10n.t("Character entity representing '{0}', unicode equivalent '{1}'",htmlEntities_1.entities[t],i);r=o?{contents:o,range:e}:null}if(r)return r.contents=i(r.contents),r}return null}(l,p);const h=g(htmlLanguageTypes_1.TokenType.AttributeValue,s.start);if(h){const e=s.tag,n=trimQuotes(t.getText(h)),a=function(e,n){const r=(0,htmlScanner_1.createScanner)(t.getText(),e);let i,o=r.scan();for(;o!==htmlLanguageTypes_1.TokenType.EOS&&r.getTokenEnd()<=n;)o=r.scan(),o===htmlLanguageTypes_1.TokenType.AttributeName&&(i=r.getTokenText());return i}(s.start,t.offsetAt(h.start));if(a)return function(t,e,n,a){for(const s of u){let l=null;if(s.provideValues(t,e).forEach((t=>{if(n===t.name&&t.description){const e=(0,dataProvider_1.generateDocumentation)(t,r,o);l=e?{contents:e,range:a}:null}})),l)return l.contents=i(l.contents),l}return null}(e,a,n,h)}return null}convertContents(t){if(!this.doesSupportMarkdown()){if("string"==typeof t)return t;if("kind"in t)return{kind:"plaintext",value:t.value};if(!Array.isArray(t))return t.value;t.map((t=>"string"==typeof t?t:t.value))}return t}doesSupportMarkdown(){var t,e,n;if(!(0,object_1.isDefined)(this.supportsMarkdown)){if(!(0,object_1.isDefined)(this.lsOptions.clientCapabilities))return this.supportsMarkdown=!0,this.supportsMarkdown;const r=null===(n=null===(e=null===(t=this.lsOptions.clientCapabilities)||void 0===t?void 0:t.textDocument)||void 0===e?void 0:e.hover)||void 0===n?void 0:n.contentFormat;this.supportsMarkdown=Array.isArray(r)&&-1!==r.indexOf(htmlLanguageTypes_1.MarkupKind.Markdown)}return this.supportsMarkdown}}function trimQuotes(t){return t.length<=1?t.replace(/['"]/,""):("'"!==t[0]&&'"'!==t[0]||(t=t.slice(1)),"'"!==t[t.length-1]&&'"'!==t[t.length-1]||(t=t.slice(0,-1)),t)}exports.HTMLHover=HTMLHover;
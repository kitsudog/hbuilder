"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.HTMLSelectionRange=void 0;const htmlScanner_1=require("../parser/htmlScanner"),htmlLanguageTypes_1=require("../htmlLanguageTypes");class HTMLSelectionRange{constructor(t){this.htmlParser=t}getSelectionRanges(t,e){const n=this.htmlParser.parseDocument(t);return e.map((e=>this.getSelectionRange(e,t,n)))}getSelectionRange(t,e,n){const a=this.getApplicableRanges(e,t,n);let s,g;for(let t=a.length-1;t>=0;t--){const n=a[t];s&&n[0]===s[0]&&n[1]===s[1]||(g=htmlLanguageTypes_1.SelectionRange.create(htmlLanguageTypes_1.Range.create(e.positionAt(a[t][0]),e.positionAt(a[t][1])),g)),s=n}return g||(g=htmlLanguageTypes_1.SelectionRange.create(htmlLanguageTypes_1.Range.create(t,t))),g}getApplicableRanges(t,e,n){const a=t.offsetAt(e),s=n.findNodeAt(a);let g=this.getAllParentTagRanges(s);if(s.startTagEnd&&!s.endTagStart){if(s.startTagEnd!==s.end)return[[s.start,s.end]];const e=htmlLanguageTypes_1.Range.create(t.positionAt(s.startTagEnd-2),t.positionAt(s.startTagEnd));"/>"===t.getText(e)?g.unshift([s.start+1,s.startTagEnd-2]):g.unshift([s.start+1,s.startTagEnd-1]);return g=this.getAttributeLevelRanges(t,s,a).concat(g),g}if(!s.startTagEnd||!s.endTagStart)return g;if(g.unshift([s.start,s.end]),s.start<a&&a<s.startTagEnd){g.unshift([s.start+1,s.startTagEnd-1]);return g=this.getAttributeLevelRanges(t,s,a).concat(g),g}return s.startTagEnd<=a&&a<=s.endTagStart?(g.unshift([s.startTagEnd,s.endTagStart]),g):(a>=s.endTagStart+2&&g.unshift([s.endTagStart+2,s.end-1]),g)}getAllParentTagRanges(t){let e=t;const n=[];for(;e.parent;)e=e.parent,this.getNodeRanges(e).forEach((t=>n.push(t)));return n}getNodeRanges(t){return t.startTagEnd&&t.endTagStart&&t.startTagEnd<t.endTagStart?[[t.startTagEnd,t.endTagStart],[t.start,t.end]]:[[t.start,t.end]]}getAttributeLevelRanges(t,e,n){const a=htmlLanguageTypes_1.Range.create(t.positionAt(e.start),t.positionAt(e.end)),s=t.getText(a),g=n-e.start,r=(0,htmlScanner_1.createScanner)(s);let o=r.scan();const T=e.start,i=[];let l=!1,c=-1;for(;o!==htmlLanguageTypes_1.TokenType.EOS;){switch(o){case htmlLanguageTypes_1.TokenType.AttributeName:if(g<r.getTokenOffset()){l=!1;break}g<=r.getTokenEnd()&&i.unshift([r.getTokenOffset(),r.getTokenEnd()]),l=!0,c=r.getTokenOffset();break;case htmlLanguageTypes_1.TokenType.AttributeValue:{if(!l)break;const t=r.getTokenText();if(g<r.getTokenOffset()){i.push([c,r.getTokenEnd()]);break}g>=r.getTokenOffset()&&g<=r.getTokenEnd()&&(i.unshift([r.getTokenOffset(),r.getTokenEnd()]),('"'===t[0]&&'"'===t[t.length-1]||"'"===t[0]&&"'"===t[t.length-1])&&g>=r.getTokenOffset()+1&&g<=r.getTokenEnd()-1&&i.unshift([r.getTokenOffset()+1,r.getTokenEnd()-1]),i.push([c,r.getTokenEnd()]));break}}o=r.scan()}return i.map((t=>[t[0]+T,t[1]+T]))}}exports.HTMLSelectionRange=HTMLSelectionRange;
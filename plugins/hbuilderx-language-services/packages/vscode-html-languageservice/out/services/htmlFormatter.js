"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.format=void 0;const htmlLanguageTypes_1=require("../htmlLanguageTypes"),beautify_html_1=require("../beautify/beautify-html"),strings_1=require("../utils/strings");function format(t,e,n){let i=t.getText(),r=!0,o=0;const a=n.tabSize||4;if(e){let a=t.offsetAt(e.start),s=a;for(;s>0&&isWhitespace(i,s-1);)s--;0===s||isEOL(i,s-1)?a=s:s<a&&(a=s+1);let p=t.offsetAt(e.end),g=p;for(;g<i.length&&isWhitespace(i,g);)g++;(g===i.length||isEOL(i,g))&&(p=g),e=htmlLanguageTypes_1.Range.create(t.positionAt(a),t.positionAt(p));const l=i.substring(0,a);if(new RegExp(/.*[<][^>]*$/).test(l))return i=i.substring(a,p),[{range:e,newText:i}];if(r=p===i.length,i=i.substring(a,p),0!==a){const i=t.offsetAt(htmlLanguageTypes_1.Position.create(e.start.line,0));o=computeIndentLevel(t.getText(),i,n)}}else e=htmlLanguageTypes_1.Range.create(htmlLanguageTypes_1.Position.create(0,0),t.positionAt(i.length));const s={indent_size:a,indent_char:n.insertSpaces?" ":"\t",indent_empty_lines:getFormatOption(n,"indentEmptyLines",!1),wrap_line_length:getFormatOption(n,"wrapLineLength",120),unformatted:getTagsFormatOption(n,"unformatted",void 0),content_unformatted:getTagsFormatOption(n,"contentUnformatted",void 0),indent_inner_html:getFormatOption(n,"indentInnerHtml",!1),preserve_newlines:getFormatOption(n,"preserveNewLines",!0),max_preserve_newlines:getFormatOption(n,"maxPreserveNewLines",32786),indent_handlebars:getFormatOption(n,"indentHandlebars",!1),end_with_newline:r&&getFormatOption(n,"endWithNewline",!1),extra_liners:getTagsFormatOption(n,"extraLiners",void 0),wrap_attributes:getFormatOption(n,"wrapAttributes","auto"),wrap_attributes_indent_size:getFormatOption(n,"wrapAttributesIndentSize",void 0),eol:"\n",indent_scripts:getFormatOption(n,"indentScripts","normal"),templating:getTemplatingFormatOption(n,"all"),unformatted_content_delimiter:getFormatOption(n,"unformattedContentDelimiter","")};let p=(0,beautify_html_1.html_beautify)(trimLeft(i),s);if(o>0){const t=n.insertSpaces?(0,strings_1.repeat)(" ",a*o):(0,strings_1.repeat)("\t",o);p=p.split("\n").join("\n"+t),0===e.start.character&&(p=t+p)}return[{range:e,newText:p}]}function trimLeft(t){return t.replace(/^\s+/,"")}function getFormatOption(t,e,n){if(t&&t.hasOwnProperty(e)){const n=t[e];if(null!==n)return n}return n}function getTagsFormatOption(t,e,n){const i=getFormatOption(t,e,null);return"string"==typeof i?i.length>0?i.split(",").map((t=>t.trim().toLowerCase())):[]:n}function getTemplatingFormatOption(t,e){return!0===getFormatOption(t,"templating",e)?["auto"]:["none"]}function computeIndentLevel(t,e,n){let i=e,r=0;const o=n.tabSize||4;for(;i<t.length;){const e=t.charAt(i);if(" "===e)r++;else{if("\t"!==e)break;r+=o}i++}return Math.floor(r/o)}function isEOL(t,e){return-1!=="\r\n".indexOf(t.charAt(e))}function isWhitespace(t,e){return-1!==" \t".indexOf(t.charAt(e))}exports.format=format;
"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,a){void 0===a&&(a=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,a,o)}:function(e,t,n,a){void 0===a&&(a=n),e[a]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.HTMLCompletion=void 0;const htmlLanguageTypes_1=require("../htmlLanguageTypes"),htmlEntities_1=require("../parser/htmlEntities"),htmlScanner_1=require("../parser/htmlScanner"),l10n=__importStar(require("@vscode/l10n")),dataProvider_1=require("../languageFacts/dataProvider"),object_1=require("../utils/object"),strings_1=require("../utils/strings"),pathCompletion_1=require("./pathCompletion");class HTMLCompletion{constructor(e,t){this.lsOptions=e,this.dataManager=t,this.completionParticipants=[]}setCompletionParticipants(e){this.completionParticipants=e||[]}async doComplete2(e,t,n,a,o){if(!this.lsOptions.fileSystemProvider||!this.lsOptions.fileSystemProvider.readDirectory)return this.doComplete(e,t,n,o);const r=new pathCompletion_1.PathCompletionParticipant(this.dataManager,this.lsOptions.fileSystemProvider.readDirectory),i=this.completionParticipants;this.completionParticipants=[r].concat(i);const s=this.doComplete(e,t,n,o);try{const t=await r.computeCompletions(e,a);return{isIncomplete:s.isIncomplete||t.isIncomplete,items:t.items.concat(s.items)}}finally{this.completionParticipants=i}}doResolve(e,t,n,a,o){o||(o={}),o.needDetail=!0,o.needDocumentation=!0;const r=this._doComplete(t,n,a,o).items.find((t=>t.label===e.label));return r&&(e.detail=r.detail,e.documentation=r.documentation,e.command=r.command),this.convertCompletionItem(e),e}doComplete(e,t,n,a){const o=this._doComplete(e,t,n,a);return this.convertCompletionList(o)}_doComplete(e,t,n,a){const o={isIncomplete:!1,items:[]},r=this.completionParticipants,i=this.dataManager.getDataProviders().filter((t=>t.isApplicable(e.languageId)&&(!a||!1!==a[t.getId()]))),s=this.dataManager.getVoidElements(i),l=this.doesSupportMarkdown(),u=(null==a||a.needDetail,null==a?void 0:a.needDocumentation),g=e.getText(),c=e.offsetAt(t),p=n.findNodeBefore(c);if(!p)return o;const m=(0,htmlScanner_1.createScanner)(g,p.start);let d,T="";function f(t,n=c){return t>c&&(t=c),{start:e.positionAt(t),end:e.positionAt(n)}}function h(e,t){const n=f(e,t);return i.forEach((e=>{e.provideTags().forEach((e=>{o.items.push({label:e.name,kind:htmlLanguageTypes_1.CompletionItemKind.Property,documentation:u?(0,dataProvider_1.generateDocumentation)(e,void 0,l):void 0,textEdit:htmlLanguageTypes_1.TextEdit.replace(n,e.name),insertTextFormat:htmlLanguageTypes_1.InsertTextFormat.PlainText,uniPlatform:e.uniPlatform,fromDataProvider:!0})}))})),o}function y(e){let t=e;for(;t>0;){const n=g.charAt(t-1);if("\n\r".indexOf(n)>=0)return g.substring(t,e);if(!isWhiteSpace(n))return null;t--}return g.substring(0,e)}function _(e,t,n=c){const a=f(e,n),r=isFollowedBy(g,n,htmlLanguageTypes_1.ScannerState.WithinEndTag,htmlLanguageTypes_1.TokenType.EndTagClose)?"":">";let s=p;for(t&&(s=s.parent);s;){const t=s.tag;if(t&&(!s.closed||s.endTagStart&&s.endTagStart>c)){const n={label:"/"+t,kind:htmlLanguageTypes_1.CompletionItemKind.Property,filterText:"/"+t,textEdit:htmlLanguageTypes_1.TextEdit.replace(a,"/"+t+r),insertTextFormat:htmlLanguageTypes_1.InsertTextFormat.PlainText},i=y(s.start),l=y(e-1);if(null!==i&&null!==l&&i!==l){const a=i+"</"+t+r;n.textEdit=htmlLanguageTypes_1.TextEdit.replace(f(e-1-l.length),a),n.filterText=l+"</"+t}return o.items.push(n),o}s=s.parent}return t||i.forEach((e=>{e.provideTags().forEach((e=>{o.items.push({label:"/"+e.name,kind:htmlLanguageTypes_1.CompletionItemKind.Property,documentation:u?(0,dataProvider_1.generateDocumentation)(e,void 0,l):void 0,filterText:"/"+e.name+r,textEdit:htmlLanguageTypes_1.TextEdit.replace(a,"/"+e.name+r),insertTextFormat:htmlLanguageTypes_1.InsertTextFormat.PlainText,uniPlatform:e.uniPlatform,fromDataProvider:!0})}))})),o}const k=(t,n)=>{if(a&&a.hideAutoCompleteProposals)return o;if(!this.dataManager.isVoidElement(n,s)){const a=e.positionAt(t);o.items.push({label:"</"+n+">",kind:htmlLanguageTypes_1.CompletionItemKind.Property,filterText:"</"+n+">",textEdit:htmlLanguageTypes_1.TextEdit.insert(a,"$0</"+n+">"),insertTextFormat:htmlLanguageTypes_1.InsertTextFormat.Snippet})}return o};function E(e,t){return h(e,t),_(e,!0,t),o}function L(e,t=c){var r;let s=c;for(;s<t&&"<"!==g[s];)s++;const m=g.substring(e,t),d=f(e,s);let h="";if(!isFollowedBy(g,t,htmlLanguageTypes_1.ScannerState.AfterAttributeName,htmlLanguageTypes_1.TokenType.DelimiterAssign)){const e=null!==(r=null==a?void 0:a.attributeDefaultValue)&&void 0!==r?r:"doublequotes";h="empty"===e?"=$1":"singlequotes"===e?"='$1'":'="$1"'}const y=function(){const e=Object.create(null);return p.attributeNames.forEach((t=>{e[t]=!0})),e}();return y[m]=!1,i.forEach((e=>{e.provideAttributes(T).forEach((e=>{if(y[e.name])return;y[e.name]=!0;let t,n=e.name;"v"!==e.valueSet&&h.length&&(n+=h,t={title:"Suggest",command:"editor.action.triggerSuggest"}),o.items.push({label:e.name,kind:"handler"===e.valueSet?htmlLanguageTypes_1.CompletionItemKind.Function:htmlLanguageTypes_1.CompletionItemKind.Value,documentation:u?(0,dataProvider_1.generateDocumentation)(e,void 0,l):void 0,textEdit:htmlLanguageTypes_1.TextEdit.replace(d,n),insertTextFormat:htmlLanguageTypes_1.InsertTextFormat.Snippet,command:t,uniPlatform:e.uniPlatform,fromDataProvider:!0})}))})),function(e,t){const a="data-",r={};function i(e){e.attributeNames.forEach((e=>{!(0,strings_1.startsWith)(e,a)||r[e]||t[e]||(r[e]=e+'="$1"')})),e.children.forEach((e=>i(e)))}r[a]=`${a}$1="$2"`,n&&n.roots.forEach((e=>i(e)));Object.keys(r).forEach((t=>o.items.push({label:t,kind:htmlLanguageTypes_1.CompletionItemKind.Value,textEdit:htmlLanguageTypes_1.TextEdit.replace(e,r[t]),insertTextFormat:htmlLanguageTypes_1.InsertTextFormat.Snippet})))}(d,y),o}function S(n,a=c){let s,p,m;if(c>n&&c<=a&&isQuote(g[n])){const e=n+1;let t=a;a>n&&g[a-1]===g[n]&&t--;const o=getWordStart(g,c,e),r=getWordEnd(g,c,t);s=f(o,r),m=c>=e&&c<=t?g.substring(e,c):"",p=!1}else s=f(n,a),m=g.substring(n,c),p=!0;if(r.length>0){const o=T.toLowerCase(),i=d.toLowerCase(),s=f(n,a);for(const n of r)n.onHtmlAttributeValue&&n.onHtmlAttributeValue({document:e,position:t,tag:o,attribute:i,value:m,range:s})}return i.forEach((e=>{e.provideValues(T,d).forEach((e=>{const t=p?'"'+e.name+'"':e.name;o.items.push({label:e.name,filterText:t,kind:htmlLanguageTypes_1.CompletionItemKind.Unit,documentation:u?(0,dataProvider_1.generateDocumentation)(e,void 0,l):void 0,textEdit:htmlLanguageTypes_1.TextEdit.replace(s,t),insertTextFormat:htmlLanguageTypes_1.InsertTextFormat.PlainText,uniPlatform:e.uniPlatform,fromDataProvider:!0})}))})),x(),o}function b(e){return c===m.getTokenEnd()&&(C=m.scan(),C===e&&m.getTokenOffset()===c)?m.getTokenEnd():c}function v(){for(const n of r)n.onHtmlContent&&n.onHtmlContent({document:e,position:t});return x()}function x(){let e=c-1,n=t.character;for(;e>=0&&(0,strings_1.isLetterOrDigit)(g,e);)e--,n--;if(e>=0&&"&"===g[e]){const e=htmlLanguageTypes_1.Range.create(htmlLanguageTypes_1.Position.create(t.line,n-1),t);for(const t in htmlEntities_1.entities)if((0,strings_1.endsWith)(t,";")){const n="&"+t;o.items.push({label:n,kind:htmlLanguageTypes_1.CompletionItemKind.Keyword,documentation:u?l10n.t("Character entity representing '{0}'",htmlEntities_1.entities[t]):void 0,textEdit:htmlLanguageTypes_1.TextEdit.replace(e,n),insertTextFormat:htmlLanguageTypes_1.InsertTextFormat.PlainText})}}return o}function P(e,t){const n=f(e,t);o.items.push({label:"!DOCTYPE",kind:htmlLanguageTypes_1.CompletionItemKind.Property,documentation:u?"A preamble for an HTML document.":void 0,textEdit:htmlLanguageTypes_1.TextEdit.replace(n,"!DOCTYPE html>"),insertTextFormat:htmlLanguageTypes_1.InsertTextFormat.PlainText})}let C=m.scan();for(;C!==htmlLanguageTypes_1.TokenType.EOS&&m.getTokenOffset()<=c;){switch(C){case htmlLanguageTypes_1.TokenType.StartTagOpen:if(m.getTokenEnd()===c){const e=b(htmlLanguageTypes_1.TokenType.StartTag);return 0===t.line&&P(c,e),E(c,e)}break;case htmlLanguageTypes_1.TokenType.StartTag:if(m.getTokenOffset()<=c&&c<=m.getTokenEnd())return h(m.getTokenOffset(),m.getTokenEnd());T=m.getTokenText();break;case htmlLanguageTypes_1.TokenType.AttributeName:if(m.getTokenOffset()<=c&&c<=m.getTokenEnd())return L(m.getTokenOffset(),m.getTokenEnd());d=m.getTokenText();break;case htmlLanguageTypes_1.TokenType.DelimiterAssign:if(m.getTokenEnd()===c){const e=b(htmlLanguageTypes_1.TokenType.AttributeValue);return S(c,e)}break;case htmlLanguageTypes_1.TokenType.AttributeValue:if(m.getTokenOffset()<=c&&c<=m.getTokenEnd())return S(m.getTokenOffset(),m.getTokenEnd());break;case htmlLanguageTypes_1.TokenType.Whitespace:if(c<=m.getTokenEnd())switch(m.getScannerState()){case htmlLanguageTypes_1.ScannerState.AfterOpeningStartTag:return E(m.getTokenOffset(),b(htmlLanguageTypes_1.TokenType.StartTag));case htmlLanguageTypes_1.ScannerState.WithinTag:case htmlLanguageTypes_1.ScannerState.AfterAttributeName:return L(m.getTokenEnd());case htmlLanguageTypes_1.ScannerState.BeforeAttributeValue:return S(m.getTokenEnd());case htmlLanguageTypes_1.ScannerState.AfterOpeningEndTag:return _(m.getTokenOffset()-1,!1);case htmlLanguageTypes_1.ScannerState.WithinContent:return v()}break;case htmlLanguageTypes_1.TokenType.EndTagOpen:if(c<=m.getTokenEnd()){return _(m.getTokenOffset()+1,!1,b(htmlLanguageTypes_1.TokenType.EndTag))}break;case htmlLanguageTypes_1.TokenType.EndTag:if(c<=m.getTokenEnd()){let e=m.getTokenOffset()-1;for(;e>=0;){const t=g.charAt(e);if("/"===t)return _(e,!1,m.getTokenEnd());if(!isWhiteSpace(t))break;e--}}break;case htmlLanguageTypes_1.TokenType.StartTagClose:if(c<=m.getTokenEnd()&&T)return k(m.getTokenEnd(),T);break;case htmlLanguageTypes_1.TokenType.Content:if(c<=m.getTokenEnd())return v();break;default:if(c<=m.getTokenEnd())return o}C=m.scan()}return o}getAllTagName(e){const t=[];return this.dataManager.getDataProviders().filter((t=>t.isApplicable(e.languageId))).forEach((e=>{e.provideTags().forEach((e=>{t.push(e.name)}))})),t}doQuoteComplete(e,t,n,a){var o;const r=e.offsetAt(t);if(r<=0)return null;const i=null!==(o=null==a?void 0:a.attributeDefaultValue)&&void 0!==o?o:"doublequotes";if("empty"===i)return null;if("="!==e.getText().charAt(r-1))return null;const s="doublequotes"===i?'"$1"':"'$1'",l=n.findNodeBefore(r);if(l&&l.attributes&&l.start<r&&(!l.endTagStart||l.endTagStart>r)){const t=(0,htmlScanner_1.createScanner)(e.getText(),l.start);let n=t.scan();for(;n!==htmlLanguageTypes_1.TokenType.EOS&&t.getTokenEnd()<=r;){if(n===htmlLanguageTypes_1.TokenType.AttributeName&&t.getTokenEnd()===r-1)return n=t.scan(),n!==htmlLanguageTypes_1.TokenType.DelimiterAssign?null:(n=t.scan(),n===htmlLanguageTypes_1.TokenType.Unknown||n===htmlLanguageTypes_1.TokenType.AttributeValue?null:s);n=t.scan()}}return null}doTagComplete(e,t,n){const a=e.offsetAt(t);if(a<=0)return null;const o=e.getText().charAt(a-1);if(">"===o){const t=this.dataManager.getVoidElements(e.languageId),o=n.findNodeBefore(a);if(o&&o.tag&&!this.dataManager.isVoidElement(o.tag,t)&&o.start<a&&(!o.endTagStart||o.endTagStart>a)){const t=(0,htmlScanner_1.createScanner)(e.getText(),o.start);let n=t.scan();for(;n!==htmlLanguageTypes_1.TokenType.EOS&&t.getTokenEnd()<=a;){if(n===htmlLanguageTypes_1.TokenType.StartTagClose&&t.getTokenEnd()===a)return`$0</${o.tag}>`;n=t.scan()}}}else if("/"===o){let t=n.findNodeBefore(a);for(;t&&t.closed&&!(t.endTagStart&&t.endTagStart>a);)t=t.parent;if(t&&t.tag){const n=(0,htmlScanner_1.createScanner)(e.getText(),t.start);let o=n.scan();for(;o!==htmlLanguageTypes_1.TokenType.EOS&&n.getTokenEnd()<=a;){if(o===htmlLanguageTypes_1.TokenType.EndTagOpen&&n.getTokenEnd()===a)return">"!==e.getText().charAt(a)?`${t.tag}>`:t.tag;o=n.scan()}}}return null}convertCompletionItem(e){return this.doesSupportMarkdown()||e.documentation&&"string"!=typeof e.documentation&&(e.documentation={kind:"plaintext",value:e.documentation.value}),e}convertCompletionList(e){return this.doesSupportMarkdown()||e.items.forEach((e=>{e.documentation&&"string"!=typeof e.documentation&&(e.documentation={kind:"plaintext",value:e.documentation.value})})),e}doesSupportMarkdown(){var e,t,n;if(!(0,object_1.isDefined)(this.supportsMarkdown)){if(!(0,object_1.isDefined)(this.lsOptions.clientCapabilities))return this.supportsMarkdown=!0,this.supportsMarkdown;const a=null===(n=null===(t=null===(e=this.lsOptions.clientCapabilities.textDocument)||void 0===e?void 0:e.completion)||void 0===t?void 0:t.completionItem)||void 0===n?void 0:n.documentationFormat;this.supportsMarkdown=Array.isArray(a)&&-1!==a.indexOf(htmlLanguageTypes_1.MarkupKind.Markdown)}return this.supportsMarkdown}}function isQuote(e){return/^["']*$/.test(e)}function isWhiteSpace(e){return/^\s*$/.test(e)}function isFollowedBy(e,t,n,a){const o=(0,htmlScanner_1.createScanner)(e,t,n);let r=o.scan();for(;r===htmlLanguageTypes_1.TokenType.Whitespace;)r=o.scan();return r===a}function getWordStart(e,t,n){for(;t>n&&!isWhiteSpace(e[t-1]);)t--;return t}function getWordEnd(e,t,n){for(;t<n&&!isWhiteSpace(e[t]);)t++;return t}exports.HTMLCompletion=HTMLCompletion;
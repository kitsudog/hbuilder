"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var a=Object.getOwnPropertyDescriptor(t,r);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,a)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.HTMLDocumentLinks=void 0;const htmlScanner_1=require("../parser/htmlScanner"),strings=__importStar(require("../utils/strings")),vscode_uri_1=require("vscode-uri"),htmlLanguageTypes_1=require("../htmlLanguageTypes");function normalizeRef(e){const t=e[0];return t!==e[e.length-1]||"'"!==t&&'"'!==t||(e=e.substring(1,e.length-1)),e}function validateRef(e,t){return!!e.length&&(("handlebars"!==t||!/{{|}}/.test(e))&&/\b(w[\w\d+.-]*:\/\/)?[^\s()<>]+(?:\([\w\d]+\)|([^[:punct:]\s]|\/?))/.test(e))}function getWorkspaceUrl(e,t,r,n){if(/^\s*javascript\:/i.test(t)||/[\n\r]/.test(t))return;const a=(t=t.replace(/^\s*/g,"")).match(/^(\w[\w\d+.-]*):/);if(a){const e=a[1].toLowerCase();return"http"===e||"https"===e||"file"===e?t:void 0}if(/^\#/i.test(t))return e+t;if(/^\/\//i.test(t)){return(strings.startsWith(e,"https://")?"https":"http")+":"+t.replace(/^\s*/g,"")}return r?r.resolveReference(t,n||e):t}function createLink(e,t,r,n,a,i){const s=normalizeRef(r);if(!validateRef(s,e.languageId))return;s.length<r.length&&(n++,a--);const o=getWorkspaceUrl(e.uri,s,t,i);if(!o)return;const u=validateAndCleanURI(o,e);return{range:htmlLanguageTypes_1.Range.create(e.positionAt(n),e.positionAt(a)),target:u}}const _hash="#".charCodeAt(0);function validateAndCleanURI(e,t){try{let r=vscode_uri_1.URI.parse(e);return"file"===r.scheme&&r.query&&(r=r.with({query:null}),e=r.toString(!0)),"file"!==r.scheme||!r.fragment||e.startsWith(t.uri)&&e.charCodeAt(t.uri.length)===_hash?e:r.with({fragment:null}).toString(!0)}catch(e){return}}class HTMLDocumentLinks{constructor(e){this.dataManager=e}findDocumentLinks(e,t){const r=[],n=(0,htmlScanner_1.createScanner)(e.getText(),0);let a,i,s,o=n.scan(),u=!1;const c={};for(;o!==htmlLanguageTypes_1.TokenType.EOS;){switch(o){case htmlLanguageTypes_1.TokenType.StartTag:i=n.getTokenText().toLowerCase(),s||(u="base"===i);break;case htmlLanguageTypes_1.TokenType.AttributeName:a=n.getTokenText().toLowerCase();break;case htmlLanguageTypes_1.TokenType.AttributeValue:if(i&&a&&this.dataManager.isPathAttribute(i,a)){const i=n.getTokenText();if(!u){const a=createLink(e,t,i,n.getTokenOffset(),n.getTokenEnd(),s);a&&r.push(a)}u&&void 0===s&&(s=normalizeRef(i),s&&t&&(s=t.resolveReference(s,e.uri))),u=!1,a=void 0}else if("id"===a){c[normalizeRef(n.getTokenText())]=n.getTokenOffset()}}o=n.scan()}for(const t of r){const r=e.uri+"#";if(t.target&&strings.startsWith(t.target,r)){const n=c[t.target.substring(r.length)];if(void 0!==n){const a=e.positionAt(n);t.target=`${r}${a.line+1},${a.character+1}`}else t.target=e.uri}}return r}}exports.HTMLDocumentLinks=HTMLDocumentLinks;
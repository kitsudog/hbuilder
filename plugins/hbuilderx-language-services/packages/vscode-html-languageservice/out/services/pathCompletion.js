"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PathCompletionParticipant=void 0;const htmlLanguageTypes_1=require("../htmlLanguageTypes"),strings_1=require("../utils/strings");class PathCompletionParticipant{constructor(t,e){this.dataManager=t,this.readDirectory=e,this.atributeCompletions=[]}onHtmlAttributeValue(t){this.dataManager.isPathAttribute(t.tag,t.attribute)&&this.atributeCompletions.push(t)}async computeCompletions(t,e){const i={items:[],isIncomplete:!1};for(const s of this.atributeCompletions){const n=stripQuotes(t.getText(s.range));if(isCompletablePath(n))if("."===n||".."===n)i.isIncomplete=!0;else{const a=pathToReplaceRange(s.value,n,s.range),o=await this.providePathSuggestions(s.value,a,t,e);for(const t of o)i.items.push(t)}}return i}async providePathSuggestions(t,e,i,s){const n=t.substring(0,t.lastIndexOf("/")+1);let a=s.resolveReference(n||".",i.uri);if(a)try{const t=[],i=await this.readDirectory(a);for(const[s,n]of i)s.charCodeAt(0)!==CharCode_dot&&t.push(createCompletionItem(s,n===htmlLanguageTypes_1.FileType.Directory,e));return t}catch(t){}return[]}}exports.PathCompletionParticipant=PathCompletionParticipant;const CharCode_dot=".".charCodeAt(0);function stripQuotes(t){return(0,strings_1.startsWith)(t,"'")||(0,strings_1.startsWith)(t,'"')?t.slice(1,-1):t}function isCompletablePath(t){return!((0,strings_1.startsWith)(t,"http")||(0,strings_1.startsWith)(t,"https")||(0,strings_1.startsWith)(t,"//"))}function pathToReplaceRange(t,e,i){let s;const n=t.lastIndexOf("/");if(-1===n)s=shiftRange(i,1,-1);else{const t=e.slice(n+1),a=shiftPosition(i.end,-1-t.length),o=t.indexOf(" ");let r;r=-1!==o?shiftPosition(a,o):shiftPosition(i.end,-1),s=htmlLanguageTypes_1.Range.create(a,r)}return s}function createCompletionItem(t,e,i){return e?{label:t+="/",kind:htmlLanguageTypes_1.CompletionItemKind.Folder,textEdit:htmlLanguageTypes_1.TextEdit.replace(i,t),command:{title:"Suggest",command:"editor.action.triggerSuggest"}}:{label:t,kind:htmlLanguageTypes_1.CompletionItemKind.File,textEdit:htmlLanguageTypes_1.TextEdit.replace(i,t)}}function shiftPosition(t,e){return htmlLanguageTypes_1.Position.create(t.line,t.character+e)}function shiftRange(t,e,i){const s=shiftPosition(t.start,e),n=shiftPosition(t.end,i);return htmlLanguageTypes_1.Range.create(s,n)}
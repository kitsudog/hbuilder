"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,s,t,r){void 0===r&&(r=t);var n=Object.getOwnPropertyDescriptor(s,t);n&&!("get"in n?!s.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return s[t]}}),Object.defineProperty(e,r,n)}:function(e,s,t,r){void 0===r&&(r=t),e[r]=s[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,s){Object.defineProperty(e,"default",{enumerable:!0,value:s})}:function(e,s){e.default=s}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var s={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(s,e,t);return __setModuleDefault(s,e),s};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Parser=void 0;const cssScanner_1=require("./cssScanner"),nodes=__importStar(require("./cssNodes")),cssErrors_1=require("./cssErrors"),languageFacts=__importStar(require("../languageFacts/facts")),objects_1=require("../utils/objects");class Parser{constructor(e=new cssScanner_1.Scanner){this.keyframeRegex=/^@(\-(webkit|ms|moz|o)\-)?keyframes$/i,this.scanner=e,this.token={type:cssScanner_1.TokenType.EOF,offset:-1,len:0,text:""},this.prevToken=void 0}peekIdent(e){return cssScanner_1.TokenType.Ident===this.token.type&&e.length===this.token.text.length&&e===this.token.text.toLowerCase()}peekKeyword(e){return cssScanner_1.TokenType.AtKeyword===this.token.type&&e.length===this.token.text.length&&e===this.token.text.toLowerCase()}peekDelim(e){return cssScanner_1.TokenType.Delim===this.token.type&&e===this.token.text}peek(e){return e===this.token.type}peekOne(e){return-1!==e.indexOf(this.token.type)}peekRegExp(e,s){return e===this.token.type&&s.test(this.token.text)}hasWhitespace(){return!!this.prevToken&&this.prevToken.offset+this.prevToken.len!==this.token.offset}consumeToken(){this.prevToken=this.token,this.token=this.scanner.scan()}mark(){return{prev:this.prevToken,curr:this.token,pos:this.scanner.pos()}}restoreAtMark(e){this.prevToken=e.prev,this.token=e.curr,this.scanner.goBackTo(e.pos)}try(e){const s=this.mark(),t=e();return t||(this.restoreAtMark(s),null)}acceptOneKeyword(e){if(cssScanner_1.TokenType.AtKeyword===this.token.type)for(const s of e)if(s.length===this.token.text.length&&s===this.token.text.toLowerCase())return this.consumeToken(),!0;return!1}accept(e){return e===this.token.type&&(this.consumeToken(),!0)}acceptIdent(e){return!!this.peekIdent(e)&&(this.consumeToken(),!0)}acceptKeyword(e){return!!this.peekKeyword(e)&&(this.consumeToken(),!0)}acceptDelim(e){return!!this.peekDelim(e)&&(this.consumeToken(),!0)}acceptRegexp(e){return!!e.test(this.token.text)&&(this.consumeToken(),!0)}_parseRegexp(e){let s=this.createNode(nodes.NodeType.Identifier);do{}while(this.acceptRegexp(e));return this.finish(s)}acceptUnquotedString(){const e=this.scanner.pos();this.scanner.goBackTo(this.token.offset);const s=this.scanner.scanUnquotedString();return s?(this.token=s,this.consumeToken(),!0):(this.scanner.goBackTo(e),!1)}resync(e,s){for(;;){if(e&&-1!==e.indexOf(this.token.type))return this.consumeToken(),!0;if(s&&-1!==s.indexOf(this.token.type))return!0;if(this.token.type===cssScanner_1.TokenType.EOF)return!1;this.token=this.scanner.scan()}}createNode(e){return new nodes.Node(this.token.offset,this.token.len,e)}create(e){return new e(this.token.offset,this.token.len)}finish(e,s,t,r){if(!(e instanceof nodes.Nodelist)&&(s&&this.markError(e,s,t,r),this.prevToken)){const s=this.prevToken.offset+this.prevToken.len;e.length=s>e.offset?s-e.offset:0}return e}markError(e,s,t,r){this.token!==this.lastErrorToken&&(e.addIssue(new nodes.Marker(e,s,nodes.Level.Error,void 0,this.token.offset,this.token.len)),this.lastErrorToken=this.token),(t||r)&&this.resync(t,r)}parseStylesheet(e){const s=e.version,t=e.getText();return this.internalParse(t,this._parseStylesheet,((r,n)=>{if(e.version!==s)throw new Error("Underlying model has changed, AST is no longer valid");return t.substr(r,n)}))}internalParse(e,s,t){this.scanner.setSource(e),this.token=this.scanner.scan();const r=s.bind(this)();return r&&(r.textProvider=t||((s,t)=>e.substr(s,t))),r}_parseStylesheet(){const e=this.create(nodes.Stylesheet);for(;e.addChild(this._parseStylesheetStart()););let s=!1;do{let t=!1;do{t=!1;const r=this._parseStylesheetStatement();for(r&&(e.addChild(r),t=!0,s=!1,this.peek(cssScanner_1.TokenType.EOF)||!this._needsSemicolonAfter(r)||this.accept(cssScanner_1.TokenType.SemiColon)||this.markError(e,cssErrors_1.ParseError.SemiColonExpected));this.accept(cssScanner_1.TokenType.SemiColon)||this.accept(cssScanner_1.TokenType.CDO)||this.accept(cssScanner_1.TokenType.CDC);)t=!0,s=!1}while(t);if(this.peek(cssScanner_1.TokenType.EOF))break;s||(this.peek(cssScanner_1.TokenType.AtKeyword)?this.markError(e,cssErrors_1.ParseError.UnknownAtRule):this.markError(e,cssErrors_1.ParseError.RuleOrSelectorExpected),s=!0),this.consumeToken()}while(!this.peek(cssScanner_1.TokenType.EOF));return this.finish(e)}_parseStylesheetStart(){return this._parseCharset()}_parseStylesheetStatement(e=!1){return this.peek(cssScanner_1.TokenType.AtKeyword)?this._parseStylesheetAtStatement(e):this._parseRuleset(e)}_parseStylesheetAtStatement(e=!1){return this._parseImport()||this._parseMedia(e)||this._parsePage()||this._parseFontFace()||this._parseKeyframe()||this._parseSupports(e)||this._parseViewPort()||this._parseNamespace()||this._parseDocument()||this._parseUnknownAtRule()}_tryParseRuleset(e){const s=this.mark();if(this._parseSelector(e)){for(;this.accept(cssScanner_1.TokenType.Comma)&&this._parseSelector(e););if(this.accept(cssScanner_1.TokenType.CurlyL))return this.restoreAtMark(s),this._parseRuleset(e)}return this.restoreAtMark(s),null}_parseRuleset(e=!1){const s=this.create(nodes.RuleSet),t=s.getSelectors();if(!t.addChild(this._parseSelector(e)))return null;for(;this.accept(cssScanner_1.TokenType.Comma);)if(!t.addChild(this._parseSelector(e)))return this.finish(s,cssErrors_1.ParseError.SelectorExpected);return this._parseBody(s,this._parseRuleSetDeclaration.bind(this))}_parseRuleSetDeclarationAtStatement(){return this._parseAtApply()||this._parseUnknownAtRule()}_parseRuleSetDeclaration(){return this.peek(cssScanner_1.TokenType.AtKeyword)?this._parseRuleSetDeclarationAtStatement():this._parseDeclaration()}_parseAtApply(){if(!this.peekKeyword("@apply"))return null;const e=this.create(nodes.AtApplyRule);return this.consumeToken(),e.setIdentifier(this._parseIdent([nodes.ReferenceType.Variable]))?this.finish(e):this.finish(e,cssErrors_1.ParseError.IdentifierExpected)}_needsSemicolonAfter(e){switch(e.type){case nodes.NodeType.Keyframe:case nodes.NodeType.ViewPort:case nodes.NodeType.Media:case nodes.NodeType.Ruleset:case nodes.NodeType.Namespace:case nodes.NodeType.If:case nodes.NodeType.For:case nodes.NodeType.Each:case nodes.NodeType.While:case nodes.NodeType.MixinDeclaration:case nodes.NodeType.FunctionDeclaration:case nodes.NodeType.MixinContentDeclaration:return!1;case nodes.NodeType.ExtendsReference:case nodes.NodeType.MixinContentReference:case nodes.NodeType.ReturnStatement:case nodes.NodeType.MediaQuery:case nodes.NodeType.Debug:case nodes.NodeType.Import:case nodes.NodeType.AtApplyRule:case nodes.NodeType.CustomPropertyDeclaration:return!0;case nodes.NodeType.VariableDeclaration:return e.needsSemicolon;case nodes.NodeType.MixinReference:return!e.getContent();case nodes.NodeType.Declaration:return!e.getNestedProperties()}return!1}_parseDeclarations(e){const s=this.create(nodes.Declarations);if(!this.accept(cssScanner_1.TokenType.CurlyL))return null;let t=e();for(;s.addChild(t)&&!this.peek(cssScanner_1.TokenType.CurlyR);){if(this._needsSemicolonAfter(t)&&!this.accept(cssScanner_1.TokenType.SemiColon))return this.finish(s,cssErrors_1.ParseError.SemiColonExpected,[cssScanner_1.TokenType.SemiColon,cssScanner_1.TokenType.CurlyR]);for(t&&this.prevToken&&this.prevToken.type===cssScanner_1.TokenType.SemiColon&&(t.semicolonPosition=this.prevToken.offset);this.accept(cssScanner_1.TokenType.SemiColon););t=e()}return this.accept(cssScanner_1.TokenType.CurlyR)?this.finish(s):this.finish(s,cssErrors_1.ParseError.RightCurlyExpected,[cssScanner_1.TokenType.CurlyR,cssScanner_1.TokenType.SemiColon])}_parseBody(e,s){return e.setDeclarations(this._parseDeclarations(s))?this.finish(e):this.finish(e,cssErrors_1.ParseError.LeftCurlyExpected,[cssScanner_1.TokenType.CurlyR,cssScanner_1.TokenType.SemiColon])}_parseSelector(e){const s=this.create(nodes.Selector);let t=!1;for(e&&(t=s.addChild(this._parseCombinator()));s.addChild(this._parseSimpleSelector());)t=!0,s.addChild(this._parseCombinator());return t?this.finish(s):null}_parseDeclaration(e){const s=this._tryParseCustomPropertyDeclaration(e);if(s)return s;const t=this.create(nodes.Declaration);return t.setProperty(this._parseProperty())?this.accept(cssScanner_1.TokenType.Colon)?(this.prevToken&&(t.colonPosition=this.prevToken.offset),t.setValue(this._parseExpr())?(t.addChild(this._parsePrio()),this.peek(cssScanner_1.TokenType.SemiColon)&&(t.semicolonPosition=this.token.offset),this.finish(t)):this.finish(t,cssErrors_1.ParseError.PropertyValueExpected)):this.finish(t,cssErrors_1.ParseError.ColonExpected,[cssScanner_1.TokenType.Colon],e||[cssScanner_1.TokenType.SemiColon]):null}_tryParseCustomPropertyDeclaration(e){if(!this.peekRegExp(cssScanner_1.TokenType.Ident,/^--/))return null;const s=this.create(nodes.CustomPropertyDeclaration);if(!s.setProperty(this._parseProperty()))return null;if(!this.accept(cssScanner_1.TokenType.Colon))return this.finish(s,cssErrors_1.ParseError.ColonExpected,[cssScanner_1.TokenType.Colon]);this.prevToken&&(s.colonPosition=this.prevToken.offset);const t=this.mark();if(this.peek(cssScanner_1.TokenType.CurlyL)){const e=this.create(nodes.CustomPropertySet),r=this._parseDeclarations(this._parseRuleSetDeclaration.bind(this));if(e.setDeclarations(r)&&!r.isErroneous(!0)&&(e.addChild(this._parsePrio()),this.peek(cssScanner_1.TokenType.SemiColon)))return this.finish(e),s.setPropertySet(e),s.semicolonPosition=this.token.offset,this.finish(s);this.restoreAtMark(t)}const r=this._parseExpr();return r&&!r.isErroneous(!0)&&(this._parsePrio(),this.peekOne(e||[cssScanner_1.TokenType.SemiColon]))?(s.setValue(r),s.semicolonPosition=this.token.offset,this.finish(s)):(this.restoreAtMark(t),s.addChild(this._parseCustomPropertyValue(e)),s.addChild(this._parsePrio()),(0,objects_1.isDefined)(s.colonPosition)&&this.token.offset===s.colonPosition+1?this.finish(s,cssErrors_1.ParseError.PropertyValueExpected):this.finish(s))}_parseCustomPropertyValue(e=[cssScanner_1.TokenType.CurlyR]){const s=this.create(nodes.Node),t=()=>0===n&&0===i&&0===o,r=()=>-1!==e.indexOf(this.token.type);let n=0,i=0,o=0;e:for(;;){switch(this.token.type){case cssScanner_1.TokenType.SemiColon:case cssScanner_1.TokenType.Exclamation:if(t())break e;break;case cssScanner_1.TokenType.CurlyL:n++;break;case cssScanner_1.TokenType.CurlyR:if(n--,n<0){if(r()&&0===i&&0===o)break e;return this.finish(s,cssErrors_1.ParseError.LeftCurlyExpected)}break;case cssScanner_1.TokenType.ParenthesisL:i++;break;case cssScanner_1.TokenType.ParenthesisR:if(i--,i<0){if(r()&&0===o&&0===n)break e;return this.finish(s,cssErrors_1.ParseError.LeftParenthesisExpected)}break;case cssScanner_1.TokenType.BracketL:o++;break;case cssScanner_1.TokenType.BracketR:if(o--,o<0)return this.finish(s,cssErrors_1.ParseError.LeftSquareBracketExpected);break;case cssScanner_1.TokenType.BadString:break e;case cssScanner_1.TokenType.EOF:let e=cssErrors_1.ParseError.RightCurlyExpected;return o>0?e=cssErrors_1.ParseError.RightSquareBracketExpected:i>0&&(e=cssErrors_1.ParseError.RightParenthesisExpected),this.finish(s,e)}this.consumeToken()}return this.finish(s)}_tryToParseDeclaration(e){const s=this.mark();return this._parseProperty()&&this.accept(cssScanner_1.TokenType.Colon)?(this.restoreAtMark(s),this._parseDeclaration(e)):(this.restoreAtMark(s),null)}_parseProperty(){const e=this.create(nodes.Property),s=this.mark();return(this.acceptDelim("*")||this.acceptDelim("_"))&&this.hasWhitespace()?(this.restoreAtMark(s),null):e.setIdentifier(this._parsePropertyIdentifier())?this.finish(e):null}_parsePropertyIdentifier(){return this._parseIdent()}_parseCharset(){if(!this.peek(cssScanner_1.TokenType.Charset))return null;const e=this.create(nodes.Node);return this.consumeToken(),this.accept(cssScanner_1.TokenType.String)?this.accept(cssScanner_1.TokenType.SemiColon)?this.finish(e):this.finish(e,cssErrors_1.ParseError.SemiColonExpected):this.finish(e,cssErrors_1.ParseError.IdentifierExpected)}_parseImport(){if(!this.peekKeyword("@import"))return null;const e=this.create(nodes.Import);return this.consumeToken(),e.addChild(this._parseURILiteral())||e.addChild(this._parseStringLiteral())?(this.peek(cssScanner_1.TokenType.SemiColon)||this.peek(cssScanner_1.TokenType.EOF)||e.setMedialist(this._parseMediaQueryList()),this.finish(e)):this.finish(e,cssErrors_1.ParseError.URIOrStringExpected)}_parseNamespace(){if(!this.peekKeyword("@namespace"))return null;const e=this.create(nodes.Namespace);return this.consumeToken(),e.addChild(this._parseURILiteral())||(e.addChild(this._parseIdent()),e.addChild(this._parseURILiteral())||e.addChild(this._parseStringLiteral()))?this.accept(cssScanner_1.TokenType.SemiColon)?this.finish(e):this.finish(e,cssErrors_1.ParseError.SemiColonExpected):this.finish(e,cssErrors_1.ParseError.URIExpected,[cssScanner_1.TokenType.SemiColon])}_parseFontFace(){if(!this.peekKeyword("@font-face"))return null;const e=this.create(nodes.FontFace);return this.consumeToken(),this._parseBody(e,this._parseRuleSetDeclaration.bind(this))}_parseViewPort(){if(!this.peekKeyword("@-ms-viewport")&&!this.peekKeyword("@-o-viewport")&&!this.peekKeyword("@viewport"))return null;const e=this.create(nodes.ViewPort);return this.consumeToken(),this._parseBody(e,this._parseRuleSetDeclaration.bind(this))}_parseKeyframe(){if(!this.peekRegExp(cssScanner_1.TokenType.AtKeyword,this.keyframeRegex))return null;const e=this.create(nodes.Keyframe),s=this.create(nodes.Node);return this.consumeToken(),e.setKeyword(this.finish(s)),s.matches("@-ms-keyframes")&&this.markError(s,cssErrors_1.ParseError.UnknownKeyword),e.setIdentifier(this._parseKeyframeIdent())?this._parseBody(e,this._parseKeyframeSelector.bind(this)):this.finish(e,cssErrors_1.ParseError.IdentifierExpected,[cssScanner_1.TokenType.CurlyR])}_parseKeyframeIdent(){return this._parseIdent([nodes.ReferenceType.Keyframe])}_parseKeyframeSelector(){const e=this.create(nodes.KeyframeSelector);if(!e.addChild(this._parseIdent())&&!this.accept(cssScanner_1.TokenType.Percentage))return null;for(;this.accept(cssScanner_1.TokenType.Comma);)if(!e.addChild(this._parseIdent())&&!this.accept(cssScanner_1.TokenType.Percentage))return this.finish(e,cssErrors_1.ParseError.PercentageExpected);return this._parseBody(e,this._parseRuleSetDeclaration.bind(this))}_tryParseKeyframeSelector(){const e=this.create(nodes.KeyframeSelector),s=this.mark();if(!e.addChild(this._parseIdent())&&!this.accept(cssScanner_1.TokenType.Percentage))return null;for(;this.accept(cssScanner_1.TokenType.Comma);)if(!e.addChild(this._parseIdent())&&!this.accept(cssScanner_1.TokenType.Percentage))return this.restoreAtMark(s),null;return this.peek(cssScanner_1.TokenType.CurlyL)?this._parseBody(e,this._parseRuleSetDeclaration.bind(this)):(this.restoreAtMark(s),null)}_parseSupports(e=!1){if(!this.peekKeyword("@supports"))return null;const s=this.create(nodes.Supports);return this.consumeToken(),s.addChild(this._parseSupportsCondition()),this._parseBody(s,this._parseSupportsDeclaration.bind(this,e))}_parseSupportsDeclaration(e=!1){return e?this._tryParseRuleset(!0)||this._tryToParseDeclaration()||this._parseStylesheetStatement(!0):this._parseStylesheetStatement(!1)}_parseSupportsCondition(){const e=this.create(nodes.SupportsCondition);if(this.acceptIdent("not"))e.addChild(this._parseSupportsConditionInParens());else if(e.addChild(this._parseSupportsConditionInParens()),this.peekRegExp(cssScanner_1.TokenType.Ident,/^(and|or)$/i)){const s=this.token.text.toLowerCase();for(;this.acceptIdent(s);)e.addChild(this._parseSupportsConditionInParens())}return this.finish(e)}_parseSupportsConditionInParens(){const e=this.create(nodes.SupportsCondition);if(this.accept(cssScanner_1.TokenType.ParenthesisL))return this.prevToken&&(e.lParent=this.prevToken.offset),e.addChild(this._tryToParseDeclaration([cssScanner_1.TokenType.ParenthesisR]))||this._parseSupportsCondition()?this.accept(cssScanner_1.TokenType.ParenthesisR)?(this.prevToken&&(e.rParent=this.prevToken.offset),this.finish(e)):this.finish(e,cssErrors_1.ParseError.RightParenthesisExpected,[cssScanner_1.TokenType.ParenthesisR],[]):this.finish(e,cssErrors_1.ParseError.ConditionExpected);if(this.peek(cssScanner_1.TokenType.Ident)){const s=this.mark();if(this.consumeToken(),!this.hasWhitespace()&&this.accept(cssScanner_1.TokenType.ParenthesisL)){let s=1;for(;this.token.type!==cssScanner_1.TokenType.EOF&&0!==s;)this.token.type===cssScanner_1.TokenType.ParenthesisL?s++:this.token.type===cssScanner_1.TokenType.ParenthesisR&&s--,this.consumeToken();return this.finish(e)}this.restoreAtMark(s)}return this.finish(e,cssErrors_1.ParseError.LeftParenthesisExpected,[],[cssScanner_1.TokenType.ParenthesisL])}_parseMediaDeclaration(e=!1){return e?this._tryParseRuleset(!0)||this._tryToParseDeclaration()||this._parseStylesheetStatement(!0):this._parseStylesheetStatement(!1)}_parseMedia(e=!1){if(!this.peekKeyword("@media"))return null;const s=this.create(nodes.Media);return this.consumeToken(),s.addChild(this._parseMediaQueryList())?this._parseBody(s,this._parseMediaDeclaration.bind(this,e)):this.finish(s,cssErrors_1.ParseError.MediaQueryExpected)}_parseMediaQueryList(){const e=this.create(nodes.Medialist);if(!e.addChild(this._parseMediaQuery([cssScanner_1.TokenType.CurlyL])))return this.finish(e,cssErrors_1.ParseError.MediaQueryExpected);for(;this.accept(cssScanner_1.TokenType.Comma);)if(!e.addChild(this._parseMediaQuery([cssScanner_1.TokenType.CurlyL])))return this.finish(e,cssErrors_1.ParseError.MediaQueryExpected);return this.finish(e)}_parseMediaQuery(e){const s=this.create(nodes.MediaQuery);let t=!0,r=!1;if(!this.peek(cssScanner_1.TokenType.ParenthesisL)){if(this.acceptIdent("only")||this.acceptIdent("not"),!s.addChild(this._parseIdent()))return null;r=!0,t=this.acceptIdent("and")}for(;t;)if(s.addChild(this._parseMediaContentStart()))t=this.acceptIdent("and");else{if(!this.accept(cssScanner_1.TokenType.ParenthesisL))return r?this.finish(s,cssErrors_1.ParseError.LeftParenthesisExpected,[],e):null;if(!s.addChild(this._parseMediaFeatureName()))return this.finish(s,cssErrors_1.ParseError.IdentifierExpected,[],e);if(this.accept(cssScanner_1.TokenType.Colon)&&!s.addChild(this._parseExpr()))return this.finish(s,cssErrors_1.ParseError.TermExpected,[],e);if(!this.accept(cssScanner_1.TokenType.ParenthesisR))return this.finish(s,cssErrors_1.ParseError.RightParenthesisExpected,[],e);t=this.acceptIdent("and")}return this.finish(s)}_parseMediaContentStart(){return null}_parseMediaFeatureName(){return this._parseIdent()}_parseMedium(){const e=this.create(nodes.Node);return e.addChild(this._parseIdent())?this.finish(e):null}_parsePageDeclaration(){return this._parsePageMarginBox()||this._parseRuleSetDeclaration()}_parsePage(){if(!this.peekKeyword("@page"))return null;const e=this.create(nodes.Page);if(this.consumeToken(),e.addChild(this._parsePageSelector()))for(;this.accept(cssScanner_1.TokenType.Comma);)if(!e.addChild(this._parsePageSelector()))return this.finish(e,cssErrors_1.ParseError.IdentifierExpected);return this._parseBody(e,this._parsePageDeclaration.bind(this))}_parsePageMarginBox(){if(!this.peek(cssScanner_1.TokenType.AtKeyword))return null;const e=this.create(nodes.PageBoxMarginBox);return this.acceptOneKeyword(languageFacts.pageBoxDirectives)||this.markError(e,cssErrors_1.ParseError.UnknownAtRule,[],[cssScanner_1.TokenType.CurlyL]),this._parseBody(e,this._parseRuleSetDeclaration.bind(this))}_parsePageSelector(){if(!this.peek(cssScanner_1.TokenType.Ident)&&!this.peek(cssScanner_1.TokenType.Colon))return null;const e=this.create(nodes.Node);return e.addChild(this._parseIdent()),this.accept(cssScanner_1.TokenType.Colon)&&!e.addChild(this._parseIdent())?this.finish(e,cssErrors_1.ParseError.IdentifierExpected):this.finish(e)}_parseDocument(){if(!this.peekKeyword("@-moz-document"))return null;const e=this.create(nodes.Document);return this.consumeToken(),this.resync([],[cssScanner_1.TokenType.CurlyL]),this._parseBody(e,this._parseStylesheetStatement.bind(this))}_parseUnknownAtRule(){if(!this.peek(cssScanner_1.TokenType.AtKeyword))return null;const e=this.create(nodes.UnknownAtRule);e.addChild(this._parseUnknownAtRuleName());let s=0,t=0,r=0,n=0;e:for(;;){switch(this.token.type){case cssScanner_1.TokenType.SemiColon:if(0===t&&0===r&&0===n)break e;break;case cssScanner_1.TokenType.EOF:return t>0?this.finish(e,cssErrors_1.ParseError.RightCurlyExpected):n>0?this.finish(e,cssErrors_1.ParseError.RightSquareBracketExpected):r>0?this.finish(e,cssErrors_1.ParseError.RightParenthesisExpected):this.finish(e);case cssScanner_1.TokenType.CurlyL:s++,t++;break;case cssScanner_1.TokenType.CurlyR:if(t--,s>0&&0===t){if(this.consumeToken(),n>0)return this.finish(e,cssErrors_1.ParseError.RightSquareBracketExpected);if(r>0)return this.finish(e,cssErrors_1.ParseError.RightParenthesisExpected);break e}if(t<0){if(0===r&&0===n)break e;return this.finish(e,cssErrors_1.ParseError.LeftCurlyExpected)}break;case cssScanner_1.TokenType.ParenthesisL:r++;break;case cssScanner_1.TokenType.ParenthesisR:if(r--,r<0)return this.finish(e,cssErrors_1.ParseError.LeftParenthesisExpected);break;case cssScanner_1.TokenType.BracketL:n++;break;case cssScanner_1.TokenType.BracketR:if(n--,n<0)return this.finish(e,cssErrors_1.ParseError.LeftSquareBracketExpected)}this.consumeToken()}return e}_parseUnknownAtRuleName(){const e=this.create(nodes.Node);return this.accept(cssScanner_1.TokenType.AtKeyword)?this.finish(e):e}_parseOperator(){if(this.peekDelim("/")||this.peekDelim("*")||this.peekDelim("+")||this.peekDelim("-")||this.peek(cssScanner_1.TokenType.Dashmatch)||this.peek(cssScanner_1.TokenType.Includes)||this.peek(cssScanner_1.TokenType.SubstringOperator)||this.peek(cssScanner_1.TokenType.PrefixOperator)||this.peek(cssScanner_1.TokenType.SuffixOperator)||this.peekDelim("=")){const e=this.createNode(nodes.NodeType.Operator);return this.consumeToken(),this.finish(e)}return null}_parseUnaryOperator(){if(!this.peekDelim("+")&&!this.peekDelim("-"))return null;const e=this.create(nodes.Node);return this.consumeToken(),this.finish(e)}_parseCombinator(){if(this.peekDelim(">")){const e=this.create(nodes.Node);this.consumeToken();const s=this.mark();if(!this.hasWhitespace()&&this.acceptDelim(">")){if(!this.hasWhitespace()&&this.acceptDelim(">"))return e.type=nodes.NodeType.SelectorCombinatorShadowPiercingDescendant,this.finish(e);this.restoreAtMark(s)}return e.type=nodes.NodeType.SelectorCombinatorParent,this.finish(e)}if(this.peekDelim("+")){const e=this.create(nodes.Node);return this.consumeToken(),e.type=nodes.NodeType.SelectorCombinatorSibling,this.finish(e)}if(this.peekDelim("~")){const e=this.create(nodes.Node);return this.consumeToken(),e.type=nodes.NodeType.SelectorCombinatorAllSiblings,this.finish(e)}if(this.peekDelim("/")){const e=this.create(nodes.Node);this.consumeToken();const s=this.mark();if(!this.hasWhitespace()&&this.acceptIdent("deep")&&!this.hasWhitespace()&&this.acceptDelim("/"))return e.type=nodes.NodeType.SelectorCombinatorShadowPiercingDescendant,this.finish(e);this.restoreAtMark(s)}return null}_parseSimpleSelector(){const e=this.create(nodes.SimpleSelector);let s=0;for(e.addChild(this._parseElementName())&&s++;(0===s||!this.hasWhitespace())&&e.addChild(this._parseSimpleSelectorBody());)s++;return s>0?this.finish(e):null}_parseSimpleSelectorBody(){return this._parsePseudo()||this._parseHash()||this._parseClass()||this._parseAttrib()}_parseSelectorIdent(){return this._parseIdent()}_parseHash(){if(!this.peek(cssScanner_1.TokenType.Hash)&&!this.peekDelim("#"))return null;const e=this.createNode(nodes.NodeType.IdentifierSelector);if(this.acceptDelim("#")){if(this.hasWhitespace()||!e.addChild(this._parseSelectorIdent()))return this.finish(e,cssErrors_1.ParseError.IdentifierExpected)}else this.consumeToken();return this.finish(e)}_parseClass(){if(!this.peekDelim("."))return null;const e=this.createNode(nodes.NodeType.ClassSelector);return this.consumeToken(),this.hasWhitespace()||!e.addChild(this._parseSelectorIdent())?this.finish(e,cssErrors_1.ParseError.IdentifierExpected):this.finish(e)}_parseElementName(){const e=this.mark(),s=this.createNode(nodes.NodeType.ElementNameSelector);return s.addChild(this._parseNamespacePrefix()),s.addChild(this._parseSelectorIdent())||this.acceptDelim("*")?this.finish(s):(this.restoreAtMark(e),null)}_parseNamespacePrefix(){const e=this.mark(),s=this.createNode(nodes.NodeType.NamespacePrefix);return!s.addChild(this._parseIdent())&&this.acceptDelim("*"),this.acceptDelim("|")?this.finish(s):(this.restoreAtMark(e),null)}_parseAttrib(){if(!this.peek(cssScanner_1.TokenType.BracketL))return null;const e=this.create(nodes.AttributeSelector);return this.consumeToken(),e.setNamespacePrefix(this._parseNamespacePrefix()),e.setIdentifier(this._parseIdent())?(e.setOperator(this._parseOperator())&&(e.setValue(this._parseBinaryExpr()),this.acceptIdent("i")),this.accept(cssScanner_1.TokenType.BracketR)?this.finish(e):this.finish(e,cssErrors_1.ParseError.RightSquareBracketExpected)):this.finish(e,cssErrors_1.ParseError.IdentifierExpected)}_parsePseudo(){const e=this._tryParsePseudoIdentifier();if(e){if(!this.hasWhitespace()&&this.accept(cssScanner_1.TokenType.ParenthesisL)){const s=()=>{const e=this.create(nodes.Node);if(!e.addChild(this._parseSelector(!1)))return null;for(;this.accept(cssScanner_1.TokenType.Comma)&&e.addChild(this._parseSelector(!1)););return this.peek(cssScanner_1.TokenType.ParenthesisR)?this.finish(e):null};if(e.addChild(this.try(s)||this._parseBinaryExpr()),!this.accept(cssScanner_1.TokenType.ParenthesisR))return this.finish(e,cssErrors_1.ParseError.RightParenthesisExpected)}return this.finish(e)}return null}_tryParsePseudoIdentifier(){if(!this.peek(cssScanner_1.TokenType.Colon))return null;const e=this.mark(),s=this.createNode(nodes.NodeType.PseudoSelector);return this.consumeToken(),this.hasWhitespace()?(this.restoreAtMark(e),null):(this.accept(cssScanner_1.TokenType.Colon),this.hasWhitespace()||!s.addChild(this._parseIdent())?this.finish(s,cssErrors_1.ParseError.IdentifierExpected):this.finish(s))}_tryParsePrio(){const e=this.mark(),s=this._parsePrio();return s||(this.restoreAtMark(e),null)}_parsePrio(){if(!this.peek(cssScanner_1.TokenType.Exclamation))return null;const e=this.createNode(nodes.NodeType.Prio);return this.accept(cssScanner_1.TokenType.Exclamation)&&this.acceptIdent("important")?this.finish(e):null}_parseExpr(e=!1){const s=this.create(nodes.Expression);if(!s.addChild(this._parseBinaryExpr()))return null;for(;;){if(this.peek(cssScanner_1.TokenType.Comma)){if(e)return this.finish(s);this.consumeToken()}if(!s.addChild(this._parseBinaryExpr()))break}return this.finish(s)}_parseNamedLine(){if(!this.peek(cssScanner_1.TokenType.BracketL))return null;const e=this.createNode(nodes.NodeType.GridLine);for(this.consumeToken();e.addChild(this._parseIdent()););return this.accept(cssScanner_1.TokenType.BracketR)?this.finish(e):this.finish(e,cssErrors_1.ParseError.RightSquareBracketExpected)}_parseBinaryExpr(e,s){let t=this.create(nodes.BinaryExpression);if(!t.setLeft(e||this._parseTerm()))return null;if(!t.setOperator(s||this._parseOperator()))return this.finish(t);if(!t.setRight(this._parseTerm()))return this.finish(t,cssErrors_1.ParseError.TermExpected);t=this.finish(t);const r=this._parseOperator();return r&&(t=this._parseBinaryExpr(t,r)),this.finish(t)}_parseTerm(){let e=this.create(nodes.Term);return e.setOperator(this._parseUnaryOperator()),e.setExpression(this._parseTermExpression())?this.finish(e):null}_parseTermExpression(){return this._parseURILiteral()||this._parseFunction()||this._parseIdent()||this._parseStringLiteral()||this._parseNumeric()||this._parseHexColor()||this._parseOperation()||this._parseNamedLine()}_parseOperation(){if(!this.peek(cssScanner_1.TokenType.ParenthesisL))return null;const e=this.create(nodes.Node);return this.consumeToken(),e.addChild(this._parseExpr()),this.accept(cssScanner_1.TokenType.ParenthesisR)?this.finish(e):this.finish(e,cssErrors_1.ParseError.RightParenthesisExpected)}_parseNumeric(){if(this.peek(cssScanner_1.TokenType.Num)||this.peek(cssScanner_1.TokenType.Percentage)||this.peek(cssScanner_1.TokenType.Resolution)||this.peek(cssScanner_1.TokenType.Length)||this.peek(cssScanner_1.TokenType.EMS)||this.peek(cssScanner_1.TokenType.EXS)||this.peek(cssScanner_1.TokenType.Angle)||this.peek(cssScanner_1.TokenType.Time)||this.peek(cssScanner_1.TokenType.Dimension)||this.peek(cssScanner_1.TokenType.Freq)){const e=this.create(nodes.NumericValue);return this.consumeToken(),this.finish(e)}return null}_parseStringLiteral(){if(!this.peek(cssScanner_1.TokenType.String)&&!this.peek(cssScanner_1.TokenType.BadString))return null;const e=this.createNode(nodes.NodeType.StringLiteral);return this.consumeToken(),this.finish(e)}_parseURILiteral(){if(!this.peekRegExp(cssScanner_1.TokenType.Ident,/^url(-prefix)?$/i))return null;const e=this.mark(),s=this.createNode(nodes.NodeType.URILiteral);return this.accept(cssScanner_1.TokenType.Ident),this.hasWhitespace()||!this.peek(cssScanner_1.TokenType.ParenthesisL)?(this.restoreAtMark(e),null):(this.scanner.inURL=!0,this.consumeToken(),s.addChild(this._parseURLArgument()),this.scanner.inURL=!1,this.accept(cssScanner_1.TokenType.ParenthesisR)?this.finish(s):this.finish(s,cssErrors_1.ParseError.RightParenthesisExpected))}_parseURLArgument(){const e=this.create(nodes.Node);return this.accept(cssScanner_1.TokenType.String)||this.accept(cssScanner_1.TokenType.BadString)||this.acceptUnquotedString()?this.finish(e):null}_parseIdent(e){if(!this.peek(cssScanner_1.TokenType.Ident))return null;const s=this.create(nodes.Identifier);return e&&(s.referenceTypes=e),s.isCustomProperty=this.peekRegExp(cssScanner_1.TokenType.Ident,/^--/),this.consumeToken(),this.finish(s)}_parseFunction(){const e=this.mark(),s=this.create(nodes.Function);if(!s.setIdentifier(this._parseFunctionIdentifier()))return null;if(this.hasWhitespace()||!this.accept(cssScanner_1.TokenType.ParenthesisL))return this.restoreAtMark(e),null;if(s.getArguments().addChild(this._parseFunctionArgument()))for(;this.accept(cssScanner_1.TokenType.Comma)&&!this.peek(cssScanner_1.TokenType.ParenthesisR);)s.getArguments().addChild(this._parseFunctionArgument())||this.markError(s,cssErrors_1.ParseError.ExpressionExpected);return this.accept(cssScanner_1.TokenType.ParenthesisR)?this.finish(s):this.finish(s,cssErrors_1.ParseError.RightParenthesisExpected)}_parseFunctionIdentifier(){if(!this.peek(cssScanner_1.TokenType.Ident))return null;const e=this.create(nodes.Identifier);if(e.referenceTypes=[nodes.ReferenceType.Function],this.acceptIdent("progid")){if(this.accept(cssScanner_1.TokenType.Colon))for(;this.accept(cssScanner_1.TokenType.Ident)&&this.acceptDelim("."););return this.finish(e)}return this.consumeToken(),this.finish(e)}_parseFunctionArgument(){const e=this.create(nodes.FunctionArgument);return e.setValue(this._parseExpr(!0))?this.finish(e):null}_parseHexColor(){if(this.peekRegExp(cssScanner_1.TokenType.Hash,/^#([A-Fa-f0-9]{3}|[A-Fa-f0-9]{4}|[A-Fa-f0-9]{6}|[A-Fa-f0-9]{8})$/g)){const e=this.create(nodes.HexColorValue);return this.consumeToken(),this.finish(e)}return null}}exports.Parser=Parser;
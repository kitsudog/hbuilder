"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,s,t,r){void 0===r&&(r=t);var i=Object.getOwnPropertyDescriptor(s,t);i&&!("get"in i?!s.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return s[t]}}),Object.defineProperty(e,r,i)}:function(e,s,t,r){void 0===r&&(r=t),e[r]=s[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,s){Object.defineProperty(e,"default",{enumerable:!0,value:s})}:function(e,s){e.default=s}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var s={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(s,e,t);return __setModuleDefault(s,e),s};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LESSParser=void 0;const lessScanner=__importStar(require("./lessScanner")),cssScanner_1=require("./cssScanner"),cssParser=__importStar(require("./cssParser")),nodes=__importStar(require("./cssNodes")),cssErrors_1=require("./cssErrors");class LESSParser extends cssParser.Parser{constructor(){super(new lessScanner.LESSScanner)}_parseStylesheetStatement(e=!1){return this.peek(cssScanner_1.TokenType.AtKeyword)?this._parseVariableDeclaration()||this._parsePlugin()||super._parseStylesheetAtStatement(e):this._tryParseMixinDeclaration()||this._tryParseMixinReference()||this._parseFunction()||this._parseRuleset(!0)}_parseImport(){if(!this.peekKeyword("@import")&&!this.peekKeyword("@import-once"))return null;const e=this.create(nodes.Import);if(this.consumeToken(),this.accept(cssScanner_1.TokenType.ParenthesisL)){if(!this.accept(cssScanner_1.TokenType.Ident))return this.finish(e,cssErrors_1.ParseError.IdentifierExpected,[cssScanner_1.TokenType.SemiColon]);do{if(!this.accept(cssScanner_1.TokenType.Comma))break}while(this.accept(cssScanner_1.TokenType.Ident));if(!this.accept(cssScanner_1.TokenType.ParenthesisR))return this.finish(e,cssErrors_1.ParseError.RightParenthesisExpected,[cssScanner_1.TokenType.SemiColon])}return e.addChild(this._parseURILiteral())||e.addChild(this._parseStringLiteral())?(this.peek(cssScanner_1.TokenType.SemiColon)||this.peek(cssScanner_1.TokenType.EOF)||e.setMedialist(this._parseMediaQueryList()),this.finish(e)):this.finish(e,cssErrors_1.ParseError.URIOrStringExpected,[cssScanner_1.TokenType.SemiColon])}_parsePlugin(){if(!this.peekKeyword("@plugin"))return null;const e=this.createNode(nodes.NodeType.Plugin);return this.consumeToken(),e.addChild(this._parseStringLiteral())?this.accept(cssScanner_1.TokenType.SemiColon)?this.finish(e):this.finish(e,cssErrors_1.ParseError.SemiColonExpected):this.finish(e,cssErrors_1.ParseError.StringLiteralExpected)}_parseMediaQuery(e){const s=super._parseMediaQuery(e);if(!s){const e=this.create(nodes.MediaQuery);return e.addChild(this._parseVariable())?this.finish(e):null}return s}_parseMediaDeclaration(e=!1){return this._tryParseRuleset(e)||this._tryToParseDeclaration()||this._tryParseMixinDeclaration()||this._tryParseMixinReference()||this._parseDetachedRuleSetMixin()||this._parseStylesheetStatement(e)}_parseMediaFeatureName(){return this._parseIdent()||this._parseVariable()}_parseVariableDeclaration(e=[]){const s=this.create(nodes.VariableDeclaration),t=this.mark();if(!s.setVariable(this._parseVariable(!0)))return null;if(!this.accept(cssScanner_1.TokenType.Colon))return this.restoreAtMark(t),null;if(this.prevToken&&(s.colonPosition=this.prevToken.offset),s.setValue(this._parseDetachedRuleSet()))s.needsSemicolon=!1;else if(!s.setValue(this._parseExpr()))return this.finish(s,cssErrors_1.ParseError.VariableValueExpected,[],e);return s.addChild(this._parsePrio()),this.peek(cssScanner_1.TokenType.SemiColon)&&(s.semicolonPosition=this.token.offset),this.finish(s)}_parseDetachedRuleSet(){let e=this.mark();if(this.peekDelim("#")||this.peekDelim(".")){if(this.consumeToken(),this.hasWhitespace()||!this.accept(cssScanner_1.TokenType.ParenthesisL))return this.restoreAtMark(e),null;{let s=this.create(nodes.MixinDeclaration);if(s.getParameters().addChild(this._parseMixinParameter()))for(;(this.accept(cssScanner_1.TokenType.Comma)||this.accept(cssScanner_1.TokenType.SemiColon))&&!this.peek(cssScanner_1.TokenType.ParenthesisR);)s.getParameters().addChild(this._parseMixinParameter())||this.markError(s,cssErrors_1.ParseError.IdentifierExpected,[],[cssScanner_1.TokenType.ParenthesisR]);if(!this.accept(cssScanner_1.TokenType.ParenthesisR))return this.restoreAtMark(e),null}}if(!this.peek(cssScanner_1.TokenType.CurlyL))return null;const s=this.create(nodes.BodyDeclaration);return this._parseBody(s,this._parseDetachedRuleSetBody.bind(this)),this.finish(s)}_parseDetachedRuleSetBody(){return this._tryParseKeyframeSelector()||this._parseRuleSetDeclaration()}_addLookupChildren(e){if(!e.addChild(this._parseLookupValue()))return!1;let s=!1;for(;this.peek(cssScanner_1.TokenType.BracketL)&&(s=!0),e.addChild(this._parseLookupValue());)s=!1;return!s}_parseLookupValue(){const e=this.create(nodes.Node),s=this.mark();return this.accept(cssScanner_1.TokenType.BracketL)&&((e.addChild(this._parseVariable(!1,!0))||e.addChild(this._parsePropertyIdentifier()))&&this.accept(cssScanner_1.TokenType.BracketR)||this.accept(cssScanner_1.TokenType.BracketR))?e:(this.restoreAtMark(s),null)}_parseVariable(e=!1,s=!1){const t=!e&&this.peekDelim("$");if(!this.peekDelim("@")&&!t&&!this.peek(cssScanner_1.TokenType.AtKeyword))return null;const r=this.create(nodes.Variable),i=this.mark();for(;this.acceptDelim("@")||!e&&this.acceptDelim("$");)if(this.hasWhitespace())return this.restoreAtMark(i),null;return(this.accept(cssScanner_1.TokenType.AtKeyword)||this.accept(cssScanner_1.TokenType.Ident))&&(s||!this.peek(cssScanner_1.TokenType.BracketL)||this._addLookupChildren(r))?r:(this.restoreAtMark(i),null)}_parseTermExpression(){return this._parseVariable()||this._parseEscaped()||super._parseTermExpression()||this._tryParseMixinReference(!1)}_parseEscaped(){if(this.peek(cssScanner_1.TokenType.EscapedJavaScript)||this.peek(cssScanner_1.TokenType.BadEscapedJavaScript)){const e=this.createNode(nodes.NodeType.EscapedValue);return this.consumeToken(),this.finish(e)}if(this.peekDelim("~")){const e=this.createNode(nodes.NodeType.EscapedValue);return this.consumeToken(),this.accept(cssScanner_1.TokenType.String)||this.accept(cssScanner_1.TokenType.EscapedJavaScript)?this.finish(e):this.finish(e,cssErrors_1.ParseError.TermExpected)}return null}_parseOperator(){const e=this._parseGuardOperator();return e||super._parseOperator()}_parseGuardOperator(){if(this.peekDelim(">")){const e=this.createNode(nodes.NodeType.Operator);return this.consumeToken(),this.acceptDelim("="),e}if(this.peekDelim("=")){const e=this.createNode(nodes.NodeType.Operator);return this.consumeToken(),this.acceptDelim("<"),e}if(this.peekDelim("<")){const e=this.createNode(nodes.NodeType.Operator);return this.consumeToken(),this.acceptDelim("="),e}return null}_parseRuleSetDeclaration(){return this.peek(cssScanner_1.TokenType.AtKeyword)?this._parseKeyframe()||this._parseMedia(!0)||this._parseImport()||this._parseSupports(!0)||this._parseDetachedRuleSetMixin()||this._parseVariableDeclaration()||super._parseRuleSetDeclarationAtStatement():this._tryParseMixinDeclaration()||this._tryParseRuleset(!0)||this._tryParseMixinReference()||this._parseFunction()||this._parseExtend()||super._parseRuleSetDeclaration()}_parseKeyframeIdent(){return this._parseIdent([nodes.ReferenceType.Keyframe])||this._parseVariable()}_parseKeyframeSelector(){return this._parseDetachedRuleSetMixin()||super._parseKeyframeSelector()}_parseSimpleSelectorBody(){return this._parseSelectorCombinator()||super._parseSimpleSelectorBody()}_parseSelector(e){const s=this.create(nodes.Selector);let t=!1;for(e&&(t=s.addChild(this._parseCombinator()));s.addChild(this._parseSimpleSelector());){t=!0;const e=this.mark();if(s.addChild(this._parseGuard())&&this.peek(cssScanner_1.TokenType.CurlyL))break;this.restoreAtMark(e),s.addChild(this._parseCombinator())}return t?this.finish(s):null}_parseSelectorCombinator(){if(this.peekDelim("&")){const e=this.createNode(nodes.NodeType.SelectorCombinator);for(this.consumeToken();!this.hasWhitespace()&&(this.acceptDelim("-")||this.accept(cssScanner_1.TokenType.Num)||this.accept(cssScanner_1.TokenType.Dimension)||e.addChild(this._parseIdent())||this.acceptDelim("&")););return this.finish(e)}return null}_parseSelectorIdent(){if(!this.peekInterpolatedIdent())return null;const e=this.createNode(nodes.NodeType.SelectorInterpolation);return this._acceptInterpolatedIdent(e)?this.finish(e):null}_parsePropertyIdentifier(e=!1){const s=/^[\w-]+/;if(!this.peekInterpolatedIdent()&&!this.peekRegExp(this.token.type,s))return null;const t=this.mark(),r=this.create(nodes.Identifier);r.isCustomProperty=this.acceptDelim("-")&&this.acceptDelim("-");let i=!1;return i=e?r.isCustomProperty?r.addChild(this._parseIdent()):r.addChild(this._parseRegexp(s)):r.isCustomProperty?this._acceptInterpolatedIdent(r):this._acceptInterpolatedIdent(r,s),i?(e||this.hasWhitespace()||(this.acceptDelim("+"),this.hasWhitespace()||this.acceptIdent("_")),this.finish(r)):(this.restoreAtMark(t),null)}peekInterpolatedIdent(){return this.peek(cssScanner_1.TokenType.Ident)||this.peekDelim("@")||this.peekDelim("$")||this.peekDelim("-")}_acceptInterpolatedIdent(e,s){let t=!1;const r=()=>{const e=this.mark();return this.acceptDelim("-")&&(this.hasWhitespace()||this.acceptDelim("-"),this.hasWhitespace())?(this.restoreAtMark(e),null):this._parseInterpolation()},i=s?()=>this.acceptRegexp(s):()=>this.accept(cssScanner_1.TokenType.Ident);for(;(i()||e.addChild(this._parseInterpolation()||this.try(r)))&&(t=!0,!this.hasWhitespace()););return t}_parseInterpolation(){const e=this.mark();if(this.peekDelim("@")||this.peekDelim("$")){const s=this.createNode(nodes.NodeType.Interpolation);return this.consumeToken(),this.hasWhitespace()||!this.accept(cssScanner_1.TokenType.CurlyL)?(this.restoreAtMark(e),null):s.addChild(this._parseIdent())?this.accept(cssScanner_1.TokenType.CurlyR)?this.finish(s):this.finish(s,cssErrors_1.ParseError.RightCurlyExpected):this.finish(s,cssErrors_1.ParseError.IdentifierExpected)}return null}_tryParseMixinDeclaration(){const e=this.mark(),s=this.create(nodes.MixinDeclaration);if(!s.setIdentifier(this._parseMixinDeclarationIdentifier())||!this.accept(cssScanner_1.TokenType.ParenthesisL))return this.restoreAtMark(e),null;if(s.getParameters().addChild(this._parseMixinParameter()))for(;(this.accept(cssScanner_1.TokenType.Comma)||this.accept(cssScanner_1.TokenType.SemiColon))&&!this.peek(cssScanner_1.TokenType.ParenthesisR);)s.getParameters().addChild(this._parseMixinParameter())||this.markError(s,cssErrors_1.ParseError.IdentifierExpected,[],[cssScanner_1.TokenType.ParenthesisR]);return this.accept(cssScanner_1.TokenType.ParenthesisR)?(s.setGuard(this._parseGuard()),this.peek(cssScanner_1.TokenType.CurlyL)?this._parseBody(s,this._parseMixInBodyDeclaration.bind(this)):(this.restoreAtMark(e),null)):(this.restoreAtMark(e),null)}_parseMixInBodyDeclaration(){return this._parseFontFace()||this._parseRuleSetDeclaration()}_parseMixinDeclarationIdentifier(){let e;if(this.peekDelim("#")||this.peekDelim(".")){if(e=this.create(nodes.Identifier),this.consumeToken(),this.hasWhitespace()||!e.addChild(this._parseIdent()))return null}else{if(!this.peek(cssScanner_1.TokenType.Hash))return null;e=this.create(nodes.Identifier),this.consumeToken()}return e.referenceTypes=[nodes.ReferenceType.Mixin],this.finish(e)}_parsePseudo(){if(!this.peek(cssScanner_1.TokenType.Colon))return null;const e=this.mark(),s=this.create(nodes.ExtendsReference);return this.consumeToken(),this.acceptIdent("extend")?this._completeExtends(s):(this.restoreAtMark(e),super._parsePseudo())}_parseExtend(){if(!this.peekDelim("&"))return null;const e=this.mark(),s=this.create(nodes.ExtendsReference);return this.consumeToken(),!this.hasWhitespace()&&this.accept(cssScanner_1.TokenType.Colon)&&this.acceptIdent("extend")?this._completeExtends(s):(this.restoreAtMark(e),null)}_completeExtends(e){if(!this.accept(cssScanner_1.TokenType.ParenthesisL))return this.finish(e,cssErrors_1.ParseError.LeftParenthesisExpected);const s=e.getSelectors();if(!s.addChild(this._parseSelector(!0)))return this.finish(e,cssErrors_1.ParseError.SelectorExpected);for(;this.accept(cssScanner_1.TokenType.Comma);)if(!s.addChild(this._parseSelector(!0)))return this.finish(e,cssErrors_1.ParseError.SelectorExpected);return this.accept(cssScanner_1.TokenType.ParenthesisR)?this.finish(e):this.finish(e,cssErrors_1.ParseError.RightParenthesisExpected)}_parseDetachedRuleSetMixin(){if(!this.peek(cssScanner_1.TokenType.AtKeyword))return null;const e=this.mark(),s=this.create(nodes.MixinReference);return!s.addChild(this._parseVariable(!0))||!this.hasWhitespace()&&this.accept(cssScanner_1.TokenType.ParenthesisL)?this.accept(cssScanner_1.TokenType.ParenthesisR)?this.finish(s):this.finish(s,cssErrors_1.ParseError.RightParenthesisExpected):(this.restoreAtMark(e),null)}_tryParseMixinReference(e=!0){const s=this.mark(),t=this.create(nodes.MixinReference);let r=this._parseMixinDeclarationIdentifier();for(;r;){this.acceptDelim(">");const e=this._parseMixinDeclarationIdentifier();if(!e)break;t.getNamespaces().addChild(r),r=e}if(!t.setIdentifier(r))return this.restoreAtMark(s),null;let i=!1;if(this.accept(cssScanner_1.TokenType.ParenthesisL)){if(i=!0,t.getArguments().addChild(this._parseMixinArgument()))for(;(this.accept(cssScanner_1.TokenType.Comma)||this.accept(cssScanner_1.TokenType.SemiColon))&&!this.peek(cssScanner_1.TokenType.ParenthesisR);)if(!t.getArguments().addChild(this._parseMixinArgument()))return this.finish(t,cssErrors_1.ParseError.ExpressionExpected);if(!this.accept(cssScanner_1.TokenType.ParenthesisR))return this.finish(t,cssErrors_1.ParseError.RightParenthesisExpected);r.referenceTypes=[nodes.ReferenceType.Mixin]}else r.referenceTypes=[nodes.ReferenceType.Mixin,nodes.ReferenceType.Rule];return this.peek(cssScanner_1.TokenType.BracketL)?e||this._addLookupChildren(t):t.addChild(this._parsePrio()),i||this.peek(cssScanner_1.TokenType.SemiColon)||this.peek(cssScanner_1.TokenType.CurlyR)||this.peek(cssScanner_1.TokenType.EOF)?this.finish(t):(this.restoreAtMark(s),null)}_parseMixinArgument(){const e=this.create(nodes.FunctionArgument),s=this.mark(),t=this._parseVariable();return t&&(this.accept(cssScanner_1.TokenType.Colon)?e.setIdentifier(t):this.restoreAtMark(s)),e.setValue(this._parseDetachedRuleSet()||this._parseExpr(!0))?this.finish(e):(this.restoreAtMark(s),null)}_parseMixinParameter(){const e=this.create(nodes.FunctionParameter);if(this.peekKeyword("@rest")){const s=this.create(nodes.Node);return this.consumeToken(),this.accept(lessScanner.Ellipsis)?(e.setIdentifier(this.finish(s)),this.finish(e)):this.finish(e,cssErrors_1.ParseError.DotExpected,[],[cssScanner_1.TokenType.Comma,cssScanner_1.TokenType.ParenthesisR])}if(this.peek(lessScanner.Ellipsis)){const s=this.create(nodes.Node);return this.consumeToken(),e.setIdentifier(this.finish(s)),this.finish(e)}let s=!1;return e.setIdentifier(this._parseVariable())&&(this.accept(cssScanner_1.TokenType.Colon),s=!0),e.setDefaultValue(this._parseDetachedRuleSet()||this._parseExpr(!0))||s?this.finish(e):null}_parseGuard(){if(!this.peekIdent("when"))return null;const e=this.create(nodes.LessGuard);if(this.consumeToken(),e.isNegated=this.acceptIdent("not"),!e.getConditions().addChild(this._parseGuardCondition()))return this.finish(e,cssErrors_1.ParseError.ConditionExpected);for(;this.acceptIdent("and")||this.accept(cssScanner_1.TokenType.Comma);)if(!e.getConditions().addChild(this._parseGuardCondition()))return this.finish(e,cssErrors_1.ParseError.ConditionExpected);return this.finish(e)}_parseGuardCondition(){if(!this.peek(cssScanner_1.TokenType.ParenthesisL))return null;const e=this.create(nodes.GuardCondition);return this.consumeToken(),e.addChild(this._parseExpr()),this.accept(cssScanner_1.TokenType.ParenthesisR)?this.finish(e):this.finish(e,cssErrors_1.ParseError.RightParenthesisExpected)}_parseFunction(){const e=this.mark(),s=this.create(nodes.Function);if(!s.setIdentifier(this._parseFunctionIdentifier()))return null;if(this.hasWhitespace()||!this.accept(cssScanner_1.TokenType.ParenthesisL))return this.restoreAtMark(e),null;if(s.getArguments().addChild(this._parseMixinArgument()))for(;(this.accept(cssScanner_1.TokenType.Comma)||this.accept(cssScanner_1.TokenType.SemiColon))&&!this.peek(cssScanner_1.TokenType.ParenthesisR);)if(!s.getArguments().addChild(this._parseMixinArgument()))return this.finish(s,cssErrors_1.ParseError.ExpressionExpected);return this.accept(cssScanner_1.TokenType.ParenthesisR)?this.finish(s):this.finish(s,cssErrors_1.ParseError.RightParenthesisExpected)}_parseFunctionIdentifier(){if(this.peekDelim("%")){const e=this.create(nodes.Identifier);return e.referenceTypes=[nodes.ReferenceType.Function],this.consumeToken(),this.finish(e)}return super._parseFunctionIdentifier()}_parseURLArgument(){const e=this.mark(),s=super._parseURLArgument();if(!s||!this.peek(cssScanner_1.TokenType.ParenthesisR)){this.restoreAtMark(e);const s=this.create(nodes.Node);return s.addChild(this._parseBinaryExpr()),this.finish(s)}return s}}exports.LESSParser=LESSParser;
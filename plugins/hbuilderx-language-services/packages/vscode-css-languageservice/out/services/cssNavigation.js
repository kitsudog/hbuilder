"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,s,r)}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CSSNavigation=void 0;const cssLanguageTypes_1=require("../cssLanguageTypes"),nls=__importStar(require("vscode-nls")),nodes=__importStar(require("../parser/cssNodes")),cssSymbolScope_1=require("../parser/cssSymbolScope"),facts_1=require("../languageFacts/facts"),strings_1=require("../utils/strings"),resources_1=require("../utils/resources"),localize=nls.loadMessageBundle();class CSSNavigation{constructor(e){this.fileSystemProvider=e}findDefinition(e,t,n){const s=new cssSymbolScope_1.Symbols(n),r=e.offsetAt(t),i=nodes.getNodeAtOffset(n,r);if(!i)return null;const o=s.findSymbolFromNode(i);return o?{uri:e.uri,range:getRange(o.node,e)}:null}findReferences(e,t,n){return this.findDocumentHighlights(e,t,n).map((t=>({uri:e.uri,range:t.range})))}findDocumentHighlights(e,t,n){const s=[],r=e.offsetAt(t);let i=nodes.getNodeAtOffset(n,r);if(!i||i.type===nodes.NodeType.Stylesheet||i.type===nodes.NodeType.Declarations)return s;i.type===nodes.NodeType.Identifier&&i.parent&&i.parent.type===nodes.NodeType.ClassSelector&&(i=i.parent);const o=new cssSymbolScope_1.Symbols(n),a=o.findSymbolFromNode(i),c=i.getText();return n.accept((t=>{if(a){if(o.matchesSymbol(t,a))return s.push({kind:getHighlightKind(t),range:getRange(t,e)}),!1}else i&&i.type===t.type&&t.matches(c)&&s.push({kind:getHighlightKind(t),range:getRange(t,e)});return!0})),s}isRawStringDocumentLinkNode(e){return e.type===nodes.NodeType.Import}findDocumentLinks(e,t,n){const s=this.findUnresolvedLinks(e,t);for(let t=0;t<s.length;t++){const r=s[t].target;if(r&&!/^\w+:\/\//g.test(r)){const i=n.resolveReference(r,e.uri);i&&(s[t].target=i)}}return s}async findDocumentLinks2(e,t,n){const s=this.findUnresolvedLinks(e,t),r=[];for(let t of s){const s=t.target;if(s&&!/^\w+:\/\//g.test(s)){const i=await this.resolveRelativeReference(s,e.uri,n);void 0!==i&&(t.target=i,r.push(t))}else r.push(t)}return r}findUnresolvedLinks(e,t){const n=[],s=t=>{let s=t.getText();const r=getRange(t,e);r.start.line===r.end.line&&r.start.character===r.end.character||(((0,strings_1.startsWith)(s,"'")||(0,strings_1.startsWith)(s,'"'))&&(s=s.slice(1,-1)),n.push({target:s,range:r}))};return t.accept((e=>{if(e.type===nodes.NodeType.URILiteral){const t=e.getChild(0);return t&&s(t),!1}if(e.parent&&this.isRawStringDocumentLinkNode(e.parent)){const t=e.getText();return((0,strings_1.startsWith)(t,"'")||(0,strings_1.startsWith)(t,'"'))&&s(e),!1}return!0})),n}findDocumentSymbols(e,t){const n=[];return t.accept((t=>{const s={name:null,kind:cssLanguageTypes_1.SymbolKind.Class,location:null};let r=t;if(t instanceof nodes.Selector)return s.name=t.getText(),r=t.findAParent(nodes.NodeType.Ruleset,nodes.NodeType.ExtendsReference),r&&(s.location=cssLanguageTypes_1.Location.create(e.uri,getRange(r,e)),n.push(s)),!1;if(t instanceof nodes.VariableDeclaration)s.name=t.getName(),s.kind=cssLanguageTypes_1.SymbolKind.Variable;else if(t instanceof nodes.MixinDeclaration)s.name=t.getName(),s.kind=cssLanguageTypes_1.SymbolKind.Method;else if(t instanceof nodes.FunctionDeclaration)s.name=t.getName(),s.kind=cssLanguageTypes_1.SymbolKind.Function;else if(t instanceof nodes.Keyframe)s.name=localize("literal.keyframes","@keyframes {0}",t.getName());else if(t instanceof nodes.FontFace)s.name=localize("literal.fontface","@font-face");else if(t instanceof nodes.Media){const e=t.getChild(0);e instanceof nodes.Medialist&&(s.name="@media "+e.getText(),s.kind=cssLanguageTypes_1.SymbolKind.Module)}return s.name&&(s.location=cssLanguageTypes_1.Location.create(e.uri,getRange(r,e)),n.push(s)),!0})),n}findDocumentColors(e,t){const n=[];return t.accept((t=>{const s=getColorInformation(t,e);return s&&n.push(s),!0})),n}getColorPresentations(e,t,n,s){const r=[],i=Math.round(255*n.red),o=Math.round(255*n.green),a=Math.round(255*n.blue);let c;c=1===n.alpha?`rgb(${i}, ${o}, ${a})`:`rgba(${i}, ${o}, ${a}, ${n.alpha})`,r.push({label:c,textEdit:cssLanguageTypes_1.TextEdit.replace(s,c)}),c=1===n.alpha?`#${toTwoDigitHex(i)}${toTwoDigitHex(o)}${toTwoDigitHex(a)}`:`#${toTwoDigitHex(i)}${toTwoDigitHex(o)}${toTwoDigitHex(a)}${toTwoDigitHex(Math.round(255*n.alpha))}`,r.push({label:c,textEdit:cssLanguageTypes_1.TextEdit.replace(s,c)});const l=(0,facts_1.hslFromColor)(n);return c=1===l.a?`hsl(${l.h}, ${Math.round(100*l.s)}%, ${Math.round(100*l.l)}%)`:`hsla(${l.h}, ${Math.round(100*l.s)}%, ${Math.round(100*l.l)}%, ${l.a})`,r.push({label:c,textEdit:cssLanguageTypes_1.TextEdit.replace(s,c)}),r}doRename(e,t,n,s){const r=this.findDocumentHighlights(e,t,s).map((e=>cssLanguageTypes_1.TextEdit.replace(e.range,n)));return{changes:{[e.uri]:r}}}async resolveRelativeReference(e,t,n){if("~"===e[0]&&"/"!==e[1]&&this.fileSystemProvider){if(e=e.substring(1),(0,strings_1.startsWith)(t,"file://")){const s=getModuleNameFromPath(e),r=n.resolveReference("/",t),i=(0,resources_1.dirname)(t),o=await this.resolvePathToModule(s,i,r);if(o){const t=e.substring(s.length+1);return(0,resources_1.joinPath)(o,t)}}return n.resolveReference(e,t)}return n.resolveReference(e,t)}async resolvePathToModule(e,t,n){const s=(0,resources_1.joinPath)(t,"node_modules",e,"package.json");return await this.fileExists(s)?(0,resources_1.dirname)(s):n&&t.startsWith(n)&&t.length!==n.length?this.resolvePathToModule(e,(0,resources_1.dirname)(t),n):void 0}async fileExists(e){if(!this.fileSystemProvider)return!1;try{const t=await this.fileSystemProvider.stat(e);return t.type!==cssLanguageTypes_1.FileType.Unknown||-1!==t.size}catch(e){return!1}}}function getColorInformation(e,t){const n=(0,facts_1.getColorValue)(e);if(n){return{color:n,range:getRange(e,t)}}return null}function getRange(e,t){return cssLanguageTypes_1.Range.create(t.positionAt(e.offset),t.positionAt(e.end))}function getHighlightKind(e){if(e.type===nodes.NodeType.Selector)return cssLanguageTypes_1.DocumentHighlightKind.Write;if(e instanceof nodes.Identifier&&e.parent&&e.parent instanceof nodes.Property&&e.isCustomProperty)return cssLanguageTypes_1.DocumentHighlightKind.Write;if(e.parent)switch(e.parent.type){case nodes.NodeType.FunctionDeclaration:case nodes.NodeType.MixinDeclaration:case nodes.NodeType.Keyframe:case nodes.NodeType.VariableDeclaration:case nodes.NodeType.FunctionParameter:return cssLanguageTypes_1.DocumentHighlightKind.Write}return cssLanguageTypes_1.DocumentHighlightKind.Read}function toTwoDigitHex(e){const t=e.toString(16);return 2!==t.length?"0"+t:t}function getModuleNameFromPath(e){return"@"===e[0]?e.substring(0,e.indexOf("/",e.indexOf("/")+1)):e.substring(0,e.indexOf("/"))}exports.CSSNavigation=CSSNavigation;
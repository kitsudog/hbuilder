"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,o){void 0===o&&(o=s);var r=Object.getOwnPropertyDescriptor(t,s);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,o,r)}:function(e,t,s,o){void 0===o&&(o=s),e[o]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LintVisitor=void 0;const languageFacts=__importStar(require("../languageFacts/facts")),nodes=__importStar(require("../parser/cssNodes")),arrays_1=require("../utils/arrays"),lintRules_1=require("./lintRules"),lintUtil_1=__importStar(require("./lintUtil")),cssLintNls_1=require("../nls/cssLintNls"),facts_1=require("../languageFacts/facts"),extType_1=require("../languageFacts/extType"),core_1=require("../../../../core");class NodesByRootMap{constructor(){this.data={}}add(e,t,s){let o=this.data[e];o||(o={nodes:[],names:[]},this.data[e]=o),o.names.push(t),s&&o.nodes.push(s)}}class LintVisitor{static entries(e,t,s,o,r){const n=new LintVisitor(t,s,o);return e.acceptVisitor(n),n.completeValidations(),{entrieRes:n.getEntries(r),selectors:n.checkSelectors}}constructor(e,t,s){this.cssDataManager=s,this.warnings=[],this.needCheckPlatformSupportSelectors=[nodes.NodeType.SelectorCombinatorParent,nodes.NodeType.SelectorCombinatorSibling,nodes.NodeType.SelectorCombinatorAllSiblings,nodes.NodeType.ClassSelector,nodes.NodeType.ElementNameSelector,nodes.NodeType.IdentifierSelector,nodes.NodeType.AttributeSelector,nodes.NodeType.PseudoSelector],this.checkSelectors=[],this.settings=t,this.documentText=e.getText(),this.keyframes=new NodesByRootMap,this.validProperties={},this.cssDataManager.generateAListOfAttributeExpectedMap();const o=t.getSetting(lintRules_1.Settings.ValidProperties);this.tool=core_1.SyntacticDiagnosticsTool.getInstance(),Array.isArray(o)&&o.forEach((e=>{if("string"==typeof e){const t=e.trim().toLowerCase();t.length&&(this.validProperties[t]=!0)}}))}visitNode(e){switch(this.needCheckPlatformSupportSelectors.includes(e.type)&&this.visitSelectorSupport(e),e.type){case nodes.NodeType.UnknownAtRule:return this.visitUnknownAtRule(e);case nodes.NodeType.Identifier:return this.visitIdentifier(e);case nodes.NodeType.Selector:return this.visitSelector(e);case nodes.NodeType.IdentifierSelector:return this.visitIdentifierSelector(e);case nodes.NodeType.Keyframe:return this.visitKeyframe(e);case nodes.NodeType.FontFace:return this.visitFontFace(e);case nodes.NodeType.Ruleset:return this.visitRuleSet(e);case nodes.NodeType.SimpleSelector:return this.visitSimpleSelector(e);case nodes.NodeType.Function:return this.visitFunction(e);case nodes.NodeType.NumericValue:return this.visitNumericValue(e);case nodes.NodeType.Import:return this.visitImport(e);case nodes.NodeType.HexColorValue:return this.visitHexColorValue(e);case nodes.NodeType.Prio:return this.visitPrio(e)}return!0}visitSelector(e){let t=this.findParentByConstructorName(e,"Nodelist");if(t){let e=t.getText(),s=t.offset;for(const t of(0,core_1.matchAll)(e,/,/g))this.visitSelectorSupport(new nodes.Node(s+t.index,t[0].length,nodes.NodeType.SelectorCombinator))}let s=e.getChildren(),o=!1,r=0;for(let e of s){let t=e.type===nodes.NodeType.SimpleSelector;o?t?(o=!0,this.visitSelectorSupport(new nodes.Node(r,e.offset-r,nodes.NodeType.SelectorCombinatorShadowPiercingDescendant)),r=e.end):o=!1:(r=e.end,o=!0)}return!0}visitSelectorSupport(e){if(!facts_1.cssSyntaxData)return!0;let t="",s="",o=e.getText(),r=e.offset,n=e.length;switch(e.type){case nodes.NodeType.IdentifierSelector:s=(0,cssLintNls_1.localize)("customRule.unSupportSelector","ID"),t=extType_1.SelectorType.IdentifierSelector;break;case nodes.NodeType.SelectorCombinator:s=(0,cssLintNls_1.localize)("customRule.unSupportSelector",(0,cssLintNls_1.localize)("customRule.group")),t=extType_1.SelectorType.CombinatorGroupSelector;break;case nodes.NodeType.SelectorCombinatorShadowPiercingDescendant:s=(0,cssLintNls_1.localize)("customRule.unSupportSelector",(0,cssLintNls_1.localize)("customRule.children")),t=extType_1.SelectorType.CombinatorChildrenSelector;break;case nodes.NodeType.SelectorCombinatorParent:s=(0,cssLintNls_1.localize)("customRule.unSupportSelector",(0,cssLintNls_1.localize)("customRule.shadowPiercingDescendant")),t=extType_1.SelectorType.CombinatorShadowPiercingDescendantSelector;break;case nodes.NodeType.SelectorCombinatorSibling:s=(0,cssLintNls_1.localize)("customRule.unSupportSelector",(0,cssLintNls_1.localize)("customRule.siblings")),t=extType_1.SelectorType.CombinatorSiblingSelector;break;case nodes.NodeType.SelectorCombinatorAllSiblings:s=(0,cssLintNls_1.localize)("customRule.unSupportSelector",(0,cssLintNls_1.localize)("customRule.allSiblings")),t=extType_1.SelectorType.CombinatorAllSiblingsSelector;break;case nodes.NodeType.ClassSelector:s=(0,cssLintNls_1.localize)("customRule.unSupportSelector",(0,cssLintNls_1.localize)("customRule.className")),t=extType_1.SelectorType.ClassSelector;break;case nodes.NodeType.ElementNameSelector:"*"!==o?(s=(0,cssLintNls_1.localize)("customRule.unSupportSelector",(0,cssLintNls_1.localize)("customRule.element")),t=extType_1.SelectorType.ElementNameSelector):(s=(0,cssLintNls_1.localize)("customRule.unSupportSelector",(0,cssLintNls_1.localize)("customRule.wildcard")),t=extType_1.SelectorType.UniversalSelectors);break;case nodes.NodeType.AttributeSelector:s=(0,cssLintNls_1.localize)("customRule.unSupportSelector",(0,cssLintNls_1.localize)("customRule.property")),t=extType_1.SelectorType.AttributeSelector,r++,n-=2;break;case nodes.NodeType.PseudoSelector:o.startsWith("::")?(s=(0,cssLintNls_1.localize)("customRule.unSupportSelector",(0,cssLintNls_1.localize)("customRule.pseudo-element")),t=extType_1.SelectorType.PseudoElementSelector,r+=2,n-=2):(s=(0,cssLintNls_1.localize)("customRule.unSupportSelector",(0,cssLintNls_1.localize)("customRule.pseudo-class")),t=extType_1.SelectorType.PseudoClassSelector,r++,n--)}if(t){let o=facts_1.cssSyntaxData[t];this.tool.uniPlatformCompletionSupport(o.uniPlatform)||this.addEntry(e,lintRules_1.Rules.UnSupportSelector,s,r,n)}return!0}visitIdentifier(e){var t;if(this.findParentByConstructorName(e,"Term")){let s=this.findParentByConstructorName(e,"Declaration");if(s){let o=this.findChildByConstructorName(s,"Property");if(o){if((null===(t=e.parent)||void 0===t?void 0:t.type)!==nodes.NodeType.Term)return!0;let s=o.getText(),r=e.getText();const n=this.cssDataManager.getProperty(s);if(!n)return!0;if(!(n.restrictions||[]).includes("enum"))return!0;let{isConstColor:i,valueData:l}=this.cssDataManager.checkInputIsInExpectedLists(s,r);l?this.tool.uniPlatformCompletionSupport(l.uniPlatform)||this.addEntry(e,lintRules_1.Rules.UnknownExpression,(0,cssLintNls_1.localize)("customRule.unSupportPropertyValue",r)):i||this.addEntry(e,lintRules_1.Rules.UnknownExpression,(0,cssLintNls_1.localize)("customRule.unSupportPropertyValue",r))}}}return!0}findParentByConstructorName(e,t){for(;e.parent;)if((e=e.parent).constructor.name===t)return e;return null}findChildByConstructorName(e,t){if(e.getChildren())for(const s of e.getChildren()){if(s.constructor.name===t)return s;this.findChildByConstructorName(s,t)}return null}visitIdentifierSelector(e){let t=!1;if(facts_1.cssSyntaxData){let e=facts_1.cssSyntaxData[extType_1.SelectorType.IdentifierSelector];t=!!this.tool.uniPlatformCompletionSupport(e.uniPlatform)}else t=!0;return t&&this.checkSelectors.push({nodeValue:e.getText().slice(1),node:e,nodeType:e.type}),!0}isValidPropertyDeclaration(e){const t=e.fullPropertyName;return this.validProperties[t]}fetch(e,t){const s=[];for(const o of e)o.fullPropertyName===t&&s.push(o);return s}fetchWithValue(e,t,s){const o=[];for(const r of e)if(r.fullPropertyName===t){const e=r.node.getValue();e&&this.findValueInExpression(e,s)&&o.push(r)}return o}findValueInExpression(e,t){let s=!1;return e.accept((e=>(e.type===nodes.NodeType.Identifier&&e.matches(t)&&(s=!0),!s))),s}getEntries(e=nodes.Level.Warning|nodes.Level.Error){return this.warnings.filter((t=>0!=(t.getLevel()&e)))}addEntry(e,t,s,o,r){const n=new nodes.Marker(e,t,this.settings.getRule(t),s,o,r);this.warnings.push(n)}getMissingNames(e,t){const s=e.slice(0);for(let e=0;e<t.length;e++){const o=s.indexOf(t[e]);-1!==o&&(s[o]=null)}let o=null;for(let e=0;e<s.length;e++){const t=s[e];t&&(o=null===o?(0,cssLintNls_1.localize)("namelist.single",t):(0,cssLintNls_1.localize)("namelist.concatenated",o,t))}return o}completeValidations(){this.validateKeyframes()}visitUnknownAtRule(e){const t=e.getChild(0);if(!t)return!1;const s=this.cssDataManager.getAtDirective(t.getText());return s&&this.tool.uniPlatformCompletionSupport(s.uniPlatform)||this.addEntry(t,lintRules_1.Rules.UnknownAtRules,(0,cssLintNls_1.localize)("customRule.unSupportAtrule",t.getText())),!0}visitKeyframe(e){const t=e.getKeyword();if(!t)return!1;const s=t.getText();return this.keyframes.add(e.getName(),s,"@keyframes"!==s?t:null),!0}validateKeyframes(){const e=["@-webkit-keyframes","@-moz-keyframes","@-o-keyframes"];for(const t in this.keyframes.data){const s=this.keyframes.data[t].names,o=-1===s.indexOf("@keyframes");if(!o&&1===s.length)continue;const r=this.getMissingNames(e,s);if(r||o)for(const e of this.keyframes.data[t].nodes){if(o){const t=(0,cssLintNls_1.localize)("keyframes.standardrule.missing");this.addEntry(e,lintRules_1.Rules.IncludeStandardPropertyWhenUsingVendorPrefix,t)}if(r){const t=(0,cssLintNls_1.localize)("keyframes.vendorspecific.missing",r);this.addEntry(e,lintRules_1.Rules.AllVendorPrefixes,t)}}}return!0}visitSimpleSelector(e){const t=this.documentText.charAt(e.offset);return 1===e.length&&"*"===t&&this.addEntry(e,lintRules_1.Rules.UniversalSelector),"#"===t&&this.addEntry(e,lintRules_1.Rules.AvoidIdSelector),!0}visitImport(e){return this.addEntry(e,lintRules_1.Rules.ImportStatemement),!0}visitRuleSet(e){const t=e.getDeclarations();if(!t)return!1;t.hasChildren()||this.addEntry(e.getSelectors(),lintRules_1.Rules.EmptyRuleSet);const s=[];for(const e of t.getChildren())e instanceof nodes.Declaration&&s.push(new lintUtil_1.Element(e));const o=(0,lintUtil_1.default)(s);if(o.width){let e=[];if(o.right.value&&(e=(0,arrays_1.union)(e,o.right.properties)),o.left.value&&(e=(0,arrays_1.union)(e,o.left.properties)),0!==e.length){for(const t of e)this.addEntry(t.node,lintRules_1.Rules.BewareOfBoxModelSize);this.addEntry(o.width.node,lintRules_1.Rules.BewareOfBoxModelSize)}}if(o.height){let e=[];if(o.top.value&&(e=(0,arrays_1.union)(e,o.top.properties)),o.bottom.value&&(e=(0,arrays_1.union)(e,o.bottom.properties)),0!==e.length){for(const t of e)this.addEntry(t.node,lintRules_1.Rules.BewareOfBoxModelSize);this.addEntry(o.height.node,lintRules_1.Rules.BewareOfBoxModelSize)}}let r=this.fetchWithValue(s,"display","inline-block");if(r.length>0){const e=this.fetch(s,"float");for(let t=0;t<e.length;t++){const s=e[t].node,o=s.getValue();o&&!o.matches("none")&&this.addEntry(s,lintRules_1.Rules.PropertyIgnoredDueToDisplay,(0,cssLintNls_1.localize)("rule.propertyIgnoredDueToDisplayInlineBlock"))}}if(r=this.fetchWithValue(s,"display","block"),r.length>0){const e=this.fetch(s,"vertical-align");for(let t=0;t<e.length;t++)this.addEntry(e[t].node,lintRules_1.Rules.PropertyIgnoredDueToDisplay,(0,cssLintNls_1.localize)("rule.propertyIgnoredDueToDisplayBlock"))}const n=this.fetch(s,"float");for(let e=0;e<n.length;e++){const t=n[e];this.isValidPropertyDeclaration(t)||this.addEntry(t.node,lintRules_1.Rules.AvoidFloat)}for(let e=0;e<s.length;e++){const t=s[e];if("background"!==t.fullPropertyName&&!this.validProperties[t.fullPropertyName]){const e=t.node.getValue();if(e&&"-"!==this.documentText.charAt(e.offset)){const e=this.fetch(s,t.fullPropertyName);if(e.length>1)for(let s=0;s<e.length;s++){const o=e[s].node.getValue();o&&"-"!==this.documentText.charAt(o.offset)&&e[s]!==t&&this.addEntry(t.node,lintRules_1.Rules.DuplicateDeclarations)}}}}if(!e.getSelectors().matches(":export")){const e=new NodesByRootMap;let t=!1;for(const o of s){const s=o.node;if(this.isCSSDeclaration(s)){let t=o.fullPropertyName;const r=t.charAt(0);if("-"===r){if("-"!==t.charAt(1)){this.cssDataManager.isKnownProperty(t)||this.validProperties[t]||this.addEntry(s.getProperty(),lintRules_1.Rules.UnknownVendorSpecificProperty);const o=s.getNonPrefixedPropertyName();e.add(o,t,s.getProperty())}}else{const o=t;if("*"!==r&&"_"!==r||(this.addEntry(s.getProperty(),lintRules_1.Rules.IEStarHack),t=t.substr(1)),this.cssDataManager.isKnownProperty(o)||this.cssDataManager.isKnownProperty(t)){let e=this.cssDataManager.getProperty(o);this.tool.uniPlatformCompletionSupport(null==e?void 0:e.uniPlatform)||this.addEntry(s.getProperty(),lintRules_1.Rules.UnknownProperty,(0,cssLintNls_1.localize)("property.unknownproperty.detailed",s.getFullPropertyName()))}else this.validProperties[t]||this.addEntry(s.getProperty(),lintRules_1.Rules.UnknownProperty,(0,cssLintNls_1.localize)("property.unknownproperty.detailed",s.getFullPropertyName()));e.add(t,t,null)}}else t=!0}if(!t)for(const t in e.data){const s=e.data[t],o=s.names,r=this.cssDataManager.isStandardProperty(t)&&-1===o.indexOf(t);if(!r&&1===o.length)continue;const n=[];for(let e=0,s=LintVisitor.prefixes.length;e<s;e++){const s=LintVisitor.prefixes[e];this.cssDataManager.isStandardProperty(s+t)&&n.push(s+t)}const i=this.getMissingNames(n,o);if(i||r)for(const e of s.nodes){if(r){const s=(0,cssLintNls_1.localize)("property.standard.missing",t);this.addEntry(e,lintRules_1.Rules.IncludeStandardPropertyWhenUsingVendorPrefix,s)}if(i){const t=(0,cssLintNls_1.localize)("property.vendorspecific.missing",i);this.addEntry(e,lintRules_1.Rules.AllVendorPrefixes,t)}}}}return!0}visitPrio(e){return this.addEntry(e,lintRules_1.Rules.AvoidImportant),!0}visitNumericValue(e){const t=e.findParent(nodes.NodeType.Function);if(t&&"calc"===t.getName())return!0;const s=e.findParent(nodes.NodeType.Declaration);if(this.findParentByConstructorName(e,"Term")&&s){let t=this.findParentByConstructorName(e,"Declaration");if(t){let o=this.findChildByConstructorName(t,"Property");if(o){let t=o.getText();const r=this.cssDataManager.getProperty(t);if(!r)return!0;let n=r.restrictions||[];if(s.getValue()){const t=e.getValue();if(!t.unit)return!0;let s=t.unit.toLowerCase(),o={},r=languageFacts.units;n.forEach((e=>{r[e]&&Object.assign(o,r[e])}));let i=o[s];i&&this.tool.uniPlatformCompletionSupport(i.uniPlatform)||this.addEntry(e,lintRules_1.Rules.UnSupportSelector,(0,cssLintNls_1.localize)("customRule.unknownUnit.detailed",t.unit))}}}}return!0}visitFontFace(e){const t=e.getDeclarations();if(!t)return!1;let s=!1,o=!1,r=!1;for(const e of t.getChildren())if(this.isCSSDeclaration(e)){const t=e.getProperty().getName().toLowerCase();"src"===t&&(s=!0),"font-family"===t&&(o=!0)}else r=!0;return r||s&&o||this.addEntry(e,lintRules_1.Rules.RequiredPropertiesForFontFace),!0}isCSSDeclaration(e){if(e instanceof nodes.Declaration){if(!e.getValue())return!1;const t=e.getProperty();if(!t)return!1;const s=t.getIdentifier();return!(!s||s.containsInterpolation())}return!1}visitHexColorValue(e){const t=e.length;return 9!==t&&7!==t&&5!==t&&4!==t&&this.addEntry(e,lintRules_1.Rules.HexColorLength),!1}visitFunction(e){const t=e.getName().toLowerCase();let s=languageFacts.findCombinesPropertyValueByKeyword(t),o=this.findParentByConstructorName(e,"Declaration");if(o){let e=this.findChildByConstructorName(o,"Property");if("transform"===(null==e?void 0:e.getText()))return!1}if(!s||!this.tool.uniPlatformCompletionSupport(s.uniPlatform))return this.addEntry(e,lintRules_1.Rules.ArgsInColorFunction,(0,cssLintNls_1.localize)("customRule.unknownFunction.detailed",t)),!1;let r=-1,n=0;switch(t){case"rgb":case"hsl":r=3;break;case"rgba":case"hsla":r=4}return-1!==r&&(e.getArguments().accept((e=>!(e instanceof nodes.BinaryExpression)||(n+=1,!1))),n!==r&&this.addEntry(e,lintRules_1.Rules.ArgsInColorFunction)),!0}}exports.LintVisitor=LintVisitor,LintVisitor.prefixes=["-ms-","-moz-","-o-","-webkit-"];
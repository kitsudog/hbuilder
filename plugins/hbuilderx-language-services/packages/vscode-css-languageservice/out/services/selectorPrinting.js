"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var s=Object.getOwnPropertyDescriptor(t,n);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,s)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.selectorToElement=exports.SelectorPrinting=exports.toElement=exports.LabelElement=exports.RootElement=exports.Element=void 0;const nodes=__importStar(require("../parser/cssNodes")),cssScanner_1=require("../parser/cssScanner"),nls=__importStar(require("vscode-nls")),localize=nls.loadMessageBundle();class Element{constructor(){this.parent=null,this.children=null,this.attributes=null}findAttribute(e){if(this.attributes)for(const t of this.attributes)if(t.name===e)return t.value;return null}addChild(e){e instanceof Element&&(e.parent=this),this.children||(this.children=[]),this.children.push(e)}append(e){if(this.attributes){const t=this.attributes[this.attributes.length-1];t.value=t.value+e}}prepend(e){if(this.attributes){const t=this.attributes[0];t.value=e+t.value}}findRoot(){let e=this;for(;e.parent&&!(e.parent instanceof RootElement);)e=e.parent;return e}removeChild(e){if(this.children){const t=this.children.indexOf(e);if(-1!==t)return this.children.splice(t,1),!0}return!1}addAttr(e,t){this.attributes||(this.attributes=[]);for(const n of this.attributes)if(n.name===e)return void(n.value+=" "+t);this.attributes.push({name:e,value:t})}clone(e=!0){const t=new Element;if(this.attributes){t.attributes=[];for(const e of this.attributes)t.addAttr(e.name,e.value)}if(e&&this.children){t.children=[];for(let e=0;e<this.children.length;e++)t.addChild(this.children[e].clone())}return t}cloneWithParent(){const e=this.clone(!1);if(this.parent&&!(this.parent instanceof RootElement)){this.parent.cloneWithParent().addChild(e)}return e}}exports.Element=Element;class RootElement extends Element{}exports.RootElement=RootElement;class LabelElement extends Element{constructor(e){super(),this.addAttr("name",e)}}exports.LabelElement=LabelElement;class MarkedStringPrinter{constructor(e){this.quote=e,this.result=[]}print(e){this.result=[],e instanceof RootElement?e.children&&this.doPrint(e.children,0):this.doPrint([e],0);return[{language:"html",value:this.result.join("\n")}]}doPrint(e,t){for(const n of e)this.doPrintElement(n,t),n.children&&this.doPrint(n.children,t+1)}writeLine(e,t){const n=new Array(e+1).join("  ");this.result.push(n+t)}doPrintElement(e,t){const n=e.findAttribute("name");if(e instanceof LabelElement||"…"===n)return void this.writeLine(t,n);const r=["<"];if(n?r.push(n):r.push("element"),e.attributes)for(const t of e.attributes)if("name"!==t.name){r.push(" "),r.push(t.name);const e=t.value;e&&(r.push("="),r.push(quotes.ensure(e,this.quote)))}r.push(">"),this.writeLine(t,r.join(""))}}var quotes;!function(e){function t(e){const t=e.match(/^['"](.*)["']$/);return t?t[1]:e}e.ensure=function(e,n){return n+t(e)+n},e.remove=t}(quotes||(quotes={}));class Specificity{constructor(){this.id=0,this.attr=0,this.tag=0}}function toElement(e,t){let n=new Element;for(const r of e.getChildren())switch(r.type){case nodes.NodeType.SelectorCombinator:if(t){const e=r.getText().split("&");if(1===e.length){n.addAttr("name",e[0]);break}if(n=t.cloneWithParent(),e[0]){n.findRoot().prepend(e[0])}for(let r=1;r<e.length;r++){if(r>1){const e=t.cloneWithParent();n.addChild(e.findRoot()),n=e}n.append(e[r])}}break;case nodes.NodeType.SelectorPlaceholder:if(r.matches("@at-root"))return n;case nodes.NodeType.ElementNameSelector:const e=r.getText();n.addAttr("name","*"===e?"element":unescape(e));break;case nodes.NodeType.ClassSelector:n.addAttr("class",unescape(r.getText().substring(1)));break;case nodes.NodeType.IdentifierSelector:n.addAttr("id",unescape(r.getText().substring(1)));break;case nodes.NodeType.MixinDeclaration:n.addAttr("class",r.getName());break;case nodes.NodeType.PseudoSelector:n.addAttr(unescape(r.getText()),"");break;case nodes.NodeType.AttributeSelector:const s=r,o=s.getIdentifier();if(o){const e=s.getValue(),t=s.getOperator();let r;if(e&&t)switch(unescape(t.getText())){case"|=":r=`${quotes.remove(unescape(e.getText()))}-…`;break;case"^=":r=`${quotes.remove(unescape(e.getText()))}…`;break;case"$=":r=`…${quotes.remove(unescape(e.getText()))}`;break;case"~=":r=` … ${quotes.remove(unescape(e.getText()))} … `;break;case"*=":r=`…${quotes.remove(unescape(e.getText()))}…`;break;default:r=quotes.remove(unescape(e.getText()))}n.addAttr(unescape(o.getText()),r)}}return n}function unescape(e){const t=new cssScanner_1.Scanner;t.setSource(e);const n=t.scanUnquotedString();return n?n.text:e}exports.toElement=toElement;class SelectorPrinting{constructor(e){this.cssDataManager=e}selectorToMarkedString(e){const t=selectorToElement(e);if(t){const n=new MarkedStringPrinter('"').print(t);return n.push(this.selectorToSpecificityMarkedString(e)),n}return[]}simpleSelectorToMarkedString(e){const t=toElement(e),n=new MarkedStringPrinter('"').print(t);return n.push(this.selectorToSpecificityMarkedString(e)),n}isPseudoElementIdentifier(e){const t=e.match(/^::?([\w-]+)/);return!!t&&!!this.cssDataManager.getPseudoElement("::"+t[1])}selectorToSpecificityMarkedString(e){const t=e=>{for(const r of e.getChildren()){switch(r.type){case nodes.NodeType.IdentifierSelector:n.id++;break;case nodes.NodeType.ClassSelector:case nodes.NodeType.AttributeSelector:n.attr++;break;case nodes.NodeType.ElementNameSelector:if(r.matches("*"))break;n.tag++;break;case nodes.NodeType.PseudoSelector:const e=r.getText();if(this.isPseudoElementIdentifier(e))n.tag++;else{if(e.match(/^:not/i))break;n.attr++}}r.getChildren().length>0&&t(r)}},n=new Specificity;return t(e),localize("specificity","[Selector Specificity](https://developer.mozilla.org/en-US/docs/Web/CSS/Specificity): ({0}, {1}, {2})",n.id,n.attr,n.tag)}}exports.SelectorPrinting=SelectorPrinting;class SelectorElementBuilder{constructor(e){this.prev=null,this.element=e}processSelector(e){let t=null;if(!(this.element instanceof RootElement)&&e.getChildren().some((e=>e.hasChildren()&&e.getChild(0).type===nodes.NodeType.SelectorCombinator))){const e=this.element.findRoot();e.parent instanceof RootElement&&(t=this.element,this.element=e.parent,this.element.removeChild(e),this.prev=null)}for(const n of e.getChildren()){if(n instanceof nodes.SimpleSelector){if(this.prev instanceof nodes.SimpleSelector){const e=new LabelElement("…");this.element.addChild(e),this.element=e}else this.prev&&(this.prev.matches("+")||this.prev.matches("~"))&&this.element.parent&&(this.element=this.element.parent);this.prev&&this.prev.matches("~")&&(this.element.addChild(toElement(n)),this.element.addChild(new LabelElement("⋮")));const e=toElement(n,t),r=e.findRoot();this.element.addChild(r),this.element=e}(n instanceof nodes.SimpleSelector||n.type===nodes.NodeType.SelectorCombinatorParent||n.type===nodes.NodeType.SelectorCombinatorShadowPiercingDescendant||n.type===nodes.NodeType.SelectorCombinatorSibling||n.type===nodes.NodeType.SelectorCombinatorAllSiblings)&&(this.prev=n)}}}function isNewSelectorContext(e){switch(e.type){case nodes.NodeType.MixinDeclaration:case nodes.NodeType.Stylesheet:return!0}return!1}function selectorToElement(e){if(e.matches("@at-root"))return null;const t=new RootElement,n=[],r=e.getParent();if(r instanceof nodes.RuleSet){let e=r.getParent();for(;e&&!isNewSelectorContext(e);){if(e instanceof nodes.RuleSet){if(e.getSelectors().matches("@at-root"))break;n.push(e)}e=e.getParent()}}const s=new SelectorElementBuilder(t);for(let e=n.length-1;e>=0;e--){const t=n[e].getSelectors().getChild(0);t&&s.processSelector(t)}return s.processSelector(e),t}exports.selectorToElement=selectorToElement;
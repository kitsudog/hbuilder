"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PathCompletionParticipant=void 0;const cssLanguageTypes_1=require("../cssLanguageTypes"),strings_1=require("../utils/strings"),resources_1=require("../utils/resources");class PathCompletionParticipant{constructor(t){this.readDirectory=t,this.literalCompletions=[],this.importCompletions=[]}onCssURILiteralValue(t){this.literalCompletions.push(t)}onCssImportPath(t){this.importCompletions.push(t)}async computeCompletions(t,e){const s={items:[],isIncomplete:!1};for(const i of this.literalCompletions){const a=i.uriValue,o=stripQuotes(a);if("."===o||".."===o)s.isIncomplete=!0;else{const o=await this.providePathSuggestions(a,i.position,i.range,t,e);for(let t of o)s.items.push(t)}}for(const i of this.importCompletions){const a=i.pathValue,o=stripQuotes(a);if("."===o||".."===o)s.isIncomplete=!0;else{let o=await this.providePathSuggestions(a,i.position,i.range,t,e);"scss"===t.languageId&&o.forEach((t=>{(0,strings_1.startsWith)(t.label,"_")&&(0,strings_1.endsWith)(t.label,".scss")&&(t.textEdit?t.textEdit.newText=t.label.slice(1,-5):t.label=t.label.slice(1,-5))}));for(let t of o)s.items.push(t)}}return s}async providePathSuggestions(t,e,s,i,a){const o=stripQuotes(t),r=(0,strings_1.startsWith)(t,"'")||(0,strings_1.startsWith)(t,'"'),n=r?o.slice(0,e.character-(s.start.character+1)):o.slice(0,e.character-s.start.character),c=i.uri,l=pathToReplaceRange(n,o,r?shiftRange(s,1,-1):s),p=n.substring(0,n.lastIndexOf("/")+1);let u=a.resolveReference(p||".",c);if(u)try{const t=[],e=await this.readDirectory(u);for(const[s,i]of e)s.charCodeAt(0)===CharCode_dot||i!==cssLanguageTypes_1.FileType.Directory&&(0,resources_1.joinPath)(u,s)===c||t.push(createCompletionItem(s,i===cssLanguageTypes_1.FileType.Directory,l));return t}catch(t){}return[]}}exports.PathCompletionParticipant=PathCompletionParticipant;const CharCode_dot=".".charCodeAt(0);function stripQuotes(t){return(0,strings_1.startsWith)(t,"'")||(0,strings_1.startsWith)(t,'"')?t.slice(1,-1):t}function pathToReplaceRange(t,e,s){let i;const a=t.lastIndexOf("/");if(-1===a)i=s;else{const t=e.slice(a+1),o=shiftPosition(s.end,-t.length),r=t.indexOf(" ");let n;n=-1!==r?shiftPosition(o,r):s.end,i=cssLanguageTypes_1.Range.create(o,n)}return i}function createCompletionItem(t,e,s){return e?{label:escapePath(t+="/"),kind:cssLanguageTypes_1.CompletionItemKind.Folder,textEdit:cssLanguageTypes_1.TextEdit.replace(s,escapePath(t)),command:{title:"Suggest",command:"editor.action.triggerSuggest"}}:{label:escapePath(t),kind:cssLanguageTypes_1.CompletionItemKind.File,textEdit:cssLanguageTypes_1.TextEdit.replace(s,escapePath(t))}}function escapePath(t){return t.replace(/(\s|\(|\)|,|"|')/g,"\\$1")}function shiftPosition(t,e){return cssLanguageTypes_1.Position.create(t.line,t.character+e)}function shiftRange(t,e,s){const i=shiftPosition(t.start,e),a=shiftPosition(t.end,s);return cssLanguageTypes_1.Range.create(i,a)}
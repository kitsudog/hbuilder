"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,s){void 0===s&&(s=o);var n=Object.getOwnPropertyDescriptor(t,o);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,s,n)}:function(e,t,o,s){void 0===s&&(s=o),e[s]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.parse=exports.JSONDocument=exports.contains=exports.getNodePath=exports.getNodeValue=exports.newJSONDocument=exports.ValidationResult=exports.EnumMatch=exports.asSchema=exports.ObjectASTNodeImpl=exports.PropertyASTNodeImpl=exports.StringASTNodeImpl=exports.NumberASTNodeImpl=exports.ArrayASTNodeImpl=exports.BooleanASTNodeImpl=exports.NullASTNodeImpl=exports.ASTNodeImpl=void 0;const Json=__importStar(require("jsonc-parser")),objects_1=require("../utils/objects"),strings_1=require("../utils/strings"),jsonLanguageTypes_1=require("../jsonLanguageTypes"),nls=__importStar(require("vscode-nls")),localize=nls.loadMessageBundle(),formats={"color-hex":{errorMessage:localize("colorHexFormatWarning","Invalid color format. Use #RGB, #RGBA, #RRGGBB or #RRGGBBAA."),pattern:/^#([0-9A-Fa-f]{3,4}|([0-9A-Fa-f]{2}){3,4})$/},"date-time":{errorMessage:localize("dateTimeFormatWarning","String is not a RFC3339 date-time."),pattern:/^(\d{4})-(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])T([01][0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9]|60)(\.[0-9]+)?(Z|(\+|-)([01][0-9]|2[0-3]):([0-5][0-9]))$/i},date:{errorMessage:localize("dateFormatWarning","String is not a RFC3339 date."),pattern:/^(\d{4})-(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])$/i},time:{errorMessage:localize("timeFormatWarning","String is not a RFC3339 time."),pattern:/^([01][0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9]|60)(\.[0-9]+)?(Z|(\+|-)([01][0-9]|2[0-3]):([0-5][0-9]))$/i},email:{errorMessage:localize("emailFormatWarning","String is not an e-mail address."),pattern:/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/}};class ASTNodeImpl{constructor(e,t,o=0){this.offset=t,this.length=o,this.parent=e}get children(){return[]}toString(){return"type: "+this.type+" ("+this.offset+"/"+this.length+")"+(this.parent?" parent: {"+this.parent.toString()+"}":"")}}exports.ASTNodeImpl=ASTNodeImpl;class NullASTNodeImpl extends ASTNodeImpl{constructor(e,t){super(e,t),this.type="null",this.value=null}}exports.NullASTNodeImpl=NullASTNodeImpl;class BooleanASTNodeImpl extends ASTNodeImpl{constructor(e,t,o){super(e,o),this.type="boolean",this.value=t}}exports.BooleanASTNodeImpl=BooleanASTNodeImpl;class ArrayASTNodeImpl extends ASTNodeImpl{constructor(e,t){super(e,t),this.type="array",this.items=[]}get children(){return this.items}}exports.ArrayASTNodeImpl=ArrayASTNodeImpl;class NumberASTNodeImpl extends ASTNodeImpl{constructor(e,t){super(e,t),this.type="number",this.isInteger=!0,this.value=Number.NaN}}exports.NumberASTNodeImpl=NumberASTNodeImpl;class StringASTNodeImpl extends ASTNodeImpl{constructor(e,t,o){super(e,t,o),this.type="string",this.value=""}}exports.StringASTNodeImpl=StringASTNodeImpl;class PropertyASTNodeImpl extends ASTNodeImpl{constructor(e,t,o){super(e,t),this.type="property",this.colonOffset=-1,this.keyNode=o}get children(){return this.valueNode?[this.keyNode,this.valueNode]:[this.keyNode]}}exports.PropertyASTNodeImpl=PropertyASTNodeImpl;class ObjectASTNodeImpl extends ASTNodeImpl{constructor(e,t){super(e,t),this.type="object",this.properties=[]}get children(){return this.properties}}function asSchema(e){return(0,objects_1.isBoolean)(e)?e?{}:{not:{}}:e}var EnumMatch;exports.ObjectASTNodeImpl=ObjectASTNodeImpl,exports.asSchema=asSchema,function(e){e[e.Key=0]="Key",e[e.Enum=1]="Enum"}(EnumMatch||(exports.EnumMatch=EnumMatch={}));class SchemaCollector{constructor(e=-1,t){this.focusOffset=e,this.exclude=t,this.schemas=[]}add(e){this.schemas.push(e)}merge(e){Array.prototype.push.apply(this.schemas,e.schemas)}include(e){return(-1===this.focusOffset||contains(e,this.focusOffset))&&e!==this.exclude}newSub(){return new SchemaCollector(-1,this.exclude)}}class NoOpSchemaCollector{constructor(){}get schemas(){return[]}add(e){}merge(e){}include(e){return!0}newSub(){return this}}NoOpSchemaCollector.instance=new NoOpSchemaCollector;class ValidationResult{constructor(){this.problems=[],this.propertiesMatches=0,this.propertiesValueMatches=0,this.primaryValueMatches=0,this.enumValueMatch=!1,this.enumValues=void 0}hasProblems(){return!!this.problems.length}mergeAll(e){for(const t of e)this.merge(t)}merge(e){this.problems=this.problems.concat(e.problems)}mergeEnumValues(e){if(!this.enumValueMatch&&!e.enumValueMatch&&this.enumValues&&e.enumValues){this.enumValues=this.enumValues.concat(e.enumValues);for(const e of this.problems)e.code===jsonLanguageTypes_1.ErrorCode.EnumValueMismatch&&(e.message=localize("enumWarning","Value is not accepted. Valid values: {0}.",this.enumValues.map((e=>JSON.stringify(e))).join(", ")))}}mergePropertyMatch(e){this.merge(e),this.propertiesMatches++,(e.enumValueMatch||!e.hasProblems()&&e.propertiesMatches)&&this.propertiesValueMatches++,e.enumValueMatch&&e.enumValues&&1===e.enumValues.length&&this.primaryValueMatches++}compare(e){const t=this.hasProblems();return t!==e.hasProblems()?t?-1:1:this.enumValueMatch!==e.enumValueMatch?e.enumValueMatch?-1:1:this.primaryValueMatches!==e.primaryValueMatches?this.primaryValueMatches-e.primaryValueMatches:this.propertiesValueMatches!==e.propertiesValueMatches?this.propertiesValueMatches-e.propertiesValueMatches:this.propertiesMatches-e.propertiesMatches}}function newJSONDocument(e,t=[]){return new JSONDocument(e,t,[])}function getNodeValue(e){return Json.getNodeValue(e)}function getNodePath(e){return Json.getNodePath(e)}function contains(e,t,o=!1){return t>=e.offset&&t<e.offset+e.length||o&&t===e.offset+e.length}exports.ValidationResult=ValidationResult,exports.newJSONDocument=newJSONDocument,exports.getNodeValue=getNodeValue,exports.getNodePath=getNodePath,exports.contains=contains;class JSONDocument{constructor(e,t=[],o=[]){this.root=e,this.syntaxErrors=t,this.comments=o}getNodeFromOffset(e,t=!1){if(this.root)return Json.findNodeAtOffset(this.root,e,t)}visit(e){if(this.root){const t=o=>{let s=e(o);const n=o.children;if(Array.isArray(n))for(let e=0;e<n.length&&s;e++)s=t(n[e]);return s};t(this.root)}}validate(e,t,o=jsonLanguageTypes_1.DiagnosticSeverity.Warning){if(this.root&&t){const s=new ValidationResult;return validate(this.root,t,s,NoOpSchemaCollector.instance),s.problems.map((t=>{var s;const n=jsonLanguageTypes_1.Range.create(e.positionAt(t.location.offset),e.positionAt(t.location.offset+t.location.length));return jsonLanguageTypes_1.Diagnostic.create(n,t.message,null!==(s=t.severity)&&void 0!==s?s:o,t.code)}))}}getMatchingSchemas(e,t=-1,o){const s=new SchemaCollector(t,o);return this.root&&e&&validate(this.root,e,new ValidationResult,s),s.schemas}}function validate(e,t,o,s){if(!e||!s.include(e))return;const n=e;switch(n.type){case"object":!function(e,t,o,s){const n=Object.create(null),r=[];for(const t of e.properties){const e=t.keyNode.value;n[e]=t.valueNode,r.push(e)}if(Array.isArray(t.required))for(const s of t.required)if(!n[s]){const t=e.parent&&"property"===e.parent.type&&e.parent.keyNode,n=t?{offset:t.offset,length:t.length}:{offset:e.offset,length:1};o.problems.push({location:n,message:localize("MissingRequiredPropWarning",'Missing property "{0}".',s)})}const a=e=>{let t=r.indexOf(e);for(;t>=0;)r.splice(t,1),t=r.indexOf(e)};if(t.properties)for(const e of Object.keys(t.properties)){a(e);const r=t.properties[e],i=n[e];if(i)if((0,objects_1.isBoolean)(r))if(r)o.propertiesMatches++,o.propertiesValueMatches++;else{const s=i.parent;o.problems.push({location:{offset:s.keyNode.offset,length:s.keyNode.length},message:t.errorMessage||localize("DisallowedExtraPropWarning","Property {0} is not allowed.",e)})}else{const e=new ValidationResult;validate(i,r,e,s),o.mergePropertyMatch(e)}}if(t.patternProperties)for(const e of Object.keys(t.patternProperties)){const i=(0,strings_1.extendedRegExp)(e);for(const l of r.slice(0))if(i.test(l)){a(l);const r=n[l];if(r){const n=t.patternProperties[e];if((0,objects_1.isBoolean)(n))if(n)o.propertiesMatches++,o.propertiesValueMatches++;else{const e=r.parent;o.problems.push({location:{offset:e.keyNode.offset,length:e.keyNode.length},message:t.errorMessage||localize("DisallowedExtraPropWarning","Property {0} is not allowed.",l)})}else{const e=new ValidationResult;validate(r,n,e,s),o.mergePropertyMatch(e)}}}}if("object"==typeof t.additionalProperties)for(const e of r){const r=n[e];if(r){const e=new ValidationResult;validate(r,t.additionalProperties,e,s),o.mergePropertyMatch(e)}}else if(!1===t.additionalProperties&&r.length>0)for(const e of r){const s=n[e];if(s){const n=s.parent;o.problems.push({location:{offset:n.keyNode.offset,length:n.keyNode.length},message:t.errorMessage||localize("DisallowedExtraPropWarning","Property {0} is not allowed.",e)})}}(0,objects_1.isNumber)(t.maxProperties)&&e.properties.length>t.maxProperties&&o.problems.push({location:{offset:e.offset,length:e.length},message:localize("MaxPropWarning","Object has more properties than limit of {0}.",t.maxProperties)});(0,objects_1.isNumber)(t.minProperties)&&e.properties.length<t.minProperties&&o.problems.push({location:{offset:e.offset,length:e.length},message:localize("MinPropWarning","Object has fewer properties than the required number of {0}",t.minProperties)});if(t.dependencies)for(const r of Object.keys(t.dependencies)){if(n[r]){const a=t.dependencies[r];if(Array.isArray(a))for(const t of a)n[t]?o.propertiesValueMatches++:o.problems.push({location:{offset:e.offset,length:e.length},message:localize("RequiredDependentPropWarning","Object is missing property {0} required by property {1}.",t,r)});else{const t=asSchema(a);if(t){const n=new ValidationResult;validate(e,t,n,s),o.mergePropertyMatch(n)}}}}const i=asSchema(t.propertyNames);if(i)for(const t of e.properties){const e=t.keyNode;e&&validate(e,i,o,NoOpSchemaCollector.instance)}}(n,t,o,s);break;case"array":!function(e,t,o,s){if(Array.isArray(t.items)){const n=t.items;for(let t=0;t<n.length;t++){const r=asSchema(n[t]),a=new ValidationResult,i=e.items[t];i?(validate(i,r,a,s),o.mergePropertyMatch(a)):e.items.length>=n.length&&o.propertiesValueMatches++}if(e.items.length>n.length)if("object"==typeof t.additionalItems)for(let r=n.length;r<e.items.length;r++){const n=new ValidationResult;validate(e.items[r],t.additionalItems,n,s),o.mergePropertyMatch(n)}else!1===t.additionalItems&&o.problems.push({location:{offset:e.offset,length:e.length},message:localize("additionalItemsWarning","Array has too many items according to schema. Expected {0} or fewer.",n.length)})}else{const n=asSchema(t.items);if(n)for(const t of e.items){const e=new ValidationResult;validate(t,n,e,s),o.mergePropertyMatch(e)}}const n=asSchema(t.contains);if(n){e.items.some((e=>{const t=new ValidationResult;return validate(e,n,t,NoOpSchemaCollector.instance),!t.hasProblems()}))||o.problems.push({location:{offset:e.offset,length:e.length},message:t.errorMessage||localize("requiredItemMissingWarning","Array does not contain required item.")})}(0,objects_1.isNumber)(t.minItems)&&e.items.length<t.minItems&&o.problems.push({location:{offset:e.offset,length:e.length},message:localize("minItemsWarning","Array has too few items. Expected {0} or more.",t.minItems)});(0,objects_1.isNumber)(t.maxItems)&&e.items.length>t.maxItems&&o.problems.push({location:{offset:e.offset,length:e.length},message:localize("maxItemsWarning","Array has too many items. Expected {0} or fewer.",t.maxItems)});if(!0===t.uniqueItems){const t=getNodeValue(e);t.some(((e,o)=>o!==t.lastIndexOf(e)))&&o.problems.push({location:{offset:e.offset,length:e.length},message:localize("uniqueItemsWarning","Array has duplicate items.")})}}(n,t,o,s);break;case"string":!function(e,t,o,s){(0,objects_1.isNumber)(t.minLength)&&e.value.length<t.minLength&&o.problems.push({location:{offset:e.offset,length:e.length},message:localize("minLengthWarning","String is shorter than the minimum length of {0}.",t.minLength)});(0,objects_1.isNumber)(t.maxLength)&&e.value.length>t.maxLength&&o.problems.push({location:{offset:e.offset,length:e.length},message:localize("maxLengthWarning","String is longer than the maximum length of {0}.",t.maxLength)});if((0,objects_1.isString)(t.pattern)){(0,strings_1.extendedRegExp)(t.pattern).test(e.value)||o.problems.push({location:{offset:e.offset,length:e.length},message:t.patternErrorMessage||t.errorMessage||localize("patternWarning",'String does not match the pattern of "{0}".',t.pattern)})}if(t.format)switch(t.format){case"uri":case"uri-reference":{let s;if(e.value){const o=/^(([^:/?#]+?):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/.exec(e.value);o?o[2]||"uri"!==t.format||(s=localize("uriSchemeMissing","URI with a scheme is expected.")):s=localize("uriMissing","URI is expected.")}else s=localize("uriEmpty","URI expected.");s&&o.problems.push({location:{offset:e.offset,length:e.length},message:t.patternErrorMessage||t.errorMessage||localize("uriFormatWarning","String is not a URI: {0}",s)})}break;case"color-hex":case"date-time":case"date":case"time":case"email":const s=formats[t.format];e.value&&s.pattern.exec(e.value)||o.problems.push({location:{offset:e.offset,length:e.length},message:t.patternErrorMessage||t.errorMessage||s.errorMessage})}}(n,t,o);break;case"number":!function(e,t,o,s){const n=e.value;function r(e){var t;const o=/^(-?\d+)(?:\.(\d+))?(?:e([-+]\d+))?$/.exec(e.toString());return o&&{value:Number(o[1]+(o[2]||"")),multiplier:((null===(t=o[2])||void 0===t?void 0:t.length)||0)-(parseInt(o[3])||0)}}if((0,objects_1.isNumber)(t.multipleOf)){let s=-1;if(Number.isInteger(t.multipleOf))s=n%t.multipleOf;else{let e=r(t.multipleOf),o=r(n);if(e&&o){const t=10**Math.abs(o.multiplier-e.multiplier);o.multiplier<e.multiplier?o.value*=t:e.value*=t,s=o.value%e.value}}0!==s&&o.problems.push({location:{offset:e.offset,length:e.length},message:localize("multipleOfWarning","Value is not divisible by {0}.",t.multipleOf)})}function a(e,t){return(0,objects_1.isNumber)(t)?t:(0,objects_1.isBoolean)(t)&&t?e:void 0}function i(e,t){if(!(0,objects_1.isBoolean)(t)||!t)return e}const l=a(t.minimum,t.exclusiveMinimum);(0,objects_1.isNumber)(l)&&n<=l&&o.problems.push({location:{offset:e.offset,length:e.length},message:localize("exclusiveMinimumWarning","Value is below the exclusive minimum of {0}.",l)});const c=a(t.maximum,t.exclusiveMaximum);(0,objects_1.isNumber)(c)&&n>=c&&o.problems.push({location:{offset:e.offset,length:e.length},message:localize("exclusiveMaximumWarning","Value is above the exclusive maximum of {0}.",c)});const u=i(t.minimum,t.exclusiveMinimum);(0,objects_1.isNumber)(u)&&n<u&&o.problems.push({location:{offset:e.offset,length:e.length},message:localize("minimumWarning","Value is below the minimum of {0}.",u)});const p=i(t.maximum,t.exclusiveMaximum);(0,objects_1.isNumber)(p)&&n>p&&o.problems.push({location:{offset:e.offset,length:e.length},message:localize("maximumWarning","Value is above the maximum of {0}.",p)})}(n,t,o);break;case"property":return validate(n.valueNode,t,o,s)}!function(){function e(e){return n.type===e||"integer"===e&&"number"===n.type&&n.isInteger}Array.isArray(t.type)?t.type.some(e)||o.problems.push({location:{offset:n.offset,length:n.length},message:t.errorMessage||localize("typeArrayMismatchWarning","Incorrect type. Expected one of {0}.",t.type.join(", "))}):t.type&&(e(t.type)||o.problems.push({location:{offset:n.offset,length:n.length},message:t.errorMessage||localize("typeMismatchWarning",'Incorrect type. Expected "{0}".',t.type)}));if(Array.isArray(t.allOf))for(const e of t.allOf)validate(n,asSchema(e),o,s);const r=asSchema(t.not);if(r){const e=new ValidationResult,t=s.newSub();validate(n,r,e,t),e.hasProblems()||o.problems.push({location:{offset:n.offset,length:n.length},message:localize("notSchemaWarning","Matches a schema that is not allowed.")});for(const e of t.schemas)e.inverted=!e.inverted,s.add(e)}const a=(e,t)=>{const r=[];let a;for(const o of e){const e=asSchema(o),i=new ValidationResult,l=s.newSub();if(validate(n,e,i,l),i.hasProblems()||r.push(e),a)if(t||i.hasProblems()||a.validationResult.hasProblems()){const t=i.compare(a.validationResult);t>0?a={schema:e,validationResult:i,matchingSchemas:l}:0===t&&(a.matchingSchemas.merge(l),a.validationResult.mergeEnumValues(i))}else a.matchingSchemas.merge(l),a.validationResult.propertiesMatches+=i.propertiesMatches,a.validationResult.propertiesValueMatches+=i.propertiesValueMatches;else a={schema:e,validationResult:i,matchingSchemas:l}}return r.length>1&&t&&o.problems.push({location:{offset:n.offset,length:1},message:localize("oneOfWarning","Matches multiple schemas when only one must validate.")}),a&&(o.merge(a.validationResult),o.propertiesMatches+=a.validationResult.propertiesMatches,o.propertiesValueMatches+=a.validationResult.propertiesValueMatches,s.merge(a.matchingSchemas)),r.length};Array.isArray(t.anyOf)&&a(t.anyOf,!1);Array.isArray(t.oneOf)&&a(t.oneOf,!0);const i=e=>{const t=new ValidationResult,r=s.newSub();validate(n,asSchema(e),t,r),o.merge(t),o.propertiesMatches+=t.propertiesMatches,o.propertiesValueMatches+=t.propertiesValueMatches,s.merge(r)},l=asSchema(t.if);l&&((e,t,o)=>{const r=asSchema(e),a=new ValidationResult,l=s.newSub();validate(n,r,a,l),s.merge(l),a.hasProblems()?o&&i(o):t&&i(t)})(l,asSchema(t.then),asSchema(t.else));if(Array.isArray(t.enum)){const e=getNodeValue(n);let s=!1;for(const o of t.enum)if((0,objects_1.equals)(e,o)){s=!0;break}o.enumValues=t.enum,o.enumValueMatch=s,s||o.problems.push({location:{offset:n.offset,length:n.length},code:jsonLanguageTypes_1.ErrorCode.EnumValueMismatch,message:t.errorMessage||localize("enumWarning","Value is not accepted. Valid values: {0}.",t.enum.map((e=>JSON.stringify(e))).join(", "))})}if((0,objects_1.isDefined)(t.const)){const e=getNodeValue(n);(0,objects_1.equals)(e,t.const)?o.enumValueMatch=!0:(o.problems.push({location:{offset:n.offset,length:n.length},code:jsonLanguageTypes_1.ErrorCode.EnumValueMismatch,message:t.errorMessage||localize("constWarning","Value must be {0}.",JSON.stringify(t.const))}),o.enumValueMatch=!1),o.enumValues=[t.const]}t.deprecationMessage&&n.parent&&o.problems.push({location:{offset:n.parent.offset,length:n.parent.length},severity:jsonLanguageTypes_1.DiagnosticSeverity.Warning,message:t.deprecationMessage,code:jsonLanguageTypes_1.ErrorCode.Deprecated})}(),s.add({node:n,schema:t})}function parse(e,t){const o=[];let s=-1;const n=e.getText(),r=Json.createScanner(n,!1),a=t&&t.collectComments?[]:void 0;function i(){for(;;){const t=r.scan();switch(u(),t){case 12:case 13:Array.isArray(a)&&a.push(jsonLanguageTypes_1.Range.create(e.positionAt(r.getTokenOffset()),e.positionAt(r.getTokenOffset()+r.getTokenLength())));break;case 15:case 14:break;default:return t}}}function l(t,n,r,a,i=jsonLanguageTypes_1.DiagnosticSeverity.Error){if(0===o.length||r!==s){const l=jsonLanguageTypes_1.Range.create(e.positionAt(r),e.positionAt(a));o.push(jsonLanguageTypes_1.Diagnostic.create(l,t,i,n,e.languageId)),s=r}}function c(e,t,o,s=[],a=[]){let c=r.getTokenOffset(),u=r.getTokenOffset()+r.getTokenLength();if(c===u&&c>0){for(c--;c>0&&/\s/.test(n.charAt(c));)c--;u=c+1}if(l(e,t,c,u),o&&p(o,!1),s.length+a.length>0){let e=r.getToken();for(;17!==e;){if(-1!==s.indexOf(e)){i();break}if(-1!==a.indexOf(e))break;e=i()}}return o}function u(){switch(r.getTokenError()){case 4:return c(localize("InvalidUnicode","Invalid unicode sequence in string."),jsonLanguageTypes_1.ErrorCode.InvalidUnicode),!0;case 5:return c(localize("InvalidEscapeCharacter","Invalid escape character in string."),jsonLanguageTypes_1.ErrorCode.InvalidEscapeCharacter),!0;case 3:return c(localize("UnexpectedEndOfNumber","Unexpected end of number."),jsonLanguageTypes_1.ErrorCode.UnexpectedEndOfNumber),!0;case 1:return c(localize("UnexpectedEndOfComment","Unexpected end of comment."),jsonLanguageTypes_1.ErrorCode.UnexpectedEndOfComment),!0;case 2:return c(localize("UnexpectedEndOfString","Unexpected end of string."),jsonLanguageTypes_1.ErrorCode.UnexpectedEndOfString),!0;case 6:return c(localize("InvalidCharacter","Invalid characters in string. Control characters must be escaped."),jsonLanguageTypes_1.ErrorCode.InvalidCharacter),!0}return!1}function p(e,t){return e.length=r.getTokenOffset()+r.getTokenLength()-e.offset,t&&i(),e}const m=new StringASTNodeImpl(void 0,0,0);function g(t,o){const s=new PropertyASTNodeImpl(t,r.getTokenOffset(),m);let n=f(s);if(!n){if(16!==r.getToken())return;{c(localize("DoubleQuotesExpected","Property keys must be doublequoted"),jsonLanguageTypes_1.ErrorCode.Undefined);const e=new StringASTNodeImpl(s,r.getTokenOffset(),r.getTokenLength());e.value=r.getTokenValue(),n=e,i()}}s.keyNode=n;const a=o[n.value];if(a?(l(localize("DuplicateKeyWarning","Duplicate object key"),jsonLanguageTypes_1.ErrorCode.DuplicateKey,s.keyNode.offset,s.keyNode.offset+s.keyNode.length,jsonLanguageTypes_1.DiagnosticSeverity.Warning),"object"==typeof a&&l(localize("DuplicateKeyWarning","Duplicate object key"),jsonLanguageTypes_1.ErrorCode.DuplicateKey,a.keyNode.offset,a.keyNode.offset+a.keyNode.length,jsonLanguageTypes_1.DiagnosticSeverity.Warning),o[n.value]=!0):o[n.value]=s,6===r.getToken())s.colonOffset=r.getTokenOffset(),i();else if(c(localize("ColonExpected","Colon expected"),jsonLanguageTypes_1.ErrorCode.ColonExpected),10===r.getToken()&&e.positionAt(n.offset+n.length).line<e.positionAt(r.getTokenOffset()).line)return s.length=n.length,s;const u=h(s);return u?(s.valueNode=u,s.length=u.offset+u.length-s.offset,s):c(localize("ValueExpected","Value expected"),jsonLanguageTypes_1.ErrorCode.ValueExpected,s,[],[2,5])}function f(e){if(10!==r.getToken())return;const t=new StringASTNodeImpl(e,r.getTokenOffset());return t.value=r.getTokenValue(),p(t,!0)}function h(e){return function(e){if(3!==r.getToken())return;const t=new ArrayASTNodeImpl(e,r.getTokenOffset());i();let o=!1;for(;4!==r.getToken()&&17!==r.getToken();){if(5===r.getToken()){o||c(localize("ValueExpected","Value expected"),jsonLanguageTypes_1.ErrorCode.ValueExpected);const e=r.getTokenOffset();if(i(),4===r.getToken()){o&&l(localize("TrailingComma","Trailing comma"),jsonLanguageTypes_1.ErrorCode.TrailingComma,e,e+1);continue}}else o&&c(localize("ExpectedComma","Expected comma"),jsonLanguageTypes_1.ErrorCode.CommaExpected);const e=h(t);e?t.items.push(e):c(localize("PropertyExpected","Value expected"),jsonLanguageTypes_1.ErrorCode.ValueExpected,void 0,[],[4,5]),o=!0}return 4!==r.getToken()?c(localize("ExpectedCloseBracket","Expected comma or closing bracket"),jsonLanguageTypes_1.ErrorCode.CommaOrCloseBacketExpected,t):p(t,!0)}(e)||function(e){if(1!==r.getToken())return;const t=new ObjectASTNodeImpl(e,r.getTokenOffset()),o=Object.create(null);i();let s=!1;for(;2!==r.getToken()&&17!==r.getToken();){if(5===r.getToken()){s||c(localize("PropertyExpected","Property expected"),jsonLanguageTypes_1.ErrorCode.PropertyExpected);const e=r.getTokenOffset();if(i(),2===r.getToken()){s&&l(localize("TrailingComma","Trailing comma"),jsonLanguageTypes_1.ErrorCode.TrailingComma,e,e+1);continue}}else s&&c(localize("ExpectedComma","Expected comma"),jsonLanguageTypes_1.ErrorCode.CommaExpected);const e=g(t,o);e?t.properties.push(e):c(localize("PropertyExpected","Property expected"),jsonLanguageTypes_1.ErrorCode.PropertyExpected,void 0,[],[2,5]),s=!0}return 2!==r.getToken()?c(localize("ExpectedCloseBrace","Expected comma or closing brace"),jsonLanguageTypes_1.ErrorCode.CommaOrCloseBraceExpected,t):p(t,!0)}(e)||f(e)||function(e){if(11!==r.getToken())return;const t=new NumberASTNodeImpl(e,r.getTokenOffset());if(0===r.getTokenError()){const e=r.getTokenValue();try{const o=JSON.parse(e);if(!(0,objects_1.isNumber)(o))return c(localize("InvalidNumberFormat","Invalid number format."),jsonLanguageTypes_1.ErrorCode.Undefined,t);t.value=o}catch(e){return c(localize("InvalidNumberFormat","Invalid number format."),jsonLanguageTypes_1.ErrorCode.Undefined,t)}t.isInteger=-1===e.indexOf(".")}return p(t,!0)}(e)||function(e){switch(r.getToken()){case 7:return p(new NullASTNodeImpl(e,r.getTokenOffset()),!0);case 8:return p(new BooleanASTNodeImpl(e,!0,r.getTokenOffset()),!0);case 9:return p(new BooleanASTNodeImpl(e,!1,r.getTokenOffset()),!0);default:return}}(e)}let d;return 17!==i()&&(d=h(d),d?17!==r.getToken()&&c(localize("End of file expected","End of file expected."),jsonLanguageTypes_1.ErrorCode.Undefined):c(localize("Invalid symbol","Expected a JSON object, array or literal."),jsonLanguageTypes_1.ErrorCode.Undefined)),new JSONDocument(d,o,a)}exports.JSONDocument=JSONDocument,exports.parse=parse;
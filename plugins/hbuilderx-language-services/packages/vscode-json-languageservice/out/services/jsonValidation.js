"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,o,t,n){void 0===n&&(n=t);var i=Object.getOwnPropertyDescriptor(o,t);i&&!("get"in i?!o.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return o[t]}}),Object.defineProperty(e,n,i)}:function(e,o,t,n){void 0===n&&(n=t),e[n]=o[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,o){Object.defineProperty(e,"default",{enumerable:!0,value:o})}:function(e,o){e.default=o}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var o={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(o,e,t);return __setModuleDefault(o,e),o};Object.defineProperty(exports,"__esModule",{value:!0}),exports.JSONValidation=void 0;const jsonSchemaService_1=require("./jsonSchemaService"),jsonLanguageTypes_1=require("../jsonLanguageTypes"),nls=__importStar(require("vscode-nls")),objects_1=require("../utils/objects"),localize=nls.loadMessageBundle();class JSONValidation{constructor(e,o){this.jsonSchemaService=e,this.promise=o,this.validationEnabled=!0}configure(e){e&&(this.validationEnabled=!1!==e.validate,this.commentSeverity=e.allowComments?void 0:jsonLanguageTypes_1.DiagnosticSeverity.Error)}doValidation(e,o,t,n){if(!this.validationEnabled)return this.promise.resolve([]);const i=[],s={},a=e=>{const o=e.range.start.line+" "+e.range.start.character+" "+e.message;s[o]||(s[o]=!0,i.push(e))},r=n=>{let s=t?toDiagnosticSeverity(t.trailingCommas):jsonLanguageTypes_1.DiagnosticSeverity.Error,r=t?toDiagnosticSeverity(t.comments):this.commentSeverity,c=(null==t?void 0:t.schemaValidation)?toDiagnosticSeverity(t.schemaValidation):jsonLanguageTypes_1.DiagnosticSeverity.Warning,l=(null==t?void 0:t.schemaRequest)?toDiagnosticSeverity(t.schemaRequest):jsonLanguageTypes_1.DiagnosticSeverity.Warning;if(n){if(n.errors.length&&o.root&&l){const t=o.root,i="object"===t.type?t.properties[0]:void 0;if(i&&"$schema"===i.keyNode.value){const o=i.valueNode||i,t=jsonLanguageTypes_1.Range.create(e.positionAt(o.offset),e.positionAt(o.offset+o.length));a(jsonLanguageTypes_1.Diagnostic.create(t,n.errors[0],l,jsonLanguageTypes_1.ErrorCode.SchemaResolveError))}else{const o=jsonLanguageTypes_1.Range.create(e.positionAt(t.offset),e.positionAt(t.offset+1));a(jsonLanguageTypes_1.Diagnostic.create(o,n.errors[0],l,jsonLanguageTypes_1.ErrorCode.SchemaResolveError))}}else if(c){const t=o.validate(e,n.schema,c);t&&t.forEach(a)}schemaAllowsComments(n.schema)&&(r=void 0),schemaAllowsTrailingCommas(n.schema)&&(s=void 0)}for(const e of o.syntaxErrors){if(e.code===jsonLanguageTypes_1.ErrorCode.TrailingComma){if("number"!=typeof s)continue;e.severity=s}a(e)}if("number"==typeof r){const e=localize("InvalidCommentToken","Comments are not permitted in JSON.");o.comments.forEach((o=>{a(jsonLanguageTypes_1.Diagnostic.create(o,e,r,jsonLanguageTypes_1.ErrorCode.CommentNotPermitted))}))}return i};if(n){const e=n.id||"schemaservice://untitled/"+idCounter++;return this.jsonSchemaService.resolveSchemaContent(new jsonSchemaService_1.UnresolvedSchema(n),e,{}).then((e=>r(e)))}return this.jsonSchemaService.getSchemaForResource(e.uri,o).then((e=>r(e)))}}exports.JSONValidation=JSONValidation;let idCounter=0;function schemaAllowsComments(e){if(e&&"object"==typeof e){if((0,objects_1.isBoolean)(e.allowComments))return e.allowComments;if(e.allOf)for(const o of e.allOf){const e=schemaAllowsComments(o);if((0,objects_1.isBoolean)(e))return e}}}function schemaAllowsTrailingCommas(e){if(e&&"object"==typeof e){if((0,objects_1.isBoolean)(e.allowTrailingCommas))return e.allowTrailingCommas;const o=e;if((0,objects_1.isBoolean)(o.allowsTrailingCommas))return o.allowsTrailingCommas;if(e.allOf)for(const o of e.allOf){const e=schemaAllowsTrailingCommas(o);if((0,objects_1.isBoolean)(e))return e}}}function toDiagnosticSeverity(e){switch(e){case"error":return jsonLanguageTypes_1.DiagnosticSeverity.Error;case"warning":return jsonLanguageTypes_1.DiagnosticSeverity.Warning;case"ignore":return}}
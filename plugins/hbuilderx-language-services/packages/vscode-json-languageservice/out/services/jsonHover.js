"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var o=Object.getOwnPropertyDescriptor(t,r);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,o)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.JSONHover=void 0;const jsonLanguageTypes_1=require("../jsonLanguageTypes"),Parser=__importStar(require("../parser/jsonParser")),extTool_1=require("../utils/extTool");class JSONHover{constructor(e,t=[],r){this.schemaService=e,this.contributions=t,this.promise=r||Promise}doHover(e,t,r){const n=e.offsetAt(t);let o=r.getNodeFromOffset(n);if(!o||("object"===o.type||"array"===o.type)&&n>o.offset+1&&n<o.offset+o.length-1)return this.promise.resolve(null);const i=o;if(o.parent){const e=o.parent;if("property"===e.type&&o.value!==e.keyNode.value)return this.promise.resolve(null)}if("string"===o.type){const e=o.parent;if(e&&"property"===e.type&&e.keyNode===o&&(o=e.valueNode,!o))return this.promise.resolve(null)}const s=jsonLanguageTypes_1.Range.create(e.positionAt(i.offset),e.positionAt(i.offset+i.length));var a=(e,t)=>({contents:e,range:s,extData:t});const c=Parser.getNodePath(o);for(let t=this.contributions.length-1;t>=0;t--){const r=this.contributions[t].getInfoContribution(e.uri,c);if(r)return r.then((e=>a(e)))}return this.schemaService.getSchemaForResource(e.uri,r).then((e=>{if(e&&o){let t,n,i,s,c,u;r.getMatchingSchemas(e.schema,o.offset).every((e=>{if(e.node===o&&!e.inverted&&e.schema&&(t=t||e.schema.title,n=n||e.schema.markdownDescription||toMarkdown(e.schema.description),c=(0,extTool_1.getDetailFromType)("",e.schema.type,e.node),u=e.schema.uniPlatform,e.schema.enum)){const t=e.schema.enum.indexOf(Parser.getNodeValue(o));e.schema.markdownEnumDescriptions?i=e.schema.markdownEnumDescriptions[t]:e.schema.enumDescriptions&&(i=toMarkdown(e.schema.enumDescriptions[t])),i&&(s=e.schema.enum[t],"string"!=typeof s&&(s=JSON.stringify(s)))}return!0}));let l="";return t&&(l=toMarkdown(t)),n&&(l.length>0&&(l+="\n\n"),l+=n),i&&(l.length>0&&(l+="\n\n"),l+=`\`${toMarkdownCodeBlock(s)}\`: ${i}`),a([l],{detail:c,uniPlatform:u})}return null}))}}function toMarkdown(e){if(e){return e.replace(/([^\n\r])(\r?\n)([^\n\r])/gm,"$1\n\n$3").replace(/[\\`*_{}[\]()#+\-.!]/g,"\\$&")}}function toMarkdownCodeBlock(e){return-1!==e.indexOf("`")?"`` "+e+" ``":e}exports.JSONHover=JSONHover;
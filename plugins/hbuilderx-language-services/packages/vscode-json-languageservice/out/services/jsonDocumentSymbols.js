"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,r)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.JSONDocumentSymbols=void 0;const Parser=__importStar(require("../parser/jsonParser")),Strings=__importStar(require("../utils/strings")),colors_1=require("../utils/colors"),jsonLanguageTypes_1=require("../jsonLanguageTypes");class JSONDocumentSymbols{constructor(e){this.schemaService=e}findDocumentSymbols(e,t,n={resultLimit:Number.MAX_VALUE}){const o=t.root;if(!o)return[];let r=n.resultLimit||Number.MAX_VALUE;const i=e.uri;if(("vscode://defaultsettings/keybindings.json"===i||Strings.endsWith(i.toLowerCase(),"/user/keybindings.json"))&&"array"===o.type){const t=[];for(const s of o.items)if("object"===s.type)for(const o of s.properties)if("key"===o.keyNode.value&&o.valueNode){const a=jsonLanguageTypes_1.Location.create(e.uri,getRange(e,s));if(t.push({name:Parser.getNodeValue(o.valueNode),kind:jsonLanguageTypes_1.SymbolKind.Function,location:a}),r--,r<=0)return n&&n.onResultLimitExceeded&&n.onResultLimitExceeded(i),t}return t}const s=[{node:o,containerName:""}];let a=0,u=!1;const c=[],l=(t,n)=>{"array"===t.type?t.items.forEach((e=>{e&&s.push({node:e,containerName:n})})):"object"===t.type&&t.properties.forEach((t=>{const o=t.valueNode;if(o)if(r>0){r--;const i=jsonLanguageTypes_1.Location.create(e.uri,getRange(e,t)),a=n?n+"."+t.keyNode.value:t.keyNode.value;c.push({name:this.getKeyLabel(t),kind:this.getSymbolKind(o.type),location:i,containerName:n}),s.push({node:o,containerName:a})}else u=!0}))};for(;a<s.length;){const e=s[a++];l(e.node,e.containerName)}return u&&n&&n.onResultLimitExceeded&&n.onResultLimitExceeded(i),c}findDocumentSymbols2(e,t,n={resultLimit:Number.MAX_VALUE}){const o=t.root;if(!o)return[];let r=n.resultLimit||Number.MAX_VALUE;const i=e.uri;if(("vscode://defaultsettings/keybindings.json"===i||Strings.endsWith(i.toLowerCase(),"/user/keybindings.json"))&&"array"===o.type){const t=[];for(const s of o.items)if("object"===s.type)for(const o of s.properties)if("key"===o.keyNode.value&&o.valueNode){const a=getRange(e,s),u=getRange(e,o.keyNode);if(t.push({name:Parser.getNodeValue(o.valueNode),kind:jsonLanguageTypes_1.SymbolKind.Function,range:a,selectionRange:u}),r--,r<=0)return n&&n.onResultLimitExceeded&&n.onResultLimitExceeded(i),t}return t}const s=[],a=[{node:o,result:s}];let u=0,c=!1;const l=(t,n)=>{"array"===t.type?t.items.forEach(((t,o)=>{if(t)if(r>0){r--;const i=getRange(e,t),s=i,u={name:String(o),kind:this.getSymbolKind(t.type),range:i,selectionRange:s,children:[]};n.push(u),a.push({result:u.children,node:t})}else c=!0})):"object"===t.type&&t.properties.forEach((t=>{const o=t.valueNode;if(o)if(r>0){r--;const i=getRange(e,t),s=getRange(e,t.keyNode),u=[],c={name:this.getKeyLabel(t),kind:this.getSymbolKind(o.type),range:i,selectionRange:s,children:u,detail:this.getDetail(o)};n.push(c),a.push({result:u,node:o})}else c=!0}))};for(;u<a.length;){const e=a[u++];l(e.node,e.result)}return c&&n&&n.onResultLimitExceeded&&n.onResultLimitExceeded(i),s}getSymbolKind(e){switch(e){case"object":return jsonLanguageTypes_1.SymbolKind.Module;case"string":return jsonLanguageTypes_1.SymbolKind.String;case"number":return jsonLanguageTypes_1.SymbolKind.Number;case"array":return jsonLanguageTypes_1.SymbolKind.Array;case"boolean":return jsonLanguageTypes_1.SymbolKind.Boolean;default:return jsonLanguageTypes_1.SymbolKind.Variable}}getKeyLabel(e){let t=e.keyNode.value;return t&&(t=t.replace(/[\n]/g,"â†µ")),t&&t.trim()?t:`"${t}"`}getDetail(e){if(e)return"boolean"===e.type||"number"===e.type||"null"===e.type||"string"===e.type?String(e.value):"array"===e.type?e.children.length?void 0:"[]":"object"===e.type?e.children.length?void 0:"{}":void 0}findDocumentColors(e,t,n){return this.schemaService.getSchemaForResource(e.uri,t).then((o=>{const r=[];if(o){let i=n&&"number"==typeof n.resultLimit?n.resultLimit:Number.MAX_VALUE;const s=t.getMatchingSchemas(o.schema),a={};for(const t of s)if(!t.inverted&&t.schema&&("color"===t.schema.format||"color-hex"===t.schema.format)&&t.node&&"string"===t.node.type){const o=String(t.node.offset);if(!a[o]){const s=(0,colors_1.colorFromHex)(Parser.getNodeValue(t.node));if(s){const n=getRange(e,t.node);r.push({color:s,range:n})}if(a[o]=!0,i--,i<=0)return n&&n.onResultLimitExceeded&&n.onResultLimitExceeded(e.uri),r}}}return r}))}getColorPresentations(e,t,n,o){const r=[],i=Math.round(255*n.red),s=Math.round(255*n.green),a=Math.round(255*n.blue);function u(e){const t=e.toString(16);return 2!==t.length?"0"+t:t}let c;return c=1===n.alpha?`#${u(i)}${u(s)}${u(a)}`:`#${u(i)}${u(s)}${u(a)}${u(Math.round(255*n.alpha))}`,r.push({label:c,textEdit:jsonLanguageTypes_1.TextEdit.replace(o,JSON.stringify(c))}),r}}function getRange(e,t){return jsonLanguageTypes_1.Range.create(e.positionAt(t.offset),e.positionAt(t.offset+t.length))}exports.JSONDocumentSymbols=JSONDocumentSymbols;
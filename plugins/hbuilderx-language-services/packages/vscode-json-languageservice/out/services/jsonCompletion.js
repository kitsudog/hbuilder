"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,n)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.JSONCompletion=void 0;const Json=__importStar(require("jsonc-parser")),jsonLanguageTypes_1=require("../jsonLanguageTypes"),Parser=__importStar(require("../parser/jsonParser")),json_1=require("../utils/json"),objects_1=require("../utils/objects"),strings_1=require("../utils/strings"),nls=__importStar(require("vscode-nls")),extTool_1=require("../utils/extTool"),localize=nls.loadMessageBundle(),valueCommitCharacters=[",","}","]"],propertyCommitCharacters=[":"];class JSONCompletion{constructor(e,t=[],r=Promise,o={}){this.schemaService=e,this.contributions=t,this.promiseConstructor=r,this.clientCapabilities=o}doResolve(e){for(let t=this.contributions.length-1;t>=0;t--){const r=this.contributions[t].resolveCompletion;if(r){const t=r(e);if(t)return t}}return this.promiseConstructor.resolve(e)}doComplete(e,t,r){const o={items:[],isIncomplete:!1},n=e.getText(),s=e.offsetAt(t);let i=r.getNodeFromOffset(s,!0);if(this.isInComment(e,i?i.offset:0,s))return Promise.resolve(o);if(i&&s===i.offset+i.length&&s>0){const e=n[s-1];("object"===i.type&&"}"===e||"array"===i.type&&"]"===e)&&(i=i.parent)}const a=this.getCurrentWord(e,s);let l;if(!i||"string"!==i.type&&"number"!==i.type&&"boolean"!==i.type&&"null"!==i.type){let r=s-a.length;r>0&&'"'===n[r-1]&&r--,l=jsonLanguageTypes_1.Range.create(e.positionAt(r),t)}else l=jsonLanguageTypes_1.Range.create(e.positionAt(i.offset),e.positionAt(i.offset+i.length));const p={},u={add:e=>{let t=e.label;const r=p[t];if(r)r.documentation||(r.documentation=e.documentation),r.detail||(r.detail=e.detail),r.uniPlatform||(r.uniPlatform=e.uniPlatform);else{if(t=t.replace(/[\n]/g,"â†µ"),t.length>60){const e=t.substr(0,57).trim()+"...";p[e]||(t=e)}l&&void 0!==e.insertText&&(e.textEdit=jsonLanguageTypes_1.TextEdit.replace(l,e.insertText)),e.label=t,p[t]=e,o.items.push(e)}},setAsIncomplete:()=>{o.isIncomplete=!0},error:e=>{console.error(e)},log:e=>{console.log(e)},getNumberOfProposals:()=>o.items.length};return this.schemaService.getSchemaForResource(e.uri,r).then((t=>{const c=[];let d,m=!0,g="";if(i&&"string"===i.type){const e=i.parent;e&&"property"===e.type&&e.keyNode===i&&(m=!e.valueNode,d=e,g=n.substr(i.offset+1,i.length-2),e&&(i=e.parent))}if(i&&"object"===i.type){if(i.offset===s)return o;i.properties.forEach((e=>{if(!d||d!==e){const t={label:"__"};p[e.keyNode.value]=t}}));let h="";m&&(h=this.evaluateSeparatorAfter(e,e.offsetAt(l.end))),t?this.getPropertyCompletions(t,r,i,m,h,u):this.getSchemaLessPropertyCompletions(r,i,g,u);const f=Parser.getNodePath(i);this.contributions.forEach((t=>{const r=t.collectPropertyCompletions(e.uri,f,a,m,""===h,u);r&&c.push(r)})),!t&&a.length>0&&'"'!==n.charAt(s-a.length-1)&&(u.add({kind:jsonLanguageTypes_1.CompletionItemKind.Property,label:this.getLabelForValue(a),insertText:this.getInsertTextForProperty(a,void 0,!1,h),insertTextFormat:jsonLanguageTypes_1.InsertTextFormat.Snippet,documentation:""}),u.setAsIncomplete())}const h={};return t?this.getValueCompletions(t,r,i,s,e,u,h):this.getSchemaLessValueCompletions(r,i,s,e,u),this.contributions.length>0&&this.getContributedValueCompletions(r,i,s,e,u,c),this.promiseConstructor.all(c).then((()=>{if(0===u.getNumberOfProposals()){let t=s;!i||"string"!==i.type&&"number"!==i.type&&"boolean"!==i.type&&"null"!==i.type||(t=i.offset+i.length);const r=this.evaluateSeparatorAfter(e,t);this.addFillerValueCompletions(h,r,u)}return o}))}))}getPropertyCompletions(e,t,r,o,n,s){t.getMatchingSchemas(e.schema,r.offset).forEach((e=>{if(e.node===r&&!e.inverted){const t=e.schema.properties;t&&Object.keys(t).forEach((e=>{const r=t[e];if("object"==typeof r&&!r.deprecationMessage&&!r.doNotSuggest){const t={kind:jsonLanguageTypes_1.CompletionItemKind.Property,label:e,insertText:this.getInsertTextForProperty(e,r,o,n),insertTextFormat:jsonLanguageTypes_1.InsertTextFormat.Snippet,filterText:this.getFilterTextForValue(e),documentation:this.fromMarkup(r.markdownDescription)||r.description||"",uniPlatform:r.uniPlatform,detail:(0,extTool_1.getDetailFromType)(e,r.type)};void 0!==r.suggestSortText&&(t.sortText=r.suggestSortText),t.insertText&&(0,strings_1.endsWith)(t.insertText,`$1${n}`)&&(t.command={title:"Suggest",command:"editor.action.triggerSuggest"}),s.add(t)}}));const r=e.schema.propertyNames;if("object"==typeof r&&!r.deprecationMessage&&!r.doNotSuggest){const e=(e,t)=>{const i={kind:jsonLanguageTypes_1.CompletionItemKind.Property,label:e,insertText:this.getInsertTextForProperty(e,void 0,o,n),insertTextFormat:jsonLanguageTypes_1.InsertTextFormat.Snippet,filterText:this.getFilterTextForValue(e),documentation:t||this.fromMarkup(r.markdownDescription)||r.description||"",uniPlatform:r.uniPlatform,detail:(0,extTool_1.getDetailFromType)(e,r.type)};void 0!==r.suggestSortText&&(i.sortText=r.suggestSortText),i.insertText&&(0,strings_1.endsWith)(i.insertText,`$1${n}`)&&(i.command={title:"Suggest",command:"editor.action.triggerSuggest"}),s.add(i)};if(r.enum)for(let t=0;t<r.enum.length;t++){let o;r.markdownEnumDescriptions&&t<r.markdownEnumDescriptions.length?o=this.fromMarkup(r.markdownEnumDescriptions[t]):r.enumDescriptions&&t<r.enumDescriptions.length&&(o=r.enumDescriptions[t]),e(r.enum[t],o)}r.const&&e(r.const)}}}))}getSchemaLessPropertyCompletions(e,t,r,o){const n=e=>{e.properties.forEach((e=>{const t=e.keyNode.value;o.add({kind:jsonLanguageTypes_1.CompletionItemKind.Property,label:t,insertText:this.getInsertTextForValue(t,""),insertTextFormat:jsonLanguageTypes_1.InsertTextFormat.Snippet,filterText:this.getFilterTextForValue(t),documentation:""})}))};if(t.parent)if("property"===t.parent.type){const r=t.parent.keyNode.value;e.visit((e=>("property"===e.type&&e!==t.parent&&e.keyNode.value===r&&e.valueNode&&"object"===e.valueNode.type&&n(e.valueNode),!0)))}else"array"===t.parent.type&&t.parent.items.forEach((e=>{"object"===e.type&&e!==t&&n(e)}));else"object"===t.type&&o.add({kind:jsonLanguageTypes_1.CompletionItemKind.Property,label:"$schema",insertText:this.getInsertTextForProperty("$schema",void 0,!0,""),insertTextFormat:jsonLanguageTypes_1.InsertTextFormat.Snippet,documentation:"",filterText:this.getFilterTextForValue("$schema")})}getSchemaLessValueCompletions(e,t,r,o,n){let s=r;if(!t||"string"!==t.type&&"number"!==t.type&&"boolean"!==t.type&&"null"!==t.type||(s=t.offset+t.length,t=t.parent),!t)return n.add({kind:this.getSuggestionKind("object"),label:"Empty object",insertText:this.getInsertTextForValue({},""),insertTextFormat:jsonLanguageTypes_1.InsertTextFormat.Snippet,documentation:""}),void n.add({kind:this.getSuggestionKind("array"),label:"Empty array",insertText:this.getInsertTextForValue([],""),insertTextFormat:jsonLanguageTypes_1.InsertTextFormat.Snippet,documentation:""});const i=this.evaluateSeparatorAfter(o,s),a=e=>{e.parent&&!Parser.contains(e.parent,r,!0)&&n.add({kind:this.getSuggestionKind(e.type),label:this.getLabelTextForMatchingNode(e,o),insertText:this.getInsertTextForMatchingNode(e,o,i),insertTextFormat:jsonLanguageTypes_1.InsertTextFormat.Snippet,documentation:""}),"boolean"===e.type&&this.addBooleanValueCompletion(!e.value,i,n)};if("property"===t.type&&r>(t.colonOffset||0)){const o=t.valueNode;if(o&&(r>o.offset+o.length||"object"===o.type||"array"===o.type))return;const s=t.keyNode.value;e.visit((e=>("property"===e.type&&e.keyNode.value===s&&e.valueNode&&a(e.valueNode),!0))),"$schema"===s&&t.parent&&!t.parent.parent&&this.addDollarSchemaCompletions(i,n)}if("array"===t.type)if(t.parent&&"property"===t.parent.type){const r=t.parent.keyNode.value;e.visit((e=>("property"===e.type&&e.keyNode.value===r&&e.valueNode&&"array"===e.valueNode.type&&e.valueNode.items.forEach(a),!0)))}else t.items.forEach(a)}getValueCompletions(e,t,r,o,n,s,i){let a,l,p=o;if(!r||"string"!==r.type&&"number"!==r.type&&"boolean"!==r.type&&"null"!==r.type||(p=r.offset+r.length,l=r,r=r.parent),r){if("property"===r.type&&o>(r.colonOffset||0)){const e=r.valueNode;if(e&&o>e.offset+e.length)return;a=r.keyNode.value,r=r.parent}if(r&&(void 0!==a||"array"===r.type)){const u=this.evaluateSeparatorAfter(n,p),c=t.getMatchingSchemas(e.schema,r.offset,l);for(const e of c)if(e.node===r&&!e.inverted&&e.schema){if("array"===r.type&&e.schema.items)if(Array.isArray(e.schema.items)){const t=this.findItemAtOffset(r,n,o);t<e.schema.items.length&&this.addSchemaValueCompletions(e.schema.items[t],u,s,i)}else this.addSchemaValueCompletions(e.schema.items,u,s,i);if(void 0!==a){let t=!1;if(e.schema.properties){const r=e.schema.properties[a];r&&(t=!0,this.addSchemaValueCompletions(r,u,s,i))}if(e.schema.patternProperties&&!t)for(const r of Object.keys(e.schema.patternProperties)){if((0,strings_1.extendedRegExp)(r).test(a)){t=!0;const o=e.schema.patternProperties[r];this.addSchemaValueCompletions(o,u,s,i)}}if(e.schema.additionalProperties&&!t){const t=e.schema.additionalProperties;this.addSchemaValueCompletions(t,u,s,i)}}}"$schema"!==a||r.parent||this.addDollarSchemaCompletions(u,s),i.boolean&&(this.addBooleanValueCompletion(!0,u,s),this.addBooleanValueCompletion(!1,u,s)),i.null&&this.addNullValueCompletion(u,s)}}else this.addSchemaValueCompletions(e.schema,"",s,i)}getContributedValueCompletions(e,t,r,o,n,s){if(t){if("string"!==t.type&&"number"!==t.type&&"boolean"!==t.type&&"null"!==t.type||(t=t.parent),t&&"property"===t.type&&r>(t.colonOffset||0)){const e=t.keyNode.value,i=t.valueNode;if((!i||r<=i.offset+i.length)&&t.parent){const r=Parser.getNodePath(t.parent);this.contributions.forEach((t=>{const i=t.collectValueCompletions(o.uri,r,e,n);i&&s.push(i)}))}}}else this.contributions.forEach((e=>{const t=e.collectDefaultCompletions(o.uri,n);t&&s.push(t)}))}addSchemaValueCompletions(e,t,r,o){"object"==typeof e&&(this.addEnumValueCompletions(e,t,r),this.addDefaultValueCompletions(e,t,r),this.collectTypes(e,o),Array.isArray(e.allOf)&&e.allOf.forEach((e=>this.addSchemaValueCompletions(e,t,r,o))),Array.isArray(e.anyOf)&&e.anyOf.forEach((e=>this.addSchemaValueCompletions(e,t,r,o))),Array.isArray(e.oneOf)&&e.oneOf.forEach((e=>this.addSchemaValueCompletions(e,t,r,o))))}addDefaultValueCompletions(e,t,r,o=0){let n=!1;if((0,objects_1.isDefined)(e.default)){let s=e.type,i=e.default;for(let e=o;e>0;e--)i=[i],s="array";r.add({kind:this.getSuggestionKind(s),label:this.getLabelForValue(i),insertText:this.getInsertTextForValue(i,t),insertTextFormat:jsonLanguageTypes_1.InsertTextFormat.Snippet,detail:localize("json.suggest.default","Default value")}),n=!0}Array.isArray(e.examples)&&e.examples.forEach((s=>{let i=e.type,a=s;for(let e=o;e>0;e--)a=[a],i="array";r.add({kind:this.getSuggestionKind(i),label:this.getLabelForValue(a),insertText:this.getInsertTextForValue(a,t),insertTextFormat:jsonLanguageTypes_1.InsertTextFormat.Snippet}),n=!0})),Array.isArray(e.defaultSnippets)&&e.defaultSnippets.forEach((s=>{let i,a,l=e.type,p=s.body,u=s.label;if((0,objects_1.isDefined)(p)){let r=e.type;for(let e=o;e>0;e--)p=[p],r="array";i=this.getInsertTextForSnippetValue(p,t),a=this.getFilterTextForSnippetValue(p),u=u||this.getLabelForSnippetValue(p)}else{if("string"!=typeof s.bodyText)return;{let e="",r="",n="";for(let t=o;t>0;t--)e=e+n+"[\n",r=r+"\n"+n+"]",n+="\t",l="array";i=e+n+s.bodyText.split("\n").join("\n"+n)+r+t,u=u||i,a=i.replace(/[\n]/g,"")}}r.add({kind:this.getSuggestionKind(l),label:u,documentation:this.fromMarkup(s.markdownDescription)||s.description,insertText:i,insertTextFormat:jsonLanguageTypes_1.InsertTextFormat.Snippet,filterText:a}),n=!0})),!n&&"object"==typeof e.items&&!Array.isArray(e.items)&&o<5&&this.addDefaultValueCompletions(e.items,t,r,o+1)}addEnumValueCompletions(e,t,r){if((0,objects_1.isDefined)(e.const)&&r.add({kind:this.getSuggestionKind(e.type),label:this.getLabelForValue(e.const),insertText:this.getInsertTextForValue(e.const,t),insertTextFormat:jsonLanguageTypes_1.InsertTextFormat.Snippet,documentation:this.fromMarkup(e.markdownDescription)||e.description,uniPlatform:e.uniPlatform,detail:(0,extTool_1.getDetailFromType)(this.getLabelForValue(e.const),e.type)}),Array.isArray(e.enum))for(let o=0,n=e.enum.length;o<n;o++){const n=e.enum[o];let s=this.fromMarkup(e.markdownDescription)||e.description;e.markdownEnumDescriptions&&o<e.markdownEnumDescriptions.length&&this.doesSupportMarkdown()?s=this.fromMarkup(e.markdownEnumDescriptions[o]):e.enumDescriptions&&o<e.enumDescriptions.length&&(s=e.enumDescriptions[o]),r.add({kind:this.getSuggestionKind(e.type),label:this.getLabelForValue(n),insertText:this.getInsertTextForValue(n,t),insertTextFormat:jsonLanguageTypes_1.InsertTextFormat.Snippet,documentation:s,uniPlatform:e.uniPlatform,detail:(0,extTool_1.getDetailFromType)(this.getLabelForValue(n),e.type)})}}collectTypes(e,t){if(Array.isArray(e.enum)||(0,objects_1.isDefined)(e.const))return;const r=e.type;Array.isArray(r)?r.forEach((e=>t[e]=!0)):r&&(t[r]=!0)}addFillerValueCompletions(e,t,r){e.object&&r.add({kind:this.getSuggestionKind("object"),label:"{}",insertText:this.getInsertTextForGuessedValue({},t),insertTextFormat:jsonLanguageTypes_1.InsertTextFormat.Snippet,detail:localize("defaults.object","New object"),documentation:""}),e.array&&r.add({kind:this.getSuggestionKind("array"),label:"[]",insertText:this.getInsertTextForGuessedValue([],t),insertTextFormat:jsonLanguageTypes_1.InsertTextFormat.Snippet,detail:localize("defaults.array","New array"),documentation:""})}addBooleanValueCompletion(e,t,r){r.add({kind:this.getSuggestionKind("boolean"),label:e?"true":"false",insertText:this.getInsertTextForValue(e,t),insertTextFormat:jsonLanguageTypes_1.InsertTextFormat.Snippet,documentation:""})}addNullValueCompletion(e,t){t.add({kind:this.getSuggestionKind("null"),label:"null",insertText:"null"+e,insertTextFormat:jsonLanguageTypes_1.InsertTextFormat.Snippet,documentation:""})}addDollarSchemaCompletions(e,t){this.schemaService.getRegisteredSchemaIds((e=>"http"===e||"https"===e)).forEach((r=>t.add({kind:jsonLanguageTypes_1.CompletionItemKind.Module,label:this.getLabelForValue(r),filterText:this.getFilterTextForValue(r),insertText:this.getInsertTextForValue(r,e),insertTextFormat:jsonLanguageTypes_1.InsertTextFormat.Snippet,documentation:""})))}getLabelForValue(e){return JSON.stringify(e)}getFilterTextForValue(e){return JSON.stringify(e)}getFilterTextForSnippetValue(e){return JSON.stringify(e).replace(/\$\{\d+:([^}]+)\}|\$\d+/g,"$1")}getLabelForSnippetValue(e){return JSON.stringify(e).replace(/\$\{\d+:([^}]+)\}|\$\d+/g,"$1")}getInsertTextForPlainText(e){return e.replace(/[\\\$\}]/g,"\\$&")}getInsertTextForValue(e,t){var r=JSON.stringify(e,null,"\t");return"{}"===r?"{$1}"+t:"[]"===r?"[$1]"+t:this.getInsertTextForPlainText(r+t)}getInsertTextForSnippetValue(e,t){return(0,json_1.stringifyObject)(e,"",(e=>"string"==typeof e&&"^"===e[0]?e.substr(1):JSON.stringify(e)))+t}getInsertTextForGuessedValue(e,t){switch(typeof e){case"object":return null===e?"${1:null}"+t:this.getInsertTextForValue(e,t);case"string":let r=JSON.stringify(e);return r=r.substr(1,r.length-2),r=this.getInsertTextForPlainText(r),'"${1:'+r+'}"'+t;case"number":case"boolean":return"${1:"+JSON.stringify(e)+"}"+t}return this.getInsertTextForValue(e,t)}getSuggestionKind(e){if(Array.isArray(e)){const t=e;e=t.length>0?t[0]:void 0}if(!e)return jsonLanguageTypes_1.CompletionItemKind.Value;switch(e){case"string":default:return jsonLanguageTypes_1.CompletionItemKind.Value;case"object":return jsonLanguageTypes_1.CompletionItemKind.Module;case"property":return jsonLanguageTypes_1.CompletionItemKind.Property}}getLabelTextForMatchingNode(e,t){switch(e.type){case"array":return"[]";case"object":return"{}";default:return t.getText().substr(e.offset,e.length)}}getInsertTextForMatchingNode(e,t,r){switch(e.type){case"array":return this.getInsertTextForValue([],r);case"object":return this.getInsertTextForValue({},r);default:const o=t.getText().substr(e.offset,e.length)+r;return this.getInsertTextForPlainText(o)}}getInsertTextForProperty(e,t,r,o){const n=this.getInsertTextForValue(e,"");if(!r)return n;const s=n+": ";let i,a=0;if(t){if(Array.isArray(t.defaultSnippets)){if(1===t.defaultSnippets.length){const e=t.defaultSnippets[0].body;(0,objects_1.isDefined)(e)&&(i=this.getInsertTextForSnippetValue(e,""))}a+=t.defaultSnippets.length}if(t.enum&&(i||1!==t.enum.length||(i=this.getInsertTextForGuessedValue(t.enum[0],"")),a+=t.enum.length),(0,objects_1.isDefined)(t.default)&&(i||(i=this.getInsertTextForGuessedValue(t.default,"")),a++),Array.isArray(t.examples)&&t.examples.length&&(i||(i=this.getInsertTextForGuessedValue(t.examples[0],"")),a+=t.examples.length),0===a){var l=Array.isArray(t.type)?t.type[0]:t.type;switch(l||(t.properties?l="object":t.items&&(l="array")),l){case"boolean":i="$1";break;case"string":i='"$1"';break;case"object":i="{$1}";break;case"array":i="[$1]";break;case"number":case"integer":i="${1:0}";break;case"null":i="${1:null}";break;default:return n}}}return(!i||a>1)&&(i="$1"),s+i+o}getCurrentWord(e,t){for(var r=t-1,o=e.getText();r>=0&&-1===' \t\n\r\v":{[,]}'.indexOf(o.charAt(r));)r--;return o.substring(r+1,t)}evaluateSeparatorAfter(e,t){const r=Json.createScanner(e.getText(),!0);r.setPosition(t);switch(r.scan()){case 5:case 2:case 4:case 17:return"";default:return","}}findItemAtOffset(e,t,r){const o=Json.createScanner(t.getText(),!0),n=e.items;for(let e=n.length-1;e>=0;e--){const t=n[e];if(r>t.offset+t.length){o.setPosition(t.offset+t.length);return 5===o.scan()&&r>=o.getTokenOffset()+o.getTokenLength()?e+1:e}if(r>=t.offset)return e}return 0}isInComment(e,t,r){const o=Json.createScanner(e.getText(),!1);o.setPosition(t);let n=o.scan();for(;17!==n&&o.getTokenOffset()+o.getTokenLength()<r;)n=o.scan();return(12===n||13===n)&&o.getTokenOffset()<=r}fromMarkup(e){if(e&&this.doesSupportMarkdown())return{kind:jsonLanguageTypes_1.MarkupKind.Markdown,value:e}}doesSupportMarkdown(){if(!(0,objects_1.isDefined)(this.supportsMarkdown)){const e=this.clientCapabilities.textDocument&&this.clientCapabilities.textDocument.completion;this.supportsMarkdown=e&&e.completionItem&&Array.isArray(e.completionItem.documentationFormat)&&-1!==e.completionItem.documentationFormat.indexOf(jsonLanguageTypes_1.MarkupKind.Markdown)}return this.supportsMarkdown}doesSupportsCommitCharacters(){if(!(0,objects_1.isDefined)(this.supportsCommitCharacters)){const e=this.clientCapabilities.textDocument&&this.clientCapabilities.textDocument.completion;this.supportsCommitCharacters=e&&e.completionItem&&!!e.completionItem.commitCharactersSupport}return this.supportsCommitCharacters}}exports.JSONCompletion=JSONCompletion;
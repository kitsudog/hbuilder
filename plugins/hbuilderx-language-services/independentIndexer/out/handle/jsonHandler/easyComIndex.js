"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o);var n=Object.getOwnPropertyDescriptor(t,o);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,r,n)}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.EasyComIndex=void 0;const fs=__importStar(require("fs")),path=__importStar(require("path")),core_1=require("../../../../core"),vscode_json_languageservice_1=require("../../../../packages/vscode-json-languageservice");function getFilePathFromFolderRecursively(e){if(!fs.existsSync(e))return;const t=[e],o=[];for(;t.length>0;){const e=t.pop();if(!e)continue;if(!fs.existsSync(e))continue;const r=fs.readdirSync(e,{withFileTypes:!0});for(const n of r){const r=path.join(e,n.name);if(!fs.existsSync(r))continue;const a=(0,core_1.noTsToNormalizedPath)(r);a&&(n.isDirectory()?t.push(a):n.isFile()&&o.push(a))}}return o}function replaceFromOffset(e,t,o,r){return e.substring(0,t)+r+e.substring(o)}class EasyComIndex{isSupport(e,t){const o=(0,core_1.noTsToNormalizedPath)(e);if(!o)return!1;const r=t.uri,n=(0,core_1.noTsToNormalizedPath)(r);if(!n)return!1;if(!fs.existsSync(o))return!1;if(!fs.existsSync(n))return!1;const a=path.resolve(o,"pages.json"),s=(0,core_1.noTsToNormalizedPath)(a);if(!s)return!1;if(s.toLowerCase()!==n.toLowerCase())return!1;const i=(0,core_1.detectProjectKind)(o);return i===core_1.HXProjectKind.UniApp||i===core_1.HXProjectKind.UniApp_Cli}setMap(e,t,o,r,n){const a=n.parent.parent,s=n.keyNode,i=(0,core_1.getRangeFromDocAndOffsetLength)(e,s.offset,s.length),c=core_1.targetUtils.indexGetTarget(e,i,t),u={isAutoScan:"autoscan"!==n.keyNode.value||n.valueNode.value,targets:c,autoScans:"autoscan"===n.keyNode.value?n.valueNode:void 0,custom:"custom"===n.keyNode.value?n.valueNode:void 0,parentNode:a};if(0===o.size)o.set(0,u);else{const e=o.get(r);e&&(e.parentNode===u.parentNode?(u.custom&&(e.custom=u.custom),u.autoScans&&(e.autoScans=u.autoScans,u.isAutoScan||(e.isAutoScan=!1)),o.set(r,e)):(r++,o.set(r,u)))}return r}getAstNodeData(e,t){const o=(0,vscode_json_languageservice_1.getLanguageService)({}).parseJSONDocument(e),r=new Map;let n=0;return o.visit((o=>{var a,s,i,c,u,l,d,h,p,f;return"property"===o.type&&"custom"===(null===(a=o.keyNode)||void 0===a?void 0:a.value)&&o.valueNode&&"object"===(null===(s=o.valueNode)||void 0===s?void 0:s.type)&&"easycom"===(null===(u=null===(c=null===(i=o.parent)||void 0===i?void 0:i.parent)||void 0===c?void 0:c.keyNode)||void 0===u?void 0:u.value)&&(n=this.setMap(e,t,r,n,o)),"property"===o.type&&"autoscan"===(null===(l=o.keyNode)||void 0===l?void 0:l.value)&&o.valueNode&&"boolean"===(null===(d=o.valueNode)||void 0===d?void 0:d.type)&&"easycom"===(null===(f=null===(p=null===(h=o.parent)||void 0===h?void 0:h.parent)||void 0===p?void 0:p.keyNode)||void 0===f?void 0:f.value)&&(n=this.setMap(e,t,r,n,o)),!0})),r}getAutoScanData(e,t,o){let r=getFilePathFromFolderRecursively(e);if(!r)return;const n=(0,core_1.noTsToNormalizedPath)(e);if(!n)return;r=r.filter((e=>{if(!(e.endsWith(".vue")||e.endsWith(".nvue")||e.endsWith(".uvue")))return!1;const o=path.basename(e),r=path.parse(e).name,a=new RegExp(`^${n}${t}/${r}/${o}$`,"g");let s;try{let t=e.match(a);t&&t.length>0&&(s=t[0])}catch(e){console.log("[RegExp] error:"+e)}return!!s&&e.toLowerCase()===s.toLowerCase()}));const a=[];return r.forEach((e=>{const t=path.parse(e).name;a.push({value:t,lineText:t,kind:core_1.IndexItemType.DEF,describe:"autoscan",easyComPath:e,platforms:o})})),a}getAutoScanDataFromType(e,t,o){if(0===o.length)return;let r="";"uni_modules"===t&&(r="/[^/]+/components");const n=[];return o.forEach((o=>{if(!o.isAutoScan)return;const a=(0,core_1.noTsToNormalizedPath)(e);if(!a)return;const s=path.resolve(a,t),i=(0,core_1.noTsToNormalizedPath)(s);if(!i)return;const c=this.getAutoScanData(i,r,o.targets);c&&n.push(...c)})),n}getNameRegexDataMap(e){const t=new Map;let o=0,r=-1;for(let n=0;n<e.length;n++){const a=e.charAt(n);"("==a?(o++,r=n):")"==a&&(-1!=r&&n>r&&t.set(o,{start:r,end:n+1,text:e.substring(r,n+1)}),r=-1)}return t}getPreTextData(e,t){const o=(0,core_1.uriToPath)(e);t.startsWith("@")&&(t=t.replace("@",o));let r=t;const n=t.lastIndexOf("/");let a=t.substring(0,n),s="\0";for(let e=0;e<t.length;e++){const o=t.charAt(e);if(o>="0"&&o<="9"&&"$"==s){r=t.substring(0,e-1);const o=r.lastIndexOf("/");return a=a.substring(0,o),{comPreText:r,comPreFolder:a}}s=o}return{comPreText:r,comPreFolder:a}}getRexPathMapData(e,t){let o=new Map;if(e.size>0){let r="\0",n=0;for(let a=0;a<t.length;a++){let s=t.charAt(a);if(s>="0"&&s<="9"&&"$"==r){let r=Number.parseInt(s);e.has(r)&&(n++,o.set(n,{index:r,start:a-1,end:a+1,text:t.substring(a-1,a+1)}))}r=s}}return o}getNamePreData(e,t,o){for(let r=e.size;r>0;r--){const n=e.get(r);n&&o.forEach(((e,o)=>{e.text===`$${r}`&&(t=replaceFromOffset(t,n.start,n.end,e.text))}))}let r=t;return t.startsWith("^")&&(r=r.substring(1)),t.endsWith("$")&&(r=r.substring(r.length-1)),r}getRexPathData(e,t,o,r){let n=o,a=[];r.forEach(((e,t)=>{a.push(e.start)}));for(let e=a.length;e>=0;e--){const o=a[e-1],s=n.substring(0,o),i=n.substring(o+2),c=r.get(e);if(!c)continue;const u=t.get(c.index);if(!u)continue;n=s+u.text+i}const s=(0,core_1.uriToPath)(e);return n.startsWith("@")&&(n=n.replace("@",s)),n}parseCustomData(e,t,o,r){const n=new Map;return r.forEach(((r,a)=>{const s=r.comText;if(!s)return;const i=r.keyNode,c=this.getNameRegexDataMap(a),u=s,{comPreText:l,comPreFolder:d}=this.getPreTextData(e,s),h=this.getRexPathMapData(c,s),p=this.getNamePreData(c,a,h),f=this.getRexPathData(e,c,s,h),g=(0,core_1.getRangeFromDocAndOffsetLength)(t,i.offset,i.length),m=core_1.targetUtils.indexGetTarget(t,g,o);n.set(a,{nameRegMap:c,namePreText:p,comText:u,comPreText:l,comPreFolder:d,comRexPath:f,comRexPathMap:h,targets:m})})),n}getName(e,t,o){if(null===e)return t;let r=o.namePreText;for(let t=1;t<e.length;t++){const n=o.comRexPathMap.get(t);if(!n)continue;const a=e[t];r=r.replace(new RegExp(`\\${n.text}`,"g"),a)}return r}getCustomData(e,t,o,r){const n=[];return r.forEach((r=>{const a=r.custom;if(!a)return;if(!a.valueNode)return;if("object"!==a.valueNode.type)return;const s=new Map;a.valueNode.properties.forEach((e=>{var t;const o=e.keyNode.value,r={keyNode:e.keyNode,comText:null===(t=e.valueNode)||void 0===t?void 0:t.value};s.set(o,r)}));const i=this.parseCustomData(e,t,o,s),c=[];i.forEach(((e,t)=>{c.push(e.comPreFolder)}));let u=(0,core_1.getRootPathRecursively)(c);""===u&&(u=(0,core_1.uriToPath)(e));const l=getFilePathFromFolderRecursively(u);l&&i.forEach(((e,t)=>{l.forEach((o=>{const r=new RegExp(e.comRexPath);let a=o.match(r);if(a&&a.length>0){const r=this.getName(a,t,e);n.push({value:r,lineText:e.comText,kind:core_1.IndexItemType.DEF,context:t,describe:"custom",easyComPath:o})}}))}))})),n}createEasyComData(e,t,o){const r=[];if(!this.isSupport(e,t))return r;const n=this.getAstNodeData(t,o);let a=Array.from(n.values());const s={isAutoScan:!0,targets:void 0};0===a.length&&(a=[s]);const i=this.getAutoScanDataFromType(e,"components",a),c=this.getAutoScanDataFromType(e,"uni_modules",a),u=this.getCustomData(e,t,o,a);return i&&r.push(...i),c&&r.push(...c),u&&r.push(...u),r}}exports.EasyComIndex=EasyComIndex;
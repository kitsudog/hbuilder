"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,n)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PagesPath=void 0;const fs=__importStar(require("fs")),path=__importStar(require("path")),core_1=require("../../../../core"),vscode_json_languageservice_1=require("../../../../packages/vscode-json-languageservice");class PagesPath{isSupport(e,t){const r=(0,core_1.noTsToNormalizedPath)(e);if(!r)return!1;const o=t.uri,n=(0,core_1.noTsToNormalizedPath)(o);if(!n)return!1;if(!fs.existsSync(r))return!1;if(!fs.existsSync(n))return!1;const a=path.resolve(r,"pages.json"),s=(0,core_1.noTsToNormalizedPath)(a);if(!s)return!1;if(s.toLowerCase()!==n.toLowerCase())return!1;const i=(0,core_1.detectProjectKind)(r);return i===core_1.HXProjectKind.UniApp||i===core_1.HXProjectKind.UniApp_Cli}getAstNodeData(e){const t=(0,vscode_json_languageservice_1.getLanguageService)({}).parseJSONDocument(e);let r;if(!t.root)return;return t.root.properties.forEach((e=>{var t,o;"property"===e.type&&"pages"===(null===(t=e.keyNode)||void 0===t?void 0:t.value)&&e.valueNode&&"array"===(null===(o=e.valueNode)||void 0===o?void 0:o.type)&&(r=e)})),r}getAbsolutePath(e,t){const r=(0,core_1.noTsToNormalizedPath)(e);if(!r)return;const o=path.resolve(r,t),n=[],a=["vue","nvue","uvue"];for(let e=0;e<a.length;e++){const t=`${o}.${a[e]}`;if(fs.existsSync(t)){const e=t.replace(/\\/g,"/");n.push(e)}}return n}getRange(e,t){const r=t.offset,o=r+t.length;return vscode_json_languageservice_1.Range.create(e.positionAt(r),e.positionAt(o))}getPagesData(e,t,r,o){if(!o)return;if(!o.valueNode)return;if("array"!==o.valueNode.type)return;const n=[];return o.valueNode.items.forEach((o=>{"object"===o.type&&o.properties.forEach((o=>{if(!o.keyNode)return;if("path"!==o.keyNode.value)return;if(!o.valueNode)return;if("string"!==o.valueNode.type)return;const a=o.valueNode.value;if(!a)return;const s=this.getAbsolutePath(e,a);if(!s||0===s.length)return;const i=o.keyNode,u=(0,core_1.getRangeFromDocAndOffsetLength)(t,i.offset,i.length),c=core_1.targetUtils.indexGetTarget(t,u,r),l=this.getRange(t,o.valueNode),f=(0,core_1.getLineTextFromOffset)(t,o.valueNode.offset);s.forEach((e=>{const t={value:e,lineText:f,kind:core_1.IndexItemType.REF,range:l,context:a,platforms:c};n.push(t)}))}))})),n}createPagesPathData(e,t,r){const o=[];if(!this.isSupport(e,t))return o;const n=this.getAstNodeData(t),a=this.getPagesData(e,t,r,n);return a&&o.push(...a),o}}exports.PagesPath=PagesPath;
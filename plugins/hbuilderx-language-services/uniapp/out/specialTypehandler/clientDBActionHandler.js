"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const fs=require("fs"),path=require("path"),vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),core_1=require("../../../core"),specialStringPlugin_1=require("../../../specialStringPlugin"),baseHandler_1=require("./baseHandler");function getUniModuleActionNames(e,t){let n=[],r=(0,specialStringPlugin_1.getUniModulesDir)(),i=path.join(e,r);if(fs.existsSync(i)&&fs.statSync(i).isDirectory()){let e=fs.readdirSync(i);for(let r of e){let e=path.join(i,r);if(fs.statSync(e).isDirectory())for(let r=0;r<specialStringPlugin_1.providers.length;++r){let r=path.join(e,"/uniCloud/cloudfunctions/uni-clientDB-actions");if(fs.existsSync(r)&&fs.statSync(r).isDirectory()){let e=fs.readdirSync(r);for(let i=0;i<e.length;++i){let l=path.basename(e[i],".js");if(l==t)return[path.join(r,e[i])];n.push(l)}}}}}return n}class ClientDBActionHandler extends baseHandler_1.UniBaseHandler{async doCompleteAsync(e,t,n,r,i){let l=[],o=new Set,a=n.project.fsPath;for(let e=0;e<specialStringPlugin_1.providers.length;++e){let t=path.join(a,(0,specialStringPlugin_1.getCloudActionRoot)(specialStringPlugin_1.providers[e]));fs.existsSync(t)&&fs.readdirSync(t).forEach((e=>{let t=e.substr(0,e.lastIndexOf("."));o.add(t)}))}return getUniModuleActionNames(a).forEach((e=>{o.add(e)})),o.forEach((e=>{l.push({label:e,kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,documentation:e})})),l}async doDefinitionAsync(e,t,n,r,i){let l=e.getText(n.range),o=n.project.fsPath;for(let e=0;e<specialStringPlugin_1.providers.length;++e){let t=path.join(o,(0,specialStringPlugin_1.getCloudActionRoot)(specialStringPlugin_1.providers[e]));if(!fs.existsSync(t))continue;let r=fs.readdirSync(t);for(let e=0;e<r.length;++e){if(path.basename(r[e],".js")==l)return[{targetUri:path.join(t,r[e]),targetRange:(0,core_1.getNullRange)(),targetSelectionRange:(0,core_1.getNullRange)(),originSelectionRange:n.range}]}}let a=getUniModuleActionNames(o,l);return 1===a.length?[{targetUri:a[0],targetRange:(0,core_1.getNullRange)(),targetSelectionRange:(0,core_1.getNullRange)(),originSelectionRange:n.range}]:[]}}exports.default=ClientDBActionHandler;
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const fs=require("fs"),path=require("path"),vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),core_1=require("../../../core"),specialStringPlugin_1=require("../../../specialStringPlugin"),baseHandler_1=require("./baseHandler");function uniModules(e){let t=[],n=path.join(e,(0,specialStringPlugin_1.getUniModulesDir)());return fs.existsSync(n)&&fs.statSync(n).isDirectory()&&fs.readdirSync(n).forEach((r=>{let i=path.join(n,r);if(fs.statSync(i).isDirectory())for(let n=0;n<specialStringPlugin_1.providers.length;++n){let i=path.join(e,(0,specialStringPlugin_1.getUniModuleDatabase)(r,specialStringPlugin_1.providers[n]));fs.existsSync(i)&&fs.statSync(i).isDirectory()&&t.push(i)}})),t}function getUniModuleSchema(e,t){let n=uniModules(t);for(let t of n)fs.readdirSync(t).forEach((n=>{let r=path.join(t,n);fs.statSync(r).isFile()&&n.endsWith(".schema.json")&&e.add(path.basename(r,".schema.json"))}))}function findUniModuleSchema(e,t){let n,r=uniModules(e);for(let e of r){let n=fs.readdirSync(e);for(let r of n){let n=path.join(e,r);if(fs.statSync(n).isFile()&&r.endsWith(".schema.json")){if(path.basename(r,".schema.json")==t)return n}}}return n}function getTargetText(e,t,n){let r=e.split(",");if(r.length>0){let e=t;for(let t=0;t<r.length;++t){let i=r[t],a=e+i.length;if(n>=e&&n<=a)return{text:i,range:{start:e,end:a}};e=a+1}}return{text:e,range:{start:t,end:t+e.length}}}class DBCollectionHandler extends baseHandler_1.UniBaseHandler{async doCompleteAsync(e,t,n,r,i){let a=[],s=e.getText(n.range),o=new Set;if(s.trim().length>0){s.split(",").forEach((e=>{o.add(e.trim())}))}let l=new Set;for(let e=0;e<specialStringPlugin_1.providers.length;++e){let t=specialStringPlugin_1.providers[e],r=path.join(n.project.fsPath,(0,specialStringPlugin_1.getCloudDatabaseRoot)(t));fs.existsSync(r)&&(fs.statSync(r).isDirectory()&&fs.readdirSync(r).forEach((e=>{let t=path.join(r,e);fs.statSync(t).isFile()&&e.endsWith(".schema.json")&&l.add(path.basename(t,".schema.json"))})))}return getUniModuleSchema(l,n.project.fsPath),l.forEach((e=>{e.length>0&&a.push({label:e,kind:vscode_languageserver_protocol_1.CompletionItemKind.Variable,documentation:e,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(n.range,e)})})),a}async doDefinitionAsync(e,t,n,r,i){let a=n.project.fsPath,s=getTargetText(e.getText(n.range),e.offsetAt(n.range.start),e.offsetAt(t));for(let t=0;t<specialStringPlugin_1.providers.length;++t){let n=specialStringPlugin_1.providers[t],r=path.join(a,(0,specialStringPlugin_1.getCloudDatabaseRoot)(n));if(fs.existsSync(r)&&fs.statSync(r).isDirectory()){let t=fs.readdirSync(r);for(let n=0;n<t.length;++n){if(path.basename(t[n],".schema.json")==s.text)return[{targetUri:path.join(r,t[n]),targetRange:(0,core_1.getNullRange)(),targetSelectionRange:(0,core_1.getNullRange)(),originSelectionRange:{start:e.positionAt(s.range.start),end:e.positionAt(s.range.end)}}]}}}let o=findUniModuleSchema(a,s.text);return o?[{targetUri:o,targetRange:(0,core_1.getNullRange)(),targetSelectionRange:(0,core_1.getNullRange)(),originSelectionRange:{start:e.positionAt(s.range.start),end:e.positionAt(s.range.end)}}]:[]}}exports.default=DBCollectionHandler;
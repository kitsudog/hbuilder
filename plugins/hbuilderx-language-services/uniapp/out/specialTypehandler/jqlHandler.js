"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),specialStringPlugin_1=require("../../../specialStringPlugin"),baseHandler_1=require("./baseHandler");function cleanText(e){if(!e)return;let n=e;return(e.startsWith('"')||e.startsWith("'"))&&(n=n.slice(1)),(e.endsWith('"')||e.endsWith("'"))&&(n=n.slice(0,n.length-1)),n}function calcFieldProposals(e,n){let t=[];return e.split(",").forEach((e=>{let i=(0,specialStringPlugin_1.parseSchema)(e.trim(),n);if(i)for(const[e,n]of i.getProperties().entries())t.push({kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,label:e,detail:n.desc})})),t}function doDBComponentComplete(e,n,t,i){let l=i.get(specialStringPlugin_1.LanguageServiceType.HTML_LANGUAGE_SERVICE),r=t.ast,s=r.findNodeAt(e.offsetAt(n)).attributes,o=l.getLocationInfoAtPosition(e,n,r);if(s&&o){let e=cleanText(s.collection);if("where"==(null==o?void 0:o.activeAttribute)&&e)return calcFieldProposals(e,t.project.fsPath)}return[]}class JQLHandler extends baseHandler_1.UniBaseHandler{async doCompleteAsync(e,n,t,i){var l;if(t.kind===specialStringPlugin_1.StringLocationInfoKind.IN_HTML_LIKE)return doDBComponentComplete(e,n,t,i);let r=[],s=i.get(specialStringPlugin_1.LanguageServiceType.TS),o=t.ast,a=(0,specialStringPlugin_1.findNodePathByOffset)(o,e.offsetAt(n)),d=a.length-1,c=a[d]||null;if(c&&(d-=1,c=a[d]||null,c))if((null==c?void 0:c.kind)===s.SyntaxKind.PropertyAssignment||(null==c?void 0:c.kind)===s.SyntaxKind.ShorthandPropertyAssignment)d-=1,c=a[d],c&&(null==c||c.kind,s.SyntaxKind.ObjectLiteralExpression);else{let e=null;if(c.kind==s.SyntaxKind.CallExpression)e=c;else{for(;c&&(null==c?void 0:c.kind)!==s.SyntaxKind.ExpressionStatement;)d-=1,c=a[d];if(c&&(null==c?void 0:c.kind)===s.SyntaxKind.ExpressionStatement){let n=c.expression;n.kind===s.SyntaxKind.CallExpression&&(e=n)}}for(;(null==e?void 0:e.kind)===s.SyntaxKind.CallExpression;){let n=e.expression;if(n.kind===s.SyntaxKind.PropertyAccessExpression){if("collection"===n.name.getText()){let n=e.arguments;if((null==n?void 0:n.length)>0&&(null===(l=n[0])||void 0===l?void 0:l.kind)===s.SyntaxKind.StringLiteral){let e=n[0].text;r.push(...calcFieldProposals(e,t.project.fsPath))}break}e=n.expression}}}return r}}exports.default=JQLHandler;
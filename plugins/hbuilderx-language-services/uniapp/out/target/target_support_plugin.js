"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.targetSupportPlugin=void 0;const hx=require("../../../core"),core_1=require("../../../core"),path=require("path"),fs=require("fs"),target_support_sourcemap_cache_1=require("./target_support_sourcemap_cache"),target_support_language_service_dispatcher_1=require("./target_support_language_service_dispatcher"),target_support_language_service_result_transformer_1=require("./target_support_language_service_result_transformer"),utils_1=require("./utils"),tsUtils_1=require("../utils/tsUtils"),utsLanguageServiceInterface_1=require("../uts/utsLanguageServiceInterface");class DefaultLanguageServicePolicy{constructor(e){this._ls=e}get kind(){return"DefaultLanguageServicePolicy"}getLanguageServiceContextIfHasPolicy(e,t){if(this.captureFile(e))return[{fileName:e,languageService:this._ls,target:void 0,position:t}]}captureFile(e){return hx.fileEndsWith(e,[".js"])}}class TargetSupportDispatchPolicy{constructor(e,t,i){this._info=e,this._sourceMapCache=t,this._originalHost=i,this._languageServices=new Map,this._languageServiceHosts=new Map,this._targets=[],hx.isUniAppXProject(this._info.project)&&(this.initTarget(),this.listenFileRemoved())}get kind(){return"target_support"}getLanguageServiceContextIfHasPolicy(e,t){if(!hx.isUniAppXProject(this._info.project))return;let i=this._sourceMapCache.isTargetBindingFile(e);if(i){const r=this._languageServices.get(i);return r?[{target:i,languageService:r,fileName:e,position:t}]:[]}if(t){let i=this.getTargetContext(e,t);if(i&&i.length){let e=[];for(let t of i){const[i,r]=t;if(i.kind!==hx.TargetKind.UNKNOWN){const t=this._languageServices.get(i.kind);t&&e.push({target:i.kind,languageService:t,fileName:i.targetFile,position:r})}}return e}}let r=[];for(const[i,n]of this._languageServices)if(i!==hx.TargetKind.UNKNOWN&&n){const o={target:i,languageService:n,fileName:e,position:t},a=this._sourceMapCache.generateTargetFileName(e,i),s=this._sourceMapCache.getTargetFileInfo(a);if(s&&(o.fileName=s.targetFile,t)){const i=this._info.tsinfo.project.projectService.getScriptInfoForNormalizedPath(hx.ts.server.toNormalizedPath(a)),r=this._info.tsinfo.project.projectService.getScriptInfoForNormalizedPath(hx.ts.server.toNormalizedPath(e));if(i&&r){const e=r.positionToLineOffset(t),n=s.getTargetPosition({line:e.line,char:e.offset}),a=i.lineOffsetToPosition(n.line,n.char);o.position=a}}r.push(o)}return r=r.sort(((e,t)=>this.getSerialNumber(e.target)-this.getSerialNumber(t.target))),r}initTarget(){let e=[];const t=hx.getAppDataPath(this._info.ts);if(t){const i=path.join(t,"extensions","hbuilderx-language-services","setting.json");if(fs.existsSync(i))try{const t=hx.readFileToString(i);if(t){const i=JSON.parse(t);if(i&&i.targets)for(const t in i.targets)hx.pathIsPath(this._info.project.fsPath,t)&&(e=i.targets[t])}}catch(e){}}this.updateTarget(this._info.project.fsPath,e),TargetSupportPlugin.registerTargetChangedCallback(this.updateTarget.bind(this))}updateTarget(e,t){if(!hx.pathIsPath(this._info.project.fsPath,e)||!fs.existsSync(e))return;e=hx.toNormalizedPath(e,core_1.ts);const i=new Set(Object.values(hx.TargetKind));let r=t.filter((e=>i.has(e)&&e!==hx.TargetKind.UNKNOWN));r.length?r.push(hx.TargetKind.UNKNOWN):r=[...i],this._targets=r;const n=new Map,o=new Map;for(const e of this._targets)if(this._languageServices.has(e)&&this._languageServiceHosts.has(e))n.set(e,this._languageServices.get(e)),o.set(e,this._languageServiceHosts.get(e));else{const t=this.createTargetLanguageService(e);n.set(e,t[0]),o.set(e,t[1])}this._languageServices.clear(),this._languageServices=n,this._languageServiceHosts.clear(),this._languageServiceHosts=o}getTargetContext(e,t){const i=this._info.tsinfo.project.projectService.getScriptInfoForNormalizedPath(this._info.ts.server.toNormalizedPath(e));if(i){const r=i.positionToLineOffset(t),n=this._sourceMapCache.getTargetFromFileName(e,{line:r.line-1,char:r.offset-1}),o=[];for(let t of n){const i=this._sourceMapCache.generateTargetFileName(e,t),n=this._sourceMapCache.getTargetFileInfo(i);if(n){const e=n.getTargetPosition({line:r.line,char:r.offset}),t=this._info.tsinfo.project.projectService.getOrCreateScriptInfoForNormalizedPath(this._info.ts.server.toNormalizedPath(i),!0);t&&o.push([n,t.lineOffsetToPosition(e.line,e.char)])}}return o}}createTargetLanguageService(e){let t=new TargetSupportLanguageServiceHost(this._info,this._originalHost,e,this._sourceMapCache),i=this._info.ts.createLanguageService2(this._info,t,this._info.project.documentRegistry);const r=i.getFileReferences.bind(i);i.getFileReferencesAsync=async e=>r(e);const n=i.findReferences.bind(i);i.findReferencesAsync=async(e,t)=>n(e,t),i.__depHost=t;const o={...this._info,languageService:i,languageServiceHost:t},[a,s]=hx.createRouterLanguageService(o,e,{getOriginalFileName:e=>{var t;if(this._sourceMapCache.hasTargetFileName(e))return null===(t=this._sourceMapCache.getTargetFileInfo(e))||void 0===t?void 0:t.noTransformSourceFile},getOriginalScriptSnapshot:e=>this._info.languageServiceHost.getScriptSnapshot(e),getOriginalScriptVersion:e=>this._info.languageServiceHost.getScriptVersion(e)}),c=t.getCompilationSettings.bind(t),l=t.resolveModuleNameLiterals.bind(t);return t.getCompilationSettings=()=>{let e=c();return e.checkExpressionOverride=(t,i,r,n)=>{for(let o=0;o<s.length;o++){let a=s[o];try{if(!a||!a.checkExpression)continue;let o=a.checkExpression(this._info.project,e,t,i,r,n);if(o)return o}catch(e){console.error(e)}}},e.getContextualTypeOverride=(t,i,r)=>{for(let n=0;n<s.length;n++){let o=s[n];try{if(!o||!o.getContextualType)continue;let n=o.getContextualType(this._info.project,e,t,i,r);if(n)return n}catch(e){console.error(e)}}},e.collectCustomModuleReferences=t=>{let i=[];for(let r=0;r<s.length;r++){let n=s[r];try{if(!n||!n.collectCustomModuleReferences)continue;let r=n.collectCustomModuleReferences(this._info.project,e,t);r&&i.push(...r)}catch(e){console.error(e)}}return i},e},t.resolveModuleNameLiterals=(t,i,r,n,o,a)=>{const s=l(t,i,r,n,o,a);return s.forEach((t=>{if(t.resolvedModule){this._sourceMapCache.upToDate(t.resolvedModule.resolvedFileName);const i=t.resolvedModule;if(this._sourceMapCache.hasOriginFileName(i.resolvedFileName)){const t=this._sourceMapCache.getOriginFileInfo(i.resolvedFileName).targetFileInfos.get(e);t&&(i.resolvedFileName=t.targetFile)}}})),s},[a,t]}listenFileRemoved(){const e=this._info.tsinfo.project.removeFile.bind(this._info.tsinfo.project),t=this._info.tsinfo.project.isRoot.bind(this._info.tsinfo.project);this._info.tsinfo.project.isRoot=e=>{if(this._sourceMapCache.hasTargetFileName(e.fileName)){const i=this._sourceMapCache.getTargetFileInfo(e.fileName),r=this._info.tsinfo.project.getScriptInfo(i.noTransformSourceFile);if(r)return t(r)}return t(e)},this._info.tsinfo.project.removeFile=(t,i,r)=>{if(this._info.tsinfo.project.isRoot(t)){const e=this._languageServiceHosts;if(this._sourceMapCache.hasOriginFileName(t.fileName)){const n=this._sourceMapCache.getOriginFileInfo(t.fileName);null==n||n.targetFileInfos.forEach(((t,n)=>{if(t){const o=e.get(n),a=this._info.tsinfo.project.projectService.getScriptInfo(t.targetFile);o&&a&&o.removeFile(a,i,r)}})),this._sourceMapCache.removeOrginFile(t.fileName)}else for(let[n,o]of e)o.removeFile(t,i,r)}e(t,i,r)}}getSerialNumber(e){switch(e){case hx.TargetKind.UNKNOWN:return 0;case hx.TargetKind["APP-ANDROID"]:return 1;case hx.TargetKind["APP-IOS"]:return 2;case hx.TargetKind.WEB:return 3}}}class TargetSupportLanguageServiceHost{constructor(e,t,i,r){this._info=e,this._originalHost=t,this._target=i,this._sourceMapCache=r}get target(){return this._target}log(e){this._info.tsinfo.project.log(e)}getProjectVersion(){return this._info.tsinfo.project.getProjectVersion()}getCompilationSettings(){return{...utsLanguageServiceInterface_1.UtsPluginLanguageService.DefaultUniappXCompilerOptions,maxNodeModuleJsDepth:this.target===hx.TargetKind["APP-ANDROID"]?2:0}}getScriptFileNames(){let e=this._info.tsinfo.languageServiceHost.getScriptFileNames();const t=new Set;return e.forEach((e=>{this._sourceMapCache.upToDate(e)&&t.add(e)})),e=e.filter((e=>!t.has(e))),e.push(...this._sourceMapCache.getTargetFiles(this._target)),e.push(...utils_1.TARGET.getTargetBaseLibs(this._target)),e}getScriptVersion(e){return this._sourceMapCache.upToDate(e),this._originalHost.getScriptVersion(e)}getScriptKind(e){return this._sourceMapCache.upToDate(e),this._originalHost.getScriptKind?this._originalHost.getScriptKind(e):core_1.ts.ScriptKind.Deferred}getScriptSnapshot(e){var t;return this._sourceMapCache.upToDate(e),this._sourceMapCache.hasOriginFileName(e)?null===(t=this._info.tsinfo.project.projectService.getScriptInfo(e))||void 0===t?void 0:t.getSnapshot():this._originalHost.getScriptSnapshot(e)}getCurrentDirectory(){return this._info.tsinfo.languageServiceHost.getCurrentDirectory()}getDefaultLibFileName(e){return this._info.tsinfo.languageServiceHost.getDefaultLibFileName(e)}readFile(e,t){if(this._sourceMapCache.hasTargetFileName(e)){return this._sourceMapCache.getTargetFileInfo(e).text}return this._info.tsinfo.languageServiceHost.readFile(e,t)}fileExists(e){var t,i;const r=null===(t=this._info.tsinfo.languageServiceHost.fileExists)||void 0===t?void 0:t.bind(this._info.tsinfo.languageServiceHost);return null!==(i=(null!=r?r:fs.existsSync)(e))&&void 0!==i?i:this._sourceMapCache.hasTargetFileName(e)}useCaseSensitiveFileNames(){return!1}resolveModuleNameLiterals(e,t,i,r,n,o){let a=hx.emptyResolvedModules(e);const s=this._info.project;for(let o=0;o<e.length;++o){const c=e[o],l=(0,tsUtils_1.fixTsNodeText)(c.getText(n));let g=hx.resolveModuleName(this._info.ts,s,l,t,r,{fileExists:this.fileExists.bind(this),readFile:this.readFile.bind(this)},void 0,i);if(g&&(a[o]={resolvedModule:{...g,extension:core_1.ts.extensionFromPath(g.resolvedFileName)}}),a[o].resolvedModule){this._sourceMapCache.upToDate(a[o].resolvedModule.resolvedFileName);const e=a[o].resolvedModule;if(this._sourceMapCache.hasOriginFileName(e.resolvedFileName)){const t=this._sourceMapCache.getOriginFileInfo(e.resolvedFileName).targetFileInfos.get(this.target);t&&(e.resolvedFileName=t.targetFile)}}}return a}removeFile(e,t,i){}}class TargetSupportPlugin{constructor(){}create(e){const t=e.ts.timestamp();if(u("target plugin create call..."),!hx.isUniAppXProject(e.project))return u("not unix project","proxy vertical ls for call horizontal ls"),hx.createRouterLanguageService(e,void 0)[0];!function(){let t=e.tsinfo.session.handlers;t&&!t.has("onTargetChanged")&&e.tsinfo.session.addProtocolHandler("onTargetChanged",(t=>{const{projectPath:i,targets:r}=t.arguments;e.tsinfo.project.log(`[target] on target chaned,targets: ${r.toString()}`),TargetSupportPlugin.onTargetChanged(i,r);return{response:{success:!0},responseRequired:!1}}))}();const i=function(){var t,i;const r=e.languageServiceHost,n=e.tsinfo.project,o=r.getScriptFileNames.bind(r),a=r.getScriptVersion.bind(r),s=null!==(i=null===(t=r.getScriptKind)||void 0===t?void 0:t.bind(r))&&void 0!==i?i:n.getScriptKind.bind(n),c=r.getScriptSnapshot.bind(r),l=r.resolveModuleNameLiterals?r.resolveModuleNameLiterals.bind(r):(e,t,i,r,n,o)=>e.map((e=>({resolvedModule:void 0})));return{...r,getScriptFileNames:()=>o(),getScriptVersion:e=>a(e),getScriptKind:e=>s(e),getScriptSnapshot:e=>c(e),resolveModuleNameLiterals:(e,t,i,r,n,o)=>l(e,t,i,r,n,o)}}(),r=new target_support_sourcemap_cache_1.TargetSupportSourceMapCache(e,i),n=new target_support_language_service_dispatcher_1.TargetSupportDispatcher(u),o=new target_support_language_service_result_transformer_1.TargetSupportResultTransformer(e,r);u("override original host api for update source map cache");const a=e.languageServiceHost;a.getCompilationSettings=function(){return{...utsLanguageServiceInterface_1.UtsPluginLanguageService.DefaultUniappXCompilerOptions,noCustomResolve:!0,noResolve:!0}},a.getScriptFileNames=()=>{const e=i.getScriptFileNames();return e.forEach((e=>{r.upToDate(e)})),e},a.resolveModuleNameLiterals=(e,t,n,o,s,c)=>{if(a.getCompilationSettings().noCustomResolve)return hx.emptyResolvedModules(e);const l=i.resolveModuleNameLiterals(e,t,n,o,s,c);return l.forEach((e=>{e.resolvedModule&&r.upToDate(e.resolvedModule.resolvedFileName)})),l};const[s]=hx.createRouterLanguageService(e,void 0),c=new DefaultLanguageServicePolicy(s);!function(){const t=[],o=hx.getRegisteredPlugins();for(let i=0;i<o.length;++i)o[i].createPolicies&&t.push(...o[i].createPolicies(e));t.forEach((e=>{n.registerPolicy(e)})),n.registerPolicy(c),n.registerPolicy(new TargetSupportDispatchPolicy(e,r,i))}(),u("proxy vertical ls from call target ls");const l=e.languageService,g=Object.create(null);for(let e of Object.keys(l)){const t=l[e];g[e]=(...e)=>t.apply(l,e)}return g.getCompletionsAtPositionAsync=async function(e,t,i){return u("call getcompletions api,first get target context"),f(e,t,{cb:async({languageService:e,fileName:t,position:r,target:n})=>{let a=await e.getCompletionsAtPositionAsync(t,r,i);return a&&n&&(a=o.transformCompletion(n,a,t)),a},merge:e=>{const t=utils_1.TARGET.createEmptyCompletionInfo(),i=[],r=new Set;return e.forEach((e=>{e&&(e.isGlobalCompletion||(t.isGlobalCompletion=e.isGlobalCompletion),e.isMemberCompletion||(t.isMemberCompletion=e.isMemberCompletion),e.isNewIdentifierLocation||(t.isNewIdentifierLocation=e.isNewIdentifierLocation),e.isIncomplete&&(t.isIncomplete=!0),e.entries.forEach((e=>{r.has(e.name)||(i.push(e),r.add(e.name))})))})),t.entries=i,t}})},g.findReferencesAsync=async function(e,t){return f(e,t,{cb:async({languageService:e,fileName:t,position:i,target:r})=>{let n=await e.findReferencesAsync(t,i);return n&&r&&(n=o.transformReference(r,n)),n},merge:e=>{const t=[];return e.forEach((e=>{e&&t.push(...e)})),t}})},g.getDefinitionAndBoundSpanAsync=async function(e,t){return f(e,t,{cb:async({languageService:e,fileName:t,position:i,target:r})=>{let n=await e.getDefinitionAndBoundSpanAsync(t,i);return n&&r&&(n=o.transformDefinition(r,n,t)),n}})},g.getFileReferencesAsync=async function(t){var i;return null!==(i=await f(t,void 0,{cb:async({languageService:e,fileName:t,target:i})=>{let r=await e.getFileReferencesAsync(t);return r&&i&&(r=o.transformFileReference(i,r)),r},merge:t=>{const i=[],r=new Set;return t.forEach((t=>{null==t||t.forEach((t=>{const n=function(t){return`${hx.toNormalizedPath(t.fileName,e.ts)}-${t.textSpan.start}-${t.textSpan.length}-${t.contextSpan?t.contextSpan.start:" "}-${t.contextSpan?t.contextSpan.length:" "}`}(t);r.has(n)||(i.push(t),r.add(n))}))})),i}}))&&void 0!==i?i:[]},g.getQuickInfoAtPositionAsync=async function(e,t){return f(e,t,{cb:async({languageService:e,fileName:t,position:i,target:r})=>{let n=await e.getQuickInfoAtPositionAsync(t,i);return n&&r&&(n=o.transformQuickInfo(r,n,t)),n}})},g.getSyntacticDiagnosticsAsync=async function(e){return await f(e,void 0,{cb:async({languageService:e,fileName:t,target:i})=>{let r=await e.getSyntacticDiagnosticsAsync(t);return r&&i&&(r=o.transformDiagnostic(i,r,t,e)),r},merge:e=>{let t=[];return e.forEach((e=>{e&&t.push(...e)})),t}})||[]},g.getSemanticDiagnosticsAsync=async function(e){return await f(e,void 0,{cb:async({languageService:e,fileName:t,target:i})=>{let r=await e.getSemanticDiagnosticsAsync(t);return r&&i&&(r=o.transformDiagnostic(i,r,t,e)),r},merge:e=>{let t=[];return e.forEach((e=>{e&&t.push(...e)})),t}})||[]},g.getSuggestionDiagnosticsAsync=async function(e){return await f(e,void 0,{cb:async({languageService:e,fileName:t,target:i})=>{let r=await e.getSuggestionDiagnosticsAsync(t);return r&&i&&(r=o.transformDiagnostic(i,r,t,e)),r},merge:e=>{let t=[];return e.forEach((e=>{e&&t.push(...e)})),t}})||[]},g.getCompletionEntryDetails=function(e,t,i,r,n,o,a){return h(e,t,{cb:({languageService:e,fileName:t,position:s})=>e.getCompletionEntryDetails(t,s,i,r,n,o,a)})},g.getSignatureHelpItems=function(e,t,i){return h(e,t,{cb:({languageService:e,fileName:t,position:r,target:n})=>{let a=e.getSignatureHelpItems(t,r,i);return a&&n&&(a=o.transformSignature(n,a,t)),a}})},g.getNavigationTree=function(e){return s.getNavigationTree(e)},g.getCodeFixesAtPosition=function(t,i,r,n,a,s){var l;return null!==(l=h(t,i,{cb:({languageService:e,fileName:t,position:c,target:l})=>{let g=e.getCodeFixesAtPosition(t,c,c+(r-i),n,a,s);return g&&l&&(g=o.transformCodeFix(l,[...g])),g},merge:i=>{const r=[];if(!c.captureFile(t)){const t=utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.UTS_DIANOSTICS_I18N.target_auto_fix_text;r.push({fixName:t.message,changes:[],description:t.message,commands:[{command:"select.target",arguments:{fsPath:e.project.fsPath}}]})}return i.forEach((e=>{e&&r.push(...e)})),r}}))&&void 0!==l?l:[]},g.toLineColumnOffset=function(e,t){let i=h(e,t,{cb:({languageService:e,fileName:t,position:i,target:r})=>{let n=e.toLineColumnOffset?e.toLineColumnOffset(t,i):void 0;return n&&r&&(n=o.transformLineAndCharacter(r,n,t)),n}});if(!i)throw new Error("[target] got invalied to line colume offser");return i},u("target plugin create call end...","speed: "+(e.ts.timestamp()-t)),g;function u(...t){e.tsinfo.project.log("[target] "+t.join(" "))}async function f(e,t,i){const{cb:r,merge:o}=i,a=n.getLanguageServiceContexts(e,t);let s=[];for(const e of a)try{let t=await r(e);t&&s.push(t)}catch(t){u("[error] context async callback call failed,context target: ",`${e.target}`,"filename",e.fileName,`${t}`)}if(o)try{return o(s)}catch(e){u("[error] merge context async result failed..., just throw one result")}return s.find((e=>!!e))}function h(e,t,i){const{cb:r,merge:o}=i,a=n.getLanguageServiceContexts(e,t);let s=[];for(const e of a)try{let t=r(e);t&&s.push(t)}catch(t){u("[error] context sync callback call failed,context target: ",`${e.target}`,"filename",e.fileName,`${t}`)}if(o)try{return o(s)}catch(e){u("[error] merge context sync result failed..., just throw one result")}return s.find((e=>!!e))}}static registerTargetChangedCallback(e){this._onTargetChangedCallback.push(e)}static onTargetChanged(e,t){this._onTargetChangedCallback.forEach((i=>i(e,t)))}}TargetSupportPlugin._onTargetChangedCallback=[];const plugin=new TargetSupportPlugin,create=plugin.create.bind(plugin);exports.targetSupportPlugin={create:create,__isTargetPlugin:!0};
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getDbSchemaFields=void 0;const fs=require("fs"),path=require("path"),out_1=require("../../../core/out");function readDbSchemaFields(e){let s=[];try{const i=(0,out_1.readFileToString)(e),a=JSON.parse(i).properties;function t(e){let s=[];return Object.keys(e).forEach((i=>{var a;if("_id"===i)return;let n,c="any";e[i].bsonType&&(c="object"===e[i].bsonType?t(null!==(a=e[i].properties)&&void 0!==a?a:{}):e[i].bsonType),"array"===c&&(n=e[i].arrayType),s.push({name:i,type:c,arrayType:n,description:e[i].description?e[i].description:""})})),s}s.push(...t(a))}catch(n){}return s}function readSpecifyDbSchemaFields(e,s){return readDbSchemaFields(e).filter((e=>s.has(e.name)))}function getDbSchemaFields(e,s,i){let a=[];if(e.kind!=out_1.HXProjectKind.UniApp&&e.kind!=out_1.HXProjectKind.UniApp_Cli)return a;const t=path.join(e.fsPath,"uniCloud-alipay/database");fs.existsSync(t)&&s.forEach((e=>{const s=path.join(t,e+".schema.json");fs.existsSync(s)&&a.push({name:e,fields:i?readSpecifyDbSchemaFields(s,i):readDbSchemaFields(s)})}));const n=path.join(e.fsPath,"uniCloud-aliyun/database");fs.existsSync(n)&&s.forEach((e=>{const s=path.join(n,e+".schema.json");fs.existsSync(s)&&a.push({name:e,fields:i?readSpecifyDbSchemaFields(s,i):readDbSchemaFields(s)})}));const c=path.join(e.fsPath,"uniCloud-tcb/database");fs.existsSync(c)&&s.forEach((e=>{const s=path.join(c,e+".schema.json");fs.existsSync(s)&&a.push({name:e,fields:i?readSpecifyDbSchemaFields(s,i):readDbSchemaFields(s)})}));let o=e.kind===out_1.HXProjectKind.UniApp_Cli?path.join(e.fsPath,"uni_modules"):path.join(e.fsPath,"src/uni_modules");if(fs.existsSync(o)){fs.readdirSync(o).forEach((e=>{const t=path.join(o,e,"uniCloud/database");fs.existsSync(t)&&s.forEach((e=>{const s=path.join(t,e+".schema.json");fs.existsSync(s)&&a.push({name:e,fields:i?readSpecifyDbSchemaFields(s,i):readDbSchemaFields(s)})}))}))}return a}exports.getDbSchemaFields=getDbSchemaFields;
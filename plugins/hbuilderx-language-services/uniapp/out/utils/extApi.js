"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ExtApi=void 0;const fs=require("fs"),path=require("path"),hx=require("../../../core");class ExtApi{constructor(t){this._info=t,this._exportFiles=new Set,this._version=0,this.extApis={},this.scanExtApi()}getExportFiles(){return this._exportFiles}hasExtApi(t){return!!this.extApis[t]}scanExtApi(){const t=path.join(this._info.project.sourceRoot,"uni_modules"),e=this,i=t=>{e._info.tsinfo.project.log(t)};let s=[];function o(){if(fs.existsSync(t)){let i=fs.readdirSync(t);e._exportFiles.clear(),s.forEach((t=>t.close())),s=[];for(const o of i){const i=path.join(t,o,"package.json");fs.existsSync(i)&&(r(i),s.push(e._info.ts.sys.watchFile(i,(()=>r(i)))))}}}function r(t){fs.existsSync(t)?hx.getFileProperty(t,"ext api",((s,o)=>{var r,n;try{const o=path.join(path.dirname(t),"utssdk"),p=hx.toNormalizedPath(path.join(o,"interface.uts"),e._info.ts);if(e._exportFiles.delete(p),e._version++,!fs.existsSync(p))return void i("[WAR] [ext api] entry file not exsits...");const a=hx.readFileToString(s);if(!a)return;const c=JSON.parse(a),x=null===(r=null==c?void 0:c.uni_modules["uni-ext-api"])||void 0===r?void 0:r.uni;if(x){if("string"==typeof x)e.extApis[x]=x;else if("object"==typeof x)if(x instanceof Array)for(const t of x)"string"==typeof x&&(e.extApis[t]=t);else for(const t in x){const i=x[t];e.extApis[t]="string"==typeof i?i:null!==(n=i.name)&&void 0!==n?n:t}e._exportFiles.has(p)||e._exportFiles.add(p)}}catch(t){i("[ERR] [ext api] parse ext api error...")}})):i("[WAR] [ext api] packageJson not exists: "+t)}o(),this._info.ts.sys.watchDirectory(t,(()=>o()),!0)}}exports.ExtApi=ExtApi;
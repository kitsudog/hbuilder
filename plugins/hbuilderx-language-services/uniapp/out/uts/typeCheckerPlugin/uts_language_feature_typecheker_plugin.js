"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.UtsLanguageFeatureTypeCheckerPlugin=void 0;const hx=require("../../../../core"),tsUtils_1=require("../../utils/tsUtils"),types_1=require("../types"),utsLanguageServiceInterface_1=require("../utsLanguageServiceInterface");class UtsLanguageFeatureTypeCheckerPlugin{constructor(e,t=e.languageService){this._info=e,this._realLs=t}checkExpression(e,t,s,i,n,a){var r,g,o,l,c,u;const f=this;if(hx.isUniAppXProject(e)&&this._info.ts.isObjectLiteralExpression(i)){const e=s.defaultCheckExpression(i,n,a),t=i.getSourceFile();if(hx.fileEndsWith(t.fileName,[".js"]))return e;if(p(i,this._info.ts)||function(e,t){if(utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.checkNodeLinkIs(e,[hx.ts.isPropertyAssignment,hx.ts.isObjectLiteralExpression,hx.ts.isCallExpression]))return p(e.parent.parent,t);return!1}(i,this._info.ts))return e;if(i.parent&&this._info.ts.isVariableDeclaration(i.parent)){const t=i.parent;if(t.type){if(this._info.ts.isTypeReferenceNode(t.type)){let n=t.type;if(new RegExp(`${utsLanguageServiceInterface_1.UtsPluginLanguageService.Constants.UTSJSONObject}`).exec((0,tsUtils_1.fixTsNodeText)(n.typeName.getText())))return null!==(r=S(i,s,e))&&void 0!==r?r:e}return e}}else if(i.parent&&this._info.ts.isAsExpression(i.parent)){const t=i.parent.type.getText().trim();return new RegExp(`${utsLanguageServiceInterface_1.UtsPluginLanguageService.Constants.UTSJSONObject}`).exec(t)&&(null!==(g=S(i,s,e))&&void 0!==g)?g:e}const u=s.getContextualType(i);return u?s.typeToString(u)===utsLanguageServiceInterface_1.UtsPluginLanguageService.Constants.UTSJSONObject&&hx.pathIsPath(utsLanguageServiceInterface_1.UtsPluginLanguageService.Constants.UTS_JSON_OBJECT_TYPE_FILE_PATH,null!==(l=null===(o=utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.getDeclarationNodeFromSymbol(u.symbol))||void 0===o?void 0:o.getSourceFile().fileName)&&void 0!==l?l:"")?u:e:null!==(c=S(i,s,e))&&void 0!==c?c:e}if(this._info.ts.isIdentifier(i))try{const e=s.defaultCheckExpression(i,n,a);if(s.typeToString(e).trim()===utsLanguageServiceInterface_1.UtsPluginLanguageService.Constants.UTSJSONObject){const t=s.getSymbolAtLocation(i);if(t){const n=utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.getDeclarationNodeFromSymbol(t).initializer;if(n){let t;if(this._info.ts.isObjectLiteralExpression(n)?t=s.getSymbolOfNode(n):this._info.ts.isAsExpression(n)&&this._info.ts.isObjectLiteralExpression(n.expression)&&(t=s.getSymbolOfNode(n.expression)),t&&t.members){let n=s.createAnonymousType(t,t.members,[],[],[]);return null!==(u=S(i,s,n))&&void 0!==u?u:e}}}}}catch(e){return void this._info.tsinfo.project.log("[error][uts] check identifer of utsjsonobject type failed...")}return;function p(t,i){var n;if(t.parent&&hx.ts.isCallExpression(t.parent)){const i=t.parent;if(utsLanguageServiceInterface_1.Global.isClientUtsFile(i.getSourceFile().fileName,e)){const e=s.getSymbolAtLocation(i.expression);if(e&&utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.isDefineCallName(e.escapedName))return!0;if(utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.isDefineCallName(null===(n=i.expression.name)||void 0===n?void 0:n.escapedText))return!0}}return!1}function S(e,t,s){const i=utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.getUTSJSONObjectType(f._realLs,e,f._info);if(i){const n=t.getUnionType([i,s],1);n.flags=f._info.ts.TypeFlags.Intersection,n.intrinsicName=utsLanguageServiceInterface_1.UtsPluginLanguageService.Constants.UTSJSONObject,n.types||(n.types=[]);const a=t.getSymbolOfNode(e);return a&&(n.symbol=a),n}}}isTypeRelatedTo(e,t,s,i){const{checker:n}=i;let a;return void 0===a&&(a=this.namedTypeIsRelated(e,t,s,i)),void 0===a&&(a=this.methodTypeIsRelated(e,t,s,i)[0]),void 0===a&&(a=this.UnionTypeIsRelated(e,t,n)),void 0===a&&(a=this.simpleTypeIsRelated(e,t,s,i)),void 0===a&&(a=this.specialStringTypeIsRelated(e,t,s,i)),void 0===a&&(a=this.undefinedTypeIsRelated(e,t,s,i)),a}checkTypeRelatedTo(e,t,s,i,n,a,r,g){var o,l;r&&!r.errors&&(r.errors=[]);const{checker:c,defaultResult:u,error:f}=g;if(0!==u&&!1===this.namedTypeIsRelated(e,t,s,g)){const s=c.typeToString(e).trim(),n=c.typeToString(t).trim();let a=f(i,utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.mergeDiagnosticMessageChainToMessage(utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.mergeDiagnosticMessagesToMesssageChain([utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.UTS_DIANOSTICS_I18N.type_0_cannot_be_assigned_to_type_1,utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.UTS_DIANOSTICS_I18N.named_type_assigned_to_named_type_must_be_same])),s,n);return r&&(null===(o=r.errors)||void 0===o||o.push(a)),0}if(0!==u){let n=this.methodTypeIsRelated(e,t,s,g);if(!1===n[0]){let e=f(i,n[1]);return r&&(null===(l=r.errors)||void 0===l||l.push(e)),0}}let p=this.UnionTypeIsRelated(e,t,c);return void 0!==p?p?-1:0:void 0!==this.simpleTypeIsRelated(e,t,s,g)?-1:u}isRelatedTo(e,t,s,i){let n;const{checker:a}=i;return void 0===n&&(n=this.literalTypeIsRelated(e,t,a)),n}checkAndReportErrorForUsingTypeAsValue(e,t){const{checker:s}=t;let i;if(e&&s&&hx.ts.isIdentifier(e)&&hx.ts.isBinaryExpression(e.parent)){e.parent.operatorToken.kind===hx.ts.SyntaxKind.InstanceOfKeyword&&(i=!0)}return i}checkAndReportErrorForUsingTypeAsNamespace(e,t){const{checker:s}=t;let i;return e&&s&&hx.ts.isIdentifier(e)&&hx.ts.isQualifiedName(e.parent)&&(i=!0),i}namedTypeIsRelated(e,t,s,i){var n,a;const r=this,{checker:g,getRelationKey:o}=i;let l=e,c=t,u=g.typeToString(l).trim(),f=g.typeToString(c).trim(),p=new RegExp(`(^${utsLanguageServiceInterface_1.UtsPluginLanguageService.Constants.UTSJSONObject}\\s*&\\s*\\{)`);if(p.test(u)&&(l=null!==(n=utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.getUTSJSONObjectType(this._realLs,void 0,this._info))&&void 0!==n?n:e,u=g.typeToString(l)),p.test(f)&&(c=null!==(a=utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.getUTSJSONObjectType(this._realLs,void 0,this._info))&&void 0!==a?a:t,f=g.typeToString(c)),(l.flags&this._info.ts.TypeFlags.Object)===this._info.ts.TypeFlags.Object&&(c.flags&this._info.ts.TypeFlags.Object)===this._info.ts.TypeFlags.Object){const i=l,n=c,a=o(e,t,types_1.IntersectionState.None,s,!1);if(s.has(a)&&s.get(a)===types_1.RelationComparisonResult.Failed)return!1;const p=e=>(e.objectFlags&this._info.ts.ObjectFlags.Class)===this._info.ts.ObjectFlags.Class,S=e=>(e.objectFlags&this._info.ts.ObjectFlags.Interface)===this._info.ts.ObjectFlags.Interface,_=e=>(e.objectFlags&this._info.ts.ObjectFlags.Anonymous)===this._info.ts.ObjectFlags.Anonymous&&!!e.aliasSymbol;if((p(i)||S(i)||_(i))&&(p(n)||S(n)||_(n))){if(l.symbol&&c.symbol&&!_(i)&&!_(n)&&function e(t,s){var i,n;const a=null!==(i=t.declarations)&&void 0!==i?i:[];for(const t of a)if(r._info.ts.isClassDeclaration(t)||r._info.ts.isInterfaceDeclaration(t)){const i=null!==(n=t.heritageClauses)&&void 0!==n?n:[];for(const t of i)for(const i of t.types){const t=g.getSymbolAtLocation(i.expression);if(t){if(t===s)return!0;if(e(t,s))return!0}}}return!1}(l.symbol,c.symbol))return;if(u!==f)return s.set(a,types_1.RelationComparisonResult.Failed),!1}}return}methodTypeIsRelated(e,t,s,i){const{checker:n,isTypeRelatedTo:a}=i,r=this,g=(e,t,s)=>{let n=r.isTypeRelatedTo(e,t,s,i);return void 0!==n?n:a(e,t,s)},o=n.getSignaturesOfType(e,this._info.ts.SignatureKind.Call),l=n.getSignaturesOfType(t,this._info.ts.SignatureKind.Call);if(o.length&&l.length){const c=[];for(const h of o)for(const T of l){let[v,d]=y(h,T);if(v)return[!0,void 0];d&&c.push(d)}const u=utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.mergeDiagnosticMessages(c),f=n.typeToString(e),p=n.typeToString(t),S=utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.replaceDiagnosticMessage(utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.UTS_DIANOSTICS_I18N.signature_0_cannot_assign_to_signature_1,[f,p]),_=utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.mergeDiagnosticMessagesToMesssageChain([S,u]);return[!1,utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.mergeDiagnosticMessageChainToMessage(_)];function y(e,t){const i=e.getParameters(),a=t.getParameters();function o(r){for(let o=0;o<r;++o){const r=i[o],c=a[o],u=n.getTypeOfSymbolAtLocation(r,e.getDeclaration()),f=n.getTypeOfSymbolAtLocation(c,t.getDeclaration()),p=n.typeToString(u),S=n.typeToString(f);if(!g(u,f,s)&&p!==S)return l.push(utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.replaceDiagnosticMessage(utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.UTS_DIANOSTICS_I18N.paramter_type_0_can_not_assign_to_paramter_type_1,[p,S])),!1}return!0}const l=[];if(i.length!==a.length){let s=Math.min(i.length,a.length);if(!o(s))return[!1,utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.mergeDiagnosticMessageChainToMessage(utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.mergeDiagnosticMessagesToMesssageChain(l))];const[g,c]=i.length>a.length?[i,e.getDeclaration()]:[a,t.getDeclaration()];for(let e=s;e<g.length;++e){const t=g[e],s=n.getTypeOfSymbolAtLocation(t,c);if((s.flags&r._info.ts.TypeFlags.Union)!==r._info.ts.TypeFlags.Union)return l.push(utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.replaceDiagnosticMessage(utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.UTS_DIANOSTICS_I18N.expected_0_parameters_type_but_got_1_parameters_type,[`${a.length}`,`${i.length}`])),[!1,utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.mergeDiagnosticMessageChainToMessage(utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.mergeDiagnosticMessagesToMesssageChain(l))];let o=!1;for(const e of s.types)(e.flags&r._info.ts.TypeFlags.Undefined)===r._info.ts.TypeFlags.Undefined&&(o=!0);if(!o)return l.push(utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.replaceDiagnosticMessage(utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.UTS_DIANOSTICS_I18N.expected_0_parameters_type_but_got_1_parameters_type,[`${a.length}`,`${i.length}`])),[!1,utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.mergeDiagnosticMessageChainToMessage(utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.mergeDiagnosticMessagesToMesssageChain(l))]}return[!0,void 0]}{let e=o(i.length||a.length);if(!e)return[e,utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.mergeDiagnosticMessageChainToMessage(utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.mergeDiagnosticMessagesToMesssageChain(l))]}const c=e.getReturnType(),u=t.getReturnType(),f=n.typeToString(c).trim(),p=n.typeToString(u).trim();return g(c,u,s)||f===p?[!0,void 0]:[!1,utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.replaceDiagnosticMessage(utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.UTS_DIANOSTICS_I18N.return_type_0_can_not_assign_to_return_type_1,[f,p])]}}return[void 0,void 0]}UnionTypeIsRelated(e,t,s){if(t.flags===this._info.ts.TypeFlags.Union){const s=t;if(!s.types.find((e=>e.flags!==this._info.ts.TypeFlags.StringLiteral))&&e.flags===this._info.ts.TypeFlags.String)return!0;if(!s.types.find((e=>e.flags!==this._info.ts.TypeFlags.NumberLiteral))&&e.flags===this._info.ts.TypeFlags.Number)return!0}}simpleTypeIsRelated(e,t,s,i){if(i.captureErrorCalculationState&&i.resetErrorInfo){let s=i.captureErrorCalculationState();if((e.flags&hx.ts.TypeFlags.Number)===hx.ts.TypeFlags.Number&&(t.flags&hx.ts.TypeFlags.NumberLiteral)===hx.ts.TypeFlags.NumberLiteral)return s.errorInfo=void 0,i.resetErrorInfo(s),!0;if((e.flags&hx.ts.TypeFlags.String)===hx.ts.TypeFlags.String&&(t.flags&hx.ts.TypeFlags.StringLiteral)===hx.ts.TypeFlags.StringLiteral)return s.errorInfo=void 0,i.resetErrorInfo(s),!0;if((e.flags&this._info.ts.TypeFlags.Object)===this._info.ts.TypeFlags.Object&&(t.flags&this._info.ts.TypeFlags.Object)===this._info.ts.TypeFlags.Object&&s&&s.errorInfo&&2420===s.errorInfo.code){let e=utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.removeDiagnosticMessageChianSubChian(s.errorInfo,[2322,void 0]);s.errorInfo=e,i.resetErrorInfo(s)}}}specialStringTypeIsRelated(e,t,s,i){var n,a;if(e.symbol&&t&&e.symbol.declarations){let s=null===(n=e.symbol.declarations[0].parent)||void 0===n?void 0:n.parent;if(s&&hx.ts.isModuleDeclaration(s)&&"string"===s.name.getText()&&t.flags===hx.ts.TypeFlags.String)return!0}if(e&&t.symbol&&t.symbol.declarations){let s=null===(a=t.symbol.declarations[0].parent)||void 0===a?void 0:a.parent;if(s&&hx.ts.isModuleDeclaration(s)&&"string"===s.name.getText()&&e.flags===hx.ts.TypeFlags.String)return!0}}undefinedTypeIsRelated(e,t,s,i){let n;return e&&t&&(e.flags===hx.ts.TypeFlags.Null&&t.flags===hx.ts.TypeFlags.Undefined&&(n=!0),t.flags===hx.ts.TypeFlags.Null&&e.flags===hx.ts.TypeFlags.Undefined&&(n=!0)),n}literalTypeIsRelated(e,t,s){return e.flags===hx.ts.TypeFlags.Number&&t.flags===hx.ts.TypeFlags.NumberLiteral||(e.flags===hx.ts.TypeFlags.NumberLiteral&&t.flags===hx.ts.TypeFlags.Number||(e.flags===hx.ts.TypeFlags.String&&t.flags===hx.ts.TypeFlags.StringLiteral||(e.flags===hx.ts.TypeFlags.StringLiteral&&t.flags===hx.ts.TypeFlags.String||void 0)))}}exports.UtsLanguageFeatureTypeCheckerPlugin=UtsLanguageFeatureTypeCheckerPlugin;
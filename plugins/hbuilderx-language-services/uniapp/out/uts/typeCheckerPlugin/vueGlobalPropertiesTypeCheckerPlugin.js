"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.VueGlobalPropertiesTypeCheckerPlugin=void 0;const path=require("path"),hx=require("../../../../core"),core_1=require("../../../../core"),utsLanguageServiceInterface_1=require("../utsLanguageServiceInterface");class VueGlobalPropertiesTypeCheckerPlugin{constructor(e){this._info=e,this._chacheType=void 0,this._mainFileVersion="0",this._mainFile=hx.toNormalizedPath(path.join(e.project.sourceRoot,"main.uts"),e.ts),this._realLs=e.languageService}setLanguageService(e){this._realLs=e}checkExpression(e,i,t,s,o,r){var n,l;let a=s.getSourceFile().fileName;if((a.endsWith(".__VLS_template.jsx")||a.endsWith(".__VLS_template.tsx"))&&this._info.ts.isPropertyAccessExpression(s)&&s.getText().indexOf("__VLS_types.vuePrototype")>=0){let e=this._info.tsinfo.project.getScriptInfo(this._mainFile);if(e&&e.getLatestVersion()===this._mainFileVersion)return this._chacheType;let i=null===(n=this._realLs.getProgram())||void 0===n?void 0:n.getSourceFile(this._mainFile);if(i){let s=this._info.ts.createSymbolTable();const o=this;if(i.forEachChild((function e(i){var r,n,l,a,c;if(utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.checkNodeIs([i,i,null==i?void 0:i.expression,null===(r=null==i?void 0:i.expression)||void 0===r?void 0:r.left,null===(l=null===(n=null==i?void 0:i.expression)||void 0===n?void 0:n.left)||void 0===l?void 0:l.expression],[o._info.ts.isExpressionStatement,e=>-1!==e.getText().indexOf(".globalProperties."),o._info.ts.isBinaryExpression,o._info.ts.isPropertyAccessExpression,o._info.ts.isPropertyAccessExpression])){let e=i;if("globalProperties"===e.expression.left.expression.name.escapedText){const i=e.expression.left.expression.expression,r=t.getTypeAtLocation(i).symbol;if(r){const i=utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.getDeclarationNodeFromSymbol(r);if(i&&o._info.ts.isClassDeclaration(i)&&(null===(a=i.name)||void 0===a?void 0:a.escapedText)==utsLanguageServiceInterface_1.UtsPluginLanguageService.Constants.GLOBAL_PROPERTIES_CONFIG_TYPE_NAME&&hx.pathIsPath(utsLanguageServiceInterface_1.UtsPluginLanguageService.Constants.GLOBAL_PROPERTIES_CONFIG_TYPE_FILE_PATH,null!==(c=null==i?void 0:i.getSourceFile().fileName)&&void 0!==c?c:"")){let i=e.expression.left.name.escapedText;if(i){let t=new(o._info.ts.objectAllocator.getSymbolConstructor())(core_1.ts.SymbolFlags.Property|core_1.ts.SymbolFlags.Assignment,i);t.declarations=[e.expression],t.valueDeclaration=e.expression,s.set(i,t)}}}}}i.forEachChild(e)})),s.size>0){const i=t.createAnonymousType(void 0,s,[],[],[]);return this._chacheType=i,this._mainFileVersion=null!==(l=null==e?void 0:e.getLatestVersion())&&void 0!==l?l:this._mainFileVersion,i}}}}}exports.VueGlobalPropertiesTypeCheckerPlugin=VueGlobalPropertiesTypeCheckerPlugin;
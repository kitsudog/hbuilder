"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CommonLanguageService=exports.CommonDocumentProvider=void 0;const fs=require("fs"),vscode_uri_1=require("vscode-uri"),hx=require("../../../../core"),core_1=require("../../../../core"),platformType_1=require("../../utils/platformType"),uts_language_feature_typecheker_plugin_1=require("../typeCheckerPlugin/uts_language_feature_typecheker_plugin"),types_1=require("../types"),utsLanguageServiceInterface_1=require("../utsLanguageServiceInterface");class CommonDocumentProvider{constructor(e){this._info=e}get version(){return this._info.tsinfo.project.getProjectVersion()+utsLanguageServiceInterface_1.Global.getLibFilesVersion(types_1.UtsPluginPlatform.COMMON)}get compilerOptions(){const e=this,t=e._info.tsinfo.project.getCompilerOptions.bind(e._info.tsinfo.project)();return{allowNonTsExtensions:!0,allowJs:!0,lib:[],target:this._info.ts.ScriptTarget.Latest,moduleResolution:this._info.ts.ModuleResolutionKind.Node10,experimentalDecorators:!0,noLib:!0,noCustomResolve:!1,noResolve:(0,utsLanguageServiceInterface_1.parseServerMode)()===core_1.ts.LanguageServiceMode.PartialSemantic,strictNullChecks:!0,strictPropertyInitialization:!0,noImplicitOverride:!0,checkExpressionOverride:function(i,n,r,s){return e.checkExpression(e._info.project,t,i,n,r,s)},getContextualTypeOverride:function(i,n,r){return e.getContextualType(e._info.project,t,i,n,r)},shouldIsTypeRelatedToOverride:!0,isTypeRelatedToOverride:function(t,i,n,r){return e.isTypeRelatedToOverride(t,i,n,r)},shouldCheckTypeRelatedToOverride:!0,checkTypeRelatedToOverride:function(t,i,n,r,s,a,g,o){g&&!g.errors&&(g.errors=[]);return e.checkTypeRelatedToOverride(t,i,n,r,s,a,g,o)},checkAndReportErrorForUsingTypeAsValue:function(t,i){return e.checkAndReportErrorForUsingTypeAsValue(t,i)},checkAndReportErrorForUsingTypeAsNamespace:function(t,i){return e.checkAndReportErrorForUsingTypeAsNamespace(t,i)},isRelatedToOverride:function(t,i,n,r){return e.isRelatedToOverride(t,i,n,r)}}}get documents(){const e=this._getDocuments(),t=new Set(hx.getDefaultLibs(this._info.project).filter((e=>!hx.pathIsPath(e,utsLanguageServiceInterface_1.UtsPluginLanguageService.Constants.SPECIAL_STRING_BASE_LIB_PATH))));return e.filter((e=>!t.has(e)))}hasDocument(e){var t;let i=hx.toNormalizedUri(e,this._info.ts);const n=vscode_uri_1.URI.parse(i).fsPath,r=null===(t=this._info.tsinfo.languageServiceHost.fileExists)||void 0===t?void 0:t.bind(this._info.tsinfo.languageServiceHost);return r?r(n):fs.existsSync(n)}getDocumentVersion(e){let t=hx.toNormalizedUri(e,this._info.ts);return this._info.tsinfo.project.getScriptVersion(vscode_uri_1.URI.parse(t).fsPath)}getDocumentSnapshot(e){let t=vscode_uri_1.URI.parse(hx.toNormalizedUri(e,this._info.ts));if(utsLanguageServiceInterface_1.Global.resolveUtsPlatformByLibFiles(t.fsPath,this._info.project)){const e=hx.getFileProperty(t.fsPath,"snapshot",(e=>{let t=fs.readFileSync(e).toString();return{getText:(e,i)=>t.substring(e,i),getLength:()=>t.length,getChangeRange:()=>{}}}));if(e)return e}return this._info.tsinfo.project.getScriptSnapshot(t.fsPath)}getDocumentKind(e){let t=hx.toNormalizedUri(e,this._info.ts);return utsLanguageServiceInterface_1.Global.isUtsFile(e)?this._info.ts.ScriptKind.TS:this._info.tsinfo.project.getScriptKind(vscode_uri_1.URI.parse(t).fsPath)}getDefaultLibs(e){return[utsLanguageServiceInterface_1.UtsPluginLanguageService.Constants.DCLOUD_IO_UNI_APP_X_BASE_LIB_PATH_PLUGIN_ENTRY_FILE_PATH]}resolveModuleNameOverride(e,t,i,n,r,s,a,g){let o;try{o=utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.getPlatformModuleNameResolver(types_1.UtsPluginPlatform.COMMON,this._info).resolveModuleName(e,t,i,n,r,s,a,g)}catch(e){return}return o||(o=utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.getUtsUniModPluginModuleNameResolver(this._info).resolveModuleName(e,t,i,n,r,s,a,g)),o||(o=hx.resolveModuleName(this._info.ts,e,t,i,n,r,s,a,g)),o}_getDocuments(){let e=[];return e.push(...utsLanguageServiceInterface_1.Global.getLibFiles(types_1.UtsPluginPlatform.COMMON)),this._info.tsinfo.project.getScriptInfos().forEach((t=>{this._info.project.isProjectOf(t.fileName,this._info.ts)&&(utsLanguageServiceInterface_1.Global.isUtsFile(t.fileName)||utsLanguageServiceInterface_1.Global.isUtsPluginVueTsFile(t.fileName,this._info.project)||utsLanguageServiceInterface_1.Global.isClientUtsFile(t.fileName,this._info.project))&&(e.includes(t.fileName)||e.push(t.fileName))})),e}checkExpression(e,t,i,n,r,s){return this.utsLanguageFeatureTypecheckerPlugin.checkExpression?this.utsLanguageFeatureTypecheckerPlugin.checkExpression(e,t,i,n,r,s):void 0}getContextualType(e,t,i,n,r){}isTypeRelatedToOverride(e,t,i,n){return this.utsLanguageFeatureTypecheckerPlugin.isTypeRelatedTo?this.utsLanguageFeatureTypecheckerPlugin.isTypeRelatedTo(e,t,i,n):void 0}checkTypeRelatedToOverride(e,t,i,n,r,s,a,g){return this.utsLanguageFeatureTypecheckerPlugin.checkTypeRelatedTo?this.utsLanguageFeatureTypecheckerPlugin.checkTypeRelatedTo(e,t,i,n,r,s,a,g):0}checkAndReportErrorForUsingTypeAsValue(e,t){return this.utsLanguageFeatureTypecheckerPlugin.checkAndReportErrorForUsingTypeAsValue?this.utsLanguageFeatureTypecheckerPlugin.checkAndReportErrorForUsingTypeAsValue(e,t):void 0}checkAndReportErrorForUsingTypeAsNamespace(e,t){return this.utsLanguageFeatureTypecheckerPlugin.checkAndReportErrorForUsingTypeAsNamespace?this.utsLanguageFeatureTypecheckerPlugin.checkAndReportErrorForUsingTypeAsNamespace(e,t):void 0}getLanguageService(){return this._info.languageService}get utsLanguageFeatureTypecheckerPlugin(){return this._UtsLanguageFeatureTypecheckerPlugin||(this._UtsLanguageFeatureTypecheckerPlugin=new uts_language_feature_typecheker_plugin_1.UtsLanguageFeatureTypeCheckerPlugin(this._info,this.getLanguageService())),this._UtsLanguageFeatureTypecheckerPlugin}isRelatedToOverride(e,t,i,n){return this.utsLanguageFeatureTypecheckerPlugin.isRelatedTo?this.utsLanguageFeatureTypecheckerPlugin.isRelatedTo(e,t,i,n):void 0}}exports.CommonDocumentProvider=CommonDocumentProvider;class CommonLanguageService{constructor(e){this._info=e}async getCompletionsAtPosition(e,t,i){return this.getUtsLanguageService().getCompletionsAtPosition(e,t,i)}getCompletionEntryDetails(e,t,i,n,r,s,a){return this.getUtsLanguageService().getCompletionEntryDetails(e,t,i,n,r,s,a)}async getDefinitionAndBoundSpan(e,t){return this.getUtsLanguageService().getDefinitionAndBoundSpan(e,t)}async getQuickInfoAtPosition(e,t){return this.getUtsLanguageService().getQuickInfoAtPosition(e,t)}async getSemanticDiagnosticsAsync(e){let t=this.getUtsLanguageService(),i=t.getSemanticDiagnostics(e);return utsLanguageServiceInterface_1.UtsPluginLanguageService.CommonLogic.getSemanticDiagnostics(t,e,this._info.ts,i)}getSignatureHelpItems(e,t,i){return this.getUtsLanguageService().getSignatureHelpItems(e,t,i)}getCodeFixesAtPosition(e,t,i,n,r,s){return this.getUtsLanguageService().getCodeFixesAtPosition(e,t,i,n,r,s)}async getSuggestionDiagnosticsAsync(e){return this.getUtsLanguageService().getSuggestionDiagnostics(e)}async getSyntacticDiagnosticsAsync(e){const t=this.getUtsLanguageService();let i=t.getSyntacticDiagnostics(e);return utsLanguageServiceInterface_1.UtsPluginLanguageService.CommonLogic.getSyntacticDiagnostics(t,e,this._info.ts,i,this._info.target)}getCompletionEntrySymbol(e,t,i,n){return this.getUtsLanguageService().getCompletionEntrySymbol(e,t,i,n)}getDefinitionAtPosition(e,t){return this.getUtsLanguageService().getDefinitionAtPosition(e,t)}getTypeDefinitionAtPosition(e,t){return this.getUtsLanguageService().getTypeDefinitionAtPosition(e,t)}getImplementationAtPosition(e,t){return this.getUtsLanguageService().getImplementationAtPosition(e,t)}getDocumentHighlights(e,t,i){return this.getUtsLanguageService().getDocumentHighlights(e,t,i)}findRenameLocations(e,t,i,n,r){return this.getUtsLanguageService().findRenameLocations(e,t,i,n,r)}getReferencesAtPosition(e,t){return this.getUtsLanguageService().getReferencesAtPosition(e,t)}findReferences(e,t){return this.getUtsLanguageService().findReferences(e,t)}getNavigateToItems(e,t,i,n){return this.getUtsLanguageService().getNavigateToItems(e,t,i,n)}getEmitOutput(e,t,i){return this.getUtsLanguageService().getEmitOutput(e,t,i)}getSemanticClassifications(e,t,i){return this.getUtsLanguageService().getSemanticClassifications(e,t,i)}getEncodedSemanticClassifications(e,t,i){return this.getUtsLanguageService().getEncodedSemanticClassifications(e,t,i)}getCombinedCodeFix(e,t,i,n){return this.getUtsLanguageService().getCombinedCodeFix(e,t,i,n)}organizeImports(e,t,i){return this.getUtsLanguageService().organizeImports(e,t,i)}getTodoComments(e,t){return this.getUtsLanguageService().getTodoComments(e,t)}getRenameInfo(e,t,i){return this.getUtsLanguageService().getRenameInfo(e,t,i)}getApplicableRefactors(e,t,i,n,r){return this.getUtsLanguageService().getApplicableRefactors(e,t,i,n,r)}getEditsForRefactor(e,t,i,n,r,s){return this.getUtsLanguageService().getEditsForRefactor(e,t,i,n,r,s)}prepareCallHierarchy(e,t){return this.getUtsLanguageService().prepareCallHierarchy(e,t)}provideCallHierarchyIncomingCalls(e,t){return this.getUtsLanguageService().provideCallHierarchyIncomingCalls(e,t)}provideCallHierarchyOutgoingCalls(e,t){return this.getUtsLanguageService().provideCallHierarchyOutgoingCalls(e,t)}provideInlayHints(e,t,i){return this.getUtsLanguageService().provideInlayHints(e,t,i)}getFileReferences(e){return this.getUtsLanguageService().getFileReferences(e)}getUtsLanguageService(){if(!this._utsPluginLs){const e=new CommonDocumentProvider(this._info);let t=utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.createLanguageServiceHost(e,this._info.project,this._info);const i=this._info.ts.createLanguageService2(this._info,t,this._info.project.documentRegistry);this._utsPluginLs=i}return this._utsPluginLs}static getAutoFixCode(e,t,i,n,r,s){const a=[],g=r.getProgram(),o=null==g?void 0:g.getTypeChecker(),c=null==g?void 0:g.getSourceFile(e),u=(0,platformType_1.getPlatformType)();if(n.includes(2345)&&o&&c){let n=core_1.ts.getTokenAtPosition(c,t),r=o.getTypeAtLocation(n),s=o.getContextualType(n);if(r.flags===core_1.ts.TypeFlags.Number){const t=null==s?void 0:s.symbol.escapedName;if(t&&u.get(t)){let n=u.get(t);if(n){let t=utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.replaceDiagnosticMessage(utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.UTS_DIANOSTICS_I18N.convert_0_to_native_platform_type,[n]).message;a.push({fixName:"autofix uts type",description:t,changes:[{fileName:e,textChanges:[{newText:n,span:{start:i,length:0}}]}]})}}}else if(r.flags===core_1.ts.TypeFlags.Object&&(null==s?void 0:s.flags)===core_1.ts.TypeFlags.Number){const i=null==r?void 0:r.symbol.escapedName;if(i&&u.get(i)){const i=n.escapedText;if(i){const n=`Number.from(${i})`;let r=utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.replaceDiagnosticMessage(utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.UTS_DIANOSTICS_I18N.convert_0_to_number_type,[n]).message;a.push({fixName:"autofix uts type",description:r,changes:[{fileName:e,textChanges:[{newText:n,span:{start:t,length:i.length}}]}]})}}}}if(n.includes(2322)&&o&&c){let i=core_1.ts.getTokenAtPosition(c,t),n=o.getTypeAtLocation(i);if(n&&n.flags===core_1.ts.TypeFlags.Object&&core_1.ts.isIdentifier(i)){let t=null==n?void 0:n.symbol.escapedName,r=i.parent.initializer;if(r){let i=o.getTypeAtLocation(r);if(r&&i.flags===core_1.ts.TypeFlags.Number&&t&&u.get(t)){let i=u.get(t);if(i){let t=utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.replaceDiagnosticMessage(utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.UTS_DIANOSTICS_I18N.convert_0_to_native_platform_type,[i]).message;a.push({fixName:"autofix uts type",description:t,changes:[{fileName:e,textChanges:[{newText:i,span:{start:r.end,length:0}}]}]})}}}}if(n&&n.flags===core_1.ts.TypeFlags.Number&&core_1.ts.isIdentifier(i)){let t=i.parent.initializer;if(t){let i=o.getTypeAtLocation(t).symbol.escapedName,n=t.escapedText;if(t&&i&&u.get(i)&&n){const i=`Number.from(${n})`;let r=utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.replaceDiagnosticMessage(utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.UTS_DIANOSTICS_I18N.convert_0_to_number_type,[i]).message;a.push({fixName:"autofix uts type",description:r,changes:[{fileName:e,textChanges:[{newText:i,span:{start:t.end-n.length,length:n.length}}]}]})}}}}return a}}exports.CommonLanguageService=CommonLanguageService;
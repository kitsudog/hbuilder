"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.IosThirdLibInfoProvider=exports.TypeKind=void 0;const path=require("path"),fs=require("fs"),hx=require("../../../../core");var TypeKind;!function(e){e[e.CLASS=0]="CLASS",e[e.INTERFACE=1]="INTERFACE",e[e.ENUM=2]="ENUM",e[e.ALL=3]="ALL"}(TypeKind||(exports.TypeKind=TypeKind={}));class IosThirdLibInfoProvider{constructor(e,t){this._project=e,this._loger=t,this._uniModuleLibDepMap=new Map,this._libInfoMap=new Map,this.scanAndListen()}hasModuleName(e,t){if(this._uniModuleLibDepMap.has(e))for(let i of this._uniModuleLibDepMap.get(e))if(this._libInfoMap.has(i)){const e=this._libInfoMap.get(i);if(new Set(Object.keys(e.info.tree)).has(t))return!0}return!1}getModuleNames(e){const t=Date.now();this.log(`IosThirdLibInfoProvider::getModuleNames start:${t}`);let i=[];if(this._uniModuleLibDepMap.has(e))for(let t of this._uniModuleLibDepMap.get(e))this._libInfoMap.has(t)&&i.push(...Object.keys(this._libInfoMap.get(t).info.tree));return this.log("IosThirdLibInfoProvider::getModuleNames end:"+(Date.now()-t)),i}getModulePath(e,t){const i=Date.now();this.log(`IosThirdLibInfoProvider::getModulePath start:${i}`);let o=[];if(this._uniModuleLibDepMap.has(e))for(let i of this._uniModuleLibDepMap.get(e))if(this._libInfoMap.has(i)){const e=this._libInfoMap.get(i),s=path.join(e.basePath,t,"index.d.ts");fs.existsSync(s)&&o.push(s)}return this.log("IosThirdLibInfoProvider::getModulePath end:"+(Date.now()-i)),o}getTypeNames(e,t){let i=[];if(this._uniModuleLibDepMap.has(e))for(let s of this._uniModuleLibDepMap.get(e))if(this._libInfoMap.has(s)){const e=this._libInfoMap.get(s);for(let s in e.info.map){const n=e.info.map[s];o(n.type,t)&&i.push({...n})}}return i;function o(e,t){switch(e){case"class":return TypeKind.CLASS===(t&TypeKind.CLASS);case"interface":return TypeKind.INTERFACE===(t&TypeKind.INTERFACE);case"enum":return TypeKind.ENUM===(t&TypeKind.ENUM);default:return!1}}}getLibDirs(){const e=[];for(let[t,i]of this._libInfoMap)e.push(i.basePath);return e}log(...e){this._loger(`[iOS 三方库]${e.join(" ")}`)}scanAndListen(){const e=this,t=hx.getSysArgsData(hx.ts,"--vscodeEnvAppData");if(!t)return;const i=require("md5"),o=hx.toNormalizedPath(this._project.fsPath,hx.ts),s=path.join(t,"extensions","uts-development-ios","ios_third_lib",i(o));fs.existsSync(s)||fs.mkdirSync(s,{recursive:!0});const n=path.join(s,"map.json");if(!fs.existsSync(n))return fs.writeFileSync(n,"{}"),void a();function r(){try{const t=JSON.parse(fs.readFileSync(n).toString());for(let i in t){const o=t[i];"[object Array]"===Object.prototype.toString.call(o)&&e._uniModuleLibDepMap.set(i,new Set(o))}for(let[,t]of e._uniModuleLibDepMap)for(let i of t){const t=path.join(s,i),o=path.join(t,"typeMap.json");if(fs.existsSync(o)){const s=hx.getFileProperty(o,"typeMap.json",(()=>{var i;try{const e=JSON.parse(null!==(i=hx.readFileToString(o))&&void 0!==i?i:"");if(e.tree&&e.map)return{basePath:t,info:e}}catch(t){e.log("解析库类型映射文件失败",JSON.stringify(t))}}));s&&e._libInfoMap.set(i,s)}}}catch(t){e.log("解析映射文件失败",JSON.stringify(t))}}function a(){fs.watch(n,(()=>{e._uniModuleLibDepMap.clear(),e._libInfoMap.clear(),fs.existsSync(n)&&r()}))}r(),a()}}exports.IosThirdLibInfoProvider=IosThirdLibInfoProvider;
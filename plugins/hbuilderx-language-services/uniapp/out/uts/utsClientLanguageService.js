"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ClientLanguageService=void 0;const hx=require("../../../core"),path=require("path"),easycome_1=require("../utils/easycome"),utsLanguageServiceInterface_1=require("./utsLanguageServiceInterface"),uni_module_uts_plugin_1=require("./uni_module_uts_plugin"),types_1=require("./types"),uts_language_feature_typecheker_plugin_1=require("./typeCheckerPlugin/uts_language_feature_typecheker_plugin"),tsUtils_1=require("../utils/tsUtils");class ClientLanguageService{constructor(e){this._info=e,uni_module_uts_plugin_1.AndroidLanguageService.init(this._info.ts),uni_module_uts_plugin_1.IosLanguageService.init(this._info.ts),this._utsLanguageFeatureTypecheckerPlugin=new uts_language_feature_typecheker_plugin_1.UtsLanguageFeatureTypeCheckerPlugin(e),this._typeCheckerPlugins=[],this.overrideHost()}async getCompletionsAtPosition(e,t,i){var n;let r=utsLanguageServiceInterface_1.Global.getTimeWatcher();r.startCollect("uts client complete");const s=this.getUtsLanguageService();r.startCollect("get default result");let a=await s.getCompletionsAtPositionAsync(e,t,i);if(this._info.target!==hx.TargetKind["APP-ANDROID"])return a;r.endCollect();const o=new Set,g=(null==a?void 0:a.entries.filter((e=>{if(e.source){let t=hx.toNormalizedPath(e.source,this._info.ts);if(utsLanguageServiceInterface_1.Global.resolveUtsPlatformByLibFiles(t,this._info.project,!1))return!1}return o.add(e.name),!0})))||[];let u=s.getProgram();if(u){let i=u.getSourceFile(e);if(i){let e=this._info.ts.getTokenAtPosition(i,t);if(utsLanguageServiceInterface_1.UtsPluginLanguageService.isImportStringLiteral(i,t,this._info.ts)){r.startCollect("get import package infos");let t=null===(n=e.text)||void 0===n?void 0:n.trim();r.startCollect("get android package infos"),uni_module_uts_plugin_1.AndroidLanguageService.isAndroidPackageNameLike(t)&&g.push(...uni_module_uts_plugin_1.AndroidLanguageService.getModuleEntries(t).filter((e=>!o.has(e.name)))),r.endCollect(),r.startCollect("get ios package infos"),r.endCollect(),r.endCollect()}else if(!(null==a?void 0:a.isMemberCompletion)&&g.length>0){let e=this._info.ts.getTokenAtPosition(i,t-1);if(e&&this._info.ts.isIdentifier(e)){g.push(...uni_module_uts_plugin_1.AndroidLanguageService.getDefaultImportEntries().filter((e=>!o.has(e.name)&&(o.add(e.name),!0))));let e=utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.getEasycom(this._info).getEasycomName();for(let t of e.keys())g.push({name:t,kind:this._info.ts.ScriptElementKind.typeElement,sortText:t,source:easycome_1.EasycomInfo._sourceFlag})}}}}return a||(a=utsLanguageServiceInterface_1.UtsPluginLanguageService.createEmptyCompletionInfo()),a.entries=g,r.endCollect(),a}getCompletionEntryDetails(e,t,i,n,r,s,a){var o;const g=utsLanguageServiceInterface_1.Global.getTimeWatcher();g.startCollect("uts client resolve completion item");const u=this.getUtsLanguageService();if(null==r?void 0:r.startsWith(uni_module_uts_plugin_1.AndroidLanguageService._sourceFlag)){let i=null===(o=u.getProgram())||void 0===o?void 0:o.getSourceFile(e);if(i){const e=uni_module_uts_plugin_1.AndroidLanguageService.resolveAutoImportEntry(a,t,i,this._info.ts);return g.endCollect(),e}}else{if(null==r?void 0:r.startsWith(uni_module_uts_plugin_1.AndroidLanguageService._defaultInportSourceFlag))return uni_module_uts_plugin_1.AndroidLanguageService.resolveDefaultImportEntry(a);if(r===easycome_1.EasycomInfo._sourceFlag){let e=utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.getEasycom(this._info).getTypeNameFileName(i);return{name:i,kind:this._info.ts.ScriptElementKind.typeElement,kindModifiers:this._info.ts.ScriptElementKind.typeElement,displayParts:[{text:e,kind:"text"}]}}}return g.endCollect(),u.getCompletionEntryDetails(e,t,i,n,r,s,a)}async getDefinitionAndBoundSpan(e,t){const i=this.getUtsLanguageService();let n=await i.getDefinitionAndBoundSpanAsync(e,t);return utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.getEasycom(this._info).getDefinitionAndBoundSpan(n,e,t,i,this._info.ts)}getQuickInfoAtPosition(e,t){return this.getUtsLanguageService().getQuickInfoAtPositionAsync(e,t)}async getSemanticDiagnosticsAsync(e){const t=this.getUtsLanguageService();let i=t.getSemanticDiagnostics(e),n=utsLanguageServiceInterface_1.UtsPluginLanguageService.CommonLogic.getSemanticDiagnostics(t,e,this._info.ts,i);return this._info.target&&this._info.target===hx.TargetKind["APP-IOS"]&&n.forEach((e=>{if(!(e&&2307===e.code&&e.file&&e.start&&e.length))return;const t=hx.ts.getTokenAtPosition(e.file,e.start);if(!utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.checkNodeLinkIs(t,[hx.ts.isStringLiteral,hx.ts.isImportDeclaration],!0))return;const i=t.text;if(!uni_module_uts_plugin_1.IOS_BUILTIN_MODEULS_SET.has(i))return;const r={pos:e.start,end:e.start+e.length},s=utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.createDiagnosticFromMessage(e.file,r,utsLanguageServiceInterface_1.UtsPluginLanguageService.Diagnostic.UTS_DIANOSTICS_I18N.try_to_use_swift_devlopment_environment_outside_uts_ios_plugin);n.push(s)})),n}getSignatureHelpItems(e,t,i){return this.getUtsLanguageService().getSignatureHelpItems(e,t,i)}getCodeFixesAtPosition(e,t,i,n,r,s){return this.getUtsLanguageService().getCodeFixesAtPosition(e,t,i,n,r,s)}async getSyntacticDiagnosticsAsync(e){const t=this.getUtsLanguageService();let i=t.getSyntacticDiagnostics(e);return utsLanguageServiceInterface_1.UtsPluginLanguageService.CommonLogic.getSyntacticDiagnostics(t,e,this._info.ts,i,this._info.target)}async getSuggestionDiagnosticsAsync(e){return this.getUtsLanguageService().getSuggestionDiagnostics(e)}getCompletionEntrySymbol(e,t,i,n){return this.getUtsLanguageService().getCompletionEntrySymbol(e,t,i,n)}getDefinitionAtPosition(e,t){return this.getUtsLanguageService().getDefinitionAtPosition(e,t)}getTypeDefinitionAtPosition(e,t){return this.getUtsLanguageService().getTypeDefinitionAtPosition(e,t)}getImplementationAtPosition(e,t){return this.getUtsLanguageService().getImplementationAtPosition(e,t)}getDocumentHighlights(e,t,i){return this.getUtsLanguageService().getDocumentHighlights(e,t,i)}findRenameLocations(e,t,i,n,r){return this.getUtsLanguageService().findRenameLocations(e,t,i,n,r)}getReferencesAtPosition(e,t){return this.getUtsLanguageService().getReferencesAtPosition(e,t)}findReferences(e,t){return this.getUtsLanguageService().findReferences(e,t)}getNavigateToItems(e,t,i,n){return this.getUtsLanguageService().getNavigateToItems(e,t,i,n)}getEmitOutput(e,t,i){return this.getUtsLanguageService().getEmitOutput(e,t,i)}getSemanticClassifications(e,t,i){return this.getUtsLanguageService().getSemanticClassifications(e,t,i)}getEncodedSemanticClassifications(e,t,i){return this.getUtsLanguageService().getEncodedSemanticClassifications(e,t,i)}getCombinedCodeFix(e,t,i,n){return this.getUtsLanguageService().getCombinedCodeFix(e,t,i,n)}organizeImports(e,t,i){return this.getUtsLanguageService().organizeImports(e,t,i)}getTodoComments(e,t){return this.getUtsLanguageService().getTodoComments(e,t)}getRenameInfo(e,t,i){return this.getUtsLanguageService().getRenameInfo(e,t,i)}getApplicableRefactors(e,t,i,n,r){return this.getUtsLanguageService().getApplicableRefactors(e,t,i,n,r)}getEditsForRefactor(e,t,i,n,r,s){return this.getUtsLanguageService().getEditsForRefactor(e,t,i,n,r,s)}prepareCallHierarchy(e,t){return this.getUtsLanguageService().prepareCallHierarchy(e,t)}provideCallHierarchyIncomingCalls(e,t){return this.getUtsLanguageService().provideCallHierarchyIncomingCalls(e,t)}provideCallHierarchyOutgoingCalls(e,t){return this.getUtsLanguageService().provideCallHierarchyOutgoingCalls(e,t)}provideInlayHints(e,t,i){return this.getUtsLanguageService().provideInlayHints(e,t,i)}getFileReferences(e){return this.getUtsLanguageService().getFileReferences(e)}checkExpression(e,t,i,n,r,s){for(let a of this._typeCheckerPlugins)if(a.checkExpression){let o=a.checkExpression(e,t,i,n,r,s);if(o)return o}}getUtsLanguageService(){return this._info.languageService}overrideHost(){const e=this._info.languageServiceHost,t=e.resolveModuleNameLiterals?e.resolveModuleNameLiterals.bind(e):(e,t,i,n,r,s)=>e.map((e=>({resolvedModule:void 0}))),i=e.getScriptFileNames.bind(e),n=e.getCompilationSettings.bind(e);e.resolveModuleNameLiterals=(i,n,r,s,a,o)=>{let g=i.map((e=>({resolvedModule:void 0})));if(g.length!=i.length)return g;const u=[utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.getPlatformModuleNameResolver(types_1.UtsPluginPlatform.COMMON,this._info),utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.getUtsUniModPluginModuleNameResolver(this._info),{resolveModuleName:(e,t,i,n,r,s,a,o)=>{if(this._info.project.kind===hx.HXProjectKind.UniApp&&hx.isUniAppXProject(this._info.project)&&utsLanguageServiceInterface_1.Global.isClientUtsFile(i,e)){if("@vue/runtime-dom"===t)return{isExternalLibraryImport:!0,resolvedFileName:path.join(utsLanguageServiceInterface_1.Global.g_extensionPath,"/builtin-dts/uniappx/node_modules/@vue/runtime-dom/dist/runtime-dom.d.ts"),extension:".d.ts"};if("vue"===t)return{isExternalLibraryImport:!0,resolvedFileName:path.join(utsLanguageServiceInterface_1.UtsPluginLanguageService.Constants.VUE_LIB_ENTRY_FILE_PATH),extension:".d.ts"}}return hx.resolveModuleName(this._info.ts,e,t,i,n,r,s,a,o)}}];this._info.target&&this._info.target!==hx.TargetKind["APP-ANDROID"]||u.unshift(utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.getPlatformModuleNameResolver(types_1.UtsPluginPlatform.APP_ANDROID,this._info));for(let l=0;l<i.length;++l){const c=i[l],_=(0,tsUtils_1.fixTsNodeText)(c.text);for(const t of u){let i={resolvedModule:void 0};if(t.resolveModuleNameLiterals?i=t.resolveModuleNameLiterals(this._info.project,c,n,r,s,a,o):t.resolveModuleName&&(i={resolvedModule:t.resolveModuleName(this._info.project,_,n,s,{fileExists:e.fileExists.bind(e),readFile:e.readFile.bind(e)},void 0,r)}),i.resolvedModule){g[l]=i;break}}if(void 0===g[l].resolvedModule){let e=t([i[l]],n,r,s,a,o?[o[l]]:void 0);g[l]=e[0]}}return g},e.getScriptFileNames=()=>{const t=[...i()];if(e.getCompilationSettings().noCustomResolve)return t;t.push(path.join(this._info.project.sourceRoot,"main.uts"),utsLanguageServiceInterface_1.UtsPluginLanguageService.Constants.DCLOUD_IO_UNI_APP_X_BASE_LIB_PATH_CLIENT_ENTRY_FILE_PATH,utsLanguageServiceInterface_1.UtsPluginLanguageService.Constants.VUE_PUBLIC_TYPES_LIB_FILE_PATH,utsLanguageServiceInterface_1.UtsPluginLanguageService.Constants.SPECIAL_STRING_BASE_LIB_PATH),this._info.target===hx.TargetKind["APP-ANDROID"]&&t.push(...utsLanguageServiceInterface_1.UtsPluginLanguageService.getScriptFileNamesAndFileRefrences(this._info,uni_module_uts_plugin_1.AndroidLanguageService.resolveFileRefrence,i)),t.push(utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.getAppinstanceExtTypeModuleNameResolver(this._info).getVirtualFile());let n=utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.getEasycom(this._info),r=n.getEasycomFile.bind(n);t.push(...utsLanguageServiceInterface_1.UtsPluginLanguageService.getScriptFileNamesAndFileRefrences(this._info,r,i));let s=new Set(t),a=path.join(this._info.project.sourceRoot,"main.js");return s.has(a)&&s.delete(a),[...s]},e.getCompilationSettings=()=>{const e=this,t=n();t.checkExpressionOverride&&(t.checkExpressionOverride=(e,i,n,r)=>{var s;return null!==(s=t.checkExpressionOverride(e,i,n,r))&&void 0!==s?s:this.checkExpression(this._info.project,t,e,i,n,r)});const i=this._info.project;return{...t,strictNullChecks:!0,strictPropertyInitialization:!0,noImplicitOverride:!0,shouldIsTypeRelatedToOverride:!0,isTypeRelatedToOverride:function(t,i,n,r){return e._utsLanguageFeatureTypecheckerPlugin.isTypeRelatedTo(t,i,n,r)},shouldCheckTypeRelatedToOverride:!0,checkTypeRelatedToOverride:function(t,i,n,r,s,a,o,g){o&&!o.errors&&(o.errors=[]);return e._utsLanguageFeatureTypecheckerPlugin.checkTypeRelatedTo(t,i,n,r,s,a,o,g)},resolveModuleNamesReusingOldState:function(e){if(void 0===e)return!1;if(e.resolvedModules&&hx.fileEndsWith(e.fileName,[".d.ts"])&&types_1.UtsPluginPlatform.APP_ANDROID===utsLanguageServiceInterface_1.Global.resolveUtsPlatformByLibFiles(e.fileName,i))return!0;return!1},checkAndReportErrorForUsingTypeAsValue:function(t,i){return e._utsLanguageFeatureTypecheckerPlugin.checkAndReportErrorForUsingTypeAsValue(t,i)},checkAndReportErrorForUsingTypeAsNamespace:function(t,i){return e._utsLanguageFeatureTypecheckerPlugin.checkAndReportErrorForUsingTypeAsNamespace(t,i)},isRelatedToOverride:function(t,i,n,r){return e._utsLanguageFeatureTypecheckerPlugin.isRelatedTo(t,i,n,r)}}}}}exports.ClientLanguageService=ClientLanguageService;
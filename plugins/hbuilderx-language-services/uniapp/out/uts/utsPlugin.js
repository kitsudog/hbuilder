"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.UTSPlugin=void 0;const fs=require("fs"),path=require("path"),hx=require("../../../core"),easycomService=require("../../../vueservice"),vueservice_1=require("../../../vueservice"),unicloudDbTypeCheckerPlugin_1=require("../uniCloud/unicloudDbTypeCheckerPlugin"),ext_typehecker_1=require("./typeCheckerPlugin/ext_typehecker"),uts_language_feature_typecheker_plugin_1=require("./typeCheckerPlugin/uts_language_feature_typecheker_plugin"),vueGlobalPropertiesTypeCheckerPlugin_1=require("./typeCheckerPlugin/vueGlobalPropertiesTypeCheckerPlugin"),types_1=require("./types"),uni_module_uts_plugin_1=require("./uni_module_uts_plugin"),utsClientLanguageService_1=require("./utsClientLanguageService"),utsLanguageServiceInterface_1=require("./utsLanguageServiceInterface"),vueRefs_1=require("./vueRefs"),utsTypeCheckerHelper_1=require("./typeCheckerPlugin/utsTypeCheckerHelper");class UtsPlugin{constructor(){this._utsPluginLanguageSerivcies=new Map,this._uniModulesTypesFiles=new Map,this._vueRefs=new vueRefs_1.VueRefs,utsLanguageServiceInterface_1.Global.registLibFilesPlatformResolver(types_1.UtsPluginPlatform.COMMON,(e=>{const t=path.join(utsLanguageServiceInterface_1.Global.g_extensionPath,"builtin-dts/uts-types/common");return fs.existsSync(t)&&path.relative(e,t).endsWith("..")})),utsLanguageServiceInterface_1.Global.registLibFilesPlatformResolver(types_1.UtsPluginPlatform.APP_ANDROID,uni_module_uts_plugin_1.AndroidLanguageService.systemLibPlatFormResolver),utsLanguageServiceInterface_1.Global.registLibFilesPlatformResolver(types_1.UtsPluginPlatform.APP_IOS,uni_module_uts_plugin_1.IosLanguageService.systemLibPlatFormResolver)}create(e){let t=e.languageService;const i=t.getCompletionsAtPositionAsync.bind(t),n=t.getDefinitionAndBoundSpanAsync.bind(t);return t.getCompletionsAtPositionAsync=async(n,s,r)=>{let o=await i(n,s,r);return o&&(o=utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.getUtsUniModPluginModuleNameResolver(e).filterCompletion(o,t,n,s)),o},t.getDefinitionAndBoundSpanAsync=async(i,s)=>{let r=await n(i,s);return r=utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.getUtsUniModPluginModuleNameResolver(e).fileterDefinition(r,t,i,s),r},t}createLs(e){this.resolveDtsPathFromPackage(e);let t=e.project;if(t&&(t.kind===hx.HXProjectKind.UniApp||t.kind===hx.HXProjectKind.UniApp_Cli)){utsLanguageServiceInterface_1.UtsPluginLanguageService.init(e);const t=utsLanguageServiceInterface_1.Global.getTimeWatcher();t.startCollect("uts plugin create"),this.listenUniMoudlesPackage(e),this.listenUtsPluginLibDir(e),this.overwriteHostApi(e);const i=this.proxyLanguageService(e.languageService,e);return t.endCollect(),i}return e.languageServiceRouter}createTypeCheckerPlugins(e){return[...utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.createUnicloudTypeChecker(e),new unicloudDbTypeCheckerPlugin_1.UnicloudDbTypeCheckerPlugin(e,hx.isUniAppXProject(e.project)?[utsLanguageServiceInterface_1.UtsPluginLanguageService.Constants.UTSJSONObject,!0]:void 0),(0,vueservice_1.createVueThisTypeChecker)(e),new vueGlobalPropertiesTypeCheckerPlugin_1.VueGlobalPropertiesTypeCheckerPlugin(e),new uts_language_feature_typecheker_plugin_1.UtsLanguageFeatureTypeCheckerPlugin(e),new ext_typehecker_1.ExtTypeCheckerPlugin(e),new utsTypeCheckerHelper_1.createTypeofTypeChecker(e)]}createExtService(e){let t=this.createLs(e);return t.isEnabled=t=>hx.isUniAppXProject(e.project)?!!this.isClientUtsLanguageServiceContext(t,e):!!this.getUtsPluginExtLanguageService(t,e)||!!this.getUtsPluginLanugageService(t,e)||!!this.isClientUtsLanguageServiceContext(t,e),t}createPolicies(e){return[new uni_module_uts_plugin_1.UTSPluginCommonPolicy(e),new uni_module_uts_plugin_1.UTSPluginAndroidPolicy(e),new uni_module_uts_plugin_1.UTSPluginIosPolicy(e),new uni_module_uts_plugin_1.UTSPluginWebPolicy(e),new uni_module_uts_plugin_1.UTSPluginAppJsPolicy(e)]}listenUniMoudlesPackage(e){const t=path.join(e.project.sourceRoot,"uni_modules"),i={libs:new Set,version:0};this._uniModulesTypesFiles.set(e.project.sourceRoot,i);const n=e=>{try{if(fs.existsSync(e)){const t=JSON.parse(fs.readFileSync(e).toString());if(t&&t.types){let i=path.resolve(e,"../",t.types);if(fs.existsSync(i))return i}}let t=path.join(e,"../","utssdk","index.d.ts");return fs.existsSync(t)?t:void 0}catch(e){}},s=new Map,r=t=>{if(!s.has(t)){const r=e.ts.sys.watchFile(t,((s,r)=>{if(r===e.ts.FileWatcherEventKind.Created||r===e.ts.FileWatcherEventKind.Changed){let e=n(t);e&&fs.existsSync(e)&&(i.libs.add(e),i.version++)}}),300);s.set(t,r)}};if(fs.existsSync(t)){fs.readdirSync(t).forEach((e=>{const s=path.join(t,e,"package.json");let o=n(s);o&&fs.existsSync(o)&&i.libs.add(o),r(s)}))}e.ts.sys.watchDirectory(t,(e=>{if(fs.existsSync(e)){if(fs.statSync(e).isDirectory()){const t=path.join(e,"package.json");r(t)}}else{const t=path.join(e,"package.json");if(s.has(t)){s.get(t).close(),s.delete(t)}const n=[];i.libs.forEach((t=>{t.startsWith(e)&&(n.push(t),i.libs.delete(t))})),n.length>0&&i.version++}}))}listenUtsPluginLibDir(e){const t=hx.getExtensionRootPath(),i=path.join(t,"builtin-dts");((t,i)=>{const n=new Set,s={libs:n,version:0};utsLanguageServiceInterface_1.Global.registerPlatformApiLibsObject(t,s);const r=e=>{if(fs.existsSync(e)){fs.readdirSync(e).forEach((t=>{t.endsWith(".d.ts")&&n.add(path.join(e,t))}))}},o=path.join(i,"uts-types",t);r(o),e.ts.sys.watchDirectory(o,(e=>{o===e&&r(o),e.endsWith(".d.ts")&&(fs.existsSync(e)?(n.add(path.join(e)),s.version++):(n.delete(e),s.version++))}))})(types_1.UtsPluginPlatform.COMMON,i)}proxyLanguageService(e,t){const i=utsLanguageServiceInterface_1.Global.getTimeWatcher();i.startCollect("uts plugin proxy language service");const n=Object.create(null);for(let t of Object.keys(e)){const i=e[t];n[t]=(...t)=>i.apply(e,t)}const s=this,r=hx.isUniAppXProject(t.project)?new utsClientLanguageService_1.ClientLanguageService(t):void 0;return n.getCompletionsAtPositionAsync=async(i,n,s)=>{const r=utsLanguageServiceInterface_1.Global.getTimeWatcher();r.startCollect("get platform language serviec by fileName");let c=a(i);if(c){let e=await c.getCompletionsAtPositionAsync(i,n,s),r=c.getProgram(),o=null==r?void 0:r.getTypeChecker(),a=null==r?void 0:r.getSourceFile(i);if(a&&e){let s=t.ts.getTokenAtPosition(a,n);if(this._vueRefs.isVueRefs(s,t.ts)){let r=this._vueRefs.getCompletionEntrys(i,n,s,o,t.tsinfo);e.entries=r}}return e}let g=o(i);if(r.endCollect(),g){g.setOriginalLanguageService&&g.setOriginalLanguageService(e);let r=await g.getCompletionsAtPosition(i,n,s);const o=g.getUtsLanguageService?g.getUtsLanguageService():void 0;let a=null==o?void 0:o.getProgram(),c=null==a?void 0:a.getTypeChecker(),u=null==a?void 0:a.getSourceFile(i);if(u&&r){let e=t.ts.getTokenAtPosition(u,n);if(this._vueRefs.isVueRefs(e,t.ts)){let s=this._vueRefs.getCompletionEntrys(i,n,e,c,t.tsinfo);r.entries=s}}return r}return await e.getCompletionsAtPositionAsync(i,n,s)},n.getCompletionEntryDetails=(i,n,s,r,c,g,u)=>{const l=a(i);if(l){let e=l.getCompletionEntryDetails(i,n,s,r,c,g,u);return e=utsLanguageServiceInterface_1.UtsPluginLanguageService.CommonLogic.getCompletionEntryDetails(l,i,n,t.ts,e),e}let f=o(i);if(f){f.setOriginalLanguageService&&f.setOriginalLanguageService(e);const o=f.getUtsLanguageService();let a=f.getCompletionEntryDetails(i,n,s,r,c,g,u);return utsLanguageServiceInterface_1.UtsPluginLanguageService.CommonLogic.getCompletionEntryDetails(o,i,n,t.ts,a)}return e.getCompletionEntryDetails(i,n,s,r,c,g,u)},n.getDefinitionAndBoundSpanAsync=async(i,n)=>{const s=a(i);if(s){let e=await s.getDefinitionAndBoundSpanAsync(i,n),r=s.getProgram(),o=null==r?void 0:r.getSourceFile(i);if(o){let s=t.ts.getTokenAtPosition(o,n);this._vueRefs.isVueRefs(s,t.ts)&&(e=this._vueRefs.getDefinitionInfoAndBoundSpan(i,n,s,t.ts,t.tsinfo))}return e}let r=o(i);if(r){r.setOriginalLanguageService&&r.setOriginalLanguageService(e);let s=await r.getDefinitionAndBoundSpan(i,n);const o=r.getUtsLanguageService?r.getUtsLanguageService():void 0;let a=null==o?void 0:o.getProgram(),c=null==a?void 0:a.getSourceFile(i);if(c){let e=t.ts.getTokenAtPosition(c,n);this._vueRefs.isVueRefs(e,t.ts)&&(s=this._vueRefs.getDefinitionInfoAndBoundSpan(i,n,e,t.ts,t.tsinfo))}return s}return await e.getDefinitionAndBoundSpanAsync(i,n)},n.getQuickInfoAtPositionAsync=async(t,i)=>{const n=a(t);if(n)return n.getQuickInfoAtPositionAsync(t,i);let s=o(t);return s?(s.setOriginalLanguageService&&s.setOriginalLanguageService(e),s.getQuickInfoAtPosition(t,i)):e.getQuickInfoAtPositionAsync(t,i)},n.getSemanticDiagnosticsAsync=async i=>{const n=a(i);if(n){return r(await n.getSemanticDiagnosticsAsync(i))}let s=o(i);if(s){return s.setOriginalLanguageService&&s.setOriginalLanguageService(e),r(await s.getSemanticDiagnosticsAsync(i))}return e.getSemanticDiagnosticsAsync?e.getSemanticDiagnosticsAsync(i):e.getSemanticDiagnostics(i);function r(e){let n=[];return e.forEach((e=>{const s=e.file,r=e.start;if(s&&r){let o=t.ts.getTokenAtPosition(s,r);if(t.ts.isStringLiteralLike(o)&&o.parent&&t.ts.isImportDeclaration(o.parent)){let u=o.text.trim();u.startsWith("@/")&&(u=u.replace("@",t.project.fsPath));let l=path.resolve(path.dirname(i),u);if(fs.existsSync(l))return}if(2345==e.code&&c()){const f=g();if(/Argument of type 'UTSJSONObject/.test(f))return}if(2769===e.code)return;const a="Property 'includes' does not exist on type 'string[]'. Do you need to change your target library? Try changing the 'lib' compiler option to 'es2016' or later.";if(g()===a)return;function c(){if(utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.checkNodeLinkIs(o,[t.ts.isObjectLiteralExpression])){let e=o.parent.parent;for(;e&&t.ts.isParenthesizedExpression(e);)e=e.parent;if(t.ts.isCallExpression(e))return!0}return!1}function g(){let t="";return"string"==typeof e.messageText?t=e.messageText:e.messageText.next&&(t=function e(t){let i=t.messageText;if(t.next)for(let n of t.next)i+=e(n);return i}(e.messageText)),t}}n.push(e)})),n}},n.getSignatureHelpItems=(t,i,n)=>{const s=a(t);if(s)return s.getSignatureHelpItems(t,i,n);let r=o(t);return r?(r.setOriginalLanguageService&&r.setOriginalLanguageService(e),r.getSignatureHelpItems(t,i,n)):e.getSignatureHelpItems(t,i,n)},n.getCodeFixesAtPosition=(i,n,s,r,c,g)=>{const u=a(i);if(u){return u.getCodeFixesAtPosition(i,n,s,r,c,g).filter((e=>{let n=t.project;return![...e.changes].find((e=>[...e.textChanges].find((e=>{let t=/import.*from\s(['"])([^'"]*)\1/g.exec(e.newText);if(t&&t.length>2){let e=path.resolve(path.dirname(i),t[2]);if(utsLanguageServiceInterface_1.Global.resolveUtsPlatformByLibFiles(e,n,!1))return!0}return!1}))))}))}let l=o(i);if(l){l.setOriginalLanguageService&&l.setOriginalLanguageService(e);let o=l.getCodeFixesAtPosition(i,n,s,r,c,g);return o=o.filter((e=>{let n=t.project;return![...e.changes].find((e=>[...e.textChanges].find((e=>{let t=/import.*from\s(['"])([^'"]*)\1/g.exec(e.newText);if(t&&t.length>2){let e=path.resolve(path.dirname(i),t[2]);if(utsLanguageServiceInterface_1.Global.resolveUtsPlatformByLibFiles(e,n,!1))return!0}return!1}))))})),o}return e.getCodeFixesAtPosition(i,n,s,r,c,g)},n.getSuggestionDiagnosticsAsync=async t=>{const i=a(t);if(i)return i.getSuggestionDiagnosticsAsync(t);const n=o(t);return n?n.getSuggestionDiagnosticsAsync(t):e.getSuggestionDiagnosticsAsync?e.getSuggestionDiagnosticsAsync(t):e.getSuggestionDiagnostics(t)},n.getSyntacticDiagnosticsAsync=async t=>{const i=a(t);if(i)return i.getSyntacticDiagnosticsAsync(t);const n=o(t);return n?n.getSyntacticDiagnosticsAsync(t):e.getSyntacticDiagnosticsAsync?e.getSyntacticDiagnosticsAsync(t):e.getSyntacticDiagnostics(t)},n.getCompletionEntrySymbol=(t,i,n,s)=>{const r=a(t);if(r)return r.getCompletionEntrySymbol(t,i,n,s);const c=o(t);return c?c.getCompletionEntrySymbol(t,i,n,s):e.getCompletionEntrySymbol(t,i,n,s)},n.getDefinitionAtPosition=(t,i)=>{const n=a(t);if(n)return n.getDefinitionAtPosition(t,i);const s=o(t);return s?s.getDefinitionAtPosition(t,i):e.getDefinitionAtPosition(t,i)},n.getTypeDefinitionAtPosition=(t,i)=>{const n=a(t);if(n)return n.getTypeDefinitionAtPosition(t,i);const s=o(t);return s?s.getTypeDefinitionAtPosition(t,i):e.getTypeDefinitionAtPosition(t,i)},n.getImplementationAtPosition=(t,i)=>{const n=a(t);if(n)return n.getImplementationAtPosition(t,i);const s=o(t);return s?s.getImplementationAtPosition(t,i):e.getImplementationAtPosition(t,i)},n.getDocumentHighlights=(t,i,n)=>{const s=a(t);if(s)return s.getDocumentHighlights(t,i,n);const r=o(t);return r?r.getDocumentHighlights(t,i,n):e.getDocumentHighlights(t,i,n)},n.findRenameLocations=(t,i,n,s,r)=>{const c=a(t);if(c)return c.findRenameLocations(t,i,n,s,r);return o(t)?void 0:e.findRenameLocations(t,i,n,s,r)},n.getReferencesAtPosition=(t,i)=>{const n=a(t);if(n)return n.getReferencesAtPosition(t,i);const s=o(t);return s?s.getReferencesAtPosition(t,i):e.getReferencesAtPosition(t,i)},n.findReferences=(t,i)=>{const n=a(t);if(n)return n.findReferences(t,i);const s=o(t);return s?s.findReferences(t,i):e.findReferences(t,i)},n.findReferencesAsync=async(t,i)=>{const n=a(t);if(n)return n.findReferencesAsync(t,i);const s=o(t);return s?s.findReferences(t,i):e.findReferences(t,i)},n.getNavigateToItems=(t,i,n,s)=>{const r=n?a(n):void 0;if(r)return r.getNavigateToItems(t,i,n,s);const c=n?o(n):void 0;return c?c.getNavigateToItems(t,i,n,s):e.getNavigateToItems(t,i,n,s)},n.getEmitOutput=(t,i,n)=>{const s=a(t);if(s)return s.getEmitOutput(t,i,n);const r=o(t);return r?r.getEmitOutput(t,i,n):e.getEmitOutput(t,i,n)},n.getSemanticClassifications=function(t,i,n){const s=a(t);if(s)return s.getSemanticClassifications(t,i,n);const r=o(t);return r?r.getSemanticClassifications(t,i,n):e.getSemanticClassifications(t,i,n)},n.getEncodedSemanticClassifications=(t,i,n)=>{const s=a(t);if(s)return s.getEncodedSemanticClassifications(t,i,n);const r=o(t);return r?r.getEncodedSemanticClassifications(t,i,n):e.getEncodedSemanticClassifications(t,i,n)},n.getCombinedCodeFix=(t,i,n,s)=>{const r=a(t.fileName);if(r)return r.getCombinedCodeFix(t,i,n,s);const c=o(t.fileName);return c?c.getCombinedCodeFix(t,i,n,s):e.getCombinedCodeFix(t,i,n,s)},n.organizeImports=(t,i,n)=>{const s=a(t.fileName);if(s)return s.organizeImports(t,i,n);const r=o(t.fileName);return r?r.organizeImports(t,i,n):e.organizeImports(t,i,n)},n.getTodoComments=(t,i)=>{const n=a(t);if(n)return n.getTodoComments(t,i);const s=o(t);return s?s.getTodoComments(t,i):e.getTodoComments(t,i)},n.getRenameInfo=(t,i,n)=>{const s=a(t);if(s)return s.getRenameInfo(t,i,n);const r=o(t);return r?r.getRenameInfo(t,i,n):e.getRenameInfo(t,i,n)},n.getApplicableRefactors=(t,i,n,s,r)=>{const c=a(t);if(c)return c.getApplicableRefactors(t,i,n,s,r);const g=o(t);return g?g.getApplicableRefactors(t,i,n,s,r):e.getApplicableRefactors(t,i,n,s,r)},n.getEditsForRefactor=(t,i,n,s,r,c)=>{const g=a(t);if(g)return g.getEditsForRefactor(t,i,n,s,r,c);const u=o(t);return u?u.getEditsForRefactor(t,i,n,s,r,c):e.getEditsForRefactor(t,i,n,s,r,c)},n.prepareCallHierarchy=(t,i)=>{const n=a(t);if(n)return n.prepareCallHierarchy(t,i);const s=o(t);return s?s.prepareCallHierarchy(t,i):e.prepareCallHierarchy(t,i)},n.provideCallHierarchyIncomingCalls=(t,i)=>{const n=a(t);if(n)return n.provideCallHierarchyIncomingCalls(t,i);const s=o(t);return s?s.provideCallHierarchyIncomingCalls(t,i):e.provideCallHierarchyIncomingCalls(t,i)},n.provideCallHierarchyOutgoingCalls=(t,i)=>{const n=a(t);if(n)return n.provideCallHierarchyOutgoingCalls(t,i);const s=o(t);return s?s.provideCallHierarchyOutgoingCalls(t,i):e.provideCallHierarchyOutgoingCalls(t,i)},n.provideInlayHints=(t,i,n)=>{const s=a(t);if(s)return s.provideInlayHints(t,i,n);const r=o(t);return r?r.provideInlayHints(t,i,n):e.provideInlayHints(t,i,n)},i.endCollect(),n;function o(i){var n;let o=null!==(n=s.getUtsPluginLanugageService(i,t))&&void 0!==n?n:r;if(o)return o.setOriginalLanguageService&&o.setOriginalLanguageService(e),o}function a(e){return s.getUtsPluginExtLanguageService(e,t)}}overwriteHostApi(e){var t,i;const n=e.languageServiceHost,s=null===(t=n.resolveModuleNames)||void 0===t?void 0:t.bind(n),r=n.getScriptFileNames.bind(n),o=null===(i=n.getProjectVersion)||void 0===i?void 0:i.bind(n),a=utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.getEasycom(e);let c=easycomService.onlyCollectEasycoms(e.project),g=utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.getExtApi(e);a.creatVlsEasycom(c,e.project.fsPath),n.resolveModuleNames=(t,i,n,r,o,a)=>{let c=[];t.forEach((()=>c.push(void 0))),s&&(c=s(t,i,n,r,o,a));const g=utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.getUtsUniModPluginModuleNameResolver(e);for(var u=0;u<t.length;u++){let n=t[u];c[u]||(c[u]=g.resolveModuleName(e.project,n,i,o))}return c},n.getScriptFileNames=()=>{let t=r();if(n.getCompilationSettings().noCustomResolve)return t;let i=new Set(t),s=this._uniModulesTypesFiles.get(e.project.sourceRoot);null==s||s.libs.forEach((e=>{i.add(e)}));let o=a.getEasycomFile.bind(a);utsLanguageServiceInterface_1.UtsPluginLanguageService.getScriptFileNamesAndFileRefrences(e,o,r).forEach((e=>{i.add(e)})),i.add(utsLanguageServiceInterface_1.UtsPluginLanguageService.Utils.getAppinstanceExtTypeModuleNameResolver(e).getVirtualFile());let c=null==g?void 0:g.getExportFiles();return null==c||c.forEach((e=>{i.add(e)})),Array.from(i)},n.getProjectVersion=()=>{var t;const i=null===(t=this._uniModulesTypesFiles.get(e.project.sourceRoot))||void 0===t?void 0:t.version;return o?o()+i:"_"+i};const u=e.tsinfo.project,l=u.containsScriptInfo.bind(u);u.containsScriptInfo=t=>{if(l(t))return!0;let i=this.getUtsPluginLanugageService(t.fileName,e);if(i){const e=i.getUtsLanguageService();if(e){const i=e.getProgram();if(i){const e=i.getSourceFileByPath(t.path);return!!e&&e.resolvedPath===t.path}}}return!1}}getUtsPluginLanugageService(e,t){if(hx.isUniAppXProject(t.project))return;let i=utsLanguageServiceInterface_1.Global.resolveUtsPluginPlatform(e,t.project);if(i){let e=this._utsPluginLanguageSerivcies.get(t.project.fsPath);e||(e=new Map,this._utsPluginLanguageSerivcies.set(t.project.fsPath,e));let n=e.get(i);if(n)return n;switch(i){case types_1.UtsPluginPlatform.COMMON:n=new uni_module_uts_plugin_1.CommonLanguageService(t);break;case types_1.UtsPluginPlatform.APP_ANDROID:n=new uni_module_uts_plugin_1.AndroidLanguageService(t);break;case types_1.UtsPluginPlatform.WEB:n=new uni_module_uts_plugin_1.WebLanguageService(t);break;default:n=void 0}return n&&e.set(i,n),n}}getUtsPluginExtLanguageService(e,t){if(hx.isUniAppXProject(t.project))return;let i=utsLanguageServiceInterface_1.Global.resolveUtsPluginPlatform(e,t.project);if(!i)return;const n=t.project.fsPath;return hx.getFileProperty(n,`getUtsPluginExtLanguageService${i}`,(()=>{switch(i){case types_1.UtsPluginPlatform.APP_JS:return new uni_module_uts_plugin_1.UTSPluginAppJsPolicy(t).createLanguageService();case types_1.UtsPluginPlatform.APP_IOS:return new uni_module_uts_plugin_1.UTSPluginIosPolicy(t).createLanguageService()}}))}isClientUtsLanguageServiceContext(e,t){return!(!hx.isUniAppXProject(t.project)||!utsLanguageServiceInterface_1.Global.isClientUtsFile(e,t.project))}resolveDtsPathFromPackage(e){var t;let i=e.tsinfo.session.handlers;i&&!i.has("resolveDtsPathFromPackage")&&(null===(t=e.tsinfo.session)||void 0===t||t.addProtocolHandler("resolveDtsPathFromPackage",(t=>{const{packageName:i}=t.arguments;let n=new uni_module_uts_plugin_1.AndroidLanguageService(e).getAndroidLibFilePathFromPackageName(i,void 0);if(!n){n=new uni_module_uts_plugin_1.IosLanguageService(e).getIosLibFilePathFromPackageName(i,void 0)}return n?{responseRequired:!0,response:{filePath:n}}:{responseRequired:!1,response:{filePath:void 0}}})))}}const utsPlugin=new UtsPlugin,create=utsPlugin.create.bind(utsPlugin),createTypeCheckerPlugins=utsPlugin.createTypeCheckerPlugins.bind(utsPlugin),createExtService=utsPlugin.createExtService.bind(utsPlugin),createPolicies=utsPlugin.createPolicies.bind(utsPlugin);exports.UTSPlugin={create:create,createTypeCheckerPlugins:createTypeCheckerPlugins,createExtService:createExtService,createPolicies:createPolicies},void 0===global.isCustomExternalModuleNameRelative&&(global.isCustomExternalModuleNameRelative=function(e){return e.startsWith("@/")||e.indexOf(".")>0&&uni_module_uts_plugin_1.AndroidLanguageService.isAndroidPackageNameLike(e)});
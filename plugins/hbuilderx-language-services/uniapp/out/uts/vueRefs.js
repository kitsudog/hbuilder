"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.VueRefs=void 0;const core_1=require("../../../core"),vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),vscode_html_languageservice_1=require("../../../packages/vscode-html-languageservice");class VueRefs{constructor(){this.htmlDocumentCache=new Map}getUvuePath(e){if(e){const t=e.split("/"),r=t.pop();let s=null==r?void 0:r.replace(".ts","");const n=t.join("/")+"/"+s;if(n.endsWith(".uvue"))return n}return""}isVueRefs(e,t){return!!(core_1.ts.isStringLiteral(e)&&core_1.ts.isElementAccessExpression(e.parent)&&core_1.ts.isPropertyAccessExpression(e.parent.expression)&&"$refs"===e.parent.expression.name.text&&e.parent.expression.expression.kind===core_1.ts.SyntaxKind.ThisKeyword)||!!(core_1.ts.isStringLiteral(e)&&core_1.ts.isCallExpression(e.parent)&&core_1.ts.isPropertyAccessExpression(e.parent.expression)&&"get"===e.parent.expression.name.text&&core_1.ts.isPropertyAccessExpression(e.parent.expression.expression)&&"$refs"===e.parent.expression.expression.name.text&&e.parent.expression.expression.expression.kind===core_1.ts.SyntaxKind.ThisKeyword)}accept(e,t){if(e(t)&&t.children)for(const r of t.children)this.accept(e,r)}getVueRefs(e,t,r){let s=[],n=r.project.getScriptInfo(e);if(t&&n){let r,i=n.getLatestVersion(),o=this.htmlDocumentCache.get(e);if(o&&o.version===i&&o.htmlDocument)r=o.htmlDocument;else{let s=(0,vscode_html_languageservice_1.getLanguageService)(),n=vscode_languageserver_textdocument_1.TextDocument.create(e,"html",0,t);r=s.parseHTMLDocument(n).roots.find((e=>"template"===e.tag)),r&&this.htmlDocumentCache.set(e,{version:i,htmlDocument:r})}if(!r)return s;this.accept((e=>{if(!e.attributes)return!0;let t=e.attributes.ref;return t&&(t=t.replace(/["']/g,""),s.push({refValue:t,pos:e.start,end:e.end})),!0}),r)}return s}getCompletionEntrys(e,t,r,s,n){var i;let o=this.getUvuePath(e),a=[];if(o&&r){let e=null===(i=n.project.getScriptInfo(o))||void 0===i?void 0:i.getSnapshot(),t=null==e?void 0:e.getText(0,null==e?void 0:e.getLength());this.getVueRefs(o,t,n).forEach((e=>{a.push({name:e.refValue,kind:"string",sortText:e.refValue})}))}return a}getDefinitionInfoAndBoundSpan(e,t,r,s,n){var i;let o,a=this.getUvuePath(e);if(a&&r&&core_1.ts.isStringLiteral(r)){let e=null===(i=n.project.getScriptInfo(a))||void 0===i?void 0:i.getSnapshot(),t=null==e?void 0:e.getText(0,null==e?void 0:e.getLength()),s=this.getVueRefs(a,t,n),c=r.text;s.forEach((e=>{e.refValue===c&&(o={definitions:[{fileName:a,kind:"string",name:e.refValue,containerName:e.refValue,containerKind:"string",textSpan:{start:e.pos,length:e.refValue.length}}],textSpan:{start:r.pos+1,length:r.text.length}})}))}return o}}exports.VueRefs=VueRefs;
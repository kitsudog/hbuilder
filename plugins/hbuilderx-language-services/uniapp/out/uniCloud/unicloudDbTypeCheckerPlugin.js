"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.UnicloudDbTypeCheckerPlugin=void 0;const fs=require("fs"),path=require("path"),core_1=require("../../../core"),specialStringPlugin_1=require("../../../specialStringPlugin");class UnicloudDbTypeCheckerPlugin{constructor(e,t){this.info=e,this._dataTypeText=null!=t?t:["",!0]}checkExpression(e,t,n,i,s,r){var o;const l=i.getText();if(-1!=l.indexOf("__VLS_useCollection")&&-1!=i.parent.parent.getText().indexOf("data:`__VLS_useCollection")){let e;try{let t=l.match(/(?<=__VLS_useCollection\()[\S\s]*((?=\)))/g)[0];e=JSON.parse(t)}catch(e){}if(!e)return;const i=this.processProperties(e),s=this.getSchemeInfo(i[1]),r=this.getVirtualSourceFileText(i,s);let p=this.info.ts.createSourceFile("",r,this.info.ts.ScriptTarget.Latest);n.bindSourceFile(p,t);const a=n.getSymbolOfNode(p);if(a){const e=n.resolveExternalModuleSymbol(a);if(e){const t=null===(o=e.exports)||void 0===o?void 0:o.get("default");if(t)return n.getTypeOfSymbol(t)}}}}setExtDataTypeText(e){this._dataTypeText=e}getExtDataTypeText(){if(this._dataTypeText[0]){let e=[];return e.push(this._dataTypeText[1]?" & ":" | "),e.push(this._dataTypeText[0]),e.join("\n")}return""}processProperties(e){let t=0;let n=!1,i=[],s=[];if(e.getone&&!e.getone.isDynamic&&e.getone.value)try{n=JSON.parse(e.getone.value)}catch(e){}if(e.collection&&!e.collection.isDynamic&&e.collection.value){i=e.collection.value.split(",").filter((e=>""!==e))}if(e.field&&!e.field.isDynamic&&e.field.value){const n=require("../../../lib/jql");if(n&&n.parseField){let i=n.parseField(e.field.value);try{s=function e(n){if(t++,t>100)return t--,[];let i=[];if("Program"===n.type)i=e(n.body[0]);else if("ExpressionStatement"===n.type)i=e(n.expression);else if("SequenceExpression"===n.type)n.expressions.forEach((t=>{i.push(...e(t))}));else if("JQLForeignKeyExpression"===n.type){let t=e(n.table)[0];t.foreign=e(n.fields),i.push(t)}else if("BlockStatement"===n.type)n.body.forEach((t=>{i.push(...e(t))}));else if("JQLAsExpression"===n.type){let e={},t=n.field,s=n.alias;if("Identifier"===t.type&&"Identifier"===s.type)"✖"!==t.name&&"✖"!==s.name&&(e.name=t.name,e.as=s.name);else if("CallExpression"===t.type&&"Identifier"===s.type&&"✖"!==s.name){let n="CallExpression-"+t.callee.name;e.name=n,e.as=s.name}i.push(e)}else"Identifier"===n.type&&i.push({name:n.name});return t--,i}(i)}catch(e){}}}return[n,i,s]}getSchemeInfo(e){function t(e){var t;try{const n=(0,core_1.readFileToString)(e);if(!n)return;const i=JSON.parse(n);function s(e){let t={};for(const n in e)t[n]={name:n,...e[n]};return t}return{name:path.basename(e,".schema.json"),properties:s(null!==(t=i.properties)&&void 0!==t?t:[])}}catch(r){return}}let n=new Map;for(let i=0;i<e.length;++i){let s=e[i],r=n.get(s);function o(e){const n=(0,core_1.getFileProperty)(e,"UnicloudDbGetSchemaInfo",t);n&&(r.properties={...r.properties,...n.properties})}r||(r={name:s,properties:{}},n.set(s,r));for(let p=0;p<specialStringPlugin_1.providers.length;++p){const a=specialStringPlugin_1.providers[p];o(path.join(this.info.project.fsPath,`uniCloud-${a}/database/${s}.schema.json`))}const l=path.join(this.info.project.sourceRoot,"uni_modules");if(fs.existsSync(l)){let u=fs.readdirSync(l);for(let c=0;c<u.length;++c){const f=u[c];o(path.join(l,f,"uniCloud/database",`${s}.schema.json`))}}}return[...n.values()]}getVirtualSourceFileText(e,t){let n=this;function i(e,t){var s;let r=[];if(e.descrtiption&&(r.push("/**"),r.push(` * ${null!==(s=e.descrtiption)&&void 0!==s?s:""}`),r.push(" */")),"object"===e.bsonType){if(r.push(`"${null!=t?t:e.name}": {`),e.properties)for(let t in e.properties){let n=e.properties[t];n.name=t,r.push(i(n))}r.push("\n}"),r.push(n.getExtDataTypeText()),r.push(";")}else"array"===e.bsonType?r.push(`"${null!=t?t:e.name}": Array<${e.arrayType}>;`):r.push(`"${null!=t?t:e.name}": ${e.bsonType};`);return r.join("\n")}function s(e){var r;let o=function(e,n){var i,s,r;if(n)return Object.values(null!==(s=null===(i=t.find((e=>e.name==n)))||void 0===i?void 0:i.properties)&&void 0!==s?s:{}).find((t=>t.name===e));for(let n of t){const t=Object.values(null!==(r=n.properties)&&void 0!==r?r:{}).find((t=>t.name===e));if(t)return t}}(e.name);if(!o)return"";let l=[];if(e.foreign&&e.foreign.length){o.descrtiption&&(l.push("/**"),l.push(` * ${o.descrtiption}`),l.push(" */")),l.push(`"${null!==(r=e.as)&&void 0!==r?r:e.name}": {`);for(let t of e.foreign)l.push(s(t));l.push("}"),l.push(n.getExtDataTypeText()),l.push(";")}else l.push(i(o,e.as));return l.join("\n")}let r="{}";if(e[2].length){let t=["{"];for(const n of e[2])t.push(s(n));t.push("}"),r=t.join("\n")}else{let e=[];for(const n of t){let t=["{"];for(const e in n.properties)"_id"!==e&&t.push(i(n.properties[e]));t.push("}"),e.push(t.join("\n"))}e.length&&(1===e.length?r=e[0]:(e=e.map((e=>`(${e})`)),r=e.join("&")))}r+=this.getExtDataTypeText(),e[0]||(r=`Array<${r}>`);let o=[];return o.push("type bool = boolean;"),o.push("type password = string;"),o.push("type int = number;"),o.push("type double = number;"),o.push("type file = {};"),o.push("type array = Array;"),o.push("type timestamp = number;"),o.push("type date = Date;\n"),o.push(`declare var schema:${r}`),o.push("export default schema;"),o.join("\n")}}exports.UnicloudDbTypeCheckerPlugin=UnicloudDbTypeCheckerPlugin;
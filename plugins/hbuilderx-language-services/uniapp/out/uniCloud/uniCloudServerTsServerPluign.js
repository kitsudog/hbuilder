"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.uniCloud=void 0;const fs=require("fs"),path=require("path"),vscode_uri_1=require("vscode-uri"),hx=require("../../../core"),core_1=require("../../../core"),utils_1=require("../../../utils/"),utils_2=require("./utils"),globalSourceFileCache=new Map;function checkCallExpression(e,t,i,n,o,r,s){var l;if(isUniCloudImportObjectExpression(n.expression,i,core_1.ts)&&n.arguments.length>=1&&core_1.ts.isStringLiteralLike(n.arguments[0])){let o,r=n.arguments[0].text;if((0,utils_1.getAllCloudFunctions)(e.project.fsPath).forEach((e=>{e.name==r&&fs.existsSync(path.join(e.path,"index.obj.js"))&&(o=path.join(e.path,"index.obj.js"))})),o){let n=null===(l=e.languageService.getProgram())||void 0===l?void 0:l.getSourceFile(o);if(!n){let e=hx.readFileToString(o);e&&(globalSourceFileCache.has(e)?n=globalSourceFileCache.get(e):(n=core_1.ts.createSourceFile(o,e,core_1.ts.ScriptTarget.Latest),i.bindSourceFile(n,t),globalSourceFileCache.set(e,n)))}if(n){let e=i.getSymbolOfNode(n);if(e){const t=i.resolveExternalModuleSymbol(e);if(t){const e=i.getTypeOfSymbol(t);return e.__uni_cloud_obj__=!0,e}}}}}}function isUniCloudImportObjectExpression(e,t,i){var n,o;if(e.kind!==core_1.ts.SyntaxKind.PropertyAccessExpression)return!1;let r=e,s=r.expression;if("importObject"!==(null===(n=r.name)||void 0===n?void 0:n.text))return!1;let l=t.getSymbolAtLocation(s);if(l){let e=t.getTypeOfSymbol(l);if("UniCloud"==(null===(o=null==e?void 0:e.symbol)||void 0===o?void 0:o.escapedName))return!0}return!1}function getType(e,t,i,n){let o=i.getSymbolsInScope(t,core_1.ts.SymbolFlags.Type).find((t=>t.escapedName===e));if(o)return i.getDeclaredTypeOfSymbol(o)}function createDocumentProvider(e,t,i,n){if(e&&t)return{get version(){return t.getProjectVersion()},getDefaultLibs:e=>[],compilerOptions:{allowNonTsExtensions:!0,allowJs:!0,lib:["lib.esnext.d.ts"],target:core_1.ts.ScriptTarget.Latest,moduleResolution:core_1.ts.ModuleResolutionKind.Node10,experimentalDecorators:!1,forceConsistentCasingInFileNames:!1,skipLibCheck:!0},get documents(){let n=[...i];return t.getScriptFileNames().forEach((t=>{isUnicloudSource(e,t,core_1.ts)&&n.push(t)})),n},getDocumentSnapshot(e){let i=vscode_uri_1.URI.parse(hx.toNormalizedUri(e,core_1.ts));return t.getScriptSnapshot(i.fsPath)},hasDocument(e){let i=vscode_uri_1.URI.parse(hx.toNormalizedUri(e,core_1.ts));return t.fileExists(i.fsPath)},getDocumentVersion(e){let i=vscode_uri_1.URI.parse(hx.toNormalizedUri(e,core_1.ts));return t.getScriptVersion(i.fsPath)},resolveModuleNameOverride(e,t,i,n,o,r,s,l){let a=(0,core_1.resolveModuleName)(core_1.ts,e,t,i,n,o,r,s,l);if(!a&&isUnicloudSource(e,i,core_1.ts)){let n=hx.toNormalizedPath(i,core_1.ts),o=path.dirname(n),r=10;for(;r>0&&isUnicloudSource(e,o,core_1.ts)&&fs.existsSync(o);){r--;let e=path.join(o,"package.json");if(fs.existsSync(e)){let i=fs.readFileSync(e).toString();try{let e=JSON.parse(i);if(e&&e.dependencies&&e.dependencies[t]){let i=e.dependencies[t];if(i.startsWith("file:")){let e=path.resolve(o,i.substring(5));if(fs.existsSync(path.join(e,"package.json"))){let t=fs.readFileSync(path.join(e,"package.json")).toString(),i=JSON.parse(t);if(i&&i.types){let t=path.resolve(e,i.types);fs.existsSync(t)&&(a={isExternalLibraryImport:!0,resolvedFileName:t})}else if(i&&i.main){a={isExternalLibraryImport:!0,resolvedFileName:path.resolve(e,i.main)}}}}}}catch(e){}break}o=path.dirname(o)}}if(a&&a.isExternalLibraryImport&&isUnicloudSource(e,a.resolvedFileName,core_1.ts))return a}}}function getUnicloudServerLibs(){let e=[],t=hx.getExtensionRootPath();return e.push(...(0,core_1.getNodeLibs)(t,[])),e.push(path.join(t,"builtin-dts","uniapp@vue2","node_modules","@dcloudio","types","uni-cloud-server.d.ts")),e}function isUnicloudSource(e,t,i){if(e.kind!=hx.HXProjectKind.UniApp&&e.kind!=hx.HXProjectKind.UniApp_Cli)return!1;const n=hx.toNormalizedUri(t,core_1.ts);let o=vscode_uri_1.URI.parse(n).fsPath,r=path.relative(e.fsPath.toLowerCase(),o.toLowerCase());r&&(r=hx.toNormalizedPath(r,core_1.ts));let s=hx.fileEndsWith(o,[".jql"]);return/^unicloud-(tcb|aliyun|alipay)\/|^uni_modules\/.*\/unicloud\//.test(r)&&!s}function getExternalFiles(e,t){return!e||e.kind!=hx.HXProjectKind.UniApp&&e.kind!=hx.HXProjectKind.UniApp_Cli?[]:getUnicloudServerLibs()}function create(e){let t=e.project;if(t&&t&&(t.kind==hx.HXProjectKind.UniApp||t.kind==hx.HXProjectKind.UniApp_Cli)){const i=e.languageService,n=Object.create(null);for(let e of Object.keys(i)){const t=i[e];n[e]=(...e)=>t.apply(i,e)}let o=getUnicloudServerLibs();const r=createDocumentProvider(t,e.tsinfo.languageServiceHost,o,e.ts),s=(0,core_1.createLanguageServiceHost)(r,t,e);let l=e.ts.createLanguageService2(e,s,t.documentRegistry);return n.getDefinitionAtPositionAsync=async(n,o)=>isUnicloudSource(t,n,e.ts)?l.getDefinitionAtPosition(n,o):i.getDefinitionAtPositionAsync(n,o),n.getDefinitionAndBoundSpan=(n,o)=>isUnicloudSource(t,n,e.ts)?l.getDefinitionAndBoundSpan(n,o):i.getDefinitionAndBoundSpan(n,o),n.getDefinitionAndBoundSpanAsync=(n,o)=>isUnicloudSource(t,n,e.ts)?l.getDefinitionAndBoundSpanAsync(n,o):i.getDefinitionAndBoundSpanAsync(n,o),n.getTypeDefinitionAtPosition=(n,o)=>isUnicloudSource(t,n,e.ts)?l.getTypeDefinitionAtPosition(n,o):i.getTypeDefinitionAtPosition(n,o),n.getQuickInfoAtPositionAsync=async(n,o)=>isUnicloudSource(t,n,e.ts)?l.getQuickInfoAtPosition(n,o):i.getQuickInfoAtPositionAsync(n,o),n.getSignatureHelpItems=(n,o,r)=>isUnicloudSource(t,n,e.ts)?l.getSignatureHelpItems(n,o,r):i.getSignatureHelpItems(n,o),n.getCompletionEntryDetails=(n,o,r,s,a,c,u)=>isUnicloudSource(t,n,e.ts)?l.getCompletionEntryDetails(n,o,r,s,a,c,u):i.getCompletionEntryDetails(n,o,r,s,a,c,u),n.getCompletionsAtPositionAsync=async(n,o,r)=>isUnicloudSource(t,n,e.ts)?l.getCompletionsAtPositionAsync(n,o,r):i.getCompletionsAtPositionAsync(n,o,r),n}return e.languageService}function createTypeCheckerPlugins(e){let t=e.project;return!t||t.kind!=hx.HXProjectKind.UniApp&&t.kind!=hx.HXProjectKind.UniApp_Cli?[]:[{checkExpression:function(t,i,n,o,r,s){var l,a,c,u;const p=o.kind;if(p!==e.ts.SyntaxKind.Identifier||hx.fileEndsWith(o.getSourceFile().fileName,[".d.ts"])){if(p===e.ts.SyntaxKind.PropertyAccessExpression){if(isUniCloudImportObjectExpression(o,n,e.ts)&&o.parent.kind===e.ts.SyntaxKind.CallExpression){let t=n.defaultCheckExpression(o,r,s),l=n.getSignaturesOfType(t,e.ts.SignatureKind.Call);return l&&l.forEach((t=>{t.resolvedReturnType=checkCallExpression(e,i,n,o.parent,r,e.ts,s)})),t}if(hx.isUniAppXProject(e.project)&&n.defaultCheckExpression(o.expression,r,s).__uni_cloud_obj__){let e=(0,utils_2.getUnicloudObjectaMethodType)();if(e){let t=n.getSignaturesOfType(e,core_1.ts.SignatureKind.Call);if(t.length){const e=()=>{let e;e=o.parent.typeArguments&&o.parent.typeArguments.length?n.getTypeFromTypeNode(o.parent.typeArguments[0]):(0,utils_2.getUTSJSONObject)();let t=(0,utils_2.copyObject)(n.getPromiseType());return t.resolvedTypeArguments=[e],t.typeArguments=[e],[e,t]},[i,l]=e();let a=t[0];a.resolvedReturnType=l,a.resolvedTypePredicate={kind:1,parameterName:"T",parameterIndex:0,type:i};const c=n.defaultCheckExpression(o,r,s);return c.callSignatures=[a],c}}}}else if(p===e.ts.SyntaxKind.CallExpression){return checkCallExpression(e,i,n,o,r,e.ts,s)}}else{let t=o,i=n.getResolvedSymbol(t);if(i&&i.valueDeclaration){let t=i.valueDeclaration;if((null===(l=t.parent)||void 0===l?void 0:l.kind)===e.ts.SyntaxKind.CatchClause&&(null===(c=null===(a=t.parent)||void 0===a?void 0:a.parent)||void 0===c?void 0:c.kind)===e.ts.SyntaxKind.TryStatement){let i=t.parent.parent.tryBlock.statements;if(i&&i.length>0){let t=n.getSymbolsInScope(i[0],core_1.ts.SymbolFlags.Variable);for(let r=0;r<i.length;r++){let s=i[r],l=/(\w+)\.(\w+)\s*\(/.exec(s.getText());if(l){let r=l[1],s=t.find((e=>e.escapedName===r));if(s&&s.valueDeclaration&&s.valueDeclaration.getText().indexOf(".importObject(")>=0){let t=n.getSymbolsInScope(i[0],core_1.ts.SymbolFlags.Namespace).find((e=>"UniCloud"===e.escapedName||"UniCloudNamespace"===e.escapedName));if(!t)return getType("Error",o,n,e.ts);let r=null===(u=t.exports)||void 0===u?void 0:u.get("UniError");if(r)return n.getDeclaredTypeOfSymbol(r)}}}}return getType("Error",o,n,e.ts)}}}},collectCustomModuleReferences(t,i,n){var o,r;let s=[];if(n.isDeclarationFile)return s;for(var l=/uniCloud\.importObject/g;l.exec(n.text);){var a=e.ts.getTokenAtPosition(n,l.lastIndex-1);if(void 0===(null===(o=null==a?void 0:a.parent)||void 0===o?void 0:o.parent)||!e.ts.isPropertyAccessExpression(null==a?void 0:a.parent)||!e.ts.isCallExpression(null===(r=null==a?void 0:a.parent)||void 0===r?void 0:r.parent))continue;const{expression:i,arguments:c}=a.parent.parent;if("uniCloud.importObject"===i.getText(n)&&c.length>0&&e.ts.isStringLiteralLike(c[0])){let i,n=c[0].text;if((0,utils_1.getAllCloudFunctions)(t.fsPath).forEach((e=>{e.name==n&&fs.existsSync(path.join(e.path,"index.obj.js"))&&(i=path.join(e.path,"index.obj.js"))})),i){let t=e.ts.createSourceFile("foo.ts",`import foo from '${i}'`,e.ts.ScriptTarget.Latest,!0);if(t.statements.length>0&&e.ts.isImportDeclaration(t.statements[0])){let i=t.statements[0];e.ts.isStringLiteralLike(i.moduleSpecifier)&&s.push(i.moduleSpecifier)}}}}return s}}]}var uniCloud;!function(e){e.uniCloudPlugin={create:create,getExternalFiles:getExternalFiles,createTypeCheckerPlugins:createTypeCheckerPlugins}}(uniCloud||(exports.uniCloud=uniCloud={}));
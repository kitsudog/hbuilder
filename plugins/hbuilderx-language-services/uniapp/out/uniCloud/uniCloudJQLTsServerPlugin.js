"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.uniCloudJQLTsServerPlugin=void 0;const vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),hx=require("../../../core"),core_1=require("../../../core");let documentVersion=1;const jqlHelperFileName="jql-helper-docs.ts",jqlSuffix="\nvar db = uniCloud.database();";let currentTextDocument=createHelperDocument(void 0),latestVersion="0";function isJql(e){return hx.fileEndsWith(e,[".jql"])}function createHelperDocument(e){let t="";if(e){let n=e.getSnapshot();t=n.getText(0,n.getLength())+jqlSuffix,latestVersion=e.getLatestVersion()}return vscode_languageserver_textdocument_1.TextDocument.create(jqlHelperFileName,"typescript",0,t)}function createDocumentProvider(e,t,n){if(!e||!t)return;return{get version(){return t.getProjectVersion()},compilerOptions:{allowNonTsExtensions:!0,allowJs:!0,lib:["lib.esnext.d.ts"],target:core_1.ts.ScriptTarget.Latest,moduleResolution:core_1.ts.ModuleResolutionKind.Classic,experimentalDecorators:!1},documents:[currentTextDocument.uri],getDocumentSnapshot(e){let t="";return e.indexOf(jqlHelperFileName)>=0&&(t=currentTextDocument.getText()),{getText:(e,n)=>t.substring(e,n),getLength:()=>t.length,getChangeRange:()=>{}}},getDocumentVersion:e=>e.indexOf(jqlHelperFileName)>=0?latestVersion:"1",hasDocument:e=>e.indexOf(jqlHelperFileName)>=0}}function proxyLanguageService(e,t,n,r){const o=Object.create(null);for(let t of Object.keys(e)){const n=e[t];o[t]=(...t)=>n.apply(e,t)}return o.getCompletionsAtPositionAsync=async(t,o,i)=>{if(isJql(t)){let e=r.tsinfo.project.getScriptInfo(t);return currentTextDocument=createHelperDocument(e),n.getCompletionsAtPosition(currentTextDocument.uri,o,i)}return e.getCompletionsAtPositionAsync(t,o,i)},o.getCompletionEntryDetails=(t,o,i,c,u,s,l)=>{if(isJql(t)){let e=r.tsinfo.project.getScriptInfo(t);return currentTextDocument=createHelperDocument(e),n.getCompletionEntryDetails(currentTextDocument.uri,o,i,c,u,s,l)}return e.getCompletionEntryDetails(t,o,i,c,u,s,l)},o.getQuickInfoAtPositionAsync=async(t,o)=>{if(isJql(t)){let e=r.tsinfo.project.getScriptInfo(t);return currentTextDocument=createHelperDocument(e),n.getQuickInfoAtPosition(currentTextDocument.uri,o)}return e.getQuickInfoAtPositionAsync(t,o)},o.getDefinitionAndBoundSpanAsync=async(t,o)=>{if(isJql(t)){let e=r.tsinfo.project.getScriptInfo(t);currentTextDocument=createHelperDocument(e);let i=n.getDefinitionAndBoundSpan(currentTextDocument.uri,o);if(i&&i.definitions&&i.definitions.length>0){let e=i.definitions[0].fileName,t=i.definitions[0].textSpan.start,n=currentTextDocument.positionAt(t);if(currentTextDocument.uri===e&&n.line===currentTextDocument.lineCount-1)return}return i}return e.getDefinitionAndBoundSpanAsync(t,o)},o}function create(e){let t=e.project;if(t&&(t.kind===core_1.HXProjectKind.UniApp||t.kind===core_1.HXProjectKind.UniApp_Cli)){const n=createDocumentProvider(t,e.tsinfo.languageServiceHost,e.ts),r=(0,core_1.createLanguageServiceHost)(n,t,e),o=e.ts.createLanguageService2(e,r,e.ts.createDocumentRegistry(!1,t.fsPath));return proxyLanguageService(e.languageService,t,o,e)}return e.languageService}exports.uniCloudJQLTsServerPlugin={create:create};
"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var s=Object.getOwnPropertyDescriptor(t,n);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,s)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.genConstructorOverloads=exports.generate=exports.getVueLibraryName=exports.getSlotsPropertyName=void 0;const code_gen_1=require("../../../code-gen"),SourceMaps=__importStar(require("../../../source-map")),shared_1=require("@vue/shared"),path=__importStar(require("path")),hx=__importStar(require("../../../../../core"));function getSlotsPropertyName(e){return e<3?"$scopedSlots":"$slots"}function getVueLibraryName(e){return e<2.7?"@vue/runtime-dom":"vue"}function generate(e,t,n,r,s,i,a,o,d,p,u,c,f){const l=hx.tryGetProjectByAnyFileCaseSensitive(t),g=getVueLibraryName(u),x=new code_gen_1.CodeGen,T=[],m={DefinePropsToOptions:!1,mergePropDefaults:!1,ConstructorOverloads:!1};let _,y;return"template"===e&&(c||x.addText("// @ts-nocheck\n")),function(){if(!(null==n?void 0:n.src))return;let t=n.src;t.endsWith(".d.ts")?t=t.substring(0,t.length-".d.ts".length):t.endsWith(".ts")?t=t.substring(0,t.length-".ts".length):t.endsWith(".tsx")&&(t=t.substring(0,t.length-".tsx".length));x.addText("export * from "),x.addCode(`'${t}'`,{start:-1,end:-1},SourceMaps.Mode.Offset,{vueTag:"scriptSrc",capabilities:{basic:"script"===e,references:!0,definitions:"script"===e,rename:!0,diagnostic:"script"===e,completion:"script"===e,semanticTokens:"script"===e}}),x.addText(";\n"),x.addText(`export { default } from '${t}';\n`)}(),function(){if(!r)return;if(!i)return;x.addCode(r.content.substring(0,i.importSectionEndOffset),{start:0,end:i.importSectionEndOffset},SourceMaps.Mode.Offset,{vueTag:"scriptSetup",capabilities:{basic:"script"===e,references:!0,definitions:"script"===e,diagnostic:"script"===e,rename:!0,completion:"script"===e,semanticTokens:"script"===e}})}(),function(){if(!n)return;if(r&&(null==s?void 0:s.exportDefault))S("script",0,s.exportDefault.expression.start),_=x.getText().length-(s.exportDefault.expression.start-s.exportDefault.start);else{let r=!1;if((null==s?void 0:s.exportDefault)&&(r=n.content.substring(s.exportDefault.expression.start,s.exportDefault.expression.end).startsWith("{")),r&&d&&(null==s?void 0:s.exportDefault)){S("script",0,s.exportDefault.expression.start);const r=()=>{const e=Object.values(hx.TargetKind).map((e=>`app.${e}.uvue`.toLowerCase()));return e.push("app.uvue"),!!e.find((e=>!!l&&hx.pathIsPath(t,path.join(l.sourceRoot,e))))};x.addText(`(await import('${g}')).${l&&hx.isUniAppXProject(l)&&r()?"defineApp":"defineComponent"} (`);let i=s.exportDefault.argsNode;if(i)if(0==i.properties.length)S("script",i.pos,i.end);else{x.addText("{");let t=!1,n=!1;i.forEachChild((e=>{if(f.isPropertyAssignment(e)&&f.isIdentifier(e.name)){if("props"===e.name.escapedText&&f.isArrayLiteralExpression(e.initializer)){let t=e.initializer;S("script",e.name.pos,e.name.end),x.addText(":"),x.addText("{"),t.elements.forEach((e=>{f.isStringLiteralLike(e)?(S("script",e.pos,e.end),x.addText(":any")):S("script",e.pos,e.end),x.addText(",")})),x.addText("}")}else S("script",e.pos,e.end);"data"===e.name.escapedText&&(t=!0),"props"===e.name.escapedText&&(n=!0)}else S("script",e.pos,e.end);f.isFunctionLike(e)&&e.name&&f.isIdentifier(e.name)&&"data"===e.name.escapedText&&(t=!0),x.addText(",\n")})),"template"===e&&(t||x.addText("\ndata:()=>{},"),n||x.addText("\nprops:{},")),x.addText("}")}else S("script",s.exportDefault.expression.start,s.exportDefault.expression.end);x.addText(")"),S("script",s.exportDefault.expression.end,n.content.length)}else S("script",0,n.content.length)}}(),function(){var d;if(!r)return;if(!i)return;(null==s?void 0:s.exportDefault)?x.addText("await (async () => {\n"):(_=x.getText().length,x.addText("export default await (async () => {\n"));x.addCode(r.content.substring(i.importSectionEndOffset),{start:i.importSectionEndOffset,end:r.content.length},SourceMaps.Mode.Offset,{vueTag:"scriptSetup",capabilities:{basic:"script"===e,references:!0,definitions:"script"===e,diagnostic:"script"===e,rename:!0,completion:"script"===e,semanticTokens:"script"===e}}),i.propsTypeArg&&(null==i?void 0:i.withDefaultsArg)&&(x.addText("const __VLS_withDefaultsArg = (function <T>(t: T) { return t })("),v("scriptSetup",i.withDefaultsArg.start,i.withDefaultsArg.end),x.addText(");\n"));(null==s?void 0:s.exportDefault)&&s.exportDefault.expression.start!==s.exportDefault.args.start?(x.addText("const __VLS_Component = "),S("script",s.exportDefault.expression.start,s.exportDefault.args.start),x.addText("{\n")):x.addText(`const __VLS_Component = (await import('${g}')).defineComponent({\n`);if(r&&i){p||((i.propsRuntimeArg||i.propsTypeArg)&&(x.addText("props: ("),i.propsTypeArg?(m.DefinePropsToOptions=!0,x.addText("{} as "),i.withDefaultsArg&&(m.mergePropDefaults=!0,x.addText("__VLS_WithDefaults<")),x.addText("__VLS_TypePropsToRuntimeProps<"),v("scriptSetup",i.propsTypeArg.start,i.propsTypeArg.end),x.addText(">"),i.withDefaultsArg&&(x.addText(", typeof __VLS_withDefaultsArg"),x.addText(">"))):i.propsRuntimeArg&&v("scriptSetup",i.propsRuntimeArg.start,i.propsRuntimeArg.end),x.addText("),\n")),i.emitsTypeArg?(m.ConstructorOverloads=!0,x.addText("emits: ({} as __VLS_UnionToIntersection<__VLS_ConstructorOverloads<"),v("scriptSetup",i.emitsTypeArg.start,i.emitsTypeArg.end),x.addText(">>),\n")):i.emitsRuntimeArg&&(x.addText("emits: ("),v("scriptSetup",i.emitsRuntimeArg.start,i.emitsRuntimeArg.end),x.addText("),\n")));const t=[];if(i&&t.push({bindings:i.bindings,content:r.content,vueTag:"scriptSetup"}),s&&n&&t.push({bindings:s.bindings,content:n.content,vueTag:"script"}),x.addText("setup() {\n"),"script"===e){x.addText("() => {\n");for(const e of o())x.addText("// @ts-ignore\n"),x.addText(e+";\n");!function(){const e=a();if(!e)return;let t=[];i&&(t=t.concat(i.bindings.map((e=>{var t;return null!==(t=null==r?void 0:r.content.substring(e.start,e.end))&&void 0!==t?t:""}))));s&&(t=t.concat(s.bindings.map((e=>{var t;return null!==(t=null==n?void 0:n.content.substring(e.start,e.end))&&void 0!==t?t:""}))));x.addText("// @ts-ignore\n"),x.addText("[");for(const n of t)(e.tagNames[n]||e.tagNames[(0,shared_1.hyphenate)(n)])&&x.addText(n+", ");for(const t of Object.keys(e.tagNames))t.indexOf(".")>=0&&x.addText(t+", ");x.addText("];\n"),x.addText("// @ts-ignore\n"),x.addText("["),x.addText([...e.identifiers].join(", ")),x.addText("];\n")}(),x.addText("};\n")}if(x.addText("return {\n"),p&&(i.propsTypeArg?(x.addText("$props: (await import('./__VLS_types')).makeOptional(defineProps<"),v("scriptSetup",i.propsTypeArg.start,i.propsTypeArg.end),x.addText(">()),\n")):i.propsRuntimeArg&&(x.addText("$props: (await import('./__VLS_types')).makeOptional(defineProps("),v("scriptSetup",i.propsRuntimeArg.start,i.propsRuntimeArg.end),x.addText(")),\n")),i.emitsAssignName?x.addText(`$emit: ${i.emitsAssignName},\n`):i.emitsTypeArg?(x.addText("$emit: defineEmits<"),v("scriptSetup",i.emitsTypeArg.start,i.emitsTypeArg.end),x.addText(">(),\n")):i.emitsRuntimeArg&&(x.addText("$emit: defineEmits("),v("scriptSetup",i.emitsRuntimeArg.start,i.emitsRuntimeArg.end),x.addText("),\n"))),"script"===e&&(i.exposeTypeArg?(x.addText("...({} as "),v("scriptSetup",i.exposeTypeArg.start,i.exposeTypeArg.end),x.addText("),\n")):i.exposeRuntimeArg&&(x.addText("...("),v("scriptSetup",i.exposeRuntimeArg.start,i.exposeRuntimeArg.end),x.addText("),\n"))),"template"===e){p&&(i.propsAssignName?x.addText(`...${i.propsAssignName},\n`):i.withDefaultsArg&&i.propsTypeArg?(x.addText("...withDefaults(defineProps<"),v("scriptSetup",i.propsTypeArg.start,i.propsTypeArg.end),x.addText(">(), "),v("scriptSetup",i.withDefaultsArg.start,i.withDefaultsArg.end),x.addText("),\n")):i.propsRuntimeArg&&(x.addText("...defineProps("),v("scriptSetup",i.propsRuntimeArg.start,i.propsRuntimeArg.end),x.addText("),\n")));for(const{bindings:e,content:n}of t)for(const t of e){const e=n.substring(t.start,t.end),r=x.addCode(e,t,SourceMaps.Mode.Offset,{vueTag:"scriptSetup",capabilities:{definitions:!0,references:!0}});x.addText(": ");const s=x.addText(e);x.addText(",\n"),T.push({sourceRange:s,mappedRange:r,mode:SourceMaps.Mode.Offset,data:{toSource:{capabilities:{definitions:!0,references:!0,rename:!0}},toTarget:{capabilities:{definitions:!0,references:!0,rename:!0}}}})}}x.addText("};\n"),x.addText("},\n")}n&&(null===(d=null==s?void 0:s.exportDefault)||void 0===d?void 0:d.args)&&S("script",s.exportDefault.args.start+1,s.exportDefault.args.end-1);x.addText("});\n"),"template"===e?x.addText("return __VLS_Component;\n"):(x.addText(`const __VLS_slots = (await import('./${path.basename(t)}.__VLS_template')).default;\n`),x.addText(`return {} as typeof __VLS_Component & (new () => { ${getSlotsPropertyName(u)}: typeof __VLS_slots });\n`));x.addText("})();"),y=x.getText().length,x.addText("\n")}(),function(){m.DefinePropsToOptions&&(x.addText("type __VLS_NonUndefinedable<T> = T extends undefined ? never : T;\n"),x.addText(`type __VLS_TypePropsToRuntimeProps<T> = { [K in keyof T]-?: {} extends Pick<T, K> ? { type: import('${g}').PropType<__VLS_NonUndefinedable<T[K]>> } : { type: import('${g}').PropType<T[K]>, required: true } };\n`));m.mergePropDefaults&&x.addText("type __VLS_WithDefaults<P, D> = {\n\t\t\t\t// use 'keyof Pick<P, keyof P>' instead of 'keyof P' to keep props jsdoc\n\t\t\t\t[K in keyof Pick<P, keyof P>]: K extends keyof D ? P[K] & {\n\t\t\t\t\tdefault: D[K]\n\t\t\t\t} : P[K]\n\t\t\t};\n");m.ConstructorOverloads&&(x.addText("type __VLS_UnionToIntersection<U> = (U extends unknown ? (arg: U) => unknown : never) extends ((arg: infer P) => unknown) ? P : never;\n"),i&&-1!==i.emitsTypeNums?x.addText(genConstructorOverloads("__VLS_ConstructorOverloads",i.emitsTypeNums)):x.addText(genConstructorOverloads("__VLS_ConstructorOverloads")))}(),function(){if(!n)return;r&&(null==s?void 0:s.exportDefault)&&S("script",s.exportDefault.end,n.content.length)}(),"script"===e&&(n||r?n&&!(null==s?void 0:s.exportDefault)&&x.addText("export default {} as any"):x.addCode("export default {} as any",{start:0,end:0},SourceMaps.Mode.Expand,{vueTag:void 0,capabilities:{}})),"template"===e&&(function(){var e;if(x.addText("\n"),x.addText("export const __VLS_options = {\n"),n&&(null===(e=null==s?void 0:s.exportDefault)||void 0===e?void 0:e.args)){const e=s.exportDefault.args;x.addText("...("),x.addCode(n.content.substring(e.start,e.end),e,SourceMaps.Mode.Offset,{vueTag:"script",capabilities:{references:!0,rename:!0}}),x.addText("),\n")}(null==i?void 0:i.propsRuntimeArg)&&r?(x.addText("props: ("),x.addCode(r.content.substring(i.propsRuntimeArg.start,i.propsRuntimeArg.end),i.propsRuntimeArg,SourceMaps.Mode.Offset,{vueTag:"scriptSetup",capabilities:{references:!0,definitions:!0,rename:!0}}),x.addText("),\n")):(null==i?void 0:i.propsTypeArg)&&r&&(x.addText("props: ({} as "),x.addCode(r.content.substring(i.propsTypeArg.start,i.propsTypeArg.end),i.propsTypeArg,SourceMaps.Mode.Offset,{vueTag:"scriptSetup",capabilities:{references:!0,definitions:!0,rename:!0}}),x.addText("),\n"));(null==i?void 0:i.emitsRuntimeArg)&&r?(x.addText("emits: ("),x.addCode(r.content.substring(i.emitsRuntimeArg.start,i.emitsRuntimeArg.end),i.emitsRuntimeArg,SourceMaps.Mode.Offset,{vueTag:"scriptSetup",capabilities:{references:!0,definitions:!0,rename:!0}}),x.addText("),\n")):(null==i?void 0:i.emitsTypeArg)&&r&&(x.addText("emits: ({} as "),x.addCode(r.content.substring(i.emitsTypeArg.start,i.emitsTypeArg.end),i.emitsTypeArg,SourceMaps.Mode.Offset,{vueTag:"scriptSetup",capabilities:{}}),x.addText("),\n"));x.addText("};\n")}(),function(){var e;if(x.addText("\n"),n&&(null===(e=null==s?void 0:s.exportDefault)||void 0===e?void 0:e.args)){const e=s.exportDefault.args;x.addText("export const __VLS_name = (await import('./__VLS_types')).getNameOption("),x.addText(`${n.content.substring(e.start,e.end)} as const`),x.addText(");\n")}else r?x.addText(`export declare const __VLS_name: '${path.basename(t.substring(0,t.lastIndexOf(".")))}';\n`):x.addText("export const __VLS_name = undefined;\n")}(),function(){const e=[];i&&r&&e.push({typeBindings:i.typeBindings,content:r.content});s&&n&&e.push({typeBindings:s.typeBindings,content:n.content});x.addText("export {\n");for(const t of e)for(const e of t.typeBindings){const n=t.content.substring(e.start,e.end);x.addText(`${n} as __VLS_types_${n},\n`)}x.addText("};\n")}()),"script"===e&&r&&x.addCode("",{start:r.content.length,end:r.content.length},SourceMaps.Mode.Offset,{vueTag:"scriptSetup",capabilities:{}}),r&&void 0!==_&&void 0!==y&&x.addMapping2({data:{vueTag:"scriptSetup",capabilities:{diagnostic:"script"===e}},mode:SourceMaps.Mode.Totally,mappedRange:{start:_,end:y},sourceRange:{start:0,end:r.content.length}}),{codeGen:x,teleports:T};function S(t,s,i){x.addCode(("script"===t?n:r).content.substring(s,i),{start:s,end:i},SourceMaps.Mode.Offset,{vueTag:t,capabilities:{basic:"script"===e,references:!0,definitions:"script"===e,rename:!0,diagnostic:!0,completion:"script"===e,semanticTokens:"script"===e}})}function v(e,t,s){x.addCode(("scriptSetup"===e?r:n).content.substring(t,s),{start:t,end:s},SourceMaps.Mode.Offset,{vueTag:e,capabilities:{references:!0,definitions:!0,rename:!0}})}}function genConstructorOverloads(e="ConstructorOverloads",t){let n=`type ${e}<T> =\n`;if(void 0===t)for(let e=8;e>=1;e--)r(e);else r(t);return n+="// 0\n",n+="{};\n",n;function r(e){n+=`// ${e}\n`,n+="T extends {\n";for(let t=1;t<=e;t++)n+=`(event: infer E${t}, ...payload: infer P${t}): void;\n`;n+="} ? (\n";for(let t=1;t<=e;t++)t>1&&(n+="& "),n+=`(E${t} extends string ? { [K${t} in E${t}]: (...payload: P${t}) => void } : {})\n`;n+=") :\n"}}exports.getSlotsPropertyName=getSlotsPropertyName,exports.getVueLibraryName=getVueLibraryName,exports.generate=generate,exports.genConstructorOverloads=genConstructorOverloads;
"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var a=Object.getOwnPropertyDescriptor(t,s);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,a)}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.useCssVars=exports.useStyleCssClasses=exports.createSourceFile=void 0;const compiler_sfc_1=require("@vue/compiler-sfc"),reactivity_1=require("@vue/reactivity"),vue_code_gen_1=require("../../vue-code-gen"),templateGen=__importStar(require("../../vue-code-gen/out/generators/template")),refSugarRanges_1=require("../../vue-code-gen/out/parsers/refSugarRanges"),scriptRanges_1=require("../../vue-code-gen/out/parsers/scriptRanges"),scriptSetupRanges_1=require("../../vue-code-gen/out/parsers/scriptSetupRanges"),parseCssClassNames_1=require("./utils/parseCssClassNames"),parseCssVars_1=require("./utils/parseCssVars"),sourceMaps_1=require("./utils/sourceMaps"),string_1=require("./utils/string"),untrack_1=require("./utils/untrack"),file_vue_1=__importDefault(require("./plugins/file-vue")),file_html_1=__importDefault(require("./plugins/file-html")),vue_template_html_1=__importDefault(require("./plugins/vue-template-html")),vue_sfc_customblocks_1=__importDefault(require("./plugins/vue-sfc-customblocks")),vue_sfc_styles_1=__importDefault(require("./plugins/vue-sfc-styles")),vue_sfc_template_1=__importDefault(require("./plugins/vue-sfc-template")),vue_typescript_scripts_1=__importDefault(require("./plugins/vue-typescript-scripts")),vue_typescript_template_1=__importDefault(require("./plugins/vue-typescript-template")),source_map_1=require("../../source-map");function createSourceFile(e,t,s,r,a,n=[],u,i){var l;const o=(0,reactivity_1.ref)(""),c=(0,reactivity_1.reactive)({template:null,script:null,scriptSetup:null,styles:[],customBlocks:[],contents:""}),p=(0,reactivity_1.computed)((()=>{var t;for(const s of R){const r=null===(t=s.compileFileToVue)||void 0===t?void 0:t.call(s,e,o.value);if(r)return r}return{vue:"<template></template>",mappings:[]}})),d=(0,reactivity_1.computed)((()=>{var e;return null===(e=p.value)||void 0===e?void 0:e.vue})),f=(0,reactivity_1.computed)((()=>void 0!==d.value?(0,compiler_sfc_1.parse)(d.value,{sourceMap:!1,ignoreEmpty:!1}):void 0)),v=(0,reactivity_1.computed)((()=>{var e;if(c.template)for(const t of R){const s=null===(e=t.compileTemplateToHtml)||void 0===e?void 0:e.call(t,c.template.lang,c.template.content);if(s)return s}})),g=(0,reactivity_1.computed)((()=>{var e;if(v.value)return(0,vue_code_gen_1.compileSFCTemplate)(v.value.html,r.experimentalTemplateCompilerOptions,null!==(e=r.target)&&void 0!==e?e:3)})),m=useStyleCssClasses(c,(e=>!!e.module)),_=useStyleCssClasses(c,(e=>{var t;const r=null!==(t=s.experimentalResolveStyleCssClasses)&&void 0!==t?t:"scoped";return"scoped"===r&&e.scoped||"always"===r})),S=(0,reactivity_1.computed)((()=>{var e,t,s,n,i,l;if(v.value&&(null===(e=g.value)||void 0===e?void 0:e.ast))return templateGen.generate(a,{target:null!==(t=r.target)&&void 0!==t?t:3,experimentalRuntimeMode:r.experimentalRuntimeMode,experimentalAllowTypeNarrowingInInlineHandlers:null!==(s=r.experimentalAllowTypeNarrowingInInlineHandlers)&&void 0!==s&&s,experimentalSuppressInvalidJsxElementTypeErrors:null===(n=r.experimentalSuppressInvalidJsxElementTypeErrors)||void 0===n||n},null!==(l=null===(i=c.template)||void 0===i?void 0:i.lang)&&void 0!==l?l:"html",g.value.ast,!!c.scriptSetup,Object.values(_.value).map((e=>e.classNames)).flat(),v.value.mapping,{getEmitCompletion:string_1.SearchTexts.EmitCompletion,getPropsCompletion:string_1.SearchTexts.PropsCompletion},u)})),y=useCssVars(c),h=(0,reactivity_1.computed)((()=>{const e=[];for(const{style:t,ranges:s}of y.value)for(const r of s)e.push(t.content.substring(r.start,r.end));return e})),T=(0,reactivity_1.computed)((()=>{if(c.script)return a.createSourceFile(e+"."+c.script.lang,c.script.content,a.ScriptTarget.Latest)})),x=(0,reactivity_1.computed)((()=>{if(c.scriptSetup)return a.createSourceFile(e+"."+c.scriptSetup.lang,c.scriptSetup.content,a.ScriptTarget.Latest)})),b=(0,reactivity_1.computed)((()=>T.value?(0,scriptRanges_1.parseScriptRanges)(a,T.value,!!c.scriptSetup,!1,!0):void 0)),E=(0,reactivity_1.computed)((()=>x.value?(0,scriptSetupRanges_1.parseScriptSetupRanges)(a,x.value):void 0)),C=(0,reactivity_1.computed)((()=>c.script||c.scriptSetup?c.scriptSetup&&"js"!==c.scriptSetup.lang?c.scriptSetup.lang:c.script&&"js"!==c.script.lang?c.script.lang:"js":"ts")),k=(0,reactivity_1.computed)((()=>x.value?{refs:(0,refSugarRanges_1.parseRefSugarDeclarationRanges)(a,x.value,["$ref","$computed","$shallowRef","$fromRefs"]),raws:(0,refSugarRanges_1.parseRefSugarCallRanges)(a,x.value,["$raw","$fromRefs"])}:void 0)),R=[...n,(0,file_vue_1.default)(),(0,file_html_1.default)(),(0,vue_template_html_1.default)(),(0,vue_typescript_scripts_1.default)(C,b,E,S,r,h,a),(0,vue_typescript_template_1.default)(a,m,_,S,y,b,E,C,r,!!r.experimentalDisableTemplateSupport||(null!==(l=s.jsx)&&void 0!==l?l:a.JsxEmit.Preserve)!==a.JsxEmit.Preserve,e.endsWith(".html"),i),(0,vue_sfc_styles_1.default)(),(0,vue_sfc_customblocks_1.default)(),(0,vue_sfc_template_1.default)()],O=(0,reactivity_1.computed)((()=>{var e,t;return new source_map_1.SourceMapBase((null!==(t=null===(e=p.value)||void 0===e?void 0:e.mappings)&&void 0!==t?t:[]).map((e=>({data:void 0,mode:source_map_1.Mode.Offset,sourceRange:{start:e.fileOffset,end:e.fileOffset+e.length},mappedRange:{start:e.vueOffset,end:e.vueOffset+e.length}}))))})),w=R.map((t=>{if(t.getEmbeddedFilesCount&&t.getEmbeddedFile){const s=(0,reactivity_1.computed)((()=>t.getEmbeddedFilesCount(e,c))),r=(0,reactivity_1.computed)((()=>{const r=[];for(let a=0;a<s.value;a++){const s=a,n=(0,reactivity_1.computed)((()=>t.getEmbeddedFile(e,c,s))),u=(0,reactivity_1.computed)((()=>{var e,t;if(!n.value)return;const s=[];for(const r of n.value.mappings){const a=j(r.data,r.sourceRange),n=null===(e=O.value.getSourceRange(a.start,a.end))||void 0===e?void 0:e[0];if(n){let e;if(r.additional){e=[];for(const s of r.additional){const a=j(r.data,s.sourceRange),n=null===(t=O.value.getSourceRange(a.start,a.end))||void 0===t?void 0:t[0];n&&e.push({...s,sourceRange:n})}}s.push({...r,sourceRange:n,additional:e})}else if(p.value){const e=p.value.mappings.filter((e=>e.vueOffset>=a.start&&e.vueOffset+e.length<=a.end));for(const t of e){const e={start:t.vueOffset,end:t.vueOffset+t.length},a={start:t.fileOffset,end:t.fileOffset+t.length},n=B(r.data,e);s.push({...r,sourceRange:a,mappedRange:n})}}}const r=new sourceMaps_1.EmbeddedFileSourceMap(s);return{file:n.value,sourceMap:r,teleport:new sourceMaps_1.Teleport(n.value.teleportMappings)}}));r.push(u)}return r}));return r}})).filter(notEmpty),I=(0,reactivity_1.computed)((()=>{if(!(e.endsWith(".vue")||e.endsWith(".nvue")||e.endsWith(".uvue"))&&p.value){const t={fileName:e+".vue",content:p.value.vue,capabilities:{diagnostics:!0,foldingRanges:!1,formatting:!1,documentSymbol:!1,codeActions:!0,inlayHints:!0},isTsHostFile:!1,mappings:p.value.mappings.map((e=>({data:{vueTag:void 0,capabilities:{basic:!0,references:!0,definitions:!0,diagnostic:!0,rename:!0,completion:!0,semanticTokens:!0,referencesCodeLens:!1,displayWithLink:!1}},mode:source_map_1.Mode.Offset,sourceRange:{start:e.fileOffset,end:e.fileOffset+e.length},mappedRange:{start:e.vueOffset,end:e.vueOffset+e.length}})))};return{file:t,sourceMap:new sourceMaps_1.EmbeddedFileSourceMap(t.mappings),teleport:void 0}}})),M=(0,reactivity_1.computed)((()=>{const e=[];I.value&&e.push(I.value);for(const t of w)for(const s of t.value)s.value&&(I.value&&!s.value.file.parentFileName?e.push({...s.value,file:{...s.value.file,parentFileName:I.value.file.fileName}}):e.push(s.value));return e})),q=(0,reactivity_1.computed)((()=>{const e=[];for(const t of M.value)t.teleport&&e.push({file:t.file,teleport:t.teleport});return e})),F=(0,reactivity_1.computed)((()=>{const e=[];let t=[...M.value];for(;t.length;){const e=t.length;if(s(),e===t.length)break}for(const s of t)e.push({self:s,embeddeds:[]});return e;function s(){for(let s=t.length-1;s>=0;s--){const a=t[s];if(a.file.parentFileName){const n=r(a.file.parentFileName,e);n&&(n.embeddeds.push({self:a,embeddeds:[]}),t.splice(s,1))}else e.push({self:a,embeddeds:[]}),t.splice(s,1)}}function r(e,t){var s;for(const a of t){if((null===(s=a.self)||void 0===s?void 0:s.file.fileName)===e)return a;let t=r(e,a.embeddeds);if(t)return t}}}));return D(t),{fileName:e,get text(){return o.value},set text(e){D(e)},getCompiledVue:(0,untrack_1.untrack)((()=>O.value)),getSfcTemplateLanguageCompiled:(0,untrack_1.untrack)((()=>v.value)),getSfcVueTemplateCompiled:(0,untrack_1.untrack)((()=>g.value)),getScriptFileName:(0,untrack_1.untrack)((()=>e.endsWith(".html")?e+".__VLS_script."+C.value:e+"."+C.value)),getDescriptor:(0,untrack_1.untrack)((()=>(0,reactivity_1.unref)(c))),getScriptAst:(0,untrack_1.untrack)((()=>T.value)),getScriptSetupAst:(0,untrack_1.untrack)((()=>x.value)),getSfcRefSugarRanges:(0,untrack_1.untrack)((()=>k.value)),getEmbeddeds:(0,untrack_1.untrack)((()=>F.value)),getScriptSetupRanges:(0,untrack_1.untrack)((()=>E.value)),isJsxMissing:()=>{var e;return!r.experimentalDisableTemplateSupport&&(null!==(e=s.jsx)&&void 0!==e?e:a.JsxEmit.Preserve)!==a.JsxEmit.Preserve},getAllEmbeddeds:()=>M.value,getTeleports:()=>q.value};function j(e,t){var s;if(void 0===d.value)throw"vueContent.value === undefined";if("scriptSrc"===e.vueTag){if(!(null===(s=c.script)||void 0===s?void 0:s.src))throw"!sfc.script?.src";const e=d.value.substring(0,c.script.startTagEnd).lastIndexOf(c.script.src);return{start:e-1,end:e+c.script.src.length+1}}if("script"===e.vueTag){if(!c.script)throw"!sfc.script";return{start:t.start+c.script.startTagEnd,end:t.end+c.script.startTagEnd}}if("scriptSetup"===e.vueTag){if(!c.scriptSetup)throw"!sfc.scriptSetup";return{start:t.start+c.scriptSetup.startTagEnd,end:t.end+c.scriptSetup.startTagEnd}}if("template"===e.vueTag){if(!c.template)throw"!sfc.template";return{start:t.start+c.template.startTagEnd,end:t.end+c.template.startTagEnd}}if("style"===e.vueTag){if(void 0===e.vueTagIndex)throw"data.vueTagIndex === undefined";return{start:t.start+c.styles[e.vueTagIndex].startTagEnd,end:t.end+c.styles[e.vueTagIndex].startTagEnd}}if("customBlock"===e.vueTag){if(void 0===e.vueTagIndex)throw"data.vueTagIndex === undefined";return{start:t.start+c.customBlocks[e.vueTagIndex].startTagEnd,end:t.end+c.customBlocks[e.vueTagIndex].startTagEnd}}return t}function B(e,t){if(void 0===d.value)throw"vueContent.value === undefined";if("script"===e.vueTag){if(!c.script)throw"!sfc.script";return{start:t.start-c.script.startTagEnd,end:t.end-c.script.startTagEnd}}if("scriptSetup"===e.vueTag){if(!c.scriptSetup)throw"!sfc.scriptSetup";return{start:t.start-c.scriptSetup.startTagEnd,end:t.end-c.scriptSetup.startTagEnd}}if("template"===e.vueTag){if(!c.template)throw"!sfc.template";return{start:t.start-c.template.startTagEnd,end:t.end-c.template.startTagEnd}}if("style"===e.vueTag){if(void 0===e.vueTagIndex)throw"data.vueTagIndex === undefined";return{start:t.start-c.styles[e.vueTagIndex].startTagEnd,end:t.end-c.styles[e.vueTagIndex].startTagEnd}}if("customBlock"===e.vueTag){if(void 0===e.vueTagIndex)throw"data.vueTagIndex === undefined";return{start:t.start-c.customBlocks[e.vueTagIndex].startTagEnd,end:t.end-c.customBlocks[e.vueTagIndex].startTagEnd}}return t}function D(t){function s(e,t){for(let s in t)e[s]=t[s]}o.value!==t&&(o.value=t,f.value&&(c.contents=t,function(e){const r=e?{tag:"template",start:t.substring(0,e.loc.start.offset).lastIndexOf("<"),end:e.loc.end.offset+t.substring(e.loc.end.offset).indexOf(">")+1,startTagEnd:e.loc.start.offset,endTagStart:e.loc.end.offset,content:e.content,lang:e.lang||"html"}:null;c.template&&r?s(c.template,r):c.template=r}(f.value.descriptor.template),function(r){const a=r?{tag:"script",start:t.substring(0,r.loc.start.offset).lastIndexOf("<"),end:r.loc.end.offset+t.substring(r.loc.end.offset).indexOf(">")+1,startTagEnd:r.loc.start.offset,endTagStart:r.loc.end.offset,content:r.content,lang:e.endsWith(".uvue")?getValidScriptSyntax("uts"):getValidScriptSyntax(r.lang||"js"),src:r.src}:null;c.script&&a?s(c.script,a):c.script=a}(f.value.descriptor.script),function(r){const a=r?{tag:"scriptSetup",start:t.substring(0,r.loc.start.offset).lastIndexOf("<"),end:r.loc.end.offset+t.substring(r.loc.end.offset).indexOf(">")+1,startTagEnd:r.loc.start.offset,endTagStart:r.loc.end.offset,content:r.content,lang:e.endsWith(".uvue")?getValidScriptSyntax("uts"):getValidScriptSyntax(r.lang||"js")}:null;c.scriptSetup&&a?s(c.scriptSetup,a):c.scriptSetup=a}(f.value.descriptor.scriptSetup),function(e){for(let r=0;r<e.length;r++){const a=e[r],n={tag:"style",start:t.substring(0,a.loc.start.offset).lastIndexOf("<"),end:a.loc.end.offset+t.substring(a.loc.end.offset).indexOf(">")+1,startTagEnd:a.loc.start.offset,endTagStart:a.loc.end.offset,content:a.content,lang:a.lang||"css",module:"string"==typeof a.module?a.module:a.module?"$style":void 0,scoped:!!a.scoped};c.styles.length>r?s(c.styles[r],n):c.styles.push(n)}for(;c.styles.length>e.length;)c.styles.pop()}(f.value.descriptor.styles),function(e){var r;for(let a=0;a<e.length;a++){const n=e[a],u={tag:"customBlock",start:t.substring(0,n.loc.start.offset).lastIndexOf("<"),end:n.loc.end.offset+t.substring(n.loc.end.offset).indexOf(">")+1,startTagEnd:n.loc.start.offset,endTagStart:n.loc.end.offset,content:n.content,lang:null!==(r=n.lang)&&void 0!==r?r:"txt",type:n.type};c.customBlocks.length>a?s(c.customBlocks[a],u):c.customBlocks.push(u)}for(;c.customBlocks.length>e.length;)c.customBlocks.pop()}(f.value.descriptor.customBlocks)))}}function useStyleCssClasses(e,t){return(0,reactivity_1.computed)((()=>{const s=[];for(let r=0;r<e.styles.length;r++){const a=e.styles[r];if(t(a)){const e=[...(0,parseCssClassNames_1.parseCssClassNames)(a.content)];s.push({style:a,index:r,classNameRanges:e,classNames:e.map((e=>a.content.substring(e.start+1,e.end)))})}}return s}))}function useCssVars(e){return(0,reactivity_1.computed)((()=>{const t=[];for(let s=0;s<e.styles.length;s++){const r=e.styles[s];t.push({style:r,styleIndex:s,ranges:[...(0,parseCssVars_1.parseCssVars)(r.content)]})}return t}))}exports.createSourceFile=createSourceFile,exports.useStyleCssClasses=useStyleCssClasses,exports.useCssVars=useCssVars;const validScriptSyntaxs=["js","jsx","ts","tsx"],validScriptSyntaxsMap=new Map;function getValidScriptSyntax(e){return validScriptSyntaxs.includes(e)?e:validScriptSyntaxsMap.has(e)?validScriptSyntaxsMap.get(e):"js"}function notEmpty(e){return null!=e}validScriptSyntaxsMap.set("uts","ts");
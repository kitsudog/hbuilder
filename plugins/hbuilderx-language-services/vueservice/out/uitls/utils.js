"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,i){void 0===i&&(i=o);var r=Object.getOwnPropertyDescriptor(t,o);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,i,r)}:function(e,t,o,i){void 0===i&&(i=o),e[i]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getExportDefaultPropertiesSymbol=exports.getPropertiesNode=exports.fixTsNodeText=exports.getExportDefaultPropertiesNode=exports.virtualToRealityFromRange=exports.getModeAtEmbeddedFile=exports.initializeMode=exports.getModeLang=void 0;const path=__importStar(require("path")),core_1=require("../../../core");function virtualToRealityFromRange(e,t){let o;if(!t)return o;let i=e.getSourceRange(t.start,t.start+t.length);return i||(i=e.getSourceRange(t.start),i&&(i[0].end=i[0].start+t.length)),i?(o={start:i[0].start,length:i[0].end-i[0].start},o):o}function getModeLang(e){let t;switch(path.extname(e)){case".html":t="html";break;case".css":case".scss":case".less":case".stylus":t="style";break;case".js":case".jsx":case".ts":case".tsx":t="javascript"}return t}function getModeAtEmbeddedFile(e,t){let o=getModeLang(t);if(o)return e.get(o)}function initializeMode(e,t,o,i,r,s,n,a){if(!e.tsinfo.project.getScriptInfo(i))return;let c=t.getUpToDateInfo(i);if(!c)return;let l=c.sourceFile.getAllEmbeddeds();for(var p=0;p<l.length;p++){const e=l[p].sourceMap,t=l[p].file;if(!t)continue;if(a){const e=t.capabilities[s];if(!e&&!1===e)continue}const i=e.getMappedRange(r);if(!i)continue;if(i[1].capabilities[n]){const r=getModeAtEmbeddedFile(o,t.fileName);if(!r)continue;return{eFile:t,mode:r,mappedRange:i,sourceMap:e}}}}function getExportDefaultPropertiesNode(e,t,o,i){var r;const s=new Map,n=e.getSymbolAtLocation(t);if(n){const e=null===(r=n.exports)||void 0===r?void 0:r.get("default");if(e&&e.valueDeclaration&&core_1.ts.isExportAssignment(e.valueDeclaration)){const t=e.valueDeclaration,o=t.expression&&core_1.ts.isCallExpression(t.expression)?t.expression:void 0;if(o){const e=o.arguments.length>0?o.arguments[0]:void 0;if(e&&core_1.ts.isObjectLiteralExpression(e)){e.properties.forEach((e=>{if(core_1.ts.isMethodDeclaration(e)){const t=e;i.includes(t.name.escapedText)&&s.set(t.name.escapedText,e)}else if(core_1.ts.isPropertyAssignment(e)){const t=e;i.includes(t.name.escapedText)&&s.set(t.name.escapedText,e)}}))}}}}return s}function getDefineAsyncCompoent(e){let t;if(e&&core_1.ts.isAwaitExpression(e)){let o=e.expression&&e.expression,i=o&&o.expression,r=i&&i.expression,s=(r&&r.body).statements;s&&s.forEach((e=>{if(core_1.ts.isVariableStatement(e)){let o=e.declarationList;if(o){let e=o.declarations[0];"__VLS_Component"===e.name.getText()&&e.initializer&&core_1.ts.isCallExpression(e.initializer)&&(t=e.initializer)}}}))}return t}function getExportDefaultPropertiesSymbol(e,t,o,i){var r;const s=new Map,n=e.getSymbolAtLocation(t);if(n){const t=null===(r=n.exports)||void 0===r?void 0:r.get("default");if(t&&t.valueDeclaration&&core_1.ts.isExportAssignment(t.valueDeclaration)){const o=t.valueDeclaration;let i;if(o&&core_1.ts.isAwaitExpression(o.expression)?i=getDefineAsyncCompoent(o.expression):o&&core_1.ts.isCallExpression(o.expression)&&(i=o.expression),i){const t=i.arguments.length>0?i.arguments[0]:void 0;if(t){e.getTypeAtLocation(t).getProperties().forEach((e=>{e.declarations&&e.declarations.length>0&&s.set(e.escapedName,e)}))}}}}return s}function getPropertiesNode(e,t,o){const i=new Map;if(e&&core_1.ts.isObjectLiteralExpression(e)){e.properties.forEach((e=>{if(core_1.ts.isMethodDeclaration(e)){const t=e;o.includes(t.name.escapedText)&&i.set(t.name.escapedText,e)}else if(core_1.ts.isPropertyAssignment(e)){const t=e;o.includes(t.name.escapedText)&&i.set(t.name.escapedText,e)}}))}return i}function fixTsNodeText(e){let t=e.trim();return(t.startsWith('"')&&t.endsWith('"')||t.startsWith("'")&&t.endsWith("'"))&&(t=t.slice(1,-1)),t}exports.virtualToRealityFromRange=virtualToRealityFromRange,exports.getModeLang=getModeLang,exports.getModeAtEmbeddedFile=getModeAtEmbeddedFile,exports.initializeMode=initializeMode,exports.getExportDefaultPropertiesNode=getExportDefaultPropertiesNode,exports.getExportDefaultPropertiesSymbol=getExportDefaultPropertiesSymbol,exports.getPropertiesNode=getPropertiesNode,exports.fixTsNodeText=fixTsNodeText;
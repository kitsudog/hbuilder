"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.VueTagEmbedMode=void 0;const vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),vscode_uri_1=require("vscode-uri"),core_1=require("../../../core");class VueTagEmbedMode{constructor(e,t,n,i){this.info=e,this.vueCachesInProjectScope=t,this.htmlLanguageService=n,this.vueDataProviders=i}initialize(e,t){const n=this.vueCachesInProjectScope.getEmbeddedFile(e);if(!n)return;const i=n.file;if(!i)return;const o=i.fileName.endsWith(".nvue.html")?"nvue":"vue",r=vscode_languageserver_textdocument_1.TextDocument.create(i.fileName,o,0,i.content),s=this.htmlLanguageService.parseHTMLDocument(r),c=r.positionAt(t);return{document:r,htmlDocument:s,lineColumn:c}}async getCompletionsAtPositionAsync(e,t,n,i){const o=this.initialize(t,n);if(!o)return;const r=this.info,s=this.htmlLanguageService,c=o.document,a=o.htmlDocument,u=o.lineColumn;let l=await s.doCompleteAsync(c,u,a);l=(0,core_1.getDeduplicationData)(l);return(0,core_1.fromLspCompletions)(l,c,r.ts)}getCompletionEntryDetails(e,t,n,i,o,r,s,c){if(!r)return;const a=this.initialize(t,n);if(!a)return;this.info;const u=this.htmlLanguageService,l=a.document,m=a.htmlDocument,h=a.lineColumn,f=vscode_uri_1.URI.parse(r).query;let g={};try{g=JSON.parse(f)}catch(e){console.error("Error:"+e),console.error("Data:"+f)}const d={label:i,...g},v=u.doResolve(d,l,h,m),p=(0,core_1.fromLspCompletionDetail)(v,l,this.info.ts);return p||void 0}async getQuickInfoAtPositionAsync(e,t,n){const i=this.initialize(t,n);if(!i)return;this.info;const o=this.htmlLanguageService,r=i.document,s=i.htmlDocument,c=i.lineColumn,a=o.doHover(r,c,s);return(0,core_1.fromLspHover)(a,r,this.info.ts)}getSignatureHelpItems(e,t,n,i){}async getDefinitionAndBoundSpanAsync(e,t,n,i){const o=this.initialize(t,i);if(!o)return;const r=this.info,s=this.htmlLanguageService,c=o.document,a=(o.htmlDocument,o.lineColumn),u=this.vueCachesInProjectScope.getUpToDateInfo(n);if(!u)return;const l=u.toLspDocument(),m=this.htmlLanguageService.parseHTMLDocument(l),h=await s.findDefinitionAsync(l,a,m);return(0,core_1.fromLspDefinition)(h,c,r,void 0)}getNavigationTree(e,t){const n=this.initialize(t,0);if(!n)return;this.info;const i=this.htmlLanguageService,o=n.document,r=n.htmlDocument,s=(n.lineColumn,i.findDocumentSymbols(o,r));return(0,core_1.fromLspNavigation)(s,o,this.info.ts,!0)}async findReferencesAsync(e,t,n,i){const o=this.initialize(t,i);if(!o)return;this.info;const r=this.htmlLanguageService,s=(o.document,o.htmlDocument),c=o.lineColumn,a=this.vueCachesInProjectScope.getUpToDateInfo(n);if(!a)return;const u=await r.tsFindReferencesAsync(a.toLspDocument(),c,s);return(0,core_1.fromLspReferences)(this.info,u)}async getFileReferencesAsync(e){return[]}async getSyntacticDiagnosticsAsync(e,t){if(!(0,core_1.isUniAppXProject)(this.info.project))return[];const n=this.initialize(e,0);if(!n)return[];const i=this.htmlLanguageService,o=n.document,r=n.htmlDocument;if(!(0,core_1.getConfigurationValue)(this.info.tsinfo.project.projectService.getHostPreferences(),"vue.validate.enable",!0))return[];core_1.SyntacticDiagnosticsTool.createInstance(this.info,t);let s=await i.doValidation(o,r);return(0,core_1.fromLspDiagnosticWithLocation)(s,o)||[]}}exports.VueTagEmbedMode=VueTagEmbedMode;
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.VueScriptEmbedMode=void 0;const core_1=require("../../../core"),scriptEmbedHandle_1=require("./scriptEmbedHandle"),path_1=require("path");class VueScriptEmbedMode{constructor(e,t){this.info=e,this.vueCachesInProjectScope=t,this.tsVueExtraCompletionHandle=new scriptEmbedHandle_1.VueScriptEmbedHandler(e,t)}initialize(e){let t=this.vueCachesInProjectScope.getEmbeddedFile(e);if(!t)return;let i=t.file;if(!i)return;if(!i.isTsHostFile)return;return{eFile:i}}async getCompletionsAtPositionAsync(e,t,i,n){const o=this.initialize(t);if(!o)return;const r=o.eFile;let s=await e.getCompletionsAtPositionAsync(r.fileName,i,n);return s=this.tsVueExtraCompletionHandle.doExtraCompletion(s,e,t,i,n),s&&(s.entries=s.entries.filter((e=>-1===e.name.indexOf("__VLS_")))),s}getCompletionEntryDetails(e,t,i,n,o,r,s,a){const l=this.initialize(t);if(!l)return;const c=l.eFile,u=e.getProgram();if(!u)return;const d=u.getSourceFile(c.fileName);if(!d)return;const f=u.getTypeChecker(),m=this.info.ts.getTokenAtPosition(d,i-1);if("vls_completion"===r){const e=f.getSymbolsInScope(m,core_1.ts.SymbolFlags.Variable);if(!e)return;const t=e.find((e=>e.escapedName===n));if(!t)return;const o=this.info.ts.getTouchingPropertyName(d,i-1),{displayParts:r,documentation:s,symbolKind:a,tags:l}=this.info.ts.SymbolDisplay.getSymbolDisplayPartsDocumentationAndSymbolKind(f,t,d,o,o,7);return this.info.ts.Completions.createCompletionDetails(t.name,this.info.ts.SymbolDisplay.getSymbolModifiers(f,t),a,r,s,l,void 0,void 0)}return e.getCompletionEntryDetails(t,i,n,o,r,s,a)}async getQuickInfoAtPositionAsync(e,t,i){const n=this.initialize(t);if(!n)return;const o=n.eFile;return e.getQuickInfoAtPositionAsync(o.fileName,i)}getSignatureHelpItems(e,t,i,n){const o=this.initialize(t);if(!o)return;const r=o.eFile;return e.getSignatureHelpItems(r.fileName,i,n)}async getDefinitionAndBoundSpanAsync(e,t,i,n){var o,r,s;const a=this.initialize(t);if(!a)return;const l=a.eFile;let c=null===(o=e.getProgram())||void 0===o?void 0:o.getSourceFile(l.fileName);if(c){let t=this.info.ts.getTokenAtPosition(c,n);if(t&&(null===(r=t.parent)||void 0===r?void 0:r.kind)===this.info.ts.SyntaxKind.PropertyAccessExpression&&"this"===t.parent.expression.getText()&&t===t.parent.name&&t.parent===t.parent.parent.left){let i=e.getProgram().getTypeChecker().getSymbolAtLocation(t.parent);i&&i.syntheticOrigin&&(i=i.syntheticOrigin);let n=(null==i?void 0:i.valueDeclaration)||(null===(s=null==i?void 0:i.declarations)||void 0===s?void 0:s.shift());if(n)return{textSpan:this.info.ts.createTextSpan(t.getStart(),t.getEnd()-t.getStart()),definitions:[{fileName:n.getSourceFile().fileName,textSpan:this.info.ts.createTextSpan(n.getStart(),n.getEnd()-n.getStart()),kind:this.info.ts.ScriptElementKind.memberVariableElement,name:i.name,containerKind:void 0,containerName:"",contextSpan:void 0}]}}}return e.getDefinitionAndBoundSpanAsync(l.fileName,n)}getNavigationTree(e,t){const i=this.initialize(t);if(!i)return;const n=i.eFile;return e.getNavigationTree(n.fileName)}async findReferencesAsync(e,t,i,n){const o=this.initialize(t);if(!o)return;const r=o.eFile;return e.findReferencesAsync(r.fileName,n)}async getFileReferencesAsync(e){return[]}async getSyntacticDiagnosticsAsync(e){let t=await this.info.languageServiceRouter.getSyntacticDiagnosticsAsync(e);return t.forEach((t=>{t.source=(0,path_1.extname)(e)})),t}}exports.VueScriptEmbedMode=VueScriptEmbedMode;
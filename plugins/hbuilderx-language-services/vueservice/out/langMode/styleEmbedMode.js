"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.VueStyleEmbedMode=void 0;const vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),vscode_uri_1=require("vscode-uri"),core_1=require("../../../core"),server_1=require("../../../stylusservice/server"),cssLanguageService_1=require("../../../packages/vscode-css-languageservice/out/cssLanguageService");function getLanguage(e){return e.endsWith(".css")||e.endsWith(".wxss")||e.endsWith(".acss")||e.endsWith(".ttss")||e.endsWith(".qss")||e.endsWith(".nss")?"css":e.endsWith(".scss")||e.endsWith(".sass")?"scss":e.endsWith(".less")||e.endsWith(".less.erb")?"less":e.endsWith(".stylus")?"stylus":""}class VueStyleEmbedMode{constructor(e,t,s){this.info=e,this.vueCachesInProjectScope=t,this.styleLanguageServiceList=s}initialize(e,t){const s=this.vueCachesInProjectScope.getEmbeddedFile(e);if(!s)return;const n=s.file;if(!n)return;const i=getLanguage(e),o=vscode_languageserver_textdocument_1.TextDocument.create(n.fileName,i,0,n.content),r=o.positionAt(t),c=this.styleLanguageServiceList.get(i);if(!c)return;return{id:i,document:o,stylesheet:c.parseStylesheet(o),lineColumn:r,languageServer:c}}stylus(e,t){let s={isIncomplete:!1,items:[]};const n=this.vueCachesInProjectScope.getEmbeddedFile(e);if(!n)return;const i=n.file;if(!i)return;const o=(new server_1.ExposedStylusServer).getLanguageServiceExt(),r=vscode_languageserver_textdocument_1.TextDocument.create(i.fileName,"stylus",0,i.content),c=r.positionAt(t);return o&&o.doCompleteSync&&(s=o.doCompleteSync(r,c)),{result:s,document:r}}async getCompletionsAtPositionAsync(e,t,s,n){let i={isIncomplete:!1,items:[]};if("stylus"===getLanguage(t)){const e=this.stylus(t,s);if(!e)return;return(0,core_1.fromLspCompletions)(e.result,e.document,this.info.ts)}const o=this.initialize(t,s);if(!o)return;const r=this.info,c=o.document,u=o.stylesheet,a=o.lineColumn,l=o.languageServer;i=await l.doCompleteAsync(c,a,u);return(0,core_1.fromLspCompletions)(i,c,r.ts)}getCompletionEntryDetails(e,t,s,n,i,o,r,c){if(!o)return;const u=this.initialize(t,s);if(!u)return;const a=this.info,l=u.document,g=u.stylesheet,d=u.lineColumn,f=u.languageServer,h=vscode_uri_1.URI.parse(o).query,m={label:n,...JSON.parse(h)},y=f.doResolve(m,l,d,g);return(0,core_1.fromLspCompletionDetail)(y,l,a.ts)}async getQuickInfoAtPositionAsync(e,t,s){const n=this.initialize(t,s);if(!n)return;const i=this.info,o=n.document,r=n.stylesheet,c=n.lineColumn,u=n.languageServer.doHover(o,c,r);return(0,core_1.fromLspHover)(u,o,i.ts)}async getDefinitionAndBoundSpanAsync(e,t,s,n){const i=this.initialize(t,n);if(!i)return;const o=this.info,r=i.document,c=i.stylesheet,u=i.lineColumn,a=i.languageServer;if(!this.vueCachesInProjectScope.getUpToDateInfo(s))return;const l=await a.tsFindDefinitionAsync(r,u,c);if(!l)return;const g=(0,core_1.getContextData)(r,n,void 0);l.forEach((e=>{e.originSelectionRange=g.contextRange}));return(0,core_1.fromLspDefinition)(l,r,o,void 0)}getSignatureHelpItems(e,t,s,n){}getNavigationTree(e,t){const s=this.initialize(t,0);if(!s)return;this.info;const n=s.document,i=s.stylesheet,o=(s.lineColumn,s.languageServer.findDocumentSymbols(n,i));return(0,core_1.fromLspNavigation)(o,n,this.info.ts,!1)}async findReferencesAsync(e,t,s,n){const i=this.initialize(t,n);if(!i)return;this.info;const o=i.document,r=i.stylesheet,c=i.lineColumn,u=i.languageServer;if(!this.vueCachesInProjectScope.getUpToDateInfo(s))return;const a=await u.tsFindReferencesAsync(o,c,r);return(0,core_1.fromLspReferences)(this.info,a)}async getFileReferencesAsync(e){return[]}async getSyntacticDiagnosticsAsync(e){if(!(0,core_1.isUniAppXProject)(this.info.project))return[];let t=this.initialize(e,0);if(!t)return[];const s=t.document,n=t.stylesheet,i=t.languageServer;return await(0,cssLanguageService_1.getStyleSyntacticDiagnostics)(this.info,s,n,i,e)}}exports.VueStyleEmbedMode=VueStyleEmbedMode;
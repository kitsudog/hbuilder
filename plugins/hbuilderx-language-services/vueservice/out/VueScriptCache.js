"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i);var s=Object.getOwnPropertyDescriptor(t,i);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,r,s)}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getScriptKind=exports.VueScriptCache=exports.VueEmbedsCacheInfo=void 0;const vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),vscode_uri_1=require("vscode-uri"),core_1=require("../../core"),volar=__importStar(require("../packages/vue-typescript")),nativeTags_1=require("./nativeTags");class VueEmbedsCacheInfo{constructor(e,t,i){this._version=t,this._vueSourceFile=e,this._tsImpl=i,this._scriptSnapshot=void 0,this._lspDocument=vscode_languageserver_textdocument_1.TextDocument.create(vscode_uri_1.URI.file(e.fileName).toString(),"vue",0,e.text),this._embedFiles=new Map;let r=this.sourceFile.getAllEmbeddeds();for(var s=0;s<r.length;s++){let e=r[s].file,t=(0,core_1.toNormalizedPath)(e.fileName,i);this._embedFiles.set(t.toLowerCase(),r[s])}this._vueVersion=2}get sourceFile(){return this._vueSourceFile}getEmbedFile(e){let t=(0,core_1.toNormalizedPath)(e,this._tsImpl);if(t=t.toLowerCase(),this._embedFiles.has(t))return this._embedFiles.get(t)}toLspDocument(){return this._lspDocument}get scriptLanguageId(){var e,t;let i=null===(t=null===(e=this.sourceFile.getDescriptor())||void 0===e?void 0:e.script)||void 0===t?void 0:t.lang;return i||"js"}get version(){return this._version}get vueVersion(){return this._vueVersion}set vueVersion(e){this._vueVersion=e}}function getScriptKind(e,t){let i=t.ScriptKind.JS;if(e)switch(e=e.toLowerCase()){case"jsx":i=t.ScriptKind.JSX;break;case"ts":i=t.ScriptKind.TS;break;case"tsx":i=t.ScriptKind.TSX}return i}exports.VueEmbedsCacheInfo=VueEmbedsCacheInfo,exports.getScriptKind=getScriptKind;const globalVueEmbedCache=new Map;class VueScriptCache{constructor(e,t){this.info=t,this.tsImpl=t.ts,this.tsServerHost=e,this.project=t.project,this.cacheFiles=new Set}get allSourceFiles(){let e=[];for(let t of this.cacheFiles){let i=globalVueEmbedCache.get(t);i&&e.push(null==i?void 0:i.sourceFile)}return e}getEmbeddedFileInfo(e){if(this.cacheFiles.size>0)for(let t of this.cacheFiles){let i=globalVueEmbedCache.get(t),r=null==i?void 0:i.getEmbedFile(e);if(r)return{file:r,host:i.sourceFile}}}getEmbeddedFile(e){let t=this.getEmbeddedFileInfo(e);if(t)return t.file}hasEmbeddedFile(e){return!!this.getEmbeddedFile(e)}getScriptVersion(e){for(let t of this.cacheFiles){let i=globalVueEmbedCache.get(t);if(null==i?void 0:i.getEmbedFile(e))return i.version}return this.tsServerHost.getScriptVersion(e)}getScriptKind(e){let t=this.getUpToDateInfo(e);return t?getScriptKind(t.scriptLanguageId,this.tsImpl):this.tsImpl.ScriptKind.Unknown}deleteCache(e){var t;const i=null!==(t=(0,core_1.noTsToNormalizedPath)(e))&&void 0!==t?t:e;this.cacheFiles.delete(i);let r=globalVueEmbedCache.get(i);if(r){let e=r.sourceFile.getAllEmbeddeds();null==e||e.forEach((e=>{let t=this.tsImpl.server.toNormalizedPath(e.file.fileName),i=this.info.tsinfo.project.projectService.getScriptInfo(t);i&&i.detachFromProject(this.info.tsinfo.project)})),globalVueEmbedCache.delete(i)}}getUpToDateInfo(e){var t;const i=null!==(t=(0,core_1.noTsToNormalizedPath)(e))&&void 0!==t?t:e;this.cacheFiles.has(i)||this.cacheFiles.add(i);const r=globalVueEmbedCache.get(i),s=this.tsServerHost.getScriptVersion(i),o=(0,core_1.vueVersion)(this.project);if((null==r?void 0:r.version)===s&&(null==r?void 0:r.vueVersion)===o)return r;const n=this.tsServerHost.getScriptSnapshot(i);if(!n)return;const l=n.getText(0,n.getLength()),c=volar.createSourceFile(i,l,this.tsServerHost.getCompilationSettings(),{target:o,experimentalImplicitWrapComponentOptionsWithDefineComponent:!0,experimentalDowngradePropsAndEmitsToSetupReturnOnScriptSetup:!0,enableTypeScriptValidation:(0,core_1.getConfigurationValue)(this.tsServerHost.getUserPreferences(),"typescript.validate.enable",!0),enableJavaScriptValidation:(0,core_1.getConfigurationValue)(this.tsServerHost.getUserPreferences(),"javascript.validate.enable",!1)},this.tsImpl,[],(0,core_1.isUniAppXProject)(this.project)?nativeTags_1.nativeTags:new Map,this.project),a=new VueEmbedsCacheInfo(c,s,this.tsImpl);a.vueVersion=o,globalVueEmbedCache.set(i,a);let u=c.getAllEmbeddeds();return null==u||u.forEach((e=>{let t=this.tsImpl.server.toNormalizedPath(e.file.fileName),i=this.info.tsinfo.project.projectService.getOrCreateScriptInfoForNormalizedPath(t,!1);i&&i.open(e.file.content)})),a}}exports.VueScriptCache=VueScriptCache;
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TagUnixValidation=void 0;const core_1=require("../../../../core"),vscode_languageserver_1=require("vscode-languageserver"),VueLintNls_1=require("../../nls/VueLintNls"),easycomService_1=require("../../vue/easycomService");class TagUnixValidation{constructor(t,e,i){this._languageService=t,this._allInfo=e,this._dataProviders=i,this.globalAttrs=[],this.tool=null}async doExtraValidation(t,e,i){this.tool=core_1.SyntacticDiagnosticsTool.getInstance();let a=t.languageId;this.generateGlobalAttributes(a);let l=await this.tool.getClassIndexData(),s=this._languageService.getAllTagName(t);const n=e.roots.find((t=>"template"===t.tag));if(!n)return i;const r=(e,a,l,s=vscode_languageserver_1.DiagnosticSeverity.Warning)=>{i.push({code:0,source:"html",message:e,severity:s,range:vscode_languageserver_1.Range.create(t.positionAt(a),t.positionAt(l))})};return accept((i=>{var n,o;try{let u=i.attributes,c=i.tag;if(!c)return!0;if(u&&u.class){let t=u.class,e=null===(n=i.attributeValuesRange)||void 0===n?void 0:n.class;if(t&&e){t=this.removeQuotationMarks(t,e);let i=(0,core_1.matchAll)(t,/[\S]+/g);for(const t of i){let i=t[0],a=e.start+t.index,s=a+i.length;l.has(i)||r((0,VueLintNls_1.localize)("htmlLintRule.unknownClassName",i),a,s)}}}let h=i.start+1,g=(0,easycomService_1.collectEasycoms)(t,e,this._allInfo.project).find((t=>t.name===c));if(g&&g.filePath){let t=getPropertiesByEasyComPath(g.filePath),e=this.analysisAttributes(u,i.attributeNamesRange);null==e||e.forEach((({attrRange:e,attrName:i,isEvent:a,showName:l})=>{var s;if(i.startsWith("data-"))return;if(t&&t.includes(i))return;let n=this.globalAttrs.find((t=>t.name===i));n&&(null===(s=this.tool)||void 0===s?void 0:s.uniPlatformCompletionSupport(n.uniPlatform))||r((0,VueLintNls_1.localize)("htmlLintRule.unSupport",null==g?void 0:g.name,(0,VueLintNls_1.localize)(a?"htmlLintRule.event":"htmlLintRule.attribute"),l),e.start,e.end)}))}else if(s.includes(c)){let t=null;for(const e of this._dataProviders)if(e.isApplicable(a)){let i=e.provideTags().find((t=>t.name===c));if(i){t=(0,core_1.deepAssign)(t,i);continue}}if(null===(o=this.tool)||void 0===o?void 0:o.uniPlatformCompletionSupport(t.uniPlatform)){if(u){let e=[...t.attributes,...this.globalAttrs];this.analysisAttributes(u,i.attributeNamesRange).forEach((({attrRange:t,attrName:i,isEvent:a,showName:l})=>{var s;if(i.startsWith("data-"))return;let n=e.find((t=>t.name===i));n&&(null===(s=this.tool)||void 0===s?void 0:s.uniPlatformCompletionSupport(n.uniPlatform))||r((0,VueLintNls_1.localize)("htmlLintRule.unSupport",c,(0,VueLintNls_1.localize)(a?"htmlLintRule.event":"htmlLintRule.attribute"),l),t.start,t.end)}))}}else r((0,VueLintNls_1.localize)("htmlLintRule.unSupportTag",c),h,h+c.length)}else r((0,VueLintNls_1.localize)("htmlLintRule.unSupportTag",c),h,h+c.length)}catch(t){console.log(t)}return!0}),n),i}removeQuotationMarks(t,e){return t.startsWith('"')&&(t=t.slice(1),e.start+=1),t.endsWith('"')&&(t=t.slice(0,-1),e.end-=1),t}generateGlobalAttributes(t){this.globalAttrs=[];for(const e of this._dataProviders){let i=e.golbalAttributes;e.isApplicable(t)&&i&&(this.globalAttrs=mergeGlobalAttribute(this.globalAttrs,i))}}analysisAttributes(t,e){return t?Object.keys(t).map((t=>{let i=!1,a=t,l=e[t],s=t;return t.startsWith(":")?s=t=t.slice(1):t.startsWith("@")?(t=`[event]${t.slice(1)}`,s=a.slice(1),i=!0):t.startsWith("v-on:")?(t=`[event]${t.slice(5)}`,s=a.slice(5),i=!0):t.startsWith("v-slot:")||t.startsWith("#")?t="v-slot":t.startsWith("v-bind:")&&(t=a.slice(7),s=a.slice(7)),{attrRange:l,attrName:t,showName:s,isEvent:i}})):[]}}function getPropertiesByEasyComPath(t){var e,i;let a=[],l=(0,easycomService_1.fetchVueComponentInfo)(t);return null===(e=null==l?void 0:l.properties)||void 0===e||e.forEach((t=>{t.name&&a.push(t.name)})),null===(i=null==l?void 0:l.events)||void 0===i||i.forEach((t=>{t.name&&a.push(`[event]${t.name}`)})),a}function accept(t,e){if(t(e)&&e.children)for(const i of e.children)accept(t,i)}function mergeGlobalAttribute(t,e){return t.forEach(((i,a)=>{let l=e.findIndex((t=>t.name===i.name));-1!==l&&(t[a]=(0,core_1.deepAssign)(i,e[l]),e.splice(l,1))})),[...t,...e]}exports.TagUnixValidation=TagUnixValidation;
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.UnicloudDbVuePlugin=void 0;const htmlservice_1=require("../../../htmlservice"),specialStringPlugin_1=require("../../../specialStringPlugin");class UnicloudDbAttributeValueService{constructor(e,t){this._htmlInfo=e,this._tsInfo=t,this._attributeTypes=new Map,this._attributeTypes.set("collection",["HBuilderX.DBCollectionString"]),this._attributeTypes.set("field",["HBuilderX.DBFieldString"]),this._attributeTypes.set("orderby",["HBuilderX.DBFieldString"]),this._attributeTypes.set("where",["HBuilderX.JQLString"]),this._attributeTypes.set("action",["HBuilderX.ClientDBActionString"]),this._serviceInstances=new Map,this._serviceInstances.set(specialStringPlugin_1.LanguageServiceType.TS,t.ts),this._serviceInstances.set(specialStringPlugin_1.LanguageServiceType.TYPESCRIPT_LANGUAGE_SERVICE,t.languageService),this._serviceInstances.set(specialStringPlugin_1.LanguageServiceType.HTML_LANGUAGE_SERVICE,e.languageService)}isInAttributeValue(e){return!(!e||"unicloud-db"!==e.activeTag||e.kind!==htmlservice_1.LocationInfoKind.AttributeValue)}async doComplete(e,t,i){let n=this._htmlInfo.languageService.getLocationInfoAtPosition(e,t,i);if(this.isInAttributeValue(n)){let s=null==n?void 0:n.activeAttribute,r=this._attributeTypes.get(s);if(r){return await(0,specialStringPlugin_1.specialStringDoCompleteAsync)(r,e,t,{project:this._tsInfo.project,kind:specialStringPlugin_1.StringLocationInfoKind.IN_HTML_LIKE,ast:i,range:null==n?void 0:n.activeRange},specialStringPlugin_1.StringServicesContainer.create(this._serviceInstances),[])}}return{isIncomplete:!0,items:[]}}async doDefinition(e,t,i){let n=[],s=this._htmlInfo.languageService.getLocationInfoAtPosition(e,t,i);if(this.isInAttributeValue(s)){let r=null==s?void 0:s.activeAttribute,a=this._attributeTypes.get(r);if(a){let r=await(0,specialStringPlugin_1.specialStringDoDefinition)(a,e,t,{project:this._tsInfo.project,kind:specialStringPlugin_1.StringLocationInfoKind.IN_HTML_LIKE,ast:i,range:null==s?void 0:s.activeRange},specialStringPlugin_1.StringServicesContainer.create(this._serviceInstances),[]);n.push(...r)}}return n}}function create(e,t){let i=e.languageService,n=Object.create(null);for(let e of Object.keys(i)){const t=i[e];n[e]=(...e)=>t.apply(i,e)}let s=new UnicloudDbAttributeValueService(e,t);return n.doCompleteAsync=async function(e,t,n,r){let a=await i.doCompleteAsync(e,t,n,r),c=await s.doComplete(e,t,n);return a.items.push(...c.items),a},n.findDefinitionAsync=async function(e,t,n){let r=await i.findDefinitionAsync(e,t,n);r||(r=[]);let a=await s.doDefinition(e,t,n);return r.push(...a),r},n}class UnicloudDbVuePlugin{constructor(e){this.tsInfo=e,this._tsInfo=e}create(e){return create(e,this.tsInfo)}}exports.UnicloudDbVuePlugin=UnicloudDbVuePlugin;
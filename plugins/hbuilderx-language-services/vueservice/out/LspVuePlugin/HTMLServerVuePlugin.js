"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var o=Object.getOwnPropertyDescriptor(t,i);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,o)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.HTMLServerVuePlugin=void 0;const path=__importStar(require("path")),vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),vscode_uri_1=require("vscode-uri"),core_1=require("../../../core"),htmlservice_1=require("../../../htmlservice"),vue_typescript_1=require("../../packages/vue-typescript"),fileReferences_1=require("../langMode/fileReferences"),serviceTypes_1=require("../serviceTypes"),easycomService=__importStar(require("../vue/easycomService")),vueModifierData_1=require("../vueModifierData"),VueEventPrefix="[event]";var VueDirectiveType;function vueDirectiveType(e){return"v-on"==e||"@"==e?VueDirectiveType.Event:"v-bind"==e||":"==e?VueDirectiveType.Attribute:"v-pre"==e||"v-cloak"==e||"v-once"==e||"v-else"==e?VueDirectiveType.Empty:VueDirectiveType.String}function getVueBindOrOnDirective(e){return e?e.startsWith("v-on:")?"v-on:":e.startsWith("@")?"@":e.startsWith("v-bind:")?"v-bind:":e.startsWith(":")?":":"":""}function checkVueModifierDirective(e){return e.startsWith("v-on:")?"v-on:":e.startsWith("@")?"@":e.startsWith("v-bind:")?"v-bind":e.startsWith(":")?":":e.startsWith("v-model")?"v-model":""}function normalizeMarkupContent(e){if(e)return"string"==typeof e?{kind:"markdown",value:e}:{kind:"markdown",value:e.value}}function vueModifierHandle(e,t,i){const n=(0,vueModifierData_1.getModifierProvider)();let o=[];if(!t.activeAttribute)return e;let r=checkVueModifierDirective(t.activeAttribute);if(""===r)return e;let a=t.activeAttribute.split("."),l=a.slice(0,1),c=a.slice(0,-1);if(t.activeAttribute===l[0])return e;let s=l[0].substring(r.length);if("@"===r||"v-on:"===r){const e=["keydown","keypress","keyup"],t=["click","dblclick","mouseup","mousedown"];o.push(...n.eventModifiers),e.includes(s)?(o.push(...n.keyModifiers),o.push(...n.systemModifiers)):t.includes(s)&&(o.push(...n.mouseModifiers),o.push(...n.systemModifiers))}else":"===r||"v-bind"===r?o.push(...n.propsModifiers):"v-model"===r&&(o.push(...n.propsModifiers),o.push(...n.vModelModifiers));let u=c.join("."),d=i.offsetAt(t.activeRange.start)+u.length+1,v=i.positionAt(d),f=t.activeRange.end,p=vscode_languageserver_protocol_1.Range.create(v,f);return e.items=[],o.forEach((t=>{e.items.push({label:t.label,kind:vscode_languageserver_protocol_1.CompletionItemKind.Method,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(p,t.label),insertTextFormat:vscode_languageserver_protocol_1.InsertTextFormat.PlainText,documentation:normalizeMarkupContent(t.documentation),data:{hxKind:core_1.HxIconKind.ATTRIBUTE}})})),e}function vueCustomDirectiveHandle(e,t,i){let n=t.project.fsPath;vscode_uri_1.URI.file(n).toString();return e}function camelToKebab(e){return e.items.forEach((t=>{if(/^[a-z:]|v-([a-z]+(?:[A-Z][a-z]*)*)$/.test(t.label)&&/[A-Z]/.test(t.label)){const i=JSON.parse(JSON.stringify(t)),n=i.label.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();i.label=n,i.textEdit.newText=`${n}="$1"`,e.items.push(i)}})),e}function camelToKebabHover(e){var t;return null===(t=null==e?void 0:e.properties)||void 0===t||t.map((t=>{var i;if(/^[a-z:]|v-([a-z]+(?:[A-Z][a-z]*)*)$/.test(t.name)&&/[A-Z]/.test(t.name)){const n=JSON.parse(JSON.stringify(t)),o=n.name.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();n.name=o,null===(i=null==e?void 0:e.properties)||void 0===i||i.push(n)}})),e}function create(e,t,i){let n=e.languageService,o=Object.create(null);for(let e of Object.keys(n)){const t=n[e];o[e]=(...e)=>t.apply(n,e)}return o.doCompleteAsync=async function(i,o,r,a){if("vue"===i.languageId||"nvue"===i.languageId){let a=await async function(t,i,o,r){var a,l,c;let s=await n.doCompleteAsync(t,i,o),u=n.getLocationInfoAtPosition(t,i,o);if(!u)return{result:s};switch(u.kind){case htmlservice_1.LocationInfoKind.StartTagOpen:case htmlservice_1.LocationInfoKind.StartTag:case htmlservice_1.LocationInfoKind.EndTag:!function(e,t,i){let n=easycomService.collectEasycoms(e,t,i),o=u.activeRange;n.forEach((t=>{s.items.push({label:t.name,kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,data:{hxKind:core_1.HxIconKind.ELEMENT,languageId:"vue-template",uri:e.uri,kind:"vue-component",filePath:t.filePath},textEdit:vscode_languageserver_protocol_1.TextEdit.replace(o,t.name+"$0></"+t.name+">"),insertTextFormat:vscode_languageserver_protocol_1.InsertTextFormat.Snippet})}))}(t,o,e.project);break;case htmlservice_1.LocationInfoKind.AttributeName:{let i=t.offsetAt(u.activeRange.end),r=n.isFollowedBy(t.getText(),i,serviceTypes_1.ScannerState.AfterAttributeName,serviceTypes_1.TokenType.DelimiterAssign),c=easycomService.findEasycomByTag(u.activeTag,t,o,e.project);if(c){let e=easycomService.fetchVueComponentInfo(c.filePath),t=r?void 0:{title:"Suggest",command:"editor.action.triggerSuggest"};null===(a=null==e?void 0:e.properties)||void 0===a||a.forEach((e=>{if(e.name){let i=e.name+(r?"":'="$1"');s.items.push({label:e.name,kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,documentation:e.description,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(u.activeRange,i),insertTextFormat:vscode_languageserver_protocol_1.InsertTextFormat.Snippet,command:t})}})),null===(l=null==e?void 0:e.events)||void 0===l||l.forEach((e=>{if(e.name){let i=e.name+(r?"":'="$1"');s.items.push({label:e.name,kind:vscode_languageserver_protocol_1.CompletionItemKind.Function,documentation:e.description,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(u.activeRange,i),insertTextFormat:vscode_languageserver_protocol_1.InsertTextFormat.Snippet,command:t,data:{hxKind:core_1.HxIconKind.EVENT,source:"easycom"}})}}))}break}case htmlservice_1.LocationInfoKind.AttributeValue:{let i=easycomService.findEasycomByTag(u.activeTag,t,o,e.project);if(i){let e=easycomService.fetchVueComponentInfo(i.filePath),t=null===(c=null==e?void 0:e.properties)||void 0===c?void 0:c.find((e=>e.name===(null==u?void 0:u.activeAttribute)));t&&t.values&&t.values.forEach((e=>{let t=e.value;s.items.push({label:e.value,kind:vscode_languageserver_protocol_1.CompletionItemKind.Value,documentation:e.description,textEdit:vscode_languageserver_protocol_1.TextEdit.replace(u.activeRange,t)})}))}}}return{result:s,location:u}}(i,o,r);i.getText(),i.offsetAt(o);if(a&&a.location&&a.location.kind===htmlservice_1.LocationInfoKind.AttributeName){let e=getVueBindOrOnDirective(a.location.activeAttribute),n={isIncomplete:a.result.isIncomplete,items:[]};return a.result.items.forEach((t=>{var i,o,r,a;if(t.label){if((null===(i=t.data)||void 0===i?void 0:i.hxKind)===core_1.HxIconKind.EVENT){if(0===e.length&&(null===(o=t.data)||void 0===o?void 0:o.source))return;if(t.label.startsWith("on")&&(t.label=t.label.slice(2),t.textEdit)){let e=t.textEdit.newText.startsWith("on")?t.textEdit.newText.slice(2):t.textEdit.newText;t.textEdit.newText=e}}if(t.label.startsWith("[event]")&&(t.data||(t.data={}),t.data.hxKind=core_1.HxIconKind.EVENT,t.label=t.label.slice("[event]".length),t.textEdit)){let e=t.textEdit.newText.startsWith("[event]")?t.textEdit.newText.slice("[event]".length):t.textEdit.newText;t.textEdit.newText=e}if(t.label.startsWith("v-")){let e=vueDirectiveType(t.label);e!=VueDirectiveType.Event&&e!=VueDirectiveType.Attribute||t.textEdit&&(t.textEdit.newText=t.label+":")}else e.length>0&&t.textEdit&&("@"===e||"v-on:"===e?(null===(r=t.data)||void 0===r?void 0:r.hxKind)===core_1.HxIconKind.EVENT&&(t.label=e+t.label,t.textEdit.newText=e+t.textEdit.newText):(null===(a=t.data)||void 0===a?void 0:a.hxKind)!==core_1.HxIconKind.EVENT&&(t.label=e+t.label,t.textEdit.newText=e+t.textEdit.newText));n.items.push(t)}})),n=vueModifierHandle(a.result,a.location,i),n=vueCustomDirectiveHandle(a.result,t,a.location),n=camelToKebab(a.result),n}return a.result}return await n.doCompleteAsync(i,o,r,a)},o.doResolve=function(e,i,o,r){if("vue"===i.languageId||"nvue"===i.languageId){if((e=n.doResolve(e,i,o,r)).data&&e.data.kind){const a=e.data;function l(){if(a.filePath){let t=easycomService.fetchVueComponentInfo(a.filePath);if(t)return e.detail=e.label,e.documentation=t.description,e}}function c(){var i,n;let o=t.languageService.getProgram(),r=null==o?void 0:o.getRootFileNames().find((e=>e.endsWith(vue_typescript_1.localTypes.typesFileName)));if(!r)return e;let a=null==o?void 0:o.getSourceFile(r),l=null==o?void 0:o.getTypeChecker();if(!l||!a)return e;let c=l.getSymbolsInScope(a,core_1.ts.SymbolFlags.Type|core_1.ts.SymbolFlags.BlockScoped).find((e=>"GlobalComponents"===e.escapedName));if(!c||0==(null===(i=c.declarations)||void 0===i?void 0:i.length))return e;let s=l.getTypeAtLocation(c.declarations[0]),u=l.getPropertiesOfType(s).find((t=>t.getName()===e.label));if(u){const{displayParts:i,documentation:o,symbolKind:r,tags:c}=t.ts.SymbolDisplay.getSymbolDisplayPartsDocumentationAndSymbolKind(l,u,a,a,a,7);let s=t.ts.Completions.createCompletionDetails(u.name,t.ts.SymbolDisplay.getSymbolModifiers(l,u),r,i,o,c,void 0,void 0);if(s){let i=null===(n=u.valueDeclaration)||void 0===n?void 0:n.getSourceFile().fileName;if(e.detail=`${e.label}:GlobalElements.${e.label}`,e.documentation=t.ts.displayPartsToString(s.documentation),i){let t=i.indexOf("node_modules");t>=0&&(i=i.substring(t),e.documentation&&e.documentation.length>0?e.documentation=e.documentation+"\n"+`来自于：${i}`:e.documentation=`来自于：${i}`)}}}return e}"vue-component"===a.kind?l():"vue-global-component"===a.kind&&c()}return e}return n.doResolve(e,i,o,r)},o.doHover=function(t,i,o,r){if("vue"===t.languageId||"nvue"===t.languageId){let a=n.doHover(t,i,o,r);if(a)return a;let l=n.getLocationInfoAtPosition(t,i,o);if((null==l?void 0:l.kind)===htmlservice_1.LocationInfoKind.AttributeName){let s=l.activeTag,u=easycomService.findEasycomByTag(s,t,o,e.project);if(u)return c(u,l)}if((null==l?void 0:l.kind)===htmlservice_1.LocationInfoKind.StartTag||(null==l?void 0:l.kind)===htmlservice_1.LocationInfoKind.EndTag){let d=l.activeTag,v=easycomService.findEasycomByTag(d,t,o,e.project);if(v)return c(v,l)}function c(t,i){var n,o;let r=easycomService.fetchVueComponentInfo(t.filePath),a="file://";if("win32"===process.platform&&(a="file:///"),r){if(i.kind!==htmlservice_1.LocationInfoKind.AttributeName){let t=[];return t.push(`**${i.activeTag}**`),t.push("<hr>"),r.description&&(t.push(`${r.description}`),t.push("<br />"),t.push("<br />")),t.push(`<b>定义于：</b> <a href='${a}${r.filePath}'>${path.relative(e.project.fsPath,r.filePath)}</a>`),r.tutorial&&(t.push("<br />"),t.push(`<b>文档：</b><a data-kind='tutorial' href='${r.tutorial}'>${r.tutorial}</a>`)),{range:i.activeRange,contents:{kind:"markdown",value:t.join("\n")}}}{r=camelToKebabHover(r);let t=null===(n=r.properties)||void 0===n?void 0:n.find((e=>i.activeAttribute==e.name||i.activeAttribute==":"+e.name||i.activeAttribute=="v-bind:"+e.name)),l=null===(o=r.events)||void 0===o?void 0:o.find((e=>i.activeAttribute==e.name||i.activeAttribute=="@"+e.name||i.activeAttribute=="v-on:"+e.name));if(t){let n=[];return n.push(`**${t.name}**`),n.push("<hr>"),t.description&&(n.push(`${t.description}`),n.push("<br />"),n.push("<br />")),n.push(`<b>定义于：</b> <a href='${a}${r.filePath}'>${path.relative(e.project.fsPath,r.filePath)}</a>`),{range:i.activeRange,contents:{kind:"markdown",value:n.join("\n")}}}if(l){let t=[];return t.push(`**${l.name}**`),t.push("<hr>"),l.description&&(t.push(`${l.description}`),t.push("<br />"),t.push("<br />")),t.push(`<b>定义于：</b> <a href='${a}${r.filePath}'>${path.relative(e.project.fsPath,r.filePath)}</a>`),{range:i.activeRange,contents:{kind:"markdown",value:t.join("\n")}}}}}return null}}return n.doHover(t,i,o,r)},o.findDefinitionAsync=async function(t,i,o){if("vue"===t.languageId||"nvue"===t.languageId){let r=[],a=await n.findDefinitionAsync(t,i,o);a&&r.push(...a);let l=n.getLocationInfoAtPosition(t,i,o);if(l&&(l.kind===htmlservice_1.LocationInfoKind.StartTag||l.kind===htmlservice_1.LocationInfoKind.EndTag)){let i=easycomService.findEasycomByTag(l.activeTag,t,o,e.project);if(i){let e={start:{line:0,character:0},end:{line:0,character:0}};r.push({originSelectionRange:l.activeRange,targetUri:i.filePath,targetSelectionRange:e,targetRange:e})}}return r}return n.findDefinitionAsync(t,i,o)},o.tsFindReferencesAsync=async function(t,i,o){const r=await n.tsFindReferencesAsync(t,i,o);if(!("vue"===t.languageId||"nvue"===t.languageId))return r;let a=n.getLocationInfoAtPosition(t,i,o);if(!a)return r;if(a.kind===htmlservice_1.LocationInfoKind.StartTagOpen){const e=i;e.character+=1,a=n.getLocationInfoAtPosition(t,e,o)}if(!a)return r;if(!(a.kind===htmlservice_1.LocationInfoKind.StartTag||a.kind===htmlservice_1.LocationInfoKind.EndTag))return r;const l=easycomService.findEasycomByTag(a.activeTag,t,o,e.project);if(!l){const n=await async function(t,i,n){n||(n=[]);const o=(0,core_1.noTsToNormalizedUri)(e.project.fsPath);if(!o)return n;const r=[{projectUri:o,kind:"VUE_COMPONENT_TAG",fileUri:(0,core_1.noTsToNormalizedUri)(t.uri)}];let a;if(a=await e.project.indexPipeHandler.getIndexDataRequest(r,!0),!a)return n;if(0===a.length)return n;a.forEach((e=>{e=(0,core_1.tagNormalizedData)(e)}));const l=t.offsetAt(i),c=(0,core_1.getContextData)(t,l,' \t\n\r":{[()]},*<>+'),s={options:{text:c.context,needRange:!0},filter:function(e,t){let i=!1,n=!1;return void 0!==t.options.text&&t.options.text===e.value&&(i=!0),t.options.needRange&&e.range&&(n=!0),!(i&&n)}},u=[];a.forEach((e=>{const t=(0,core_1.lspFilterIndexData)(e,s);u.push(t)}));const d=[];return u.forEach((e=>{const t=(0,core_1.creatorExtLocationLinksFromIndexData)(e,c.contextRange);d.unshift(...t)})),n.push(...d),n}(t,i,r);return n}const c=new fileReferences_1.VueFileReferences,s=(0,core_1.noTsToNormalizedPath)(l.filePath);if(!s)return r;return c.getLspFileReferencesAsync(e.project,s)},o}!function(e){e[e.Empty=0]="Empty",e[e.String=1]="String",e[e.Event=2]="Event",e[e.Attribute=3]="Attribute"}(VueDirectiveType||(VueDirectiveType={}));class HTMLServerVuePlugin{constructor(e,t){this.tsInfo=e,this.vueDataProviders=t}create(e){return create(e,this.tsInfo,this.vueDataProviders)}}exports.HTMLServerVuePlugin=HTMLServerVuePlugin;
"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,r)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.createVueOptionsTypeChecker=exports.createVueThisTypeChecker=exports.getMixinsNode=exports.isMixinsContext=void 0;const path=__importStar(require("path")),core_1=require("../../core"),hx=__importStar(require("../../core")),core_2=require("../../core"),utils_1=require("./uitls/utils"),utils_2=require("../../utils");function getType(e,t,i,s){let r=i.getSymbolsInScope(t,core_1.ts.SymbolFlags.Type).find((t=>t.escapedName===e));if(r)return i.getDeclaredTypeOfSymbol(r)}function asCallExpression(e,t){return e.kind==core_1.ts.SyntaxKind.CallExpression?e:void 0}function isMixinsContext(e,t){let i=e;for(;i&&i.kind!=core_1.ts.SyntaxKind.SourceFile;){if(i=i.parent,core_1.ts.isPropertyAssignment(i)&&"mixins"===i.name.getText()&&core_1.ts.isArrayLiteralExpression(i.initializer)&&core_1.ts.isCallExpression(i.parent.parent)&&core_1.ts.isPropertyAccessExpression(i.parent.parent.expression)&&"defineComponent"===i.parent.parent.expression.name.getText())return!0;if(core_1.ts.isVariableDeclaration(i)&&i.initializer&&core_1.ts.isCallExpression(i.initializer)&&i.initializer.expression&&"defineMixin"===i.initializer.expression.escapedText)return!0}return!1}function isVueThisContext(e,t){var i;let s=e;for(;s&&s.kind!=core_1.ts.SyntaxKind.SourceFile&&(!core_1.ts.isFunctionLike(s)||core_1.ts.isArrowFunction(s));)s=s.parent;if(core_1.ts.isFunctionLike(s)){if("setup"===(null===(i=s.name)||void 0===i?void 0:i.getText()))return!1;for(s=s.parent;s&&s.kind!=core_1.ts.SyntaxKind.SourceFile&&!core_1.ts.isObjectLiteralExpression(s)&&!core_1.ts.isFunctionLike(s);)s=s.parent;if(!core_1.ts.isObjectLiteralExpression(s))return!1;if(core_1.ts.isCallExpression(s.parent)){let e=s.parent;if(!e.expression.getText().endsWith(".defineComponent")&&!e.expression.getText().endsWith(".defineApp"))return!1}}return!0}function getComponentPublicInstance(e,t,i){let s=i.getSymbolsInScope(e,core_1.ts.SymbolFlags.BlockScopedVariable);if(s){let e=s.find((e=>"___VLS_vueInstance"===e.escapedName));if(e&&e.valueDeclaration)return i.getTypeAtLocation(e.valueDeclaration)}}function getVueOptionsType(e,t,i,s,r,n,o){let l=r.getSymbolAtLocation(t);n&&(l=n);let a=s.ts.createSymbolTable();if(l&&l&&e){const t=["data","props","methods","computed","inject","setup"],i=(0,utils_1.getExportDefaultPropertiesSymbol)(r,e,s.ts,t);a=(0,utils_2.getMembersAtType)(t,i,s,r);let n=(0,utils_1.getExportDefaultPropertiesNode)(r,e,s.ts,["mixins"]);if(n&&n.has("mixins")){let e=n.get("mixins");if(e&&s.ts.isPropertyAssignment(e)&&s.ts.isArrayLiteralExpression(e.initializer)){let t=e.initializer,i=(0,utils_2.getMixinsOptionsType)(t,s,r,o);i&&i.forEach(((e,t)=>{a.set(t,e)}))}}return r.createAnonymousType(l,a,[],[],[])}}function getMixinsNode(e,t){let i=e;for(;i&&i.kind!=core_1.ts.SyntaxKind.SourceFile;){if(i=i.parent,core_1.ts.isPropertyAssignment(i)&&"mixins"===i.name.getText()&&core_1.ts.isArrayLiteralExpression(i.initializer)&&core_1.ts.isCallExpression(i.parent.parent)&&core_1.ts.isPropertyAccessExpression(i.parent.parent.expression)&&"defineComponent"===i.parent.parent.expression.name.getText())return i.initializer;if(core_1.ts.isCallExpression(i)&&core_1.ts.isPropertyAccessExpression(i.expression)&&"defineComponent"===i.expression.name.getText()&&i.arguments&&i.arguments.length>0){let e=i.arguments[0].properties.find((e=>"mixins"===e.name.escapedText));if(e&&core_1.ts.isPropertyAssignment(e)&&core_1.ts.isArrayLiteralExpression(e.initializer))return e.initializer}}}function createVueThisTypeChecker(e){return{checkExpression(t,i,s,r,n,o){var l,a,c,p,u,_;const d=r.kind;let x=r.getSourceFile().fileName;if((x.endsWith(".__VLS_template.jsx")||x.endsWith(".__VLS_template.tsx"))&&(t.kind===core_2.HXProjectKind.UniApp||t.kind===core_2.HXProjectKind.UniApp_Cli)&&e.ts.isPropertyAccessExpression(r)&&r.getText().indexOf("__VLS_types.vuePrototype")>=0){let i=path.join(t.sourceRoot,"main.js"),r=null===(l=e.languageService.getProgram())||void 0===l?void 0:l.getSourceFile(i);if(r){let t=e.ts.createSymbolTable();if(r.forEachChild((function i(s){var r;if(e.ts.isExpressionStatement(s)){let i=s;if((i.getText().startsWith("Vue.prototype.")||-1!=i.getText().indexOf(".config.globalProperties."))&&e.ts.isBinaryExpression(i.expression)){let s=i.expression;if(e.ts.isPropertyAccessExpression(s.left)){let i=s.left,n=null===(r=null==i?void 0:i.name)||void 0===r?void 0:r.escapedText;if(n){let i=new(e.ts.objectAllocator.getSymbolConstructor())(core_1.ts.SymbolFlags.Property|core_1.ts.SymbolFlags.Assignment,n);i.declarations=[s],i.valueDeclaration=s,t.set(n,i)}}}}e.ts.forEachChild(s,i)})),t.size>0)return s.createAnonymousType(void 0,t,[],[],[])}}if((x.endsWith(".vue.js")||x.endsWith(".vue.ts")||x.endsWith(".nvue.js")||x.endsWith(".nvue.ts")||x.endsWith(".uvue.js")||x.endsWith(".uvue.ts"))&&d===e.ts.SyntaxKind.ThisKeyword&&(isVueThisContext(r,e.ts)||isMixinsContext(r,e.ts))){let t=x.slice(0,-2)+"1.__VLS_template.tsx",i=null===(a=e.languageService.getProgram())||void 0===a?void 0:a.getSourceFile(t);if(i||(t=x.slice(0,-2)+"1.__VLS_template.jsx",i=null===(c=e.languageService.getProgram())||void 0===c?void 0:c.getSourceFile(t)),i){let e=s.getSymbolsInScope(i,core_1.ts.SymbolFlags.FunctionScopedVariable);if(e){let t=e.find((e=>"___VLS_ctx"===e.escapedName));if(t)return s.getTypeOfSymbol(t)}}}if(hx.fileEndsWith(x,[".1.__VLS_template.tsx",".__VLS_template.tsx",".1.__VLS_template.jsx",".__VLS_template.jsx"])&&e.ts.isIdentifier(r)&&"__VLS_uvueCurrent"===r.getText()){let i=hx.fileEndsWith(x,[".1.__VLS_template.tsx",".1.__VLS_template.jsx"])?x.slice(0,-21)+".__VLS_script.ts":x.slice(0,-19)+".__VLS_script.ts";return getVueOptionsType(null===(p=e.languageService.getProgram())||void 0===p?void 0:p.getSourceFile(i),r,i,e,s,void 0,t)}if(x.endsWith(".easycom.ts")){const t=/__easycom\("([^"]+)"\)/,i=r.getSourceFile().text.match(t);let n="";if(i&&i[1]&&(n=i[1]),n){let t="";t=(n.endsWith(".uvue"),n+".1.__VLS_template.tsx");let i=null===(u=e.languageService.getProgram())||void 0===u?void 0:u.getSourceFile(t);if(i||(t=t.slice(0,-3)+"jsx",i=null===(_=e.languageService.getProgram())||void 0===_?void 0:_.getSourceFile(t)),i){let e=s.getSymbolsInScope(i,core_1.ts.SymbolFlags.FunctionScopedVariable);if(e){let t=e.find((e=>"___VLS_ctx"===e.escapedName));if(t){let e=s.getTypeOfSymbol(t).types,i=s.getUnionType(e,0);return i.flags=core_1.ts.TypeFlags.Intersection,i}}}}}}}}function createVueOptionsTypeChecker(e){return{getContextualType(t,i,s,r,n){var o;let l=r.getSourceFile().fileName,a=l.endsWith(".vue.ts")||l.endsWith(".vue.js")||l.endsWith(".nvue.ts")||l.endsWith(".nvue.js")||l.endsWith(".uvue.js")||l.endsWith(".uvue.ts");if(t.kind===core_2.HXProjectKind.UniApp&&a&&e.ts.isObjectLiteralExpression(r)&&e.ts.isCallExpression(r.parent)){if(r.parent.expression.getText().endsWith(".defineComponent")){let t=(0,core_2.getExtensionRootPath)(),i=path.join(t,"builtin-dts","uniapp@vue2","node_modules","@dcloudio","types","uni-app","vue.d.ts"),s=e.languageService.getProgram(),r=null==s?void 0:s.getTypeChecker(),n=null==s?void 0:s.getSourceFile(i);if(n&&r){let e=r.getSymbolsInScope(n,core_1.ts.SymbolFlags.Module).find((e=>'"vue/types/options"'===e.escapedName));if(e){let t=null===(o=e.exports)||void 0===o?void 0:o.get("ComponentOptions");if(t&&t.declarations&&t.declarations.length>0){return r.getTypeAtLocation(t.declarations[0])}}}}}}}}exports.isMixinsContext=isMixinsContext,exports.getMixinsNode=getMixinsNode,exports.createVueThisTypeChecker=createVueThisTypeChecker,exports.createVueOptionsTypeChecker=createVueOptionsTypeChecker;
"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.TsServerVuePlugin=void 0;const core_1=require("../../core"),htmlservice_1=require("../../htmlservice"),VueScriptCache_1=require("./VueScriptCache"),path=__importStar(require("path")),path_1=require("path"),vscode_uri_1=require("vscode-uri"),styleservice_1=require("../../styleservice"),vue_typescript_1=require("../packages/vue-typescript"),fileReferences_1=require("./langMode/fileReferences"),scriptEmbedMode_1=require("./langMode/scriptEmbedMode"),styleEmbedMode_1=require("./langMode/styleEmbedMode"),tagEmbedMode_1=require("./langMode/tagEmbedMode"),HTMLServerVuePlugin_1=require("./LspVuePlugin/HTMLServerVuePlugin"),TagUnixPlugin_1=require("./LspVuePlugin/TagUnixPlugin/TagUnixPlugin"),unicloudDbVuePlugin_1=require("./LspVuePlugin/unicloudDbVuePlugin"),VueAdditionalPlugin_1=require("./LspVuePlugin/VueAdditionalPlugin"),serviceTypes_1=require("./serviceTypes"),utils_1=require("./uitls/utils"),veturProvider_1=require("./vue/veturProvider"),vueTypeCheckerHelper_1=require("./vueTypeCheckerHelper");function isVueFile(e){return core_1.fileTypesTool.isVueType(e)}const g_vueCachesByHost=new Map;function initialize(e){var t,i;let n=e.languageServiceHost;const r=n.getScriptKind.bind(n),s=n.getScriptSnapshot.bind(n),o=null===(t=n.resolveModuleNameLiterals)||void 0===t?void 0:t.bind(n),a=n.getCompilationSettings.bind(n),l=n.fileExists.bind(n),c=n.getScriptVersion.bind(n),u=n.getScriptFileNames.bind(n),p=new VueScriptCache_1.VueScriptCache({getScriptVersion:c,getScriptSnapshot:s,getCompilationSettings:a,getUserPreferences:()=>e.tsinfo.project.projectService.getHostPreferences()},e);g_vueCachesByHost.set(e.languageServiceHost,p);const f=null===(i=n.removeFile)||void 0===i?void 0:i.bind(e.tsinfo.project);n.removeFile=function(t,i,n){e.tsinfo.project.isRoot(t)&&p.deleteCache(t.fileName),f&&f(t,i,n)};const d=e.project.kind,g=!(d===core_1.HXProjectKind.UniApp||d===core_1.HXProjectKind.UniApp_Cli),m=[],v=[new serviceTypes_1.VueDataProvider(e.project,"uni_vue",serviceTypes_1.uniVueData),new serviceTypes_1.NVueDataProvider(e.project,"uni_nvue",serviceTypes_1.uniNvueData),new serviceTypes_1.VueBaseDataProvider(e.project,"vue2-base",serviceTypes_1.vue2Data),new serviceTypes_1.VueBaseDataProvider(e.project,"vue3-base",serviceTypes_1.vue3Data)];m.push(...v),d!==core_1.HXProjectKind.UniApp&&d!=core_1.HXProjectKind.UniApp_Cli&&m.push(new serviceTypes_1.HTMLDataProvider("html5",serviceTypes_1.htmlData));let h=(0,htmlservice_1.enablePluginProxy)({languageService:(0,serviceTypes_1.getHTMLLanguageService)({}),project:e.project});const _=[];_.push(new htmlservice_1.HTMLRevisePLugin(e)),_.push(new htmlservice_1.HTMLIdAndClassPlugin(e)),_.push(new HTMLServerVuePlugin_1.HTMLServerVuePlugin(e,m)),_.push(new htmlservice_1.HTMLAdditionalPlugin(e,m)),_.push(new VueAdditionalPlugin_1.VueAdditionalPlugin(e,m)),_.push(new unicloudDbVuePlugin_1.UnicloudDbVuePlugin(e)),_.push(new TagUnixPlugin_1.TagUnixPlugin(e,m)),_.forEach((t=>{h=t.create({languageService:h,project:e.project})}));const y=(0,veturProvider_1.getVeturDataProviders)(vscode_uri_1.URI.file(e.project.fsPath).toString());m.push(...y),h.setDataProviders(g,m),e.ts.sys.watchFile&&e.ts.sys.watchFile(path.join(e.project.fsPath,"package.json"),((t,i)=>{m.splice(0,m.length),m.push(...v);const n=(0,veturProvider_1.getVeturDataProviders)(vscode_uri_1.URI.file(e.project.fsPath).toString());m.push(...n),h.setDataProviders(g,m)}),2e3);const S=new Map;S.set("javascript",new scriptEmbedMode_1.VueScriptEmbedMode(e,p)),S.set("html",new tagEmbedMode_1.VueTagEmbedMode(e,p,h,m));const x=new Map;x.set("css",(0,serviceTypes_1.getCSSLanguageService)()),x.set("scss",(0,serviceTypes_1.getSCSSLanguageService)()),x.set("less",(0,serviceTypes_1.getLESSLanguageService)());const T={data:serviceTypes_1.webCssDataProvider,enable:function(e){return!(0,core_1.isUniAppXProject)(e)}},b={data:serviceTypes_1.uniappxCssDataProvider,enable:function(e){return(0,core_1.isUniAppXProject)(e)}},F=[new serviceTypes_1.MergeDataProvider(e.project,serviceTypes_1.styleI18nData,[T,b])],P=new Map;x.forEach(((e,t)=>{e.setDataProviders(!1,F),P.set(t,F)}));let j=(0,styleservice_1.styleServerListEnablePluginProxy)({styleLanguageServiceList:x,project:e.project});return j=new styleservice_1.StyleExtraPluginModule(e,P,m).create({styleLanguageServiceList:j,project:e.project}),S.set("style",new styleEmbedMode_1.VueStyleEmbedMode(e,p,j)),function(){const t=e.tsinfo.serverHost.readFile.bind(e.tsinfo.serverHost),i=e.tsinfo.serverHost.fileExists.bind(e.tsinfo.serverHost);e.tsinfo.serverHost.readFile=function(e,i){if(p.hasEmbeddedFile(e)){let t=p.getEmbeddedFile(e);if(t)return t.file.content}else if(e.endsWith(vue_typescript_1.localTypes.typesFileName))return vue_typescript_1.localTypes.getTypesCode(2);return t(e,i)},e.tsinfo.serverHost.fileExists=function(e){return!!i(e)||(!!e.endsWith(vue_typescript_1.localTypes.typesFileName)||p.hasEmbeddedFile(e))}}(),n.resolveModuleNameLiterals=function(t,i,r,s,a,l){if(s.noCustomResolve)return(0,core_1.emptyResolvedModules)(t);let c=[],u=null==o?void 0:o(t,i,r,s,a,l);if(u)for(let r=0;r<u.length;r++){let o=u[r],a=t[r].text;if(e.project.kind===core_1.HXProjectKind.UniApp&&!(0,core_1.isUniAppXProject)(e.project)){let t=(0,core_1.getBuiltinUniappModule)(a,e.project);if(t){c.push({resolvedModule:{isExternalLibraryImport:!0,resolvedFileName:t,extension:".d.ts"}});continue}}if(o&&o.resolvedModule)c.push(o);else{let t,r={fileExists:e=>n.fileExists(e),readFile:e=>n.readFile(e)};e.project.kind!=core_1.HXProjectKind.UniApp&&e.project.kind!=core_1.HXProjectKind.UniApp_Cli||a.startsWith("@/")&&(a=path.join(e.project.sourceRoot,a.substring(2)));let o=path.resolve(path.dirname(i),a),l=[o,o+".vue",o+".nvue",o+".uvue"],u=".ts";for(let e of l){let i;if(isVueFile(e)&&r.fileExists(e)){let t=p.getUpToDateInfo(e);if(t){let n=[".ts",".js"];for(let r of n){let n=t.getEmbedFile(e+r);if(n){i=n.file.fileName,u=r;break}}}}if(i){t={isExternalLibraryImport:!1,resolvedFileName:i,extension:u};break}}if(!t){let i=["",".js",".ts",".jsx",".tsx"];for(let n of i){let i=o+n;if(p.hasEmbeddedFile(i)){t={isExternalLibraryImport:!1,resolvedFileName:i,extension:n};break}if(i.endsWith(vue_typescript_1.localTypes.typesFileName)){t={isExternalLibraryImport:!1,resolvedFileName:i,extension:n};break}if(e.languageServiceHost.fileExists(i)){t={isExternalLibraryImport:!1,resolvedFileName:i,extension:n||path.extname(o)};break}}}if(!t&&!core_1.ts.pathIsRelative(a)){const i=path.join((0,core_1.getExtensionRootPath)(),"builtin-dts");let n=[path.join(i,"index.js"),path.join(i,"uniapp@vue"+(2===(0,core_1.vueVersion)(e.project)?2:3),"index.js")];for(const o of n){let n=e.ts.nodeModuleNameResolver(a,o,s,r);if(n.resolvedModule&&(0,core_1.fileStartsWith)(n.resolvedModule.resolvedFileName,[i])){t=n.resolvedModule;break}}}c.push({resolvedModule:t})}}return c},n.getScriptFileNames=function(){let t=[],i=u();if(i&&t.push(...i),t.forEach((e=>{isVueFile(e)&&p.getUpToDateInfo(e)})),n.getCompilationSettings().noCustomResolve)return t;let r=[],s=p.allSourceFiles;for(let e of s){t.indexOf(e.fileName)<0&&r.push(e.fileName);let i=path.join(path.dirname(e.fileName),vue_typescript_1.localTypes.typesFileName);t.indexOf(i)<0&&r.indexOf(i)<0&&r.push(i);let n=e.getAllEmbeddeds();for(let e of n)e.file.isTsHostFile&&r.push(e.file.fileName)}return t.push(...r),e.project.kind!==core_1.HXProjectKind.UniApp&&e.project.kind!==core_1.HXProjectKind.UniApp_Cli||t.push(path.join(e.project.sourceRoot,"main.js")),t},n.fileExists=function(e){return!!l(e)||(!!e.endsWith(vue_typescript_1.localTypes.typesFileName)||p.hasEmbeddedFile(e))},n.getScriptVersion=function(e){return isVueFile(e)&&p.getUpToDateInfo(e),c(e)},n.getScriptKind=function(e){return isVueFile(e)&&p.getUpToDateInfo(e),r(e)},n.getScriptSnapshot=function(t){if(isVueFile(t)&&p.getUpToDateInfo(t),t.endsWith(vue_typescript_1.localTypes.typesFileName)){let i=e.tsinfo.serverHost.readFile(t);return e.ts.ScriptSnapshot.fromString(i)}return s(t)},{vueCachesInProjectScope:p,vueLanguageModes:S}}function create(e){let t=e.languageServiceRouter,i=Object.create(null);for(let e of Object.keys(t)){const n=t[e];i[e]=(...e)=>n.apply(t,e)}const{vueCachesInProjectScope:n,vueLanguageModes:r}=initialize(e),s=new fileReferences_1.VueFileReferences;return i.isEnabled=(e,t)=>isVueFile(e),i=function(t){const i=Object.create(null);for(let e of Object.keys(t)){const n=t[e];i[e]=(...e)=>n.apply(t,e)}return i.getCompletionsAtPositionAsync=async function(i,s,o){if(isVueFile(i)){const a=(0,utils_1.initializeMode)(e,n,r,i,s,"completions","completion",!0);if(!a)return;const l=a.mode,c=a.eFile,u=a.mappedRange,p=a.sourceMap,f=await l.getCompletionsAtPositionAsync(t,c.fileName,u[0].start,o);if(!f)return;let d,g;return f.entries.forEach((e=>{d?((0,core_1.isSameTextSpan)(d,e.replacementSpan)||(d=e.replacementSpan,g=(0,utils_1.virtualToRealityFromRange)(p,e.replacementSpan)),e.replacementSpan=g?{...g}:g):(d=e.replacementSpan,g=(0,utils_1.virtualToRealityFromRange)(p,e.replacementSpan),e.replacementSpan=g?{...g}:g)})),f}return t.getCompletionsAtPositionAsync(i,s,o)},i.getCompletionEntryDetails=function(i,s,o,a,l,c,u){if(isVueFile(i)){const p=(0,utils_1.initializeMode)(e,n,r,i,s,"completions","completion",!0);if(!p)return;const f=p.mode,d=p.eFile,g=p.mappedRange,m=(p.sourceMap,f.getCompletionEntryDetails(t,d.fileName,g[0].start,o,a,l,c,u));if(!m)return;if(!m.codeActions)return m;return m.codeActions=m.codeActions.map((e=>{let t=e.changes.map((e=>{let t=n.getEmbeddedFileInfo(e.fileName);if(t&&t.file){return{isNewFile:!1,fileName:t.host.fileName,textChanges:e.textChanges.map((e=>{let i=e.newText;return i.toLowerCase().indexOf("vue2and3")>0&&(i=i.replace(/(['"]{1}).*(['"]{1})/,'"vue"')),0===e.span.start&&(i="\n"+i.trimRight()),{newText:i,span:(0,utils_1.virtualToRealityFromRange)(t.file.sourceMap,e.span)}}))}}return e}));return{...e,changes:t}})),e.ts.displayPartsToString(m.sourceDisplay).toLowerCase().indexOf("vue2and3")>0&&(m.source=m.sourceDisplay=[{kind:"text",text:"vue"}]),m}return t.getCompletionEntryDetails(i,s,o,a,l,c,u)},i.getNavigationTree=function(i){if(isVueFile(i)){let t={text:"",kind:e.ts.ScriptElementKind.alias,kindModifiers:"",spans:[],nameSpan:void 0};if(!e.tsinfo.project.getScriptInfo(i))return t;if(!n.getUpToDateInfo(i))return t;let r=n.getEmbeddedFileInfo(i+".html");if(!r)return t;if(e.html){return e.html.getNavigationTree(r.file.file.fileName)}}return t.getNavigationTree(i)},i}(i),i=function(t){const i=Object.create(null);for(let e of Object.keys(t)){const n=t[e];i[e]=(...e)=>n.apply(t,e)}return i.toLineColumnOffset=function(e,i){if(isVueFile(e)){let t=n.getUpToDateInfo(e);if(t){let e=t.toLspDocument().positionAt(i);return{line:e.line,character:e.character}}}return t.toLineColumnOffset(e,i)},i.getDefinitionAndBoundSpanAsync=async function(i,s){if(isVueFile(i)){const o=(0,utils_1.initializeMode)(e,n,r,i,s,"completions","definitions",!1);if(o){const e=o.mode,r=o.eFile,s=o.mappedRange,a=o.sourceMap,l=await e.getDefinitionAndBoundSpanAsync(t,r.fileName,i,s[0].start);if(!l)return;if(!l.definitions)return;if(!l.textSpan)return;if(0===l.definitions.length)return;if(!a.getSourceRange(l.textSpan.start))return;return{textSpan:(0,utils_1.virtualToRealityFromRange)(a,l.textSpan),definitions:l.definitions.map((e=>{const t=n.getEmbeddedFileInfo(e.fileName);if((null==t?void 0:t.host.fileName)===e.fileName)return e;if(!t)return e;const i=t.file.sourceMap;if(!i)return e;const r=t.host.fileName;return{...e,fileName:r,textSpan:(0,utils_1.virtualToRealityFromRange)(i,e.textSpan),contextSpan:(0,utils_1.virtualToRealityFromRange)(i,e.contextSpan)}}))}}}return t.getDefinitionAndBoundSpanAsync(i,s)},i.getQuickInfoAtPositionAsync=async function(i,s){var o;if(isVueFile(i)){const a=(0,utils_1.initializeMode)(e,n,r,i,s,"completions","basic",!1);if(!a)return;const l=a.mode,c=a.eFile,u=a.mappedRange,p=a.sourceMap,f=await l.getQuickInfoAtPositionAsync(t,c.fileName,u[0].start);if(!f)return;if(f.kind===e.ts.ScriptElementKind.jsxAttribute&&(0,core_1.pathIsPath)(c.fileName,i+".__VLS_template.tsx")){let e="";null===(o=f.displayParts)||void 0===o||o.forEach((t=>{e+=t.text}));let t=/(?<=\()JSX\s*(?=attribute\))/;t.test(e)&&(e=e.replace(t,""),f.displayParts=[{kind:"text",text:e}])}const d=p.getSourceRange(f.textSpan.start);return{...f,textSpan:{start:d?d[0].start:f.textSpan.start,length:f.textSpan.length}}}return t.getQuickInfoAtPositionAsync(i,s)},i.getSignatureHelpItems=function(i,s,o){if(isVueFile(i)){const a=(0,utils_1.initializeMode)(e,n,r,i,s,"completions","completion",!1);if(!a)return;const l=a.mode,c=a.eFile,u=a.mappedRange,p=a.sourceMap,f=l.getSignatureHelpItems(t,c.fileName,u[0].start,o);if(!f)return;const d=(0,utils_1.virtualToRealityFromRange)(p,f.applicableSpan);return d&&(f.applicableSpan=d),f}return t.getSignatureHelpItems(i,s,o)},i.getSyntacticDiagnosticsAsync=async function(e){if(isVueFile(e)){const t=n.getUpToDateInfo(e);if(!t)return[];const i=t.sourceFile.getAllEmbeddeds();if(!i)return[];const s=[];for(let t of i){if(!t.file.capabilities.diagnostics)continue;const i=(0,utils_1.getModeAtEmbeddedFile)(r,t.file.fileName);if(!i)continue;const n=await i.getSyntacticDiagnosticsAsync(t.file.fileName,e);if(!n)continue;const o=t.sourceMap;n.forEach((e=>{const t=o.getSourceRange(e.start,e.start+e.length);t&&t[1].capabilities.diagnostic&&s.push({...e,start:t[0].start})}))}return s}return t.getSyntacticDiagnostics(e)},i.getSemanticDiagnosticsAsync=async function(e){if(isVueFile(e)){const i=n.getUpToDateInfo(e);if(!i)return[];const r=i.sourceFile.getAllEmbeddeds();if(!r)return[];const s=[];for(let e of r){if(!e.file.isTsHostFile||!e.file.capabilities.diagnostics)continue;const i=await t.getSemanticDiagnosticsAsync(e.file.fileName);if(!i)continue;const n=e.sourceMap;i.forEach((t=>{if(!t)return;const i=n.getSourceRange(t.start,t.start+t.length);if(i&&i[1].capabilities.diagnostic){let n="string"==typeof t.messageText?t.messageText:t.messageText.messageText;n=n.replace(/__VLS_CurrentPageType/g,"VueInstance"),t.source=(0,path_1.extname)(e.file.fileName),s.push({...t,messageText:n,start:i[0].start})}}))}return s}return t.getSemanticDiagnostics(e)},i.getSuggestionDiagnosticsAsync=async function(e){if(isVueFile(e)){const i=n.getUpToDateInfo(e);if(!i)return[];const r=i.sourceFile.getAllEmbeddeds();if(!r)return[];const s=[];for(let e of r){if(!e.file.isTsHostFile||!e.file.capabilities.diagnostics)continue;const i=await t.getSuggestionDiagnosticsAsync(e.file.fileName);if(!i)continue;const n=e.sourceMap;i.forEach((t=>{const i=n.getSourceRange(t.start,t.start+t.length);t.source=(0,path_1.extname)(e.file.fileName),i&&i[1].capabilities.diagnostic&&s.push({...t,start:i[0].start})}))}return s}return t.getSuggestionDiagnostics(e)},i.findReferencesAsync=async function(i,s){if(isVueFile(i)){const o=(0,utils_1.initializeMode)(e,n,r,i,s,"completions","references",!1);if(!o)return;const a=o.mode,l=o.eFile,c=o.mappedRange,u=(o.sourceMap,await a.findReferencesAsync(t,l.fileName,i,c[0].start));if(!u)return;if(0===u.length)return;if("javascript"===(0,utils_1.getModeLang)(l.fileName)){return u.map((e=>(e.definition,e.references=e.references.map((e=>{let t=e.fileName,i=n.getEmbeddedFileInfo(t);if(i&&i.file){e.fileName=i.host.fileName;let t=i.file.sourceMap;e.contextSpan=(0,utils_1.virtualToRealityFromRange)(t,e.contextSpan),e.textSpan=(0,utils_1.virtualToRealityFromRange)(t,e.textSpan),e.originalContextSpan=(0,utils_1.virtualToRealityFromRange)(t,e.originalContextSpan)}return e})),e)))}return u}return t.findReferencesAsync(i,s)},i.getFileReferencesAsync=async function(i){if(isVueFile(i)){const t=await s.getFileReferencesAsync(e.project,i,e);return t||[]}return t.getFileReferencesAsync(i)},i.getCodeFixesAtPosition=function(i,s,o,a,l,c){var u,p,f;if(isVueFile(i)){const d=(0,utils_1.initializeMode)(e,n,r,i,s,"completions","completion",!1);if(!d)return[];d.mode;const g=d.eFile,m=(d.mappedRange,d.sourceMap),v=m.getMappedRange(s,o);if(!v)return[];const h=[...t.getCodeFixesAtPosition(g.fileName,v[0].start,v[0].end,a,l,c)];if(g.fileName===i+".__VLS_template.tsx"&&(a.includes(2339)||a.includes(2551))){const _=t.getProgram();if(_){const y=i+".ts",S=_.getSourceFile(y),x=_.getSourceFile(g.fileName);if(x&&S){const T=e.ts.getTokenAtPosition(x,v[0].start),b=T.getText(),F=_.getTypeChecker().getSymbolAtLocation(S),P=null===(u=null==F?void 0:F.exports)||void 0===u?void 0:u.get("default");let j=null===(p=null==P?void 0:P.valueDeclaration)||void 0===p?void 0:p.getChildren();const M=null==j?void 0:j.find((t=>{if(e.ts.isCallExpression(t))return!!t.expression.getText().indexOf("defineComponent")})),E=null==M?void 0:M.arguments[0];if(E){let A="",R="",N="",V=0;if(D(T)){A="add method",R=`Add missing method decalration '${b}'`;let H=!1,k=!1;for(let I of E.properties)if(e.ts.isPropertyAssignment(I)){const U=I;if("methods"===U.name.getText()){H=!0;const $=w(U.initializer);N=`${$.needComma?",":""}\n${$.indentText}${b}(){\n${$.indentText}    throw new Error('method not implemented.');\n${$.indentText}}`,V=$.insertPos}}else if(e.ts.isMethodDeclaration(I)){if("setup"===I.name.getText()){k=!0;break}}if(!H){const O=w(E);N=`${O.needComma?",":""}\n${O.indentText}methods:{\n${O.indentText}    ${b}(){\n${O.indentText}        throw new Error('method not implemented.');\n${O.indentText}    }\n${O.indentText}}`,V=O.insertPos}k||L()}else{A="add property",R=`Add missing property decalration '${b}'`;let q=!1,B=!1;for(let K of E.properties)if(e.ts.isMethodDeclaration(K)){const X=K;if("data"===X.name.getText()){q=!0;let z=!1;if(null===(f=X.body)||void 0===f||f.statements.forEach((t=>{if(e.ts.isReturnStatement(t)&&t.expression&&e.ts.isObjectLiteralExpression(t.expression)){z=!0;const e=w(t.expression);N=`${e.needComma?",":""}\n${e.indentText}${b}: ""`,V=e.insertPos}})),!z){const W=C(X,"data");N=`\n${W}    return {\n${W}        ${b}: ""\n${W}    }\n${W}`,V=X.body.end-1}}if("setup"===X.name.getText()){B=!0;break}}if(!q){const Q=w(E);N=`${Q.needComma?",":""}\n${Q.indentText}data(){\n${Q.indentText}    return{\n${Q.indentText}        ${b}: ""\n${Q.indentText}    }\n${Q.indentText}}`,V=Q.insertPos}B||L()}function D(t){let i=!1,n=!1,r=!1,s=!1,o=!1,a=t;for(;a;)e.ts.isIdentifier(a)?i=!0:i&&e.ts.isPropertyAccessExpression(a)?n=!0:n&&e.ts.isPropertyAssignment(a)?r=!0:r&&e.ts.isObjectLiteralExpression(a)?s=!0:s&&e.ts.isVariableDeclaration(a)&&(o=!0),a=a.parent;return i&&n&&r&&s&&o}function C(e,t){try{let i=new RegExp(`(.*)(?=${t})`).exec(e.getFullText());if(i&&i.length>0){let e=i[0],t=/[^\\t\s].*/.exec(e);if(!(t&&t.length>0))return i[0];{let n=t[0];if(i=new RegExp(`(.*)(?=${n})`).exec(e),i&&i.length>0)return i[0]}}}catch(e){}return"\t"}function w(e){const t=e.properties.length>0;let i,n;if(t){const t=e.properties[e.properties.length-1];i=C(t,t.name.getText()),n=t.end}else i=C(e,"}")+"    ",n=e.properties.pos;return{needComma:t,indentText:i,insertPos:n}}function L(){h.push({fixName:A,description:R,changes:[{fileName:y,textChanges:[{newText:N,span:{start:V,length:0}}]}]})}}}}}return h.forEach((e=>{e.changes.forEach((e=>{e.textChanges.forEach((t=>{var i;const r=null===(i=n.getEmbeddedFile(e.fileName))||void 0===i?void 0:i.sourceMap,s=(0,utils_1.virtualToRealityFromRange)(r||m,t.span);s&&(t.span=s)})),e.fileName=i}))})),h}return t.getCodeFixesAtPosition(i,s,o,a,l,c)},i}(i),i}const TsServerVuePlugin={create(e){const t=Object.create(null),i=e.languageService;for(let e of Object.keys(i)){const n=i[e];t[e]=(...e)=>n.apply(i,e)}return t.getDefinitionAndBoundSpanAsync=async function(t,n){var r;const s=g_vueCachesByHost.get(e.languageServiceHost),o=await(null===(r=i.getDefinitionAndBoundSpanAsync)||void 0===r?void 0:r.call(i,t,n));return s&&o&&o.definitions&&(o.definitions=o.definitions.map((e=>{if("script"===e.kind&&s.hasEmbeddedFile(e.fileName)){let t=s.getEmbeddedFileInfo(e.fileName);if(t){let i=t.file.sourceMap;return{...e,fileName:t.host.fileName,textSpan:(0,utils_1.virtualToRealityFromRange)(i,e.textSpan),contextSpan:(0,utils_1.virtualToRealityFromRange)(i,e.contextSpan)}}}return e}))),o},t.getFileReferencesAsync=async function(t){var n;const r=await(null===(n=i.getFileReferencesAsync)||void 0===n?void 0:n.call(i,t));if(!r)return[];if(t.endsWith("js")||t.endsWith("ts")){const i=[];r.forEach((e=>{e.fileName.endsWith("vue")||i.push(e)}));const n=await(0,core_1.createFileRefDataFromIndex)(e.project,t),s=(0,core_1.fromLspFileReferences)(e,n);return s?(i.push(...s),i):i}return r},t},createExtService:e=>create(e),createTypeCheckerPlugins:e=>[(0,vueTypeCheckerHelper_1.createVueOptionsTypeChecker)(e),(0,vueTypeCheckerHelper_1.createVueThisTypeChecker)(e)]};exports.TsServerVuePlugin=TsServerVuePlugin;
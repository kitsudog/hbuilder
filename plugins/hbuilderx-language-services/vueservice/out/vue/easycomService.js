"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s);var o=Object.getOwnPropertyDescriptor(t,s);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,n,o)}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.fetchVueComponentInfo=exports.onlyCollectEasycoms=exports.collectEasycoms=exports.findImportComponents=exports.findEasycomByTag=void 0;const fs=__importStar(require("fs")),jsonc_1=require("jsonc"),path=__importStar(require("path")),vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),vscode_uri_1=require("vscode-uri"),core_1=require("../../../core"),serviceTypes_1=require("../serviceTypes");function visitFiles(e,t){if(!fs.existsSync(e))return;if(fs.statSync(e).isDirectory()){let s=fs.readdirSync(e);for(let n of s){fs.statSync(path.join(e,n)).isDirectory()?visitFiles(path.join(e,n),t):t(path.join(e,n))}}}function scanComponents(e){let t=[];if(!fs.existsSync(e))return t;if(fs.statSync(e).isDirectory()){let s=fs.readdirSync(e);for(let n of s){if(!fs.statSync(path.join(e,n)).isDirectory())continue;let s=[".vue",".nvue",".uvue"];for(let o of s){let s=path.join(e,n,n+o);if(fs.existsSync(s)){t.push({name:n,filePath:s});break}}}}return t}function collectRuleRegexGroups(e){let t=new Map,s=0,n=-1;for(let o=0;o<e.length;o++){let i=e.charAt(o);"("==i?(s++,n=o):")"==i&&(-1!=n&&o>n&&t.set(s,{start:n,end:o+1}),n=-1)}return t}function buildGroupMappings(e,t){let s=new Map;if(t.size>0){let n="\0",o=0;for(let i=0;i<e.length;i++){let r=e.charAt(i);if(r>="0"&&r<="9"&&"$"==n){let e=Number.parseInt(r);t.has(e)&&(o++,s.set(o,e))}n=r}}return s}function scanAllEasycomByCustomRule(e,t,s,n,o,i){let r=[],a=new RegExp(e),c=e.split("/"),l=i.fsPath;for(;c.length>0;){let e=c.shift(),t=path.join(l,e);if(!fs.existsSync(t))break;l=t}return visitFiles(l,(e=>{let c=path.relative(i.fsPath,e),l=a.exec(c.replace(/\\/g,"/"));if(l){const e=[],a=new Map;for(let t=1;t<l.length;t++)if(o.has(t)){let s=l[t],i=o.get(t),r=n.get(i);e.find((e=>e.start==r.start&&e.end==r.end))||e.push({start:null==r?void 0:r.start,end:null==r?void 0:r.end,newText:s}),a.set(i,s)}e.sort(((e,t)=>t.start-e.start));let c=t;for(let t of e)c=c.substring(0,t.start)+t.newText+c.substring(t.end);let f=s;a.forEach(((e,t)=>{f=f.replace(new RegExp("\\$"+t,"g"),e)})),f=path.join(i.fsPath,f),c.length>0&&fs.existsSync(f)&&(c.startsWith("^")&&(c=c.substring(1)),/^[A-Za-z][A-Za-z0-9\-_]+$/.test(c)&&r.push({name:c,filePath:f}))}return!0})),r}function findAutoEasycomPriorityByProject(e,t){const s=[];let n=[".vue",".nvue"];(0,core_1.isUniAppXProject)(t)&&(n=[".uvue",".vue"]);const o=path.join(t.sourceRoot,"uni_modules"),i=fs.existsSync(o);let r=[];return i&&(r=fs.readdirSync(o)),n.forEach((n=>{const i=path.join(t.sourceRoot,"components",e,e+n);s.push(i);for(let t of r){const i=path.join(o,t,"components",e,e+n);s.push(i)}})),s}function findEasycomByTag(e,t,s,n){if(!e)return;let o=findImportComponents(t,s,n).find((t=>t.name===e));if(o)return o;if(o=findUtsComponents(n).find((t=>t.name===e)),o)return o;let i=getEasycomConfigOptions(n),r=[];if(i.custom)for(let t in i.custom){let s=i.custom[t];if("string"!=typeof s)continue;let o=new RegExp(t).exec(e);if(o){for(let e=1;e<o.length;e++)s=s.replace(new RegExp("\\$"+e,"g"),o[e]);s=s.startsWith("@/")?path.join(n.sourceRoot,s.substring(2)):path.join(n.fsPath,"node_modules",s),r.push(s)}}if(i.autoscan){const t=findAutoEasycomPriorityByProject(e,n);r.push(...t)}for(let t of r)if(fs.existsSync(t))return{name:e,filePath:t}}function getEasycomConfigOptions(e){let t=e.sourceRoot,s=path.join(t,"pages.json"),n={autoscan:!0,custom:{}};if(fs.existsSync(s)){let e;try{e=jsonc_1.jsonc.readSync(s)}catch(e){return console.error(e),n}if(e.easycom&&e.easycom instanceof Object&&null!==e.easycom)for(let t in n)t in e.easycom&&(n[t]=e.easycom[t])}return n}function findImportComponents(e,t,s){var n,o;let i=[];if(null==s)return i;let r=parseVuePageInstanceOptions(e,t);if(r){let t=r.options.find((e=>{if(core_1.ts.isIdentifier(e.name)){return"components"===e.name.escapedText}return"components"===e.name.getText()})),a=null==t?void 0:t.initializer;if(a&&core_1.ts.isObjectLiteralExpression(a)){let t=new Map;for(let e of r.sourceFile.statements)if(core_1.ts.isImportDeclaration(e)){let s=e,i=null===(o=null===(n=s.importClause)||void 0===n?void 0:n.name)||void 0===o?void 0:o.getText(),r=s.moduleSpecifier;if(i&&r&&core_1.ts.isStringLiteral(r)){let e=r.text;t.set(i,e)}}a.properties.forEach((n=>{var o;let r=null===(o=n.name)||void 0===o?void 0:o.getText();if(r){let n="";if(t.has(r)){let o=t.get(r);if(o.startsWith("@/"))n=s.kind===core_1.HXProjectKind.UniApp||s.kind===core_1.HXProjectKind.UniApp_Cli?path.join(s.fsPath,o.substring(2)):path.join(s.fsPath,"src",o.substring(2));else{let t=e.uri,s=path.dirname(t.startsWith("file:/")?vscode_uri_1.URI.parse(t).fsPath:t);n=path.resolve(s,o)}if(!n.endsWith(".vue")&&!n.endsWith(".nvue")&&!n.endsWith(".uvue"))for(let e of[".vue",".nvue",".uvue"])if(fs.existsSync(n+e)){n+=e;break}}i.push({name:r,filePath:fs.existsSync(n)?n:""});let o=r.replace(/([A-Z])/g,"-$1").toLowerCase();i.push({name:o.startsWith("-")?o.substring(1):o,filePath:fs.existsSync(n)?n:""})}}))}}return i}function collectEasycoms(e,t,s){let n=[];if(null==s)return n;let o=findImportComponents(e,t,s);return n.push(...o),n.push(...findEasycoms(s)),n}function onlyCollectEasycoms(e){let t=[];return null==e||t.push(...findEasycoms(e)),t}function findEasycoms(e){let t=[];if(null==e)return t;t.push(...findUtsComponents(e));let s=getEasycomConfigOptions(e),n=s.custom;for(let s in n){let o=n[s];if("string"!=typeof o)continue;let i=collectRuleRegexGroups(s),r=buildGroupMappings(o,i),a=o;if(i.forEach(((e,t)=>{let n=s.substring(e.start,e.end);a=a.replace(new RegExp("\\$"+t,"g"),n)})),a.startsWith("@/")){scanAllEasycomByCustomRule(a.substr(2),s,o.substr(2),i,r,e).forEach((e=>{t.push(e)}))}else{scanAllEasycomByCustomRule("node_modules/"+a,s,"node_modules/"+o,i,r,e).forEach((e=>{t.push(e)}))}}if(s.autoscan){scanComponents(path.join(e.sourceRoot,"components")).forEach((e=>{t.push(e)}));let s=path.join(e.sourceRoot,"uni_modules");if(fs.existsSync(s)){let e=fs.readdirSync(s);for(let n of e){scanComponents(path.join(s,n,"components")).forEach((e=>{t.push(e)}))}}}let o=new Map;t.forEach((e=>{o.set(`${e.name}@${e.filePath}`,e)}));let i=[];return o.forEach(((e,t)=>{i.push(e)})),i}function parseVuePageInstanceOptions(e,t){if(!t)return;let s=t.roots.find((e=>"script"===e.tag));if(s){let t={options:[]},n=s.attributes&&"setup"in s.attributes,o=e.positionAt(s.startTagEnd),i=e.positionAt(s.endTagStart),r=e.getText({start:o,end:i}),a=core_1.ts.createSourceFile(e.uri,r,core_1.ts.ScriptTarget.Latest,!0,core_1.ts.ScriptKind.TS);if(t.sourceFile=a,n){if(a.statements&&a.statements.length>0){let e=a.statements[0].jsDoc;e&&e.length>0&&(t.vuedoc=e[0]);let s=[];if(a.statements.forEach((e=>{var t,n;if(core_1.ts.isImportDeclaration(e)){let o=e,i=o.moduleSpecifier;if(core_1.ts.isStringLiteral(i)){let e=i;if(e.text&&core_1.fileTypesTool.isUniAppOrUniAppXVueFile(e.text)){if(null===(n=null===(t=o.importClause)||void 0===t?void 0:t.name)||void 0===n?void 0:n.getText()){let e=o.importClause.name;s.push(core_1.ts.factory.createPropertyAssignment(e,e))}}}}})),s.length>0){let e=core_1.ts.factory.createObjectLiteralExpression(s);t.options.push(core_1.ts.factory.createPropertyAssignment("components",e))}}}else{let e=a.statements.find(core_1.ts.isExportAssignment);if(e){let s=e.jsDoc;s&&s.length>0&&(t.vuedoc=s[0]);let n=e.expression;if(n&&core_1.ts.isObjectLiteralExpression(n)){n.properties.forEach((e=>{if(e&&e.kind==core_1.ts.SyntaxKind.PropertyAssignment){let s=e;t.options.push(s)}}))}}}return t}}function fetchVueComponentInfo(e){if(!fs.existsSync(e))return;let t=(0,serviceTypes_1.getHTMLLanguageService)(),s=vscode_languageserver_textdocument_1.TextDocument.create(e,"html",1,fs.readFileSync(e).toString()),n=parseVuePageInstanceOptions(s,t.parseHTMLDocument(s));if(n){let t=new Map,s=new Map,o={filePath:e,properties:[],events:[]};if(n.options.length>0){let e=n.options.find((e=>{var t;return core_1.ts.isIdentifier(e.name)?"props"===e.name.escapedText:"props"===(null===(t=e.name)||void 0===t?void 0:t.getText())}));if(e){let s=e.initializer;if(core_1.ts.isObjectLiteralExpression(s)){s.properties.forEach((e=>{var s;let n=null===(s=e.name)||void 0===s?void 0:s.getText();if(n&&e.name&&core_1.ts.isStringLiteralLike(e.name)&&(n=n.substring(1,n.length-1)),n){let s=e.initializer,o="";if(core_1.ts.isIdentifier(s))o=s.getText();else if(core_1.ts.isObjectLiteralExpression(s)){let e=s.properties.find((e=>{var t;return"type"===(null===(t=e.name)||void 0===t?void 0:t.getText())}));e&&(o=e.initializer.getText())}t.set(n,{name:n,type:o})}}))}}let o=n.options.find((e=>{var t;return core_1.ts.isIdentifier(e.name)?"emits"===e.name.escapedText:"emits"===(null===(t=e.name)||void 0===t?void 0:t.getText())}));if(o){let e=o.initializer;if(e&&core_1.ts.isArrayLiteralExpression(e)){e.elements.forEach((e=>{if(core_1.ts.isStringLiteral(e)){let t=e.text;s.set(t,{name:t,description:""})}}))}}}let i=n.vuedoc;if(i){let e,n,r=i.comment;if(i.tags){let o;for(let a of i.tags){let i=a.tagName.getText();if("description"!==i){if("tutorial"===i)e=a.comment;else if("property"===i){let e=a.comment;if(e){let s=/\s*{(.*)}\s+(\w+)\s*=\s*\[(.*)\]\s+(.*)/.exec(e);if(s){let e=s[1],n=s[2],i=s[3],r=s[4],a=new Map;i.split("|").forEach((e=>{a.set(e,{value:e})})),t.set(n,{name:n,type:e,description:r,values:a}),o=n}else{let s=/\s*{(.*)}\s+(\w+)\s+(.*)/.exec(e);if(s){let e=s[1],n=s[2],i=s[3];t.set(n,{name:n,type:e,description:i}),o=n}}}}else if("value"===i){let e=a.comment;if(e&&o&&t.has(o)){let s=/\s*(\w+)\s+(.*)/.exec(e);if(s){let e=s[1],n=s[2],i=t.get(o);i.values||(i.values=new Map),i.values.set(e,{value:e,description:n})}}}else if("event"===i){let e=a.comment;if(e){let t=/\s*{(.*)}\s+(\w+)\s+(.*)/.exec(e);if(t){t[1];let e=t[2],n=t[3];s.set(e,{name:e,description:n})}}}else"example"===i&&(n=a.comment);"property"!=i&&"value"!=i&&(o=void 0)}else r=a.comment}}o.description=r,o.example=n,o.tutorial=e}return t.forEach((e=>{var t;null===(t=o.properties)||void 0===t||t.push(e)})),s.forEach((e=>{var t;null===(t=o.events)||void 0===t||t.push(e)})),o}}exports.findEasycomByTag=findEasycomByTag,exports.findImportComponents=findImportComponents,exports.collectEasycoms=collectEasycoms,exports.onlyCollectEasycoms=onlyCollectEasycoms,exports.fetchVueComponentInfo=fetchVueComponentInfo;const PLATFORMS=["app-android","app-ios","web","mp-alipay","mp-baidu","mp-jd","mp-kuaishou","mp-lark","mp-qq","mp-toutiao","mp-weixin","mp-xhs"],utsComponentsCache=new Map,utsComponentsFile=new Map;function findUtsComponents(e){if(utsComponentsCache.has(e.fsPath))return[...utsComponentsCache.get(e.fsPath)];const t=path.join(e.sourceRoot,"uni_modules");if(fs.existsSync(t)){const s=new Set;utsComponentsCache.set(e.fsPath,s);return fs.readdirSync(t).forEach((e=>{const r=path.join(t,e);if(n(r)){i(path.join(r,"utssdk")).forEach((t=>{let n=a(t);const i=u(t);if(i){let e={name:i,filePath:t};s.add(e),utsComponentsFile.set(t,{version:f(t),watcher:n})}else if(o(r,t)){let o={name:e,filePath:t};s.add(o),utsComponentsFile.set(t,{version:f(t),watcher:n})}}))}})),r(),[...s];function n(e){for(let t=0;t<PLATFORMS.length;++t){const s=path.join(e,"utssdk",PLATFORMS[t],"index.vue");if(fs.existsSync(s))return!0}return!1}function o(e,t){for(let s=0;s<PLATFORMS.length;++s){if(path.join(e,"utssdk",PLATFORMS[s],"index.vue")==t)return!0}return!1}function i(e){const t=[];if(fs.existsSync(e)){const s=fs.readdirSync(e);for(let n=0;n<s.length;++n){const o=s[n],r=path.join(e,o);fs.statSync(r).isDirectory()?t.push(...i(r)):o.endsWith(".vue")&&t.push(r)}}return t}function r(){fs.watch(t,{recursive:!0},((e,r)=>{const p=path.join(t,r);if(fs.existsSync(p)){if(p.endsWith(".vue")&&!utsComponentsFile.has(p)){if(d(p)){const e=h(p);if(e){const t=a(p);if(o(e,p)){const n=u(p),o={name:n||m(e),filePath:p};s.add(o),utsComponentsFile.set(p,{version:f(p),watcher:t})}else{const e=u(p);if(e){const n={name:e,filePath:p};s.add(n),utsComponentsFile.set(p,{version:f(p),watcher:t})}}}}}else if(n(p)){i(path.join(p,"utssdk")).forEach((e=>{var t;const n=f(p);if(utsComponentsFile.has(p)&&(null===(t=utsComponentsFile.get(p))||void 0===t?void 0:t.version)===n)return;const o=u(e);c(e);let i=a(p);if(o){const t={name:o,filePath:e};s.add(t),utsComponentsFile.set(t.filePath,{version:n,watcher:i})}}))}}else l(r)}))}function a(e){return fs.watch(e,((t,n)=>{if(fs.existsSync(e)){const t=u(e);if(t){const n={name:t,filePath:e};c(e,!1),s.add(n);let o=utsComponentsFile.get(e);o.version=f(e),utsComponentsFile.set(e,o)}}else c(e)}))}function c(e,t=!0){if(t){let t=utsComponentsFile.get(e);null==t||t.watcher.close()}utsComponentsFile.delete(e),s.forEach((t=>{t.filePath===e&&s.delete(t)}))}function l(t,n=!0){const o=path.join(e.fsPath,"uni_modules",t,"utssdk");s.forEach((e=>{if(e.filePath.startsWith(o)){if(n){let t=utsComponentsFile.get(e.filePath);null==t||t.watcher.close()}utsComponentsFile.delete(e.filePath),s.delete(e)}}))}function f(e){return fs.statSync(e).mtime.toString()}function u(e){const t=fs.readFileSync(e).toString();try{const e=/export\s+default\s+[\s\S]*?name\s*:\s*['|"](.*?)['|"]/.exec(t);if(e&&e.length>1)return e[1]}catch(e){}}function p(e){try{if(/(?<=(\/|\\)uni_modules(\/|\\))\.*/g.test(e))return!0}catch(e){}return!1}function m(e){try{let t=/(?<=(\/|\\)uni_modules(\/|\\))\.*[^\/\\]*/g,s=e.match(t);if(s&&s.length>0)return s[0]}catch(e){}}function h(e){let t=m(e);if(t)try{let s=new RegExp(`.*uni_modules(/|\\\\)(?=${t})`),n=e.match(s);if(n&&n.length>0){let e=n[0];return path.join(e,t)}}catch(e){}}function d(t){if(p(t)){const e=h(t);if(e){const t=path.join(e,"utssdk");return fs.existsSync(t)&&fs.statSync(t).isDirectory()}}else{let s=path.join(e.sourceRoot,"utssdk");if(fs.existsSync(s)){let e=fs.readdirSync(s);for(let n of e)if(t.startsWith(path.join(s,n)))return!0}}return!1}}return[]}
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.FileData=void 0;const fs=require("fs-extra"),md5=require("md5"),path=require("path"),core_1=require("../../../../../core");class FileData{constructor(e,t,i,a){this._needSaveFlag=!1,this._forceSaveFlag=!1,this._projectUri=e,this._fileVersion=t,this._oldDiskPath=i,this._newDiskPath=a}get indexData(){return this._indexData}setIndexData(e){this._indexData=e}setForceSaveFlag(e){this._forceSaveFlag=e}updateIndexData(e,t){const i=this._fileVersion.getProjectVersion();if(!this._indexData){const e=this._projectUri;let t={canonicalVersion:core_1.CanonicalVersion,projectVersion:i,projectUri:e,kindMap:new Map};this._indexData=t}for(const i of t.kindMap.keys()){const a=t.kindMap.get(i);if(!a)continue;if(!this._indexData.kindMap.has(i)){this._indexData.kindMap.set(i,a);continue}const n=a.get(e);if(!n)continue;const s=this._indexData.kindMap.get(i);s&&s.set(e,n)}this._needSaveFlag=!0}getNeedDeleteList(e){if(!this._indexData)return;let t=[];for(const i of this._indexData.kindMap.keys()){const a=this._indexData.kindMap.get(i);if(a)for(const n of a.keys()){const a=n===e;if(e.endsWith("/")||(e+="/"),a||n.startsWith(e)){const e={kind:i,fileUri:n};t.push(e)}}}return t}removeIndexDataFromUri(e){if(!this._indexData)return;const t=this.getNeedDeleteList(e);t&&(t.forEach((e=>{const t=this._indexData.kindMap.get(e.kind);t&&(t.delete(e.fileUri),this._fileVersion.deleteFileVersion(e.fileUri))})),this._needSaveFlag=!0)}removeIndexData(){const e=this._projectUri;this._indexData=void 0;const t=md5(e).toLowerCase(),i=path.join(this._oldDiskPath,t),a=path.join(this._newDiskPath,t);fs.existsSync(i)&&fs.removeSync(i),fs.existsSync(a)&&fs.removeSync(a)}async saveIndexData(){if(!this._needSaveFlag)return;if(!this._indexData)return;const e=this._indexData,t=this._projectUri,i=md5(t).toLowerCase(),a=path.join(this._newDiskPath,i);fs.existsSync(a)||fs.mkdirSync(a);for(const i of e.kindMap.keys()){let n=e.kindMap.get(i);if(!n||0===n.size)continue;const s=(0,core_1.mapToObj)(n);let o={canonicalVersion:e.canonicalVersion,projectVersion:e.projectVersion,projectUri:e.projectUri,data:s};const r=path.join(a,i);(0,core_1.getObjectSize)(o)>267386880&&((0,core_1.deleteSaveObjectItem)(o),console.error(`[IndexServer] 存储索引数据时, 数据大小超出了node的限制! 项目路径: ${(0,core_1.noTsToNormalizedPath)(t)}`,"ERROR"));let c=JSON.stringify(o);fs.writeFileSync(r,c)}this._needSaveFlag=!1}async forceSaveIndexData(){this._forceSaveFlag&&(await this.saveIndexData(),this._forceSaveFlag=!1)}queryIndexData(e){if(!this._indexData)return;return(0,core_1.filterIndexData)(e,this._indexData)}}exports.FileData=FileData;
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.createFileIndexProcessor=void 0;const ts=require("typescript"),vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),core_1=require("../../../core"),utils_1=require("../../../utils"),utils_2=require("./utils"),vueCustomDirectivesProc_1=require("./vueCustomDirectivesProc"),vueRouterProc_1=require("./vueRouterProc"),vuexProc_1=require("./vuexProc");let docVersion=0;function getLanguageSerivceHost(){let e=vscode_languageserver_textdocument_1.TextDocument.create("init","javascript",1,"");const t={get version(){return""+(e.version+docVersion)},get compilerOptions(){return{allowNonTsExtensions:!0,allowJs:!0,lib:["lib.es6.d.ts"],target:ts.ScriptTarget.Latest,moduleResolution:ts.ModuleResolutionKind.Classic,experimentalDecorators:!1}},get documents(){return[e.uri]},getDocumentSnapshot(t){let r="";return t===e.uri&&(r=e.getText()),{getText:(e,t)=>r.substring(e,t),getLength:()=>r.length,getChangeRange:()=>{}}},getDocumentVersion:t=>t==e.uri?""+(e.version+docVersion):"1",hasDocument:t=>t==e.uri};return{getLanguaserService(r,s){e=r,docVersion++;let o=utils_1.hx.getProject(s.uri);if(o)return o.createTSLanguageService(t)}}}function mergeIndexData(e,t){e.categories.forEach((r=>{-1===t.categories.indexOf(r)&&(t.categories.push(r),t[r]=[]);let s=e[r];s.length>0&&t[r].push(...s)})),t.references.push(...e.references)}const host=getLanguageSerivceHost();class JavascriptIndexProcessor extends core_1.IndexProcessor{constructor(){super(...arguments),this.lastUri="",this.lastProcTime=-1,this.astIndexProcs=[]}getProcessorID(){return"script"}isSupportIndexer(e,t){if(this.lastUri&&t.uri==this.lastUri&&process.uptime()-this.lastProcTime<1)return!1;if(this.lastUri="","javascript"==t.languageId||"javascript_es6"==t.languageId)return!0;return t.uri.toLowerCase().endsWith(".js")}async createIndexData(e,t){}searchAst(e,t,r){function s(e){let t=e.getChildren(),r=t.findIndex((e=>e.kind==ts.SyntaxKind.NewKeyword));if(r>=0){let e=t[r+1];if(e)switch(e.kind){case ts.SyntaxKind.Identifier:case ts.SyntaxKind.PropertyAccessExpression:return e}}}let o=this;if(0!=o.astIndexProcs.filter((e=>e.onCallExpression||e.onNewExpression)).length)return function t(n,i){if(i<10){const a=n.getChildren();for(let n=0;n<a.length;n++){let c=a[n],u=utils_2.tsConvert.asTsNewExpression(a[n]);if(u){let t=s(u);t&&o.astIndexProcs.forEach((s=>{var o;let n=null===(o=s.onNewExpression)||void 0===o?void 0:o.call(s,e,u,t);n&&mergeIndexData(n,r)}))}let l=utils_2.tsConvert.asTsCallExpression(a[n]);l&&o.astIndexProcs.forEach((t=>{var s;let o=null===(s=t.onCallExpression)||void 0===s?void 0:s.call(t,e,l);o&&mergeIndexData(o,r)})),t(c,i+1)}}}(t,0)}doIndex(e,t,r){if(!t)return new core_1.IndexData;let s={source:r,ws:t};if(this.astIndexProcs=[],[(0,vueRouterProc_1.getVueRouterIndexProc)(t),(0,vuexProc_1.getVuexIndexProc)(t),(0,vueCustomDirectivesProc_1.getVueDirectivesProc)(t)].forEach((t=>{t.support(e,s)&&this.astIndexProcs.push(t)})),0===this.astIndexProcs.length)return new core_1.IndexData;let o=new core_1.IndexData,n=host.getLanguaserService(e,t);if(n){let t=n.getProgram(),r=(t.getTypeChecker(),t.getSourceFile(e.uri));if(r){for(let t=0;t<r.statements.length;t++){let s=r.statements[t];switch(s.kind){case ts.SyntaxKind.ImportDeclaration:{let t=s;this.astIndexProcs.forEach((r=>{var s;let n=null===(s=r.onImportDeclaration)||void 0===s?void 0:s.call(r,e,t);n&&mergeIndexData(n,o)}))}break;case ts.SyntaxKind.ExportAssignment:{let t=s;this.astIndexProcs.forEach((r=>{var s;let n=null===(s=r.onExportAssignment)||void 0===s?void 0:s.call(r,e,t);n&&mergeIndexData(n,o)}))}}}this.searchAst(e,r,o)}}return this.lastUri=e.uri,this.lastProcTime=process.uptime(),o}}function createFileIndexProcessor(){return new JavascriptIndexProcessor}exports.createFileIndexProcessor=createFileIndexProcessor;
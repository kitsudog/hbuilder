"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getJsonNodeRange=void 0;const fs=require("fs"),vscode=require("vscode"),vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),vscode_uri_1=require("vscode-uri"),core_1=require("../../../core"),schemaManager_1=require("./schemaManager");function toNumber(e){if(/^[0-9]+$/.test(e))return Number(e)}function getResult(e,r,o,t){let n;if(o>=e.length)return;const s=e[o];if(t){if("array"===r.type&&r.children){const i=toNumber(s);if(void 0===i)return;if(i>=r.children.length)return void console.error(`API Error! [getJsonNodeRange]: ${s} is out of range!`);if(n=getResult(e,r.children[i],o+1,t),n)return n}}else if("property"===r.type&&r.keyNode.value===s){if(o===e.length-1)return r;const s=r.valueNode;if(!s)return;if(!s.children)return;t=!1,"array"===s.type&&(t=!0);for(let r=0;r<s.children.length;r++){if(n=getResult(e,s.children[r],o+1,t),n)return n}}return n}async function getJsonNodeRange(e){const{filePath:r,tokens:o}=e;if(toNumber(o[o.length-1]))return void console.error("API Error! [getJsonNodeRange]: The last item cannot be an array member !");if(!r.endsWith(".json"))return void console.error("API Error! [getJsonNodeRange]: The file path must end with .json !");if(0===o.length)return void console.error("API Error! [getJsonNodeRange]: The tokens cannot be empty !");const t=(0,core_1.noTsToNormalizedUri)(r);if(!t)return void console.error("API Error! [getJsonNodeRange]: The file path is undefined !");const n=fs.readFileSync(r).toString(),s=vscode_languageserver_textdocument_1.TextDocument.create(t,"json",0,n),i=vscode_uri_1.URI.parse(s.uri),a=await vscode.workspace.getWorkspaceFolder(i);if(!a)return void console.error("API Error! [getJsonNodeRange]: The workspaceFolder is undefined !");const c=(0,core_1.isUniAppXProjectByPath)(a.uri.fsPath),u=await(0,schemaManager_1.initLanguageService)(c);(0,schemaManager_1.setLanguageConfig)(u,r,a);const d=u.parseJSONDocument(s);let g;if(!d.root)return void console.error("API Error! [getJsonNodeRange]: The jsonDocument.root is undefined !");const l=d.root.properties;if(!l)return void console.error("API Error! [getJsonNodeRange]: The jsonDocument.root.properties is undefined !");try{for(let e=0;e<l.length;e++){const r=getResult(o,l[e],0);if(r){g=r;break}}}catch(e){console.error(e.message)}if(!g)return;const f=g.offset,h=f+g.keyNode.length;return{start:s.positionAt(f),end:s.positionAt(h)}}exports.getJsonNodeRange=getJsonNodeRange;
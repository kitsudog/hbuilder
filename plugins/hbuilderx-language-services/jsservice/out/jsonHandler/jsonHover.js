"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.register=void 0;const vscode=require("vscode"),vscode_uri_1=require("vscode-uri"),core_1=require("../../../core"),vscode_json_languageservice_1=require("../../../packages/vscode-json-languageservice"),utils_1=require("../../../utils"),arrays_1=require("../utils/arrays"),schemaMgr=require("./schemaManager"),schemaManager_1=require("./schemaManager"),specialStringHandler_1=require("./specialStringHandler"),utils_2=require("./utils");class JsonHoverProvider{async getSpecialStringHover(e,r,t,a,s){const n=await e.getMatchingSchemas(r,t),i=r.offsetAt(a),o=n.filter((e=>e.node.offset<i)),c=(0,utils_2.findClosestNumberObject)(o,i);if(c){const e=c.schema.type;let n=utils_1.hx.createProject(null==s?void 0:s.uri.toString());return await(0,specialStringHandler_1.getSpecialStringHover)(e,r,a,t,n)}}async provideHover(e,r,t){let a=await vscode.workspace.getWorkspaceFolder(e.uri);if(!a)return null;const s=(0,core_1.isUniAppXProjectByPath)(a.uri.fsPath),n=await(0,schemaManager_1.initLanguageService)(s);schemaMgr.setLanguageConfig(n,vscode_uri_1.URI.parse(e.uri.toString()).fsPath,a);const i=vscode_json_languageservice_1.TextDocument.create(e.uri.toString(),e.languageId,1,e.getText()),o=n.parseJSONDocument(i);let c=await this.getSpecialStringHover(n,i,o,r,a);if(c)return c;let g=await n.doHover(i,r,o);if(!g)return null;let u=null==g?void 0:g.contents.toString();const l=new vscode.MarkdownString(u),d=[],v=g.extData;if(v){const e=(0,utils_2.parseExtData)(v,l);d.push(...e)}const p=new vscode.Hover(d);return g.range&&(p.range=new vscode.Range(new vscode.Position(g.range.start.line,g.range.start.character),new vscode.Position(g.range.end.line,g.range.end.character))),p}}function register(){const e=["**/package.json","**/database/*.schema.json","**/pages.json","**/manifest.json","**/settings.json"],r=(0,arrays_1.flatten)(["json","jsonc","json_tm"].map((r=>e.map((e=>({language:r,pattern:e}))))));return vscode.languages.registerHoverProvider(r,new JsonHoverProvider)}exports.register=register;
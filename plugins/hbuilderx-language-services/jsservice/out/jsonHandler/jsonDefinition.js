"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.register=void 0;const vscode=require("vscode"),vscode_uri_1=require("vscode-uri"),core_1=require("../../../core"),vscode_json_languageservice_1=require("../../../packages/vscode-json-languageservice"),utils_1=require("../../../utils"),arrays_1=require("../utils/arrays"),schemaMgr=require("./schemaManager"),schemaManager_1=require("./schemaManager"),specialStringHandler_1=require("./specialStringHandler"),utils_2=require("./utils");class JsonDefinitionProvider{async getSpecialStringDefinition(e,r,i,t,s){const a=[],n=await e.getMatchingSchemas(r,i),o=r.offsetAt(t),c=n.filter((e=>e.node.offset<o)),g=(0,utils_2.findClosestNumberObject)(c,o);if(g){const e=g.schema.type;let n=utils_1.hx.createProject(null==s?void 0:s.uri.toString());const o=await(0,specialStringHandler_1.getSpecialStringDefinition)(e,r,t,i,n);a.unshift(...o)}return a}async provideDefinition(e,r,i){const t=await vscode.workspace.getWorkspaceFolder(e.uri);if(!t)return;const s=(0,core_1.isUniAppXProjectByPath)(t.uri.fsPath),a=await(0,schemaManager_1.initLanguageService)(s);schemaMgr.setLanguageConfig(a,vscode_uri_1.URI.parse(e.uri.toString()).fsPath,t);const n=vscode_json_languageservice_1.TextDocument.create(e.uri.toString(),e.languageId,1,e.getText()),o=a.parseJSONDocument(n),c=await this.getSpecialStringDefinition(a,n,o,r,t);return c&&0!==c.length?c:void 0}}function register(){const e=["**/package.json","**/database/*.schema.json","**/pages.json","**/manifest.json","**/settings.json"],r=(0,arrays_1.flatten)(["json","jsonc","json_tm"].map((r=>e.map((e=>({language:r,pattern:e}))))));return vscode.languages.registerDefinitionProvider(r,new JsonDefinitionProvider)}exports.register=register;
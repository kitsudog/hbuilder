"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.deactivate=exports.activate=void 0;const rimraf=require("rimraf"),vscode=require("vscode"),pipeName_1=require("../../lib/pipeName"),api_1=require("./api"),commandManager_1=require("./commands/commandManager"),index_1=require("./commands/index"),tsDocAutoEnter_1=require("./commands/tsDocAutoEnter"),api_2=require("./jsonHandler/api"),languageConfiguration_1=require("./languageFeatures/languageConfiguration"),lazyClientHost_1=require("./lazyClientHost"),cancellation_electron_1=require("./tsServer/cancellation.electron"),logDirectoryProvider_electron_1=require("./tsServer/logDirectoryProvider.electron"),serverProcess_electron_1=require("./tsServer/serverProcess.electron"),versionProvider_electron_1=require("./tsServer/versionProvider.electron"),cancellation_1=require("./utils/cancellation"),fileSystem_electron_1=require("./utils/fileSystem.electron"),fileWatch_1=require("./utils/fileWatch"),plugins_1=require("./utils/plugins"),temp=require("./utils/temp.electron"),utsJsonToType_1=require("./utsJsonToType/utsJsonToType"),fs=require("fs"),path=require("path"),hx=require("hbuilderx");function isZH_CN(){try{if(process.env.VSCODE_NLS_CONFIG)return"zh_CN"===JSON.parse(process.env.VSCODE_NLS_CONFIG).locale}catch(e){console.error(null==e?void 0:e.stack)}return!0}const isCN=isZH_CN();async function updateFrameworkLibs(e,t){const r=e.value.serviceClient,s=await r.executeAsync("updateFrameworkLibs",t,cancellation_1.nulToken);let n="add"==t.type?"添加":"移除",o=s.body.success?"成功":"失败",i=s.body.success?"info":"warn";return vscode.window.setStatusBarMessage(`${n}框架语法库${o}`,5e3,i),s.body.success}function selectCompilationTarget(e){vscode.commands.registerCommand("select.target",(async t=>{const r=isCN?"语法提示和校验平台选择":"Syntax Completion and Type Check Seletion",s=isCN?"平台":"Platform",n=isCN?"确定":"Ok",o=isCN?"取消":"Cancel",i=isCN?"提示":"Tip",a=isCN?"选择多平台可能会影响语言服务性能，请谨慎选择，是否继续？":"Choosing multi-platforms may affect the performance of the language service, please choose carefully, continue?",c=isCN?'<a href="https://hx.dcloud.net.cn/Tutorial/Language/language_service_target_support">文档</a>':'<a href="https://hx.dcloud.net.cn/Tutorial/Language/language_service_target_support">Guide</a>',l=["APP-ANDROID","APP-IOS","WEB"];function u(e){return e.toLowerCase().replace(/\\/g,"/")}const p=path.join(hx.env.appData,"/extensions/hbuilderx-language-services");fs.existsSync(p)||fs.mkdirSync(p,{recursive:!0});const g=path.join(p,"/setting.json"),d=u(t.fsPath);console.log(" configPath",g," projectPath",d);let m=[];try{const e=JSON.parse(fs.readFileSync(g).toString());if(e&&e.targets)for(const t in e.targets)""===path.relative(d,u(t))&&(m=e.targets[t])}catch(e){}hx.window.showFormDialog({title:r,width:350,height:300,footer:c,customButtons:[{text:n,role:"accept"},{text:o}],formItems:[{type:"list",name:"targets",title:s,columnStretches:[1],multiSelection:!0,value:function(e){const t=[];return e.length&&l.forEach(((r,s)=>{e.includes(r)&&t.push(s)})),t}(m),items:function(){const e=[];return l.forEach((t=>{e.push({columns:[{label:`${t}`}]})})),e}()}],validate:async function(e){if(e.targets.length>1){return await hx.window.showMessageBox({type:"warning",title:i,text:a,buttons:[n,o]})===n}return!0}}).then((t=>{if(console.log("result",t),0!==t.buttonIndex)return;let r=t.result.targets.map((e=>l[e]));r=r.filter((e=>!!e));try{let e=fs.existsSync(g)?JSON.parse(fs.readFileSync(g).toString()||"{}"):{};e||(e={}),e.targets||(e.targets={}),e.targets[d]=[...r],fs.writeFileSync(g,JSON.stringify(e),{flag:"w"}),e=void 0}catch(e){}const s=e.value.serviceClient;s.executeAsync("onTargetChanged",{projectPath:d,targets:r},cancellation_1.nulToken).then((e=>{s.bufferSyncSupport.requestAllDiagnostics()}))}))}))}async function resolveDtsPathFromPackage(e,t){const r=e.value.serviceClient,s=await r.executeAsync("resolveDtsPathFromPackage",t,cancellation_1.nulToken);if(s.success)return s.body.filePath}function activate(e){const t=new plugins_1.PluginManager;e.subscriptions.push(t);const r=new commandManager_1.CommandManager;e.subscriptions.push(r);const s=new vscode.EventEmitter;e.subscriptions.push(s);const n=new logDirectoryProvider_electron_1.NodeLogDirectoryProvider(e),o=new versionProvider_electron_1.DiskTypeScriptVersionProvider;e.subscriptions.push(new languageConfiguration_1.LanguageConfigurationManager),serverProcess_electron_1.ChildServerProcess.inServerDebugMode=e.extensionMode==vscode.ExtensionMode.Development;const i={clientProcessId:"",indexPipeName:pipeName_1.default.createIndexPipeName(),tsServerProcessKind:""},a=(0,lazyClientHost_1.createLazyClientHost)(e,(0,fileSystem_electron_1.onCaseInsenitiveFileSystem)(),{pluginManager:t,commandManager:r,logDirectoryProvider:n,cancellerFactory:cancellation_electron_1.nodeRequestCancellerFactory,versionProvider:o,processFactory:serverProcess_electron_1.ChildServerProcess},(e=>{s.fire(e)}),i);(0,index_1.registerBaseCommands)(r,a,t),selectCompilationTarget(a),Promise.resolve().then((()=>require("./languageFeatures/tsconfig"))).then((t=>{e.subscriptions.push(t.register())})),Promise.resolve().then((()=>require("./jsonHandler/jsonCompletion"))).then((t=>{e.subscriptions.push(t.register())})),Promise.resolve().then((()=>require("./jsonHandler/jsonHover"))).then((t=>{e.subscriptions.push(t.register())})),Promise.resolve().then((()=>require("./jsonHandler/jsonDefinition"))).then((t=>{e.subscriptions.push(t.register())}));let c=[vscode.commands.registerCommand("references.findAllFileReferences",(e=>{vscode.commands.executeCommand("typescript.findAllFileReferences",e)}))];e.subscriptions.push(...c);const l=new utsJsonToType_1.UtsJsonToType,u=vscode.commands.registerCommand("utsJsonToType.toType",(()=>l.convertJSONToType()));return e.subscriptions.push(u),e.subscriptions.push((0,lazyClientHost_1.lazilyActivateClient)(a,t)),hx.languages.setLanguageConfiguration("typescript",tsDocAutoEnter_1.TsDocOnEnterRules),"win32"===process.platform&&(0,fileWatch_1.creatFileWatch)(a),{updateFrameworkLibs:e=>updateFrameworkLibs(a,e),resolveDtsPathFromPackage:e=>resolveDtsPathFromPackage(a,e),getFileReferences:e=>(0,api_1.getFileReferences)(a,e),getFilesDiagnostics:e=>(0,api_1.getFilesDiagnostics)(a,e),getJsonNodeRange:e=>(0,api_2.getJsonNodeRange)(e)}}function deactivate(){rimraf.sync(temp.getInstanceTempDir())}exports.activate=activate,exports.deactivate=deactivate;
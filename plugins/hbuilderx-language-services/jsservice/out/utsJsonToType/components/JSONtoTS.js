"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.convertJsonToTs=void 0;const jsonc=require("jsonc-parser"),config_1=require("./config"),util_1=require("./util"),ErrorKey=[];ErrorKey.push(...util_1.SwiftKey),ErrorKey.push(...util_1.KotlinKey);const NewErrorKey=Array.from(new Set(ErrorKey));function addUnderscoreIfNeeded(e){return NewErrorKey.includes(e)?`_${e}`:e}function replaceSpecialChars(e){const t=new RegExp(`[${util_1.ErrChar.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}]`,"g");return e.replace(t,"_")}function replaceNumberStart(e){return e.replace(/^\d/,"_$&")}function replaceKeys(e){const t=[];if("object"!=typeof e||null===e)return e;if(Array.isArray(e))return e.map((e=>replaceKeys(e)));const r={};for(const n of Object.keys(e)){let o=addUnderscoreIfNeeded(n);o=replaceNumberStart(o),o=replaceSpecialChars(o),t.includes(o)&&(o+="_"),t.push(o),r[o]=replaceKeys(e[n])}return r}function convertJsonToTs(e){try{let t;e.startsWith("{")||e.startsWith("[")||(e="{"+e+"}");let r=validateJson(e);if(r.result===util_1.Result.error)return r;const n=replaceKeys(jsonc.parse(r.output));return t=(0,util_1.isArray)(n)?convertArrayToTs(n):convertToTs(n),{result:util_1.Result.ok,output:t,errorMessage:""}}catch(e){return{result:util_1.Result.error,output:"",errorMessage:(e&&e.name&&"SyntaxError"===e.name?"Error while processing the interface. ":"")+e.message}}}function validateJson(e){return(0,util_1.isValidJSON)(e)?(0,util_1.isSupportedJsonFormat)(e)?{result:util_1.Result.error,output:"",errorMessage:"Only 'Object' and 'Array of Object' json are supported"}:{result:util_1.Result.ok,output:e,errorMessage:"Invalid JSON"}:{result:util_1.Result.error,output:"",errorMessage:"Invalid JSON"}}function convertArrayToTs(e,t="IRootInterface"){let r=[];return arrayType(e,t,[],r),r.join("\n\n")}function convertToTs(e,t="IRootInterface"){let r=[],n=[];for(let t in e){let o=e[t];if((0,util_1.isObject)(o)){if(0===Object.keys(o).length){e[t]="any;";continue}let r=(0,util_1.formatInterfaceName)(t);n.push(convertToTs(o,r)),e[t]=r+";"}else(0,util_1.isArray)(o)?e[t]=arrayType(o,t,r,n):(0,util_1.isNullOrUndefined)(o)?(e[t]="any;",r.push(t)):(0,util_1.isDate)(o)?e[t]="Date;":(0,util_1.isBoolean)(o)?e[t]="boolean;":(0,util_1.isNumber)(o)?e[t]="number;":(0,util_1.isString)(o)&&(e[t]="string;")}let o=formatInterface(e,t,r);return n.push(o),n.join("\n\n")}function arrayType(e,t,r,n){return e.every(util_1.isObject)?arrayWithObjectTypes(e,t,r,n):arrayWithMultipleTypes(e,t,r,n)}function extractInterfaceContent(e){const t=/interface(.*){/.exec(e);return t&&t[1]?t[1].trim():void 0}function createObjectFromStrings(e){const t={};for(const r of e){const[e,n]=r.split(":");e&&n&&(t[e.trim()]=n.trim())}return t}function extractBracesContent(e){const t=/{([\s\S]*?)}/.exec(e);if(t&&t[1]){let e=t[1];return e=e.replace(/\n/g,"").replace(/\t/g,""),createObjectFromStrings(e.split(/[,;]/))}}function margeObjectData(e,t){const r={...e};for(const e in t)if(t.hasOwnProperty(e)){const n=r[e];if(!n){r[`${e}?`]=`${t[e]}`;continue}let o=n.split("|");o=o.map((e=>e.trim()));const l=t[e];o.includes(l)||(r[e]=`${r[e]} | ${t[e]}`)}return r}function mapToString(e){let t=[];return e.forEach(((e,r)=>{let n=`export interface ${r} ${JSON.stringify(e,null,"\t")}`;n=n.replace(/"/g,""),t.push(n)})),t}function duplicatesMerge(e){let t=new Map;for(let r=0;r<e.length;r++){const n=e[r],o=extractInterfaceContent(n);if(!o)continue;const l=extractBracesContent(n);if(l)if(t.has(o)){const e=margeObjectData(t.get(o),l);t.set(o,e)}else t.set(o,l)}return mapToString(t)}function arrayWithObjectTypes(e,t,r,n){let o=[],l=[];if(0===e.length)return"any[]";if(1===e.length&&0===Object.keys(e[0]).length)return"any[]";for(let n=0;n<e.length;n++){if((0,util_1.isNullOrUndefined)(e[n])){r.push(t);continue}let s=populateJson(n,e,t,o),i=jsonc.parse(s);l.push(i)}const s=l.map((e=>Object.keys(e))).reduce(((e,t)=>[...e,...t]),[]),i=s.map((e=>e.replace("?",""))).filter(util_1.onlyUnique),a=s.filter(util_1.getOptionalKeys);let c=[];for(let e=0;e<l.length;e++)for(let t=0;t<i.length;t++){let n=l[e],o=i[t];void 0!==n[o]?c[t]=c[t]?c[t].includes(n[o])?c[t]:c[t]+" | "+n[o]:n[o]:void 0!==n[o+"?"]?c[t]=c[t]?c[t].includes(n[o+"?"])?c[t]:c[t]+" | "+n[o+"?"]:n[o+"?"]:r.includes(o)||r.push(o)}a.forEach((e=>{r.includes(e.replace("?",""))||r.push(e.replace("?",""))}));let u="{\n";for(let e=0;e<i.length;e++){u=`${u}\t"${i[e]}" : "${c[e].includes("|")?"("+c[e]+")":c[e]}",\n`}u+="}";let p=(0,util_1.formatInterfaceName)(t);return u=formatInterface(jsonc.parse(u),p,r),n.push(u),o=duplicatesMerge(o),n.push(...o),`${p}[]`}function arrayWithMultipleTypes(e,t,r,n){let o="";for(let l=0;l<e.length;l++){if((0,util_1.isNullOrUndefined)(e[l])){r.push(t);continue}let s=(0,util_1.getType)(e[l]);if("Array"===s)s=arrayType(e[l],t,r,n);else if("object"===s){let r=(0,util_1.formatInterfaceName)(t);n.push(convertToTs(e[l],r)),s=r}o=o.includes(s)?o:""===o?s:o+" | "+s}return o.includes("|")?`(${o})[]`:`${o}[]`}function extractAfterLastInterface(e,t){const r=e.split("\n\n");let n=e;for(let e=0;e<r.length;e++){const o=r[e];e===r.length-1?n=o:null==t||t.push(o)}return n}function populateJson(e,t,r,n){const o=(0,util_1.formatInterfaceName)(r);let l=convertToTs(t[e],o);l=extractAfterLastInterface(l,n);return l.replace(/(([ ]*(export)?[ ]*interface[ ]*)([a-zA-Z0-9-]*[ ]*))/gm,"").replace(/(:)([ ]*)(([\[\]\(a-z0-9A-Z\| \)]*|[a-z0-9A-Z])([[]])*(\?)?([ ]*))(;|,)*/gm,'$1"$3",').replace(/([a-zA-Z0-9-]+(\?))(:)/gm,'"$1":').replace(/,(?=\s*?[\]}])/g,"").replace(/\n|\t/g,"").replace(/(?<=[{|,])(.*?)(?=:)/g,'"$1"')}function formatInterface(e,t,r){let n=JSON.stringify(e,null,"\t").replace(new RegExp('"',"g"),"");const o=(0,config_1.getJSONUtilityConfiguration)().get("property",!0);if(r&&r.length>0)for(let t in e)(r.includes(t)||r.includes(t+"?"))&&(n=n.replace(t+":",(o?(0,util_1.formatPropertyName)(t):t)+"?:"));return n=n.replace(/((,|;)+)/gm,";").replace(/((:)([ ]*)(([\[\]\(a-z0-9A-Z\| \)]*|[a-z0-9A-Z])([[]])*(\?)?([ ]*)))((;|,)*)(\n([ ])*})/gm,"$1;$11"),"export interface "+t+" "+n}exports.convertJsonToTs=convertJsonToTs;
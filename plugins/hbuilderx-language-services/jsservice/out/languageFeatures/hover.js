"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.register=void 0;const vscode=require("vscode"),typescriptService_1=require("../typescriptService"),dependentRegistration_1=require("../utils/dependentRegistration"),previewer_1=require("../utils/previewer"),typeConverters=require("../utils/typeConverters"),unixVersionCompatibilityResolver_1=require("./unixVersionCompatibilityResolver");class TypeScriptHoverProvider{constructor(e){this.client=e}async provideHover(e,t,i){const r=this.client.toOpenedFilePath(e);if(!r)return;const n=typeConverters.Position.toFileLocationRequestArgs(r,t),o=await this.client.interruptGetErr((()=>this.client.execute("quickinfo",n,i)));return"response"===o.type&&o.body?new vscode.Hover(this.getContents(o.body,o._serverType),typeConverters.Range.fromTextSpan(o.body)):void 0}getContents(e,t){const i=[];if(e&&e.tags){let t="";const i=[];e.tags.forEach((e=>{if("uniPlatform"===e.name){if(!e.text)return;t="string"==typeof e.text?e.text:e.text[0].text}else i.push(e)})),e.tags=i;const r=new unixVersionCompatibilityResolver_1.UnixVersionCompatibilityResolver(t).getHtml();if(r){"string"==typeof e.documentation&&(e.documentation=[{kind:"text",text:e.documentation}]);let t=!0;e.documentation.length>0&&e.documentation[0].text===r&&(t=!1),t&&e.documentation.unshift({text:r,kind:"text"})}}if(e.displayString){const r=[];t===typescriptService_1.ServerType.Syntax&&this.client.capabilities.has(typescriptService_1.ClientCapability.Semantic),r.push(e.displayString),i.push({language:"typescript",value:r.join(" ")})}return i.push((0,previewer_1.markdownDocumentation)(e.documentation,e.tags)),i}}function register(e,t){return(0,dependentRegistration_1.conditionalRegistration)([(0,dependentRegistration_1.requireSomeCapability)(t,typescriptService_1.ClientCapability.EnhancedSyntax,typescriptService_1.ClientCapability.Semantic)],(()=>vscode.languages.registerHoverProvider(e.syntax,new TypeScriptHoverProvider(t))))}exports.register=register;
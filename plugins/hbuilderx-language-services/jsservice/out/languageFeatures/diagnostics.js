"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.DiagnosticsManager=void 0;const vscode=require("vscode"),arrays=require("../utils/arrays"),dispose_1=require("../utils/dispose"),resourceMap_1=require("../utils/resourceMap");function diagnosticsEquals(s,t){return s===t||s.code===t.code&&s.message===t.message&&s.severity===t.severity&&s.source===t.source&&s.range.isEqual(t.range)&&arrays.equals(s.relatedInformation||arrays.empty,t.relatedInformation||arrays.empty,((s,t)=>s.message===t.message&&s.location.range.isEqual(t.location.range)&&s.location.uri.fsPath===t.location.uri.fsPath))&&arrays.equals(s.tags||arrays.empty,t.tags||arrays.empty)}class FileDiagnostics{constructor(s,t){this.file=s,this.language=t,this._diagnostics=new Map}updateDiagnostics(s,t,e){s!==this.language&&(this._diagnostics.clear(),this.language=s);const i=this._diagnostics.get(t);return!arrays.equals(i||arrays.empty,e,diagnosticsEquals)&&(e.forEach((s=>{var t;s.source=(null===(t=s.target)||void 0===t?void 0:t.startsWith("[target]"))?s.target.slice(8):""})),this._diagnostics.set(t,e),!0)}getDiagnostics(s){return s.getValidate(this.language)?[...this.get(0),...this.get(1),...this.getSuggestionDiagnostics(s)]:[]}getSuggestionDiagnostics(s){const t=s.getEnableSuggestions(this.language);return this.get(2).filter((s=>!!t||s.tags&&(s.tags.includes(vscode.DiagnosticTag.Unnecessary)||s.tags.includes(vscode.DiagnosticTag.Deprecated))))}get(s){return this._diagnostics.get(s)||[]}}function areLanguageDiagnosticSettingsEqual(s,t){return s.validate===t.validate&&s.enableSuggestions==s.enableSuggestions}class DiagnosticSettings{constructor(){this._languageSettings=new Map}getValidate(s){return this.get(s).validate}setValidate(s,t){return this.update(s,(s=>({validate:t,enableSuggestions:s.enableSuggestions})))}getEnableSuggestions(s){return this.get(s).enableSuggestions}setEnableSuggestions(s,t){return this.update(s,(s=>({validate:s.validate,enableSuggestions:t})))}get(s){return this._languageSettings.get(s)||DiagnosticSettings.defaultSettings}update(s,t){const e=this.get(s),i=t(e);return this._languageSettings.set(s,i),!areLanguageDiagnosticSettingsEqual(e,i)}}DiagnosticSettings.defaultSettings={validate:!0,enableSuggestions:!0};class DiagnosticsManager extends dispose_1.Disposable{constructor(s,t){super(),this._settings=new DiagnosticSettings,this._updateDelay=50,this._diagnostics=new resourceMap_1.ResourceMap(void 0,{onCaseInsenitiveFileSystem:t}),this._pendingUpdates=new resourceMap_1.ResourceMap(void 0,{onCaseInsenitiveFileSystem:t}),this._currentDiagnostics=this._register(vscode.languages.createDiagnosticCollection(s))}dispose(){super.dispose();for(const s of this._pendingUpdates.values)clearTimeout(s);this._pendingUpdates.clear()}reInitialize(){this._currentDiagnostics.clear(),this._diagnostics.clear()}setValidate(s,t){this._settings.setValidate(s,t)&&this.rebuild()}setEnableSuggestions(s,t){this._settings.setEnableSuggestions(s,t)&&this.rebuild()}updateDiagnostics(s,t,e,i){let a=!1;const n=this._diagnostics.get(s);if(n)a=n.updateDiagnostics(t,e,i);else if(i.length){const n=new FileDiagnostics(s,t);n.updateDiagnostics(t,e,i),this._diagnostics.set(s,n),a=!0}a&&this.scheduleDiagnosticsUpdate(s)}configFileDiagnosticsReceived(s,t){this._currentDiagnostics.set(s,t)}delete(s){this._currentDiagnostics.delete(s),this._diagnostics.delete(s)}getDiagnostics(s){return this._currentDiagnostics.get(s)||[]}hasDiagnostics(s){return this._currentDiagnostics.has(s)}scheduleDiagnosticsUpdate(s){this._pendingUpdates.has(s)||this._pendingUpdates.set(s,setTimeout((()=>this.updateCurrentDiagnostics(s)),this._updateDelay))}updateCurrentDiagnostics(s){this._pendingUpdates.has(s)&&(clearTimeout(this._pendingUpdates.get(s)),this._pendingUpdates.delete(s));const t=this._diagnostics.get(s);this._currentDiagnostics.set(s,t?t.getDiagnostics(this._settings):[])}rebuild(){this._currentDiagnostics.clear();for(const s of this._diagnostics.values)this._currentDiagnostics.set(s.file,s.getDiagnostics(this._settings))}}exports.DiagnosticsManager=DiagnosticsManager;
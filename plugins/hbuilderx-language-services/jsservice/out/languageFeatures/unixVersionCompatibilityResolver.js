"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.UnixVersionCompatibilityResolver=void 0;const fs=require("fs"),os=require("os"),path=require("path"),vscode=require("vscode"),core_1=require("../../../core");var VerStatus;!function(t){t[t.enable=0]="enable",t[t.disable=1]="disable",t[t.partial=2]="partial"}(VerStatus||(VerStatus={}));const platformList=["weixin","alipay","baidu","toutiao","lark","qq","kuaishou","jd"],g_nameMap={360:"360",alipay:"支付宝",baidu:"百度",jd:"京东",kuaishou:"快手",lark:"飞书",qq:"QQ",toutiao:"字节跳动",weixin:"微信",quickapp:"快应用"};class UnixVersionCompatibilityResolver{constructor(t){var e;if(this._isUniAppx=!1,t)try{this._jsonData=JSON.parse(t)}catch(t){console.log("parse uniPlatForm text error")}else this._jsonData=void 0;const i=null===(e=vscode.window.activeTextEditor)||void 0===e?void 0:e.document.uri.fsPath;if(i){const t=vscode.workspace.getWorkspaceFolder(vscode.Uri.file(i));this._isUniAppx=(0,core_1.isUniAppXProjectByPath)(null==t?void 0:t.uri.fsPath)}}getImgTip(t,e){let i=t+": ";const a=e.uniVer?"uniVer "+e.uniVer:"",r=e.unixVer?(a?", ":"")+"unixVer "+e.unixVer:"";return a||r?(i+=a,i+=r,i):""}getVerStatus(t){if(Object.keys(t).length<=0)return VerStatus.enable;const e=!!t.uniVer&&"x"!==t.uniVer,i=!!t.unixVer&&"x"!==t.unixVer;return e&&i?VerStatus.enable:e||i?VerStatus.partial:VerStatus.disable}getUnixVer(t){return"uni-app x "+t.unixVer}getIconData(t,e,i){let a="";switch(e){case VerStatus.enable:a=path.resolve(__dirname,`../../../lib/img/${t}_e.png`);break;case VerStatus.partial:a=path.resolve(__dirname,`../../../lib/img/${t}_p.png`);break;case VerStatus.disable:a=path.resolve(__dirname,`../../../lib/img/${t}_d.png`)}const r=path.resolve(a);if(!fs.existsSync(r))return"";let n=10,s=10;"Darwin"===os.type()&&(n=16,s=16);return`<img src="${r}" width="${n}" height="${s}" title="${i||""}">`}createAppData(t){if(!t)return"";const e=!t.android||t.android&&!t.android.osVer&&!t.android.uniVer&&!t.android.unixVer,i=!t.ios||t.ios&&!t.ios.osVer&&!t.ios.uniVer&&!t.ios.unixVer;if(!e||!i){const a="<p><strong>App: </strong></p><p></p>",r='<table cellspacing="0.5" width="550px" style="background-color: ${color://suggestWidget.details.table.border}; font-size:9pt; margin-bottom: 5px;">',n="</table>";let s='\n                <tr >\n                    <td style="background-color: ${color://suggestWidget.details.table.corner};text-align: left; padding: 6px 10px;">平台\\版本</td>\n                    <td style="background-color: ${color://suggestWidget.details.table.title};text-align: left; padding: 6px 10px;">osVer</td>\n                    <td style="background-color: ${color://suggestWidget.details.table.title};text-align: left; padding: 6px 10px;">uniVer</td>\n                    <td style="background-color: ${color://suggestWidget.details.table.title};text-align: left; padding: 6px 10px;">uniXVer</td>\n                </tr>\n            ',o="";if(!e){o+=`\n                    <tr >\n                        <td style="background-color: \${color://suggestWidget.details.table.column.title};text-align: left; padding: 6px 10px;">Android</td>\n                        <td style="background-color: \${color://suggestWidget.details.table.content};text-align: left; padding: 6px 10px;">${t.android&&t.android.osVer?t.android.osVer:""}</td>\n                        <td style="background-color: \${color://suggestWidget.details.table.content};text-align: left; padding: 6px 10px;">${t.android&&t.android.uniVer?t.android.uniVer:""}</td>\n                        <td style="background-color: \${color://suggestWidget.details.table.content};text-align: left; padding: 6px 10px;">${t.android&&t.android.unixVer?t.android.unixVer:""}</td>\n                    </tr>\n                `}if(!i){o+=`\n                    <tr >\n                        <td style="background-color: \${color://suggestWidget.details.table.column.title};text-align: left; padding: 6px 10px;">iOS</td>\n                        <td style="background-color: \${color://suggestWidget.details.table.content};text-align: left; padding: 6px 10px;">${t.ios&&t.ios.osVer?t.ios.osVer:""}</td>\n                        <td style="background-color: \${color://suggestWidget.details.table.content};text-align: left; padding: 6px 10px;">${t.ios&&t.ios.uniVer?t.ios.uniVer:""}</td>\n                        <td style="background-color: \${color://suggestWidget.details.table.content};text-align: left; padding: 6px 10px;">${t.ios&&t.ios.unixVer?t.ios.unixVer:""}</td>\n                    </tr>\n                `}return""===o?o:(s=a+r+s+o+n,s)}return""}createMpData(t){if(!t)return"";let e='<p><table  style="margin-bottom: 5px; " border="0" cellpadding="0" cellspacing="0" align="center "><tr><td valign="middle" style="white-space: nowrap;"><strong>小程序:</strong></td>';for(let i of platformList){const a=t[i];if(a){const t=this.getVerStatus(a);e+="<td>&nbsp;"+this.getIconData(i,t,this.getImgTip(g_nameMap[i],a))+"</td>"}}if(this._jsonData&&this._jsonData.quickapp){const t=this.createQuickAppData(this._jsonData.quickapp);""!==t&&(e+="<td>&nbsp;"+t+"</td>")}return e+="</tr></table><p>",e}createQuickAppData(t){if(!t)return"";const e=this.getVerStatus(t);return this.getIconData("quickapp",e,this.getImgTip(g_nameMap.quickapp,t))}createWebData(t){if(!t)return"";let e="";switch(this.getVerStatus(t)){case VerStatus.enable:e=this.getUnixVer(t);break;case VerStatus.disable:e="不支持";break;case VerStatus.partial:e="部分支持"}return e="<p><strong>Web: </strong>"+e+"</p>",e}getHtml(){let t="";if(!this._jsonData)return t;const e=this.createAppData(this._jsonData.app),i=this.createMpData(this._jsonData.mp),a=this.createWebData(this._jsonData.web);return""!==e&&(t+=e),this._isUniAppx||""!==i&&(t+=i),""!==a&&(t+=a),t}}exports.UnixVersionCompatibilityResolver=UnixVersionCompatibilityResolver;
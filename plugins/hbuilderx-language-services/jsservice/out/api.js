"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getFilesDiagnostics=exports.getFileReferences=exports.getExtensionApi=void 0;const fs=require("fs"),vscode=require("vscode"),typeScriptServiceClientHost_1=require("./typeScriptServiceClientHost"),cancellation_1=require("./utils/cancellation"),typeConverters=require("./utils/typeConverters");class ApiV0{constructor(e,t){this.onCompletionAccepted=e,this._pluginManager=t}configurePlugin(e,t){this._pluginManager.setConfiguration(e,t)}}function getExtensionApi(e,t){return{getAPI(i){if(0===i)return new ApiV0(e,t)}}}async function getFileReferences(e,t){var i,n;const s=e.value.serviceClient;if(!t)return;const o={file:t.fsPath,projectRootPath:null===(n=null===(i=t.workspaceFolder)||void 0===i?void 0:i.uri)||void 0===n?void 0:n.fsPath};if(!o.projectRootPath)return;if(!fs.existsSync(o.projectRootPath))return;s.executeWithoutWaitingForResponse("open",o);const r=await s.execute("fileReferences",{file:t.fsPath},cancellation_1.nulToken);if("response"!==r.type)return;if(!r.body)return;return r.body.refs.map((e=>{const t=s.toResource(e.file);return typeConverters.Location.fromTextSpan(t,e)}))}async function fileIsOpened(e,t){const i=vscode.window.visibleTextEditors,n=t.file;for(let e=0;e<i.length;e++){if(n===i[e].document.fileName)return!0}return!1}async function getFilesDiagnostics(e,t){const i=e.value.serviceClient;if(t)return new Promise((async(n,s)=>{const o=vscode.Uri.file(t.filePathList[0]).fsPath,r={file:o,projectRootPath:t.projectPath},c={fileArgs:r,pendingPromise:{resolve:n,reject:s},diagnostics:[],needClose:t.needClose};await fileIsOpened(e,r)?c.needClose=!1:i.executeWithoutWaitingForResponse("open",r),t.needClose&&(c.needClose=!0),typeScriptServiceClientHost_1.DiagnosticsMap.set(o,c),i.executeAsync("geterr",{delay:0,files:t.filePathList},cancellation_1.nulToken)}))}exports.getExtensionApi=getExtensionApi,exports.getFileReferences=getFileReferences,exports.getFilesDiagnostics=getFilesDiagnostics;